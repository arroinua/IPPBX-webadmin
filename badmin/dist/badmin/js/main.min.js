function load_application(e){function n(e,t){show_loading_panel();t?request("POST","/",extend(e,{method:"setObject",id:1,file:t,filename:t.name}),o):request("POST","/",extend({},{method:"setObject",id:1,params:e}),set_object_success)}function o(e,t){t.result&&!t.result.error&&json_rpc_async("getObject",{oid:t.result},function(e){set_object_success(),PbxObject.query=e.kind+"/"+e.oid,window.location.href="#"+PbxObject.query,s(e)})}function a(e){PbxObject.name=e}function r(e){PbxObject.name&&setObjectState(PbxObject.oid,e,function(e){return!0})}function i(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function s(e){var t={frases:PbxObject.frases,params:e,setObject:n,onNameChange:a,onStateChange:r};e.name&&(t.removeObject=i),ReactDOM.render(ApplicationComponent(t),document.getElementById("el-loaded-content"))}PbxObject.oid=e.oid,PbxObject.name=e.name,s(e),show_content(),set_page()}function load_attendant(t){PbxObject.oid=t?t.oid:"",PbxObject.name=t?t.name:"";var n=document.getElementById("enabled"),e=document.getElementById("objname");t.name?e.value=t.name:getObjects(null,function(e){filterObject(e,"attendant").length}),n&&(n.checked=t.enabled,addEvent(n,"change",function(){setObjectState(t.oid,this.checked,function(e){e||(n.checked=!n.checked)})})),t.debug&&(document.getElementById("debug").checked=t.debug),show_content(),set_page(),setInitAttParams(),makeActiveCanvas(),getAttTemplate("attendant_object",function(e){setAttSettings(t.parameters,e)}),document.getElementById("addConnector").onclick=function(){addConnector()},json_rpc_async("getExtensions",null,function(e){var t=e.filter(function(e){return"trunk"!==e.kind&&"cli"!==e.kind&&"timer"!==e.kind&&"routes"!==e.kind&&"pickup"!==e.kind});PbxObject.attendant.routes=t})}function setInitAttParams(){PbxObject.attendant={currentPid:"",routes:[],connectors:[],objects:{},buttons:["1","2","3","4","5","6","7","8","9","0","#","*"],availableButtons:[],types:{menu:"menu",commutator:"commutator",mail:"mail"}}}function changeAvailableButtons(e,t){var n,o=t||document.querySelector(".att-canvas.active"),a=[];"object"==typeof e?a=[].concat(e):(a=JSON.parse(o.getAttribute("data-available-buttons")),btnIndex=a.indexOf(e),-1!==btnIndex?a.splice(btnIndex,1):a.splice(btnIndex,0,e)),PbxObject.attendant.availableButtons=PbxObject.attendant.buttons.map(function(e){return(n={}).button=e,-1===a.indexOf(e)?n.disabled=!0:n.disabled=!1,n}),o.setAttribute("data-available-buttons",JSON.stringify(a))}function createCanvas(e){var t=document.getElementById("att-container"),n=document.createElement("div");n.className="att-canvas active",void 0!==e&&n.setAttribute("data-parent",e),t.appendChild(n),createInitButton(n),changeAvailableButtons(PbxObject.attendant.buttons),addAttObjects(PbxObject.attendant.objects,e)}function makeActiveCanvas(t){void 0!==t&&(PbxObject.attendant.currentPid=t);var n,e=[].slice.call(document.querySelectorAll(".att-canvas")),o=document.getElementById("toPrevCanvas"),a=!1;e.forEach(function(e){(n=e.getAttribute("data-parent"))===t||!t&&!n?(e.classList.add("active"),a=e):e.classList.remove("active")}),a?changeAvailableButtons(JSON.parse(a.getAttribute("data-available-buttons"))):createCanvas(t),setSchemaActiveEl(t||""),o&&(t&&"hidden"===o.className?o.className="":t||(o.className="hidden")),toTheTop("att-container")}function removeCanvases(e){var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),o=new RegExp(e+"d*");n.forEach(function(e){t=e.getAttribute("data-parent"),o.test(t)&&e.parentNode.removeChild(e)})}function toPrevCanvas(e){e&&e.preventDefault();var t=document.querySelector(".att-canvas.active").getAttribute("data-parent");makeActiveCanvas(t.substr(0,t.length-1))}function createInitButton(e){var t=document.createElement("div"),n=e||document.querySelector(".att-canvas.active");t.className="dropdown att-init-button",t.innerHTML='<button class="btn btn-default dropdown-toggle dropdown-round" type="button" id="att-obj-types" data-toggle="dropdown" aria-expanded="true"><i class="fa fa-plus"></i></button><ul class="dropdown-menu" role="menu" aria-labelledby="att-obj-types"><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.menu+'"><i class="fa fa-music"></i> '+PbxObject.frases.ATTENDANT.MENU+'</a></li><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.mail+'"><i class="fa fa-envelope"></i>  '+PbxObject.frases.ATTENDANT.MAIL+"</a></li>"+(PbxObject.attendant.currentPid?'<li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.commutator+'"><i class="fa fa-phone"></i>  '+PbxObject.frases.ATTENDANT.COMMUTATOR+"</a></li>":"")+"</ul>",addEvent(t,"click",function(e){e&&e.preventDefault();var t=e.currentTarget,n=e.target;"top"===elPosition(t)?t.className="dropup att-init-button":t.className="dropdown att-init-button","A"!==n.nodeName&&(n=n.parentNode);var o=n.getAttribute("data-type");o&&showAttObjectSetts({type:o})}),n.appendChild(t)}function setInitAttMoveBtns(e){var t=PbxObject.attendant.buttons,n=document.getElementById("moveBack"),o=document.getElementById("moveMmenu");fillBtnsSelectList(t,n,e.moveBack),fillBtnsSelectList(t,o,e.moveMmenu)}function fillBtnsSelectList(e,t,n){var o,a=document.createDocumentFragment();e.forEach(function(e){(o=document.createElement("option")).value=e,(o.innerHTML=e)===n&&o.setAttribute("selected","selected"),a.appendChild(o)}),t.appendChild(a)}function strToJson(e){var t=new RegExp(/([\d\w]+)(=+)(?!\{)([\d\w@\-_.\s,?!*%$^&#+]*)(?=\,|\})/,"g"),n=new RegExp(/([\d\w#*]+)(=+)(?=\{)/,"g");return e.replace(t,function(e,t,n,o){return"null"!==o&&(o=JSON.stringify(o)),'"'+t+'":'+o}).replace(n,function(e,t,n){return'"'+t+'":'})}function setAttSettings(e,t){var n,o=document.getElementById("attvariables"),a="",r="",i="",s="",c={},l=null;e&&o&&setFormData(o,e),e.forEach(function(e){"jsonString"===e.key?(l=e.value,n=JSON.parse(l,function(e,t){return"null"===t?null:t}),PbxObject.attendant.objects=n):"connectors"===e.key?(l=e.value,addConnectors(JSON.parse(l))):"greetings"===e.key?a=e.value:"ringbackMusic"===e.key?r=e.value:"connectionFailed"===e.key?i=e.value:"leaveMessage"===e.key?s=e.value:"moveBack"===e.key?c.moveBack=e.value:"moveMmenu"===e.key&&(c.moveMmenu=e.value)}),e.length||(c.moveBack="#",c.moveMmenu="*"),customize_upload("attGreetings",a),customize_upload("ringbackMusic",r),customize_upload("connectionFailed",i),customize_upload("leaveMessage",s),setInitAttMoveBtns(c),addAttObjects(n,""),buildSchema(n)}function buildSchema(e){var t,n,o=document.getElementById("att-schema"),a=[];for(key in addToSchema("home",{name:'<i class="fa fa-home"></i>',type:PbxObject.attendant.types.menu},o),e)e.hasOwnProperty(key)&&a.push(e[key]);sortByKey(a,"oid"),a.forEach(function(e){t=e.oid.substr(0,e.oid.length-1),n="0"===e.oid?o.querySelector('ul[data-oid="home"]'):o.querySelector('ul[data-oid="'+t+'"]'),addToSchema(e.oid,e,n)}),addEvent(o,"click",setAttPosition)}function addToSchema(e,t,n){if(null!=e&&"null"!==e){var o,a,r=e.substr(0,e.length-1);a=n||("0"!==e?document.querySelector('#att-schema ul[data-oid="'+r+'"]'):document.querySelector('#att-schema ul[data-oid="home"]')),o=createSchemaBranch(e,t),a.appendChild(o)}}function createSchemaBranch(e,t){var n=document.createElement("li");return n.setAttribute("data-oid",e),t.type===PbxObject.attendant.types.menu?("home"===e&&(n.className="active"),n.innerHTML='<label class="fa fa-minus" for="t-'+e+'"></label><input type="checkbox" name="tree-node" id="t-'+e+'"/> <a href="#'+("home"===e?"":e)+'">'+t.name+(t.button?'<small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>":"")+'</a><ul data-oid="'+e+'"></ul>'):(n.innerHTML=t.name,t.button&&"null"!==t.button&&(n.innerHTML+=' <small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>")),n}function rebuildSchema(){var e=document.getElementById("att-schema");e.children[0]&&e.removeChild(e.children[0]),buildSchema(PbxObject.attendant.objects),setSchemaActiveEl(PbxObject.attendant.currentPid)}function removeFromSchema(e){var t=document.querySelector('#att-schema li[data-oid="'+e+'"]');t.parentNode.removeChild(t)}function setSchemaActiveEl(e){var t=document.getElementById("att-schema"),n=t.querySelector('li a[href="#'+e+'"]'),o=t.querySelector("li.active");n&&(o&&(o.className=""),n.parentNode.className="active")}function addAttObjects(e,t){if(e)for(key in e)e.hasOwnProperty(key)&&key.substr(0,key.length-1)===t&&addAttObject(e[key])}function addAttObject(e,t){var n=new AttObject(e),o=document.querySelector(".att-canvas.active"),a=PbxObject.attendant.currentPid+(e.button?e.button:0);if(e.button)changeAvailableButtons(e.button,o);else{var r=o.querySelector(".att-init-button");r&&isMainEl()&&r.parentNode.removeChild(r)}t?(o.insertBefore(n,t.element),t.removeElement(null,t.params),t.params.button!==e.button&&changeObjectsParent(PbxObject.attendant.currentPid+t.params.button,a)):o.insertBefore(n,o.lastChild),e.connector&&(e.data=e.data.split(" - ")[0]),e.oid=a,PbxObject.attendant.objects[a]!==e&&(PbxObject.attendant.objects[a]=e,t?rebuildSchema():addToSchema(a,e)),setupInProgress()}function AttObject(t){var e=formAttParams(t),n=PbxObject.templates.attendant_object,o=Mustache.render(n,e),a=document.createElement("div"),r=PbxObject.attendant.currentPid+(t.button?t.button:0);a.className="att-obj-wrapper",a.innerHTML=o;var i=a.querySelector("#enter-att-menu"),s=a.querySelector("#edit-att-object"),c=a.querySelector("#remove-att-object");return removeTreeBtn=a.querySelector("#remove-att-tree"),i&&addEvent(i,"click",function(e){this.enterAttMenu(e,t)}.bind(this)),s&&addEvent(s,"click",function(e){this.editObject(e,t)}.bind(this)),c&&addEvent(c,"click",function(e){this.removeElement(e,t)}.bind(this)),removeTreeBtn&&addEvent(removeTreeBtn,"click",function(e){this.removeElement(e,t,!0)}.bind(this)),this.oid=r,this.params=t,this.element=a}function removeObject(e,t){var n=PbxObject.attendant.objects,o=(document.getElementById("objname").value,t?new RegExp(e+"d*"):new RegExp("^"+e+"$"));for(var a in n)n.hasOwnProperty(a)&&o.test(a)&&delete n[a];removeCanvases(e),setupInProgress()}function changeObjectsParent(e,t){var n=PbxObject.attendant.objects,o=new RegExp(e+"d*"),a="";for(var r in n)n.hasOwnProperty(r)&&o.test(r)&&(n[a=r.replace(e,t)]=n[r],n[a].oid=a,delete n[r])}function checkParams(e){var t="";return e.button||isMainEl()||(t+=PbxObject.frases.ATT__BTN_MISSED+"\n"),e.type===PbxObject.attendant.types.menu||e.connector||(t+=PbxObject.frases.ATT__CONN_MISSED+"\n"),e.type!==PbxObject.attendant.types.menu||e.file||e.data||(t+=PbxObject.frases.ATT__AUDIO_FILE_MISSED+"\n"),""===t||(alert(t),!1)}function showAttObjectSetts(i,s){var c=formAttParams(i);getAttTemplate("attendant_modal",function(e){var t=Mustache.render(e,c);n||((n=document.createElement("div")).id="att-setts-cont",$("#pagecontainer").prepend(n)),$(n).html(t);var n=document.getElementById("att-setts-cont"),o=document.getElementById("att-setts-data"),a=document.querySelector('#att-setts-form select[name="data"]'),r=document.querySelector('#att-setts-form select[name="button"]');a&&i.connector&&(a.value=i.connector),r&&i.button&&(r.value=i.button),i.type===PbxObject.attendant.types.menu?customize_upload("audioFile",i.data||""):i.type!==PbxObject.attendant.types.mail&&i.type!==PbxObject.attendant.types.commutator||customize_upload("audioFile",i.audio||""),$("#set-att-object").on("click",function(e){setAttObject(i,s)}),$('#att-setts-modal [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),o&&ReactDOM.render(Select3({name:"data",placeholder:PbxObject.frases.ATTENDANT.DATA_PLACEHOLDER,frases:PbxObject.frases,value:{value:c.data.data,label:c.data.data},options:c.connectors}),o),$("#att-setts-modal").on("shown.bs.modal",function(){document.querySelector('#att-setts-modal input[name="name"]').focus()}),$("#att-setts-modal").on("hide.bs.modal",function(){$('#att-setts-modal [data-toggle="popover"]').popover("destroy"),$("#set-att-object").off("click",function(e){setAttObject(i,s)})}),$("#att-setts-modal").modal()})}function setAttObject(e,t){var n=collectAttParams(e);checkParams(n)&&(t?addAttObject(n,t):addAttObject(n),$("#att-setts-modal").modal("hide"),setupInProgress())}function collectAttParams(e){var t,n=document.getElementById("att-setts-cont"),o=e.type,a="",r=(PbxObject.attendant.types.menu,extend({},e));if(isMainEl()?r.button=null:r.button=n.querySelector('select[name="button"]').value,r.name=n.querySelector('input[name="name"]').value||generateAttObjName(o,r.button),(r.type=o)===PbxObject.attendant.types.menu){var i=n.querySelector('input[type="file"]'),s=n.querySelector('[name="digits"]');i&&(i.files.length?(a=i.files[0].name,r.file=i,r.data=a):e.file&&(r.file=e.file)),!r.data&&e.file&&(a=e.file.files[0].name,r.data=a),r.digits=s.checked?"14":"1"}else t=n.querySelector('[name="data"]').value,r.data=t,r.connector=t;if(o===PbxObject.attendant.types.mail||o===PbxObject.attendant.types.commutator){var c=n.querySelector('input[name="subject"]'),l=n.querySelector('textarea[name="body"]');(i=n.querySelector('input[type="file"]'))&&(i.files.length?(r.file=i,r.audio=i.files[0].name):e.file&&(r.file=e.file)),!r.audio&&e.file&&(r.audio=e.file.files[0].name),c&&(r.subject=c.value),l&&(r.body=l.value)}return r}function formAttParams(e){var t={data:e,pid:PbxObject.attendant.currentPid,connectors:[],buttons:PbxObject.attendant.availableButtons,frases:PbxObject.frases,typeMenu:function(){return this.data.type==PbxObject.attendant.types.menu},typeCommutator:function(){return this.data.type==PbxObject.attendant.types.commutator},typeEmail:function(){return this.data.type==PbxObject.attendant.types.mail},allowMultipleDigits:function(){return"14"===this.data.digits},objType:function(){return this.frases.ATTENDANT[this.data.type.toUpperCase()]}};return t.data.name=t.data.name||generateAttObjName(t.data.type,t.pid),e.type===PbxObject.attendant.types.commutator?(t.connectors=PbxObject.attendant.connectors.filter(function(e){return-1===e.ext.indexOf("@")}),t.connectors=t.connectors.concat(PbxObject.attendant.routes)):e.type===PbxObject.attendant.types.mail&&(t.connectors=PbxObject.attendant.connectors.filter(function(e){return-1!==e.ext.indexOf("@")})),t.connectors=t.connectors.map(formatConnectors),t}function formatConnectors(e){return{value:e.ext,label:e.name?e.ext+" - "+e.name:e.ext}}function generateAttObjName(e,t,n){return PbxObject.attendant.currentPid||n?n||PbxObject.frases.ATTENDANT[e.toUpperCase()]:e===PbxObject.attendant.types.menu?PbxObject.frases.ATTENDANT.MAIN_MENU:PbxObject.frases.ATTENDANT.MAIL}function generateAttObjPath(e){return e.replace("0","").split("").reduce(function(e,t){return e+"."+t})}function setAttPosition(e){if(e=e||window.event){var t=e.target;if("LABEL"===t.nodeName&&("fa fa-plus"===t.className?t.className="fa fa-minus":t.className="fa fa-plus"),"A"!==t.nodeName&&(t=t.parentNode),"A"===t.nodeName){e.preventDefault();var n=t.href.substr(t.href.indexOf("#")+1);t.hash;makeActiveCanvas(n)}}}function addConnectors(e){var t=document.getElementById("attconnectors").querySelector("tbody");e.forEach(function(e){t.appendChild(createConnectorRow(e)),PbxObject.attendant.connectors.push(e)})}function addConnector(e){(e=e||window.event)&&"click"==e.type&&e.preventDefault();var t,n=document.getElementById("attconnectors"),o=n.querySelector("tbody"),a=n.querySelector('input[name="connName"]'),r=n.querySelector('input[name="connVal"]'),i=PbxObject.attendant.connectors;if(Utils.validateElement(a,a.parentNode),Utils.validateElement(r,r.parentNode),!r.value||!a.value)return!1;t={name:a.value,ext:r.value},o.appendChild(createConnectorRow(t)),a.value="",r.value="",i.push(t),setupInProgress()}function removeConnector(n){var o=PbxObject.attendant.connectors;o.forEach(function(e,t){e.name===n.name&&o.splice(t,1)}),setupInProgress()}function createConnectorRow(t){var e=e||window.event;e&&"click"==e.type&&e.preventDefault();var n,o,a=document.createElement("tr");return n=a.insertCell(0),t&&t.name&&(n.textContent=t.name),n=a.insertCell(1),t&&t.ext&&(n.textContent=t.ext),n=a.insertCell(2),(o=document.createElement("a")).href="#",o.className="remove-clr",o.innerHTML='<i class="fa fa-close"></i>',addEvent(o,"click",function(e){remove_row(e),removeConnector(t)}),n.appendChild(o),a}function getAttTemplate(t,n){PbxObject.templates=PbxObject.templates||{};var e=PbxObject.templates[t];e?n(e):$.get("/badmin/views/"+t+".html",function(e){PbxObject.templates[t]=e,n(e)})}function filterByPattern(e,t){if(t){var n=new RegExp(t);return e.filter(function(e){return n.test(e.ext)})}return e}function isMainEl(){return!PbxObject.attendant.currentPid}function set_attendant(){var e,t=document.getElementById("objname").value,n=(document.querySelector(".att-container"),PbxObject.attendant.objects),o=PbxObject.oid,a=retrieveFormData(document.getElementById("attvariables")),r=document.getElementById("attGreetings"),i=document.getElementById("ringbackMusic"),s=document.getElementById("connectionFailed"),c=document.getElementById("leaveMessage"),l=PbxObject.options.prefix,d="users"+(l?"/"+l:"")+"/attendant/"+o+"/";if(r.files[0]&&upload(r,"/attendant/"+o+"/"+r.files[0].name),i.files[0]&&upload(i,"/attendant/"+o+"/"+i.files[0].name),s.files[0]&&upload(s,"/attendant/"+o+"/"+s.files[0].name),c.files[0]&&upload(c,"/attendant/"+o+"/"+c.files[0].name),!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',PbxObject.oid&&(e+='"oid":"'+o+'",'),e+='"kind":"attendant",';var u,m,b=document.getElementById("enabled");for(var p in null!=b&&(e+='"enabled":'+b.checked+","),e+='"debug":'+document.getElementById("debug").checked+",",e+='"parameters":[',e+="{",e+='"key":"algdir",',e+='"value":"'+d+'"',e+="},",n)n.hasOwnProperty(p)&&(u=n[p].file)&&(u.files.length&&(m=(m=u.files[0].name.split("."))[0]+"_"+n[p].oid+"."+m[1],n[p].audio?n[p].audio=m:n[p].data=m,upload(u,"/attendant/"+o+"/"+m)),delete n[p].file);for(var p in e+="{",e+='"key":"jsonString",',e+='"value":'+JSON.stringify(n),e+="},",e+="{",e+='"key":"connectors",',e+='"value":'+JSON.stringify(PbxObject.attendant.connectors),e+="},",a)a.hasOwnProperty(p)&&(e+="{",e+='"key":"'+p+'",',e+='"value":"'+a[p]+'"',e+="},");setObject(e+="],",function(e){set_object_success(e),setupInProgress(!1)})}function load_bgroup(n){switch_presentation(n.kind);var e,t=document,o=n.kind,a=n.members,r=t.getElementById("dcontainer"),i=document.getElementById("enabled"),s=document.getElementById("new-user-form"),c=$(".object-name .switch"),l=n.available,d=PbxObject.options.maxusers,u=PbxObject.options.storelimit,m=document.getElementById("el-set-object"),b=document.getElementById("el-delete-object"),p=document.getElementById("services-cont");if(PbxObject.isUserAccount&&!checkPermissions("equipment",3)&&(m.parentNode.removeChild(m),p.parentNode.removeChild(p)),PbxObject.isUserAccount&&!checkPermissions("equipment",15)&&b.parentNode.removeChild(b),l&&(l=l.sort(),PbxObject.available=l),PbxObject.oid=n.oid,PbxObject.name=n.name,n.name&&(t.getElementById("objname").value=n.name),i&&(i.checked=n.enabled,addEvent(i,"change",function(){setObjectState(n.oid,this.checked,function(e){e||(i.checked=!i.checked)})})),"users"===o||"equipment"===o){var f=document.getElementById("group-extensions").querySelector("tbody"),g=document.getElementById("available-users"),h=document.getElementById("group-protocol"),v=document.getElementById("get-proto-opts"),y=(document.getElementById("new-user-form"),document.getElementById("clear-input"),document.getElementById("add-user")),x=document.getElementById("user-login"),E="users"===o?"user":"phone";if("equipment"==o){var O=n.options.protocols||n.options.protocol;if(addEvent(g,"change",function(e){x.value=createExtLogin(e.target.value)}),"object"==typeof O)O.forEach(function(e){h.innerHTML+='<option value="'+e+'">'+e+"</option>"});else{var j=h.parentNode,P=document.createElement("span");P.className="form-control-static",P.textContent=O,j.insertBefore(P,h),j.removeChild(h)}addEvent(v,"click",function(){get_protocol_opts(n.options.protocol||h.value,n.options)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={}}l&&l.length?(makeElement(l.sort(),g,function(e){var t=document.createElement("option");return t.value=e,t.textContent=e,t}),x.value=createExtLogin(g.value)):y.setAttribute("disabled","disabled"),addEvent(s,"submit",function(e){e.preventDefault(),addUser(E,function(){cleanForm("new-user-form"),"users"===o&&s.storelimit&&u&&d&&(s.storelimit.value=(convertBytes(u,"Byte","GB")/d).toFixed(2)),x.value=createExtLogin(g.value)})}),makeElement(sortByKey(a,"number"),f,addMembersRow),PbxObject.members=a||[],PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer?$("#from-directory-btn").show():$("#from-directory-btn").hide()}else l&&fill_list_items("available",l),a&&fill_list_items("members",a,"number");if(n.options)if("equipment"==o){var _=document.getElementById("devtype"),I=document.getElementById("group-protocol"),C=n.options.kind||"ipphones",k=document.getElementById("tr-register"),w=document.getElementById("tr-proxy");_.value=C,n.options.protocol||(I.value="sip"),switch_options_tab("tab-"+C),_.onchange=function(){switch_options_tab("tab-"+(C=this.options[this.selectedIndex].value)),switchVisibility(c,"trunk"===C)},1!==PbxObject.options.mode||PbxObject.options.prefix?(_.removeChild(_.children[_.children.length-1]),c.hide()):switchVisibility(c,"trunk"===C),void 0!==n.options.gateway&&(t.getElementById("regname").value=n.options.gateway.regname||"",t.getElementById("regpass").value=n.options.gateway.regpass||""),"trunk"==C&&(document.getElementById("tr-domain").value=n.options.trunk.domain||"",document.getElementById("tr-user").value=n.options.trunk.user||"",document.getElementById("tr-auth").value=n.options.trunk.auth||"",document.getElementById("tr-pass").value=n.options.trunk.pass||"",document.getElementById("tr-regexpires").value=n.options.trunk.regexpires||60,k.checked=n.options.trunk.register,isVisible("reg-setts",k.checked),w.checked=n.options.trunk.proxy,isVisible("proxy-setts",w.checked),document.getElementById("tr-paddr").value=n.options.trunk.paddr||"",document.getElementById("tr-pauth").value=n.options.trunk.pauth||"",document.getElementById("tr-ppass").value=n.options.trunk.ppass||""),t.getElementById("phonelines").value=n.options.phonelines||"1",null!=n.options.starflash&&(t.getElementById("starflash").checked=n.options.starflash),addEvent(k,"change",function(e){isVisible("reg-setts",this.checked)}),addEvent(w,"change",function(e){isVisible("proxy-setts",this.checked)})}else if("unit"==o){if(t.getElementById("groupno1").value=n.options.groupno||"",t.getElementById("timeout1").value=n.options.timeout||"",void 0!==n.options.huntmode){var B=t.getElementById("huntmode1");B.selectedIndex=n.options.huntmode,addEvent(B,"change",function(){checkHuntMode()}),checkHuntMode()}void 0!==n.options.huntfwd&&(t.getElementById("huntfwd1").checked=n.options.huntfwd);var S=n.options.greeting||"",T=n.options.waitmusic||"";customize_upload("unit-greeting",S),customize_upload("unit-waitmusic",T)}else if("pickup"==o)t.getElementById("groupno2").value=n.options.groupno||"";else if("conference"==o||"channel"==o||"selector"==o){var A=["OFF","320x240","352x288","640x360","640x480","704x576","1024x768","1280x720","1920x1080"],N=document.getElementById("initmode");if(N&&(N.onchange=function(){2==N.options[N.selectedIndex].value?document.getElementById("conf-greetfile").style.display="block":document.getElementById("conf-greetfile").style.display="none"}),PbxObject.videomax=n.options.maxvideomode,customize_upload("onhold2",n.options.onholdfile||""),customize_upload("greeting2",n.options.greetingfile||""),"channel"==o){var M,L=[].slice.call(r.querySelectorAll('input[name="objectType"]')),D=document.getElementById("out-number"),R=document.getElementById("channel-type-sel"),q=document.getElementById("video");L.forEach(function(e){if(n.external){if("global"==e.value){var t=e.parentNode;e.checked=!0,$(t).button("toggle"),M=e.value}D.value=n.external}else if("local"==e.value){t=e.parentNode;e.checked=!0,$(t).button("toggle"),M=e.value}R.onclick=function(e){var t=(e=e||window.event).target;"LABEL"===t.nodeName&&changeGroupType(M=t.children[0].value)}}),q&&("OFF"!==n.options.videomode?q.checked=!0:q.checked=!1),N&&(N.value=n.options.initmode);var U=n.options.musiconback||"";document.getElementById("playmusiconback").checked=!!U,customize_upload("musiconback",U),changeGroupType(M)}else if("selector"==o){var F=n.owner,H=document.getElementById("owner");N&&(N.value=n.options.initmode),2==n.options.initmode?document.getElementById("conf-greetfile").style.display="block":document.getElementById("conf-greetfile").style.display="none",initcalls.checked=n.options.initcalls,l.concat(n.members).sort().forEach(function(e){H.innerHTML+=F&&e==F?'<option value="'+e+'" selected>'+e+"</option>":'<option value="'+e+'">'+e+"</option>"})}t.getElementById("dialuptt").value=n.options.dialtimeout||"",t.getElementById("autoredial").checked=n.options.autoredial,"channel"!==o&&(t.getElementById("confrecord").checked=n.options.recording);var z=t.getElementById("playgreet");z.checked=n.options.greeting,z.checked&&(z.checked=!!n.options.greetingfile);var K=t.getElementById("videoform");if(K)for(e=0;e<A.length;e++){var G=t.createElement("option");if(G.value=A[e],G.innerHTML=A[e],K.appendChild(G),A[e]==n.options.videomode&&(K.selectedIndex=e),A[e]==n.options.maxvideomode)break}var Y=document.getElementById("confrecord"),J=document.getElementById("rectime-cont"),V=document.getElementById("rectime");addEvent(Y,"change",function(e){this.checked?J.classList.remove("hidden"):J.classList.add("hidden")}),Y&&void 0!==n.options.recording&&(Y.checked=n.options.recording,Y.checked&&J.classList.remove("hidden")),V&&void 0!==n.options.rectime&&(V.value=n.options.rectime/60)}if(null!=n.profile){t.getElementById("forwarding")&&(t.getElementById("forwarding").checked=n.profile.forwarding),t.getElementById("callpickup")&&(t.getElementById("callpickup").checked=n.profile.callpickup),t.getElementById("dndover")&&(t.getElementById("dndover").checked=n.profile.dndover),t.getElementById("busyover")&&(t.getElementById("busyover").checked=n.profile.busyover),t.getElementById("monitor")&&(t.getElementById("monitor").checked=n.profile.monitor),t.getElementById("dnd")&&(t.getElementById("dnd").checked=n.profile.dnd),t.getElementById("clir")&&(t.getElementById("clir").checked=n.profile.clir),t.getElementById("pickupdeny")&&(t.getElementById("pickupdeny").checked=n.profile.pickupdeny),t.getElementById("busyoverdeny")&&(t.getElementById("busyoverdeny").checked=n.profile.busyoverdeny),t.getElementById("monitordeny")&&(t.getElementById("monitordeny").checked=n.profile.monitordeny),t.getElementById("callwaiting")&&(t.getElementById("callwaiting").checked=n.profile.callwaiting),t.getElementById("outcallbarring")&&(t.getElementById("outcallbarring").checked=n.profile.outcallbarring),t.getElementById("costroutebarring")&&(t.getElementById("costroutebarring").checked=n.profile.costroutebarring),t.getElementById("recording")&&(t.getElementById("recording").checked=n.profile.recording),t.getElementById("hiderecind")&&(t.getElementById("hiderecind").checked=n.profile.hiderecindication),t.getElementById("voicemail")&&(t.getElementById("voicemail").checked=n.profile.voicemail);var W=n.profile.bnumbertransforms;if(0!=W.length)for(e=0;e<W.length;e++)append_transform(null,"transforms",W[e]);else append_transform(null,"transforms")}if(TableSortable.sortables_init(),show_content(),set_page(),PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer.trim().length&&(PbxObject.LdapConnection=Ldap({domains:PbxObject.options.ldap.directoryDomains.split(" "),available:PbxObject.available,onaddusers:onAddLdapUsers}),$("#from-directory-btn").click(function(){PbxObject.LdapConnection.auth()})),"users"===o){var Q=PbxObject.options.services.filter(function(e){return e.state});s.storelimit&&u&&d&&(s.storelimit.value=(convertBytes(u,"Byte","GB")/d).toFixed(2)),Q.length?$("#services-cont").append(Q.map(createServiceBtn)):PbxObject.options.ldap&&(!PbxObject.options.ldap||PbxObject.options.ldap.directoryServer)||$("#add-external-user").hide();var X=window.sessionStorage.getItem("serviceParams");X&&(getExternalUsers(JSON.parse(X)),window.sessionStorage.removeItem("serviceParams"))}}function onAddLdapUsers(e){if(PbxObject.name){var t=PbxObject.LdapConnection;document.getElementById("available-users");t.setUsers({groupid:PbxObject.oid,username:t.options.username,password:t.options.password,domain:t.options.domain,users:e},function(e){t.close(),refreshUsersTable(function(e){t.options.available=e})})}else set_bgroup(e,onAddLdapUsers)}function createServiceBtn(t){var e=document.createElement("button");return e.type="button",e.className="btn btn-default padding-lg pl-users",e.innerHTML="<span>"+PbxObject.frases.IMPORT_USERS_FROM+" </span><strong>"+t.name+"</strong>",addEvent(e,"click",function(e){getExternalUsers(t)}),e}function getExternalUsers(e){PbxObject.LdapConnection=Ldap({service_id:e.id,service_type:e.type,available:PbxObject.available,onaddusers:setExternalUsers}),1===e.type?PbxObject.LdapConnection.getExternalUsers():json_rpc_async("getExternalUsers",{service_id:e.id},function(e){e&&PbxObject.LdapConnection.showUsers(e)})}function setExternalUsers(e){if(PbxObject.name){var t=PbxObject.LdapConnection;t.setExternalUsers({groupid:PbxObject.oid,service_id:t.options.service_id,users:e},function(e){t.close(),refreshUsersTable(function(e){t.options.available=e})})}else set_bgroup(e,setExternalUsers)}function set_bgroup(n,o){var e,a,t,r=document,i=PbxObject.oid,s=PbxObject.kind,c=r.getElementById("members"),l=r.getElementById("profile"),d=r.getElementById("playgreet"),u=r.getElementById("objname").value,m=document.getElementById("enabled"),b=[].slice.call(document.querySelectorAll('input[name="objectType"]'));if(u){if(e='"name":"'+u+'",',show_loading_panel(),a=PbxObject.name?set_object_success:(PbxObject.name=u,null),i&&(e+='"oid":"'+i+'",'),s&&(e+='"kind":"'+s+'",'),m&&(e+='"enabled":'+m.checked+","),"users"!=s&&"equipment"!=s){e+='"members":[';for(var p=0;p<c.children.length;p++)e+='"'+c.children[p].innerHTML+'",';e+="],"}if("users"==s||"equipment"==s){e+='"members":[';for(p=0;p<PbxObject.members.length;p++)e+='"'+PbxObject.members[p].number+'",';e+="],"}if("channel"==s){if(b.forEach(function(e){e.checked&&(t=e.value)}),"global"==t)d.checked=!1,e+='"external":"'+document.getElementById("out-number").value+'",'}else if("selector"==s){e+='"owner":"'+document.getElementById("owner").options[document.getElementById("owner").selectedIndex].value+'",'}else if("users"==s||"unit"==s||"equipment"==s){if(l)e+='"profile":{',null!=r.getElementById("forwarding")&&(e+='"forwarding":'+r.getElementById("forwarding").checked+","),null!=r.getElementById("callpickup")&&(e+='"callpickup":'+r.getElementById("callpickup").checked+","),null!=r.getElementById("dndover")&&(e+='"dndover":'+r.getElementById("dndover").checked+","),null!=r.getElementById("busyover")&&(e+='"busyover":'+r.getElementById("busyover").checked+","),null!=r.getElementById("monitor")&&(e+='"monitor":'+r.getElementById("monitor").checked+","),null!=r.getElementById("dnd")&&"users"!==s&&(e+='"dnd":'+r.getElementById("dnd").checked+","),null!=r.getElementById("recording")&&(e+='"recording":'+r.getElementById("recording").checked+","),null!=r.getElementById("hiderecind")&&(e+='"hiderecindication":'+r.getElementById("hiderecind").checked+","),null!=r.getElementById("callwaiting")&&"users"!==s&&(e+='"callwaiting":'+r.getElementById("callwaiting").checked+","),null!=r.getElementById("pickupdeny")&&(e+='"pickupdeny":'+r.getElementById("pickupdeny").checked+","),null!=r.getElementById("monitordeny")&&(e+='"monitordeny":'+r.getElementById("monitordeny").checked+","),null!=r.getElementById("busyoverdeny")&&(e+='"busyoverdeny":'+r.getElementById("busyoverdeny").checked+","),null!=r.getElementById("voicemail")&&(e+='"voicemail":'+r.getElementById("voicemail").checked+","),null!=r.getElementById("outcallbarring")&&(e+='"outcallbarring":'+r.getElementById("outcallbarring").checked+","),null!=r.getElementById("costroutebarring")&&(e+='"costroutebarring":'+r.getElementById("costroutebarring").checked+","),r.getElementById("transforms").getElementsByTagName("tbody")[0]&&(e+='"bnumbertransforms":[',e+=encode_transforms("transforms"),e+="]"),e+="},"}if(e+='"options":{',"equipment"==s){var f=JSON.stringify(PbxObject.protocolOpts);f=f.substr(1,f.length-2);var g=document.getElementById("devtype"),h=g.options[g.selectedIndex].value,v=document.getElementById("group-protocol");if(v&&(e+='"protocol":"'+v.options[v.selectedIndex].value+'",'),"ipphones"==h)e+='"kind":"ipphones",';else if("gateway"==h)e+='"kind":"gateway",',e+='"gateway":{',e+='"regname":"'+r.getElementById("regname").value+'",',e+='"regpass":"'+r.getElementById("regpass").value+'",',e+="},";else if("trunk"==h){var y=document.getElementById("tr-register").checked,x=document.getElementById("tr-proxy").checked;e+='"kind":"trunk",',e+='"trunk":{',e+='"domain":"'+document.getElementById("tr-domain").value+'",',e+='"register":'+y+",",y&&(e+='"user":"'+document.getElementById("tr-user").value+'",',e+='"auth":"'+document.getElementById("tr-auth").value+'",',e+='"pass":"'+document.getElementById("tr-pass").value+'",',e+='"regexpires":'+document.getElementById("tr-regexpires").value+","),e+='"proxy":'+x+",",x&&(e+='"paddr":"'+document.getElementById("tr-paddr").value+'",',e+='"pauth":"'+document.getElementById("tr-pauth").value+'",',e+='"ppass":"'+document.getElementById("tr-ppass").value+'",'),e+="},"}r.getElementById("phonelines")&&(e+='"phonelines":'+r.getElementById("phonelines").value+","),r.getElementById("starflash")&&(e+='"starflash":'+r.getElementById("starflash").checked+","),e+=f}else if("unit"==s){e+='"groupno":"'+r.getElementById("groupno1").value+'",',e+='"timeout":'+r.getElementById("timeout1").value+",",e+='"huntmode":'+r.getElementById("huntmode1").value+",",e+='"huntfwd":'+r.getElementById("huntfwd1").checked+",";var E=document.getElementById("unit-greeting"),O=document.getElementById("unit-waitmusic");E.value&&(E.files[0]&&(e+='"greeting":"'+E.files[0].name+'",'),upload("unit-greeting")),O.value&&(O.files[0]&&(e+='"waitmusic":"'+O.files[0].name+'",'),upload("unit-waitmusic"))}else if("pickup"==s)e+='"groupno":"'+r.getElementById("groupno2").value+'",';else if("conference"==s||"channel"==s||"selector"==s){var j=document.getElementById("initmode"),P=j.options[j.selectedIndex].value;d=r.getElementById("playgreet");if(file2=document.getElementById("greeting2"),e+='"autoredial":'+r.getElementById("autoredial").checked+",",e+='"recording":'+r.getElementById("confrecord").checked+",",e+='"greeting":'+d.checked+",",r.getElementById("rectime")&&r.getElementById("confrecord").checked&&(e+='"rectime":'+60*r.getElementById("rectime").value+","),d.checked&&file2.value&&(file2.files[0]&&(e+='"greetingfile":"'+file2.files[0].name+'",'),upload("greeting2")),"channel"!=s&&(e+='"dialtimeout":'+r.getElementById("dialuptt").value+",",e+='"videomode":"'+r.getElementById("videoform").value+'",'),"selector"==s)e+='"initcalls":'+document.getElementById("initcalls").checked+",",2==P&&(file3=document.getElementById("onhold2"),file3.value&&(file3.files[0]&&(e+='"onholdfile":"'+file3.files[0].name+'",'),upload("onhold2")));if("channel"==s){var _=document.getElementById("playmusiconback").checked;if(e+='"playmusiconback":'+_+",",_){var I=document.getElementById("musiconback");I.files[0]&&(e+='"musiconback":["'+I.files[0].name+'"],'),upload("musiconback")}document.getElementById("video").checked?e+='"videomode":"640x480",':e+='"videomode":"OFF",'}e+='"initmode":'+P+","}json_rpc_async("setObject",e+="}",function(e,t){"function"==typeof a&&a(),"function"==typeof o&&o(n)})}else alert(PbxObject.frases.MISSEDNAMEFIELD)}function renderObjRoute(e){ReactDOM.render(ObjectRoute({routes:e.routes,frases:e.frases,onChange:e.onChange}),document.getElementById("object-route-cont"))}function addMembersRow(e){var t,n,o,a,r;return t=document.createElement("tr"),r=(a=getInfoFromState(e.state,!0)).rstatus,a.rclass,t.id=e.oid,n=t.insertCell(0),e.oid?(t.setAttribute("data-ext",e.number),(o=document.createElement("a")).textContent=e.number,o.href="#",addEvent(o,"click",get_extension),n.appendChild(o)):n.textContent=e.number,(n=t.insertCell(1)).setAttribute("data-cell","name"),n.textContent=e.name||"",(n=t.insertCell(2)).setAttribute("data-cell","display"),n.textContent=e.display||"",(n=t.insertCell(3)).setAttribute("data-cell","reg"),n.textContent=e.followme||e.reg||"",(n=t.insertCell(4)).setAttribute("data-cell","status"),n.innerHTML='<span class="label label-'+a.className+'">'+r+"</span>",PbxObject.isUserAccount&&!checkPermissions("equipment",3)||(n=t.insertCell(5),button=document.createElement("button"),button.className="btn btn-link btn-danger btn-md",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",delete_extension),n.appendChild(button)),t}function addUser(e,r){var i,t,n,o=o||window.event,s=document.getElementById("group-extensions").querySelector("tbody"),c=document.getElementById("available-users"),a=c.options,l=document.getElementById("user-name"),d=document.getElementById("user-login"),u=document.getElementById("user-email"),m=document.getElementById("user-alias"),b=document.getElementById("user-pass"),p=document.getElementById("storelimit");if(a.length)if(PbxObject.name){i=c.options[c.selectedIndex].value,t=l.value||PbxObject.frases.KINDS[e]+" "+i,login=d.value,email=u.value,n=m?m.value:t;var f='"kind":"'+e+'",';f+='"groupid":"'+PbxObject.oid+'",',login&&(f+='"login":"'+login+'",'),email&&(f+='"info": { "email": "'+email+'" },'),f+='"number":"'+i+'",',f+='"name":"'+t+'",',f+='"display":"'+n+'",',f+='"password":"'+b.value+'",',0<=(p=convertBytes(parseFloat(p.value),"GB","Byte"))&&(f+='"storelimit":'+p+",");var g={kind:e,groupid:PbxObject.oid,number:i,name:t,display:n,password:b.value};json_rpc_async("setObject",f,function(e,t){if(e){g.oid=e;var n=addMembersRow(g);s.rows.length?s.insertBefore(n,s.firstChild):s.appendChild(n),PbxObject.members.push(g),-1!==PbxObject.available.indexOf(i)&&PbxObject.available.splice(PbxObject.available.indexOf(i),1);for(var o=document.getElementById("select2-available-users-container"),a=([].slice.call(c.options),0);a<c.options.length;a++)c.options[a].value===i&&(c.removeChild(c.options[a]),o&&(c.options.length?o.textContent=c.options[0].value:o.textContent=""));if(!c.options.length)document.getElementById("add-user").setAttribute("disabled","disabled");$("#new-user-form").trigger("users.create"),r&&r()}else notify_about("error",t&&t.message)})}else set_bgroup(e,function(){addUser(e,r)})}function refreshUsersTable(t){var n=document.getElementById("available-users");json_rpc_async("getObject",{oid:PbxObject.oid},function(e){PbxObject.available=e.available.sort(),makeElement(sortByKey(e.members,"number"),document.getElementById("group-extensions").querySelector("tbody"),addMembersRow,!0),makeElement(PbxObject.available.sort(),n,function(e){var t=document.createElement("option");return t.value=e,t.textContent=e,t},!0),$(n).trigger("change"),remove_loading_panel(),t&&t(PbxObject.available)})}function cleanForm(e){document.getElementById(e).reset()}function checkHuntMode(e){0==(e?e.target:document.getElementById("huntmode1")).selectedIndex?document.getElementById("huntmodesetts").classList.add("hidden"):document.getElementById("huntmodesetts").classList.remove("hidden")}function createExtLogin(e){return PbxObject.options.prefix?PbxObject.options.prefix+e:e}AttObject.prototype.enterAttMenu=function(e,t){(e=e||window.event).preventDefault(),makeActiveCanvas(this.oid)},AttObject.prototype.editObject=function(e,t){(e=e||window.event).preventDefault(),showAttObjectSetts(this.params,this)},AttObject.prototype.removeElement=function(e,t,n){e&&e.preventDefault();var o=this.element.querySelector("#enter-att-menu"),a=this.element.querySelector("#edit-att-object"),r=this.element.querySelector("#remove-att-object");removeTreeBtn=this.element.querySelector("#remove-att-tree"),o&&removeEvent(o,"click",function(){this.enterAttMenu(e,t)}.bind(this)),a&&removeEvent(a,"click",function(){this.editObject(e,t)}.bind(this)),r&&removeEvent(r,"click",function(e){this.removeElement(e)}.bind(this)),removeTreeBtn&&removeEvent(removeTreeBtn,"click",function(e){this.removeElement(e)}.bind(this)),this.element.parentNode.removeChild(this.element),e?(removeObject(this.oid,n),removeFromSchema(this.oid),"0"==this.oid&&createInitButton()):removeObject(this.oid),changeAvailableButtons(t.button),setupInProgress()};var BillingApi={url:"https://api-web.ringotel.net/branch/api/",cache:{},fetch:function(e,t,n,o,a){var r,i,s;(r=new XMLHttpRequest).open(e,t,!0),o&&o.headers&&o.headers.forEach(function(e){r.setRequestHeader(e.name,e.value)}),i=setTimeout(function(){r.abort()},6e4),r.onload=function(e){clearTimeout(i);e.target.getAllResponseHeaders();var t=e.target.status,n=e.target.responseText;if(n)try{n=JSON.parse(n)}catch(e){console.log("response in not JSON")}if(403===t)logout();else if(200===t)a&&a(null,n);else if(500<=t){if(a)return a("The service is under maintenance. Please, try again later.")}else a&&a(n.error)},n?(r.setRequestHeader("Content-Type","application/json"),s=JSON.stringify(n),r.send(s)):r.send()},request:function(e,t,n){var o=window.localStorage.getItem("ringo_tid");if(!o)return n("MISSING_TOKEN");this.fetch("POST",this.url+e,t||null,{headers:[{name:"x-access-token",value:o}]},function(e,t){if(e||t.error)return n(e||t.error);n&&n(null,t)})},sendAppsLinks:function(e,t){this.request("sendAppsLinks",{email:e},t)},getProration:function(e,t){var n=Date.now(),o=Math.floor((e.nextBillingDate-e.prevBillingDate)/1e3),a=((e.nextBillingDate>n?Math.floor((e.nextBillingDate-n)/1e3):0)/o).toFixed(2);return parseFloat(t)*parseFloat(a)},getProfile:function(e){this.request("getProfile",null,e)},updateBalance:function(e,t){this.request("updateBalance",e,t)},addCard:function(e,t){this.request("addCard",e,t)},updateCard:function(e,t){this.request("updateCard",e,t)},getPlans:function(e,t){this.request("getPlans",e,t)},changePlan:function(e,t){this.request("changePlan",e,t)},getSubscription:function(e){this.request("getSubscription",null,e)},updateSubscription:function(e,t){this.request("updateSubscription",e,t)},renewSubscription:function(e,t){this.request("renewSubscription",e,t)},addCoupon:function(e,t){this.request("addCoupon",e,t)},getInvoices:function(e){this.request("getInvoices",null,e)},getDiscounts:function(e){this.request("getDiscounts",null,e)},getAssignedDids:function(e){this.request("getAssignedDids",null,e)},getUnassignedDids:function(e){this.request("getUnassignedDids",null,e)},orderDid:function(e,t){this.request("orderDid",e,t)},unassignDid:function(e,t){this.request("unassignDid",e,t)},getDidPrice:function(e,t){this.request("getDidPrice",e,t)},getDid:function(e,t){this.request("getDid",e,t)},getDidCountries:function(e){this.request("getDidCountries",null,e)},getDidLocations:function(e,t){this.request("getDidLocations",e,t)},hasDids:function(e){this.request("hasDids",null,e)},updateDidStatus:function(e,t){this.request("updateDidStatus",e,t)},updateDidRegistration:function(e,t){this.request("updateDidRegistration",e,t)},getCredits:function(e){this.request("getCredits",null,e)},addCredits:function(e,t){this.request("addCredits",e,t)}};function load_billing(){var e=document.getElementById("el-loaded-content"),o=PbxObject.profile,n={},a=[],r=PbxObject.frases;function i(){ReactDOM.render(BillingComponent({options:PbxObject.options,profile:o,sub:n,frases:PbxObject.frases,invoices:a,onAddPaymentMethod:s,setPrimaryPaymentMethod:c,removePaymentMethod:l,extend:deepExtend}),e)}function t(e,t){e?notify_about("error",e.message):(set_object_success(),o.billingMethod=t,o.billingDetails=(o.billingDetails||[]).concat([t]),i())}function s(e){PbxObject.PaymentsApi.open({profile:o},t)}function c(t){var n=o.billingDetails.filter(function(e){return e.id===t})[0];n&&d({type:"primary",title:r.BILLING.PAYMENT_METHODS.SET_PRIMARY_TITLE,text:Utils.interpolate(r.BILLING.PAYMENT_METHODS.SET_PRIMARY_CONTENT,{method:n.params.brand.toUpperCase()+" "+n.params.last4})},function(){show_loading_panel(),BillingApi.request("setPrimaryPaymentMethod",{pmid:t},function(e,t){if(show_content(),e||t.error)return notify_about("error",e.message||t.error.message);o.billingMethod=n,set_object_success(),i()})})}function l(n){var e=o.billingDetails.filter(function(e){return e.id===n})[0];d({type:"danger",title:r.BILLING.PAYMENT_METHODS.REMOVE_METHOD_TITLE,warning:Utils.interpolate(r.BILLING.PAYMENT_METHODS.REMOVE_METHOD_CONTENT,{method:e.params.brand.toUpperCase()+" "+e.params.last4})},function(){show_loading_panel(),BillingApi.request("removePaymentMethod",{pmid:n},function(e,t){if(show_content(),e||t.error)return notify_about("error",e.message||t.error.message);o.billingDetails=o.billingDetails.filter(function(e){return e.id!==n}),o.billingDetails.length?o.billingMethod=o.billingDetails[0]:o.billingMethod=null,set_object_success(),i()})})}function d(e,t){var n=document.getElementById("modal-cont"),o={frases:PbxObject.frases,type:e.type,title:e.title,warning:e.warning,text:e.text,onSubmit:t};n||((n=document.createElement("div")).id="modal-cont",document.body.appendChild(n)),ReactDOM.render(ConfirmActionModalComponent(o),n)}BillingApi.getSubscription(function(e,t){if(e)return notify_about("error",e.message);n=PbxObject.subscription=t.result,i(),show_content(),function(n){BillingApi.getInvoices(function(e,t){if(e)return n(e);n&&n(null,t.result||[])})}(function(e,t){if(e)return notify_about("error",e.message);a=t.filter(function(e){return e.paidAmount&&0<parseFloat(e.paidAmount)}),i()})})}function load_branch_options(){var a={},r=null,t=null,n=!1;function o(t,n){var o;t.files&&(t.files.forEach(function(e){uploadFile(e)}),delete t.files),o=t.lang&&t.lang!==r?set_options_success_with_reload:set_object_success,json_rpc_async("setPbxOptions",t,function(e){a=deepExtend(a,t),PbxObject.options=a,o(),n&&n()})}function i(e,t){show_loading_panel(),json_rpc_async("createAPIKey",e,function(e){show_content(),e&&set_object_success(),t(e)})}function s(e,t){show_loading_panel(),json_rpc_async("deleteAPIKey",e,function(e){show_content(),set_object_success(),t(e)})}function c(e){json_rpc_async("setDeviceSettings",e,null)}function l(e,n){json_rpc_async("setPbxOptions",e,function(e,t){t||e.error||set_object_success(),n&&n(t,e)})}function d(){var e=document.getElementById("modal-cont");e&&e.parentNode.removeChild(e),(e=document.createElement("div")).id="modal-cont",document.body.appendChild(e),ReactDOM.render(ChangePasswordComponent({frases:PbxObject.frases,open:!0,onSubmit:l}),e)}function u(){var e={frases:PbxObject.frases,singleBranch:n,params:a,branchParams:t,saveOptions:o,generateApiKey:i,deleteApiKey:s,saveBranchOptions:c,showChangePassSettings:d};ReactDOM.render(OptionsComponent(e),document.getElementById("el-loaded-content")),show_content()}json_rpc_async("getPbxOptions",null,function(e){r=(a=e).lang,(n=1===e.mode||!e.prefix)?json_rpc_async("getDeviceSettings",null,function(e){t=e,u(),close_options()}):(u(),close_options())})}function load_certificates(){PbxObject.options.mode&&0!==PbxObject.options.mode?$("#createCertBtn").click(createCert):$("#createCertBtn").remove(),$("#importCertBtn").click(importCert),getCertificates(),set_page()}function getCertificates(){json_rpc_async("getCertificates",null,function(e){fillCertTable(e)})}function fillCertTable(e){if(e){var t=document.querySelector("#certificates tbody");e.forEach(function(e){t.appendChild(createCertRow(e))}),close_options(),show_content()}}function createCertRow(t){var e,n,o,a=document.createElement("tr");return e=a.insertCell(0),(n=document.createElement("a")).href="#",n.innerHTML=t,addEvent(n,"click",function(e){downloadCert(e,t)}),e.appendChild(n),e=a.insertCell(1),(o=document.createElement("button")).className="btn btn-default btn-sm",o.innerHTML='<i class="fa fa-eye"></i>',addEvent(o,"click",function(){showCert(t)}),e.appendChild(o),e=a.insertCell(2),(o=document.createElement("button")).className="btn btn-danger btn-sm",o.innerHTML='<i class="fa fa-remove"></i>',addEvent(o,"click",function(){removeCert(t)}),e.appendChild(o),a.setAttribute("data-cert",t),a}function downloadCert(e,t){var n=e.target;n.getAttribute("download")||(e.preventDefault(),json_rpc_async("getCertificate",{alias:t},function(e){n.setAttribute("download","certificate.pem"),n.href="data:text/plain;charset=utf-8,"+e,n.click()}))}function createCert(){openModal({tempName:"create_cert",modalId:"createCertModal"},function(){$("#createCert").click(function(){addNewCert()})})}function addNewCert(){var t=retrieveFormData(document.getElementById("newCertForm"));t&&0!==Object.keys(t).length&&(t.V=parseInt(t.V),json_rpc_async("createCertificate",t,function(e){e&&(notify_about("success",PbxObject.frases.SAVED),fillCertTable([t.CN]),$("#createCertModal").modal("hide"))}))}function importCert(){openModal({tempName:"import_cert",modalId:"importCertModal",data:{certonly:0===PbxObject.options.mode}},function(){$("#importCert").click(function(){importNewCert()})})}function importNewCert(){var e=retrieveFormData(document.getElementById("importCertForm"));e&&0!==Object.keys(e).length&&json_rpc_async("setCertificate",e,function(e){"OK"===e&&(notify_about("success",PbxObject.frases.SAVED),$("#importCertModal").modal("hide"),clearTable(document.querySelector("#certificates tbody")),getCertificates())})}function showCert(t){json_rpc_async("getCertificate",{alias:t},function(e){openModal({tempName:"show_cert",modalId:"showCertModal",data:{name:t,certificate:e}})})}function removeCert(n){json_rpc_async("removeCertificate",{alias:n},function(e){notify_about("success",PbxObject.frases.SAVED);var t=document.querySelector('#certificates tbody tr[data-cert="'+n+'"]');t.parentNode.removeChild(t)})}function load_channel_records(){ChannelRecords(),show_content()}function ChannelRecords(){PbxObject.ChannelPlayer=PbxObject.ChannelPlayer||new ChannelPlayer({audio:document.getElementById("channel-audiorec")});var a=PbxObject.ChannelPlayer,t=document.getElementById("date-from"),n=document.getElementById("date-to"),o=document.getElementById("cpl-recs"),r=document.getElementById("cpl-events"),i=document.getElementById("cpl-download"),s=document.getElementById("online-events-cont"),c=document.getElementById("offline-events-cont"),l=document.getElementById("range-events"),d=document.getElementById("channel-events"),u=document.getElementById("online-events"),m=(document.getElementById("channel-state"),document.getElementById("cpl-time")),b=document.getElementById("cpl-duration"),p=document.getElementById("cpl-currentFile"),f=document.getElementById("cpl-currentTrack"),g=document.getElementById("cpl-play"),h=document.getElementById("cpl-seek"),e=document.getElementById("cpl-controls"),v=document.getElementById("cpl-submit-btn"),y=document.getElementById("events-view");function x(e){var t={oid:window.location.hash.substr(window.location.hash.indexOf("?")+1),begin:e.begin,end:e.end},n={};json_rpc_async("getChannelRecords",t,function(e){n.records=e,json_rpc_async("getChannelEvents",t,function(e){n.events=e,$(document).trigger("channelRecords:data",[n])})})}function E(e){json_rpc_async("getChannelState",{oid:window.location.hash.substr(window.location.hash.indexOf("?")+1),time:e},function(e){$(document).trigger("channelRecords:state",[e])})}function O(e,t){o.innerText=t.records.length,r.innerText=t.events.length,combined=function(e,o){var t=[],a=0;function n(e){var t=e.timecode+1e3*e.duration;e.events=[];for(var n=a;n<o.length;n++){if(!(o[n].timecode<=t)){a=n;break}e.events.push(o[n])}return e}for(var r=0;r<e.length;r++)t.push(n(e[r]));return t}(t.records,t.events),combined.length&&(clearTable(l),lastEvents=[],I(t.events,l),function(e){a.playlist=e,a.duration=(e[e.length-1].timecode+1e3*e[e.length-1].duration-e[0].timecode)/1e3,a.init().playTrack()}(combined))}function j(e,t){-1===lastEvents.indexOf(t.channelEvent.timecode)&&(lastEvents.push(t.channelEvent.timecode),I([t.channelEvent],d),C(t.channelEvent))}function P(e,t){[].forEach.call(l.children,function(e){parseInt(e.getAttribute("data-event"),10)===t.channelEvent.timecode?e.classList.add("list-group-item-success"):e.classList.remove("list-group-item-success")})}function _(e,t){clearTable(d),clearTable(u),onlineElements={},lastEvents=[],I(t,d),t.forEach(C)}function I(e,t){var n=document.createDocumentFragment();e.forEach(function(e){n.insertBefore(function(e){var t=document.createElement("li");return icon=document.createElement("i"),user=document.createElement("span"),evt=document.createElement("span"),time=document.createElement("span"),t.className="list-group-item",t.setAttribute("data-event",e.timecode),icon.className="fa fa-fw fa-"+function(e){var t="";switch(e){case 25:t="rss";break;case 26:t="sign-out";break;case 27:t="microphone";break;case 28:t="microphone-slash";break;case 29:t="close";break;case 30:t="check"}return t}(e.event),user.innerText=e.user+" ",evt.innerText=PbxObject.frases.CHANNEL_EVENTS[e.event.toString()],time.innerText=moment(e.timecode).format("DD/MM/YY HH:mm:ss"),time.className="pull-right",t.appendChild(icon),t.appendChild(user),t.appendChild(evt),t.appendChild(time),t}(e),n.firstChild)}),t.insertBefore(n,t.firstChild)}function C(e){var t;onlineElements[e.user]||(t=function(e){var t=document.createElement("li");return user=document.createElement("span"),t.className="list-group-item",t.setAttribute("data-event",e.timecode),user.innerText=e.user+" ",t.appendChild(user),t}(e),u.appendChild(t),onlineElements[e.user]=t),t=$(onlineElements[e.user]),25===e.event?t.show():26===e.event?t.hide():27===e.event?(t.remove(),$(u).prepend(t),t.addClass("list-group-item-success")):28===e.event?t.removeClass("list-group-item-success"):29===e.event?t.addClass("list-group-item-danger"):30===e.event&&t.removeClass("list-group-item-danger")}function k(e,t){0!==t.trackIndex||a.audio.currentTime||E(Math.floor(t.track.timecode+t.currentTime)),p.innerText=t.track.file,f.innerText=t.trackIndex+1,g.innerHTML='<i class="fa fa-fw fa-pause"></i>'}function w(){g.innerHTML='<i class="fa fa-fw fa-play"></i>'}function B(e,t){E(Math.floor(t.track.timecode+(t.currentTime||0)))}function S(e){!function(e){var o=combined[0].timecode+1e3*e;combined.forEach(function(e,t,n){o>=e.timecode&&o<e.timecode+1e3*e.duration&&a.playTrack(t,(o-e.timecode)/1e3)})}((a.duration*((e.offsetX||e.layerX)/h.clientWidth)).toFixed(2))}function T(e,t){var n=t.playlist[t.playlist.length-1],o=n.timecode+1e3*n.duration;b.textContent=moment(o).format("DD/MM/YY HH:mm:ss")}function A(e,t){i.href=t.src,i.setAttribute("download",t.src)}function N(e){var t=e.target;"span"===t.nodeName&&(t=t.parentNode),function(o){combined.forEach(function(e,t,n){o>=e.timecode&&o<n[t+1].timecode&&a.playTrack(t,(o-e.timecode)/1e3)})}(t.getAttribute("data-event"))}function M(e){var t=(e||window.event).target;"I"===t.nodeName&&(t=t.parentNode),"cpl-play"===t.id&&a.play(),"cpl-stop"===t.id&&a.stop(),"cpl-prev"===t.id&&a.prev(),"cpl-next"===t.id&&a.next()}function L(e,t){var n=0===t.currentTime?0:Math.floor(100/t.duration*t.currentTime);h.value=n}function D(e,t){var n=t.track.timecode+1e3*a.audio.currentTime;!function(e,t){var n=Math.floor(t/1e3);e.forEach(function(e){n===Math.floor(e.timecode/1e3)&&$(document).trigger("channelRecords:event",[{channelEvent:e,timeSeconds:n}])})}(combined[t.trackIndex].events,n),m.textContent=moment(n).format("DD/MM/YY HH:mm:ss")}function R(e,t){a.playTrack(a.trackIndex+1)}function q(e,t){t.online?(c.classList.add("hidden"),s.classList.remove("hidden")):(c.classList.remove("hidden"),s.classList.add("hidden"))}combined=[],begin=moment().subtract(30,"minutes"),end=moment(),lastEvents=[],onlineElements={},$("#channel-player-cont").affix({offset:{top:200}}),rome(t,{initialValue:begin}),rome(n,{initialValue:end}),$(document).on("player:init",T),$(document).on("player:seeked",B),$(document).on("player:timeupdate",L),$(document).on("player:timeupdate",D),$(document).on("player:playing",k),$(document).on("player:pause",w),$(document).on("player:next",B),$(document).on("player:prev",B),$(document).on("player:ended",R),$(document).on("player:trackchange",A),$(document).on("channelRecords:data",O),$(document).on("channelRecords:event",j),$(document).on("channelRecords:event",P),$(document).on("channelRecords:state",_),$(document).on("channelRecords:viewchange",q),addEvent(e,"click",M),addEvent(h,"click",S),addEvent(v,"click",function(e){x({begin:moment(t.value).valueOf(),end:moment(n.value).valueOf()})}),addEvent(y,"change",function(e){$(document).trigger("channelRecords:viewchange",[{online:this.checked}])}),addEvent(l,"click",N),addEvent(d,"click",N),x({begin:begin.valueOf(),end:end.valueOf()})}function load_channel_statistics(){var e;e={frases:PbxObject.frases},ReactDOM.render(AnalyticsComponent(e),document.getElementById("el-loaded-content")),set_page()}function ChannelPlayer(e){"use strict";if(!e.audio)throw"audio is undefined";return this.audio=e.audio,this.path=window.location.protocol+"//"+window.location.host+"/records/"||e.path,this.playlist=e.playlist||[],this.trackIndex=0,this.initEvents()}function load_channels(e){for(var t,n=document.getElementById("channels").getElementsByTagName("tbody")[0],o=document.createDocumentFragment(),a=[],r=0;r<e.length;r++)"channel"===e[r].kind&&(t=createChannelRow(e[r]),o.appendChild(t),a.push(e[r]));n.appendChild(o),PbxObject.channels=a,add_search_handler(),show_content(),addEvent(n,"click",tableClickHandler)}function tableClickHandler(e){var t,n=(e=e||window.event).target;"BUTTON"!==n.nodeName&&(n=n.parentNode),-1!=(t=n.className).indexOf("showPartiesBtn")?showParties(n):-1!=t.indexOf("deleteObjBtn")&&delete_extension(e)}function createChannelRow(e){var t,n,o=document.createElement("tr"),a=getInfoFromState(e.state,e.group),r=a.rstatus,i=a.rclass;return t=o.insertCell(0),e.oid?((n=document.createElement("a")).href="#"+e.kind+"?"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,(t=o.insertCell(1)).setAttribute("data-cell","name"),t.textContent=e.name||"",(t=o.insertCell(2)).setAttribute("data-cell","status"),t.textContent=r||"",(t=o.insertCell(3)).setAttribute("data-cell","parties"),e.parties&&(t.textContent=e.parties.length||""),t=o.insertCell(4),button=createNewButton({type:"popover",classname:"btn btn-primary btn-sm showPartiesBtn",placement:"left",dataTrigger:"focus",content:'<i class="fa fa-user"></i>'}),t.appendChild(button),e.parties||(button.disabled="disabled"),(t=o.insertCell(5)).innerHTML='<a type="button" class="btn btn-primary btn-sm" href="#channel_records?'+e.oid+'"><i class="fa fa-history"></i></a>',t=o.insertCell(6),e.oid&&(button=createNewButton({title:PbxObject.frases.DELETE,classname:"btn btn-danger btn-sm deleteObjBtn",content:'<i class="fa fa-trash"></i>'}),t.appendChild(button)),o.id=e.oid,o.setAttribute("data-ext",e.ext),o.className=i,o}function showParties(e){var n,t,o=getClosest(e,"tr"),a=PbxObject.channels,r="";a.forEach(function(e){e.oid===o.id&&(t=e.parties)&&(n=t.length,t.sort(),t.forEach(function(e,t){r+=e,t!=n-1&&(r+=", ")}))}),e.setAttribute("data-content",r),$(e).popover("toggle")}function load_chatchannel(e){var t,n,o=e,a=null,r=(t=PbxObject.frases.CHAT_CHANNEL.DEFAULT_NAME+" ",t+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1);function i(e){o.name=e}function s(t){o.enabled=t,PbxObject.name&&setObjectState(PbxObject.oid,t,function(e){console.log("onStateChange: ",t,e)})}function c(){(n=document.getElementById("available-users-cont"))&&n.parentNode.removeChild(n),(n=document.createElement("div")).id="available-users-cont",document.body.appendChild(n),getExtensions(function(e){ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,onSubmit:l,availableList:e.filter(function(e){return"user"===e.kind}),excludeList:o.members,groupid:PbxObject.name?PbxObject.oid:null}),n)})}function l(e){o.members=o.members.concat(e),PbxObject.name?u(o,function(e){b(o)}):b(o),$("#available-users-modal").modal("hide")}function d(e){var t=e.oid;o.members=o.members.filter(function(e){return e.oid!==t}),PbxObject.name?u(o,function(e){b(o)}):b(o)}function u(e,t){PbxObject.name&&(a=set_object_success);var n=e.name||r;setObject({kind:PbxObject.kind,oid:e.oid,name:n,enabled:e.enabled,members:e.members.length?e.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(e){PbxObject.name=o.name=n,a&&a(),t&&t(e)})}function m(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function b(e){var t={frases:PbxObject.frases,params:e,onAddMembers:PbxObject.isUserAccount?checkPermissions("chatchannel",3)?c:null:c,setObject:PbxObject.isUserAccount?checkPermissions("chatchannel",3)?u:null:u,onNameChange:i,onStateChange:PbxObject.isUserAccount?checkPermissions("chatchannel",3)?s:null:s,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:PbxObject.isUserAccount?checkPermissions("chatchannel",3)?d:null:d};!e.name||PbxObject.isUserAccount&&!checkPermissions("chatchannel",15)||(t.removeObject=m),ReactDOM.render(ChatchannelComponent(t),document.getElementById("el-loaded-content"))}e.name||(e.enabled=!0),PbxObject.oid=e.oid,PbxObject.name=e.name,b(o),show_content(),set_page()}function load_chattrunk(e){var o=getQueryParams(),t=PbxObject.frases,a=PbxObject.profile,n=e.type||"Telephony",r=[{id:"Telephony",name:t.CHAT_TRUNK.DID.SERVICE_NAME,icon:"/badmin/images/channels/did.png",component:DidTrunkComponent},{id:"FacebookMessenger",name:t.CHAT_TRUNK.FACEBOOK.SERVICE_NAME,icon:"/badmin/images/channels/facebook.png",params:{appId:"1920629758202993",redirectUri:"https://main.ringotel.net/chatbot/FacebookMessenger"},component:FacebookTrunkComponent},{id:"Email",name:t.CHAT_TRUNK.EMAIL.SERVICE_NAME,icon:"/badmin/images/channels/email.png",providers:{gmail:{protocol:"imap",hostname:"imap.gmail.com",port:993,usessl:!0},outlook:{protocol:"imap",hostname:"imap-mail.outlook.com",port:993,usessl:!0},office365:{protocol:"imap",hostname:"outlook.office365.com",port:993,usessl:!0},icloud:{protocol:"imap",hostname:"imap.mail.me.com",port:993,usessl:!0},aol:{protocol:"imap",hostname:"imap.aol.com",port:993,usessl:!0},yahoo:{protocol:"imap",hostname:"imap.mail.yahoo.com",port:993,usessl:!0}},component:EmailTrunkComponent},{id:"Viber",name:"Viber",icon:"/badmin/images/channels/viber.ico",component:ViberTrunkComponent},{id:"Telegram",name:"Telegram",icon:"/badmin/images/channels/telegram.png",component:TelegramTrunkComponent},{id:"WebChat",name:t.CHAT_TRUNK.WEBCHAT.SERVICE_NAME,icon:"/badmin/images/channels/webchat.png",component:WebchatTrunkComponent},{id:"Webcall",name:t.CHAT_TRUNK.WEBCALL.SERVICE_NAME,icon:"/badmin/images/channels/webcall.png",component:WebcallTrunkComponent},{id:"WebAPI",name:t.CHAT_TRUNK.WEBAPI.SERVICE_NAME,iconClass:"fa fa-2x fa-code",component:WebApiComponent}],i=getQueryParams().access_token||getQueryParams(window.location.hash.substr(window.location.hash.indexOf("?"))).access_token||null,s=null;try{s=window.opener&&window.opener.onTokenReceived?window.opener.onTokenReceived:null}catch(e){s=null}if(s)return s(i);function c(e,n){PbxObject.name&&setObjectState(PbxObject.oid,e,function(e,t){n&&n(t,e)})}function l(n,e){show_loading_panel(),n.directref=!0,setObject(n,function(e,t){if(t)return notify_about("error",t.message);PbxObject.name?set_object_success():(PbxObject.name=n.name,n.oid&&function(e,t){json_rpc_async("getObject",{oid:e.oid},t)}(n,function(e){e.pageid&&p(e.type,e)})),p(n.type,n),remove_loading_panel()})}function d(e,t){var n=document.getElementById("modal-cont"),o={frases:PbxObject.frases,name:PbxObject.name,warning:"Telephony"===e?PbxObject.frases.CHAT_TRUNK.DID.DELETE_SIP_CHANNEL_MSG:PbxObject.frases.CHAT_TRUNK.DID.DELETE_OTHER_CHANNEL_MSG,onSubmit:t};n||((n=document.createElement("div")).id="modal-cont",document.body.appendChild(n)),ReactDOM.render(DeleteObjectModalComponent(o),n)}function u(n,o){var e={currency:n.currency,amount:n.chargeAmount,description:"Update balance"};PbxObject.PaymentsApi[a.billingMethod?"authenticate":"open"]({profile:a,payment:e},function(e,t){if(e)return notify_about("error",e.message);o(n)})}function m(n,e,o){if(e)return o(n);showModal("confirm_payment_modal",{frases:PbxObject.frases,payment:n},function(e,t){$(t).modal("toggle"),o(n)})}function b(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid,!0)}function p(e,t){var n={type:e,services:r,frases:PbxObject.frases,params:t,selected:o.channel,getObjects:getObjects,onStateChange:PbxObject.isUserAccount?checkPermissions("chattrunk",3)?c:null:c,setObject:PbxObject.isUserAccount?checkPermissions("chattrunk",3)?l:null:l,updateBalance:!PbxObject.isUserAccount&&u,confirmRemoveObject:d,removeObject:PbxObject.isUserAccount?checkPermissions("chattrunk",15)?b:null:b,confirmPayment:m};ReactDOM.render(ChatTrunkComponent(n),document.getElementById("el-loaded-content")),show_content()}i&&(r=r.map(function(e){return"FacebookMessenger"===e.id&&(e.params.userAccessToken=i),e})),PbxObject.oid=e.oid,PbxObject.name=e.name,e.sessiontimeout=e.sessiontimeout||604800,e.replytimeout=e.replytimeout||3600,set_page(),p(n,e)}function load_cli(e){PbxObject.oid=e.oid,PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})}));var o=e.bnumbertransforms;if(o.length)for(var a=0;a<o.length;a++)append_transform(null,"transforms1",o[a]);else append_transform(null,"transforms1");var r=e.numbers;if(r.length)for(a=0;a<r.length;a++)add_cli_row(r[a]);else add_cli_row();show_content(),set_page()}function set_cli(){var e,t=document.getElementById("objname").value;if(!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var n='"name":"'+t+'",';show_loading_panel(),e=PbxObject.name?set_object_success:(PbxObject.name=t,null),PbxObject.oid&&(n+='"oid":"'+PbxObject.oid+'",'),n+='"kind":"cligroup",',n+='"enabled":'+document.getElementById("enabled").checked+",",n+='"bnumbertransforms":[',n+=encode_transforms("transforms1"),n+="],",n+='"numbers":[';var o,a=document.getElementById("clinumbers").getElementsByTagName("tbody")[0];for(o=0;o<a.children.length;o++){var r=a.children[o],i="",s=r.getElementsByTagName("input")[0];s&&"number"==s.name&&(i+='"number":"'+s.value+'",');var c=r.getElementsByTagName("textarea")[0];c&&"description"==c.name&&(i+='"description":"'+c.value+'",'),""!=i&&(n+="{"+i+"},")}setObject(n+="]",e)}function add_cli_row(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,o,a,r=document.getElementById("clinumbers").getElementsByTagName("tbody")[0],i=r.rows.length,s=r.insertRow(i);n=s.insertCell(0),(o=document.createElement("div")).className="form-group",(a=document.createElement("input")).className="form-control",a.setAttribute("type","text"),a.setAttribute("name","number"),e&&e.number&&(a.value=e.number),o.appendChild(a),n.appendChild(o),n=s.insertCell(1),(o=document.createElement("div")).className="form-group",(a=document.createElement("textarea")).className="form-control y-resizable",a.setAttribute("rows","3"),a.setAttribute("name","description"),e&&e.description&&(a.value=e.description),o.appendChild(a),n.appendChild(o),n=s.insertCell(2),(o=document.createElement("div")).className="form-group",(a=document.createElement("a")).href="#",a.className="remove-clr",a.innerHTML='<i class="fa fa-close"></i>',addEvent(a,"click",remove_row),o.appendChild(a),n.appendChild(o)}function load_customers(e){var o=PbxObject.frases,a=[],t=PbxObject.options.services||[],n=[{id:"csv",name:".csv"}].concat(t.filter(function(e){return e.state})),r=document.getElementById("modal-cont");function i(){json_rpc_async("getCustomers",null,function(e,t){m(a=sortByKey(e||[],"name")),show_content()})}function s(e){ReactDOM.render(DeleteObjectModalComponent({frases:o,warning:o.CUSTOMERS.ON_DELETE_WARNING,onSubmit:function(){!function(n){json_rpc_async("deleteCustomerData",{customerid:n},function(e,t){a=a.filter(function(e){return e.id!==n}),notify_about("success",o.CUSTOMERS.ON_DELETED_MSG),m(a)})}(e)}}),r)}function c(e,n){json_rpc_async("getCustomerConsent",{customerid:e},function(e,t){if(t)return notify_about("error",t);n(e)})}function l(e){ReactDOM.render(CustomerInfoModalComponent({frases:o,params:e,onDelete:PbxObject.isUserAccount?checkPermissions("customers",15)?s:null:s,getPrivacyPrefs:c}),r)}function d(o){show_loading_panel(),json_rpc_async(o.service_id?"importContacts":"importCustomers",o,function(e,t){if(t&&t.message){var n=JSON.parse(t.message);401===n.error.code?function(t,r){showModal("ldap_auth",{service_id:t.service_id},function(e,n){var o=n.querySelector('button[data-type="submit"]'),a=o.innerHTML;(o=$(o)).prop("disabled",!0),o.html('<i class="fa fa-fw fa-spinner fa-spin"></i>'),function(e,n,o){var t={url:n};e&&(t.method="POST",t.data="username="+e.username+"&password="+e.password);$.ajax(t).then(function(e){if(e){if(e.result.location)return window.sessionStorage.setItem("serviceParams",JSON.stringify(serviceParams)),window.location=e.result.location;o(e.result)}else o()},function(e){var t=null;e.responseJSON.error&&e.responseJSON.error.message&&(t=JSON.parse(e.responseJSON.error.message).error),t&&t.redirection?(window.sessionStorage.setItem("serviceParams",JSON.stringify(serviceParams)),window.location=t.redirection):t&&401===t.code?o(t):(window.sessionStorage.setItem("serviceParams",JSON.stringify(serviceParams)),window.location=loc.origin+n)})}(e,t.path,function(e,t){o.prop("disabled",!1),o.html(a),$(n).modal("hide"),r(null,t)})})}({service_id:o.service_id,path:"/services/"+o.service_id+"/Contacts"},function(e,t){if(!e)return d(o);notify_about("error",e.message)}):notify_about("error",n.error.message)}else showModal("import_result_modal",{contacts:e,contactsCount:e.length},function(e,t){return $(t).modal("hide"),i()})})}function u(e){var t,n=document.getElementById("modal-cont");n&&n.parentNode.removeChild(n),(n=document.createElement("div")).id="modal-cont",document.body.appendChild(n),t={frases:PbxObject.frases,selectedService:e,onSubmit:d},ReactDOM.render(ImportDataModalComponent(t),n)}function m(e){var t={frases:PbxObject.frases,params:e,import:PbxObject.isUserAccount?checkPermissions("customers",7)?u:null:u,importServices:n,openCustomerInfo:l};ReactDOM.render(CustomersComponent(t),document.getElementById("el-loaded-content"))}r||((r=document.createElement("div")).id="modal-cont",document.body.appendChild(r)),set_page(),close_options(),i()}function load_dashboard(){var e,t={frases:PbxObject.frases,options:PbxObject.options,profile:PbxObject.profile,fetchData:function(e,t,n){json_rpc_async(e,t,n)},fetchSubscription:function(e){BillingApi.getSubscription(e)},fetchCallingCredits:function(e){BillingApi.getCredits(e)}};e=t,ReactDOM.render(DashboardComponent(e),document.getElementById("el-loaded-content")),show_content(),set_page()}function load_developer(){var e;e={frases:PbxObject.frases,params:PbxObject.options},ReactDOM.render(DeveloperComponent(e),document.getElementById("el-loaded-content")),show_content()}function EventEmitter(){var o={},a=o.hasOwnProperty;return{on:function(e,t){a.call(o,e)||(o[e]=[]);var n=o[e].push(t)-1;return{off:function(){delete o[e][n]}}},emit:function(e,t){a.call(o,e)&&o[e].forEach(function(e){e(void 0!==t?t:{})})}}}function load_extensions(e){var t,n,o=filterObject(e,["user","phone"]);t=o,n={frases:PbxObject.frases,data:t,getExtension:getExtension,deleteExtension:PbxObject.isUserAccount?checkPermissions("users",15)?deleteExtension:null:deleteExtension},ReactDOM.render(ExtensionsComponent(n),document.getElementById("el-loaded-content")),set_page(),show_content()}function getExtensions(t,n){json_rpc_async("getExtensions",null,function(e){"function"!=typeof t?n(filterObject(e,t)):t(e)})}function updateExtensionRow(e,t){var n=document.getElementById(t.oid),o=getInfoFromState(t.state,t.group);if(n){n.cells;var a,r=o.rstatus;o.rclass;t.name&&(a=n.querySelector('[data-cell="name"]'))&&(a.innerHTML=t.name),t.hasOwnProperty("group")&&(a=n.querySelector('[data-cell="group"]'))&&(a.innerHTML=t.group),t.hasOwnProperty("reg")&&(a=n.querySelector('[data-cell="reg"]'))&&(a.innerHTML=t.reg),(a=n.querySelector('[data-cell="status"]'))&&(a.innerHTML='<span class="label label-'+o.className+'">'+r+"</span>")}updateObjects(PbxObject.extensions,t,"ext")}function getExtension(e){show_loading_panel();var t={},n=[{name:"statistics",grant:0},{name:"records",grant:0},{name:"customers",grant:0},{name:"users",grant:0},{name:"equipment",grant:0},{name:"channels",grant:0}],o=document.getElementById("modal-cont");o&&o.parentNode.removeChild(o),(o=document.createElement("div")).id="modal-cont",document.body.appendChild(o),getObject(e,function(e){show_content(),(t=extend(t,e)).permissions=PbxObject.isUserAccount?null:function(e){return e&&e.length?e.filter(function(e){return e.name.match("^(statistics|records|customers|users|equipment|channels)$")}):n}(e.permissions),ReactDOM.render(ExtensionModalComponent({frases:PbxObject.frases,params:t,onSubmit:PbxObject.isUserAccount?checkPermissions("users",3)?setExtension:null:setExtension,generatePassword:generatePassword,convertBytes:convertBytes,getObjects:getObjects}),o)})}function setExtension(e,n){show_loading_panel();var t=e.params.permissions;t&&(e.params.permissions=t.reduce(function(e,t){return e=e.concat([t]),"users"===t.name?e=e.concat([{name:"user",grant:t.grant}]):"equipment"===t.name?e=e.concat([{name:"unit",grant:t.grant},{name:"phone",grant:t.grant}]):"channels"===t.name&&(e=e.concat([{name:"chattrunk",grant:t.grant},{name:"chatchannel",grant:t.grant},{name:"hunting",grant:t.grant},{name:"icd",grant:t.grant}])),e},[])),setObject(e.params,function(e,t){t||(set_object_success(),n&&n())}),e.file&&uploadFile(e.file,"/$AVATAR$?userid="+e.params.userid)}function get_extension(e){"click"==(e=e||window.event).type&&e.preventDefault();var t=getClosest(e.target,"tr").id;t&&getExtension(t)}function load_extension(t){PbxObject.extOid=t.oid,PbxObject.userid=t.userid,PbxObject.vars=PbxObject.vars||{},PbxObject.vars.infoShown=!1;var e,n=document,o=document.getElementById("ext-cont"),a=t.groupid,r="user"==t.kind?"users":"unit";"users"==r&&(t.isUser=!0,t.storelimit=t.storelimit?convertBytes(t.storelimit,"Byte","GB").toFixed(2):0,t.storesize=t.storesize?convertBytes(t.storesize,"Byte","GB").toFixed(2):0,t.storefree=(t.storelimit-t.storesize).toFixed(2)),1!==getInstanceMode()&&(t.domain=window.location.hostname),e=Mustache.render(PbxObject.templates.extension,{data:t,frases:PbxObject.frases}),o||((o=document.createElement("div")).id="ext-cont",$("#pagecontainer").prepend(o)),$(o).html(e);var i=document.querySelector(".user-connected-services"),s=document.getElementById("ext-storelimit-cont"),c=document.querySelector("#el-extension .user-state-ind"),l=document.getElementById("user-avatar"),d="/$AVATAR$?userid="+t.userid;if(l.onerror=function(){this.src="images/avatar.png"},l.src=d,c.classList.add(getInfoFromState(t.state).rclass),"users"!=r){var u=document.querySelector("#el-extension .user-storage-usage");u&&u.classList.add("hidden"),s&&s.classList.add("hidden")}else{var m=document.getElementById("pin-cont");m&&m.classList.add("hidden"),s.style.display="block"}switch_presentation(r,document.getElementById("ext-features")),"users"==r?fill_group_choice(r,a):document.getElementById("extgroup-cont").classList.add("hidden");var b=n.getElementById("ext-fwdnreg"),p=n.getElementById("ext-fwdnregnumber");b.checked=t.features.fwdnreg,p.value=t.features.fwdnregnumber;var f=document.getElementById("ext-tabs");t.features&&(null==t.features.fwdall&&(f.querySelector('li a[href="#ext-forwarding"]').parentNode.className="hidden"),null==t.features.recording&&n.getElementById("ext-recording").setAttribute("disabled",""),null==t.features.callwaiting&&n.getElementById("ext-callwaiting").setAttribute("disabled",""),null==t.features.pickupdeny&&n.getElementById("ext-pickupdeny").setAttribute("disabled",""),null==t.features.monitordeny&&n.getElementById("ext-monitordeny").setAttribute("disabled",""),null==t.features.busyoverdeny&&n.getElementById("ext-busyoverdeny").setAttribute("disabled",""),null==t.features.voicemail&&n.getElementById("ext-voicemail").setAttribute("disabled",""),null==t.features.lock&&n.getElementById("ext-plock").setAttribute("disabled","")),n.getElementById("el-set-extension").onclick=function(){set_extension(r)},n.getElementById("showUserInfo").onclick=function(e){e&&e.preventDefault(),getUserInfo(t.userid)},t.services&&t.services.forEach(function(e){i.insertAdjacentHTML("beforeend",'<img src="/badmin/images/services/'+e+'.png" alt="'+e+'" title="'+PbxObject.frases.CONNECTED_TO+" "+e+'" />')}),show_content(),$('#el-extension [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),$('#el-extension [data-toggle="tooltip"]').tooltip(),$("#el-extension").modal(),$("#el-extension").on("hidden.bs.modal",function(e){$('#el-extension [data-toggle="popover"]').popover("destroy"),PbxObject.vars.infoShown=!1})}function set_extension(e){var t=document,n='"oid":"'+PbxObject.extOid+'",',o=t.getElementById("extgroup"),a=t.getElementById("extlogin").textContent,r=t.getElementById("extpassword").value,i=t.getElementById("extstorelimit");if(o.options.length)var s=o.options[o.selectedIndex].value;n+=s?'"groupid":"'+s+'",':'"groupid":"'+PbxObject.oid+'",',n+='"name":"'+t.getElementById("extname").value+'",',a&&(n+='"login":"'+a+'",'),r&&(n+='"password":"'+r+'",'),t.getElementById("extpin").value&&(n+='"pin":'+t.getElementById("extpin").value+","),i&&0<=(i=convertBytes(i.value,"GB","Byte").toFixed())&&(n+='"storelimit":'+i+","),n+='"features":{',null!=t.getElementById("ext-fwdall")&&(n+='"fwdall":'+t.getElementById("ext-fwdall").checked+",",n+='"fwdallnumber":"'+t.getElementById("ext-fwdallnumber").value+'",'),null!=t.getElementById("ext-fwdnregnumber")&&(n+='"fwdnreg":'+t.getElementById("ext-fwdnreg").checked+",",n+='"fwdnregnumber":"'+t.getElementById("ext-fwdnregnumber").value+'",'),null!=t.getElementById("ext-fwdbusynumber")&&(n+='"fwdbusy":'+t.getElementById("ext-fwdbusy").checked+",",n+='"fwdbusynumber":"'+t.getElementById("ext-fwdbusynumber").value+'",'),null!=t.getElementById("ext-fwdnansnumber")&&(n+='"fwdnans":'+t.getElementById("ext-fwdnans").checked+",",n+='"fwdnansnumber":"'+t.getElementById("ext-fwdnansnumber").value+'",'),null!=t.getElementById("ext-fwdtimeout")&&t.getElementById("ext-fwdtimeout").value&&(n+='"fwdtimeout":'+t.getElementById("ext-fwdtimeout").value+","),0==t.getElementById("ext-plock").disabled&&(n+='"lock":'+t.getElementById("ext-plock").checked+","),0==t.getElementById("ext-recording").disabled&&(n+='"recording":'+t.getElementById("ext-recording").checked+","),0==t.getElementById("ext-callwaiting").disabled&&(n+='"callwaiting":'+t.getElementById("ext-callwaiting").checked+","),0==t.getElementById("ext-pickupdeny").disabled&&(n+='"pickupdeny":'+t.getElementById("ext-pickupdeny").checked+","),0==t.getElementById("ext-monitordeny").disabled&&(n+='"monitordeny":'+t.getElementById("ext-monitordeny").checked+","),0==t.getElementById("ext-busyoverdeny").disabled&&(n+='"busyoverdeny":'+t.getElementById("ext-busyoverdeny").checked+","),0==t.getElementById("ext-voicemail").disabled&&(n+='"voicemail":'+t.getElementById("ext-voicemail").checked+","),n+="}";var c=retrieveFormData(document.getElementById("userInfo"));c&&0!==Object.keys(c).length&&(c.userid=PbxObject.userid,json_rpc_async("setUserInfo",c,null)),setObject(n,function(){$("#el-extension").modal("hide")}),upload("upload-avatar","/$AVATAR$?userid="+PbxObject.userid)}function getUserInfo(e){if(!0!==PbxObject.vars.infoShown){var n,o,a=document.getElementById("showUserInfo"),r=a.innerHTML;a.innerHTML='<i class="fa fa-lg fa-spinner fa-spin"></i>',getPartial("userinfo",function(t){json_rpc_async("getUserInfo",{userid:e},function(e){PbxObject.vars.infoShown=!0,(o={data:e,frases:PbxObject.frases}).data.email=o.data.email||o.data.mail,n=Mustache.render(t,o),$("#userInfo").html(n),a.innerHTML=r,$("#userInfo").collapse("toggle")})})}else $("#userInfo").collapse("toggle")}function GetStarted(e){var t=[],n=(PbxObject.objects,document.getElementById("modals-cont"));function a(){var e=t.length<2?0:2;ReactDOM.render(GSModalComponent({frases:PbxObject.frases,initialStep:e,profile:PbxObject.profile,options:PbxObject.options,objects:PbxObject.objects,onClose:r,sendLinks:o}),n)}function o(e){}function r(e){PbxObject.tourStarted=!!e}n||((n=document.createElement("div")).id="gs-modal-cont",document.body.appendChild(n)),this.init=function(){getExtensions(function(e){t=e,appStorage.get("welcomed")||t.length&&!(t.length<2)||(a(),appStorage.set("welcomed",!0)),function(){var e=document.createElement("ul"),t=document.createElement("li"),n=document.querySelector("#pbxmenu"),o=document.querySelector("#pbxmenu .nav-list");e.className="nav-list",e.appendChild(t),n.insertBefore(e,o),ReactDOM.render(InitGSButtonComponent({frases:PbxObject.frases,onClick:a}),t)}()})}}function load_guide(){getObjects("chattrunk",function(t){getExtensions(function(e){ReactDOM.render(GuideComponent({frases:PbxObject.frases,options:PbxObject.options,profile:PbxObject.profile,extensions:e,channels:t}),document.getElementById("dcontainer"))})}),show_content()}function load_hunting(r){var e,t,i=r,s=null,c=(e=PbxObject.frases.HUNTING_GROUP.DEFAULT_NAME+" ",e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1);function n(e){i.name=e}function o(e){i.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(e){return!0})}function a(){(t=document.getElementById("available-users-cont"))&&t.parentNode.removeChild(t),(t=document.createElement("div")).id="available-users-cont",document.body.appendChild(t),ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,onSubmit:l,excludeList:i.members,groupid:PbxObject.name?PbxObject.oid:null}),t)}function l(e){i.members=i.members.concat(e),PbxObject.name?u(i,function(e){b(i)}):b(i),$("#available-users-modal").modal("hide")}function d(e){var t=e.oid;i.members=i.members.filter(function(e){return e.oid!==t}),PbxObject.name?u(i,function(e){b(i)}):b(i)}function u(n,o){PbxObject.name&&(s=set_object_success);var a=n.name||c;setObject({kind:PbxObject.kind,oid:n.oid,name:a,enabled:n.enabled,options:n.options,members:n.members.length?n.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(e){if(PbxObject.name=i.name=a,n.files&&n.files.length&&n.files.forEach(function(e){uploadFile(e)}),n.route&&n.route.ext){var t={number:n.route.ext,target:{oid:PbxObject.oid,name:PbxObject.name}};r.routes.length&&(t.oid=r.routes[0].id),setObjRoute(t)}s&&s(),o&&o(e)})}function m(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function b(e){var t={frases:PbxObject.frases,params:e,onAddMembers:PbxObject.isUserAccount?checkPermissions("hunting",3)?a:null:a,setObject:PbxObject.isUserAccount?checkPermissions("hunting",3)?u:null:u,onNameChange:n,onStateChange:PbxObject.isUserAccount?checkPermissions("hunting",3)?o:null:o,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:PbxObject.isUserAccount?checkPermissions("hunting",3)?d:null:d};!e.name||PbxObject.isUserAccount&&!checkPermissions("hunting",15)||(t.removeObject=m),ReactDOM.render(HuntingGroupComponent(t),document.getElementById("el-loaded-content"))}i.options.huntmode||(i.options.huntmode=1),PbxObject.oid=r.oid,PbxObject.name=r.name,b(i),show_content(),set_page()}function load_icd(e){var t,n,r=e,i=null,s=(t=PbxObject.frases.ICD_GROUP.DEFAULT_NAME+" ",t+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1);function o(e){r.name=e}function a(e){r.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(e){return!0})}function c(){(n=document.getElementById("available-users-cont"))&&n.parentNode.removeChild(n),(n=document.createElement("div")).id="available-users-cont",document.body.appendChild(n),ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,onSubmit:l,excludeList:r.members,groupid:PbxObject.name?PbxObject.oid:null}),n)}function l(e){r.members=r.members.concat(e),PbxObject.name?u(r,function(e){b(r)}):b(r),$("#available-users-modal").modal("hide")}function d(e){var t=e.oid;r.members=r.members.filter(function(e){return e.oid!==t}),PbxObject.name?u(r,function(e){b(r)}):b(r)}function u(n,o){PbxObject.name&&(i=set_object_success);var a=n.name||s;setObject({kind:PbxObject.kind,oid:n.oid,name:a,enabled:n.enabled,options:n.options,members:n.members.length?n.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(e,t){if(t)return notify_about("error",t.message);PbxObject.name=r.name=a,n.files&&n.files.length&&n.files.forEach(function(e){uploadFile(e)}),i&&i(),o&&o(e)})}function m(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function b(e){var t={frases:PbxObject.frases,params:e,onAddMembers:PbxObject.isUserAccount?checkPermissions("icd",3)?c:null:c,setObject:PbxObject.isUserAccount?checkPermissions("icd",3)?u:null:u,onNameChange:o,onStateChange:PbxObject.isUserAccount?checkPermissions("icd",3)?a:null:a,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:PbxObject.isUserAccount?checkPermissions("icd",3)?d:null:d};!e.name||PbxObject.isUserAccount&&!checkPermissions("icd",15)||(t.removeObject=m),ReactDOM.render(IcdGroupComponent(t),document.getElementById("el-loaded-content"))}PbxObject.oid=e.oid,PbxObject.name=e.name,b(r),show_content(),set_page()}function Ldap(a){a=a||{};var r=null,i=window.location,s={id:a.service_id,type:a.service_type};return{options:a,getUsers:c,getExternalUsers:l,setUsers:function(e,t){json_rpc_async("setDirectoryUsers",e,function(e){t&&t(e)})},setExternalUsers:function(e,n){json_rpc_async("setExternalUsers",e,function(e,t){if(t)return notify_about("error",t.message||PbxObject.frases.ERROR);n&&n(e)})},showUsers:u,auth:d,close:function(){$(r).modal("hide")}};function c(e,t){json_rpc_async("getDirectoryUsers",e,function(e){t&&t(e)})}function l(e,o){var n="",t={url:"/services/"+a.service_id+"/Users"};e&&(t.method="POST",t.data="username="+e.username+"&password="+e.password),$.ajax(t).then(function(e,t,n){return e&&"string"==typeof e&&isLoginPage(e)?logout():(window.sessionStorage.removeItem("serviceParams"),e.result.location?(window.sessionStorage.setItem("serviceParams",JSON.stringify(s)),window.location=e.result.location):void(o?o(e.result):u(e.result)))},function(e){var t=null;if(window.sessionStorage.removeItem("serviceParams"),e.responseJSON&&e.responseJSON.error&&e.responseJSON.error.message&&(t=JSON.parse(e.responseJSON.error.message).error),t&&t.redirection)n=t.redirection;else if(300<=e.statusCode()&&e.statusCode()<400)n=e.getResponseHeader("Location");else{if(t&&401===t.code)return a.external=!0,d();n=i.origin+"/services/"+a.service_id+"/Users"}n&&(window.location=n,window.sessionStorage.setItem("serviceParams",JSON.stringify(s)))})}function d(e){e?c(e,function(e){e&&u(e)}):showModal("ldap_auth",{service_id:a.service_id,domains:a.domains},t)}function t(e,t){var n=t.querySelector('button[data-type="submit"]'),o=n.innerHTML;r=t,(n=$(n)).prop("disabled",!0),n.html('<i class="fa fa-fw fa-spinner fa-spin"></i>'),a.auth=e,a.external?l(e,function(e){n.prop("disabled",!1),n.html(o),e&&($(t).modal("hide"),u(e))}):c(e,function(e){n.prop("disabled",!1),n.html(o),e&&($(t).modal("hide"),u(e))})}function u(e){var t=document.getElementById("modal-cont");t||((t=document.createElement("div")).id="modal-cont",document.body.appendChild(t)),ReactDOM.render(ImportUsersListModalComponent({frases:PbxObject.frases,service:s,externalUsers:e,available:a.available,members:a.members,onSubmit:n}),t)}function n(t){t.deAssociationList&&t.deAssociationList.length?Utils.each(t.deAssociationList,function(n,e){!function(e,n){json_rpc_async("deleteUserService",e,function(e,t){if(t)return notify_about("error",t.message);n()})}(e,function(e,t){n()})},function(e){if(e)return notify_about("error",e.message);a.onaddusers(t.selectedUsers)}):a.onaddusers(t.selectedUsers)}}function load_licenses(){var e=document.getElementById("el-loaded-content"),t=PbxObject.profile,a={},o=[],n=[],r={changePlan:m,updateLicenses:p,addCredits:f},i=document.getElementById("modal-cont");function s(){ReactDOM.render(LicensesComponent({options:PbxObject.options,profile:t,sub:a,dids:o,frases:PbxObject.frases,discounts:n,renewSub:c,editCard:l,onPlanSelect:m,updateLicenses:b,addCredits:f,extend:deepExtend,addCoupon:u,countSubAmount:h,currencyNameToSymbol:y,utils:{convertBytes:convertBytes,getProration:g}}),e)}function c(n){show_loading_panel();var o={subId:a._id};BillingApi.renewSubscription(o,function(e,t){if(show_content(),e||t.error){if("NO_PAYMENT_SOURCE"===e.name)return d(o,c);notify_about("error",e.message||t.error.message)}else n(e,t),set_object_success()})}function l(t){d(null,function(e){t(e)})}function d(n,o){var e=n&&n.payment?{currency:n.payment.currency,amount:n.payment.chargeAmount,description:"Update balance"}:null;PbxObject.PaymentsApi[t.billingMethod?"authenticate":"open"]({profile:t,payment:e},function(e,t){if(e)return notify_about("error",e.message);"string"==typeof o?r[o](n,!0):o(n,!0)})}function u(e){BillingApi.addCoupon({coupon:e},function(e,t){if(e)return notify_about("error",e.message);n.push(t),set_object_success(),s()})}function m(n,e){if(!e)return v("confirm_payment_modal",n,m);show_loading_panel(),BillingApi.changePlan({subId:a._id,planId:n.plan.planId},function(e,t){show_content(),e?"NO_PAYMENT_SOURCE"===e.name||"authentication_required"===e.name?d(n,"changePlan"):notify_about("error",e.message):(a=PbxObject.subscription=t.result,set_object_success(),s())})}function b(){ReactDOM.render(UpdateLicenseModalComponent({options:PbxObject.options,sub:a,discounts:n,frases:PbxObject.frases,onSubmit:p,countSubAmount:h,currencyNameToSymbol:y,utils:{convertBytes:convertBytes,getProration:g}}),i)}function p(n,e){if(!e)return v("confirm_payment_modal",n,p);show_loading_panel(),BillingApi.updateSubscription({subId:a._id,addOns:n.addOns,quantity:n.quantity},function(e,t){show_content(),e?"NO_PAYMENT_SOURCE"===e.name||"authentication_required"===e.name?d(n,"updateLicenses"):notify_about("error",e.message):(a=PbxObject.subscription=t.result,set_object_success(),s())})}function f(n,e){if(!e)return v("confirm_payment_modal",{payment:{chargeAmount:n.amount,currencySymbol:y(t.currency)}},f);show_loading_panel(),BillingApi.addCredits({amount:n.payment.chargeAmount},function(e,t){remove_loading_panel(),e?"NO_PAYMENT_SOURCE"===e.name||"authentication_required"===e.name?d({payment:n},"addCredits"):notify_about("error",e.message):(set_object_success(),s())})}function g(e,t){return BillingApi.getProration(e,t)}function h(e){var t=e.quantity*e.plan.price,n="years"===e.plan.billingPeriodUnit?"annualPrice":"monthlyPrice";return e.addOns&&e.addOns.length&&e.addOns.forEach(function(e){e.quantity&&(t+=e.price*e.quantity)}),e.hasDids&&o.forEach(function(e){t+=e.included?0:parseFloat(e[n])}),t.toFixed(2)}function v(e,n,o){showModal(e,extend({frases:PbxObject.frases},n),function(e,t){$(t).modal("toggle"),o(n,!0)})}function y(e){var t="";switch(e.toLowerCase()){case"eur":t="€";break;case"usd":t="$";break;default:t="€"}return t}i||((i=document.createElement("div")).id="modal-cont",document.body.appendChild(i)),BillingApi.getSubscription(function(e,t){if(e)return notify_about("error",e.message);a=PbxObject.subscription=t.result,BillingApi.getAssignedDids(function(e,t){if(e)return notify_about("error",e.message);o=t.result,function(n){BillingApi.getDiscounts(function(e,t){if(e)return n(e);n&&n(null,t.result||[])})}(function(e,t){if(e)return notify_about("error",e.message);n=t,s(),show_content()})})})}function load_location(e){var t,o=e,a=(t=PbxObject.frases.ICD_GROUP.DEFAULT_NAME+" ",t+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1);function n(e){o.name=e}function r(e,t){PbxObject.name&&set_object_success;var n=extend({},e);n.kind=PbxObject.kind,n.name=e.name||a,n.profile={anumbertransforms:e.profile.anumbertransforms||[],bnumbertransforms:e.profile.bnumbertransforms||[]},delete n.members,setObject(n,function(e,t){if(t)return notify_about("error",t.message);PbxObject.name=o.name=n.name,set_object_success(),s(n)})}function i(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function s(e){var t={frases:PbxObject.frases,params:e,setObject:r,onNameChange:n,getExtension:getExtension};e.name&&(t.removeObject=i),ReactDOM.render(LocationGroupComponent(t),document.getElementById("el-loaded-content"))}PbxObject.oid=e.oid,PbxObject.name=e.name,s(o),show_content(),set_page()}function initGlobals(e){e.PbxObject={options:{},optionsOpened:!1,systime:"",initInterval:{},websocket:{},websocketTry:0,currentObj:{},protocolOpts:{},frases:{},smallScreen:!1,Dashboard:{},channels:[],members:[],available:[],extensions:[],objects:void 0,groups:{},templates:{},partials:{},name:"",language:"",query:"",kind:"",oid:""}}function init(){var e=setupPage;initGlobals(window),window.clearInterval(PbxObject.initInterval),"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener?document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,!1),e()},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),e())})}function logout(){var e=new XMLHttpRequest;e.open("GET","/logout",!0),e.onload=function(e){window.location="/"},e.send(),window.localStorage.removeItem("ringo_tid"),setLastQuery("")}function createWebsocket(){var e="https:"===location.protocol?"wss:":"ws:",t=new WebSocket(e+"//"+window.location.host+"/","json.api.smile-soft.com");t.onopen=function(e){PbxObject.websocketTry=1},t.onmessage=function(e){handleMessage(e.data)},t.onclose=onWebsocketClose,window.onbeforeunload=function(){t.onclose=function(){},t.close()},PbxObject.websocket=t}function onWebsocketClose(e){var t=generateInterval(PbxObject.websocketTry);setTimeout(function(){PbxObject.websocketTry++,createWebsocket()},t)}function generateInterval(e){var t=1e3*(Math.pow(2,e)-1);return 3e4<t&&(t=3e4),Math.random()*t}function loadStripeJs(){if(window.Stripe)return configureStripe();$.ajaxSetup({cache:!0}),$.getScript("https://js.stripe.com/v3/",configureStripe)}function configureStripe(){PbxObject.PaymentsApi=PaymentsApi("pk_live_6EK33o0HpjJ1JuLUWVWgH1vT",PbxObject.frases,BillingApi)}function json_rpc(e,t){var n;n=null==t?'{"method":"'+e+'", "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}';var o=new XMLHttpRequest;if(o.open("POST","/",!1),o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),o.send(n),403===o.status)return window.location="/";var a=JSON.parse(o.responseText);if(null==a.error)return a.result;notify_about("error",a.error.message)}function json_rpc_async(e,t,n,o){var a,r={},i={},s={};Utils.debug("json_rpc_async: ",e,t),i=null!==t?"string"==typeof t?'{"method":"'+e+'", "params":{'+t+'}, "id":1}':(i={method:e,params:t,id:1},t.file?toFormData(i):JSON.stringify(i)):(i={method:e,id:1},JSON.stringify(i)),(r=new XMLHttpRequest).open("POST","/",!0),a=setTimeout(function(){r.abort(),notify_about("info",PbxObject.frases.TIMEOUT),show_content()},3e5),r.onreadystatechange=function(){if(4==r.readyState)if(clearTimeout(a),200!=r.status){if(console.error(e,r.responseText),302===r.status)return window.location=r.getResponseHeader("Location");if(403===r.status)return logout();r.responseText&&(s=JSON.parse(r.responseText)),n?n(null,s.error):notify_about("error",s.error?s.error.message:PbxObject.frases.ERROR),show_content()}else if(null!=r.responseText){if(!r.responseText)return n();try{s=JSON.parse(r.responseText)}catch(e){if(isLoginPage(r.responseText))return logout()}s.error?(n&&n(null,s.error),notify_about("error",s.error?s.error.message:PbxObject.frases.ERROR),show_content()):s.result&&null!==n&&n(s.result)}},i instanceof FormData||r.setRequestHeader("Content-Type","application/json; charset=UTF-8"),r.send(i)}function request(e,t,n,o,a){var r,i,s,c,l=a;"function"==typeof o&&(l=o),(r=new XMLHttpRequest).open(e,t,!0),o&&"function"!=typeof o&&o.headers&&o.headers.forEach(function(e){r.setRequestHeader(e.name,e.value)}),s=setTimeout(function(){r.abort()},6e4),r.onreadystatechange=function(){if(4==r.readyState){if(clearTimeout(s),i=r.response)try{i=JSON.parse(i)}catch(e){if(isLoginPage(i))return logout()}if(200===r.status)l&&l(null,i);else{if(300<=r.status&&r.status<400)return window.location=r.getResponseHeader("Location");if(403===r.status)return logout();if(500<=r.status){if(l)return l("The service is under maintenance. Please, try again later.")}else l&&l(i?i.error:null)}}},n?(c=n.file?toFormData(n):(r.setRequestHeader("Content-Type","application/json"),JSON.stringify(n)),r.send(c)):r.send()}function isLoginPage(e){return-1!==e.indexOf("auth-form")}function getTranslations(e,n){var o=new XMLHttpRequest,t="translations_"+e+".json";o.open("GET","/badmin/translations/"+t,!0),o.onload=function(e){if(403===e.target.status)logout();else if(200===e.target.status){var t=JSON.parse(o.responseText);PbxObject.frases=t,n(null,t)}else n("ERROR_OCCURED")},o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),o.send()}function sendData(e,t,n){var o={};o.method=e,t&&(o.params=t),n&&(o.id=n),o=JSON.stringify(o),PbxObject.websocket.send(o)}function setPageHeight(){$("#pagecontent").css("min-height",function(){return $(window).height()})}function changeOnResize(e){PbxObject.smallScreen!==e&&(e?($("#pagecontent").hasClass("squeezed-right")&&$("#pagecontent").removeClass("squeezed-right"),$("#pbxmenu").hasClass("squeezed-menu")&&$("#pbxmenu").removeClass("squeezed-menu")):$("#pagecontent").hasClass("squeezed-right")||$("#pagecontent").addClass("squeezed-right"),PbxObject.smallScreen=e)}function handleMessage(e){var t=(e=JSON.parse(e)).method;if(e.method){var n=e.params;"stateChanged"==t||"objectUpdated"==t?$(document).trigger("onmessage.object.update",n):"conferenceUpdate"==t?updateConference(e):"objectCreated"==t?$(document).trigger("onmessage.object.add",n):"objectDeleted"==t&&$(document).trigger("onmessage.object.delete",n)}else callbackOnId(e.id,e.result)}function callbackOnId(e,t){5==e?PbxObject.Dashboard.setCurrentCalls(t):6==e?PbxObject.Dashboard.setCurrentState(t):7==e&&setCallStatistics(t)}function subscribeToEvents(){$(document).on("onmessage.object.update",updateExtensionRow),$(document).on("onmessage.object.update",updateMenu),$(document).on("onmessage.object.update",function(e,t){PbxObject.oid===t.oid&&objectStateUpdated(t),updateObjectCache(t)}),$(document).on("onmessage.object.add",newObjectAdded)}function getPbxOptions(t){var e=window.sessionStorage.getItem("pbxOptions");e?t(JSON.parse(e)):json_rpc_async("getPbxOptions",null,function(e){PbxObject.options=e,t(e)})}function getInstanceMode(){return window.localStorage.getItem("ringo_tid")?PbxObject.options.mode:1}function checkPermissions(e,t){return PbxObject.permissionsObject[e]>=t}function setupPage(){window.sessionStorage.getItem("lastURL");var t,e=location.hash.substring(1),n=-1!==e.indexOf("?")?e.substring(e.indexOf("?")+1):null;createWebsocket(),getPbxOptions(function(e){t=e.lang||"en",moment.locale(t),e.profile&&(window.localStorage.removeItem("ringo_tid"),PbxObject.isUserAccount=!0,PbxObject.permissionsObject=e.permissions.reduce(function(e,t){return e[t.name]=t.grant,e},{})),getTranslations(t,function(e,t){if(e)return notify_about("error",e);Utils.debug("getInstanceMode",getInstanceMode()),1===getInstanceMode()||PbxObject.isUserAccount?init_page():(dataLayer&&dataLayer.push({event:"is_cloud_branch"}),BillingApi.getSubscription(function(e,t){e?console.error(e):(PbxObject.subscription=t.result,BillingApi.getProfile(function(e,t){e?console.error(e):(loadFSTracking(PbxObject.profile=t.result),loadStripeJs()),window.sessionStorage.query&&!window.opener&&(window.location.hash=window.sessionStorage.query+(n||"")),init_page()}))}))})})}function loadFSTracking(e){window.FS&&FS.identify(e._id,{displayName:e._id,reviewsWritten_int:14})}function init_page(){window.Events=EventEmitter();var e=$("#main-template").html(),t=Mustache.render(e,PbxObject.frases);$("#pagecontainer").html(t),PbxObject.options.config&&switchMode(PbxObject.options),document.getElementsByTagName("title")[0].innerHTML="Ringotel | "+PbxObject.frases.PBXADMIN,setPageHeight(),subscribeToEvents(),PbxObject.language=PbxObject.options.lang,PbxObject.smallScreen=isSmallScreen(),$(window).resize(function(){setPageHeight(),changeOnResize(isSmallScreen())}),isSmallScreen()||$("#pagecontent").addClass("squeezed-right"),location.hash.substring(1)||(location.hash=PbxObject.isUserAccount?"profile":"realtime"),get_object(),set_listeners(),$('[data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}}),renderHelpSidebar("#help-sidebar")}function renderHelpSidebar(e){ReactDOM.render(HelpSidebarComponent({frases:PbxObject.frases,options:PbxObject.options}),document.querySelector(e))}function initTour(e){var t=e.kind||"",n=e.tourOptions||{};n.frases=PbxObject.frases,PbxObject.tours[t]&&MyTour(t,PbxObject.tours[t](n)).start()}function set_listeners(){addEvent(window,"hashchange",get_object),$(".sidebar-toggle","#pagecontent").click(toggle_sidebar),$("#help-toggle").click(toggle_options),$("#logout-btn").click(logout)}function get_object(e){var t=!0;if(PbxObject.setupInProgress&&(t=confirm("You have unsaved changes. Do you want cancel them?")),!t)return e.preventDefault();var n=location.hash.substring(1),o=-1!==n.indexOf("?")?n.substring(n.indexOf("?")+1):null,a=-1!=n.indexOf("/")?n.substring(0,n.indexOf("/")):n.substring(0),r=-1!=n.indexOf("/")?n.substring(n.indexOf("/")+1,o?n.indexOf("?"):n.length):null;PbxObject.language;if(n!==PbxObject.query){if(n){PbxObject.query=n,PbxObject.search=o,PbxObject.kind=a,PbxObject.oid=r,$("#dcontainer").addClass("faded"),show_loading_panel(),setLastQuery(n);var i=document.getElementById("el-extension");i&&i.parentNode.removeChild(i);-1!=["equipment","unit","conference","channel","pickup"].indexOf(a)&&(a="bgroup"),PbxObject.templates[a]?load_template(PbxObject.templates[a],a):request("GET","/badmin/views/"+a+".html",null,null,function(e,t){load_template(PbxObject.templates[a]=t,a)}),renderSidebar({branchOptions:PbxObject.options,activeKind:PbxObject.kind,activeItem:PbxObject.oid}),window.ga&&(ga("set","page","/"+a),ga("send","pageview"))}isSmallScreen()&&$("#pagecontent").hasClass("squeezed-right")&&($("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),$("#pbxmenu").scrollTop(0))}}function load_template(e,t){var n=window["load_"+t],o=Mustache.render(e,PbxObject.frases);$("#dcontainer").html(o),"extensions"===t||"channels"===t?getExtensions(n):PbxObject.oid?json_rpc_async("getObject",{oid:PbxObject.oid},n):n(),$("#dcontainer").scrollTop(0),$(".squeezed-menu > ul").children("li.active").removeClass("active").children("ul:visible").slideUp("normal")}function getPartial(n,o){PbxObject.partials=PbxObject.partials||{};var e=PbxObject.partials[n];e?o(e):request("GET","/badmin/partials/"+n+".html",null,null,function(e,t){PbxObject.partials[n]=t,o(t)})}function getTemplate(n,o){PbxObject.templates=PbxObject.templates||{};var e=PbxObject.templates[n];e?o(e):request("GET","/badmin/views/"+n+".html",null,null,function(e,t){PbxObject.templates[n]=temp,o(temp)})}function getTempParams(){return PbxObject.currentObj}function updateTempParams(e){PbxObject.currentObj=extend(PbxObject.currentObj||{},e)}function setTempParams(e){PbxObject.currentObj=extend(PbxObject.currentObj,e)}function clearTempParams(){PbxObject.currentObj={}}function setLastQuery(e){window.sessionStorage.query=e}function setActiveMenuElement(e,t){var n=document.getElementById("pbxmenu"),o=n.querySelector('.nav-list li a[data-kind="'+e+'"]');t||hideGroups(),o&&(o.classList.contains("active")||n.classList.contains("squeezed-menu")||(showGroups(o,!0),setTimeout(function(){setActiveMenuItemElement(o,t)},500)),setActiveMenuItemElement(o,t))}function setActiveMenuItemElement(e,t){[].slice.call(e.parentNode.querySelectorAll("ul li")).map(function(e){return e.hasAttribute("data-oid")&&e.getAttribute("data-oid")===t?e.classList.add("active"):e.classList.remove("active"),e})}function set_page(){var e=PbxObject.kind;-1!=["equipment","unit","users","conference","selector","channel","pickup"].indexOf(e)&&(e="bgroup");var t=document.getElementById("dcontainer"),n=t.querySelectorAll(".transrow"),o=t.querySelectorAll(".clirow"),a=document.getElementById("add-route"),r=document.getElementById("el-set-object"),i=document.getElementById("el-delete-object"),s=window["set_"+e];if(n.length)for(d=0;d<n.length;d++)addEvent(n[d],"click",append_transform);if(o.length)for(d=0;d<o.length;d++)addEvent(o[d],"click",add_cli_row);if(a&&addEvent(a,"click",add_new_route),r){var c=PbxObject.name?PbxObject.frases.SAVE:PbxObject.frases.CREATE;r.innerHTML='<i class="fa fa-check"></i> '+c,r.onclick=function(){s()}}i&&(PbxObject.name?i.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}:i.setAttribute("disabled","disabled"));for(var l=document.getElementsByClassName("el-sortable"),d=0;d<l.length;d++)new Sortable(l[d]);add_search_handler(),$(".selectable-cont").click(function(e){var t=e.target;if(t.getAttribute("data-value"))move_list_item(e);else{var n,o,a=getClosest(t,".selectable-cont");if(t.classList.contains("assign-all"))n=a.querySelector(".members"),o=a.querySelector(".available");else{if(!t.classList.contains("unassign-all"))return;n=a.querySelector(".available"),o=a.querySelector(".members")}move_list(n,o)}}),$("#dcontainer div.panel-header:not(.panel-static)").click(toggle_panel),$('#dcontainer [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),$('#dcontainer [data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}})}function setBreadcrumbs(){for(var e=document.getElementById("main-breadcrumb");e.firstChild;)e.removeChild(e.firstChild);if(PbxObject.kind){var t,n,o=document.getElementById("objname"),a=document.createDocumentFragment();(t=document.createElement("li")).innerHTML='<a href="#'+PbxObject.kind+"/"+PbxObject.kind+'">'+PbxObject.frases.KINDS[PbxObject.kind]+"</a>",(n=document.createElement("li")).className="active",o&&(n.innerHTML=o.value,addEvent(o,"input",function(){n.innerHTML=o.value})),a.appendChild(t),a.appendChild(n),e.appendChild(a)}}function getAvailablePool(t){json_rpc_async("getObject",{oid:"user"},function(e){t(e.available.sort())})}function toggle_sidebar(e){e&&(e.preventDefault(),$(this).toggleClass("flipped")),$("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),isSmallScreen()?$(document.documentElement).toggleClass("noscroll"):toggle_menu()}function toggle_menu(){$("#pbxmenu").toggleClass("squeezed-menu")}function toggle_options(e){e&&e.preventDefault();var t=$("#pbxmenu");$("#pagecontent").toggleClass("pushed-left"),isSmallScreen()||(t.hasClass("squeezed-right")?t.removeClass("squeezed-right"):t.addClass("squeezed-right")),$(document.documentElement).toggleClass("noscroll"),$("#help-sidebar").toggleClass("squeezed")}function close_options(e){e&&e.preventDefault(),$("#pagecontent").removeClass("pushed-left"),$("#pbxoptions").removeClass("pushed-left"),$("#el-slidemenu").removeClass("hide-menu"),setTimeout(function(){$("#pbxoptions").removeClass("top-layer"),$("#el-options-content").remove()},500)}function showModal(t,n,o,a,r){var i=document.getElementById(t),s=document.getElementById("pagecontainer");i&&i.parentNode.removeChild(i),getPartial(t,function(e){n.frases=PbxObject.frases,i=Mustache.render(e,n),s.insertAdjacentHTML("afterbegin",i),$("#"+t).modal(),$("#"+t).on("shown.bs.modal",function(e){o&&setModal(this,o),a&&a(this)}),r&&$("#"+t).on("hide.bs.modal",function(e){r(this)})})}function setModal(t,n){var e=t.querySelector('[data-type="submit"]'),o=t.querySelector("form");e&&addEvent(e,"click",function(e){e.target.disabled=!0,n(o?retrieveFormData(o):null,t)})}function openModal(o,a){var r={},i=document.getElementById(o.modalId);getPartial(o.tempName,function(e){r.frases=PbxObject.frases,o.data&&(r.data=o.data);var t=Mustache.render(e,r),n=document.querySelector("#pagecontainer");i&&i.parentNode.removeChild(i),n.insertAdjacentHTML("afterbegin",t),$("#"+o.modalId).modal(),a&&a()})}function toggle_panel(e){e.preventDefault();var t=$(this).closest(".panel");t.children(".panel-body").slideToggle(),t.toggleClass("minimized")}function toggle_presentation(){$("#el-slidemenu").addClass("hide-menu"),$("#pagecontent").addClass("pushed-left"),$("#pbxoptions").addClass("pushed-left")}function show_loading_panel(e){if(!document.getElementById("el-loading")){"string"==typeof e&&(e=document.getElementById(e));var t=document.createElement("div");t.id="el-loading",t.className="el-loading-panel ";var n=document.createElement("div");n.className="loader",n.innerHTML='<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>',t.appendChild(n),(e||document.getElementById("pagecontainer")).appendChild(t)}}function remove_loading_panel(){var e=document.getElementById("el-loading");e&&e.parentNode.removeChild(e)}function show_content(e){remove_loading_panel(),$("#dcontainer").removeClass("faded")}function switchMode(e){var t=e.config,n=e.mode,o=[].slice.call(document.querySelectorAll(".branch-mode"));-1==t.indexOf("channels")&&o.forEach(function(e){-1!=e.className.indexOf("mode-channels")&&e.parentNode.removeChild(e)}),-1!==t.indexOf("no selectors")&&o.forEach(function(e){-1!=e.className.indexOf("mode-selector")&&e.parentNode.removeChild(e)}),-1!==t.indexOf("no users")&&o.forEach(function(e){-1!=e.className.indexOf("mode-users")&&e.parentNode.removeChild(e)}),-1!==t.indexOf("no trunks")&&o.forEach(function(e){-1!=e.className.indexOf("mode-trunks")&&e.parentNode.removeChild(e)}),-1!==t.indexOf("no groups")&&o.forEach(function(e){-1!=e.className.indexOf("mode-groups")&&e.parentNode.removeChild(e)}),1===n&&o.forEach(function(e){-1!=e.className.indexOf("mode-single")&&e.parentNode.removeChild(e)})}function switch_presentation(t,e,n){var o=e||document.getElementById("dcontainer");n=n?"."+n:".pl-kind";[].slice.call(o.querySelectorAll(n)).forEach(function(e){e.classList.contains("pl-"+t)||e.classList.contains("pl-all")?(e.style.display="",e.classList.contains("pl-no-"+t)&&(e.style.display="none")):e.style.display="none"})}function switch_tab(e){for(var t=document.getElementById(e).parentNode.parentNode.children,n=0;n<t.length;n++)t[n].children[0].id!=e?t[n].style.display="none":t[n].style.display=""}function switch_options_tab(e){for(var t=document.getElementById(e).parentNode.children,n=1;n<t.length;n++)t[n].id!=e?t[n].style.display="none":t[n].style.display=""}function add_search_handler(){var e=[].slice.call(document.querySelectorAll(".el-search"));e.length&&e.forEach(function(e){e.getAttribute("data-element")&&(e.oninput=function(e){filter_element(e)})})}function makeElement(e,t,n,o){var a=document.createDocumentFragment();e.forEach(function(e){a.appendChild(n(e))}),o&&clearTable(t),t.appendChild(a)}function filter_element(e){var t,n,o=(e=e||window.event).target||this,a=o.getAttribute("data-element"),r=document.getElementById(a);n=o.value.toLowerCase(),"TABLE"==r.nodeName?(defClass="table-row",r=r.querySelector("tbody")):defClass="block";for(var i=0;i<r.children.length;i++)child=r.children[i],t=child.textContent.toLowerCase(),child.style.display=-1===t.indexOf(n)?"none":defClass}function arrayToPattern(e,t){return e+"|"+t}function filterObject(e,t,n){var o=!1,a=t?Array.isArray(t)?t:[t]:[];return a.length?e.filter(function(e){return o=-1!==a.indexOf(e.kind),n?!o:o}):e}function setObject(e,n,t){var o="function"==typeof n?n:t,a=e.oid||PbxObject.oid,r=e.kind||PbxObject.kind;json_rpc_async("setObject",e,function(e,t){t?o?o(null,t):notify_about("error",t.message):(n&&(!1===n.changeUrl||"user"===r||"phone"===r)||(PbxObject.query=r+"/"+a,window.location.href="#"+PbxObject.query),o&&o(e))})}function getObject(t,e,n){if(!n&&Array.isArray(PbxObject.objects)){var o=PbxObject.objects.filter(function(e){return e.oid===t});return o.length?e(o[0]):json_rpc_async("getObject",{oid:t},e)}json_rpc_async("getObject",{oid:t},e)}function getObjects(t,n,o){Array.isArray(PbxObject.objects)?n(t?filterObject(PbxObject.objects,t,o):PbxObject.objects):json_rpc_async("getObjects",{kind:"all"},function(e){sortByKey(e,"name"),PbxObject.objects=filterTrunks(e),n(t?filterObject(PbxObject.objects,t,o):e)})}function filterTrunks(e){return e.filter(function(e){return"trunk"!==e.kind||"service"!==e.type})}function addObjects(e,t,n){return e.push(t),sortByKey(e,n)}function updateObjects(e,o,a){return e=e.map(function(e,t,n){return e[a]===o[a]?extend(n[t],o):e})}function deleteObjects(e,o,a){return e=e.filter(function(e,t,n){return e[a]!==o[a]})}function notify_about(e,t){var n,o,a,r=document.createElement("div"),i=document.createElement("i"),s=document.getElementsByTagName("body")[0];switch(e){case"success":o='<span class="fa fa-check"></span>',a="el-notifier-ok";break;case"error":o='<span class="fa fa-close"></span>',a="el-notifier-error";break;default:o='<span class="fa fa-warning"></span>',a="el-notifier-info"}i.className="fa fa-close el-close-notify",r.className="el-notifier "+a,r.innerHTML+=o+" "+t,r.appendChild(i),s.appendChild(r),n=setTimeout(function(){removeEvent(i,"click",function(){s.removeChild(r),clearTimeout(n)}),s.removeChild(r)},7e3),addEvent(i,"click",function(){s.removeChild(r),clearTimeout(n)})}function append_transforms(t,e){e.forEach(function(e){append_transform(null,t,e)})}function append_transform(e,t,n){var o,a,r,i,s,c;if(t)o=document.getElementById(t);else{if(!e||"click"!=e.type)return;var l=(e=e||window.event).target||e.srcElement;e.preventDefault(),o=getClosest(l,"table")}i=(a=o.querySelector("tbody")).rows.length,row=a.insertRow(i),r=row.insertCell(0),(s=document.createElement("div")).className="form-group",(c=document.createElement("input")).className="form-control",c.setAttribute("type","text"),c.setAttribute("name","number"),null!=n&&c.setAttribute("value",n.number),s.appendChild(c),r.appendChild(s),(r=row.insertCell(1)).setAttribute("align","center"),(s=document.createElement("div")).className="form-group",(c=document.createElement("input")).setAttribute("type","checkbox"),c.setAttribute("name","strip"),null!=n&&(c.checked=n.strip),s.appendChild(c),r.appendChild(s),r=row.insertCell(2),(s=document.createElement("div")).className="form-group",(c=document.createElement("input")).className="form-control",c.setAttribute("type","text"),c.setAttribute("name","prefix"),null!=n&&c.setAttribute("value",n.prefix),s.appendChild(c),r.appendChild(s),r=row.insertCell(3),(s=document.createElement("div")).className="form-group",(c=document.createElement("a")).href="#",c.className="remove-clr",c.innerHTML='<i class="fa fa-minus"></i>',addEvent(c,"click",remove_row),s.appendChild(c),r.appendChild(s)}function clear_transforms(e){var t,n,o;for(t=0;t<e.length;t++)for(n=(o=document.getElementById(e[t])).rows.length-1;1<n;n--)o.deleteRow(n)}function transformsToArray(e){var t,n=document.getElementById(e).getElementsByTagName("tbody")[0],o=[].slice.call(n.children);return o=o.map(function(e){return t={},[].slice.call(e.querySelectorAll("input[name]")).map(function(e){t[e.name]="checkbox"===e.type?e.checked:e.value}),t}).filter(function(e){return""!==e.number})}function encode_transforms(e){for(var t=document.getElementById(e).getElementsByTagName("tbody")[0],n="",o=t.children.length;o--;){var a=t.children[o],r=a.getElementsByTagName("input"),i=r.length;if(a.querySelector('input[name="number"]').value){for(n+="{";i--;)"number"==r[i].name?n+='"number":"'+r[i].value+'",':"strip"==r[i].name?n+='"strip":'+r[i].checked+",":"prefix"==r[i].name&&(n+='"prefix":"'+r[i].value+'",');n+="},"}}return n}function remove_row(e){e.preventDefault();for(var t,n=e.currentTarget.parentNode;"TBODY"!=n.nodeName;)"TR"==n.nodeName&&(t=n),n=n.parentNode;n.removeChild(t)}function updateObjectCache(t){var e=(PbxObject.objects||[]).filter(function(e){return e.oid===t.oid})[0];e&&(e.enabled=t.enabled,e.name=t.name)}function objectStateUpdated(e){var t=document.getElementById("enabled");t&&(t.checked=e.enabled),void 0!==e.up&&changeTrunkRegState(e.up)}function newObjectAdded(e,t){t.oid;var n=t.kind,o=t.name,a=(t.enabled,document.getElementById("objname")),r=document.getElementById("el-set-object"),i=document.getElementById("el-delete-object");remove_loading_panel(),notify_about("success",o+" "+PbxObject.frases.CREATED),t.ext&&addObjects(PbxObject.extensions,t,"ext"),"phone"!==n&&"user"!==n&&(a&&o&&(a.value=o),i&&i.hasAttribute("disabled")&&(i.removeAttribute("disabled"),i.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid,t.ext)}),r&&(r.innerHTML='<i class="fa fa-check fa-fw"></i> '+PbxObject.frases.SAVE),Array.isArray(PbxObject.objects)&&(PbxObject.objects.push(t),sortByKey(PbxObject.objects,"name")),renderSidebar({branchOptions:PbxObject.options,activeKind:PbxObject.kind,activeItem:PbxObject.oid}))}function updateMenu(e,t){getObjects(null,function(e){PbxObject.objects=e.map(function(e){return e.ext||e.oid!==t.oid||(e.name=t.name,e.enabled=t.enabled,void 0!==t.up&&(e.up=t.up)),e}),renderSidebar({branchOptions:PbxObject.options,activeKind:PbxObject.kind,activeItem:PbxObject.oid})})}function objectDeleted(t){var n,e=t.kind?document.getElementById("ul-"+t.kind):document.querySelector("#pbxmenu .nav-list");(e?[].slice.call(e.querySelectorAll("li ul li")):[]).forEach(function(e){(n=e.getAttribute("data-oid"))&&n===t.oid&&e.parentNode.removeChild(e)}),Array.isArray(PbxObject.objects)&&(PbxObject.objects=PbxObject.objects.filter(function(e){return e.oid!==t.oid}))}function set_object_success(e){remove_loading_panel(),notify_about("success",PbxObject.frases.SAVED)}function set_options_success_with_reload(){window.location.reload(!1)}function delete_object(e,t,n,o){if(!(!!o||confirm(PbxObject.frases.DODELETE+" "+e+"?")))return!1;json_rpc_async("deleteObject",{oid:n},function(){objectDeleted({name:e,kind:t,oid:n}),setupInProgress(!1),window.location.hash=t+"/"+t})}function deleteExtension(e){var o=e.oid,t=e.ext,n=e.group,a=PbxObject.frases.DODELETE+" "+e.name+" "+PbxObject.frases.FROM.toLowerCase()+" "+(n||"")+"?",r=confirm(a);PbxObject.members=PbxObject.members||[],PbxObject.available=PbxObject.available||[],r&&json_rpc_async("deleteObject",{oid:o},function(){PbxObject.members.forEach(function(e,t,n){e.oid===o&&n.splice(t,1)}),PbxObject.available.push(t),PbxObject.available.sort(),onObjectDelete(e)})}function delete_extension(e){var t=getClosest(e.target,"tr"),o=t.id,n=(t.parentNode,t.getAttribute("data-ext")),a=t.querySelector("a"),r="extensions"===PbxObject.kind?t.cells[2].textContent:PbxObject.name,i=PbxObject.frases.DODELETE+" "+n+" "+PbxObject.frases.FROM.toLowerCase()+" "+(r||"")+"?",s=confirm(i);if(PbxObject.members=PbxObject.members||[],PbxObject.available=PbxObject.available||[],!s)return!1;json_rpc_async("deleteObject",{oid:o},function(){a&&(a.removeAttribute("href"),removeEvent(a,"click",get_extension)),PbxObject.members.forEach(function(e,t,n){e.oid===o&&n.splice(t,1)}),PbxObject.available.push(n),PbxObject.available.sort(),onObjectDelete({kind:PbxObject.kind,ext:n,group:r,oid:o})})}function onObjectDelete(e){e.ext&&/extensions|equipment/.test(PbxObject.kind)?(delete_extension_row(e),PbxObject.extensions=deleteObjects(PbxObject.extensions,e,"ext")):objectDeleted(e)}function delete_extension_row(e){var t=document.getElementById("extensions")||document.getElementById("group-extensions");t=t.querySelector("tbody");var n=document.getElementById(e.oid);t.removeChild(n);var o=document.getElementById("available-users");o&&(o.innerHTML+='<option value="'+e.ext+'">'+e.ext+"</option>")}function validateInput(e){e=e||window.event;-1!==[46,9,8,27,13].indexOf(e.keyCode)||65==e.keyCode&&!0===e.ctrlKey||35<=e.keyCode&&e.keyCode<=40||188==e.keyCode&&!1===e.shiftKey||189==e.keyCode&&!1===e.shiftKey||(e.shiftKey||e.keyCode<48||57<e.keyCode)&&(e.keyCode<96||105<e.keyCode)&&e.preventDefault()}function escapeValue(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function getFileName(e){if(null===e)return"";var o="";return Array.isArray(e)?e.forEach(function(e,t,n){o+=" "+e,t!==n.length-1&&(o+=",")}):o=" "+e,o.trim()}function customize_upload(e,t){var n=document.getElementById(e);if(n){var o=n.parentNode,a=document.createElement("button"),r=document.createElement("span");o.className+=" nowrap";var i=getFileName(t);n.setAttribute("data-value",i),r.innerHTML=i,r.title=i,r.className="upload-filename",a.type="button",a.className="btn btn-default btn-sm needsclick",a.innerHTML=PbxObject.frases.UPLOAD,a.onclick=function(){n.click()},o.insertBefore(a,n),o.insertBefore(r,n),n.onchange=function(){this.files.length?(i=getFileName(this.files[0].name),r.innerHTML=i,r.title=i,n.setAttribute("data-value",i)):(r.innerHTML=" ",r.title="",n.removeAttribute("data-value"))}}}function parseAsCsv(e,t){var n=e.split(/\r\n|\n/),o=new Array(n.length),a=n[0].split(t),r=0;function i(e,t,n){for(var o=[],a=!1,r=0,i=0;i<e.length;i++)'"'===e[i]&&(a=!a),i!==e.length-1&&(e[i]!==t||a&&'"'!==e[i-1]&&'"'!==e[i+1])||(o.push(e.substring(r,i)),r=i+1);return o.length<n&&(o.length=n),o}for(;r<n.length;)o[r]=i(n[r],t,a),r++;return o}function readFile(e,t,n){var o="function"==typeof t?t:n,a=new FileReader;a.readAsText(e,t.encoding||"UTF-8"),a.onload=function(e){o(null,e.target.result)},a.onerror=function(e){o(e)}}function toFormData(t,e,n){var o=e||new FormData,a="";return Object.keys(t).map(function(e){if(t.hasOwnProperty(e))if(a=n?n+"["+e+"]":e,"file"===e)o.append(a,t[e],t.filename||"");else{if("filename"===e)return e;"object"==typeof t[e]?toFormData(t[e],o,a):o.append(a,t[e])}return e}),o}function upload(e,t){var n;if(isElement(e))n=e;else{if("string"!=typeof e)return!1;n=document.getElementById(e)}var o=n.files;if(0==o.length)return!1;var a=o[0],r=t||"/"+a.name,i=new XMLHttpRequest,s=setTimeout(function(){i.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);i.onreadystatechange=function(){4==i.readyState&&(clearTimeout(s),200!=i.status?notify_about("error",PbxObject.frases.ERROR):"uploadapp"==e&&notify_about("success",a.name+" "+PbxObject.frases.UPLOADED))},i.open("PUT",r,!0),i.send(a)}function uploadFile(e,t,n){var o="function"==typeof t?t:n;if(!e)return!1;var a=t&&"string"==typeof t?t:"/"+e.name,r=new XMLHttpRequest,i=setTimeout(function(){r.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);r.onreadystatechange=function(){4==r.readyState&&(clearTimeout(i),200!=r.status?notify_about("error",PbxObject.frases.ERROR):o&&o())},r.open("PUT",a,!0),r.send(e)}function deleteFile(e){if(e){var t=new XMLHttpRequest,n=setTimeout(function(){t.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);t.onreadystatechange=function(){4==t.readyState&&(clearTimeout(n),200!=t.status&&notify_about("error",PbxObject.frases.ERROR))},t.open("DELETE",e,!0),t.send()}}function b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function get_object_link(e){var t=json_rpc("getObject",'"oid":"'+e+'"');location.hash=t.kind+"/"+e}function setObjectState(e,t,n){e&&void 0!==t&&json_rpc_async("setObjectState",{oid:e,enabled:t},function(e,t){t&&notify_about("error",t.message),n&&n(e,t)})}function setFormData(e,t){for(var n,o,a=0;a<e.elements.length;a++)(n=e.elements[a]).hasAttribute("name")&&(o=n.name,t.forEach(function(e){e.hasOwnProperty("key")&&e.key===o&&"file"!==n.type&&("checkbox"===n.type?n.checked=e.value:n.value=e.value)}))}function retrieveFormData(e){for(var t,n,o,a,r={},i=0;i<e.elements.length;i++)t=(n=e.elements[i]).getAttribute("data-type")||n.type,n.hasAttribute("name")&&(o=n.name,null!=(a="number"===t?parseFloat(n.value):"checkbox"===t?n.checked:"file"===t&&n.files.length?n.files[0].name:"file"===t&&n.getAttribute("data-value")?n.getAttribute("data-value"):n.value)&&(r[o]=a));return r}function isSmallScreen(){return $(window).width()<768}function isTouchDevice(){var e=" -webkit- -moz- -o- -ms- ".split(" ");if("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)return!0;var t,n=["(",e.join("touch-enabled),("),"heartz",")"].join("");return t=n,window.matchMedia(t).matches}function convertBytes(e,t,n){var o={Byte:1,KB:1e3,MB:1e6,GB:1e9};return e*o[t]/o[n]}function debounce(o,a,r){var i;return function(){var e=this,t=arguments,n=r&&!i;clearTimeout(i),i=setTimeout(function(){i=null,r||o.apply(e,t)},a),n&&o.apply(e,t)}}function toTheTop(e){var t=$(document).scrollTop(),n=e?$("#"+e).offset().top:0;t<n||$("html body").animate({scrollTop:n},500)}function copyFromField(e,t){var n=getClosest(e,".input-group").querySelector("input"),o=document.getElementById(t);n.value=o.value}function revealPassword(e){var t=getClosest(e,".input-group").querySelector("input");"password"==t.type?(t.type="text",e.innerHTML='<i class="fa fa-eye-slash" data-toggle="tooltip" title="'+PbxObject.frases.HIDE_PWD+'"></i>'):(t.type="password",e.innerHTML='<i class="fa fa-eye" data-toggle="tooltip" title="'+PbxObject.frases.REVEAL_PWD+'"></i>')}function generatePassword(e,t){for(var n,o="",a=(t=t||14,0);a<t;a++)n=Math.floor(62*Math.random()),o+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*()-_=+".charAt(n);if(!e)return o;getClosest(e,".input-group").querySelector("input").value=o}function getClosest(e,t){for(var n=t.charAt(0);e&&e!==document;e=e.parentNode)if("."===n){if(e.classList.contains(t.substr(1)))return e}else if("#"===n){if(e.id===t.substr(1))return e}else if("["===n){if(e.hasAttribute(t.substr(1,t.length-2)))return e}else if(e.nodeName===t.toUpperCase())return e;return!1}function checkAll(e,t){[].forEach.call(document.querySelectorAll(e),function(e){e.checked=t})}function isVisible(e,t){var n=t?"remove":"add";document.getElementById(e).classList[n]("hidden")}function switchDisabledState(e){var t,n,o;t=isElement(e)?e:(e||window.event).target,n=t.checked,o=t.getAttribute("data-name"),[].slice.call(document.querySelectorAll('input[name="'+o+'"]')).forEach(function(e){e.disabled=!n})}function isElement(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}function isGroup(e){if(-1!=["equipment","unit","users","icd","hunting","cli","pickup"].indexOf(e))return!0}function isMaxNumber(e){return 2147483647===e}function sortSelectOptions(e){var t=e.querySelectorAll("options");t.sort(function(e,t){return e.text.toUpperCase()>t.text.toUpperCase()?1:e.text.toUpperCase()<t.text.toUpperCase()?-1:0}),$(e).empty().append(t)}function sortByKey(e,n){return e.sort(function(e,t){return e[n]<t[n]?-1:e[n]>t[n]?1:0}),e}function objFromString(e,t){return e[t]}function formatTimeString(e,t){var n,o,a,r=[];switch(e-=3600*(n=Math.floor(e/3600)),o=Math.floor(e/60),a=Math.floor(e-60*o),t){case"hh:mm":r=r.concat([n,o]);case"mm:ss":o=60*n+o,r=r.concat([o,a]);break;default:r=r.concat([n,o,a])}return r.map(function(e){return e<10&&(e="0"+e),e}).join(":")}function formatDateString(e){var t="NaN"!==parseInt(e)?parseInt(e):e,n=new Date(t),o=n.getDate()<10?"0"+n.getDate():n.getDate(),a=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,r=n.getHours()<10?"0"+n.getHours():n.getHours(),i=n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes();return o+"/"+a+"/"+n.getFullYear()+" "+r+":"+i}function fillTable(t,e,n,o){t&&e&&n&&("object"==typeof e?e.forEach(function(e){t.appendChild(n(e))}):t.appendChild(n(e)),o&&o())}function clearTable(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function clearColumns(e){for(var t=e.querySelector("thead"),n=e.rows;1<t.rows[0].cells.length;)for(var o=0;o<n.length;o++)1<n[o].cells.length&&n[o].deleteCell(-1)}function elPosition(e){return getViewportH()-getOffset(e).top-e.offsetHeight<=e.offsetHeight?"top":"bottom"}function getViewportH(){var e=document.documentElement.clientHeight,t=window.innerHeight;return e<t?t:e}function getOffset(e){return e.getBoundingClientRect()}function extend(e,t){if(arguments.length<=1)return e;var n,o,a;for(n=1;n<arguments.length;n++)for(a in o=arguments[n])o.hasOwnProperty(a)&&(e[a]=o[a]);return e}function deepExtend(e,t){for(var n in t)t[n]&&t[n].constructor&&t[n].constructor===Object?(e[n]=e[n]||{},arguments.callee(e[n],t[n])):e[n]=t[n];return e}function addEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)}function removeEvent(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}function createNewButton(e){var t=document.createElement("button");return"popover"!==e.type&&"tooltip"!==e.type||(t.setAttribute("data-toggle",e.type),void 0!==e.html&&t.setAttribute("data-html",e.html),e.placement&&t.setAttribute("data-placement",e.placement),e.dataContent&&t.setAttribute("data-content",e.dataContent),e.dataTrigger&&t.setAttribute("data-trigger",e.dataTrigger)),t.className=e.classname||"",t.innerHTML=e.content||"",e.title&&(t.title=e.title),e.handler&&addEvent(t,e.evtType||"click",e.handler),t}function setAccordion(e){var t=e||"";$(t+" .acc-cont > .acc-pane").slideToggle(),$(t+" .acc-cont > .acc-header").click(function(){$(this).next(".acc-pane").slideToggle(),$(this).toggleClass("current"),$(this).siblings(".acc-header").removeClass("current")})}function createCodecRow(e){var t,n;return(n=(t=document.createElement("tr")).insertCell(0)).className="draggable",n.innerHTML='<i class="fa fa-ellipsis-v"></i>',(n=t.insertCell(1)).className="codec-name",n.innerHTML=e.codec,(n=t.insertCell(2)).innerHTML='<input type="text" class="form-control codec-frames" value="'+(e.frame?e.frame:30)+'">',(n=t.insertCell(3)).innerHTML='<input type="checkbox" '+(e.enabled?"checked":"")+' class="codec-enabled">',t}function buildCodecsTable(e,t,n){var o=[],a=document.createDocumentFragment(),r=isElement(e)?e:document.getElementById(e);o=o.concat(n),t.forEach(function(e){e.enabled=!0,a.appendChild(createCodecRow(e)),-1!=o.indexOf(e.codec)&&o.splice(o.indexOf(e.codec),1)}),o.forEach(function(e){a.appendChild(createCodecRow({codec:e}))}),r.appendChild(a)}function getCodecsString(e){for(var t,n,o=[],a=isElement(e)?e:document.getElementById(e),r=0;n=a.rows[r];r++)n.getElementsByClassName("codec-enabled")[0].checked&&(t={codec:n.getElementsByClassName("codec-name")[0].textContent,frame:parseInt(n.getElementsByClassName("codec-frames")[0].value)},o.push(t));return o}function getFriendlyCodeName(e){return PbxObject.frases.CODES[e.toString()]||e}function fill_select_items(e,t){var n,o=document.getElementById(e);t.forEach(function(e){(n=document.createElement("option")).value=e.oid,n.textContent=e.name,o.appendChild(n)})}function fill_list_items(e,t,n){("available"==e||"hunting"!=PbxObject.kind&&"icd"!=PbxObject.kind&&"unit"!=PbxObject.kind)&&t.sort();for(var o=document.getElementById(e),a=document.createDocumentFragment(),r=0;r<t.length;r++){var i=n&&t[r][n]?t[r][n]:t[r],s=document.createElement("li");s.setAttribute("data-value",i),s.innerHTML=i,a.appendChild(s)}o.appendChild(a)}function move_list_item(e){var t=e.target,n=getClosest(t,".selectable-cont"),o=t.parentNode;o.classList.contains("available")?(o.removeChild(t),n.querySelector(".members").appendChild(t)):(o.removeChild(t),n.querySelector(".available").appendChild(t))}function move_list(t,e){t=isElement(t)?t:document.getElementById(t),e=isElement(e)?e:document.getElementById(e);[].slice.call(e.querySelectorAll("li")).forEach(function(e){t.appendChild(e)})}function changeGroupType(t){[].slice.call(document.querySelectorAll(".object-type")).forEach(function(e){e.classList.contains(t)?e.classList.remove("hidden"):e.classList.add("hidden")})}function newInput(e){var t=document.createElement("div");if(t.className="form-group",e.label){var n='<label for="'+e.id+'">'+e.label+"</label>";t.innerHTML+=n}var o='<input type="'+(e.type||"text")+'" class="form-control" id="'+(e.id||"")+'" value="'+(e.value||"")+'">';return t.innerHTML+=o,t}function switchVisibility(e,t){t?$(e).show():$(e).hide()}function get_protocol_opts(e,t,n){var o="h323"==e?"h323":"sip",a=t,r=0!==Object.keys(PbxObject.protocolOpts).length?PbxObject.protocolOpts:a,i=[{mode:"sip info",sel:"sip info"===r.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===r.dtmfmode},{mode:"inband",sel:"inband"===r.dtmfmode}],s=[{mode:"h245alpha",sel:"h245alpha"===r.dtmfmode},{mode:"h245signal",sel:"h245signal"===r.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===r.dtmfmode},{mode:"inband",sel:"inband"===r.dtmfmode}],c={opts:r,internal:"internal"===n,frases:PbxObject.frases};c.opts.dtmfmodes="h323"==o?s:i;var l=Mustache.render(PbxObject.templates.protocol,c),d=document.getElementById("proto-cont");d||((d=document.createElement("div")).id="proto-cont",$("#pagecontainer").prepend(d)),$(d).html(l);var u=document.getElementById("protocol-codecs").querySelector("tbody");buildCodecsTable(u,c.opts.codecs,["Opus","G.711 Alaw","G.711 Ulaw","G.729","G.723"]),new Sortable(u),switch_presentation(o,d),$("#el-protocol").modal(),$("#el-set-protocol").click(function(){save_proto_opts(o)})}function save_proto_opts(e){var t=PbxObject.protocolOpts,n=document.getElementById("protocol-codecs").querySelector("tbody");t.codecs=getCodecsString(n),document.getElementById("t1")&&(t.t1=parseInt(document.getElementById("t1").value)),document.getElementById("t2")&&(t.t2=parseInt(document.getElementById("t2").value)),document.getElementById("t3")&&(t.t3=parseInt(document.getElementById("t3").value)),document.getElementById("t38fax")&&(t.t38fax=document.getElementById("t38fax").checked),document.getElementById("pvideo")&&(t.video=document.getElementById("pvideo").checked),document.getElementById("earlymedia")&&(t.earlymedia=document.getElementById("earlymedia").checked),document.getElementById("dtmfrelay")&&(t.dtmfrelay=document.getElementById("dtmfrelay").checked),t.dtmfmode=document.getElementById("dtmfmode").value,"h323"==e?(t.faststart=document.getElementById("faststart").checked,t.h245tunneling=document.getElementById("h245tunneling").checked,t.playringback=document.getElementById("playringback").checked):(t.nosymnat=document.getElementById("nosymnat").checked,t.buffering=document.getElementById("buffering").checked,t.noprogress=document.getElementById("noprogress").checked,t.noredirectinfo=document.getElementById("noredirectinfo").checked,t.passanumber=document.getElementById("passanumber").checked,t.directrtp=!!document.getElementById("directrtp")&&document.getElementById("directrtp").checked),$("#el-protocol").modal("hide")}function updateConference(e){var n=e.params,t=document.getElementById(n.oid);if(t){var o=t.querySelector('[data-cell="parties"]');if(o){var a=t.querySelector(".showPartiesBtn");n.total?(o.textContent=n.total,a.removeAttribute("disabled")):(o.textContent="",a.setAttribute("disabled","disabled"))}}var r=PbxObject.channels;r&&r.forEach(function(e){if(e.oid===n.oid){var t=e.parties;1==n.state?(t||(e.parties=t=[]),-1==t.indexOf(n.number)&&t.push(n.number)):0==n.state&&t.splice(t.indexOf(n.number),1)}})}function getInfoFromState(e,t){var n;return n=1==e?"info":8==e?"danger":2==e||5==e?"warning":0==e||-1==e&&t?"default":3==e?"danger":6==e||7==e?"danger":"active",{rstatus:PbxObject.frases.STATES[e]||"",rclass:"bg-"+n,className:n}}function getQueryParams(e){return(e||document.location.search).replace(/(^\?)/,"").split("&").map(function(e){return this[(e=e.split("="))[0]]=e[1],this}.bind({}))[0]}function fill_group_choice(e,r,i){if(i=i||document.getElementById("extgroup")){for(;i.firstChild;)i.removeChild(i.firstChild);getObjects(e,function(e){var t,n,o,a;if(!e.length)return(o=document.createElement("option")).value="",o.innerHTML=r,o.disabled="disabled",void i.appendChild(o);for(a=0;a<e.length;a++)t=e[a].oid,n=e[a].name,(o=document.createElement("option")).setAttribute("value",t),t!=r&&n!=r||(o.selected="true"),o.innerHTML=e[a].name,i.appendChild(o)})}}function change_protocol(){"h323"==(this.value||document.getElementById("protocols").value)?(document.getElementById("sip").parentNode.style.display="none",document.getElementById("h323").parentNode.style.display=""):(document.getElementById("sip").parentNode.style.display="",document.getElementById("h323").parentNode.style.display="none")}function loadSupportWidget(e){return!0}function setupInProgress(e){return!1}function isBranchPackage(e){return 1!==getInstanceMode()&&PbxObject.subscription&&PbxObject.subscription.plan?!!PbxObject.subscription.plan.planId.match(e):!(!"enterprise".match(e)&&!"business".match(e))}function load_new_trunk(){var e,t=[{type:"sip",name:"SIP trunk",href:"#trunk/trunk",icon:"fa fa-fw fa-phone"},{type:"Messenger",name:"Messenger",href:"#chattrunk/chattrunk?type=Messenger",icon:"fa fa-fw fa-facebook"}];e={frases:PbxObject.frases,trunks:t},ReactDOM.render(NewTrunkComponent(e),document.getElementById("el-loaded-content")),show_content(),set_page()}function load_numbers(e){billingRequest("getDidCountries",null,function(e,t){if(e)return notify_about("error",e.message)})}function Pagination(e){this.options=e,this.createPagination=function(e,t){if(this.pagin&&clearTable(this.options.table),this.currentRange=[],!(this.options.pagnum<=1)){e=e||this.options.page,t=t||(this.options.pagnum>this.options.maxpagins?this.options.maxpagins:this.options.pagnum);var n,o=document.querySelector(".pagination-container"),a=document.createElement("ul"),r=document.createElement("p");a.className="pagination custom-pagination",(n=document.createElement("li")).innerHTML='<a href="#" class="first">&laquo;</a>',a.appendChild(n),(n=document.createElement("li")).innerHTML='<a href="#" class="prev">-</a>',a.appendChild(n);for(var i=e;i<=t;i++)(n=document.createElement("li")).innerHTML='<a href="#" data-page="'+i+'">'+i+"</a>",a.appendChild(n),i==t&&(this.lastPage=n),this.currentRange.push(i);for((n=document.createElement("li")).innerHTML='<a href="#" class="next">+</a>',a.appendChild(n),(n=document.createElement("li")).innerHTML='<a href="#" class="last">&raquo;</a>',a.appendChild(n),this.pagin=a,this.paginInfo=r;o.hasChildNodes();)o.removeChild(o.firstChild);o.appendChild(a),o.appendChild(r),a.onclick=this._getSelectedPage.bind(this)}},this._getSelectedPage=function(e){e.preventDefault();var t=e.target,n=this._isPagin(t);n||("next"==t.className?n=this.currentPage+1:"prev"==t.className?n=this.currentPage-1:"first"==t.className?(n=1,this.options.pagnum>=this.options.maxpagins&&this.createPagination(1,this.options.maxpagins)):"last"==t.className&&(n=this.options.pagnum)>=this.options.maxpagins&&this.createPagination(n-this.options.maxpagins+1,n)),n>this.options.pagnum||n<1||this.selectPage(n)},this.selectPage=function(e){e=parseInt(e);var t=parseInt(e)*parseInt(this.options.rows)-parseInt(this.options.rows),n=e*parseInt(this.options.rows);n=n<this.options.records.length?n:this.options.records.length,this.currentPage=e,clearTable(this.options.table);for(var o=t;o<n;o++)build_records_row(this.options.records[o],this.options.table);if(this.currentRange.length){this.currentRange.indexOf(e)==this.currentRange.length-1||this.currentRange.indexOf(e)==this.currentRange.length-2?this._appendPage():0!=this.currentRange.indexOf(e)&&1!=this.currentRange.indexOf(e)||this._prependPage();var a=this.pagin.querySelector("li.active");a&&a.classList.remove("active"),this.pagin.querySelector('a[data-page="'+e+'"]').parentNode.classList.add("active")}this.paginInfo&&(this.paginInfo.innerHTML=PbxObject.frases.FROM2.toLowerCase()+" "+t+" "+PbxObject.frases.TO.toLowerCase()+" "+n+" "+PbxObject.frases.RECORDS.REC.toLowerCase())},this._appendPage=function(){var e=this.currentRange[this.currentRange.length-1]+1;if(!(e>this.options.pagnum)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,o=document.createElement("li");o.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(o,t.nextSibling),this.pagin.removeChild(n),this.currentRange.push(e),this.currentRange.shift()}},this._prependPage=function(){var e=this.currentRange[0]-1;if(!(e<1)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,o=document.createElement("li");o.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(o,n),this.pagin.removeChild(t),this.currentRange.unshift(e),this.currentRange.pop()}},this._destroyPagination=function(){for(;this.pagin&&this.pagin.hasChildNodes();)this.pagin.removeChild(this.pagin.firstChild)},this._isPagin=function(e){return e.getAttribute("data-page")}}function PaymentsApi(e,n,a){var r=Stripe(e),t=r.elements(),i=null,s=null,o=[],c=document.getElementById("modal-cont");return c||((c=document.createElement("div")).id="modal-cont",document.body.appendChild(c)),{open:function(n,o){if(!n.profile)return o("profile param is undefined");n.payment?(n.payment,l({profile:n.profile,payment:n.payment},function(e,t){o(p(e),t)})):(show_loading_panel(),function(e){a.request("createSetupIntent",{returnUrl:window.location.href},e)}(function(e,t){if(e||t.error)return o(e||t.error);s=t.result,show_content(),l({profile:n.profile},function(e,t){o(p(e),t)})}))},authenticate:function(n,o){!function(e,t){a.request("createPaymentIntent",{payment:e.payment},t)}(n,function(e,t){if(e)return o(p(e));b(t.result,n.payment,function(e,t){o(p(e),t)})})}};function l(e,t){ReactDOM.render(NewPaymentComponent({profile:e.profile,payment:e.payment,frases:n,renderCardElement:d,onClose:u,onSubmit:m,onCallback:t,getCountries:f}),c)}function d(e){return(i=t.create("card",{style:{base:{fontSize:"14px",color:"#555",fontFamily:'"Trebuchet MS", Helvetica, sans-serif'}}})).mount(e),i}function u(){return i.destroy()}function m(e,t){var n={};e.details&&(n=e.details),e.address&&(n.address=e.address),e.payment?function(e,n,o){r.createPaymentMethod("card",i,{billing_details:e}).then(function(e){e.error?o(e.error):a.request("confirmPayment",{service:"stripe",payment:n,payment_method_id:e.paymentMethod.id,confirmation_method:"manual"},function(e,t){if(e)return o(e);b(t.result,n,o)})})}(n,e.payment,t):function(e,t){r.handleCardSetup(s.client_secret,i,{payment_method_data:{billing_details:e}}).then(function(e){e.error?t(e.error):function(e,n){a.request("addPaymentMethod",{service:"stripe",paymentMethod:e.payment_method},function(e,t){e||t.error?n(e||t.error):n(null,t.result)})}(e.setupIntent,t)}).catch(function(e){t(e)})}(n,t)}function b(e,n,o){e.requires_action?r.handleCardAction(e.payment_intent_client_secret).then(function(e){e.error?o(e.error):a.request("updateBalance",{token:e.paymentIntent.id,service:"stripe",payment:n},function(e,t){if(e)return o(e);b(t,n,o)})}):o()}function p(e){return e?{name:e.name||"generic_decline",message:e.name?PbxObject.frases.CHECKOUT.ERROR[e.name]:PbxObject.frases.CHECKOUT.ERROR.generic_decline}:null}function f(t){if(o.length)return o;$.ajax("https://restcountries.eu/rest/v2/all?fields=name;alpha2Code;").then(function(e){t(null,o=e)},function(e){t(e)})}}function Picker(t,e){var a,n,o,r,i="string"==typeof t?document.getElementById(t):t,s=PbxObject.frases,c=!1,l=this;this.defaults={defaultOption:"today",interval:!1,actionButton:!0,buttonSize:"sm",buttonColor:"default"},this.defaults=extend({},this.defaults),extend(this.defaults,e),this.date={},this.interval=this.defaults.interval?36e5:null,this.intervalString="hour",this.fields={},this._pickerHandler=function(e){var t,n,o=e.target;"LABEL"===o.nodeName?(t=o.children[0].getAttribute("data-range"))?(l._setCurrentRange(t),"custom"===t?(c=!0,a.classList.remove("ghosted")):(c=!1,a.classList.add("ghosted"))):(n=o.children[0].getAttribute("data-interval"))&&("hour"===n?this.interval=36e5:"1/2_hour"===n?this.interval=18e5:"1/4_hour"===n?this.interval=9e5:"day"===n&&(this.interval=864e5),this.intervalString=n):"BUTTON"===o.nodeName&&("submitButton"===o.name?(c&&l._rangeToString(),l.defaults.submitFunction&&l.defaults.submitFunction({date:this.date})):"selectButton"===o.name&&c&&l._rangeToString(),i.classList.toggle("open"))},this._init=function(){if(i){var e=this.template();i.innerHTML=e,dropdown=i.querySelector(".dropdown-menu"),[].slice.call(i.querySelectorAll('input[name="options"]')),n=i.querySelector(".dropdown-button"),btnText=n.querySelector(".btn-text"),a=i.querySelector(".custom-range"),n.onclick=function(){i.classList.toggle("open")},dropdown.onclick=function(e){l._pickerHandler(e)},this._setCurrentRange(this.defaults.defaultOption),o=document.getElementById("custom-range-from"),r=document.getElementById("custom-range-to"),rome(o,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.beforeEq(r)}),rome(r,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.afterEq(o)})}},this._setCurrentRange=function(e){"today"===e?(this.date.start=today().toStartOf().valueOf(),this.date.end=today().toEndOf().valueOf()):"yesterday"===e?(this.date.end=today().toEndOf().minus(1).valueOf(),this.date.start=today().toStartOf().minus(1).valueOf()):"week"===e?(this.date.end=today().toEndOf().valueOf(),this.date.start=today().toStartOf().minus(7).valueOf()):"30_days"===e?(this.date.end=today().toEndOf().valueOf(),this.date.start=today().toStartOf().minus(30).valueOf()):"60_days"===e?(this.date.end=today().toEndOf().valueOf(),this.date.start=today().toStartOf().minus(60).valueOf()):"custom"===e&&this._setCustomRange(),t&&this._setButtonText()},this._rangeToString=function(){var e=rome.find(o).getDateString("MM/DD/YYYY"),t=rome.find(r).getDateString("MM/DD/YYYY");this.date.start=today(e).toStartOf().valueOf(),this.date.end=today(t).toEndOf().valueOf(),this._setButtonText()},this.formatDate=function(e,t){var n=("0"+(e.getMonth()+1)).slice(-2),o=("0"+e.getDate()).slice(-2),a=e.getFullYear();return"mm/dd/yyyy"==t?n+"/"+o+"/"+a:o+"/"+n+"/"+a},this._setCustomRange=function(e){var t=today().toStartOf().dateOf(),n=today().toEndOf().dateOf();o.value=this.formatDate(t),r.value=this.formatDate(n)},this._setButtonText=function(){btnText.innerHTML=this.formatDate(new Date(this.date.start))+" - "+this.formatDate(new Date(this.date.end))},this._closeDropdowns=function(){i.classList.toggle("open"),removeEvent(document,"click",this._closeDropdowns)},this.today=function(){return today().toStartOf().valueOf()},this.template=function(){return'<button type="button" class="btn btn-'+this.defaults.buttonColor+" btn-"+this.defaults.buttonSize+' btn-block dropdown-button" aria-expanded="true"><span class="btn-text" style="margin-right:5px"></span><span class="caret"></span></button><div class="dropdown-menu"><div class="col-xs-12 btn-group btn-group-vertical" data-toggle="buttons"><label class="btn btn-default active"><input type="radio" name="options" data-range="today"autocomplete="on" checked>'+s.DATE_PICKER.TODAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="yesterday" autocomplete="off" checked>'+s.DATE_PICKER.YESTERDAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="week" autocomplete="off">'+s.DATE_PICKER.LAST_7_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="30_days" autocomplete="off">'+s.DATE_PICKER.LAST_30_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="60_days" autocomplete="off">'+s.DATE_PICKER.LAST_60_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="custom" autocomplete="off">'+s.DATE_PICKER.CUSTOM_RANGE+'</label></div><div class="col-xs-12 custom-range ghosted"><br><div class="input-group"><input type="text" class="form-control" id="custom-range-from"><span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" class="form-control" id="custom-range-to"></div></div>'+(this.defaults.interval?'<div class="col-xs-12 custom-interval"><hr><p>'+s.DATE_PICKER.INTERVAL+'</p><div class="btn-group btn-group-justified" data-toggle="buttons"><label class="btn btn-default"><input type="radio" name="options" data-interval="1/4_hour" autocomplete="off">15'+s.MIN+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="1/2_hour" autocomplete="off">30'+s.MIN+'</label><label class="btn btn-default active"><input type="radio" name="options" data-interval="hour" autocomplete="off" checked>'+s.HOUR+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="day" autocomplete="off">'+s.DAY+"</label></div></div>":"")+'<div class="col-xs-12"><hr>'+(this.defaults.actionButton?'<button type="button" name="submitButton" class="btn btn-primary btn-md btn-block">'+s.SEARCH+"</button>":'<button type="button" name="selectButton" class="btn btn-primary btn-md btn-block">'+s.SELECT+"</button>")+"</div></div>"},this._init()}function Player(){var e,t,n,o,a,r,i,s,c,l,d=1,u=!1,m="",b=function(){addEvent(e,"click",function(e){g(e)}),addEvent(i,"playing",function(){o.innerHTML='<i class="fa fa-fw fa-pause"></i>',v.lastEl&&(v.lastEl.innerHTML='<i class="fa fa-fw fa-pause"></i>')},!0),addEvent(i,"loadedmetadata",function(){a.textContent=formatTimeString(parseInt(i.duration),"hh:mm:ss")}),addEvent(i,"pause",function(){o.innerHTML='<i class="fa fa-fw fa-play"></i>',v.lastEl&&(v.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>')},!0),addEvent(i,"timeupdate",p,!0),addEvent(i,"ended",f(d+1),!0),addEvent(t,"click",function(e){e=e||window.event,i.currentTime=(i.duration*((e.offsetX||e.layerX)/t.clientWidth)).toFixed(2)},!0)},p=function(){var e=0===i.currentTime?0:Math.floor(100/i.duration*i.currentTime);n.textContent=formatTimeString(parseInt(i.currentTime),"hh:mm:ss"),t.value=e,$(document).trigger("player:timeupdate",[{time:1e3*i.currentTime,trackIndex:d}])},f=function(e){!v.playlist.length||e<=1||e>=v.playlist.length||(d=e,$(document).trigger("player:track",[{track:d}]),i.src=v.filePath+v.playlist[d-1].file,m=v.playlist[d-1].file,r.href=i.src,r.setAttribute("download",i.src),i.play())},g=function(e){var t=(e=e||window.event).target;"I"==t.nodeName&&(t=t.parentNode),"pl-play"==t.id&&v.playAudio(),"pl-stop"==t.id&&v.stopAudio(),"pl-prev"==t.id&&v.prevAudio(),"pl-next"==t.id&&v.nextAudio(),"pl-close"==t.id&&h()},h=function(){e.classList.remove("shown"),v.stopAudio(),u=!1},v={playlist:[],filePath:"",audioFile:"",audioURL:"",audio:i,lastEl:null,playAudio:function(){!1===u&&(e.classList.add("shown"),u=!0,v.playlist.length&&(s.style.width="475px",c.classList.remove("hidden"))),this.audioURL!==m&&(i.src=this.filePath+this.audioURL,m=this.audioURL,r.href=this.audioURL,r.setAttribute("download",this.audioFile)),i.paused?i.play():i.pause()},prevAudio:function(){this.stopAudio(),f(d-1)},nextAudio:function(){this.stopAudio(),f(d+1)},stopAudio:function(){i.pause(),i.currentTime=0}};return l=function(){return'<audio id="audio-rec" type="audio/x-wav; codecs=\'1\'"></audio><div class="pl-controls" id="pl-controls"><a href="#" download="" class="pl-control bg-success pull-left" id="pl-download"><i class="fa fa-download"></i></a><button class="pl-control bg-primary pull-left" id="pl-play"><i class="fa fa-fw fa-play"></i></button><div id="pl-pb-control" class="hidden" style="display:inline;height: 100%;"><button class="pl-control bg-primary pull-left" id="pl-prev"><i class="fa fa-fw fa-backward"></i></button><button class="pl-control bg-primary pull-left" id="pl-next"><i class="fa fa-fw fa-forward"></i></button></div><div class="pl-time"><span id="pl-time"></span>/<span id="pl-duration"></span></div><progress id="pl-seek" max="100" value="0" class-"pl-seek-bar"></progress><button class="pl-control bg-danger pull-right" id="pl-close"><i class="fa fa-fw fa-close"></i></button><button class="pl-control bg-primary pull-right" id="pl-stop"><i class="fa fa-fw fa-stop"></i></button></div>'}(),(e=document.createElement("div")).id="rec-player",e.className="pl-cont",e.innerHTML=l,document.querySelector("body").appendChild(e),t=document.getElementById("pl-seek"),n=document.getElementById("pl-time"),o=document.getElementById("pl-play"),a=document.getElementById("pl-duration"),r=document.getElementById("pl-download"),i=document.getElementById("audio-rec"),s=document.getElementById("pl-controls"),c=document.getElementById("pl-pb-control"),b(),v}function load_profile(){var e="user"==PbxObject.options.profile.kind?"users":"unit",t=extend({},PbxObject.options.profile),n=[];getObjects(e,function(e){n=n.concat(e),function(e,t){show_content();var n=document.getElementById("el-loaded-content"),o=document.createElement("div"),a=document.createElement("div");extend({},e).permissions=null,o.className="panel",a.className="panel-body",o.appendChild(a),n.appendChild(o),ReactDOM.render(ExtensionComponent({frases:PbxObject.frases,params:e,groups:t,onSubmit:PbxObject.isUserAccount?checkPermissions("user",3)?setExtension:null:setExtension,generatePassword:generatePassword,convertBytes:convertBytes,getObjects:getObjects,isUserAccount:PbxObject.isUserAccount,onChange:function(){}}),a)}(t,n)})}function load_realtime(){var t=null,n={extensions:[],state:{inc:0,out:0,conn:0,load:0},trunks:[],calls:[]};function o(){ReactDOM.render(RealtimeDashboardComponent({frases:PbxObject.frases,data:n}),document.getElementById("el-loaded-content"))}function a(){json_rpc_async("getCurrentCalls",null,r),json_rpc_async("getCurrentState",null,e)}function e(e){n.state=e,n.trunks=e.trunks,o()}function r(e){e&&(n.calls=e,o())}function i(){clearInterval(t),removeEvent(window,"hashchange",i)}getExtensions(function(e){n.extensions=e,t=setInterval(a,1e3),addEvent(window,"hashchange",i),o(),show_content(),set_page()})}function load_rec_settings(){json_rpc_async("getVoiceRecordingList",null,function(e){getRecObjects(e)}),$("#set-rec-settings").click(function(){setRecObjects()})}function getRecObjects(n){var e=0,o={};function a(){2===(e+=1)&&fillSelects(o)}o.result=n,json_rpc_async("getObjects",{kind:"trunk"},function(e){n.trunks?o.trunks=e.filter(function(e){return-1==n.trunks.indexOf(e.name)}):o.trunks=e,a()}),json_rpc_async("getExtensions",null,function(e){var t=filterObject(e,["phone","user"]);n.extensions?o.exts=t.filter(function(e){return-1===n.extensions.indexOf(e.ext)}):o.exts=t,a()})}function fillSelects(e){document.querySelector('#trunks-rec-mode input[value="'+e.result.trunksmode+'"]').checked=!0,document.querySelector('#ext-rec-mode input[value="'+e.result.extmode+'"]').checked=!0,e.result.trunks&&fill_list_items("rec-trunks",e.result.trunks),e.result.extensions&&fill_list_items("rec-ext",e.result.extensions),fill_list_items("av-trunks",e.trunks,"name"),fill_list_items("av-ext",e.exts,"ext"),close_options(),set_page(),show_content()}function setRecObjects(){var e="",t=document.querySelector("#trunks-rec-mode input:checked"),n=document.querySelector("#ext-rec-mode input:checked"),o=document.getElementById("rec-trunks"),a=document.getElementById("rec-ext");e+='"trunks":[';for(var r=0;r<o.children.length;r++)e+='"'+o.children[r].innerHTML+'",';e+="],",e+='"extensions":[';for(r=0;r<a.children.length;r++)e+='"'+a.children[r].innerHTML+'",';e+="],",e+='"trunksmode":'+t.value+",",json_rpc_async("setVoiceRecordingList",e+='"extmode":'+n.value+",",function(){set_object_success()})}function load_records(){PbxObject.Pagination=new Pagination,PbxObject.recPicker=new Picker("recs-date-picker",{submitFunction:getRecParams,buttonSize:"md"});var a={playRecord:playRecord,getQos:getQos,toggleRecQoS:toggleRecQoS};[].slice.call(document.querySelectorAll(".init-mode")).forEach(function(e){"0"===e.value&&(e.checked=!0)}),json_rpc_async("getObjects",{kind:"trunk"},function(e){e.unshift({oid:PbxObject.frases.ALL,name:PbxObject.frases.ALL}),fill_select_items("searchtrunk",e)}),$("#sample-data").hide(),$("#records-table").click(function(e){var t="I"===e.target.nodeName?e.target.parentNode:e.target,n=t.getAttribute("data-method"),o=t.getAttribute("data-param");a[n]&&a[n](o,t,e)}),TableSortable.sortables_init(),getRecords({begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end},showRecords),show_content()}function build_records_row(e,t){if(e){var n,o=0,a="",r=t.rows.length,i=t.insertRow(r),s=e.td;if(e.id&&(i.id=e.id),n=i.insertCell(o++),e.fi){var c=document.createElement("a");c.href="#",c.setAttribute("data-method","playRecord"),c.setAttribute("data-param",e.fi),c.innerHTML='<i class="fa fa-play fa-fw"></i>',n.appendChild(c)}(n=i.insertCell(o++)).textContent=formatDateString(e.ts),(n=i.insertCell(o++)).className="nowrap",n.textContent=e.na,n=i.insertCell(o++),a=e.nc&&e.nc!==e.nb?e.nb+" ("+e.nc+")":e.nb,n.textContent=a,n.title=a,n=i.insertCell(o++),a=e.ta?e.tb?e.ta+" ("+e.tb+")":e.ta:e.tb,n.textContent=a,(n=i.insertCell(o++)).textContent=formatTimeString(s,"hh:mm:ss"),(n=i.insertCell(o++)).textContent=getFriendlyCodeName(e.cs),(n=i.insertCell(o++)).textContent=parseFloat(e.tr).toFixed(2),(n=i.insertCell(o++)).textContent=parseFloat(e.ch).toFixed(2),(n=i.insertCell(o++)).innerHTML=e.fi?'<a href="'+window.location.protocol+"//"+window.location.host+"/records/"+e.fi+'" download="'+e.fi+'" target="_blank"><i class="fa fa-fw fa-download"></i></a>':"",(n=i.insertCell(o++)).innerHTML='<a href="#" data-method="getQos" data-param="'+e.id+'"><i class="fa fa-fw fa-info"></i></a>'}}function getRecParams(e){show_loading_panel(document.querySelector("#pagecontent"));var t,n,o,a=document.querySelectorAll(".init-order"),r=document.querySelectorAll(".init-mode"),i=document.getElementById("searchnum"),s=document.getElementById("searchtrunk");for(o=0;o<a.length;o++)a[o].checked&&(t=a[o].value);for(o=0;o<r.length;o++)r[o].checked&&(n=r[o].value);var c={begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end};i.value&&(c.number=i.value),s.value!==PbxObject.frases.ALL&&(c.trunk=s.options[s.selectedIndex].textContent),n&&(c.mode=parseInt(n,10)),t&&(c.order=parseInt(t,10)),getRecords(c,showRecords)}function getRecords(e,t){json_rpc_async("getCalls",e,t)}function showRecords(e){show_content();var t=document.getElementById("records-table").querySelector("tbody"),n=document.getElementById("searchrows");!n.value&&20<e.length&&(n.value=20);for(var o,a=n.value?parseInt(n.value):e.length,r=e.length>a?Math.ceil(e.length/a):1,i=0,s=0;s<e.length;s++)for(o in e[s])"ch"==o&&(i+=parseFloat(e[s][o]));i=i.toFixed(2),$("#sample-data").show(),$("#sample-length").text(e.length),$("#sample-cost").text(i),PbxObject.Pagination.options={table:t,page:1,maxpagins:5,rows:a,records:e,pagnum:r,buildTableFunction:build_records_row},PbxObject.Pagination.createPagination(),PbxObject.Pagination.selectPage(1)}function getQos(t,n,e){if(e.preventDefault(),t){var o=n.innerHTML;n.getAttribute("data-method");n.innerHTML='<i class="fa fa-spinner fa-spin"></i>',n.setAttribute("data-method",""),getRecords({begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end,qos:!0,id:t},function(e){n.innerHTML=o,n.setAttribute("data-method","toggleRecQoS"),showRecQoS(t,e)})}}function toggleRecQoS(e){$("#"+e+"-qos").collapse("toggle")}function showRecQoS(e,t){var n=document.createElement("tr"),o=document.createElement("td"),a=document.createElement("div");a.id=e+"-qos",a.className="collapse",o.colSpan="11",o.style.padding="0",o.style.borderTop="none",o.appendChild(a),n.appendChild(o),$(n).insertAfter("#"+e),ReactDOM.render(RecQosTable({frases:PbxObject.frases,data:t[0],utils:{formatTimeString:formatTimeString}}),a),$(a).collapse()}function playRecord(e,t,n){n.preventDefault(),PbxObject.Player=PbxObject.Player||new Player;var o=PbxObject.Player;null!==o.lastEl&&o.lastEl!=t&&(o.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>'),o.lastEl=t,o.audioFile=e,o.audioURL=window.location.protocol+"//"+window.location.host+"/records/"+e,o.playAudio()}function load_reg_history(e){var t,n;n={frases:PbxObject.frases,params:t},ReactDOM.render(UsersRegHistoryComponent(n),document.getElementById("el-loaded-content")),show_content()}function renderSidebar(n){var r=PbxObject.profile,i=(PbxObject.options.config,getInstanceMode()),s=PbxObject.options.permissions&&PbxObject.isUserAccount?PbxObject.options.permissions.reduce(function(e,t){return e[t.name]=t.grant,e},{}):null;function c(e){return!!e&&isBranchPackage(e)}function l(e,t){return s?t?c(t)&&!!s[e]:!!s[e]:!t||c(t)}function d(e){var t=extend({},n);t.activeKind=e,t.activeItem=n.activeItem||n.activeKind,o(t)}function o(e){var t=function(){var e=[{name:"profile",iconClass:"fa fa-id-card",link:"#profile",shouldRender:!!PbxObject.isUserAccount},{name:"dashboard",iconClass:"fa fa-fw fa-pie-chart",shouldRender:l("statistics")||l("records")||l("users")||l("customers"),objects:[{kind:s?"":"guide",iconClass:"fa fa-fw fa-arrow-circle-o-right",standout:!0},{kind:l("trunks")?"realtime":"",iconClass:"fa fa-fw fa-tachometer"},{kind:l("records")?"records":"",iconClass:"fa fa-fw fa-phone"},{kind:l("statistics")?"statistics":"",iconClass:"fa fa-fw fa-table"},{kind:l("statistics")?"channel_statistics":"",iconClass:"fa fa-fw fa-area-chart"},{kind:l("users")||l("equipment")?"extensions":"",iconClass:"icon-uniE908"},{kind:l("users")?"reg_history":"",iconClass:"fa fa-fw fa-history"},{kind:l("customers")?"customers":"",iconClass:"fa fa-fw fa-users"}]},{name:"users",iconClass:"icon-contact",type:"group",shouldRender:l("users"),fetchKinds:["users"]},{name:"equipment",iconClass:"icon-landline",type:"group",shouldRender:l("equipment"),fetchKinds:["equipment"]},{name:"servicegroup",iconClass:"icon-headset_mic",type:"group",fetchKinds:["hunting",c("team")?"":"icd",c("team")?"":"chatchannel"],shouldRender:l("chatchannel")},{name:"chattrunk",iconClass:"icon-perm_phone_msg",shouldRender:l("chattrunk","free|trial|business|enterprise"),fetchKinds:["chattrunk"]},{name:"trunk",iconClass:"icon-dialer_sip",shouldRender:l("trunk"),fetchKinds:["trunk"]},{name:"attendant",iconClass:"fa fa-fw fa-sitemap",shouldRender:l("attendant"),fetchKinds:["attendant"]},{name:"application",iconClass:"fa fa-fw fa-cubes",shouldRender:l("application","enterprise"),fetchKinds:["application"]},{name:"timer",iconClass:"fa fa-fw fa-clock-o",shouldRender:l("timer"),fetchKinds:["timer"]},{name:"routes",iconClass:"fa fa-fw fa-arrows",shouldRender:l("routes"),fetchKinds:["routes"]},{name:"location",iconClass:"fa fa-fw fa-map-marker",shouldRender:l("location","enterprise"),fetchKinds:["location"]}];return s||(e=e.concat([{name:"settings",shouldRender:!1,objects:[{kind:"branch_options",iconClass:"fa fa-fw fa-sliders"},{kind:"rec_settings",iconClass:"fa fa-fw fa-microphone"},{kind:"services",iconClass:"fa fa-fw fa-plug"},{kind:"storages",iconClass:"fa fa-fw fa-hdd-o"},{kind:0!==i||r.partnerid?"":"licenses",iconClass:"fa fa-fw fa-key"},{kind:0!==i||r.partnerid?"":"billing",iconClass:"fa fa-fw fa-credit-card"},{kind:"certificates",iconClass:"fa fa-fw fa-lock"}]}])),e}(),n=function(e){return e.match("hunting|icd|chatchannel|selector")?"servicegroup":e.match("guide|realtime|statistics|channel_statistics|records|extensions|reg_history|customers")?"dashboard":e.match("extensions")?"users":e.match("branch_options|rec_settings|services|storages|licenses|billing|certificates|developer")?"settings":e}(e.activeKind),o=e.activeItem||e.activeKind,a=t.filter(function(e){return e.name===n})[0];!function(t,e,n){var o=[];if(!t.fetchKinds||!t.fetchKinds.length)return n(o);getObjects(t.fetchKinds,function(e){return o=e?o.concat(e):o,-1!==t.fetchKinds.indexOf("trunk")&&(o=o.filter(function(e){return"service"!==e.type})),n(o)})}(a,e.branchOptions,function(e){componentParams={frases:PbxObject.frases,menuItems:t,activeKind:n,activeItem:o,selectedMenu:a,selectKind:d,objects:e},ReactDOM.render(SideBarComponent(componentParams),document.getElementById("pbxmenu"))})}o(n)}function load_reports(){new Reports}function chartOptions(e){return{xaxis:{mode:"time",timeformat:e,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0,labelFormatter:function(e,t){return'<span class="chart-label">'+e+"</span>"}},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:e}}}function Reports(){document.querySelectorAll(".calls-incoming"),document.querySelectorAll(".calls-outgoing"),document.querySelectorAll(".calls-connected"),document.querySelectorAll(".calls-load");var h,t=this;this.init=function(){var e;e='"begin":'+(h=new Picker("calls-date-picker",{submitFunction:t.getStatistics,interval:!0,buttonSize:"md"})).date.start+', "end":'+h.date.end+', "interval":'+h.interval,json_rpc_async("getCallStatisticsGraph",JSON.parse(e),function(e){t.createGraph(e),show_content()})},this.getStatistics=function(){$("#reports-cont").addClass("faded");var e='"begin":'+h.date.start+', "end":'+h.date.end+', "interval":'+h.interval;json_rpc_async("getCallStatisticsGraph",JSON.parse(e),function(e){t.createGraph(e),$("#reports-cont").removeClass("faded")})},this.createGraph=function(e){if(!e.length)return $("#outCalls-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),$("#inAndLost-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),$("#intCalls-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),void $("#linesLoad-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>");for(var t,n,o,a=[],r=[],i=[],s=[],c=[],l=("1/2_hour"==h.intervalString||"1/4_hour"==h.intervalString||h.intervalString,"hour"==(o=h.intervalString)?"%H:%M":"day"==o?"%d %b":"%H:%M"),d=0,u=e.length;d<u;d++)t=(n=e[d]).t,a.push([t,n.i]),r.push([t,n.o]),i.push([t,n.l]),s.push([t,n.m]),c.push([t,n.p]);var m={show:!0,barWidth:h.interval,lineWidth:0,fill:.7};insAndLostData=[{label:PbxObject.frases.STATISTICS.CONNECTEDCALLS,stack:0,bars:m,data:a,color:"#3c763d"},{label:PbxObject.frases.STATISTICS.LOSTCALLS,stack:0,bars:m,data:s,color:"#AA4643"}],r=[{label:PbxObject.frases.SETTINGS.OUTCALLS,bars:m,data:r,color:"#4572A7"}],i=[{label:PbxObject.frases.SETTINGS.INTCALLS,bars:m,data:i,color:"#BADABA"}],c=[{label:PbxObject.frases.STATISTICS.LINES_PAYLOAD,data:c,lines:{show:!0,fill:!1},points:{show:!0},color:"#3c763d"}],{xaxis:{mode:"time",timeformat:l,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:l}};var b=new chartOptions(l);b.legend.container=$("#outCalls-graph-lg");var p=new chartOptions(l);p.legend.container=$("#inAndLost-graph-lg");var f=new chartOptions(l);f.legend.container=$("#intCalls-graph-lg");var g=new chartOptions(l);g.legend.container=$("#linesLoad-graph-lg"),$.plot($("#outCalls-graph"),r,b),$.plot($("#inAndLost-graph"),insAndLostData,p),$.plot($("#intCalls-graph"),i,f),$.plot($("#linesLoad-graph"),c,g)},this.init()}function load_routes(e){PbxObject.oid=e.oid,PbxObject.routepriorities=["Max. prefix length","Least cost routing","Load balancing","Answer seizure ratio","Average call duration","Most idle gateway","Least utilised gateway","Max. priority (status)"],PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})}));document.getElementById("rtable");var o,a=document.getElementById("priorities"),r=e.priorities;for(o=0;o<r.length;o++){var i=document.createElement("li");i.setAttribute("data-routepriority",r[o]),i.innerHTML=PbxObject.routepriorities[r[o]],a.appendChild(i)}var s=e.anumbertransforms;if(s.length)for(o=0;o<s.length;o++)append_transform(null,"transforms1",s[o]);else append_transform(null,"transforms1");if((s=e.bnumbertransforms).length)for(o=0;o<s.length;o++)append_transform(null,"transforms2",s[o]);else append_transform(null,"transforms2");null!=e.routes?build_routes_table(e.routes):show_content(),TableSortable.sortables_init(),set_page()}function set_routes(){var e=document.getElementById("objname").value;if(!e)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var t,n='"name":"'+e+'",';show_loading_panel(),t=PbxObject.name?set_object_success:(PbxObject.name=e,null),PbxObject.oid&&(n+='"oid":"'+PbxObject.oid+'",'),n+='"kind":"routes",',n+='"enabled":'+document.getElementById("enabled").checked+",",n+='"priorities":[';var o,a=document.getElementById("priorities");for(o=0;o<a.children.length;o++)n+=a.children[o].getAttribute("data-routepriority")+",";n+="],",n+='"anumbertransforms":[',n+=encode_transforms("transforms1"),n+="],",n+='"bnumbertransforms":[',n+=encode_transforms("transforms2"),n+="],",n+='"routes":[';var r,i,s=document.getElementById("rtable");for(o=1;o<s.rows.length;o++)(i=s.rows[o]).cells[0].textContent&&(r="",r+='"number":"'+i.cells[0].textContent+'",',r+='"description":"'+i.cells[1].textContent+'",',r+='"target":{"oid":"'+i.cells[2].getAttribute("data-gid")+'"},',r+='"priority":'+parseInt(i.cells[3].getAttribute("data-priority"))+",",(r+='"cost":'+parseFloat(i.cells[4].textContent)+",")&&(n+="{"+r+"},"));setObject(n+="]",t)}function getRouteObjects(t){var n=[];getObjects(["equipment","users","cli","timer","routes","pickup","chattrunk","chatchannel"],function(e){n=n.concat(e),getExtensions(function(e){n=n.concat(e.filter(function(e){return e.kind.match(/user|phone/)})),t(n)})},!0)}function build_routes_table(n){var o,a=document.getElementById("rtable").getElementsByTagName("tbody")[0];getRouteObjects(function(e){if(!n.length&&e.length)a.appendChild(build_route_row(null,e));else{sortByKey(n,"number"),o=document.createDocumentFragment();for(var t=0;t<n.length;t++)isChannelRoute(n[t])||o.appendChild(add_route_row(n[t],e));a.appendChild(o)}show_content()})}function isChannelRoute(e){return e.number&&-1!==e.number.indexOf("@")}function editRow(n,o){getRouteObjects(function(e){var t=build_route_row(o,e);n.parentNode.insertBefore(t,n),n.style.display="none"})}function add_new_route(e){(e=e||window.event)&&e.preventDefault(),getRouteObjects(function(e){var t=document.getElementById("rtable").getElementsByTagName("tbody")[0];t.insertBefore(build_route_row(null,e),t.children[0])})}function add_route_row(t,e){var n,o,a;(o=(n=document.createElement("tr")).insertCell(0)).textContent=t.number,(o=n.insertCell(1)).textContent=t.description,o.className="nowrap",o.title=t.description||"",o=n.insertCell(2);var r={};for(i=0;i<e.length;i++)e[i].oid==t.target.oid&&(r=e[i],o.setAttribute("data-gid",t.target.oid),o.setAttribute("data-gname",r.name),a=document.createElement("a"),r.kind.match(/user|phone/)?(a.href="#",a.onclick=function(e){e.preventDefault(),getExtension(r.oid)}):a.href="#"+r.kind+"/"+r.oid,a.innerText=r.name,o.appendChild(a));return(o=n.insertCell(3)).setAttribute("data-priority",t.priority),o.textContent=0==t.priority?"OFF":10==t.priority?"EXV":t.priority,(o=n.insertCell(4)).textContent=parseFloat(t.cost).toFixed(2),o=n.insertCell(5),button=document.createElement("button"),button.className="btn btn-primary btn-sm",button.innerHTML='<i class="fa fa-edit"></i>',addEvent(button,"click",function(){editRow(n,t)}),o.appendChild(button),o=n.insertCell(6),button=document.createElement("button"),button.className="btn btn-danger btn-sm",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",function(e){if(!confirm(PbxObject.frases.DELETE+" "+PbxObject.frases.ROUTE.toLowerCase()+"?"))return!1;deleteRoute(t.oid),remove_row(e)}),o.appendChild(button),n}function build_route_row(e,n){var t,o,a,r={},i=document.createElement("tr"),s=document.createElement("td"),c=document.createElement("div"),l=document.createElement("input"),d={};i.className="route-on-edit",i.style.height="70px",l.className="form-control",l.setAttribute("type","text"),l.setAttribute("name","number"),l.setAttribute("size","12"),r.groupid=PbxObject.oid,null!=e&&(l.value=e.number,r.oid=e.oid),r.number=l.value.trim(),l.onchange=function(){r.number=l.value.trim()},c.appendChild(l),s.appendChild(c),i.appendChild(s),s=document.createElement("td");c=document.createElement("div");descr=document.createElement("input"),descr.className="form-control",descr.setAttribute("type","text"),descr.setAttribute("name","description"),null!=e&&(descr.value=e.description),r.description=descr.value,descr.onchange=function(){r.description=descr.value},c.appendChild(descr),s.appendChild(c),i.appendChild(s),s=document.createElement("td");c=document.createElement("div");target=document.createElement("select"),target.className="form-control",target.setAttribute("name","target");for(var u=0;u<n.length;u++)d[o=n[u].kind]?t=d[o]:((t=document.createElement("optgroup")).setAttribute("label",PbxObject.frases.KINDS[o]),d[o]=t,target.appendChild(t)),a=n[u].oid,(m=document.createElement("option")).setAttribute("value",a),m.innerHTML=n[u].name,null!=e&&a==e.target.oid&&m.setAttribute("selected",""),t.appendChild(m);n.length&&(r.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent},target.onchange=function(){r.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent}}),c.appendChild(target),s.appendChild(c),i.appendChild(s),s=document.createElement("td");c=document.createElement("div");priority=document.createElement("select"),priority.className="form-control",priority.setAttribute("name","priority");for(u=0;u<=10;u++){var m;(m=document.createElement("option")).value=u,null!=e&&u==e.priority&&m.setAttribute("selected",""),m.innerHTML=0==u?"OFF":10==u?"EXV":u,priority.appendChild(m)}e||(priority.selectedIndex=1),c.appendChild(priority),r.priority=priority.options[priority.selectedIndex].value,priority.onchange=function(){r.priority=priority.options[priority.selectedIndex].value},s.appendChild(c),i.appendChild(s),s=document.createElement("td");c=document.createElement("div");return cost=document.createElement("input"),cost.className="form-control",cost.setAttribute("type","text"),cost.setAttribute("name","cost"),cost.setAttribute("size","2"),null!=e&&e.cost?cost.setAttribute("value",parseFloat(e.cost).toFixed(2)):cost.value=parseFloat(0).toFixed(2),r.cost=parseFloat(cost.value).toFixed(2),cost.onchange=function(){r.cost=parseFloat(cost.value).toFixed(2)},c.appendChild(cost),s.appendChild(c),i.appendChild(s),s=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-default btn-sm",button.innerHTML='<i class="fa fa-chevron-left"></i>',addEvent(button,"click",function(){var e=i.nextSibling;e&&"TR"==e.nodeName&&"none"==e.style.display&&(e.style.display="table-row"),i.parentNode.removeChild(i)}),s.appendChild(button),i.appendChild(s),s=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-success btn-sm",button.innerHTML='<i class="fa fa-check"></i>',addEvent(button,"click",function(){if(document.getElementById("objname").value)if(r.number){isNaN(r.cost)&&(r.cost=0);var e=i.nextSibling,t=add_route_row(r,n);i.parentNode.insertBefore(t,i),e&&"TR"==e.nodeName&&"none"==e.style.display&&e.parentNode.removeChild(e),i.parentNode.removeChild(i),setRoute(r,set_object_success)}else alert(PbxObject.frases.MISSED_ROUTE_NUMBER);else alert(PbxObject.frases.MISSEDNAMEFIELD)}),s.appendChild(button),i.appendChild(s),i}function setRoute(e,t){var n=e,o=t||null;e.oid&&(n.oid=e.oid),e.priority&&(n.priority=parseFloat(e.priority)),e.cost&&(n.cost=parseFloat(e.cost)),json_rpc_async("setRoute",n,o)}function deleteRoute(e){json_rpc_async("deleteRoute",'"oid":"'+e+'"',set_object_success)}function load_selector(r){var e,t,i=r,s=null,c=(e=PbxObject.frases.KINDS.selector+" ",e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1),n=[].concat(i.members),o=[];function a(e){i.name=e}function l(e){i.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(e){return!0})}function d(){(t=document.getElementById("available-users-cont"))&&t.parentNode.removeChild(t),(t=document.createElement("div")).id="available-users-cont",document.body.appendChild(t),ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,availableList:o,excludeList:i.members,onSubmit:u,groupid:PbxObject.name?PbxObject.oid:null}),t)}function u(e){i.members=i.members.concat(e),PbxObject.name?b(i,function(e){f(i)}):f(i),$("#available-users-modal").modal("hide")}function m(e){var t=e.oid;i.members=i.members.filter(function(e){return e.oid!==t}),PbxObject.name?b(i,function(e){f(i)}):f(i)}function b(e,n){PbxObject.name&&(s=set_object_success);var o=extend({},e),a=o.name||c;o.members=o.members.reduce(function(e,t){return e=e.concat([t.ext])},[]),setObject({kind:PbxObject.kind,oid:o.oid,name:a,owner:o.owner,enabled:o.enabled,options:o.options,members:o.members},function(e){if(PbxObject.name=i.name=a,o.files&&o.files.length&&o.files.forEach(function(e){uploadFile(e)}),o.route&&o.route.ext){var t={number:o.route.ext,target:{oid:PbxObject.oid,name:PbxObject.name}};r.routes.length&&(t.oid=r.routes[0].id),setObjRoute(t)}s&&s(),n&&n(e)})}function p(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function f(e){var t={frases:PbxObject.frases,params:e,onAddMembers:d,setObject:b,onNameChange:a,onStateChange:l,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:m};e.name&&(t.removeObject=p),ReactDOM.render(SelectorComponent(t),document.getElementById("el-loaded-content"))}PbxObject.oid=r.oid,PbxObject.name=r.name,getExtensions(function(e){o=e.filter(function(e){return"user"===e.kind||"phone"===e.kind}),i.members=o.filter(function(e){return-1!==n.indexOf(e.ext)}),f(i),show_content(),set_page()})}function load_services(){var o=[],t=null,n=[],a={},r=window.sessionStorage.serviceParams,i=["Azure","Zapier"],s=["DynamicsCRMOnline","MicrosoftAD"];function c(e){(a=Ldap({service_id:e.id,service_type:e.type,available:[],onaddusers:l,members:n})).getExternalUsers()}function l(e){e.length&&(show_loading_panel(),a.setExternalUsers({service_id:a.options.service_id,users:e},function(e){a.close(),"OK"===e&&set_object_success()}))}function d(n){var e="/services/"+n.id+"/Subscription";e+="?state="+(n.state?1:0),request("GET",e+=Object.keys(n.props).reduce(function(e,t){return e+="&"+t+"="+n.props[t]},""),null,null,function(e,t){if(e)return notify_about("error",e);t.result&&(t.result.location?window.location=t.result.location:(set_object_success(),o=o.map(function(e){return e.id===n.id&&(e=n),e}),m()))})}function u(e){json_rpc_async("setPbxOptions",{ldap:e.props},function(){t=e,m(),set_object_success()})}function m(){var e={frases:PbxObject.frases,saveOptions:d,saveLdapOptions:u,services:o,onImportUsers:c,ldap:t};ReactDOM.render(ServicesComponent(e),document.getElementById("el-loaded-content")),r&&r.id&&1===getQueryParams().success&&c(r),show_content()}json_rpc_async("getPbxOptions",null,function(e){e.config,o=function(e){var t=isBranchPackage("team")?i.join(s):isBranchPackage("business")||isBranchPackage("trial")?s:[];return e.filter(function(e){return-1===t.indexOf(e.id)})}(e.services),isBranchPackage("enterprise")&&((t={}).props=e.ldap||{},t.name="Microsoft Active Directory",t.id="MicrosoftAD",t.types=1),getExtensions(["phone","user"],function(e){n=e,m()})})}function load_statistics(){new Statistics}function Statistics(){var i,e,t,o=document.getElementById("trunks-statistics-table"),c=document.getElementById("ext-statistics-table"),n=document.getElementById("ext-stats-btn"),a=document.getElementById("ext-stat-kind"),r=document.getElementById("lost-stats-btn"),s=document.getElementById("trunks-qos-btn"),l=document.getElementById("dcontainer"),d=[].slice.call(l.querySelectorAll(".data-model")),u="inbound",m=PbxObject.oid,b=!0,p=!0,f=!1;function g(e){e&&ReactDOM.render(TrunksQosTable({frases:PbxObject.frases,data:e,utils:{formatTimeString:formatTimeString}}),document.getElementById("trunks-qos-cont"))}function h(){if(f)return!1;f=!0,$("#trunks-qos-cont").addClass("faded"),v({begin:i.date.start,end:i.date.end},function(e){g(e),$("#trunks-qos-cont").removeClass("faded")})}function v(e,t){json_rpc_async("getTrunksStatistics",{begin:e.begin,end:e.end},t)}(self=this)._init=function(){i=new Picker("statistics-date-picker",{submitFunction:self.getStatisticsData,interval:!0,buttonSize:"md"}),e=i.date.start,t=i.date.end,interval=i.interval,json_rpc_async("getCallStatistics",{begin:e,end:t},self._setStatistics),json_rpc_async("getCallStatisticsGraph",{begin:e,end:t,interval:interval},self._setCharts),n.onclick=function(){"shown"!==n.getAttribute("data-state")?(n.setAttribute("data-state","shown"),self._getExtStatisticsData()):n.setAttribute("data-state","hidden")},a.onclick=function(e){var t=(e=e||window.event).target;"LABEL"===t.nodeName&&(u=t.children[0].getAttribute("data-kind"),b=!0,self._getExtStatisticsData())},r.onclick=function(){"shown"!==r.getAttribute("data-state")?(r.setAttribute("data-state","shown"),self._getLostStatisticsData()):r.setAttribute("data-state","hidden")},s.onclick=h,switch_presentation(m),set_page()},this.getColumns=function(e,n,o,t){var a=[n],r=null,i=t?t.convert:null;return e.map(function(e){for(var t in e)t===n||o&&-1===o.indexOf(t)||(r=e[t],"minutes"===i&&(r=parseFloat((r/1e3/60).toFixed(2))),a.push(r))}.bind(this)),a},this.getStatisticsData=function(){var e={begin:i.date.start,end:i.date.end};$("#statistics-cont").addClass("faded"),json_rpc_async("getCallStatistics",e,function(e){self._setStatistics(e),$("#statistics-cont").removeClass("faded")}),json_rpc_async("getCallStatisticsGraph",{begin:i.date.start,end:i.date.end,interval:i.interval},self._setCharts),v(e,g),p=b=!0,"shown"==n.getAttribute("data-state")&&self._getExtStatisticsData(),"shown"==r.getAttribute("data-state")&&self._getLostStatisticsData()},this._getExtStatisticsData=function(){b&&(b=!1,$("#extStat-cont").addClass("faded"),e=i.date.start,t=i.date.end,json_rpc_async("getCallStatisticsExt",'"begin":'+e+', "end":'+t+', "kind":"'+u+'"',function(e){self._setExtStatistics(e),$("#extStat-cont").removeClass("faded")}))},this._getLostStatisticsData=function(){p&&(p=!1,$("#lostCalls-cont").addClass("faded"),e=i.date.start,t=i.date.end,json_rpc_async("getLostCalls",'"begin":'+e+', "end":'+t,function(e){self._setLostStats(e),$("#lostCalls-cont").removeClass("faded")}))},this._setStatistics=function(e){var n,o=e;o.inbounds.duration=formatTimeString(o.inbounds.duration,"hh:mm:ss"),o.outbounds.duration=formatTimeString(o.outbounds.duration,"hh:mm:ss"),o.internals.duration=formatTimeString(o.internals.duration,"hh:mm:ss"),void 0!==o.outbounds.cost&&(o.outbounds.cost=parseFloat(o.outbounds.cost).toFixed(2)),d.forEach(function(e){"inbounds.lost"==(n=e.getAttribute("data-model"))&&(0===o.inbounds.lost?e.classList.remove("negtv-col"):e.classList.add("negtv-col"));var t=n.split(".").reduce(objFromString,o);e.textContent=t}),self._build_trunks_statistics(o.trunks),show_content()},this._setExtStatistics=function(e){clearColumns(c);for(var t=0;t<e.length;t++)self._buildExtStatColumn(e[t])},this._setLostStats=function(e){for(var t=document.createDocumentFragment(),n=document.getElementById("lost-calls-table").querySelector("tbody"),o=0;o<e.length;o++)t.appendChild(self._buildLostCallsTable(e[o]));n.appendChild(t)},this._setCharts=function(e){var t=moment(i.date.start).isSame(i.date.end,"day"),n=moment(i.date.end).diff(i.date.start,"day"),o=864e5===i.interval,a="%d-%m-%Y",r=!isSmallScreen()&&(!(7<=n)||o);o||(a=t?"%H:%M":"%d-%m-%Y %H:%M");c3.generate({bindto:"#outbounds-chart",data:{x:"intervals",columns:[self.getColumns(e,"intervals",["t"]),self.getColumns(e,PbxObject.frases.SETTINGS.OUTCALLS,["o"])]},axis:{x:{show:r,type:"timeseries",tick:{culling:{max:7},format:a}},y:{min:0}}}),c3.generate({bindto:"#inbounds-chart",data:{x:"intervals",columns:[self.getColumns(e,"intervals",["t"]),self.getColumns(e,PbxObject.frases.SETTINGS.INCALLS,["i"]),self.getColumns(e,PbxObject.frases.STATISTICS.LOSTCALLS,["m"])],type:"bar",groups:[[PbxObject.frases.SETTINGS.INCALLS,PbxObject.frases.STATISTICS.LOSTCALLS]]},axis:{x:{show:r,type:"timeseries",tick:{culling:{max:7},format:a}},y:{min:0}}}),c3.generate({bindto:"#internals-chart",data:{x:"intervals",columns:[self.getColumns(e,"intervals",["t"]),self.getColumns(e,PbxObject.frases.SETTINGS.INTCALLS,["l"])]},axis:{x:{show:r,type:"timeseries",tick:{culling:{max:7},format:a}},y:{min:0}}})},this._build_trunks_statistics=function(e){var t=o.querySelector("tbody");clearTable(t);for(var n=0;n<e.length;n++)row=t.insertRow(n),cell=row.insertCell(0),cell.textContent=void 0!==e[n].trunk?e[n].trunk:"",cell=row.insertCell(1),cell.textContent=void 0!==e[n].in?e[n].in:"",cell=row.insertCell(2),cell.textContent=void 0!==e[n].insec?formatTimeString(e[n].insec,"hh:mm:ss"):"",cell=row.insertCell(3),cell.textContent=void 0!==e[n].out?e[n].out:"",cell=row.insertCell(4),cell.textContent=void 0!==e[n].outsec?formatTimeString(e[n].outsec,"hh:mm:ss"):"",cell=row.insertCell(5),cell.textContent=void 0!==e[n].cost?parseFloat(e[n].cost).toFixed(2):""},this._buildExtStatColumn=function(e){for(var t,n,o,a=c.querySelector("thead"),r=c.querySelector("tbody"),i=0;i<a.rows.length;i++)t=document.createElement("th"),a.rows[i].appendChild(t),t.innerHTML=e.ext;for(var s=0;s<r.rows.length;s++){switch(n=r.rows[s].insertCell(-1),s){case 0:o="total";break;case 1:o="connected";break;case 2:o="duration";break;case 3:o="cost"}n.innerHTML=void 0!==e[o]?"duration"===o?formatTimeString(e[o],"hh:mm:ss"):"cost"===o?parseFloat(e[o]).toFixed(2):e[o]:""}},this._buildLostCallsTable=function(e){var t=document.createElement("tr");return t.insertCell(0).textContent=formatDateString(e.ts)||"",t.insertCell(1).textContent=e.na||"",t.insertCell(2).textContent=e.nb||"",t.insertCell(3).textContent=e.nc||"",t.insertCell(4).textContent=getFriendlyCodeName(e.cs)||"",t},this._init()}ChannelPlayer.prototype={initEvents:function(){return addEvent(this.audio,"playing",function(e){$(document).trigger("player:playing",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],currentTime:this.audio.currentTime,duration:this.audio.duration}])}.bind(this),!0),addEvent(this.audio,"loadedmetadata",function(e){$(document).trigger("player:loadedmetadata",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.audio.duration}])}.bind(this)),addEvent(this.audio,"pause",function(e){$(document).trigger("player:pause",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex]}])}.bind(this),!0),addEvent(this.audio,"seeked",function(e){$(document).trigger("player:seeked",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.duration||this.playlist[this.trackIndex].duration,currentTime:(this.playlist[this.trackIndex].timecode-this.playlist[0].timecode)/1e3+this.audio.currentTime}])}.bind(this),!0),addEvent(this.audio,"timeupdate",function(e){$(document).trigger("player:timeupdate",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.duration||this.playlist[this.trackIndex].duration,currentTime:(this.playlist[this.trackIndex].timecode-this.playlist[0].timecode)/1e3+this.audio.currentTime}])}.bind(this),!0),addEvent(this.audio,"ended",function(e){$(document).trigger("player:ended",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],currentTime:this.audio.currentTime}])}.bind(this),!0),this},init:function(){return $(document).trigger("player:init",[{audio:this.audio,path:this.path,playlist:this.playlist,trackIndex:this.trackIndex,duration:this.duration}]),this},playTrack:function(e,t){if(!this.playlist.length||e>this.playlist.length-1||e<0)return this;var n=this.playlist[e||this.trackIndex],o=this.path+n.file;void 0!==e&&(this.trackIndex=e),this.audio.src!==o&&(this.audio.src=o,$(document).trigger("player:trackchange",[{trackIndex:this.trackIndex,track:n,src:this.audio.src}])),void 0!==t&&(this.audio.currentTime=t),this.audio.play()},play:function(){return this.audio.paused?this.audio.play():this.audio.pause(),this},stop:function(){return this.audio.pause(),this.trackIndex=0,this.audio.currentTime=0,this},next:function(){var e=this.trackIndex+1;return this.audio.pause(),this.audio.currentTime=0,this.playTrack(e),$(document).trigger("player:next",[{trackIndex:this.trackIndex,track:this.playlist[e]}]),this},prev:function(){var e=this.trackIndex-1;return this.audio.pause(),this.audio.currentTime=0,this.playTrack(e),$(document).trigger("player:prev",[{trackIndex:this.trackIndex,track:this.playlist[e]}]),this}},window.onerror=function(e,t,n){console.error("Error message: "+e+"\nURL: "+t+"\nLine number: "+n)},init();var appStorage=new AppStorage("app-storage","localStorage");function AppStorage(o,e){if("localStorage"!==e&&"sessionStorage"!==e)return console.error('No such storage type. Choose either "localStorage" or "sessionStorage".');var a=window[e],r=a.getItem(o)?JSON.parse(a.getItem(o)):{};this.set=function(e,t,n){return r[e]=t,n||a.setItem(o,JSON.stringify(r)),this},this.get=function(e){return e?r[e]:r},this.remove=function(e){return e?delete r[e]:r={},this},this.setType=function(e){return window[e]&&(a=window[e]),this}}function load_storages(){var o,t,n,a=document.getElementById("modal-cont");function e(e){var t=extend({},e);t.maxsize&&(t.maxsize=convertBytes(t.maxsize,"Byte","GB")),ReactDOM.render(StorageComponent({frases:PbxObject.frases,data:t,onSubmit:r}),a)}function r(e,n){e.path&&(e.id||delete e.id,void 0!==e.maxsize&&(e.maxsize=convertBytes(e.maxsize,"GB","Byte")),e.state=parseInt(e.state,10),json_rpc_async("setFileStore",e,function(e,t){if(t)return n(t);notify_about("success",PbxObject.frases.SAVED),getStorages(function(e){o=e,getTotalStorage(function(e){PbxObject.options=e,s(),n&&n()})})}))}function i(){show_content(),void 0!==o&&null!=t&&(s(),TableSortable.sortables_init(),close_options(),set_page())}function s(){ReactDOM.render(UsageComponent({options:PbxObject.options,frases:PbxObject.frases,storageInfo:t,fileStorage:o,extensions:n,getTotalStorage:getTotalStorage,utils:{convertBytes:convertBytes,formatDateString:formatDateString,getFriendlyStorageState:getFriendlyStorageState},openStorageSettings:e}),document.getElementById("el-loaded-content"))}a||((a=document.createElement("div")).id="modal-cont",document.body.appendChild(a)),1!==PbxObject.options.mode&&PbxObject.options.prefix?o=null:getStorages(function(e){o=e,i()}),getStorageInfo(function(e){t=e,getExtensions(function(e){n=e,i()})})}function getStorages(t){json_rpc_async("getFileStore",null,function(e){t&&t(e)})}function getStorageInfo(t){json_rpc_async("getStoreInfo",null,function(e){sortByKey(e,"user"),t&&t(e)})}function getTotalStorage(t){json_rpc_async("getPbxOptions",null,function(e){t&&t(e)})}function setUserStoreLimit(e,t,n){json_rpc_async("setStoreLimit",{oid:e,limit:convertBytes(parseFloat(t),"GB","Byte")},function(e){n.value=convertBytes(e,"Byte","GB").toFixed(2)})}function getFriendlyStorageState(e){return PbxObject.frases.STORAGE.STATES[e]}function load_timer(e){PbxObject.oid=e.oid,PbxObject.name=e.name;new Date;var t,n=document.getElementById("enabled"),o=document.getElementById("objname");e.name&&(o.value=e.name),n&&(n.checked=e.enabled,addEvent(n,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(n.checked=!n.checked)})}));var a=document.getElementById("hh");for(t=0;t<24;t++){if(t<10)var r="0"+t;else r=t;(s=document.createElement("option")).value=r,s.innerHTML=r,a.appendChild(s),r==e.hour&&(a.selectedIndex=t)}var i=document.getElementById("mm");for(t=0;t<=55;t+=5){var s;if(t<10)r="0"+t;else r=t;(s=document.createElement("option")).value=r,s.innerHTML=r,i.appendChild(s),r==e.minute&&(i.selectedIndex=t/5)}for(t=0;t<e.weekdays.length;t++){var c=document.getElementById("t-d"+e.weekdays[t]);c.checked=!0,"LABEL"===c.parentNode.nodeName&&c.parentNode.classList.add("active")}fill_timer_targets("objects"),setTimezones(document.getElementById("timer_timezone"),e.timezone||PbxObject.options.timezone);var l=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t=0;t<e.targets.length;t++)l.appendChild(timer_target_row(e.targets[t].oid,e.targets[t].name,e.targets[t].action));show_content(),set_page(),document.getElementById("add-timer-target").onclick=function(){add_timer_target()},addEvent(document.getElementById("timer-range"),"click",check_days);var d=document.createElement("div");d.className="timer-dates-wrapper no-weekdays no-years",document.body.appendChild(d),flatpickr("#timer-dates",{locale:PbxObject.language||"en",mode:"multiple",dateFormat:"d.m",appendTo:d,minDate:new Date((new Date).getFullYear(),0,1),maxDate:new Date((new Date).getFullYear(),11,31),defaultDate:e.yeardays?e.yeardays.map(function(e){return moment().dayOfYear(e).format("YYYY-MM-DD")}):[],onChange:function(e,t){setTempParams({selectedDates:e})}})}function setTimezones(e,t){var n=moment.tz.names()||[],o=document.createDocumentFragment(),a=null;n.map(function(e){return(a=document.createElement("option")).value=e,(a.textContent=e)===t&&(a.selected=!0),o.appendChild(a),e}),e.appendChild(o)}function set_timer(){var t,e,n=document.getElementById("objname").value,o=document.getElementById("timer_timezone");if(!n)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;t='"name":"'+n+'",',show_loading_panel(),e=PbxObject.name?set_object_success:(PbxObject.name=n,null),null!=PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),t+='"kind":"timer",';var a=document.getElementById("enabled");null!=a&&(t+='"enabled":'+a.checked+",");var r,i=document.getElementById("hh"),s=document.getElementById("mm");for(t+='"hour":"'+i.options[i.selectedIndex].value+'",',t+='"minute":"'+s.options[s.selectedIndex].value+'",',(o.value||PbxObject.options.timezone)&&(t+='"timezone":"'+(o.value||PbxObject.options.timezone)+'",'),t+='"weekdays":[',r=0;r<7;r++)document.getElementById("t-d"+r).checked&&(t+=r+",");t+="],",PbxObject.currentObj&&PbxObject.currentObj.selectedDates&&(t+='"yeardays":[',PbxObject.currentObj.selectedDates.forEach(function(e){t+=moment(e).dayOfYear()+","}),t+="],");var c=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t+='"targets":[',r=0;r<c.children.length;r++){var l=c.children[r];null!=l.id&&""!=l.id&&(t+='{"oid":"'+c.children[r].id+'","action":"'+l.children[0].getAttribute("data-action")+'"},')}setObject(t+="]",e)}function timer_target_row(t,e,n){var o=document.createElement("tr"),a=document.createElement("td"),r=document.createElement("a"),i="Enable"==n?PbxObject.frases.ENABLE:PbxObject.frases.DISABLE;a.textContent=i,a.setAttribute("data-action",n),o.appendChild(a),a=document.createElement("td"),o.id=t,r.href="#",r.onclick=function(e){get_object_link(t),e.preventDefault()},r.innerHTML=e,a.appendChild(r),o.appendChild(a),(a=document.createElement("td")).className="text-center";var s=document.createElement("button");return s.className="btn btn-danger btn-link btn-sm",s.innerHTML='<i class="fa fa-trash"></i>',s.onclick=function(){remove_listener(t)},a.appendChild(s),o.appendChild(a),o}function add_timer_target(){var e=document.getElementById("targets").getElementsByTagName("tbody")[0],t=document.getElementById("objects"),n=document.getElementById("actions"),o=t.options[t.selectedIndex];e.appendChild(timer_target_row(o.value,o.innerHTML,n.value))}function remove_listener(e){var t,n=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t=0;t<n.children.length;t++)n.children[t].id==e&&n.removeChild(n.children[t])}function fill_timer_targets(e){var t,n,o,a,r,i=document.getElementById(e),s={};"object"==typeof PbxObject.objects?r=PbxObject.objects:(sortByKey(r=json_rpc("getObjects",'"kind":"all"'),"name"),PbxObject.objects=r);for(var c=0;c<r.length;c++)"equipment"!=(o=r[c].kind)&&"cli"!=o&&"timer"!=o&&"users"!=o&&(s[o]?t=s[o]:((t=document.createElement("optgroup")).setAttribute("label",PbxObject.frases.KINDS[o]),s[o]=t,i.appendChild(t)),a=r[c].oid,(n=document.createElement("option")).value=a,n.innerHTML=r[c].name,t.appendChild(n))}function check_days(e){var t,n=(e=e||window.event).target.getAttribute("data-filter");e.preventDefault();for(var o=0;o<7;o++)t=document.getElementById("t-d"+o),"timer-workdays"===n&&(5===o||6===o)||"timer-holidays"===n&&o<5?(t.checked&&(t.checked=!1),"LABEL"===t.parentNode.nodeName&&t.parentNode.classList.remove("active")):(t.checked=!0,"LABEL"===t.parentNode.nodeName&&t.parentNode.classList.add("active"))}function today(e){"use strict";var n=e?new Date(e):new Date,o={valueOf:function(){return n.valueOf()},dateOf:function(){return n},toStartOf:function(e){n="month"===e?new Date(n.setDate(1)):"year"===e?new Date(n.setMonth(0,1)):new Date(n.setHours(0,0,0,1));return o},toEndOf:function(e){"month"===e?o.toStartOf("month").plus(1,"month").minus(1):n="year"===e?new Date(n.setMonth(11,31)):new Date(n.setHours(23,59,59));return o},plus:function(e,t){t?t.match(/month|months/g)?n=new Date(n.setMonth(n.getMonth()+e)):t.match(/year|years/g)&&(n=new Date(n.setFullYear(n.getFullYear()+e))):n=new Date(n.setDate(n.getDate()+e));return o},minus:function(e,t){t?t.match(/month|months/g)?n=new Date(n.setMonth(n.getMonth()-e)):t.match(/year|years/g)&&(n=new Date(n.setFullYear(n.getFullYear()-e))):n=new Date(n.setDate(n.getDate()-e));return o}};return o}function MyTour(e,t){if(!e)return console.error("tour name is undefined");if(!t)return console.error("options is undefined");var n={},o={name:e,backdrop:!0,backdropContainer:"#pagecontent",storage:!1,template:["<div class='popover tour'>","<div class='arrow'></div>","<h3 class='popover-title'></h3>","<div class='popover-content'></div>","<div class='popover-navigation'>","<button class='btn btn-default' data-role='prev'><i class='fa fa-angle-left'></i></button>","<span data-role='separator'> </span>","<button class='btn btn-default' data-role='next'><i class='fa fa-angle-right'></i></button>","<button class='btn btn-link' data-role='end'>",PbxObject.frases.TOURS.END_TOUR,"</button>","</div>","</div>"].join(""),steps:[]};return t&&extend(o,t),(n=new Tour(o)).init(),n}function load_trunk(n){console.log("load_trunk result",n);n.type;var e=[].slice.call(document.querySelectorAll('[name="trunkType"]'));PbxObject.oid=n.oid,PbxObject.name=n.name;var t=document.getElementById("enabled"),o=document.getElementById("objname");if(n.name&&(o.value=n.name),t&&(t.checked=n.enabled,addEvent(t,"change",function(){setObjectState(n.oid,this.checked,function(e){e||(t.checked=!t.checked)})})),n.status){var a=document.getElementById("status");a&&(a.innerHTML=n.status)}if(void 0!==n.up&&changeTrunkRegState(n.up),n.protocol){var r,i="h323"==n.protocol?"h323":"sip",s=document.getElementById("protocols"),c=document.getElementById("get-proto-opts");n.name?((r=document.createElement("option")).value=n.protocol,r.textContent=n.protocol,s.appendChild(r)):(n.protocols.forEach(function(e){(r=document.createElement("option")).value=e,"sip"===(r.textContent=e)&&r.setAttribute("selected","selected"),s.appendChild(r)}),"sip"!==s.value&&(s.value=n.protocol),addEvent(s,"change",function(){switch_presentation(i="h323"==this.value?"h323":"sip")})),addEvent(c,"click",function(){getProtocolOptions(n.parameters)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={},switch_presentation(i)}e.forEach(function(e){if(e.value===n.type){var t=e.parentNode;e.checked,$(t).button("toggle")}else n.name&&e.parentNode.parentNode.removeChild(e.parentNode)}),n.domain&&(document.getElementById("domain").value=n.domain),document.getElementById("register").checked=n.register,document.getElementById("user").value=n.user||"",document.getElementById("pass").value=n.pass||"",document.getElementById("int-trunk-user").value=n.gateway?n.gateway.regname:n.user||"",document.getElementById("int-trunk-pass").value=n.gateway?n.gateway.regpass:n.pass||"",n.auth&&(document.getElementById("auth").value=n.auth);var l=document.getElementById("proxy");addEvent(l,"change",function(){for(var e=document.getElementsByName("proxy"),t=0;t<e.length;t++)e[t].disabled=!this.checked}),l.checked=n.proxy;for(var d=document.getElementsByName("proxy"),u=0;u<d.length;u++)d[u].disabled=!n.proxy;if(n.paddr&&(document.getElementById("paddr").value=n.paddr),n.pauth&&(document.getElementById("pauth").value=n.pauth),n.ppass&&(document.getElementById("ppass").value=n.ppass),null!=n.maxinbounds&&(document.getElementById("maxinbounds").value=isMaxNumber(n.maxinbounds)?16:n.maxinbounds,document.getElementById("inmode").checked=0<n.maxinbounds),null!=n.maxoutbounds&&(document.getElementById("maxoutbounds").value=isMaxNumber(n.maxoutbounds)?16:n.maxoutbounds,document.getElementById("outmode").checked=0<n.maxoutbounds),null!=n.parameters){var m=n.parameters.codecs;if(null!=m){var b;for(u=0;u<m.length&&(b=document.getElementById("c"+u));u++)b.value=m[u].codec,document.getElementById("f"+u).value=m[u].frame}else for(u=0;u<4;u++)document.getElementById("c"+u).selectedIndex=0,document.getElementById("f"+u).value=0;document.getElementById("regexpires")&&(document.getElementById("regexpires").value=n.parameters.regexpires||60)}var p=n.inboundanumbertransforms;if(p.length)for(u=0;u<p.length;u++)append_transform(null,"transforms1",p[u]);else append_transform(null,"transforms1");if((p=n.inboundbnumbertransforms).length)for(u=0;u<p.length;u++)append_transform(null,"transforms2",p[u]);else append_transform(null,"transforms2");if((p=n.outboundanumbertransforms).length)for(u=0;u<p.length;u++)append_transform(null,"transforms3",p[u]);else append_transform(null,"transforms3");if((p=n.outboundbnumbertransforms).length)for(u=0;u<p.length;u++)append_transform(null,"transforms4",p[u]);else append_transform(null,"transforms4");switch_presentation(n.type&&"undefined"!==n.type?n.type:"external",null,"pl-trunk-kind"),show_content(),set_page()}function getProtocolOptions(e){var t=document.getElementById("protocols"),n=[].slice.call(document.querySelectorAll('[name="trunkType"]')),o="";n.forEach(function(e){e.checked&&(o=e.value)}),get_protocol_opts(t.value,e,o)}function changeTrunkRegState(e){var t=document.getElementById("enabled");e?t.classList.remove("unregistered"):t.classList.add("unregistered")}function set_trunk(){var e,t,n,o,a,r,i,s,c=document.getElementById("objname").value,l=document.getElementById("enabled");if(!c)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;t='"name":"'+c+'",',show_loading_panel(),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),n=PbxObject.name?set_object_success:(PbxObject.name=c,null),[].slice.call(document.querySelectorAll('[name="trunkType"]')).forEach(function(e){e.checked?o=e.value:e.parentNode.parentNode.removeChild(e.parentNode)}),t+='"kind":"trunk",',t+='"enabled":'+l.checked+",";var d=document.getElementById("protocols").value,u=document.getElementById("register").checked,m=document.getElementById("proxy").checked;t+='"protocol":"'+d+'",',t+='"type":"'+o+'",',"external"===o?(t+='"domain":"'+document.getElementById("domain").value+'",',t+='"register":'+u+",",u&&(t+='"user":"'+document.getElementById("user").value+'",',t+='"auth":"'+document.getElementById("auth").value+'",',t+='"pass":"'+document.getElementById("pass").value+'",'),t+='"proxy":'+m+",",m&&(t+='"paddr":"'+document.getElementById("paddr").value+'",',t+='"pauth":"'+document.getElementById("pauth").value+'",',t+='"ppass":"'+document.getElementById("ppass").value+'",')):(t+='"user":"'+document.getElementById("int-trunk-user").value+'",',t+='"pass":"'+document.getElementById("int-trunk-pass").value+'",'),document.getElementById("inmode").checked?t+='"maxinbounds":'+document.getElementById("maxinbounds").value+",":t+='"maxinbounds":0,',document.getElementById("outmode").checked?t+='"maxoutbounds":'+document.getElementById("maxoutbounds").value+",":t+='"maxoutbounds":0,',t+='"parameters":{',u&&(t+='"regexpires":'+document.getElementById("regexpires").value+","),t+=e=(e=JSON.stringify(PbxObject.protocolOpts)).substr(1,e.length-2),a=transformsToArray("transforms1"),r=transformsToArray("transforms2"),i=transformsToArray("transforms3"),s=transformsToArray("transforms4"),t+="},",t+='"inboundanumbertransforms":',t+=JSON.stringify(a),t+=', "inboundbnumbertransforms":',t+=JSON.stringify(r),t+=', "outboundanumbertransforms":',t+=JSON.stringify(i),t+=', "outboundbnumbertransforms":',setObject(t+=JSON.stringify(s),function(e){e?n&&n():l.checked&&(l.checked=!1)})}function load_users(e){PbxObject.frases;var t,a=e,o=null,r=(t=PbxObject.frases.USERS_GROUP.DEFAULT_NAME+" ",t+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1),n=document.getElementById("modal-cont"),i=PbxObject.options.services?PbxObject.options.services.filter(function(e){return e.state}):[],s=window.sessionStorage.serviceParams;function c(e){a.name=e}function l(){(n=document.getElementById("modal-cont"))&&n.parentNode.removeChild(n),(n=document.createElement("div")).id="modal-cont",document.body.appendChild(n),function(){var e=PbxObject.options,t=e.storelimit/e.maxusers;a.storelimit=t,ReactDOM.render(NewUsersModalComponent({frases:PbxObject.frases,params:a,onSubmit:d,generatePassword:generatePassword,convertBytes:convertBytes,groupid:PbxObject.name?PbxObject.oid:null}),n)}()}function d(e,n){var o=extend({},e);if(!PbxObject.name)return g({name:a.name,profile:a.profile,members:[]},function(){d(o,n)});o.kind="users"===a.kind?"user":"phone",o.groupid=a.oid,setObject(o,function(e,t){if(t)return n(t),notify_about("error",t.message);o.oid=e,o.reg="",o.state=0,a.available=a.available.filter(function(e){return e!==o.number}),a.members.push(o),v(a),n&&n(null,e)})}function u(e){"MicrosoftAD"===e.id?(PbxObject.LdapConnection=Ldap({domains:e.props.directoryDomains.split(" "),available:a.available,onaddusers:m,members:a.members}),PbxObject.LdapConnection.auth()):b(e)}function m(e){if(PbxObject.name){var t=PbxObject.LdapConnection;t.setUsers({groupid:PbxObject.oid,username:t.options.username,password:t.options.password,domain:t.options.domain,users:e},function(e){t.close()})}else set_bgroup(e,m)}function b(e){PbxObject.LdapConnection=Ldap({service_id:e.id,service_type:e.type,available:a.available,onaddusers:p,members:a.members}),PbxObject.LdapConnection.getExternalUsers()}function p(e){if(PbxObject.name){show_loading_panel();var t=PbxObject.LdapConnection;t.setExternalUsers({groupid:PbxObject.oid,service_id:t.options.service_id,users:e},function(e){t.close(),"OK"===e&&set_object_success()})}else set_bgroup(e,p)}function f(e){var t=e.oid,n=PbxObject.frases.DODELETE+" "+e.name+"?";confirm(n)&&json_rpc_async("deleteObject",{oid:t},function(){a.members=a.members.filter(function(e){return e.oid!==t}),a.available=a.available.concat([e.ext]).sort(),v(a)})}function g(e,t){PbxObject.name&&(o=set_object_success);var n=e.name||r;setObject({kind:PbxObject.kind,oid:a.oid,name:n,profile:e.profile,members:e.members.length?e.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(e){PbxObject.name=a.name=n,o&&o(),t&&t(e)})}function h(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function v(e){var t={frases:PbxObject.frases,params:e,setObject:PbxObject.isUserAccount?checkPermissions("users",PbxObject.name?3:7)?g:null:g,onAddMembers:l,onNameChange:c,getExtension:getExtension,activeServices:i,onImportUsers:PbxObject.isUserAccount?checkPermissions("users",PbxObject.name?3:7)?u:null:u,deleteMember:PbxObject.isUserAccount?checkPermissions("users",15)?f:null:f};!e.name||PbxObject.isUserAccount&&!checkPermissions("users",15)||(t.removeObject=h),ReactDOM.render(UsersGroupComponent(t),document.getElementById("el-loaded-content")),s&&s.id&&1===getQueryParams().success&&b(s)}PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer.trim().length&&i.unshift({id:"MicrosoftAD",name:"Microsoft Active Directory",props:PbxObject.options.ldap,state:!0,types:1}),n||((n=document.createElement("div")).id="modal-cont",document.body.appendChild(n)),a.available.sort(),PbxObject.oid=e.oid,PbxObject.name=e.name,v(a),show_content(),set_page()}var Utils={validateElement:function(e,t){var n=!!e.value;return n?t?t.classList.remove("has-error"):e.classList.remove("has-error"):(t?t.classList.add("has-error"):e.classList.add("has-error"),n=!1),n},validateEmail:function(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)},each:function(e,o,a){e.forEach(function(e,t,n){o(function(e){if(e)return a(e);t===n.length-1&&a()},e)})},interpolate:function(e,a){return e.replace(/{{(\w*)}}/g,function(e,t,n,o){if(a[t])return a[t]})},htmlDecode:function(e){return e.replace(/(&lt;)(&gt;)/,"<",">")},debug:function(){window.localStorage.getItem("swc.debug")&&[].forEach.call(arguments,function(e){window.console.log(e)})}};