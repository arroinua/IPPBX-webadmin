function load_application(e){if(PbxObject.oid=e.oid,PbxObject.name=e.name,e.name&&(document.getElementById("objname").value=e.name),enabled&&(enabled.checked=e.enabled,e.name&&addEvent(enabled,"change",function(){json_rpc_async("setObjectState",'"oid":"'+e.oid+'", "enabled":'+this.checked,null)})),e.debug&&(document.getElementById("debug").checked=e.debug),e.dbconnection){var t=e.dbconnection;"sun.jdbc.odbc.JdbcOdbcDriver"==t.driver?(document.getElementById("odbc").checked=!0,t.url&&(document.getElementById("odbcurl").value=t.url)):t.driver&&(document.getElementById("jdbc").checked=!0,document.getElementById("jdbcdriver").value=t.driver,t.url&&(document.getElementById("jdbcurl").value=t.url)),t.schema&&(document.getElementById("dbowner").value=t.schema),t.username&&(document.getElementById("dbuser").value=t.username),t.password&&(document.getElementById("dbpass").value=t.password)}var n=e.parameters;if(n.length)for(var a=0;a<n.length;a++)add_app_row(n[a]);else add_app_row();show_content(),set_page()}function set_application(){show_loading_panel();var e=document.getElementById("appvariables").getElementsByTagName("tbody")[0],t='"name":"'+document.getElementById("objname").value+'",';t+='"enabled":'+document.getElementById("enabled").checked+",",PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),t+='"parameters":[';var n,a;for(n=0;n<e.children.length;n++){var o=e.children[n],r=o.getElementsByTagName("input"),l="";for(a=0;a<r.length;a++)if("variable"==r[a].name)l+='"key":"'+r[a].value+'",';else{if("value"!=r[a].name)continue;l+='"value":"'+r[a].value+'",'}""!=l&&(t+="{"+l+"},")}t+="],",t+='"debug":'+document.getElementById("debug").checked+",",t+='"dbconnection":{';var i,s;document.getElementById("odbc").checked?(i="sun.jdbc.odbc.JdbcOdbcDriver",s=document.getElementById("odbcurl").value):(i=document.getElementById("jdbcdriver").value,s=document.getElementById("jdbcurl").value),t+='"driver":"'+i+'",',t+='"url":"'+s+'",',document.getElementById("dbowner")&&(t+='"schema":"'+document.getElementById("dbowner").value+'",'),document.getElementById("dbuser")&&(t+='"username":"'+document.getElementById("dbuser").value+'",'),document.getElementById("dbpass")&&(t+='"password":"'+document.getElementById("dbpass").value+'",'),t+="},",json_rpc_async("setObject",t,set_object_success)}function add_app_row(e){var t=document.getElementById("appvariables").getElementsByTagName("tbody")[0],n=document.createElement("tr"),a=document.createElement("td"),o=document.createElement("div");o.className="form-group";var r=document.createElement("input");r.className="form-control",r.setAttribute("type","text"),r.setAttribute("name","variable"),r.setAttribute("disabled","disabled"),e&&e.key&&(r.value=e.key),o.appendChild(r),a.appendChild(o),n.appendChild(a),t.appendChild(n),a=document.createElement("td"),o=document.createElement("div"),o.className="form-group",r=document.createElement("input"),r.className="form-control",r.setAttribute("name","value"),e&&e.value&&(r.value=e.value),o.appendChild(r),a.appendChild(o),n.appendChild(a),t.appendChild(n),t.appendChild(n)}function load_attendant(e){PbxObject.oid=e?e.oid:"",PbxObject.name=e?e.name:"",e&&e.name&&(document.getElementById("objname").value=e.name),document.getElementById("enabled").checked=e.enabled,e.debug&&(document.getElementById("debug").checked=e.debug),show_content(),set_page(),setInitAttParams(),makeActiveCanvas(),getAttTemplate("attendant_object",function(t){setAttSettings(e.parameters,t)});var t=document.getElementById("addConnector");t.onclick=function(){addConnector()},json_rpc_async("getExtensions",null,function(e){var t=e.filter(function(e){return"trunk"!==e.kind&&"cli"!==e.kind&&"timer"!==e.kind&&"routes"!==e.kind&&"pickup"!==e.kind});PbxObject.attendant.routes=t})}function setInitAttParams(){PbxObject.attendant={currentPid:"",routes:[],connectors:[],objects:{},buttons:["1","2","3","4","5","6","7","8","9","0","#","*"],availableButtons:[],types:{menu:"menu",commutator:"commutator",mail:"mail"}}}function changeAvailableButtons(e,t){var n,a=t||document.querySelector(".att-canvas.active"),o=[];"object"==typeof e?o=[].concat(e):(o=JSON.parse(a.getAttribute("data-available-buttons")),btnIndex=o.indexOf(e),-1!==btnIndex?o.splice(btnIndex,1):o.splice(btnIndex,0,e)),PbxObject.attendant.availableButtons=PbxObject.attendant.buttons.map(function(e){return n={},n.button=e,n.disabled=-1===o.indexOf(e)?!0:!1,n}),a.setAttribute("data-available-buttons",JSON.stringify(o))}function createCanvas(e){var t=document.getElementById("att-container"),n=document.createElement("div");n.className="att-canvas active",void 0!==e&&n.setAttribute("data-parent",e),t.appendChild(n),createInitButton(n),changeAvailableButtons(PbxObject.attendant.buttons),addAttObjects(PbxObject.attendant.objects,e)}function makeActiveCanvas(e){void 0!==e&&(PbxObject.attendant.currentPid=e);var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),a=document.getElementById("toPrevCanvas"),o=!1;n.forEach(function(n){t=n.getAttribute("data-parent"),t===e||!e&&!t?(n.classList.add("active"),o=n):n.classList.remove("active")}),o?changeAvailableButtons(JSON.parse(o.getAttribute("data-available-buttons"))):createCanvas(e),setSchemaActiveEl(e||""),a&&(e&&"hidden"===a.className?a.className="":e||(a.className="hidden")),toTheTop("att-container")}function removeCanvases(e){var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),a=new RegExp(e+"d*");n.forEach(function(e){t=e.getAttribute("data-parent"),a.test(t)&&e.parentNode.removeChild(e)})}function toPrevCanvas(e){e&&e.preventDefault();var t=document.querySelector(".att-canvas.active"),n=t.getAttribute("data-parent"),a=n.substr(0,n.length-1);makeActiveCanvas(a)}function createInitButton(e){var t=document.createElement("div"),n=e||document.querySelector(".att-canvas.active");t.className="dropdown att-init-button",t.innerHTML='<button class="btn btn-default dropdown-toggle dropdown-round" type="button" id="att-obj-types" data-toggle="dropdown" aria-expanded="true"><i class="fa fa-plus"></i></button><ul class="dropdown-menu" role="menu" aria-labelledby="att-obj-types"><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.menu+'"><i class="fa fa-music"></i> '+PbxObject.frases.ATTENDANT.MENU+'</a></li><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.mail+'"><i class="fa fa-envelope"></i>  '+PbxObject.frases.ATTENDANT.MAIL+"</a></li>"+(PbxObject.attendant.currentPid?'<li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.commutator+'"><i class="fa fa-phone"></i>  '+PbxObject.frases.ATTENDANT.COMMUTATOR+"</a></li>":"")+"</ul>",addEvent(t,"click",function(e){e&&e.preventDefault();var t=e.currentTarget,n=e.target;t.className="top"===elPosition(t)?"dropup att-init-button":"dropdown att-init-button","A"!==n.nodeName&&(n=n.parentNode);var a=n.getAttribute("data-type");a&&showAttObjectSetts({type:a})}),n.appendChild(t)}function setInitAttMoveBtns(e){var t=PbxObject.attendant.buttons,n=document.getElementById("moveBack"),a=document.getElementById("moveMmenu");fillBtnsSelectList(t,n,e.moveBack),fillBtnsSelectList(t,a,e.moveMmenu)}function fillBtnsSelectList(e,t,n){var a,o=document.createDocumentFragment();e.forEach(function(e){a=document.createElement("option"),a.value=e,a.innerHTML=e,e===n&&a.setAttribute("selected","selected"),o.appendChild(a)}),t.appendChild(o)}function setAttSettings(e){var t,n=document.getElementById("attvariables"),a="",o="",r="",l={};e&&n&&setFormData(n,e),e.forEach(function(e){"jsonString"===e.key?(t=JSON.parse(e.value),PbxObject.attendant.objects=t):"connectors"===e.key?addConnectors(JSON.parse(e.value)):"greetings"===e.key?a=e.value:"connectionFailed"===e.key?o=e.value:"leaveMessage"===e.key?r=e.value:"moveBack"===e.key?l.moveBack=e.value:"moveMmenu"===e.key&&(l.moveMmenu=e.value)}),e.length||(l.moveBack="#",l.moveMmenu="*"),customize_upload("attGreetings",a),customize_upload("connectionFailed",o),customize_upload("leaveMessage",r),setInitAttMoveBtns(l),addAttObjects(t,""),buildSchema(t)}function buildSchema(e){var t,n,a=document.getElementById("att-schema"),o=[];addToSchema("home",{name:'<i class="fa fa-home"></i>',type:PbxObject.attendant.types.menu},a);for(key in e)e.hasOwnProperty(key)&&o.push(e[key]);sortByKey(o,"oid"),o.forEach(function(e){t=e.oid.substr(0,e.oid.length-1),n=a.querySelector("0"===e.oid?'ul[data-oid="home"]':'ul[data-oid="'+t+'"]'),addToSchema(e.oid,e,n)}),addEvent(a,"click",setAttPosition)}function addToSchema(e,t,n){var a,o,r=e.substr(0,e.length-1);o=n?n:document.querySelector("0"!==e?'#att-schema ul[data-oid="'+r+'"]':'#att-schema ul[data-oid="home"]'),a=createSchemaBranch(e,t),o.appendChild(a)}function createSchemaBranch(e,t){var n=document.createElement("li");return n.setAttribute("data-oid",e),t.type===PbxObject.attendant.types.menu?("home"===e&&(n.className="active"),n.innerHTML='<label class="fa fa-minus" for="t-'+e+'"></label><input type="checkbox" name="tree-node" id="t-'+e+'"/> <a href="#'+("home"===e?"":e)+'">'+t.name+(t.button?'<small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>":"")+'</a><ul data-oid="'+e+'"></ul>'):(n.innerHTML=t.name,t.button&&(n.innerHTML+=' <small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>")),n}function rebuildSchema(){var e=document.getElementById("att-schema");e.children[0]&&e.removeChild(e.children[0]),buildSchema(PbxObject.attendant.objects),setSchemaActiveEl(PbxObject.attendant.currentPid)}function removeFromSchema(e){var t=document.querySelector('#att-schema li[data-oid="'+e+'"]');t.parentNode.removeChild(t)}function setSchemaActiveEl(e){var t=document.getElementById("att-schema"),n=t.querySelector('li a[href="#'+e+'"]'),a=t.querySelector("li.active");n&&(a&&(a.className=""),n.parentNode.className="active")}function addAttObjects(e,t){if(e)for(key in e)e.hasOwnProperty(key)&&key.substr(0,key.length-1)==t&&addAttObject(e[key])}function addAttObject(e,t){var n,a=new AttObject(e),o=document.querySelector(".att-canvas.active"),r=PbxObject.attendant.currentPid+(e.button?e.button:0);if(e.button)changeAvailableButtons(e.button,o);else{var l=o.querySelector(".att-init-button");l&&isMainEl()&&l.parentNode.removeChild(l)}t?(o.insertBefore(a,t.element),t.removeElement(null,t.params),t.params.button!==e.button&&(n=PbxObject.attendant.currentPid+t.params.button,changeObjectsParent(n,r))):o.insertBefore(a,o.lastChild),e.oid=r,PbxObject.attendant.objects[r]!==e&&(PbxObject.attendant.objects[r]=e,t?rebuildSchema():addToSchema(r,e))}function AttObject(e){var t=formAttParams(e),n=PbxObject.templates.attendant_object,a=Mustache.render(n,t),o=document.createElement("div"),r=PbxObject.attendant.currentPid+(e.button?e.button:0);o.className="att-obj-wrapper",o.innerHTML=a;var l=o.querySelector("#enter-att-menu"),i=o.querySelector("#edit-att-object"),s=o.querySelector("#remove-att-object");return removeTreeBtn=o.querySelector("#remove-att-tree"),l&&addEvent(l,"click",function(t){this.enterAttMenu(t,e)}.bind(this)),i&&addEvent(i,"click",function(t){this.editObject(t,e)}.bind(this)),s&&addEvent(s,"click",function(t){this.removeElement(t,e)}.bind(this)),removeTreeBtn&&addEvent(removeTreeBtn,"click",function(t){this.removeElement(t,e,!0)}.bind(this)),this.oid=r,this.params=e,this.element=o,o}function removeObject(e,t){var n=PbxObject.attendant.objects,a=(document.getElementById("objname").value,new RegExp(t?e+"d*":"^"+e+"$"));for(var o in n)n.hasOwnProperty(o)&&a.test(o)&&delete n[o];removeCanvases(e)}function changeObjectsParent(e,t){var n=PbxObject.attendant.objects,a=new RegExp(e+"d*"),o="";for(var r in n)n.hasOwnProperty(r)&&a.test(r)&&(o=r.replace(e,t),n[o]=n[r],n[o].oid=o,delete n[r])}function checkParams(e){var t="";return e.button||isMainEl()||(t+=PbxObject.frases.ATT__BTN_MISSED+"\n"),e.type===PbxObject.attendant.types.menu||e.connector||(t+=PbxObject.frases.ATT__CONN_MISSED+"\n"),""!==t?(alert(t),!1):!0}function showAttObjectSetts(e,t){var n=formAttParams(e);getAttTemplate("attendant_modal",function(a){var o=Mustache.render(a,n);r||(r=document.createElement("div"),r.id="att-setts-cont",$("#pagecontainer").prepend(r)),$(r).html(o);var r=document.getElementById("att-setts-cont"),l=document.querySelector('#ext-general select[name="data"]'),i=document.querySelector('#ext-general select[name="button"]');l&&e.connector&&(l.value=e.connector),i&&e.button&&(i.value=e.button),e.type===PbxObject.attendant.types.menu&&customize_upload("audioFile",e.data||""),$("#set-att-object").one("click",function(){setAttObject(e,t)}),$(document).one("keypress",function(n){(10==n.keyCode||13==n.keyCode)&&setAttObject(e,t)}),$("#att-setts-modal .select2").select2(),$("#att-setts-modal").modal()})}function setAttObject(e,t){var n=collectAttParams(e);checkParams(n)&&(t?addAttObject(n,t):addAttObject(n),$("#att-setts-modal").modal("hide"))}function collectAttParams(e){var t=document.getElementById("att-setts-cont"),n=e.type,a=n===PbxObject.attendant.types.menu?"input":"select",o={};if(o.button=isMainEl()?null:t.querySelector('select[name="button"]').value,o.name=generateAttObjName(n,o.button,t.querySelector('input[name="name"]').value||null),o.type=n,n===PbxObject.attendant.types.menu){var r=t.querySelector('input[type="file"]'),l=t.querySelector(a+'[name="digits"]');r&&(r.files.length?(o.file=r,o.data=r.files[0].name):e.file&&(o.file=e.file)),!o.data&&e.file&&(o.data=e.file.files[0].name),o.digits=l.checked?"14":"1"}else{o.data=t.querySelector(a+'[name="data"]').value;var i=t.querySelector(a+'[name="data"]').value;o.connector=i}if(n===PbxObject.attendant.types.mail){var s=t.querySelector('input[name="subject"]'),d=t.querySelector('textarea[name="body"]');o.subject=s.value,o.body=d.value}return o}function formAttParams(e){var t={data:e,pid:PbxObject.attendant.currentPid,buttons:PbxObject.attendant.availableButtons,frases:PbxObject.frases,typeMenu:function(){return this.data.type==PbxObject.attendant.types.menu},typeCommutator:function(){return this.data.type==PbxObject.attendant.types.commutator},typeEmail:function(){return this.data.type==PbxObject.attendant.types.mail},allowMultipleDigits:function(){return"14"===this.data.digits?!0:!1},objType:function(){return this.frases.ATTENDANT[this.data.type.toUpperCase()]}};return t.connectors=e.type===PbxObject.attendant.types.commutator?PbxObject.attendant.connectors.concat(PbxObject.attendant.routes):PbxObject.attendant.connectors,sortByKey(t.connectors,"ext"),t}function generateAttObjName(e,t,n){if(t||null===t){var a,o;return PbxObject.attendant.currentPid||n?(a=n||PbxObject.frases.ATTENDANT[e.toUpperCase()],o=a):o=PbxObject.frases.ATTENDANT.MAIN_MENU,o}}function generateAttObjPath(e){return e.replace("0","").split("").reduce(function(e,t){return e+"."+t})}function setAttPosition(e){var e=e||window.event;if(e){var t=e.target;if("LABEL"===t.nodeName&&(t.className="fa fa-plus"===t.className?"fa fa-minus":"fa fa-plus"),"A"!==t.nodeName&&(t=t.parentNode),"A"===t.nodeName){e.preventDefault();{var n=t.href.substr(t.href.indexOf("#")+1);t.hash}makeActiveCanvas(n)}}}function addConnectors(e){var t=document.getElementById("attconnectors").querySelector("tbody");e.forEach(function(e){t.appendChild(createConnectorRow(e)),PbxObject.attendant.connectors.push(e)})}function addConnector(e){var e=e||window.event;e&&"click"==e.type&&e.preventDefault();var t=document.getElementById("attconnectors"),n=t.querySelector("tbody"),a=t.querySelector('input[name="connName"]'),o=t.querySelector('input[name="connVal"]'),r={name:a.value,ext:o.value},l=PbxObject.attendant.connectors;n.appendChild(createConnectorRow(r)),a.value="",o.value="",l.push(r)}function getConnectorNumber(e){var t;return PbxObject.attendant.connectors.forEach(function(n){n.name===e&&(t=n.ext)}),t?t:void console.error("Connector not found!")}function removeConnector(e){var t=PbxObject.attendant.connectors;t.forEach(function(n,a){n.name===e.name&&t.splice(a,1)})}function createConnectorRow(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,a,o=document.createElement("tr");return n=o.insertCell(0),e&&e.name&&(n.textContent=e.name),n=o.insertCell(1),e&&e.ext&&(n.textContent=e.ext),n=o.insertCell(2),a=document.createElement("a"),a.href="#",a.className="remove-clr",a.innerHTML='<i class="fa fa-close"></i>',addEvent(a,"click",function(t){remove_row(t),removeConnector(e)}),n.appendChild(a),o}function getAttTemplate(e,t){PbxObject.templates=PbxObject.templates||{};var n=PbxObject.templates[e];n?t(n):$.get("/badmin/views/"+e+".html",function(n){PbxObject.templates[e]=n,t(n)})}function filterByPattern(e,t){if(t){var n=new RegExp(t),a=e.filter(function(e){return n.test(e.ext)});return a}return e}function isMainEl(){return PbxObject.attendant.currentPid?!1:!0}function set_attendant(){var e,t=document.getElementById("objname").value,n=(document.querySelector(".att-container"),PbxObject.attendant.objects),a=retrieveFormData(document.getElementById("attvariables")),o=document.getElementById("attGreetings"),r=document.getElementById("connectionFailed"),l=document.getElementById("leaveMessage"),i=PbxObject.options.prefix,s="users"+(i?"/"+i:"")+"/attendant/"+t+"/";if(o.files[0]&&upload(o,"/attendant/"+t+"/"+o.files[0].name),r.files[0]&&upload(r,"/attendant/"+t+"/"+r.files[0].name),l.files[0]&&upload(l,"/attendant/"+t+"/"+l.files[0].name),!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',PbxObject.oid&&(e+='"oid":"'+PbxObject.oid+'",'),e+='"kind":"attendant",';var d=document.getElementById("enabled");null!=d&&(e+='"enabled":'+d.checked+","),e+='"debug":'+document.getElementById("debug").checked+",",e+='"parameters":[',e+="{",e+='"key":"algdir",',e+='"value":"'+s+'"',e+="},";var c;for(var u in n)n.hasOwnProperty(u)&&(c=n[u].file,c&&(c.files.length&&upload(c,"/attendant/"+t+"/"+c.files[0].name),delete n[u].file));e+="{",e+='"key":"jsonString",',e+='"value":'+JSON.stringify(n),e+="},",e+="{",e+='"key":"connectors",',e+='"value":'+JSON.stringify(PbxObject.attendant.connectors),e+="},";for(var u in a)a.hasOwnProperty(u)&&(e+="{",e+='"key":"'+u+'",',e+='"value":"'+a[u]+'"',e+="},");e+="],",json_rpc_async("setObject",e,set_object_success)}function load_bgroup(e){switch_presentation(e.kind);var t,n=document,a=e.kind,o=e.members,r=n.getElementById("dcontainer"),l=(n.getElementById("options"),document.getElementById("enabled"));if(PbxObject.oid=e.oid,PbxObject.name=e.name,e.name&&(n.getElementById("objname").value=e.name),l&&(l.checked=e.enabled,e.name&&addEvent(l,"change",function(){json_rpc_async("setObjectState",'"oid":"'+e.oid+'", "enabled":'+this.checked,null)})),"users"==a||"equipment"==a){var i=document.getElementById("group-extensions").querySelector("tbody"),s=document.getElementById("available-users"),d=document.getElementById("group-protocol"),c=document.getElementById("get-proto-opts"),u=(document.getElementById("new-user-form"),document.getElementById("clear-input"),document.getElementById("add-user")),m="users"===a?"user":"phone";if("equipment"==a){var p=e.options.protocols||e.options.protocol;if("object"==typeof p)p.forEach(function(e){d.innerHTML+='<option value="'+e+'">'+e+"</option>"});else{var b=d.parentNode,g=document.createElement("span");g.className="form-control-static",g.textContent=p,b.insertBefore(g,d),b.removeChild(d)}addEvent(c,"click",function(){get_protocol_opts(e.options.protocol||d.value,e.options)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={}}if(e.available&&e.available.length){var f=document.createDocumentFragment();e.available.sort().forEach(function(e){var t=document.createElement("option");t.value=e,t.textContent=e,f.appendChild(t)}),s.appendChild(f)}else u.setAttribute("disabled","disabled");addEvent(u,"click",function(){addUser(m)});sortByKey(o,"number"),o.forEach(function(e){i.appendChild(addMembersRow(e))}),PbxObject.members=o||[]}else e.available&&fill_list_items("available",e.available),o&&fill_list_items("members",o);if(e.options)if("equipment"==a){var h=document.getElementById("devtype"),v=e.options.kind||"ipphones";h.value=v,switch_options_tab("tab-"+v),h.onchange=function(){switch_options_tab("tab-"+this.options[this.selectedIndex].value)},"gateway"==e.options.kind?(n.getElementById("regname").value=e.options.gateway.regname||"",n.getElementById("regpass").value=e.options.gateway.regpass||""):"trunk"==e.options.kind&&(document.getElementById("address").value=e.options.trunk.domain||""),n.getElementById("phonelines").value=e.options.phonelines||"2",void 0!=e.options.starflash&&(n.getElementById("starflash").checked=e.options.starflash)}else if("unit"==a){if(n.getElementById("groupno1").value=e.options.groupno||"",n.getElementById("timeout1").value=e.options.timeout||"",void 0!==e.options.huntmode){var y=n.getElementById("huntmode1");y.selectedIndex=e.options.huntmode,addEvent(y,"change",function(){checkHuntMode()}),checkHuntMode()}void 0!==e.options.huntfwd&&(n.getElementById("huntfwd1").checked=e.options.huntfwd)}else if("hunting"==a)void 0!==e.options.timeout&&(n.getElementById("timeout2").value=e.options.timeout),void 0!==e.options.huntmode&&(n.getElementById("huntmode2").value=e.options.huntmode),void 0!==e.options.huntfwd&&(n.getElementById("huntfwd2").checked=e.options.huntfwd);else if("pickup"==a)n.getElementById("groupno2").value=e.options.groupno||"";else if("icd"==a){n.getElementById("groupno").value=e.options.groupno||"",n.getElementById("maxlines").value=e.options.maxlines||"",n.getElementById("priority").value=e.options.priority||"",n.getElementById("canpickup").checked=e.options.canpickup,n.getElementById("autologin").checked=e.options.autologin,n.getElementById("method").selectedIndex=e.options.method,n.getElementById("natimeout").value=e.options.natimeout||"",n.getElementById("resumetime").value=e.options.resumetime||"",n.getElementById("queuelen").value=e.options.queuelen||"",n.getElementById("maxqwait").value=e.options.maxqwait||"",n.getElementById("overflowredirect").value=e.options.overflowredirect||"",n.getElementById("overtimeredirect").value=e.options.overtimeredirect||"",n.getElementById("indicationmode").value=e.options.indicationmode||"",n.getElementById("indicationtime").value=e.options.indicationtime||"";var E=e.options.greeting||"";customize_upload("greeting",E)}else if("conference"==a||"channel"==a||"selector"==a){var x=["OFF","320x240","352x288","640x360","640x480","704x576","1024x768","1280x720","1920x1080"],I=document.getElementById("initmode");I&&(I.onchange=function(){document.getElementById("conf-greetfile").style.display=2==I.options[I.selectedIndex].value?"block":"none"}),PbxObject.videomax=e.options.maxvideomode;var B=e.options.onholdfile||"";customize_upload("onhold2",B);var C=e.options.greetingfile||"";if(customize_upload("greeting2",C),"channel"==a){var _,w=[].slice.call(r.querySelectorAll('input[name="objectType"]')),k=document.getElementById("out-number"),j=document.getElementById("channel-type-sel"),O=document.getElementById("video");w.forEach(function(t){if(e.external){if("global"==t.value){var n=t.parentNode;t.checked=!0,$(n).button("toggle"),_=t.value}k.value=e.external}else if("local"==t.value){var n=t.parentNode;t.checked=!0,$(n).button("toggle"),_=t.value}j.onclick=function(e){var e=e||window.event,t=e.target;"LABEL"===t.nodeName&&(_=t.children[0].value,changeGroupType(_))}}),O&&(O.checked="OFF"!==e.options.videomode?!0:!1),I&&(I.value=e.options.initmode);var P=e.options.musiconback||"";document.getElementById("playmusiconback").checked=P?!0:!1,customize_upload("musiconback",P),changeGroupType(_)}else if("selector"==a){var S=e.owner,T=document.getElementById("owner");I&&(I.value=e.options.initmode),document.getElementById("conf-greetfile").style.display=2==e.options.initmode?"block":"none",initcalls.checked=e.options.initcalls;var A=e.available.concat(e.members).sort();A.forEach(function(e){T.innerHTML+=S&&e==S?'<option value="'+e+'" selected>'+e+"</option>":'<option value="'+e+'">'+e+"</option>"})}n.getElementById("dialuptt").value=e.options.dialtimeout||"",n.getElementById("autoredial").checked=e.options.autoredial,"channel"!==a&&(n.getElementById("confrecord").checked=e.options.recording);var N=n.getElementById("playgreet");N.checked=e.options.greeting,N.checked&&(N.checked=e.options.greetingfile?!0:!1);var L=n.getElementById("videoform");if(L)for(t=0;t<x.length;t++){var M=n.createElement("option");if(M.value=x[t],M.innerHTML=x[t],L.appendChild(M),x[t]==e.options.videomode&&(L.selectedIndex=t),x[t]==e.options.maxvideomode)break}var D=document.getElementById("confrecord");D&&void 0!==e.options.recording&&(D.checked=e.options.recording)}if(void 0!=e.profile){n.getElementById("forwarding")&&(n.getElementById("forwarding").checked=e.profile.forwarding),n.getElementById("callpickup")&&(n.getElementById("callpickup").checked=e.profile.callpickup),n.getElementById("dndover")&&(n.getElementById("dndover").checked=e.profile.dndover),n.getElementById("busyover")&&(n.getElementById("busyover").checked=e.profile.busyover),n.getElementById("monitor")&&(n.getElementById("monitor").checked=e.profile.monitor),n.getElementById("dnd")&&(n.getElementById("dnd").checked=e.profile.dnd),n.getElementById("clir")&&(n.getElementById("clir").checked=e.profile.clir),n.getElementById("pickupdeny")&&(n.getElementById("pickupdeny").checked=e.profile.pickupdeny),n.getElementById("busyoverdeny")&&(n.getElementById("busyoverdeny").checked=e.profile.busyoverdeny),n.getElementById("monitordeny")&&(n.getElementById("monitordeny").checked=e.profile.monitordeny),n.getElementById("callwaiting")&&(n.getElementById("callwaiting").checked=e.profile.callwaiting),n.getElementById("outcallbarring")&&(n.getElementById("outcallbarring").checked=e.profile.outcallbarring),n.getElementById("costroutebarring")&&(n.getElementById("costroutebarring").checked=e.profile.costroutebarring),n.getElementById("recording")&&(n.getElementById("recording").checked=e.profile.recording),n.getElementById("hiderecind")&&(n.getElementById("hiderecind").checked=e.profile.hiderecindication),n.getElementById("voicemail")&&(n.getElementById("voicemail").checked=e.profile.voicemail);var q=e.profile.bnumbertransforms;if(0!=q.length)for(t=0;t<q.length;t++)append_transform(null,"transforms",q[t]);else append_transform(null,"transforms")}TableSortable.sortables_init(),show_content(),set_page(),$(".select2").select2()}function set_bgroup(e,t){var n,a,o,r=document,l=PbxObject.oid,i=PbxObject.kind,s=r.getElementById("members"),d=r.getElementById("profile"),c=r.getElementById("playgreet"),u=r.getElementById("objname").value,m=[].slice.call(document.querySelectorAll('input[name="objectType"]'));if(!u)return void alert(PbxObject.frases.MISSEDNAMEFIELD);if(n='"name":"'+u+'",',show_loading_panel(),PbxObject.name?a=set_object_success:(PbxObject.name=u,a=null),l&&(n+='"oid":"'+l+'",'),i&&(n+='"kind":"'+i+'",'),n+='"enabled":'+document.getElementById("enabled").checked+",","users"!=i&&"equipment"!=i){n+='"members":[';for(var p=0;p<s.children.length;p++)n+='"'+s.children[p].innerHTML+'",';n+="],"}if("users"==i||"equipment"==i){n+='"members":[';for(var p=0;p<PbxObject.members.length;p++)n+='"'+PbxObject.members[p].number+'",';n+="],"}if("channel"==i){if(m.forEach(function(e){e.checked&&(o=e.value)}),"global"==o){c.checked=!1;var b=document.getElementById("out-number");n+='"external":"'+b.value+'",'}}else if("selector"==i){var g=document.getElementById("owner").options[document.getElementById("owner").selectedIndex].value;n+='"owner":"'+g+'",'}else if(("users"==i||"unit"==i||"equipment"==i)&&d){n+='"profile":{',null!=r.getElementById("forwarding")&&(n+='"forwarding":'+r.getElementById("forwarding").checked+","),null!=r.getElementById("callpickup")&&(n+='"callpickup":'+r.getElementById("callpickup").checked+","),null!=r.getElementById("dndover")&&(n+='"dndover":'+r.getElementById("dndover").checked+","),null!=r.getElementById("busyover")&&(n+='"busyover":'+r.getElementById("busyover").checked+","),null!=r.getElementById("monitor")&&(n+='"monitor":'+r.getElementById("monitor").checked+","),null!=r.getElementById("dnd")&&"users"!==i&&(n+='"dnd":'+r.getElementById("dnd").checked+","),null!=r.getElementById("recording")&&(n+='"recording":'+r.getElementById("recording").checked+","),null!=r.getElementById("hiderecind")&&(n+='"hiderecindication":'+r.getElementById("hiderecind").checked+","),null!=r.getElementById("callwaiting")&&"users"!==i&&(n+='"callwaiting":'+r.getElementById("callwaiting").checked+","),null!=r.getElementById("pickupdeny")&&(n+='"pickupdeny":'+r.getElementById("pickupdeny").checked+","),null!=r.getElementById("monitordeny")&&(n+='"monitordeny":'+r.getElementById("monitordeny").checked+","),null!=r.getElementById("busyoverdeny")&&(n+='"busyoverdeny":'+r.getElementById("busyoverdeny").checked+","),null!=r.getElementById("voicemail")&&(n+='"voicemail":'+r.getElementById("voicemail").checked+","),null!=r.getElementById("outcallbarring")&&(n+='"outcallbarring":'+r.getElementById("outcallbarring").checked+","),null!=r.getElementById("costroutebarring")&&(n+='"costroutebarring":'+r.getElementById("costroutebarring").checked+",");var f=r.getElementById("transforms").getElementsByTagName("tbody")[0];f&&(n+='"bnumbertransforms":[',n+=encode_transforms("transforms"),n+="]"),n+="},"}if(n+='"options":{',"equipment"==i){var h=JSON.stringify(PbxObject.protocolOpts);h=h.substr(1,h.length-2);var v=document.getElementById("devtype"),y=v.options[v.selectedIndex].value,E=document.getElementById("group-protocol");E&&(n+='"protocol":"'+E.options[E.selectedIndex].value+'",'),"ipphones"==y?n+='"kind":"ipphones",':"gateway"==y?(n+='"kind":"gateway",',n+='"gateway":{',n+='"regname":"'+r.getElementById("regname").value+'",',n+='"regpass":"'+r.getElementById("regpass").value+'",',n+="},"):"trunk"==y&&(n+='"kind":"trunk",',n+='"trunk":{',n+='"domain":"'+document.getElementById("address").value+'",',n+="},"),r.getElementById("phonelines")&&(n+='"phonelines":'+r.getElementById("phonelines").value+","),r.getElementById("starflash")&&(n+='"starflash":'+r.getElementById("starflash").checked+","),n+=h}else if("unit"==i)n+='"groupno":"'+r.getElementById("groupno1").value+'",',n+='"timeout":'+r.getElementById("timeout1").value+",",n+='"huntmode":'+r.getElementById("huntmode1").value+",",n+='"huntfwd":'+r.getElementById("huntfwd1").checked+",";else if("hunting"==i)n+='"timeout":'+r.getElementById("timeout2").value+",",n+='"huntmode":'+r.getElementById("huntmode2").value+",",n+='"huntfwd":'+r.getElementById("huntfwd2").checked+",";else if("pickup"==i)n+='"groupno":"'+r.getElementById("groupno2").value+'",';else if("icd"==i){n+='"groupno":"'+r.getElementById("groupno").value+'",',n+='"maxlines":'+r.getElementById("maxlines").value+",",n+='"priority":'+r.getElementById("priority").value+",",n+='"canpickup":'+r.getElementById("canpickup").checked+",",n+='"autologin":'+r.getElementById("autologin").checked+",",n+='"method":'+r.getElementById("method").value+",",n+='"natimeout":'+r.getElementById("natimeout").value+",",n+='"resumetime":'+r.getElementById("resumetime").value+",",n+='"queuelen":'+r.getElementById("queuelen").value+",",n+='"overflowredirect":"'+r.getElementById("overflowredirect").value+'",',n+='"maxqwait":'+r.getElementById("maxqwait").value+",",n+='"overtimeredirect":"'+r.getElementById("overtimeredirect").value+'",',n+='"indicationmode":'+r.getElementById("indicationmode").value+",",n+='"indicationtime":'+r.getElementById("indicationtime").value+",";var x=document.getElementById("greeting");x.value&&(x.files[0]&&(n+='"greeting":"'+x.files[0].name+'",'),upload("greeting"))}else if("conference"==i||"channel"==i||"selector"==i){var I=document.getElementById("initmode"),B=I.options[I.selectedIndex].value,c=r.getElementById("playgreet");if(file2=document.getElementById("greeting2"),n+='"autoredial":'+r.getElementById("autoredial").checked+",",n+='"recording":'+r.getElementById("confrecord").checked+",",n+='"greeting":'+c.checked+",",c.checked&&file2.value&&(file2.files[0]&&(n+='"greetingfile":"'+file2.files[0].name+'",'),upload("greeting2")),"channel"!=i&&(n+='"dialtimeout":'+r.getElementById("dialuptt").value+",",n+='"videomode":"'+r.getElementById("videoform").value+'",'),"selector"==i){var C=document.getElementById("initcalls");
n+='"initcalls":'+C.checked+",",2==B&&(file3=document.getElementById("onhold2"),file3.value&&(file3.files[0]&&(n+='"onholdfile":"'+file3.files[0].name+'",'),upload("onhold2")))}if("channel"==i){var _=document.getElementById("playmusiconback").checked;if(n+='"playmusiconback":'+_+",",_){var w=document.getElementById("musiconback");w.files[0]&&(n+='"musiconback":["'+w.files[0].name+'"],'),upload("musiconback")}var k=document.getElementById("video");n+=k.checked?'"videomode":"640x480",':'"videomode":"OFF",'}n+='"initmode":'+B+","}n+="}",json_rpc_async("setObject",n,function(){"function"==typeof a&&a(),"function"==typeof t&&t(e)})}function addMembersRow(e){var t,n,a,o,r,l;return t=document.createElement("tr"),o=getInfoFromState(e.state,!0),r=o.rstatus,l=o.rclass,t.id=e.oid,t.className=l,n=t.insertCell(0),e.oid?(t.setAttribute("data-ext",e.number),a=document.createElement("a"),a.textContent=e.number,a.href="#",addEvent(a,"click",get_extension),n.appendChild(a)):n.textContent=e.number,n=t.insertCell(1),n.setAttribute("data-cell","name"),n.textContent=e.name||"",n=t.insertCell(2),n.setAttribute("data-cell","display"),n.textContent=e.display||"",n=t.insertCell(3),n.setAttribute("data-cell","reg"),n.textContent=e.followme||e.reg||"",n=t.insertCell(4),n.setAttribute("data-cell","status"),n.innerHTML=r,n=t.insertCell(5),button=document.createElement("button"),button.className="btn btn-danger btn-sm",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",delete_extension),n.appendChild(button),t}function addUser(e){var t=t||window.event,n=document.getElementById("group-extensions").querySelector("tbody"),a=document.getElementById("available-users"),o=a.options,r=document.getElementById("user-name"),l=document.getElementById("user-alias"),i=document.getElementById("user-pass");if(o.length){if(!PbxObject.name)return void set_bgroup(e,addUser);var s=a.options[a.selectedIndex].value,d='"kind":"'+e+'",';d+='"groupid":"'+PbxObject.oid+'",',d+='"number":"'+s+'",',d+='"name":"'+r.value+'",',d+='"display":"'+l.value+'",',d+='"password":"'+i.value+'",';var c={kind:e,groupid:PbxObject.oid,number:s,name:r.value,display:l.value,password:i.value};json_rpc_async("setObject",d,function(e){if(e){c.oid=e;var t=addMembersRow(c),o=n.rows;o.length?n.insertBefore(t,n.firstChild):n.appendChild(t),PbxObject.members.push(c);for(var r=document.getElementById("select2-available-users-container"),l=([].slice.call(a.options),0);l<a.options.length;l++)a.options[l].value===s&&(a.removeChild(a.options[l]),r&&(r.textContent=a.options.length?a.options[0].value:""));if(!a.options.length){var i=document.getElementById("add-user");i.setAttribute("disabled","disabled")}cleanForm("new-user-form")}})}}function cleanForm(e){var t=document.getElementById(e),n=[].slice.call(t.querySelectorAll("input"));n.forEach(function(e){e.value&&(e.value="")})}function checkHuntMode(e){var t;t=e?e.target:document.getElementById("huntmode1"),0==t.selectedIndex?document.getElementById("huntmodesetts").classList.add("hidden"):document.getElementById("huntmodesetts").classList.remove("hidden")}function load_certificates(){$("#createCertBtn").click(createCert),$("#importCertBtn").click(importCert),getCertificates(),set_page()}function getCertificates(){json_rpc_async("getCertificates",null,function(e){fillCertTable(e)})}function fillCertTable(e){if(e){var t=document.querySelector("#certificates tbody");e.forEach(function(e){t.appendChild(createCertRow(e))}),close_options(),show_content()}}function createCertRow(e){var t,n,a,o=document.createElement("tr");return t=o.insertCell(0),n=document.createElement("a"),n.href="#",n.innerHTML=e,addEvent(n,"click",function(t){downloadCert(t,e)}),t.appendChild(n),t=o.insertCell(1),a=document.createElement("button"),a.className="btn btn-default btn-sm",a.innerHTML='<i class="fa fa-eye"></i>',addEvent(a,"click",function(){showCert(e)}),t.appendChild(a),t=o.insertCell(2),a=document.createElement("button"),a.className="btn btn-danger btn-sm",a.innerHTML='<i class="fa fa-remove"></i>',addEvent(a,"click",function(){removeCert(e)}),t.appendChild(a),o.setAttribute("data-cert",e),o}function downloadCert(e,t){var n=e.target;n.getAttribute("download")||(e.preventDefault(),json_rpc_async("getCertificate",{alias:t},function(e){n.setAttribute("download","certificate.pem"),n.href="data:text/plain;charset=utf-8,"+e,n.click()}))}function createCert(){openModal({tempName:"create_cert",modalId:"createCertModal",cb:function(){$("#createCert").click(function(){addNewCert()})}})}function addNewCert(){var e=document.getElementById("newCertForm"),t=retrieveFormData(e);t&&0!==Object.keys(t).length&&(t.V=parseInt(t.V),json_rpc_async("createCertificate",t,function(e){e&&(fillCertTable([t.CN]),$("#createCertModal").modal("hide"))}))}function importCert(){openModal({tempName:"import_cert",modalId:"importCertModal",cb:function(){$("#importCert").click(function(){importNewCert()})}})}function importNewCert(){var e=document.getElementById("importCertForm"),t=retrieveFormData(e);t&&0!==Object.keys(t).length&&json_rpc_async("setCertificate",t,function(e){if("OK"===e){$("#importCertModal").modal("hide");var t=document.querySelector("#certificates tbody");clearTable(t),getCertificates()}})}function showCert(e){json_rpc_async("getCertificate",{alias:e},function(t){openModal({tempName:"show_cert",modalId:"showCertModal",data:{name:e,certificate:t}})})}function removeCert(e){json_rpc_async("removeCertificate",{alias:e},function(){var t=document.querySelector('#certificates tbody tr[data-cert="'+e+'"]');t.parentNode.removeChild(t)})}function openModal(e){var t={};getPartial(e.tempName,function(n){t.frases=PbxObject.frases,e.data&&(t.data=e.data);var a=Mustache.render(n,t),o=document.querySelector("#el-loaded-content");o.insertAdjacentHTML("afterbegin",a),e.cb&&e.cb(),$("#"+e.modalId).modal()})}function load_channels(e){for(var t,n=document.getElementById("channels").getElementsByTagName("tbody")[0],a=document.createDocumentFragment(),o=[],r=0;r<e.length;r++)"channel"===e[r].kind&&(t=createChannelRow(e[r]),a.appendChild(t),o.push(e[r]));n.appendChild(a),PbxObject.channels=o,add_search_handler(),show_content(),addEvent(n,"click",tableClickHandler),$('[data-toggle="popover"]').popover({content:function(){return showParties(this)}})}function tableClickHandler(e){var t,e=e||window.event,n=e.target;"BUTTON"!==n.nodeName&&(n=n.parentNode),t=n.className,-1!=t.indexOf("showPartiesBtn")||-1!=t.indexOf("deleteObjBtn")&&delete_extension(e)}function createChannelRow(e){var t,n,a=document.createElement("tr"),o=getInfoFromState(e.state,e.group),r=o.rstatus,l=o.rclass;return t=a.insertCell(0),e.oid?(n=document.createElement("a"),n.href="#"+e.kind+"?"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,t=a.insertCell(1),t.setAttribute("data-cell","name"),t.textContent=e.name||"",t=a.insertCell(2),t.setAttribute("data-cell","status"),t.textContent=r||"",t=a.insertCell(3),t.setAttribute("data-cell","parties"),e.parties&&(t.textContent=e.parties.length||""),t=a.insertCell(4),button=createNewButton({type:"popover",classname:"btn btn-primary btn-sm showPartiesBtn",placement:"left",dataTrigger:"focus",content:'<i class="fa fa-user"></i>'}),t.appendChild(button),e.parties||(button.disabled="disabled"),t=a.insertCell(5),e.oid&&(button=createNewButton({title:PbxObject.frases.DELETE,classname:"btn btn-danger btn-sm deleteObjBtn",content:'<i class="fa fa-trash"></i>'}),t.appendChild(button)),a.id=e.oid,a.setAttribute("data-ext",e.ext),a.className=l,a}function showParties(e){var t,n,a=getClosest(e,"tr"),o=PbxObject.channels,r="";return o.forEach(function(e){e.oid===a.id&&(n=e.parties,n&&(t=n.length,n.sort(),n.forEach(function(e,n){r+=e,n!=t-1&&(r+=", ")})))}),r}function load_cli(e){PbxObject.oid=e.oid,PbxObject.name=e.name,e.name&&(document.getElementById("objname").value=e.name),document.getElementById("enabled").checked=e.enabled;var t=e.bnumbertransforms;if(t.length)for(var n=0;n<t.length;n++)append_transform(null,"transforms1",t[n]);else append_transform(null,"transforms1");var a=e.numbers;if(a.length)for(n=0;n<a.length;n++)add_cli_row(a[n]);else add_cli_row();show_content(),set_page()}function set_cli(){var e=document.getElementById("objname").value;if(!e)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var t='"name":"'+e+'",';show_loading_panel();var n;PbxObject.name?n=set_object_success:(PbxObject.name=e,n=null),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),t+='"kind":"cligroup",',t+='"enabled":'+document.getElementById("enabled").checked+",",t+='"bnumbertransforms":[',t+=encode_transforms("transforms1"),t+="],",t+='"numbers":[';var a,o=document.getElementById("clinumbers").getElementsByTagName("tbody")[0];for(a=0;a<o.children.length;a++){var r=o.children[a],l="",i=r.getElementsByTagName("input")[0];i&&"number"==i.name&&(l+='"number":"'+i.value+'",');var s=r.getElementsByTagName("textarea")[0];s&&"description"==s.name&&(l+='"description":"'+s.value+'",'),""!=l&&(t+="{"+l+"},")}t+="]",json_rpc_async("setObject",t,n)}function add_cli_row(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,a,o,r=document.getElementById("clinumbers").getElementsByTagName("tbody")[0],l=r.rows.length,i=r.insertRow(l);n=i.insertCell(0),a=document.createElement("div"),a.className="form-group",o=document.createElement("input"),o.className="form-control",o.setAttribute("type","text"),o.setAttribute("name","number"),e&&e.number&&(o.value=e.number),a.appendChild(o),n.appendChild(a),n=i.insertCell(1),a=document.createElement("div"),a.className="form-group",o=document.createElement("textarea"),o.className="form-control y-resizable",o.setAttribute("rows","3"),o.setAttribute("name","description"),e&&e.description&&(o.value=e.description),a.appendChild(o),n.appendChild(a),n=i.insertCell(2),a=document.createElement("div"),a.className="form-group",o=document.createElement("a"),o.href="#",o.className="remove-clr",o.innerHTML='<i class="fa fa-close"></i>',addEvent(o,"click",remove_row),a.appendChild(o),n.appendChild(a)}function CallsBoard(){var e,t,n,a,o,r,l,i,s,d,c,u,m=!1,p=document.querySelectorAll(".calls-incoming"),b=document.querySelectorAll(".calls-outgoing"),g=document.querySelectorAll(".calls-connected"),f=document.querySelectorAll(".calls-load"),h=document.getElementById("calls-trunks").querySelector("tbody"),v=document.getElementById("calls-table").querySelector("tbody"),y=(h.rows.length,this);this.init=function(){var e,t,n;c=new Picker,e=c.today(),t=36e5,n='"begin":'+e+', "interval":'+t,json_rpc_async("getCallStatisticsGraph",n,function(e){y.createGraph(e)}),this.update=setInterval(this.checkStates.bind(this),1e3),this.statUpdate=setInterval(this.updateStatistics.bind(this),18e5),addEvent(window,"hashchange",this.stopUpdate.bind(this))},this.checkStates=function(){sendData("getCurrentState",null,6),sendData("getCurrentCalls",null,5)},this.updateStatistics=function(){var e,t,n;c=new Picker,e=c.today(),t=36e5,n='"begin":'+e+', "interval":'+t,json_rpc_async("getCallStatisticsGraph",n,function(e){y.createGraph(e)})},this.setCurrentState=function(e){m===!1&&(show_content(),m=!0);var t,n=e.trunks;for(t=0;t<p.length;t++)p[t].textContent!=e["in"]&&(p[t].textContent=e["in"]);for(t=0;t<b.length;t++)b[t].textContent!=e.out&&(b[t].textContent=e.out);for(t=0;t<g.length;t++)g[t].textContent!=e.conn&&(g[t].textContent=e.conn);for(t=0;t<f.length;t++)f[t].textContent=parseFloat(e.load).toFixed(1)+"%";for(t=0;t<n.length;t++){var a=n[t].enabled?"success":"danger";h.rows[t]?(h.rows[t].cells[0].className=a,h.rows[t].cells[1].firstChild.textContent!=n[t].name&&(h.rows[t].cells[1].firstChild.textContent=n[t].name),h.rows[t].cells[2].textContent!=n[t]["in"]&&(h.rows[t].cells[2].textContent=n[t]["in"]),h.rows[t].cells[3].textContent!=n[t].out&&(h.rows[t].cells[3].textContent=n[t].out),h.rows[t].cells[4].textContent=parseFloat(n[t].load).toFixed(1)+"%",h.rows[t].cells[5].textContent!=n[t].address&&(h.rows[t].cells[5].textContent=n[t].address)):(i=h.insertRow(t),s=i.insertCell(0),s.className=a,s=i.insertCell(1),"system"===n[t].type?s.innerText=n[t].name:(d=document.createElement("a"),d.href="#trunk?"+n[t].oid,d.textContent=n[t].name,s.appendChild(d)),s=i.insertCell(2),s.textContent=n[t]["in"],s=i.insertCell(3),s.textContent=n[t].out,s=i.insertCell(4),s.textContent=parseFloat(n[t].load).toFixed(1)+"%",s=i.insertCell(5),s.textContent=n[t].address)}},this.setCurrentCalls=function(e){if(e){v.rows.length>e.length&&this.clearTable(v,e.length);for(var t=0;t<e.length;t++)v.rows[t]?(v.rows[t].cells[0].textContent=e[t].caller,v.rows[t].cells[1].textContent=e[t].called,e[t].time&&(v.rows[t].cells[2].textContent=formatTimeString(e[t].time,"hh:mm:ss"))):(i=v.insertRow(t),s=i.insertCell(0),s.textContent=e[t].caller,s=i.insertCell(1),s.textContent=e[t].called,s=i.insertCell(2),s.textContent=formatTimeString(e[t].time,"hh:mm:ss"))}},this.clearTable=function(e,t){for(i=t-1;e.rows.length!=t;)e.deleteRow(i),i-=1},this.stopUpdate=function(){clearInterval(this.update),clearInterval(this.statUpdate),removeEvent(window,"hashchange",this.stopUpdate.bind(this))},this.createGraph=function(i){if(i.length){e=[],t=[],n=[],a=[],o=[];for(var s=0,d=i.length;d>s;s++)l=i[s],r=l.t,e.push([r,l.i]),t.push([r,l.o]),n.push([r,l.l]),a.push([r,l.m]),o.push([r,l.p]);var c={show:!0,barWidth:36e5,lineWidth:0,fill:.7};insAndLostData=[{label:PbxObject.frases.STATISTICS.CONNECTEDCALLS,stack:0,bars:c,data:e,color:"#3c763d"},{label:PbxObject.frases.STATISTICS.LOSTCALLS,stack:0,bars:c,data:a,color:"#AA4643"}],t=[{label:PbxObject.frases.SETTINGS.OUTCALLS,bars:c,data:t,color:"#4572A7"}],n=[{label:PbxObject.frases.SETTINGS.INTCALLS,bars:c,data:n,color:"#BADABA"}],o=[{label:PbxObject.frases.STATISTICS.LINES_PAYLOAD,data:o,lines:{show:!0,fill:!1},points:{show:!0},color:"#3c763d"}],u={xaxis:{mode:"time",timeformat:"%H:%M",timezone:"browser",tickSize:0,tickLength:0},yaxis:{min:0,tickFormatter:function(e){return e.toFixed(1)}},grid:{margin:0,hoverable:!0,borderWidth:0,color:"#ccc"},legend:!1,tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.1",yDateFormat:"%H:%M"}},$.plot($("#outCalls-graph"),t,u),$.plot($("#inAndLost-graph"),insAndLostData,u),$.plot($("#intCalls-graph"),n,u),$.plot($("#linesLoad-graph"),o,u),addEvent(window,"resize",y.resizeChart),addEvent(window,"hashchange",function(){removeEvent(window,"resize",y.resizeChart)})}else;},this.resizeChart=function(){$.plot($("#outCalls-graph"),t,u),$.plot($("#inAndLost-graph"),insAndLostData,u),$.plot($("#intCalls-graph"),n,u),$.plot($("#linesLoad-graph"),o,u)},this.init()}function load_calls(){PbxObject.CallsBoard=new CallsBoard}function load_extensions(e){for(var t,n=document.getElementById("extensions").getElementsByTagName("tbody")[0],a=document.createDocumentFragment(),o=0;o<e.length;o++)t=createExtRow(e[o]),a.appendChild(t);n.appendChild(a),TableSortable.sortables_init(),add_search_handler(),set_page(),show_content()}function createExtRow(e){var t,n,a=document.createElement("tr"),o=getInfoFromState(e.state,e.group),r=o.rstatus,l=o.rclass;return t=a.insertCell(0),e.oid&&e.kind?(n=document.createElement("a"),"user"==e.kind||"phone"==e.kind?(n.href="#",addEvent(n,"click",get_extension)):n.href="#"+e.kind+"?"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,t=a.insertCell(1),t.setAttribute("data-cell","name"),t.textContent=e.name||"",t=a.insertCell(2),t.setAttribute("data-cell","group"),t.textContent=e.group||"",t=a.insertCell(3),t.textContent=e.reg||"",t.setAttribute("data-cell","reg"),t.className="nowrap",t.title=e.reg||"",t=a.insertCell(4),t.setAttribute("data-cell","kind"),t.textContent=PbxObject.frases.KINDS[e.kind]||"",t=a.insertCell(5),t.setAttribute("data-cell","status"),t.textContent=r||"",t=a.insertCell(6),e.kind&&("user"==e.kind||"phone"==e.kind)&&(button=createNewButton({type:"tooltip",title:PbxObject.frases.EDIT,classname:"btn btn-primary btn-sm",content:'<i class="fa fa-edit"></i>',handler:editExtension}),t.appendChild(button)),t=a.insertCell(7),e.oid&&(button=createNewButton({type:"tooltip",title:PbxObject.frases.DELETE,classname:"btn btn-danger btn-sm",content:'<i class="fa fa-trash"></i>',handler:delete_extension}),t.appendChild(button)),a.id=e.oid,a.setAttribute("data-ext",e.ext),a.setAttribute("data-kind",e.kind),a.className=l,a}function updateExtension(e){var t=document.getElementById(e.oid),n=e.state,a=getInfoFromState(n,e.group);if(t){var o,r=(t.cells,a.rstatus),l=a.rclass;t.className=l,e.name&&(o=t.querySelector('[data-cell="name"]'),o&&(o.innerHTML=e.name)),e.hasOwnProperty("group")&&(o=t.querySelector('[data-cell="group"]'),o&&(o.innerHTML=e.group)),e.hasOwnProperty("reg")&&(o=t.querySelector('[data-cell="reg"]'),o&&(o.innerHTML=e.reg)),o=t.querySelector('[data-cell="status"]'),o&&(o.innerHTML=r)}}function get_extension(e){var e=e||window.event;"click"==e.type&&e.preventDefault();var t=getClosest(e.target,"tr").id;t&&(show_loading_panel(),PbxObject.templates.extension?json_rpc_async("getObject",'"oid":"'+t+'"',load_extension):$.get("/badmin/views/extension.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.extension=e,json_rpc_async("getObject",'"oid":"'+t+'"',load_extension)}))}function editExtension(e){var t,n,a,o=getClosest(e.target,"tr"),r=o.parentNode,l=document.createElement("tr"),i=o.cells,s=i[1].textContent,d=i[2].textContent,c=i[3].textContent,u=o.getAttribute("data-kind"),m=i[5].textContent;if(l.setAttribute("data-oid",o.id),t=l.insertCell(0),t.innerHTML=i[0].innerHTML,t=l.insertCell(1),t.innerHTML='<input class="form-control extname" value="'+s+'">',t=l.insertCell(2),"user"==u||"phone"==u){var p="user"==u?"users":"unit";n=document.createElement("select"),n.className="form-control extgroup",fill_group_choice(p,d,n),t.appendChild(n)}else t.textContent=d;t=l.insertCell(3),"phone"==u||-1!=c.indexOf(".")?t.textContent=c:t.innerHTML='<input class="form-control extreg" value="'+c+'">',t=l.insertCell(4),t.textContent=u,t=l.insertCell(5),t.textContent=m,t=l.insertCell(6),a=createNewButton({type:"tooltip",title:PbxObject.frases.CANCEL,classname:"btn btn-default btn-sm",content:'<i class="fa fa-chevron-left"></i>',handler:function(){o.style.display="table-row",r.removeChild(l)}}),t.appendChild(a),t=l.insertCell(7),a=createNewButton({type:"tooltip",title:PbxObject.frases.SAVE,classname:"btn btn-success btn-sm",content:'<i class="fa fa-check"></i>',handler:set_extension_update}),t.appendChild(a),r.insertBefore(l,o),o.style.display="none"}function set_extension_update(e){var t=getClosest(e.target,"tr"),n=t.getAttribute("data-oid"),a=document.getElementById(n),o=t.querySelector(".extname").value,r=t.querySelector(".extgroup"),l=r.options[r.selectedIndex].value,i=t.querySelector(".extreg"),s='"oid":"'+n+'",';o&&(s+='"name":"'+o+'",'),l&&(s+='"groupid":"'+l+'",'),i&&i.value&&(s+='"followme":"'+i.value+'",'),json_rpc_async("setObject",s,function(){t.parentNode.removeChild(t),a.style.display="table-row"})}function load_extension(e){var t=document,n=e.groupid,a="user"==e.kind?"users":"unit";data={data:e,frases:PbxObject.frases},PbxObject.extOid=e.oid,PbxObject.vars=PbxObject.vars||{},PbxObject.vars.infoShown=!1;var o=Mustache.render(PbxObject.templates.extension,data),r=document.getElementById("ext-cont");r||(r=document.createElement("div"),r.id="ext-cont",$("#pagecontainer").prepend(r)),$(r).html(o);var l=document.getElementById("user-avatar"),i="/$AVATAR$?userid="+e.userid;l.onerror=function(){this.src="images/avatar.png"},l.src=i,switch_presentation(a,document.getElementById("ext-features")),n?fill_group_choice(a,n):document.getElementById("extgroup-cont").classList.add("hidden");var s=t.getElementById("ext-fwdnreg"),d=t.getElementById("ext-fwdnregnumber");"users"===a?(t.getElementById("fwdall-cont").classList.add("hidden"),s.checked=e.features.fwdall,d.value=e.features.fwdallnumber):(s.checked=e.features.fwdnreg,d.value=e.features.fwdnregnumber);var c=document.getElementById("ext-tabs");e.features&&(void 0==e.features.fwdall&&(c.querySelector('li a[href="#ext-forwarding"]').parentNode.className="hidden"),void 0==e.features.recording&&t.getElementById("ext-recording").setAttribute("disabled",""),void 0==e.features.callwaiting&&t.getElementById("ext-callwaiting").setAttribute("disabled",""),void 0==e.features.pickupdeny&&t.getElementById("ext-pickupdeny").setAttribute("disabled",""),void 0==e.features.monitordeny&&t.getElementById("ext-monitordeny").setAttribute("disabled",""),void 0==e.features.busyoverdeny&&t.getElementById("ext-busyoverdeny").setAttribute("disabled",""),void 0==e.features.voicemail&&t.getElementById("ext-voicemail").setAttribute("disabled",""),void 0==e.features.lock&&t.getElementById("ext-plock").setAttribute("disabled","")),t.getElementById("extpassword").value=e.password||"",t.getElementById("el-set-extension").onclick=function(){set_extension(a)},t.getElementById("showUserInfo").onclick=function(t){t&&t.preventDefault(),getUserInfo(e.userid)},show_content(),$('#el-extension [data-toggle="tooltip"]').tooltip(),$("#el-extension").modal(),$("#el-extension").on("hidden.bs.modal",function(){PbxObject.vars.infoShown=!1})}function set_extension(e){var t=document,n=PbxObject.extOid,a='"oid":"'+n+'",',o=t.getElementById("extgroup"),r=t.getElementById("extlogin").textContent;if(o.options.length)var l=o.options[o.selectedIndex].value;if(a+=l?'"groupid":"'+l+'",':'"groupid":"'+PbxObject.oid+'",',a+='"name":"'+t.getElementById("extname").value+'",',a+='"display":"'+t.getElementById("extdisplay").value+'",',r&&(a+='"login":"'+r+'",'),a+='"password":"'+t.getElementById("extpassword").value+'",',t.getElementById("extpin").value&&(a+='"pin":'+t.getElementById("extpin").value+","),a+='"features":{',null!=t.getElementById("ext-fwdall")&&"users"!==e&&(a+='"fwdall":'+t.getElementById("ext-fwdall").checked+",",a+='"fwdallnumber":"'+t.getElementById("ext-fwdallnumber").value+'",'),null!=t.getElementById("ext-fwdnregnumber")){var i="users"===e?"fwdall":"fwdnreg",s="users"===e?"fwdallnumber":"fwdnregnumber";a+=i+":"+t.getElementById("ext-fwdnreg").checked+",",a+=s+':"'+t.getElementById("ext-fwdnregnumber").value+'",'}null!=t.getElementById("ext-fwdbusynumber")&&(a+='"fwdbusy":'+t.getElementById("ext-fwdbusy").checked+",",a+='"fwdbusynumber":"'+t.getElementById("ext-fwdbusynumber").value+'",'),null!=t.getElementById("ext-fwdnansnumber")&&(a+='"fwdnans":'+t.getElementById("ext-fwdnans").checked+",",a+='"fwdnansnumber":"'+t.getElementById("ext-fwdnansnumber").value+'",'),null!=t.getElementById("ext-fwdtimeout")&&t.getElementById("ext-fwdtimeout").value&&(a+='"fwdtimeout":'+t.getElementById("ext-fwdtimeout").value+","),0==t.getElementById("ext-plock").disabled&&(a+='"lock":'+t.getElementById("ext-plock").checked+","),0==t.getElementById("ext-recording").disabled&&(a+='"recording":'+t.getElementById("ext-recording").checked+","),0==t.getElementById("ext-callwaiting").disabled&&(a+='"callwaiting":'+t.getElementById("ext-callwaiting").checked+","),0==t.getElementById("ext-pickupdeny").disabled&&(a+='"pickupdeny":'+t.getElementById("ext-pickupdeny").checked+","),0==t.getElementById("ext-monitordeny").disabled&&(a+='"monitordeny":'+t.getElementById("ext-monitordeny").checked+","),0==t.getElementById("ext-busyoverdeny").disabled&&(a+='"busyoverdeny":'+t.getElementById("ext-busyoverdeny").checked+","),0==t.getElementById("ext-voicemail").disabled&&(a+='"voicemail":'+t.getElementById("ext-voicemail").checked+","),a+="}";var d=document.getElementById("userInfo"),c=retrieveFormData(d);c&&0!==Object.keys(c).length&&(c.userid=r,json_rpc_async("setUserInfo",c,null)),json_rpc_async("setObject",a,function(){$("#el-extension").modal("hide")}),upload("upload-avatar","/$AVATAR$?userid="+r)}function loadAvatar(e){var e=e||window.event;e&&e.preventDefault();var t=document.getElementById("upload-avatar");t.click(),t.onchange=function(){previewAvatar(this)}}function previewAvatar(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#user-avatar").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function getAvatar(e,t){var n=new XMLHttpRequest;n.overrideMimeType("text/plain; charset=x-user-defined"),n.open("GET","/$AVATAR$?userid="+e,!0),n.responseType="arraybuffer",n.onload=function(){if(200==this.status){for(var e="",a=n.mozResponseArrayBuffer||n.response,o=new Uint8Array(a),r=0;r<o.byteLength;r++)e+=String.fromCharCode(o[r]);null!=t&&t(e)}},n.send(null)}function getUserInfo(e){if(PbxObject.vars.infoShown===!0)return void $("#userInfo").collapse("toggle");var t,n,a=document.getElementById("showUserInfo"),o=a.innerHTML;a.innerHTML='<i class="fa fa-lg fa-spinner fa-spin"></i>',getPartial("userinfo",function(r){json_rpc_async("getUserInfo",'"userid":"'+e+'"',function(e){PbxObject.vars.infoShown=!0,n={data:e,frases:PbxObject.frases},t=Mustache.render(r,n),$("#userInfo").html(t),a.innerHTML=o,$("#userInfo").collapse("toggle")})})}function init(){window.clearInterval(PbxObject.initInterval),"complete"===document.readyState||"interactive"===document.readyState?init_page():document.addEventListener?document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,!1),init_page()},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),init_page())})}function createWebsocket(){var e="https:"===location.protocol?"wss:":"ws:";PbxObject.websocket=new WebSocket(e+"//"+window.location.host+"/","json.api.smile-soft.com"),PbxObject.websocket.onopen=function(){console.log("WebSocket opened"),PbxObject.websocketTry=1},PbxObject.websocket.onmessage=function(e){handleMessage(e.data)},PbxObject.websocket.onclose=function(){console.log("WebSocket closed");var e=generateInterval(PbxObject.websocketTry);setTimeout(function(){PbxObject.websocketTry++,createWebsocket()},e)}}function generateInterval(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function json_rpc(e,t){var n;n=null==t?'{"method":"'+e+'", "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}';var a=new XMLHttpRequest;a.open("POST","/",!1),a.setRequestHeader("Content-Type","application/json; charset=UTF-8"),a.send(n);var o=JSON.parse(a.responseText);return void 0!=o.error?void notify_about("error",o.error.message):o.result}function json_rpc_async(e,t,n){var a;a=null!==t?"object"==typeof t?'{"method":"'+e+'", "params":'+JSON.stringify(t)+', "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}':'{"method":"'+e+'", "id":1}';var o=new XMLHttpRequest;o.open("POST","/",!0);var r=setTimeout(function(){o.abort(),notify_about("info",PbxObject.frases.TIMEOUT),show_content()},6e4);o.onreadystatechange=function(){if(4==o.readyState)if(clearTimeout(r),200!=o.status)console.error(e,o.statusText),notify_about("error",PbxObject.frases.ERROR),show_content();else if(null!=o.responseText){if(!o.responseText)return;var t=JSON.parse(o.responseText);void 0!=t.error?(notify_about("error",t.error.message),show_content()):t.result&&null!==n&&n(t.result)}},o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),o.send(a)}function getTranslations(e){var t=new XMLHttpRequest,n="translations_"+e+".json";t.open("GET","/badmin/translations/"+n,!0),t.onreadystatechange=function(){if(4==t.readyState&&"200"==t.status){var e=JSON.parse(t.responseText);loadTranslations(e)}},t.setRequestHeader("Content-Type","application/json; charset=UTF-8"),t.send()}function loadTranslations(e){PbxObject.frases=e,init()}function sendData(e,t,n){var a={};a.method=e,t&&(a.params=t),n&&(a.id=n),a=JSON.stringify(a),PbxObject.websocket.send(a)}function setPageHeight(){$("#pagecontent").css("min-height",function(){return $(window).height()})}function changeOnResize(e){PbxObject.smallScreen!==e&&(e?($("#pagecontent").hasClass("squeezed-right")&&$("#pagecontent").removeClass("squeezed-right"),$("#pbxmenu").hasClass("squeezed-menu")&&$("#pbxmenu").removeClass("squeezed-menu")):$("#pagecontent").hasClass("squeezed-right")||$("#pagecontent").addClass("squeezed-right"),$("#sidebar-toggle").toggleClass("flipped"),PbxObject.smallScreen=e)}function handleMessage(e){var e=JSON.parse(e),t=e.method;if(e.method){var n=e.params;"stateChanged"==t||"objectUpdated"==t?updateExtension(n):"conferenceUpdate"==t?updateConference(e):"objectCreated"==t?newObjectAdded(n):"objectDeleted"==t&&(n.ext?delete_extension_row(n):objectDeleted(n))}else callbackOnId(e.id,e.result)}function callbackOnId(e,t){5==e?PbxObject.CallsBoard.setCurrentCalls(t):6==e?PbxObject.CallsBoard.setCurrentState(t):7==e&&setCallStatistics(t)}function init_page(){var e=$("#main-template").html(),t=Mustache.render(e,PbxObject.frases);$("#pagecontainer").html(t),switchMode(PbxObject.options.config),document.getElementsByTagName("title")[0].innerHTML="SmileSoft - "+PbxObject.frases.PBXADMIN,setPageHeight(),PbxObject.groups={},PbxObject.templates={},PbxObject.language=PbxObject.options.lang,PbxObject.smallScreen=isSmallScreen(),$(window).resize(function(){setPageHeight(),changeOnResize(isSmallScreen())}),isSmallScreen()?$("#sidebar-toggle").toggleClass("flipped"):$("#pagecontent").addClass("squeezed-right"),$(window).width()>767&&$(window).width()<959&&($("#pbxmenu").addClass("squeezed-menu"),$("#pagecontent").removeClass("squeezed-right")),location.hash.substring(1)||(location.hash="calls"),load_pbx_options(PbxObject.options),get_object(),set_listeners(),$('[data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}})}function set_listeners(){addEvent(window,"hashchange",get_object),$(".sidebar-toggle","#pagecontent").click(toggle_sidebar),$(".options-open","#pagecontent").click(open_options),$(".options-close","#pbxoptions").click(close_options),$("#pbxmenu li a").click(showGroups)}function showGroups(e){var t,n=this,a=this.href;a&&"#"===a.substring(a.length-1)&&e.preventDefault();var o=$(n).parent(),r=$(n).attr("data-kind");if(o.hasClass("active"))t=$(n).next("ul"),t&&(o.removeClass("active"),t.slideUp("normal"));else if(r){var l=document.createElement("ul");l.id="ul-"+r,"unit"!=r&&"icd"!=r&&"hunting"!=r&&"pickup"!=r&&"cli"!=r&&(likind=document.createElement("li"),likind.className="menu-name",likind.innerHTML=PbxObject.frases.KINDS[r],l.appendChild(likind)),json_rpc_async("getObjects",'"kind":"'+r+'"',function(e){var a=document.createElement("li");a.className="add-group-object";var i=document.createElement("a");if("application"==r){var s=document.createElement("input");s.type="file",s.id="uploadapp",s.className="upload-custom",s.accept=".application",addEvent(s,"change",function(){upload("uploadapp")}),a.appendChild(s),i.href="#",addEvent(i,"click",function(e){document.getElementById("uploadapp").click(),e&&e.preventDefault})}else i.href="#"+r;i.innerHTML='<i class="fa fa-plus"></i><span>'+(isGroup(r)?PbxObject.frases.ADD_GROUP:PbxObject.frases.ADD)+"</span>",a.appendChild(i),l.appendChild(a);var d,c,u,a,i,m=e;for(sortByKey(m,"name"),d=0;d<m.length;d++)("trunk"!==r||"system"!==m[d].type)&&(c=m[d].oid,u=m[d].name,a=document.createElement("li"),i=document.createElement("a"),i.href="#"+r+"?"+c,i.innerHTML=u,a.appendChild(i),l.appendChild(a));$(n).siblings().remove("ul"),o.append(l),show_content(!1),t=$(n).next("ul"),t&&t.slideDown("normal"),o.addClass("active")}),show_loading_panel(o[0])}else t=$(n).next("ul"),t&&t.slideDown("normal"),o.addClass("active");o.siblings("li.active").removeClass("active").children("ul:visible").slideUp("normal")}function get_object(){{var e=location.hash.substring(1),t=-1!=e.indexOf("?")?e.substring(0,e.indexOf("?")):e.substring(0),n=-1!=e.indexOf("?")?e.substring(e.indexOf("?")+1):t;PbxObject.language}if(e!==PbxObject.query){if(""!=e){PbxObject.query=e,PbxObject.kind=t,PbxObject.oid=n,$("#dcontainer").addClass("faded");var a=document.getElementById("el-extension");a&&a.parentNode.removeChild(a);var o=["equipment","unit","users","icd","hunting","conference","selector","channel","pickup"];-1!=o.indexOf(t)&&(t="bgroup"),PbxObject.templates[t]?load_template(PbxObject.templates[t],t):$.get("/badmin/views/"+t+".html",function(e){PbxObject.templates[t]=e,load_template(e,t)
})}isSmallScreen()&&$("#pagecontent").hasClass("squeezed-right")&&($("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),$("#pbxmenu").scrollTop(0))}}function load_template(e,t){var n="load_"+t,a=window[n],o=Mustache.render(e,PbxObject.frases);$("#dcontainer").html(o),"extensions"==t||"channels"==t?json_rpc_async("getExtensions",null,a):"calls"==t||"records"==t||"rec_settings"==t||"certificates"==t||"statistics"==t||"reports"==t?a():json_rpc_async("getObject",'"oid":"'+PbxObject.oid+'"',a),$("#dcontainer").scrollTop(0)}function getPartial(e,t){PbxObject.partials=PbxObject.partials||{};var n=PbxObject.partials[e];n?t(n):$.get("/badmin/partials/"+e+".html",function(n){PbxObject.partials[e]=n,t(n)})}function set_page(){var e=PbxObject.kind;"attendant"!=e&&"extensions"!=e&&"trunk"!=e&&"application"!=e&&"cli"!=e&&"routes"!=e&&"timer"!=e&&(e="bgroup");var t=document.getElementById("dcontainer"),n=t.querySelectorAll(".transrow"),a=t.querySelectorAll(".clirow"),o=document.getElementById("add-route"),r=document.getElementById("el-set-object"),l=document.getElementById("el-delete-object"),i="set_"+e,s=window[i];if(n.length)for(u=0;u<n.length;u++)addEvent(n[u],"click",append_transform);if(a.length)for(u=0;u<a.length;u++)addEvent(a[u],"click",add_cli_row);if(o&&addEvent(o,"click",add_new_route),r){var d=PbxObject.name?PbxObject.frases.SAVE:PbxObject.frases.CREATE;r.innerHTML='<i class="fa fa-check"></i> '+d,r.onclick=function(){s()}}l&&(PbxObject.name?l.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}:l.setAttribute("disabled","disabled"));for(var c=document.getElementsByClassName("el-sortable"),u=0;u<c.length;u++)new Sortable(c[u]);add_search_handler(),$(".selectable-cont").click(function(e){var t=e.target;if(t.getAttribute("data-value"))move_list_item(e);else{var n,a,o=getClosest(t,".selectable-cont");if(t.classList.contains("assign-all"))n=o.querySelector(".members"),a=o.querySelector(".available");else{if(!t.classList.contains("unassign-all"))return;n=o.querySelector(".available"),a=o.querySelector(".members")}move_list(n,a)}}),$("#dcontainer div.panel-header:not(.panel-static)").click(toggle_panel),$('#dcontainer [data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}})}function setBreadcrumbs(){for(var e=document.getElementById("main-breadcrumb");e.firstChild;)e.removeChild(e.firstChild);if(PbxObject.kind){var t,n,a=document.getElementById("objname"),o=document.createDocumentFragment();t=document.createElement("li"),t.innerHTML='<a href="#'+PbxObject.kind+'">'+PbxObject.frases.KINDS[PbxObject.kind]+"</a>",n=document.createElement("li"),n.className="active",a&&(n.innerHTML=a.value,addEvent(a,"input",function(){n.innerHTML=a.value})),o.appendChild(t),o.appendChild(n),e.appendChild(o)}}function toggle_sidebar(e){e&&e.preventDefault(),$(this).toggleClass("flipped"),$("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),isSmallScreen()||toggle_menu()}function toggle_menu(){$("#pbxmenu").toggleClass("squeezed-menu")}function open_options(e){e&&e.preventDefault(),toggle_presentation()}function close_options(e){$("#pagecontent").removeClass("pushed-left"),$("#pbxoptions").removeClass("pushed-left"),$("#el-slidemenu").removeClass("hide-menu"),setTimeout(function(){$("#pbxoptions").removeClass("top-layer"),$("#el-options-content").remove()},500),e&&e.preventDefault()}function toggle_panel(e){e.preventDefault();var t=$(this).closest(".panel"),n=t.children(".panel-body");n.slideToggle(),t.toggleClass("minimized")}function toggle_presentation(){$("#el-slidemenu").addClass("hide-menu"),$("#pagecontent").addClass("pushed-left"),$("#pbxoptions").addClass("pushed-left"),$(".tab-switcher","#pbxoptions").click(function(e){var e=e||window.event;switch_options_tab($(this).attr("data-tab")),e.preventDefault()})}function show_loading_panel(e){if(!document.getElementById("el-loading")){var t=document.createElement("div");t.id="el-loading",t.className="el-loading-panel ";var n=document.createElement("img");n.src="/badmin/images/sprites_white.png",n.className="loader",t.appendChild(n);var a=e||document.getElementById("pagecontainer");a.appendChild(t)}}function remove_loading_panel(){var e=document.getElementById("el-loading");e&&e.parentNode.removeChild(e)}function show_content(e){setBreadcrumbs(),remove_loading_panel(),$("#dcontainer").hasClass("faded")&&$("#dcontainer").removeClass("faded"),e===!1}function switchMode(e){var t=[].slice.call(document.querySelectorAll(".branch-mode"));-1==e.indexOf("channels")&&t.forEach(function(e){-1!=e.className.indexOf("mode-channels")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no selectors")&&t.forEach(function(e){-1!=e.className.indexOf("mode-selector")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no users")&&t.forEach(function(e){-1!=e.className.indexOf("mode-users")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no groups")&&t.forEach(function(e){-1!=e.className.indexOf("mode-groups")&&e.parentNode.removeChild(e)})}function switch_presentation(e,t,n){var a,o=t||document.getElementById("dcontainer"),n=n?"."+n:".pl-kind",r=[].slice.call(o.querySelectorAll(n));r.forEach(function(t){a=t.classList.contains("pl-"+e)||t.classList.contains("pl-all")?t.classList.contains("pl-no-"+e)?"remove":"add":"remove",t.classList[a]("revealed")})}function switch_tab(e){for(var t=document.getElementById(e),n=t.parentNode.parentNode,a=n.children,o=0;o<a.length;o++)a[o].style.display=a[o].children[0].id!=e?"none":""}function switch_options_tab(e){for(var t=document.getElementById(e),n=t.parentNode,a=n.children,o=1;o<a.length;o++)a[o].style.display=a[o].id!=e?"none":""}function add_search_handler(){var e=[].slice.call(document.querySelectorAll(".el-search"));e.length&&e.forEach(function(e){e.getAttribute("data-element")&&(e.oninput=function(e){filter_element(e)})})}function filter_element(e){var t,n,e=e||window.event,a=e.target||this,o=a.getAttribute("data-element"),r=document.getElementById(o);n=a.value.toLowerCase(),"TABLE"==r.nodeName?(defClass="table-row",r=r.querySelector("tbody")):defClass="block";for(var l=0;l<r.children.length;l++)child=r.children[l],t=child.textContent.toLowerCase(),child.style.display=-1===t.indexOf(n)?"none":defClass}function notify_about(e,t){var n,a,o,r=document.createElement("div"),l=document.createElement("i"),i=document.getElementsByTagName("body")[0];switch(e){case"success":a='<span class="fa fa-check"></span>',o="el-notifier-ok";break;case"error":a='<span class="fa fa-close"></span>',o="el-notifier-error";break;default:a='<span class="fa fa-warning"></span>',o="el-notifier-info"}l.className="fa fa-close el-close-notify",r.className="el-notifier "+o,r.innerHTML+=a+" "+t,r.appendChild(l),i.appendChild(r),n=setTimeout(function(){removeEvent(l,"click",function(){i.removeChild(r),clearTimeout(n)}),i.removeChild(r)},7e3),addEvent(l,"click",function(){i.removeChild(r),clearTimeout(n)})}function append_transform(e,t,n){var a,o,r,l,i,s;if(t)a=document.getElementById(t);else{if(!e||"click"!=e.type)return;var e=e||window.event,d=e.target||e.srcElement;e.preventDefault(),a=getClosest(d,"table")}o=a.querySelector("tbody"),l=o.rows.length,row=o.insertRow(l),r=row.insertCell(0),i=document.createElement("div"),i.className="form-group",s=document.createElement("input"),s.className="form-control",s.setAttribute("type","text"),s.setAttribute("name","number"),null!=n&&s.setAttribute("value",n.number),i.appendChild(s),r.appendChild(i),r=row.insertCell(1),r.setAttribute("align","center"),i=document.createElement("div"),i.className="form-group",s=document.createElement("input"),s.setAttribute("type","checkbox"),s.setAttribute("name","strip"),null!=n&&(s.checked=n.strip),i.appendChild(s),r.appendChild(i),r=row.insertCell(2),i=document.createElement("div"),i.className="form-group",s=document.createElement("input"),s.className="form-control",s.setAttribute("type","text"),s.setAttribute("name","prefix"),null!=n&&s.setAttribute("value",n.prefix),i.appendChild(s),r.appendChild(i),r=row.insertCell(3),i=document.createElement("div"),i.className="form-group",s=document.createElement("a"),s.href="#",s.className="remove-clr",s.innerHTML='<i class="fa fa-minus"></i>',addEvent(s,"click",remove_row),i.appendChild(s),r.appendChild(i)}function clear_transforms(e){var t,n,a;for(t=0;t<e.length;t++)for(a=document.getElementById(e[t]),n=a.rows.length-1;n>1;n--)a.deleteRow(n)}function encode_transforms(e){for(var t=document.getElementById(e).getElementsByTagName("tbody")[0],n="",a=t.children.length;a--;){var o=t.children[a],r=o.getElementsByTagName("input"),l=r.length,i=o.querySelector('input[name="number"]');if(i.value){for(n+="{";l--;)"number"==r[l].name?n+='"number":"'+r[l].value+'",':"strip"==r[l].name?n+='"strip":'+r[l].checked+",":"prefix"==r[l].name&&(n+='"prefix":"'+r[l].value+'",');n+="},"}}return n}function remove_row(e){e.preventDefault();for(var t,n=e.currentTarget,a=n.parentNode;"TBODY"!=a.nodeName;)"TR"==a.nodeName&&(t=a),a=a.parentNode;a.removeChild(t)}function newObjectAdded(e){var t=e.oid,n=e.kind,a=e.name,o=(e.enabled,document.getElementById("el-set-object")),r=document.getElementById("el-delete-object"),l=document.getElementById("ul-"+e.kind);if(remove_loading_panel(),notify_about("success",a+" "+PbxObject.frases.CREATED),"phone"!==n&&"user"!==n){if("application"!==n&&(PbxObject.query=n+"?"+t,window.location.href="#"+PbxObject.query),l){var i=document.createElement("li"),s=document.createElement("a");s.href="#"+n+"?"+t,s.innerHTML=a,i.appendChild(s),l.appendChild(i)}r&&r.hasAttribute("disabled")&&(r.removeAttribute("disabled"),r.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}),o&&(o.innerHTML=PbxObject.frases.SAVE),"object"==typeof PbxObject.objects&&(PbxObject.objects.push(e),sortByKey(PbxObject.objects,"name"))}}function objectDeleted(e){var t=document.getElementById("ul-"+e.kind);if(t)for(var n,a,o,r=0;r<t.children.length;r++)n=t.children[r],a=n.querySelector("a"),a&&a.href&&(o=a.href,o&&o.substring(o.indexOf("?")+1)==e.oid&&t.removeChild(n));"object"==typeof PbxObject.objects&&(PbxObject.objects=PbxObject.objects.filter(function(t){return t.oid!==e.oid}))}function set_object_success(){remove_loading_panel(),notify_about("success",PbxObject.frases.SAVED)}function set_options_success(){var e,t="",n=window.location.pathname.split("/");for(e=0;e<n.length;e++)("en"===n[e]||"uk"===n[e]||"ru"===n[e])&&(n[e]=PbxObject.language),t+="/",t+=n[e];var a=window.location.protocol+"//"+window.location.host+t.substring(1);window.location.href=a}function delete_object(e,t,n){var a=confirm(PbxObject.frases.DODELETE+" "+e+"?");return a?void json_rpc_async("deleteObject",'"oid":"'+n+'"',function(){objectDeleted({name:e,kind:t,oid:n}),window.location.hash=t}):!1}function delete_extension(e){var t=getClosest(e.target,"tr"),n=t.id,a=(t.parentNode,t.getAttribute("data-ext")),o=t.querySelector("a"),r="extensions"===PbxObject.kind?t.cells[2].textContent:PbxObject.name,l=PbxObject.frases.DODELETE+" "+a+" "+PbxObject.frases.FROM.toLowerCase()+" "+(r?r:"")+"?",i=confirm(l);return i?void json_rpc_async("deleteObject",'"oid":"'+n+'"',function(){o&&(o.removeAttribute("href"),removeEvent(o,"click",get_extension))}):!1}function delete_extension_row(e){var t=document.getElementById("extensions")||document.getElementById("group-extensions");t=t.querySelector("tbody");var n=document.getElementById(e.oid);t.removeChild(n);var a=document.getElementById("available-users");a&&(a.innerHTML+='<option value="'+e.ext+'">'+e.ext+"</option>")}function validateInput(e){var e=e||window.event;-1!==[46,9,8,27,13].indexOf(e.keyCode)||65==e.keyCode&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=40||188==e.keyCode&&e.shiftKey===!1||189==e.keyCode&&e.shiftKey===!1||(e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault()}function getFileName(e){if(null!==e){var t="";return Array.isArray(e)?e.forEach(function(e,n,a){t+=" "+e,n!==a.length-1&&(t+=",")}):t=" "+e,t}return""}function customize_upload(e,t){var n=document.getElementById(e);if(!n)return void console.error("custommize_upload: File element not found");var a=n.parentNode,o=document.createElement("button"),r=document.createElement("span");a.className+=" nowrap";var l=getFileName(t);r.innerHTML=l,r.title=l,r.className="upload-filename",o.type="button",o.className="btn btn-default btn-sm needsclick",o.innerHTML="Upload",o.onclick=function(){n.click()},a.insertBefore(o,n),a.insertBefore(r,n),n.onchange=function(){this.files.length?(l=getFileName(this.files[0].name),r.innerHTML=l,r.title=l):(r.innerHTML=" ",r.title="")}}function upload(e,t){var n;if(isElement(e))n=e;else{if("string"!=typeof e)return!1;n=document.getElementById(e)}var a=t?t:"/",o=n.files;if(0==o.length)return!1;var r=o[0],l=new XMLHttpRequest,i=setTimeout(function(){l.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);l.onreadystatechange=function(){4==l.readyState&&(clearTimeout(i),200!=l.status?notify_about("error",PbxObject.frases.ERROR):"uploadapp"==e&&notify_about("success",r.name+" "+PbxObject.frases.UPLOADED))},l.open("PUT",a,!0),l.setRequestHeader("X-File-Name",r.name),l.setRequestHeader("X-File-Size",r.size),l.send(r)}function deleteFile(e){if(e){var t=new XMLHttpRequest,n=setTimeout(function(){t.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);t.onreadystatechange=function(){4==t.readyState&&(clearTimeout(n),200!=t.status&&notify_about("error",PbxObject.frases.ERROR))},t.open("DELETE",e,!0),t.send(),console.log("file deleted",e)}}function b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function get_object_link(e){var t=json_rpc("getObject",'"oid":"'+e+'"');location.hash=t.kind+"?"+e}function setFormData(e,t){for(var n,a,o=0;o<e.elements.length;o++)n=e.elements[o],n.hasAttribute("name")&&(a=n.name,t.forEach(function(e){e.hasOwnProperty("key")&&e.key===a&&"file"!==n.type&&("checkbox"===n.type?n.checked=e.value:n.value=e.value)}))}function retrieveFormData(e){for(var t,n,a,o={},r=0;r<e.elements.length;r++)t=e.elements[r],t.hasAttribute("name")&&(n=t.name,a="checkbox"===t.type?t.checked:"file"===t.type?t.files.length?t.files[0].name:null:t.value,void 0!==a&&null!==a&&(o[n]=a));return o}function isSmallScreen(){return $(window).width()<768}function toTheTop(e){var t=$(document).scrollTop(),n=e?$("#"+e).offset().top:0;n>t||$("html body").animate({scrollTop:n},500)}function copyFromField(e,t){var n=getClosest(e,".input-group"),a=n.querySelector("input"),o=document.getElementById(t);a.value=o.value}function revealPassword(e){var t=getClosest(e,".input-group"),n=t.querySelector("input");"password"==n.type?(n.type="text",e.innerHTML='<i class="fa fa-eye-slash" data-toggle="tooltip" title="'+PbxObject.frases.HIDE_PWD+'"></i>'):(n.type="password",e.innerHTML='<i class="fa fa-eye" data-toggle="tooltip" title="'+PbxObject.frases.REVEAL_PWD+'"></i>')}function generatePassword(e){for(var t,n=getClosest(e,".input-group"),a=n.querySelector("input"),o="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",r="",l=8,i=0;l>i;i++)t=Math.floor(62*Math.random()),r+=o.charAt(t);a.value=r}function getClosest(e,t){for(var n=t.charAt(0);e&&e!==document;e=e.parentNode)if("."===n){if(e.classList.contains(t.substr(1)))return e}else if("#"===n){if(e.id===t.substr(1))return e}else if("["===n){if(e.hasAttribute(t.substr(1,t.length-2)))return e}else if(e.nodeName===t.toUpperCase())return e;return!1}function switchDisabledState(e){var t,n,a,o,r;isElement(e)?t=e:(a=e||window.event,t=a.target),n=t.checked,o=t.getAttribute("data-name"),r=[].slice.call(document.querySelectorAll('input[name="'+o+'"]')),r.forEach(function(e){e.disabled=!n})}function isElement(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}function isGroup(e){var t=["equipment","unit","users","icd","hunting","cli","pickup"];return-1!=t.indexOf(e)?!0:void 0}function isMaxNumber(e){return 2147483647===e}function sortSelectOptions(e){var t=e.querySelectorAll("options");t.sort(function(e,t){return e.text.toUpperCase()>t.text.toUpperCase()?1:e.text.toUpperCase()<t.text.toUpperCase()?-1:0}),$(e).empty().append(t)}function sortByKey(e,t){e.sort(function(e,n){return e[t]<n[t]?-1:e[t]>n[t]?1:0})}function objFromString(e,t){return e[t]}function formatTimeString(e,t){var n,a,o,r;return n=Math.floor(e/3600),e-=3600*n,a=Math.floor(e/60),r=(10>n?"0"+n:n)+":"+(10>a?"0"+a:a),"hh:mm:ss"==t&&(o=e-60*a,r+=":"+(10>o?"0"+o:o)),r}function formatDateString(e){var t="NaN"!==parseInt(e)?parseInt(e):e,n=new Date(t),a=n.getDate()<10?"0"+n.getDate():n.getDate(),o=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,r=n.getHours()<10?"0"+n.getHours():n.getHours(),l=n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes();return a+"/"+o+"/"+n.getFullYear()+" "+r+":"+l}function clearTable(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function clearColumns(e){for(var t=e.querySelector("thead"),n=e.rows;t.rows[0].cells.length>1;)for(var a=0;a<n.length;a++)n[a].cells.length>1&&n[a].deleteCell(-1)}function elPosition(e){var t=getViewportH(),n=getOffset(e),a=n.top,o=t-a-e.offsetHeight;return o<=e.offsetHeight?"top":"bottom"}function getViewportH(){var e=document.documentElement,t=e.clientHeight,n=window.innerHeight;return n>t?n:t}function getOffset(e){return e.getBoundingClientRect()}function extend(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function addEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)}function removeEvent(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}function createNewButton(e){var t=document.createElement("button");return("popover"===e.type||"tooltip"===e.type)&&(t.setAttribute("data-toggle",e.type),void 0!==e.html&&t.setAttribute("data-html",e.html),e.placement&&t.setAttribute("data-placement",e.placement),e.dataContent&&t.setAttribute("data-content",e.dataContent),e.dataTrigger&&t.setAttribute("data-trigger",e.dataTrigger)),t.className=e.classname||"",t.innerHTML=e.content||"",e.title&&(t.title=e.title),e.handler&&addEvent(t,e.evtType||"click",e.handler),t}function setAccordion(e){var t=e?e:"";$(t+" .acc-cont > .acc-pane").slideToggle(),$(t+" .acc-cont > .acc-header").click(function(){$(this).next(".acc-pane").slideToggle(),$(this).toggleClass("current"),$(this).siblings(".acc-header").removeClass("current")})}function createCodecRow(e){var t,n;return t=document.createElement("tr"),n=t.insertCell(0),n.className="draggable",n.innerHTML='<i class="fa fa-ellipsis-v"></i>',n=t.insertCell(1),n.className="codec-name",n.innerHTML=e.codec,n=t.insertCell(2),n.innerHTML='<input type="text" class="form-control codec-frames" value="'+(e.frame?e.frame:0)+'">',n=t.insertCell(3),n.innerHTML='<input type="checkbox" '+(e.frame?"checked":"")+' class="codec-enabled">',t}function buildCodecsTable(e,t,n){var a=[],o=document.createDocumentFragment(),r=isElement(e)?e:document.getElementById(e);a=a.concat(n),t.forEach(function(e){o.appendChild(createCodecRow(e)),-1!=a.indexOf(e.codec)&&a.splice(a.indexOf(e.codec),1)}),a.forEach(function(e){o.appendChild(createCodecRow({codec:e}))}),r.appendChild(o)}function getCodecsString(e){for(var t,n,a=[],o=isElement(e)?e:document.getElementById(e),r=0;n=o.rows[r];r++)n.getElementsByClassName("codec-enabled")[0].checked&&(t={codec:n.getElementsByClassName("codec-name")[0].textContent,frame:parseInt(n.getElementsByClassName("codec-frames")[0].value)},a.push(t));return a}function getFriendlyCodeName(e){return PbxObject.frases.CODES[e.toString()]}function fill_select_items(e,t){var n,a=document.getElementById(e);t.forEach(function(e){n=document.createElement("option"),n.value=e.oid,n.textContent=e.name,a.appendChild(n)})}function fill_list_items(e,t,n){("available"==e||"hunting"!=PbxObject.kind&&"icd"!=PbxObject.kind&&"unit"!=PbxObject.kind)&&t.sort();for(var a=document.getElementById(e),o=document.createDocumentFragment(),r=0;r<t.length;r++){var l=n?t[r][n]:t[r],i=document.createElement("li");i.setAttribute("data-value",l),i.innerHTML=l,o.appendChild(i)}a.appendChild(o)}function move_list_item(e){var t=e.target,n=getClosest(t,".selectable-cont"),a=t.parentNode;a.classList.contains("available")?(a.removeChild(t),n.querySelector(".members").appendChild(t)):(a.removeChild(t),n.querySelector(".available").appendChild(t))}function move_list(e,t){var e=isElement(e)?e:document.getElementById(e),t=isElement(t)?t:document.getElementById(t),n=[].slice.call(t.querySelectorAll("li"));n.forEach(function(t){e.appendChild(t)})}function changeGroupType(e){var t=[].slice.call(document.querySelectorAll(".object-type"));t.forEach(function(t){t.classList.contains(e)?t.classList.remove("hidden"):t.classList.add("hidden")})}function newInput(e){var t=document.createElement("div");if(t.className="form-group",e.label){var n='<label for="'+e.id+'">'+e.label+"</label>";t.innerHTML+=n}var a='<input type="'+(e.type||"text")+'" class="form-control" id="'+(e.id||"")+'" value="'+(e.value||"")+'">';return t.innerHTML+=a,t}function get_protocol_opts(e,t){var n="h323"==e?"h323":"sip",a=0!==Object.keys(PbxObject.protocolOpts).length?PbxObject.protocolOpts:t,o=[{mode:"sip info",sel:"sip info"===a.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===a.dtmfmode},{mode:"inband",sel:"inband"===a.dtmfmode}],r=[{mode:"h245alpha",sel:"h245alpha"===a.dtmfmode},{mode:"h245signal",sel:"h245signal"===a.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===a.dtmfmode},{mode:"inband",sel:"inband"===a.dtmfmode}],l={opts:a,frases:PbxObject.frases};l.opts.dtmfmodes="h323"==n?r:o;var i=Mustache.render(PbxObject.templates.protocol,l),s=document.getElementById("proto-cont");s||(s=document.createElement("div"),s.id="proto-cont",$("#pagecontainer").prepend(s)),$(s).html(i);var d=["G.711 Alaw","G.711 Ulaw","G.729","G.723"],c=document.getElementById("protocol-codecs").querySelector("tbody");buildCodecsTable(c,l.opts.codecs,d),new Sortable(c),switch_presentation(n,s),$("#el-protocol").modal(),$("#el-set-protocol").click(function(){save_proto_opts(n)})}function save_proto_opts(e){var t=PbxObject.protocolOpts,n=document.getElementById("protocol-codecs").querySelector("tbody");t.codecs=getCodecsString(n),document.getElementById("t1")&&(t.t1=parseInt(document.getElementById("t1").value)),document.getElementById("t2")&&(t.t2=parseInt(document.getElementById("t2").value)),document.getElementById("t3")&&(t.t3=parseInt(document.getElementById("t3").value)),document.getElementById("t38fax")&&(t.t38fax=document.getElementById("t38fax").checked),document.getElementById("pvideo")&&(t.video=document.getElementById("pvideo").checked),document.getElementById("earlymedia")&&(t.earlymedia=document.getElementById("earlymedia").checked),document.getElementById("dtmfrelay")&&(t.dtmfrelay=document.getElementById("dtmfrelay").checked),t.dtmfmode=document.getElementById("dtmfmode").value,"h323"==e?(t.faststart=document.getElementById("faststart").checked,t.h245tunneling=document.getElementById("h245tunneling").checked,t.playringback=document.getElementById("playringback").checked):(t.nosymnat=document.getElementById("nosymnat").checked,t.buffering=document.getElementById("buffering").checked,t.noprogress=document.getElementById("noprogress").checked,t.noredirectinfo=document.getElementById("noredirectinfo").checked,t.passanumber=document.getElementById("passanumber").checked),$("#el-protocol").modal("hide")}function updateConference(e){var t=e.params,n=document.getElementById(t.oid);if(n){var a=n.querySelector('[data-cell="parties"]');if(a){var o=n.querySelector(".showPartiesBtn");t.total?(a.textContent=t.total,o.removeAttribute("disabled")):(a.textContent="",o.setAttribute("disabled","disabled"))}}var r=PbxObject.channels;r&&r.forEach(function(e){if(e.oid===t.oid){var n=e.parties;1==t.state?(n||(e.parties=n=[]),-1==n.indexOf(t.number)&&n.push(t.number)):0==t.state&&n.splice(n.indexOf(t.number),1)}})}function getInfoFromState(e,t){var n,a;return 1==e?a="success":8==e?a="connected":2==e||5==e?a="warning":0==e||-1==e&&t?(e="",a=""):a=3==e?"danger":6==e||7==e?"info":"active",n=PbxObject.frases.STATES[e]||"",{rstatus:n,rclass:a}}function fill_group_choice(e,t,n){for(var n=n||document.getElementById("extgroup");n.firstChild;)n.removeChild(n.firstChild);json_rpc_async("getObjects",'"kind":"'+e+'"',function(e){var a,o,r,l;if(n)for(l=0;l<e.length;l++)a=e[l].oid,o=e[l].name,r=document.createElement("option"),r.setAttribute("value",a),(a==t||o==t)&&(r.selected="true"),r.innerHTML=e[l].name,n.appendChild(r)})}function change_protocol(){var e=this.value||document.getElementById("protocols").value;"h323"==e?(document.getElementById("sip").parentNode.style.display="none",document.getElementById("h323").parentNode.style.display=""):(document.getElementById("sip").parentNode.style.display="",document.getElementById("h323").parentNode.style.display="none")}function poolArrayToString(e){var t="";return e.forEach(function(e,n){n>0&&(t+=","),t+=e.firstnumber,e.poolsize>1&&(t+="-"+(e.firstnumber+e.poolsize-1))}),t}function poolStringToObject(e){var t=[];return e.split(",").map(function(e){return e.split("-")}).forEach(function(e){t.push({firstnumber:parseInt(e[0]),poolsize:parseInt(e[1]?e[1]-e[0]+1:1)})}),t}function getDeviceSettings(e){var t=e||window.event;t&&t.preventDefault(),PbxObject.deviceSettings?switch_options_tab("deviceopt-tab"):json_rpc_async("getDeviceSettings",null,loadDeviceSettings)}function loadDeviceSettings(e){PbxObject.deviceSettings=e;var t={data:e,lang:PbxObject.frases},n=document.getElementById("device-options"),a=Mustache.render(n.innerHTML,t);document.getElementById("deviceopt-tab").insertAdjacentHTML("beforeend",a),n.parentNode.removeChild(n);var o,r=[];e.sip&&(document.getElementById("sip-log").value=e.sip.log||0,o=document.getElementById("sip-codecs").querySelector("tbody"),buildCodecsTable(o,e.sip.codecs,e.avcodecs),r.push(o)),e.sips&&(document.getElementById("sips-log").value=e.sips.log||0,o=document.getElementById("sips-codecs").querySelector("tbody"),buildCodecsTable(o,e.sips.codecs,e.avcodecs),r.push(o)),e.wss&&(document.getElementById("wss-log").value=e.wss.log||0,o=document.getElementById("wss-codecs").querySelector("tbody"),buildCodecsTable(o,e.wss.codecs,e.avcodecs),r.push(o)),e.http&&(document.getElementById("http-log").value=e.http.log||0),e.system&&(document.getElementById("rec-format").value=e.system.recformat||"PCM 8 Khz 16 bit",e.system.smdr&&(document.getElementById("smdr-host").value=e.system.smdr.host)),setAccordion(),r.forEach(function(e){new Sortable(e)})}function load_pbx_options(e){var t;if(switch_options_tab("mainopt-tab"),PbxObject.config=e.config||[],e.lang)for(var n=document.getElementById("interfacelang"),a=n.options.length-1;a>=0;)n.options[a].value===e.lang&&(n.options[a].selected=!0),a--;customize_upload("musonhold",e.options.holdmusicfile),document.getElementById("adminname").value=e.adminname||"";var o=document.getElementById("firstnumber");if(o.value=e.extensions?poolArrayToString(e.extensions):"",e.options&&(document.getElementById("holdreminterv").value=e.options.holdremindtime||"",document.getElementById("holdrectime").value=e.options.holdrecalltime||"",document.getElementById("transrectime").value=e.options.transferrecalltime||"",document.getElementById("transrecdest").value=e.options.transferrecallnumber||"",document.getElementById("autoretrieve").checked=e.options.autoretrive,document.getElementById("parkrectime").value=e.options.parkrecalltime||"",document.getElementById("parkrecdest").value=e.options.parkrecallnumber||"",document.getElementById("discontime").value=e.options.parkdroptimeout||""),t=document.getElementById("el-set-options"),t.onclick=set_pbx_options,1!==e.mode&&e.prefix){var r=document.getElementById("deviceopt-tab"),l=document.getElementById("deviceopt-btn");r&&r.parentNode.removeChild(r),l&&l.parentNode.removeChild(l),setAccordion()}else getDeviceSettings()}function set_pbx_options(e){var e=e||window.event;e&&e.preventDefault(),1!==PbxObject.options.mode&&PbxObject.options.prefix||setDeviceSettings();var t,n="",a=document.getElementById("adminpass").value,o=document.getElementById("confirmpass").value,r=document.getElementById("interfacelang"),l=document.getElementById("firstnumber"),i=(document.getElementById("lastnumber"),r.options[r.selectedIndex].value);if(!l||!l.value)return void alert(PbxObject.frases.OPTS__POOL_UNSPECIFIED);var s=poolStringToObject(l.value);if(n+='"extensions":'+JSON.stringify(s)+", ",a&&a!==o){if(!o)return alert(PbxObject.frases.OPTS__PWD_CONF_EMPTY),!1;if(o&&o!==a)return alert(PbxObject.frases.OPTS__PWD_UNMATCH),!1}else show_loading_panel();n+='"lang":"'+i+'", ',a&&(n+='"adminpass":"'+a+'", '),n+='"options":{';var d=document.getElementById("musonhold");d.value&&(n+='"holdmusicfile":"'+d.files[0].name+'", ',upload("musonhold")),document.getElementById("holdreminterv").value&&(n+='"holdremindtime":'+document.getElementById("holdreminterv").value+", "),document.getElementById("holdrectime").value&&(n+='"holdrecalltime":'+document.getElementById("holdrectime").value+", "),document.getElementById("transrectime").value&&(n+='"transferrecalltime":'+document.getElementById("transrectime").value+", "),document.getElementById("transrecdest").value&&(n+='"transferrecallnumber":"'+document.getElementById("transrecdest").value+'", '),n+='"autoretrive":'+document.getElementById("autoretrieve").checked+", ",document.getElementById("parkrectime").value&&(n+='"parkrecalltime":'+document.getElementById("parkrectime").value+", "),document.getElementById("parkrecdest").value&&(n+='"parkrecallnumber":"'+document.getElementById("parkrecdest").value+'", '),document.getElementById("discontime").value&&(n+='"parkdroptimeout":'+document.getElementById("discontime").value),n+="}",i!==PbxObject.language?(PbxObject.language=i,window.localStorage.setItem("pbxLanguage",i),t=set_options_success):t=set_object_success,json_rpc_async("setPbxOptions",n,t)}function setDeviceSettings(){var e,t="";t+='"sip":{',document.getElementById("sip-port").value&&(t+='"port":'+document.getElementById("sip-port").value+", "),document.getElementById("sip-log").value&&(t+='"log":'+document.getElementById("sip-log").value+", "),document.getElementById("sip-enabled").value&&(t+='"enabled":'+document.getElementById("sip-enabled").checked+", "),e=document.getElementById("sip-codecs").querySelector("tbody"),t+='"codecs":'+JSON.stringify(getCodecsString(e)),t+="},",t+='"sips":{',document.getElementById("sips-port").value&&(t+='"port":'+document.getElementById("sips-port").value+", "),document.getElementById("sips-log").value&&(t+='"log":'+document.getElementById("sips-log").value+", "),document.getElementById("sips-enabled").value&&(t+='"enabled":'+document.getElementById("sips-enabled").checked+", "),e=document.getElementById("sips-codecs").querySelector("tbody"),t+='"codecs":'+JSON.stringify(getCodecsString(e)),t+="},",t+='"wss":{',document.getElementById("wss-port").value&&(t+='"port":'+document.getElementById("wss-port").value+", "),document.getElementById("wss-log").value&&(t+='"log":'+document.getElementById("wss-log").value+", "),document.getElementById("wss-enabled").value&&(t+='"enabled":'+document.getElementById("wss-enabled").checked+", "),e=document.getElementById("wss-codecs").querySelector("tbody"),t+='"codecs":'+JSON.stringify(getCodecsString(e)),t+="},",t+='"http":{',document.getElementById("http-port").value&&(t+='"port":'+document.getElementById("http-port").value+", "),document.getElementById("http-log").value&&(t+='"log":'+document.getElementById("http-log").value+", "),document.getElementById("http-ssl").value&&(t+='"ssl":'+document.getElementById("http-ssl").checked+", "),t+="},",t+='"nat":{',document.getElementById("stun")&&(t+='"stun":"'+(document.getElementById("stun").value||"")+'", '),document.getElementById("router")&&(t+='"router":"'+(document.getElementById("router").value||"")+'", '),document.getElementById("rtpfirst")&&document.getElementById("rtpfirst").value&&(t+='"rtpfirst":'+document.getElementById("rtpfirst").value+", "),document.getElementById("rtplast")&&document.getElementById("rtplast").value&&(t+='"rtplast":'+document.getElementById("rtplast").value+", "),t+="},",t+='"registrar":{',document.getElementById("minexpires")&&document.getElementById("minexpires").value&&(t+='"minexpires":'+document.getElementById("minexpires").value+", "),document.getElementById("maxexpires")&&document.getElementById("maxexpires").value&&(t+='"maxexpires":'+document.getElementById("maxexpires").value+", "),t+="},",t+='"net":{',document.getElementById("tcptimeout")&&document.getElementById("tcptimeout").value&&(t+='"tcptimeout":'+document.getElementById("tcptimeout").value+", "),document.getElementById("rtptimeout")&&document.getElementById("rtptimeout").value&&(t+='"rtptimeout":'+document.getElementById("rtptimeout").value+", "),document.getElementById("iptos")&&document.getElementById("iptos").value&&(t+='"iptos":'+document.getElementById("iptos").value+", "),t+="},",t+='"system":{',document.getElementById("config-name")&&(t+='"config":"'+(document.getElementById("config-name").value||"")+'", '),document.getElementById("backup-path")&&(t+='"backup":"'+(document.getElementById("backup-path").value||"")+'", '),document.getElementById("rec-path")&&(t+='"store":"'+(document.getElementById("rec-path").value||"")+'", '),document.getElementById("rec-format")&&(t+='"recformat":"'+(document.getElementById("rec-format").value||"")+'", '),t+='"smtp":{',document.getElementById("smtp-host")&&(t+='"host":"'+(document.getElementById("smtp-host").value||"")+'", '),document.getElementById("smtp-port")&&(t+='"port":"'+(document.getElementById("smtp-port").value||"")+'", '),document.getElementById("smtp-username")&&(t+='"username":"'+(document.getElementById("smtp-username").value||"")+'", '),document.getElementById("smtp-password")&&(t+='"password":"'+(document.getElementById("smtp-password").value||"")+'", '),document.getElementById("smtp-from")&&(t+='"from":"'+(document.getElementById("smtp-from").value||"")+'", '),t+="},",t+='"smdr":{',document.getElementById("smdr-port")&&document.getElementById("smdr-port").value&&(t+='"port":'+document.getElementById("smdr-port").value+", "),document.getElementById("smdr-host")&&document.getElementById("smdr-host").value&&(t+='"host":"'+document.getElementById("smdr-host").value+'", '),document.getElementById("smdr-enabled")&&document.getElementById("smdr-enabled").value&&(t+='"state":'+document.getElementById("smdr-enabled").checked+", "),t+="},",t+="},",json_rpc_async("setDeviceSettings",t,null)
}function Pagination(e){this.options=e,this.createPagination=function(e,t){if(this.pagin&&clearTable(this.options.table),this.currentRange=[],!(this.options.pagnum<=1)){var n,e=e||this.options.page,t=t||(this.options.pagnum>this.options.maxpagins?this.options.maxpagins:this.options.pagnum),a=document.querySelector(".pagination-container"),o=document.createElement("ul"),r=document.createElement("p");o.className="pagination custom-pagination",n=document.createElement("li"),n.innerHTML='<a href="#" class="first">&laquo;</a>',o.appendChild(n),n=document.createElement("li"),n.innerHTML='<a href="#" class="prev">-</a>',o.appendChild(n);for(var l=e;t>=l;l++)n=document.createElement("li"),n.innerHTML='<a href="#" data-page="'+l+'">'+l+"</a>",o.appendChild(n),l==t&&(this.lastPage=n),this.currentRange.push(l);for(n=document.createElement("li"),n.innerHTML='<a href="#" class="next">+</a>',o.appendChild(n),n=document.createElement("li"),n.innerHTML='<a href="#" class="last">&raquo;</a>',o.appendChild(n),this.pagin=o,this.paginInfo=r;a.hasChildNodes();)a.removeChild(a.firstChild);a.appendChild(o),a.appendChild(r),o.onclick=this._getSelectedPage.bind(this)}},this._getSelectedPage=function(e){e.preventDefault();var t=e.target,n=this._isPagin(t);n||("next"==t.className?n=this.currentPage+1:"prev"==t.className?n=this.currentPage-1:"first"==t.className?(n=1,this.options.pagnum>=this.options.maxpagins&&this.createPagination(1,this.options.maxpagins)):"last"==t.className&&(n=this.options.pagnum,n>=this.options.maxpagins&&this.createPagination(n-this.options.maxpagins+1,n))),n>this.options.pagnum||1>n||this.selectPage(n)},this.selectPage=function(e){var e=parseInt(e),t=parseInt(e)*parseInt(this.options.rows)-parseInt(this.options.rows),n=e*parseInt(this.options.rows);n=n<this.options.records.length?n:this.options.records.length,this.currentPage=e,clearTable(this.options.table);for(var a=t;n>a;a++)build_records_row(this.options.records[a],this.options.table);if(this.currentRange.length){this.currentRange.indexOf(e)==this.currentRange.length-1||this.currentRange.indexOf(e)==this.currentRange.length-2?this._appendPage():(0==this.currentRange.indexOf(e)||1==this.currentRange.indexOf(e))&&this._prependPage();var o=this.pagin.querySelector("li.active");o&&o.classList.remove("active"),this.pagin.querySelector('a[data-page="'+e+'"]').parentNode.classList.add("active")}this.paginInfo&&(this.paginInfo.innerHTML=PbxObject.frases.FROM2.toLowerCase()+" "+t+" "+PbxObject.frases.TO.toLowerCase()+" "+n+" "+PbxObject.frases.RECORDS.REC.toLowerCase())},this._appendPage=function(){var e=this.currentRange[this.currentRange.length-1]+1;if(!(e>this.options.pagnum)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,a=document.createElement("li");a.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(a,t.nextSibling),this.pagin.removeChild(n),this.currentRange.push(e),this.currentRange.shift()}},this._prependPage=function(){var e=this.currentRange[0]-1;if(!(1>e)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,a=document.createElement("li");a.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(a,n),this.pagin.removeChild(t),this.currentRange.unshift(e),this.currentRange.pop()}},this._destroyPagination=function(){for(;this.pagin&&this.pagin.hasChildNodes();)this.pagin.removeChild(this.pagin.firstChild)},this._isPagin=function(e){return e.getAttribute("data-page")}}function Picker(e,t){var n,a,o,r,l,i=document.getElementById(e),s=PbxObject.frases,d=!1,c=this;this.defaults={defaultOption:"today",interval:!1,actionButton:!0,buttonSize:"sm",buttonColor:"default"},this.defaults=extend({},this.defaults),extend(this.defaults,t),this.date={},this.interval=this.defaults.interval?36e5:null,this.intervalString="hour",this.fields={},this._pickerHandler=function(e){var t,a,o=e.target;"LABEL"===o.nodeName?(t=o.children[0].getAttribute("data-range"),t?(c._setCurrentRange(t),"custom"===t?(d=!0,n.classList.remove("ghosted")):(d=!1,n.classList.add("ghosted"))):(a=o.children[0].getAttribute("data-interval"),a&&("hour"===a?this.interval=36e5:"1/2_hour"===a?this.interval=18e5:"1/4_hour"===a?this.interval=9e5:"day"===a&&(this.interval=864e5),this.intervalString=a))):"BUTTON"===o.nodeName&&("submitButton"===o.name?(d&&c._rangeToString(),c.defaults.submitFunction&&c.defaults.submitFunction()):"selectButton"===o.name&&d&&c._rangeToString(),i.classList.toggle("open"))},this._init=function(){if(i){var e=this.template();i.innerHTML=e,dropdown=i.querySelector(".dropdown-menu"),o=[].slice.call(i.querySelectorAll('input[name="options"]')),a=i.querySelector(".dropdown-button"),btnText=a.querySelector(".btn-text"),n=i.querySelector(".custom-range"),a.onclick=function(){i.classList.toggle("open")},dropdown.onclick=function(e){c._pickerHandler(e)},this._setCurrentRange(this.defaults.defaultOption),r=document.getElementById("custom-range-from"),l=document.getElementById("custom-range-to"),rome(r,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.beforeEq(l)}),rome(l,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.afterEq(r)})}},this._setCurrentRange=function(e){if("today"===e){var t=this.today();this.date.start=t,this.date.end=t+864e5}else"yesterday"===e?(this.date.end=this.today(),this.date.start=this.date.end-864e5):"week"===e?(this.date.end=this.today()+864e5,this.date.start=this.date.end-6048e5):"30_days"===e?(this.date.end=this.today()+864e5,this.date.start=this.date.end-2592e6):"60_days"===e?(this.date.end=this.today()+864e5,this.date.start=this.date.end-5184e6):"custom"===e&&this._setCustomRange();this._setButtonText()},this._rangeToString=function(){var e=rome.find(r).getDateString("MM/DD/YYYY"),t=rome.find(l).getDateString("MM/DD/YYYY");this.date.start=new Date(e).getTime(),this.date.end=new Date(t).getTime(),this._setButtonText()},this.formatDate=function(e,t){var n=("0"+(e.getMonth()+1)).slice(-2),a=("0"+e.getDate()).slice(-2),o=e.getFullYear(),r="mm/dd/yyyy"==t?n+"/"+a+"/"+o:a+"/"+n+"/"+o;return r},this._setCustomRange=function(){var e=this.today(),t=new Date(e),n=new Date(e+864e5);r.value=this.formatDate(t),l.value=this.formatDate(n)},this._setButtonText=function(){btnText.innerHTML=this.formatDate(new Date(this.date.start))+" - "+this.formatDate(new Date(this.date.end))},this._closeDropdowns=function(){i.classList.toggle("open"),removeEvent(document,"click",this._closeDropdowns)},this.today=function(){var e=new Date,t=new Date(this.formatDate(e,"mm/dd/yyyy")).getTime();return t},this.template=function(){return'<button type="button" class="btn btn-'+this.defaults.buttonColor+" btn-"+this.defaults.buttonSize+' btn-block dropdown-button" aria-expanded="true"><span class="btn-text" style="margin-right:5px"></span><span class="caret"></span></button><div class="dropdown-menu"><div class="col-xs-12 btn-group btn-group-vertical" data-toggle="buttons"><label class="btn btn-default active"><input type="radio" name="options" data-range="today"autocomplete="on" checked>'+s.DATE_PICKER.TODAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="yesterday" autocomplete="off" checked>'+s.DATE_PICKER.YESTERDAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="week" autocomplete="off">'+s.DATE_PICKER.LAST_7_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="30_days" autocomplete="off">'+s.DATE_PICKER.LAST_30_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="60_days" autocomplete="off">'+s.DATE_PICKER.LAST_60_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="custom" autocomplete="off">'+s.DATE_PICKER.CUSTOM_RANGE+'</label></div><div class="col-xs-12 custom-range ghosted"><br><div class="input-group"><input type="text" class="form-control" id="custom-range-from"><span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" class="form-control" id="custom-range-to"></div></div>'+(this.defaults.interval?'<div class="col-xs-12 custom-interval"><hr><p>'+s.DATE_PICKER.INTERVAL+'</p><div class="btn-group btn-group-justified" data-toggle="buttons"><label class="btn btn-default"><input type="radio" name="options" data-interval="1/4_hour" autocomplete="off">15'+s.MIN+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="1/2_hour" autocomplete="off">30'+s.MIN+'</label><label class="btn btn-default active"><input type="radio" name="options" data-interval="hour" autocomplete="off" checked>'+s.HOUR+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="day" autocomplete="off">'+s.DAY+"</label></div></div>":"")+'<div class="col-xs-12"><hr>'+(this.defaults.actionButton?'<button type="button" name="submitButton" class="btn btn-primary btn-md btn-block">'+s.SEARCH+"</button>":'<button type="button" name="selectButton" class="btn btn-primary btn-md btn-block">'+s.SELECT+"</button>")+"</div></div>"},this._init()}function Player(){var e,t,n,a,o,r,l,i=!1,s="",d=function(){var i=g();e=document.createElement("div"),e.id="rec-player",e.className="pl-cont",e.innerHTML=i,document.querySelector("body").appendChild(e),t=document.getElementById("pl-seek"),n=document.getElementById("pl-time"),a=document.getElementById("pl-play"),o=document.getElementById("pl-duration"),r=document.getElementById("pl-download"),l=document.getElementById("audio-rec"),c()},c=function(){addEvent(e,"click",function(e){m(e)}),addEvent(l,"playing",function(){a.innerHTML='<i class="fa fa-fw fa-pause"></i>',f.lastEl.innerHTML='<i class="fa fa-fw fa-pause"></i>'},!0),addEvent(l,"loadedmetadata",function(){o.textContent=formatTimeString(parseInt(l.duration),"hh:mm:ss")}),addEvent(l,"pause",function(){a.innerHTML='<i class="fa fa-fw fa-play"></i>',f.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>'},!0),addEvent(l,"timeupdate",u,!0),addEvent(t,"click",function(e){e||(e=window.event),l.currentTime=(l.duration*((e.offsetX||e.layerX)/t.clientWidth)).toFixed(2)},!0)},u=function(){var e=Math.floor(100/l.duration*l.currentTime);n.textContent=formatTimeString(parseInt(l.currentTime),"hh:mm:ss"),t.value=e},m=function(e){e||(e=window.event);var t=e.target;"I"==t.nodeName&&(t=t.parentNode),"pl-play"==t.id&&f.playAudio(),"pl-stop"==t.id&&f.stopAudio(),"pl-close"==t.id&&b()},p=function(){e.classList.add("shown"),i=!0},b=function(){e.classList.remove("shown"),f.stopAudio(),i=!1},g=function(){return'<audio id="audio-rec" type="audio/x-wav; codecs=\'1\'"></audio><div class="pl-controls"><a href="#" download="" class="pl-control bg-success pull-left" id="pl-download"><i class="fa fa-download"></i></a><button class="pl-control bg-primary pull-left" id="pl-play"><i class="fa fa-fw fa-play"></i></button><div class="pl-time"><span id="pl-time"></span>/<span id="pl-duration"></span></div><progress id="pl-seek" max="100" value="0" class-"pl-seek-bar"></progress><button class="pl-control bg-danger pull-right" id="pl-close"><i class="fa fa-fw fa-close"></i></button><button class="pl-control bg-primary pull-right" id="pl-stop"><i class="fa fa-fw fa-stop"></i></button></div>'},f={audioFile:"",audioURL:"",audio:l,lastEl:null,playAudio:function(){i===!1&&p(),this.audioURL!==s&&(l.src=this.audioURL,s=this.audioURL,r.href=this.audioURL,r.setAttribute("download",this.audioFile)),l.paused?l.play():l.pause()},stopAudio:function(){l.pause(),l.currentTime=0}};return d(),f}function load_rec_settings(){json_rpc_async("getVoiceRecordingList","",function(e){getRecObjects(e)}),$("#set-rec-settings").click(function(){setRecObjects()})}function getRecObjects(e){function t(){n+=1,n===a&&fillSelects(o)}var n=0,a=2,o={};o.result=e,json_rpc_async("getObjects",'"kind":"trunk"',function(n){o.trunks=e.trunks?n.filter(function(t){return-1==e.trunks.indexOf(t.name)}):n,t()}),json_rpc_async("getExtensions",null,function(n){o.exts=e.extensions?n.filter(function(t){return-1==e.extensions.indexOf(t.ext)}):n,t()})}function fillSelects(e){$('#trunks-rec-mode input[value="'+e.result.trunksmode+'"]').parent().button("toggle"),$('#ext-rec-mode input[value="'+e.result.extmode+'"]').parent().button("toggle"),e.result.trunks&&fill_list_items("rec-trunks",e.result.trunks),e.result.extensions&&fill_list_items("rec-ext",e.result.extensions),fill_list_items("av-trunks",e.trunks,"name"),fill_list_items("av-ext",e.exts,"ext"),close_options(),set_page(),show_content()}function setRecObjects(){var e="",t=document.querySelector("#trunks-rec-mode label.active input"),n=document.querySelector("#ext-rec-mode label.active input"),a=document.getElementById("rec-trunks"),o=document.getElementById("rec-ext");e+='"trunks":[';for(var r=0;r<a.children.length;r++)e+='"'+a.children[r].innerHTML+'",';e+="],",e+='"extensions":[';for(var r=0;r<o.children.length;r++)e+='"'+o.children[r].innerHTML+'",';e+="],",e+='"trunksmode":'+t.value+",",e+='"extmode":'+n.value+",",json_rpc_async("setVoiceRecordingList",e,function(){set_object_success()})}function load_records(){PbxObject.Pagination=new Pagination,PbxObject.recPicker=new Picker("recs-date-picker",{submitFunction:getRecords,actionButton:!1,buttonSize:"md"});var e=[].slice.call(document.querySelectorAll(".init-mode"));e.forEach(function(e){"0"===e.value&&(e.checked=!0)}),json_rpc_async("getObjects",'"kind":"trunk"',function(e){e.unshift({oid:PbxObject.frases.ALL,name:PbxObject.frases.ALL}),fill_select_items("searchtrunk",e)}),$("#getcalls-btn").click(function(e){getRecords(e)}),$("#sample-data").hide(),$("#search-calls .panel-body").slideToggle(),$("#extendedsearch").click(function(e){e.preventDefault();var t=$(this).closest(".panel"),n=t.find(".panel-body");$(this).text(n.is(":visible")?PbxObject.frases.MORE:PbxObject.frases.LESS),n.slideToggle()}),TableSortable.sortables_init(),show_content()}function build_records_row(e,t){if(e){var n,a=t.rows.length,o=t.insertRow(a),r=e.td;if(n=o.insertCell(0),n.textContent=formatDateString(e.ts),n=o.insertCell(1),n.textContent=e.na,n=o.insertCell(2),n.textContent=e.nb,n=o.insertCell(3),n.textContent=e.nc||"",n.className="nowrap",n.title=e.nc||"",n=o.insertCell(4),e.ta&&(n.textContent=e.ta),n=o.insertCell(5),e.tb&&(n.textContent=e.tb),n=o.insertCell(6),n.textContent=formatTimeString(r,"hh:mm:ss"),n=o.insertCell(7),n.textContent=getFriendlyCodeName(e.cs),n=o.insertCell(8),n.textContent=parseFloat(e.tr).toFixed(2),n=o.insertCell(9),n.textContent=parseFloat(e.ch).toFixed(2),n=o.insertCell(10),e.fi){var l=document.createElement("a");l.href="#",l.setAttribute("data-src",e.fi),l.innerHTML='<i class="fa fa-play fa-fw"></i>',l.onclick=function(e){playRecord(e)},n.appendChild(l)}n=o.insertCell(11),n.innerHTML=e.fi?'<a href="'+window.location.protocol+"//"+window.location.host+"/records/"+e.fi+'" download="'+e.fi+'"><i class="fa fa-fw fa-download"></i></a>':""}}function getRecords(e){show_loading_panel(e.target);var t,n,a,o=document.querySelectorAll(".init-order"),r=document.querySelectorAll(".init-mode"),l=document.getElementById("searchnum"),i=document.getElementById("searchtrunk");for(a=0;a<o.length;a++)o[a].checked&&(t=o[a].value);for(a=0;a<r.length;a++)r[a].checked&&(n=r[a].value);var s="";s+='"begin": '+PbxObject.recPicker.date.start,s+=', "end": '+PbxObject.recPicker.date.end,l.value&&(s+=', "number": "'+l.value+'"'),i.value!==PbxObject.frases.ALL&&(s+=', "trunk": "'+i.options[i.selectedIndex].textContent+'"'),n&&(s+=', "mode": '+n),t&&(s+=', "order": '+t),json_rpc_async("getCalls",s,showRecords)}function showRecords(e){show_content();var t=document.getElementById("records-table").querySelector("tbody"),n=document.getElementById("searchrows");!n.value&&e.length>20&&(n.value=20);for(var a,o=n.value?parseInt(n.value):e.length,r=e.length>o?Math.ceil(e.length/o):1,l=0,i=0;i<e.length;i++)for(a in e[i])"ch"==a&&(l+=parseFloat(e[i][a]));l=l.toFixed(2),$("#sample-data").show(),$("#sample-length").text(e.length),$("#sample-cost").text(l),PbxObject.Pagination.options={table:t,page:1,maxpagins:5,rows:o,records:e,pagnum:r,buildTableFunction:build_records_row},PbxObject.Pagination.createPagination(),PbxObject.Pagination.selectPage(1)}function playRecord(e){e||(e=window.event),e.preventDefault();var t,n=e.currentTarget,a=n.getAttribute("data-src");PbxObject.Player=PbxObject.Player||new Player,t=PbxObject.Player,null!==t.lastEl&&t.lastEl!=n&&(t.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>'),t.lastEl=n,t.audioFile=a,t.audioURL=window.location.protocol+"//"+window.location.host+"/records/"+a,t.playAudio()}function load_reports(){new Reports}function Reports(){var e,t,n=(document.querySelectorAll(".calls-incoming"),document.querySelectorAll(".calls-outgoing"),document.querySelectorAll(".calls-connected"),document.querySelectorAll(".calls-load"),this);this.init=function(){var t,a,o,r;e=new Picker("calls-date-picker",{submitFunction:n.getStatistics,interval:!0,buttonSize:"md"}),t=e.date.start,a=e.date.end,o=e.interval,r='"begin":'+t+', "end":'+a+', "interval":'+o,json_rpc_async("getCallStatisticsGraph",r,function(e){n.createGraph(e),show_content()})},this.getStatistics=function(){$("#reports-cont").addClass("faded");var t=e.date.start,a=e.date.end,o=e.interval,r='"begin":'+t+', "end":'+a+', "interval":'+o;json_rpc_async("getCallStatisticsGraph",r,function(e){n.createGraph(e),$("#reports-cont").removeClass("faded")})},this.createGraph=function(n){if(n.length){for(var a,o,r=[],l=[],i=[],s=[],d=[],c=("1/2_hour"==e.intervalString||"1/4_hour"==e.intervalString?[]:[1,e.intervalString],function(e){return"hour"==e?"%H:%M":"day"==e?"%d %b":"%H:%M"}(e.intervalString)),u=0,m=n.length;m>u;u++)o=n[u],a=o.t,r.push([a,o.i]),l.push([a,o.o]),i.push([a,o.l]),s.push([a,o.m]),d.push([a,o.p]);var p={show:!0,barWidth:e.interval,lineWidth:0,fill:.7};insAndLostData=[{label:PbxObject.frases.STATISTICS.CONNECTEDCALLS,stack:0,bars:p,data:r,color:"#3c763d"},{label:PbxObject.frases.STATISTICS.LOSTCALLS,stack:0,bars:p,data:s,color:"#AA4643"}],l=[{label:PbxObject.frases.SETTINGS.OUTCALLS,bars:p,data:l,color:"#4572A7"}],i=[{label:PbxObject.frases.SETTINGS.INTCALLS,bars:p,data:i,color:"#BADABA"}],d=[{label:PbxObject.frases.STATISTICS.LINES_PAYLOAD,data:d,lines:{show:!0,fill:!1},points:{show:!0},color:"#3c763d"}],t={xaxis:{mode:"time",timeformat:c,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:c}},$.plot($("#outCalls-graph"),l,t),$.plot($("#inAndLost-graph"),insAndLostData,t),$.plot($("#intCalls-graph"),i,t),$.plot($("#linesLoad-graph"),d,t)}else;},this.init()}function load_routes(e){PbxObject.oid=e.oid,PbxObject.routepriorities=["Max. prefix length","Least cost routing","Load balancing","Answer seizure ratio","Average call duration","Most idle gateway","Least utilised gateway","Max. priority (status)"],PbxObject.name=e.name,e.name&&(document.getElementById("objname").value=e.name),document.getElementById("enabled").checked=e.enabled;var t,n=(document.getElementById("rtable"),document.getElementById("priorities")),a=e.priorities;for(t=0;t<a.length;t++){var o=document.createElement("li");o.setAttribute("data-value",a[t]),o.innerHTML=PbxObject.routepriorities[a[t]],n.appendChild(o)}var r=e.anumbertransforms;if(r.length)for(t=0;t<r.length;t++)append_transform(null,"transforms1",r[t]);else append_transform(null,"transforms1");if(r=e.bnumbertransforms,r.length)for(t=0;t<r.length;t++)append_transform(null,"transforms2",r[t]);else append_transform(null,"transforms2");void 0!=e.routes?build_routes_table(e.routes):show_content(),TableSortable.sortables_init(),set_page()}function set_routes(){var e=document.getElementById("objname").value;if(!e)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var t='"name":"'+e+'",';show_loading_panel();var n;PbxObject.name?n=set_object_success:(PbxObject.name=e,n=null),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),t+='"kind":"routes",',t+='"enabled":'+document.getElementById("enabled").checked+",",t+='"priorities":[';var a,o=document.getElementById("priorities");for(a=0;a<o.children.length;a++)t+=o.children[a].getAttribute("data-value")+",";t+="],",t+='"anumbertransforms":[',t+=encode_transforms("transforms1"),t+="],",t+='"bnumbertransforms":[',t+=encode_transforms("transforms2"),t+="],",t+='"routes":[';var r,l,i=document.getElementById("rtable");for(a=1;a<i.rows.length;a++)l=i.rows[a],"route-on-edit"!=l.className&&(r="",r+='"number":"'+l.cells[0].textContent+'",',r+='"description":"'+l.cells[1].textContent+'",',r+='"target":{"oid":"'+l.cells[2].getAttribute("data-gid")+'"},',r+='"priority":'+parseInt(l.cells[3].getAttribute("data-priority"))+",",r+='"cost":'+parseFloat(l.cells[4].textContent)+",",""!=r&&(t+="{"+r+"},"));t+="]",json_rpc_async("setObject",t,n)}function build_routes_table(e){var t,n,a=document.getElementById("rtable").getElementsByTagName("tbody")[0];if("object"==typeof PbxObject.objects?t=PbxObject.objects:(t=json_rpc("getObjects",'"kind":"all"'),sortByKey(t,"name"),PbxObject.objects=t),t=t.filter(function(e){return"equipment"!==e.kind&&"cli"!==e.kind&&"timer"!==e.kind&&"routes"!==e.kind&&"users"!==e.kind&&"pickup"!==e.kind}),!e.length&&t.length)a.appendChild(build_route_row(null,t));else{sortByKey(e,"number"),n=document.createDocumentFragment();for(var o=0;o<e.length;o++)n.appendChild(add_route_row(e[o],t));a.appendChild(n)}show_content()}function add_new_route(e){var e=e||window.event;e&&e.preventDefault();var t=PbxObject.objects.filter(function(e){return"equipment"!==e.kind&&"cli"!==e.kind&&"timer"!==e.kind&&"routes"!==e.kind&&"users"!==e.kind&&"pickup"!==e.kind}),n=document.getElementById("rtable").getElementsByTagName("tbody")[0];n.insertBefore(build_route_row(null,t),n.children[0])}function add_route_row(e,t){var n,a;n=document.createElement("tr"),a=n.insertCell(0),a.textContent=e.number,a=n.insertCell(1),a.textContent=e.description,a.className="nowrap",a.title=e.description||"",a=n.insertCell(2);var o={};for(i=0;i<t.length;i++)t[i].oid==e.target.oid&&(o=t[i],a.setAttribute("data-gid",e.target.oid),a.setAttribute("data-gname",o.name),a.innerHTML='<a href="#'+o.kind+"?"+o.oid+'">'+o.name+"</a>");return a=n.insertCell(3),a.setAttribute("data-priority",e.priority),a.textContent=0==e.priority?"OFF":10==e.priority?"EXV":e.priority,a=n.insertCell(4),a.textContent=parseFloat(e.cost).toFixed(2),a=n.insertCell(5),button=document.createElement("button"),button.className="btn btn-primary btn-sm",button.innerHTML='<i class="fa fa-edit"></i>',addEvent(button,"click",function(){var a=build_route_row(e,t);n.parentNode.insertBefore(a,n),n.style.display="none"}),a.appendChild(button),a=n.insertCell(6),button=document.createElement("button"),button.className="btn btn-danger btn-sm",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",function(t){var n=confirm(PbxObject.frases.DELETE+" "+PbxObject.frases.ROUTE.toLowerCase()+"?");return n?(deleteRoute(e.oid),void remove_row(t)):!1}),a.appendChild(button),n}function build_route_row(e,t){var n,a,o,r,l={},i=document.createElement("tr"),s=document.createElement("td"),d=document.createElement("div"),c=document.createElement("input"),u={};i.className="route-on-edit",d.className="form-group",c.className="form-control",c.setAttribute("type","text"),c.setAttribute("name","number"),c.setAttribute("size","12"),null!=e&&(c.value=e.number,l.oid=e.oid),l.number=c.value,c.onchange=function(){l.number=c.value},d.appendChild(c),s.appendChild(d),i.appendChild(s),s=document.createElement("td");var d=document.createElement("div");d.className="form-group",descr=document.createElement("input"),descr.className="form-control",descr.setAttribute("type","text"),descr.setAttribute("name","description"),null!=e&&(descr.value=e.description),l.description=descr.value,descr.onchange=function(){l.description=descr.value},d.appendChild(descr),s.appendChild(d),i.appendChild(s),s=document.createElement("td");var d=document.createElement("div");d.className="form-group",target=document.createElement("select"),target.className="form-control",target.setAttribute("name","target");for(var m=0;m<t.length;m++)o=t[m].kind,u[o]?n=u[o]:(n=document.createElement("optgroup"),n.setAttribute("label",PbxObject.frases.KINDS[o]),u[o]=n,target.appendChild(n)),r=t[m].oid,a=document.createElement("option"),a.setAttribute("value",r),a.innerHTML=t[m].name,null!=e&&r==e.target.oid&&a.setAttribute("selected",""),n.appendChild(a);t.length&&(l.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent},target.onchange=function(){l.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent}}),d.appendChild(target),s.appendChild(d),i.appendChild(s),s=document.createElement("td");var d=document.createElement("div");d.className="form-group",priority=document.createElement("select"),priority.className="form-control",priority.setAttribute("name","priority");for(var m=0;10>=m;m++){var a=document.createElement("option");a.value=m,null!=e&&m==e.priority&&a.setAttribute("selected",""),a.innerHTML=0==m?"OFF":10==m?"EXV":m,priority.appendChild(a)}e||(priority.selectedIndex=1),d.appendChild(priority),l.priority=priority.options[priority.selectedIndex].value,priority.onchange=function(){l.priority=priority.options[priority.selectedIndex].value},s.appendChild(d),i.appendChild(s),s=document.createElement("td");var d=document.createElement("div");return d.className="form-group",cost=document.createElement("input"),cost.className="form-control",cost.setAttribute("type","text"),cost.setAttribute("name","cost"),cost.setAttribute("size","2"),null!=e?cost.setAttribute("value",parseFloat(e.cost).toFixed(2)):cost.value=parseFloat(0).toFixed(2),l.cost=parseFloat(cost.value).toFixed(2),cost.onchange=function(){l.cost=parseFloat(cost.value).toFixed(2)},d.appendChild(cost),s.appendChild(d),i.appendChild(s),s=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-default btn-sm",button.innerHTML='<i class="fa fa-chevron-left"></i>',addEvent(button,"click",function(){var e=i.nextSibling;e&&"TR"==e.nodeName&&"none"==e.style.display&&(e.style.display="table-row"),i.parentNode.removeChild(i)}),s.appendChild(button),i.appendChild(s),s=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-success btn-sm",button.innerHTML='<i class="fa fa-check"></i>',addEvent(button,"click",function(){var e=document.getElementById("objname").value;if(!e)return void alert(PbxObject.frases.MISSEDNAMEFIELD);var n=i.nextSibling,a=add_route_row(l,t);i.parentNode.insertBefore(a,i),n&&"TR"==n.nodeName&&"none"==n.style.display&&n.parentNode.removeChild(n),i.parentNode.removeChild(i),setRoute(l,set_object_success)}),s.appendChild(button),i.appendChild(s),i}function setRoute(e,t){var n="",a=t||null;e.oid&&(n+='"oid":"'+e.oid+'",'),n+='"groupid":"'+PbxObject.oid+'",',n+='"number":"'+e.number+'",',n+='"description":"'+e.description+'",',n+='"target":{"oid":"'+e.target.oid+'", "name":"'+e.target.name+'"},',n+='"priority":'+e.priority+",",n+='"cost":'+e.cost+",",json_rpc_async("setRoute",n,a)}function deleteRoute(e){var t='"oid":"'+e+'"';json_rpc_async("deleteRoute",t,set_object_success)}function load_statistics(){new Statistics}function Statistics(){var e,t,n,a,o=document.getElementById("trunks-statistics-table"),r=document.getElementById("ext-statistics-table"),l=document.getElementById("ext-stats-btn"),i=document.getElementById("ext-stat-kind"),s=document.getElementById("lost-stats-btn"),d=document.getElementById("dcontainer"),c=[].slice.call(d.querySelectorAll(".data-model")),u="inbound",m=PbxObject.oid,p=!0,b=!0,g=this;this._init=function(){e=new Picker("statistics-date-picker",{submitFunction:g.getStatisticsData,buttonSize:"md"}),t=e.date.start,n=e.date.end,a='"begin":'+t+', "end":'+n,json_rpc_async("getCallStatistics",a,g._setStatistics),l.onclick=function(){"shown"!==l.getAttribute("data-state")?(l.setAttribute("data-state","shown"),g._getExtStatisticsData()):l.setAttribute("data-state","hidden")},i.onclick=function(e){var e=e||window.event,t=e.target;"LABEL"===t.nodeName&&(u=t.children[0].getAttribute("data-kind"),p=!0,g._getExtStatisticsData())},s.onclick=function(){"shown"!==s.getAttribute("data-state")?(s.setAttribute("data-state","shown"),g._getLostStatisticsData()):s.setAttribute("data-state","hidden")},switch_presentation(m),set_page()},this.getStatisticsData=function(){$("#statistics-cont").addClass("faded"),t=e.date.start,n=e.date.end,a='"begin":'+t+', "end":'+n,json_rpc_async("getCallStatistics",a,function(e){g._setStatistics(e),$("#statistics-cont").removeClass("faded")}),p=!0,b=!0,"shown"==l.getAttribute("data-state")&&g._getExtStatisticsData(),"shown"==s.getAttribute("data-state")&&g._getLostStatisticsData()},this._getExtStatisticsData=function(){p&&(p=!1,$("#extStat-cont").addClass("faded"),t=e.date.start,n=e.date.end,a='"begin":'+t+', "end":'+n+', "kind":"'+u+'"',json_rpc_async("getCallStatisticsExt",a,function(e){g._setExtStatistics(e),$("#extStat-cont").removeClass("faded")}))},this._getLostStatisticsData=function(){b&&(b=!1,$("#lostCalls-cont").addClass("faded"),t=e.date.start,n=e.date.end,a='"begin":'+t+', "end":'+n,json_rpc_async("getLostCalls",a,function(e){g._setLostStats(e),$("#lostCalls-cont").removeClass("faded")}))},this._setStatistics=function(e){var t,n=e;n.inbounds.duration=formatTimeString(n.inbounds.duration,"hh:mm:ss"),n.outbounds.duration=formatTimeString(n.outbounds.duration,"hh:mm:ss"),n.internals.duration=formatTimeString(n.internals.duration,"hh:mm:ss"),n.outbounds.cost&&(n.outbounds.cost=n.outbounds.cost.toFixed(2)),c.forEach(function(e){t=e.getAttribute("data-model"),"inbounds.lost"==t&&(0===n.inbounds.lost?e.classList.remove("negtv-col"):e.classList.add("negtv-col"));var a=t.split(".").reduce(objFromString,n);e.textContent=a}),g._build_trunks_statistics(n.trunks),show_content()},this._setExtStatistics=function(e){clearColumns(r);for(var t=0;t<e.length;t++)g._buildExtStatColumn(e[t])},this._setLostStats=function(e){for(var t=document.createDocumentFragment(),n=document.getElementById("lost-calls-table").querySelector("tbody"),a=0;a<e.length;a++)t.appendChild(g._buildLostCallsTable(e[a]));n.appendChild(t)},this._build_trunks_statistics=function(e){var t=o.querySelector("tbody");clearTable(t);for(var n=0;n<e.length;n++)row=t.insertRow(n),cell=row.insertCell(0),cell.textContent=void 0!==e[n].trunk?e[n].trunk:"",cell=row.insertCell(1),cell.textContent=void 0!==e[n]["in"]?e[n]["in"]:"",cell=row.insertCell(2),cell.textContent=void 0!==e[n].insec?formatTimeString(e[n].insec,"hh:mm:ss"):"",cell=row.insertCell(3),cell.textContent=void 0!==e[n].out?e[n].out:"",cell=row.insertCell(4),cell.textContent=void 0!==e[n].outsec?formatTimeString(e[n].outsec,"hh:mm:ss"):"",cell=row.insertCell(5),cell.textContent=void 0!==e[n].cost?e[n].cost.toFixed(2):""},this._buildExtStatColumn=function(e){for(var t,n,a,o=r.querySelector("thead"),l=r.querySelector("tbody"),i=0;i<o.rows.length;i++)t=document.createElement("th"),o.rows[i].appendChild(t),t.innerHTML=e.ext;for(var s=0;s<l.rows.length;s++){switch(n=l.rows[s].insertCell(-1),s){case 0:a="total";
break;case 1:a="connected";break;case 2:a="duration";break;case 3:a="cost"}n.innerHTML=void 0!==e[a]?"duration"===a?formatTimeString(e[a],"hh:mm:ss"):"cost"===a?e[a].toFixed(2):e[a]:""}},this._buildLostCallsTable=function(e){var t,n=document.createElement("tr");return t=n.insertCell(0),t.textContent=formatDateString(e.ts)||"",t=n.insertCell(1),t.textContent=e.na||"",t=n.insertCell(2),t.textContent=e.nb||"",t=n.insertCell(3),t.textContent=e.nc||"",t=n.insertCell(4),t.textContent=getFriendlyCodeName(e.cs)||"",n},this._init()}function load_timer(e){PbxObject.oid=e.oid,PbxObject.name=e.name,e.name&&(document.getElementById("objname").value=e.name),document.getElementById("enabled").checked=e.enabled;var t,n=document.getElementById("hh");for(t=0;24>t;t++){var a=document.createElement("option");if(10>t)var o="0"+t;else o=t;a.value=o,a.innerHTML=o,n.appendChild(a),o==e.hour&&(n.selectedIndex=t)}var r=document.getElementById("mm");for(t=0;55>=t;t+=5){var a=document.createElement("option");if(10>t)var o="0"+t;else o=t;a.value=o,a.innerHTML=o,r.appendChild(a),o==e.minute&&(r.selectedIndex=t/5)}for(t=0;t<e.weekdays.length;t++){var l=document.getElementById("t-d"+e.weekdays[t]);l.checked=!0,"LABEL"===l.parentNode.nodeName&&l.parentNode.classList.add("active")}fill_timer_targets("objects");var i=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t=0;t<e.targets.length;t++)i.appendChild(timer_target_row(e.targets[t].oid,e.targets[t].name,e.targets[t].action));show_content(),set_page();var s=document.getElementById("add-timer-target");s.onclick=function(){add_timer_target()};var d=document.getElementById("timer-range");addEvent(d,"click",check_days)}function set_timer(){var e,t=document.getElementById("objname").value;if(!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',show_loading_panel();var n;PbxObject.name?n=set_object_success:(PbxObject.name=t,n=null),null!=PbxObject.oid&&(e+='"oid":"'+PbxObject.oid+'",'),e+='"kind":"timer",';var a=document.getElementById("enabled");null!=a&&(e+='"enabled":'+a.checked+",");var o=document.getElementById("hh"),r=document.getElementById("mm");e+='"hour":"'+o.options[o.selectedIndex].value+'",',e+='"minute":"'+r.options[r.selectedIndex].value+'",',e+='"weekdays":[';var l;for(l=0;7>l;l++)document.getElementById("t-d"+l).checked&&(e+=l+",");e+="],";var i=document.getElementById("targets").getElementsByTagName("tbody")[0];for(e+='"targets":[',l=0;l<i.children.length;l++){var s=i.children[l];void 0!=s.id&&""!=s.id&&(e+='{"oid":"'+i.children[l].id+'","action":"'+s.children[1].getAttribute("data-action")+'"},')}e+="]",json_rpc_async("setObject",e,n)}function timer_target_row(e,t,n){var a=document.createElement("tr"),o=document.createElement("td"),r=document.createElement("a"),l="Enable"==n?PbxObject.frases.ENABLE:PbxObject.frases.DISABLE;a.id=e,r.href="#",r.onclick=function(t){get_object_link(e),t.preventDefault()},r.innerHTML=t,o.appendChild(r),a.appendChild(o),o=document.createElement("td"),o.textContent=l,o.setAttribute("data-action",n),a.appendChild(o),o=document.createElement("td");var i=document.createElement("button");return i.className="btn btn-danger btn-sm",i.innerHTML='<i class="fa fa-minus"></i>',i.onclick=function(){remove_listener(e)},o.appendChild(i),a.appendChild(o),a}function add_timer_target(){var e=document.getElementsByTagName("tbody")[0],t=document.getElementById("objects"),n=document.getElementById("actions"),a=t.options[t.selectedIndex];e.appendChild(timer_target_row(a.value,a.innerHTML,n.value))}function remove_listener(e){var t,n=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t=0;t<n.children.length;t++)n.children[t].id==e&&n.removeChild(n.children[t])}function fill_timer_targets(e){var t,n,a,o,r,l=document.getElementById(e),i={};"object"==typeof PbxObject.objects?r=PbxObject.objects:(r=json_rpc("getObjects",'"kind":"all"'),sortByKey(r,"name"),PbxObject.objects=r);for(var s=0;s<r.length;s++)a=r[s].kind,"equipment"!=a&&"cli"!=a&&"timer"!=a&&"users"!=a&&(i[a]?t=i[a]:(t=document.createElement("optgroup"),t.setAttribute("label",PbxObject.frases.KINDS[a]),i[a]=t,l.appendChild(t)),o=r[s].oid,n=document.createElement("option"),n.value=o,n.innerHTML=r[s].name,t.appendChild(n))}function check_days(e){var t,n,e=e||window.event,a=e.target.children[0],o=a.value;for(t=0;7>t;t++)n=document.getElementById("t-d"+t),"timer-workdays"===o&&(5===t||6===t)||"timer-holidays"===o&&5>t?(n.checked&&(n.checked=!1),"LABEL"===n.parentNode.nodeName&&n.parentNode.classList.remove("active")):(n.checked=!0,"LABEL"===n.parentNode.nodeName&&n.parentNode.classList.add("active"))}function load_trunk(e){console.log(e);var t=e.type,n=[].slice.call(document.querySelectorAll('[name="trunkType"]'));PbxObject.oid=e.oid,PbxObject.name=e.name,e.name&&(document.getElementById("objname").value=e.name);var a=document.getElementById("enabled");if(a&&(a.checked=e.enabled,e.name&&addEvent(a,"change",function(){json_rpc_async("setObjectState",'"oid":"'+e.oid+'", "enabled":'+this.checked,function(e){"OK"!==e&&(a.checked=!a.checked)})})),e.status){var o=document.getElementById("status");o&&(o.innerHTML=e.status)}if(e.protocol){var r,l="h323"==e.protocol?"h323":"sip",i=document.getElementById("protocols"),s=document.getElementById("get-proto-opts");e.name?(r=document.createElement("option"),r.value=e.protocol,r.textContent=e.protocol,i.appendChild(r)):e.protocols&&(e.protocols.forEach(function(t){r=document.createElement("option"),r.value=t,r.textContent=t,t==e.protocol&&r.setAttribute("selected","selected"),i.appendChild(r)}),addEvent(i,"change",function(){l="h323"==this.value?"h323":"sip",switch_presentation(l)})),addEvent(s,"click",function(){get_protocol_opts(i.value,e.parameters)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={},switch_presentation(l)}n.forEach(function(t){if(t.value===e.type){var n=t.parentNode;t.checked,$(n).button("toggle")}}),e.domain&&(document.getElementById("domain").value=e.domain),document.getElementById("register").checked=e.register,e.user&&("external"===t?document.getElementById("user").value=e.user:document.getElementById("int-trunk-user").value=e.user),e.pass&&("external"===t?document.getElementById("pass").value=e.pass:document.getElementById("int-trunk-pass").value=e.pass),e.auth&&(document.getElementById("auth").value=e.auth),document.getElementById("regexpires").value=e.regexpires||60;var d=document.getElementById("proxy");addEvent(d,"change",function(){for(var e=document.getElementsByName("proxy"),t=0;t<e.length;t++)e[t].disabled=!this.checked}),d.checked=e.proxy;for(var c=document.getElementsByName("proxy"),u=0;u<c.length;u++)c[u].disabled=!e.proxy;if(e.paddr&&(document.getElementById("paddr").value=e.paddr),e.pauth&&(document.getElementById("pauth").value=e.pauth),e.ppass&&(document.getElementById("ppass").value=e.ppass),void 0!=e.maxinbounds&&(document.getElementById("maxinbounds").value=isMaxNumber(e.maxinbounds)?16:e.maxinbounds,document.getElementById("inmode").checked=e.maxinbounds>0),void 0!=e.maxoutbounds&&(document.getElementById("maxoutbounds").value=isMaxNumber(e.maxoutbounds)?16:e.maxoutbounds,document.getElementById("outmode").checked=e.maxoutbounds>0),void 0!=e.parameters){var m=e.parameters.codecs;if(void 0!=m)for(var p,u=0;u<m.length&&(p=document.getElementById("c"+u),p);u++)p.value=m[u].codec,document.getElementById("f"+u).value=m[u].frame;else for(u=0;4>u;u++)document.getElementById("c"+u).selectedIndex=0,document.getElementById("f"+u).value=0}var b=e.inboundanumbertransforms;if(b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms1",b[u]);else append_transform(null,"transforms1");if(b=e.inboundbnumbertransforms,b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms2",b[u]);else append_transform(null,"transforms2");if(b=e.outboundanumbertransforms,b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms3",b[u]);else append_transform(null,"transforms3");if(b=e.outboundbnumbertransforms,b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms4",b[u]);else append_transform(null,"transforms4");switch_presentation(e.type?e.type:"external",null,"pl-trunk-kind"),show_content(),set_page()}function set_trunk(){var e,t,n,a,o=document.getElementById("objname").value,r=document.getElementById("enabled");if(!o)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+o+'",',show_loading_panel(),PbxObject.oid&&(e+='"oid":"'+PbxObject.oid+'",'),PbxObject.name?t=set_object_success:(PbxObject.name=o,t=null),n=[].slice.call(document.querySelectorAll('[name="trunkType"]')),n.forEach(function(e){e.checked&&(a=e.value)}),e+='"kind":"trunk",',e+='"enabled":'+r.checked+",";var l=document.getElementById("protocols").value,i=document.getElementById("register").checked,s=document.getElementById("proxy").checked;e+='"protocol":"'+l+'",',e+='"type":"'+a+'",',"external"===a?(e+='"domain":"'+document.getElementById("domain").value+'",',e+='"register":'+i+",",i&&(e+='"user":"'+document.getElementById("user").value+'",',e+='"auth":"'+document.getElementById("auth").value+'",',e+='"pass":"'+document.getElementById("pass").value+'",',e+='"regexpires":'+document.getElementById("regexpires").value+","),e+='"proxy":'+s+",",s&&(e+='"paddr":"'+document.getElementById("paddr").value+'",',e+='"pauth":"'+document.getElementById("pauth").value+'",',e+='"ppass":"'+document.getElementById("ppass").value+'",')):(e+='"user":"'+document.getElementById("int-trunk-user").value+'",',e+='"pass":"'+document.getElementById("int-trunk-pass").value+'",'),e+=document.getElementById("inmode").checked?'"maxinbounds":'+document.getElementById("maxinbounds").value+",":'"maxinbounds":0,',e+=document.getElementById("outmode").checked?'"maxoutbounds":'+document.getElementById("maxoutbounds").value+",":'"maxoutbounds":0,',e+='"parameters":{';var d=JSON.stringify(PbxObject.protocolOpts);d=d.substr(1,d.length-2),e+=d,e+="},",e+='"inboundanumbertransforms":[',e+=encode_transforms("transforms1"),e+="],",e+='"inboundbnumbertransforms":[',e+=encode_transforms("transforms2"),e+="],",e+='"outboundanumbertransforms":[',e+=encode_transforms("transforms3"),e+="],",e+='"outboundbnumbertransforms":[',e+=encode_transforms("transforms4"),e+="]",console.log(e),json_rpc_async("setObject",e,function(e){"OK"!==e&&(t?t():r.checked&&(r.checked=!1))})}AttObject.prototype.enterAttMenu=function(e){var e=e||window.event;e.preventDefault(),makeActiveCanvas(this.oid)},AttObject.prototype.editObject=function(e){var e=e||window.event;e.preventDefault(),showAttObjectSetts(this.params,this)},AttObject.prototype.removeElement=function(e,t,n){e&&e.preventDefault();var a=this.element.querySelector("#enter-att-menu"),o=this.element.querySelector("#edit-att-object"),r=this.element.querySelector("#remove-att-object");removeTreeBtn=this.element.querySelector("#remove-att-tree"),a&&removeEvent(a,"click",function(){this.enterAttMenu(e,t)}.bind(this)),o&&removeEvent(o,"click",function(){this.editObject(e,t)}.bind(this)),r&&removeEvent(r,"click",function(e){this.removeElement(e)}.bind(this)),removeTreeBtn&&removeEvent(removeTreeBtn,"click",function(e){this.removeElement(e)}.bind(this)),this.element.parentNode.removeChild(this.element),e?(removeObject(this.oid,n),removeFromSchema(this.oid),"0"==this.oid&&createInitButton()):removeObject(this.oid),changeAvailableButtons(t.button)},window.onerror=function(e,t,n){console.error("Error message: "+e+"\nURL: "+t+"\nLine number: "+n)};var PbxObject=PbxObject||{};!function(){var e;if(createWebsocket(),window.localStorage.getItem("pbxOptions")){var t=window.localStorage.getItem("pbxOptions");t=JSON.parse(t),e=t.lang||"en",getTranslations(e),PbxObject.options=t,window.localStorage.removeItem("pbxOptions"),moment.locale(e)}else json_rpc_async("getPbxOptions",null,function(t){e=t.lang||"en",getTranslations(e),PbxObject.options=t,moment.locale(e)})}();