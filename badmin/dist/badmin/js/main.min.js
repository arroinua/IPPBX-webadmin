function load_application(e){PbxObject.oid=e.oid,PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");if(e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})})),e.debug&&(document.getElementById("debug").checked=e.debug),e.dbconnection){var o=e.dbconnection;"sun.jdbc.odbc.JdbcOdbcDriver"==o.driver?(document.getElementById("odbc").checked=!0,o.url&&(document.getElementById("odbcurl").value=o.url)):o.driver&&(document.getElementById("jdbc").checked=!0,document.getElementById("jdbcdriver").value=o.driver,o.url&&(document.getElementById("jdbcurl").value=o.url)),o.schema&&(document.getElementById("dbowner").value=o.schema),o.username&&(document.getElementById("dbuser").value=o.username),o.password&&(document.getElementById("dbpass").value=o.password)}var a=e.parameters;if(a.length)for(var r=0;r<a.length;r++)add_app_row(a[r]);else add_app_row();renderObjRoute({routes:e.routes||[],frases:PbxObject.frases,onChange:setCurrObjRoute}),show_content(),set_page()}function set_application(){show_loading_panel();var e=document.getElementById("appvariables").getElementsByTagName("tbody")[0],t=document.getElementById("objname").value,n='"name":"'+t+'",';n+='"enabled":'+document.getElementById("enabled").checked+",",PbxObject.oid&&(n+='"oid":"'+PbxObject.oid+'",'),n+='"parameters":[';var o,a;for(o=0;o<e.children.length;o++){var r=e.children[o],s=r.getElementsByTagName("input"),i="";for(a=0;a<s.length;a++)if("variable"==s[a].name)i+='"key":"'+s[a].value+'",';else{if("value"!=s[a].name)continue;i+='"value":"'+s[a].value+'",'}""!=i&&(n+="{"+i+"},")}n+="],",n+='"debug":'+document.getElementById("debug").checked+",",n+='"dbconnection":{';var l,c;document.getElementById("odbc").checked?(l="sun.jdbc.odbc.JdbcOdbcDriver",c=document.getElementById("odbcurl").value):(l=document.getElementById("jdbcdriver").value,c=document.getElementById("jdbcurl").value),n+='"driver":"'+l+'",',n+='"url":"'+c+'",',document.getElementById("dbowner")&&(n+='"schema":"'+document.getElementById("dbowner").value+'",'),document.getElementById("dbuser")&&(n+='"username":"'+document.getElementById("dbuser").value+'",'),document.getElementById("dbpass")&&(n+='"password":"'+document.getElementById("dbpass").value+'",'),n+="},",json_rpc_async("setObject",n,function(e){if(set_object_success(e),e&&getTempParams().ext){var n={number:getTempParams().ext,target:{oid:e,name:t}};getTempParams().oid&&(n.oid=getTempParams().oid),console.log("set route params: ",n),setObjRoute(n)}})}function add_app_row(e){var t=document.getElementById("appvariables").getElementsByTagName("tbody")[0],n=document.createElement("tr"),o=document.createElement("td"),a=document.createElement("div");a.className="form-group";var r=document.createElement("input");r.className="form-control",r.setAttribute("type","text"),r.setAttribute("name","variable"),r.setAttribute("disabled","disabled"),e&&e.key&&(r.value=e.key),a.appendChild(r),o.appendChild(a),n.appendChild(o),t.appendChild(n),o=document.createElement("td"),a=document.createElement("div"),a.className="form-group",r=document.createElement("input"),r.className="form-control",r.setAttribute("name","value"),e&&e.value&&(r.value=e.value),a.appendChild(r),o.appendChild(a),n.appendChild(o),t.appendChild(n),t.appendChild(n)}function load_attendant(e){PbxObject.oid=e?e.oid:"",PbxObject.name=e?e.name:"";var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name?n.value=e.name:getObjects(null,function(e){!filterObject(e,"attendant").length}),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})})),e.debug&&(document.getElementById("debug").checked=e.debug),show_content(),set_page(),setInitAttParams(),makeActiveCanvas(),getAttTemplate("attendant_object",function(t){setAttSettings(e.parameters,t)});var o=document.getElementById("addConnector");o.onclick=function(){addConnector()},json_rpc_async("getExtensions",null,function(e){var t=e.filter(function(e){return"trunk"!==e.kind&&"cli"!==e.kind&&"timer"!==e.kind&&"routes"!==e.kind&&"pickup"!==e.kind});PbxObject.attendant.routes=t}),renderObjRoute({routes:e.routes||[],frases:PbxObject.frases,onChange:setCurrObjRoute})}function setInitAttParams(){PbxObject.attendant={currentPid:"",routes:[],connectors:[],objects:{},buttons:["1","2","3","4","5","6","7","8","9","0","#","*"],availableButtons:[],types:{menu:"menu",commutator:"commutator",mail:"mail"}}}function changeAvailableButtons(e,t){var n,o=t||document.querySelector(".att-canvas.active"),a=[];"object"==typeof e?a=[].concat(e):(a=JSON.parse(o.getAttribute("data-available-buttons")),btnIndex=a.indexOf(e),-1!==btnIndex?a.splice(btnIndex,1):a.splice(btnIndex,0,e)),PbxObject.attendant.availableButtons=PbxObject.attendant.buttons.map(function(e){return n={},n.button=e,-1===a.indexOf(e)?n.disabled=!0:n.disabled=!1,n}),o.setAttribute("data-available-buttons",JSON.stringify(a))}function createCanvas(e){var t=document.getElementById("att-container"),n=document.createElement("div");n.className="att-canvas active",void 0!==e&&n.setAttribute("data-parent",e),t.appendChild(n),createInitButton(n),changeAvailableButtons(PbxObject.attendant.buttons),addAttObjects(PbxObject.attendant.objects,e)}function makeActiveCanvas(e){void 0!==e&&(PbxObject.attendant.currentPid=e);var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),o=document.getElementById("toPrevCanvas"),a=!1;n.forEach(function(n){t=n.getAttribute("data-parent"),t===e||!e&&!t?(n.classList.add("active"),a=n):n.classList.remove("active")}),a?changeAvailableButtons(JSON.parse(a.getAttribute("data-available-buttons"))):createCanvas(e),setSchemaActiveEl(e||""),o&&(e&&"hidden"===o.className?o.className="":e||(o.className="hidden")),toTheTop("att-container")}function removeCanvases(e){var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),o=new RegExp(e+"d*");n.forEach(function(e){t=e.getAttribute("data-parent"),o.test(t)&&e.parentNode.removeChild(e)})}function toPrevCanvas(e){e&&e.preventDefault();var t=document.querySelector(".att-canvas.active"),n=t.getAttribute("data-parent"),o=n.substr(0,n.length-1);makeActiveCanvas(o)}function createInitButton(e){var t=document.createElement("div"),n=e||document.querySelector(".att-canvas.active");t.className="dropdown att-init-button",t.innerHTML='<button class="btn btn-default dropdown-toggle dropdown-round" type="button" id="att-obj-types" data-toggle="dropdown" aria-expanded="true"><i class="fa fa-plus"></i></button><ul class="dropdown-menu" role="menu" aria-labelledby="att-obj-types"><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.menu+'"><i class="fa fa-music"></i> '+PbxObject.frases.ATTENDANT.MENU+'</a></li><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.mail+'"><i class="fa fa-envelope"></i>  '+PbxObject.frases.ATTENDANT.MAIL+"</a></li>"+(PbxObject.attendant.currentPid?'<li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.commutator+'"><i class="fa fa-phone"></i>  '+PbxObject.frases.ATTENDANT.COMMUTATOR+"</a></li>":"")+"</ul>",addEvent(t,"click",function(e){e&&e.preventDefault();var t=e.currentTarget,n=e.target;"top"===elPosition(t)?t.className="dropup att-init-button":t.className="dropdown att-init-button","A"!==n.nodeName&&(n=n.parentNode);var o=n.getAttribute("data-type");o&&showAttObjectSetts({type:o})}),n.appendChild(t)}function setInitAttMoveBtns(e){var t=PbxObject.attendant.buttons,n=document.getElementById("moveBack"),o=document.getElementById("moveMmenu");fillBtnsSelectList(t,n,e.moveBack),fillBtnsSelectList(t,o,e.moveMmenu)}function fillBtnsSelectList(e,t,n){var o,a=document.createDocumentFragment();e.forEach(function(e){o=document.createElement("option"),o.value=e,o.innerHTML=e,e===n&&o.setAttribute("selected","selected"),a.appendChild(o)}),t.appendChild(a)}function strToJson(e){var t=new RegExp(/([\d\w]+)(=+)(?!\{)([\d\w@\-_.\s,?!*%$^&#+]*)(?=\,|\})/,"g"),n=new RegExp(/([\d\w#*]+)(=+)(?=\{)/,"g");return e.replace(t,function(e,t,n,o){return"null"!==o&&(o=JSON.stringify(o)),'"'+t+'":'+o}).replace(n,function(e,t,n){return'"'+t+'":'})}function setAttSettings(e,t){var n,o=document.getElementById("attvariables"),a="",r="",s="",i="",l={},c=null;e&&o&&setFormData(o,e),e.forEach(function(e){"jsonString"===e.key?(c=e.value,n=JSON.parse(c),PbxObject.attendant.objects=n):"connectors"===e.key?(c=e.value,addConnectors(JSON.parse(c))):"greetings"===e.key?a=e.value:"ringbackMusic"===e.key?r=e.value:"connectionFailed"===e.key?s=e.value:"leaveMessage"===e.key?i=e.value:"moveBack"===e.key?l.moveBack=e.value:"moveMmenu"===e.key&&(l.moveMmenu=e.value)}),e.length||(l.moveBack="#",l.moveMmenu="*"),customize_upload("attGreetings",a),customize_upload("ringbackMusic",r),customize_upload("connectionFailed",s),customize_upload("leaveMessage",i),setInitAttMoveBtns(l),addAttObjects(n,""),buildSchema(n)}function buildSchema(e){var t,n,o=document.getElementById("att-schema"),a=[];addToSchema("home",{name:'<i class="fa fa-home"></i>',type:PbxObject.attendant.types.menu},o);for(key in e)e.hasOwnProperty(key)&&a.push(e[key]);sortByKey(a,"oid"),a.forEach(function(e){t=e.oid.substr(0,e.oid.length-1),n="0"===e.oid?o.querySelector('ul[data-oid="home"]'):o.querySelector('ul[data-oid="'+t+'"]'),addToSchema(e.oid,e,n)}),addEvent(o,"click",setAttPosition)}function addToSchema(e,t,n){var o,a,r=e.substr(0,e.length-1);a=n?n:"0"!==e?document.querySelector('#att-schema ul[data-oid="'+r+'"]'):document.querySelector('#att-schema ul[data-oid="home"]'),o=createSchemaBranch(e,t),a.appendChild(o)}function createSchemaBranch(e,t){var n=document.createElement("li");return n.setAttribute("data-oid",e),t.type===PbxObject.attendant.types.menu?("home"===e&&(n.className="active"),n.innerHTML='<label class="fa fa-minus" for="t-'+e+'"></label><input type="checkbox" name="tree-node" id="t-'+e+'"/> <a href="#'+("home"===e?"":e)+'">'+t.name+(t.button?'<small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>":"")+'</a><ul data-oid="'+e+'"></ul>'):(n.innerHTML=t.name,t.button&&"null"!==t.button&&(n.innerHTML+=' <small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>")),n}function rebuildSchema(){var e=document.getElementById("att-schema");e.children[0]&&e.removeChild(e.children[0]),buildSchema(PbxObject.attendant.objects),setSchemaActiveEl(PbxObject.attendant.currentPid)}function removeFromSchema(e){var t=document.querySelector('#att-schema li[data-oid="'+e+'"]');t.parentNode.removeChild(t)}function setSchemaActiveEl(e){var t=document.getElementById("att-schema"),n=t.querySelector('li a[href="#'+e+'"]'),o=t.querySelector("li.active");n&&(o&&(o.className=""),n.parentNode.className="active")}function addAttObjects(e,t){if(e)for(key in e)e.hasOwnProperty(key)&&key.substr(0,key.length-1)==t&&addAttObject(e[key])}function addAttObject(e,t){var n,o=new AttObject(e),a=document.querySelector(".att-canvas.active"),r=PbxObject.attendant.currentPid+(e.button?e.button:0);if(e.button)changeAvailableButtons(e.button,a);else{var s=a.querySelector(".att-init-button");s&&isMainEl()&&s.parentNode.removeChild(s)}t?(a.insertBefore(o,t.element),t.removeElement(null,t.params),t.params.button!==e.button&&(n=PbxObject.attendant.currentPid+t.params.button,changeObjectsParent(n,r))):a.insertBefore(o,a.lastChild),e.oid=r,PbxObject.attendant.objects[r]!==e&&(PbxObject.attendant.objects[r]=e,t?rebuildSchema():addToSchema(r,e))}function AttObject(e){var t=formAttParams(e),n=PbxObject.templates.attendant_object,o=Mustache.render(n,t),a=document.createElement("div"),r=PbxObject.attendant.currentPid+(e.button?e.button:0);a.className="att-obj-wrapper",a.innerHTML=o;var s=a.querySelector("#enter-att-menu"),i=a.querySelector("#edit-att-object"),l=a.querySelector("#remove-att-object");return removeTreeBtn=a.querySelector("#remove-att-tree"),s&&addEvent(s,"click",function(t){this.enterAttMenu(t,e)}.bind(this)),i&&addEvent(i,"click",function(t){this.editObject(t,e)}.bind(this)),l&&addEvent(l,"click",function(t){this.removeElement(t,e)}.bind(this)),removeTreeBtn&&addEvent(removeTreeBtn,"click",function(t){this.removeElement(t,e,!0)}.bind(this)),this.oid=r,this.params=e,this.element=a,a}function removeObject(e,t){var n=PbxObject.attendant.objects,o=(document.getElementById("objname").value,t?new RegExp(e+"d*"):new RegExp("^"+e+"$"));for(var a in n)n.hasOwnProperty(a)&&o.test(a)&&delete n[a];removeCanvases(e)}function changeObjectsParent(e,t){var n=PbxObject.attendant.objects,o=new RegExp(e+"d*"),a="";for(var r in n)n.hasOwnProperty(r)&&o.test(r)&&(a=r.replace(e,t),n[a]=n[r],n[a].oid=a,delete n[r])}function checkParams(e){var t="";return e.button||isMainEl()||(t+=PbxObject.frases.ATT__BTN_MISSED+"\n"),e.type===PbxObject.attendant.types.menu||e.connector||(t+=PbxObject.frases.ATT__CONN_MISSED+"\n"),e.type!==PbxObject.attendant.types.menu||e.file||(t+=PbxObject.frases.ATT__AUDIO_FILE_MISSED+"\n"),""!==t?(alert(t),!1):!0}function showAttObjectSetts(e,t){var n=formAttParams(e);console.log("showAttObjectSetts data: ",n),getAttTemplate("attendant_modal",function(o){var a=Mustache.render(o,n);r||(r=document.createElement("div"),r.id="att-setts-cont",$("#pagecontainer").prepend(r)),$(r).html(a);var r=document.getElementById("att-setts-cont"),s=document.getElementById("att-setts-data"),i=document.querySelector('#att-setts-form select[name="data"]'),l=document.querySelector('#att-setts-form select[name="button"]');i&&e.connector&&(i.value=e.connector),l&&e.button&&(l.value=e.button),e.type===PbxObject.attendant.types.menu&&customize_upload("audioFile",e.data||""),$("#set-att-object").on("click",function(n){setAttObject(e,t)}),$('#att-setts-modal [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),s&&ReactDOM.render(Select3({name:"data",placeholder:PbxObject.frases.ATTENDANT.DATA_PLACEHOLDER,frases:PbxObject.frases,value:{value:n.data.data,label:n.data.data},options:n.connectors}),s),$("#att-setts-modal").on("shown.bs.modal",function(){document.querySelector('#att-setts-modal input[name="name"]').focus()}),$("#att-setts-modal").on("hide.bs.modal",function(){$('#att-setts-modal [data-toggle="popover"]').popover("destroy"),$("#set-att-object").off("click",function(n){setAttObject(e,t)})}),$("#att-setts-modal").modal()})}function setAttObject(e,t){var n=collectAttParams(e);checkParams(n)&&(t?addAttObject(n,t):addAttObject(n),$("#att-setts-modal").modal("hide"))}function collectAttParams(e){var t,n=document.getElementById("att-setts-cont"),o=e.type,a=(o===PbxObject.attendant.types.menu?"input":"select",{});if(isMainEl()?a.button=null:a.button=n.querySelector('select[name="button"]').value,a.name=n.querySelector('input[name="name"]').value||generateAttObjName(o,a.button),a.type=o,o===PbxObject.attendant.types.menu){var r=n.querySelector('input[type="file"]'),s=n.querySelector('[name="digits"]');r&&(r.files.length?(a.file=r,a.data=r.files[0].name):e.file&&(a.file=e.file)),!a.data&&e.file&&(a.data=e.file.files[0].name),a.digits=s.checked?"14":"1"}else t=n.querySelector('[name="data"]').value,a.data=t,a.connector=t;if(o===PbxObject.attendant.types.mail){var i=n.querySelector('input[name="subject"]'),l=n.querySelector('textarea[name="body"]');a.subject=i.value,a.body=l.value}return a}function formAttParams(e){var t={data:e,pid:PbxObject.attendant.currentPid,connectors:[],buttons:PbxObject.attendant.availableButtons,frases:PbxObject.frases,typeMenu:function(){return this.data.type==PbxObject.attendant.types.menu},typeCommutator:function(){return this.data.type==PbxObject.attendant.types.commutator},typeEmail:function(){return this.data.type==PbxObject.attendant.types.mail},allowMultipleDigits:function(){return"14"===this.data.digits?!0:!1},objType:function(){return this.frases.ATTENDANT[this.data.type.toUpperCase()]}};return t.data.name=t.data.name||generateAttObjName(t.data.type,t.pid),e.type===PbxObject.attendant.types.commutator?(t.connectors=PbxObject.attendant.connectors.filter(function(e){return-1===e.ext.indexOf("@")}),t.connectors=t.connectors.concat(PbxObject.attendant.routes)):e.type===PbxObject.attendant.types.mail&&(t.connectors=PbxObject.attendant.connectors.filter(function(e){return console.log("fliter: ",e),-1!==e.ext.indexOf("@")})),t.connectors=t.connectors.map(formatConnectors),sortByKey(t.connectors,"ext"),t}function formatConnectors(e){return{value:e.ext,label:e.name?e.ext+" - "+e.name:e.ext}}function generateAttObjName(e,t,n){var o="";return o=PbxObject.attendant.currentPid||n?n||PbxObject.frases.ATTENDANT[e.toUpperCase()]:e===PbxObject.attendant.types.menu?PbxObject.frases.ATTENDANT.MAIN_MENU:PbxObject.frases.ATTENDANT.MAIL,console.log("generateAttObjPath: ",o),o}function generateAttObjPath(e){return e.replace("0","").split("").reduce(function(e,t){return e+"."+t})}function setAttPosition(e){var e=e||window.event;if(e){var t=e.target;if("LABEL"===t.nodeName&&("fa fa-plus"===t.className?t.className="fa fa-minus":t.className="fa fa-plus"),"A"!==t.nodeName&&(t=t.parentNode),"A"===t.nodeName){e.preventDefault();var n=t.href.substr(t.href.indexOf("#")+1);t.hash;makeActiveCanvas(n)}}}function addConnectors(e){var t=document.getElementById("attconnectors").querySelector("tbody");e.forEach(function(e){t.appendChild(createConnectorRow(e)),PbxObject.attendant.connectors.push(e)})}function addConnector(e){var e=e||window.event;e&&"click"==e.type&&e.preventDefault();var t=document.getElementById("attconnectors"),n=t.querySelector("tbody"),o=t.querySelector('input[name="connName"]'),a=t.querySelector('input[name="connVal"]'),r=PbxObject.attendant.connectors,s={};return Utils.validateElement(o,o.parentNode),Utils.validateElement(a,a.parentNode),a.value&&o.value?(s={name:o.value,ext:a.value},n.appendChild(createConnectorRow(s)),o.value="",a.value="",void r.push(s)):!1}function removeConnector(e){var t=PbxObject.attendant.connectors;t.forEach(function(n,o){n.name===e.name&&t.splice(o,1)})}function createConnectorRow(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,o,a=document.createElement("tr");return n=a.insertCell(0),e&&e.name&&(n.textContent=e.name),n=a.insertCell(1),e&&e.ext&&(n.textContent=e.ext),n=a.insertCell(2),o=document.createElement("a"),o.href="#",o.className="remove-clr",o.innerHTML='<i class="fa fa-close"></i>',addEvent(o,"click",function(t){remove_row(t),removeConnector(e)}),n.appendChild(o),a}function getAttTemplate(e,t){PbxObject.templates=PbxObject.templates||{};var n=PbxObject.templates[e];n?t(n):$.get("/badmin/views/"+e+".html",function(n){PbxObject.templates[e]=n,t(n)})}function filterByPattern(e,t){if(t){var n=new RegExp(t),o=e.filter(function(e){return n.test(e.ext)});return o}return e}function isMainEl(){return PbxObject.attendant.currentPid?!1:!0}function set_attendant(){var e,t=document.getElementById("objname").value,n=(document.querySelector(".att-container"),PbxObject.attendant.objects),o=retrieveFormData(document.getElementById("attvariables")),a=document.getElementById("attGreetings"),r=document.getElementById("ringbackMusic"),s=document.getElementById("connectionFailed"),i=document.getElementById("leaveMessage"),l=PbxObject.options.prefix,c="users"+(l?"/"+l:"")+"/attendant/"+t+"/";if(a.files[0]&&upload(a,"/attendant/"+t+"/"+a.files[0].name),r.files[0]&&upload(r,"/attendant/"+t+"/"+r.files[0].name),s.files[0]&&upload(s,"/attendant/"+t+"/"+s.files[0].name),i.files[0]&&upload(i,"/attendant/"+t+"/"+i.files[0].name),!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',PbxObject.oid&&(e+='"oid":"'+PbxObject.oid+'",'),e+='"kind":"attendant",';var d=document.getElementById("enabled");null!=d&&(e+='"enabled":'+d.checked+","),e+='"debug":'+document.getElementById("debug").checked+",",e+='"parameters":[',e+="{",e+='"key":"algdir",',e+='"value":"'+c+'"',e+="},";var u;for(var m in n)n.hasOwnProperty(m)&&(u=n[m].file,u&&(u.files.length&&upload(u,"/attendant/"+t+"/"+u.files[0].name),delete n[m].file));e+="{",e+='"key":"jsonString",',e+='"value":'+JSON.stringify(n),e+="},",e+="{",e+='"key":"connectors",',e+='"value":'+JSON.stringify(PbxObject.attendant.connectors),e+="},";for(var m in o)o.hasOwnProperty(m)&&(e+="{",e+='"key":"'+m+'",',e+='"value":"'+o[m]+'"',e+="},");e+="],",json_rpc_async("setObject",e,function(e){if(set_object_success(e),e&&getTempParams().ext){var n={number:getTempParams().ext,target:{oid:e,name:t}};getTempParams().oid&&(n.oid=getTempParams().oid),console.log("set route params: ",n),setObjRoute(n)}})}function load_bgroup(e){console.log("load_bgroup: ",e),switch_presentation(e.kind);var t,n=document,o=e.kind,a=e.members,r=n.getElementById("dcontainer"),s=document.getElementById("enabled"),i=document.getElementById("new-user-form"),l=$(".object-name .switch"),c=e.available;if(c&&(c=c.sort(),PbxObject.available=c),PbxObject.oid=e.oid,PbxObject.name=e.name,getObjects(null,function(e){updateTempParams({tour:!0})}),e.name&&(n.getElementById("objname").value=e.name),s&&(s.checked=e.enabled,addEvent(s,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(s.checked=!s.checked)})})),"users"===o||"equipment"===o){var d=document.getElementById("group-extensions").querySelector("tbody"),u=document.getElementById("available-users"),m=document.getElementById("group-protocol"),p=document.getElementById("get-proto-opts"),b=(document.getElementById("new-user-form"),document.getElementById("clear-input"),document.getElementById("add-user")),g="users"===o?"user":"phone";if("equipment"==o){var f=e.options.protocols||e.options.protocol;if("object"==typeof f)f.forEach(function(e){m.innerHTML+='<option value="'+e+'">'+e+"</option>"});else{var h=m.parentNode,v=document.createElement("span");v.className="form-control-static",v.textContent=f,h.insertBefore(v,m),h.removeChild(m)}addEvent(p,"click",function(){get_protocol_opts(e.options.protocol||m.value,e.options)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={}}c&&c.length?makeElement(c.sort(),u,function(e){var t=document.createElement("option");return t.value=e,t.textContent=e,t}):b.setAttribute("disabled","disabled"),addEvent(i,"submit",function(e){e.preventDefault(),addUser(g,function(){cleanForm("new-user-form")})});makeElement(sortByKey(a,"number"),d,addMembersRow),PbxObject.members=a||[],PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer?$("#from-directory-btn").show():$("#from-directory-btn").hide()}else c&&fill_list_items("available",c),a&&fill_list_items("members",a),renderObjRoute({routes:e.routes||[],frases:PbxObject.frases,onChange:setCurrObjRoute});if(e.options)if("equipment"==o){var y=document.getElementById("devtype"),x=document.getElementById("group-protocol"),E=e.options.kind||"ipphones",O=document.getElementById("tr-register"),j=document.getElementById("tr-proxy");y.value=E,e.options.protocol||(x.value="sip"),switch_options_tab("tab-"+E),y.onchange=function(){E=this.options[this.selectedIndex].value,switch_options_tab("tab-"+E),switchVisibility(l,"trunk"===E)},1!==PbxObject.options.mode||PbxObject.options.prefix?(y.removeChild(y.children[y.children.length-1]),l.hide(),console.log(l)):switchVisibility(l,"trunk"===E),void 0!==e.options.gateway&&(n.getElementById("regname").value=e.options.gateway.regname||"",n.getElementById("regpass").value=e.options.gateway.regpass||""),"trunk"==E&&(document.getElementById("tr-domain").value=e.options.trunk.domain||"",document.getElementById("tr-user").value=e.options.trunk.user||"",document.getElementById("tr-auth").value=e.options.trunk.auth||"",document.getElementById("tr-pass").value=e.options.trunk.pass||"",document.getElementById("tr-regexpires").value=e.options.trunk.regexpires||60,O.checked=e.options.trunk.register,isVisible("reg-setts",O.checked),j.checked=e.options.trunk.proxy,isVisible("proxy-setts",j.checked),document.getElementById("tr-paddr").value=e.options.trunk.paddr||"",document.getElementById("tr-pauth").value=e.options.trunk.pauth||"",document.getElementById("tr-ppass").value=e.options.trunk.ppass||""),n.getElementById("phonelines").value=e.options.phonelines||"1",void 0!=e.options.starflash&&(n.getElementById("starflash").checked=e.options.starflash),addEvent(O,"change",function(e){isVisible("reg-setts",this.checked)}),addEvent(j,"change",function(e){isVisible("proxy-setts",this.checked)})}else if("unit"==o){if(n.getElementById("groupno1").value=e.options.groupno||"",n.getElementById("timeout1").value=e.options.timeout||"",void 0!==e.options.huntmode){var I=n.getElementById("huntmode1");I.selectedIndex=e.options.huntmode,addEvent(I,"change",function(){checkHuntMode()}),checkHuntMode()}void 0!==e.options.huntfwd&&(n.getElementById("huntfwd1").checked=e.options.huntfwd);var B=e.options.greeting||"",k=e.options.waitmusic||"";customize_upload("unit-greeting",B),customize_upload("unit-waitmusic",k)}else if("pickup"==o)n.getElementById("groupno2").value=e.options.groupno||"";else if("conference"==o||"channel"==o||"selector"==o){var C=["OFF","320x240","352x288","640x360","640x480","704x576","1024x768","1280x720","1920x1080"],w=document.getElementById("initmode");w&&(w.onchange=function(){2==w.options[w.selectedIndex].value?document.getElementById("conf-greetfile").style.display="block":document.getElementById("conf-greetfile").style.display="none"}),PbxObject.videomax=e.options.maxvideomode;var P=e.options.onholdfile||"";customize_upload("onhold2",P);var _=e.options.greetingfile||"";if(customize_upload("greeting2",_),"channel"==o){var T,S=[].slice.call(r.querySelectorAll('input[name="objectType"]')),A=document.getElementById("out-number"),N=document.getElementById("channel-type-sel"),L=document.getElementById("video");S.forEach(function(t){if(e.external){if("global"==t.value){var n=t.parentNode;t.checked=!0,$(n).button("toggle"),T=t.value}A.value=e.external}else if("local"==t.value){var n=t.parentNode;t.checked=!0,$(n).button("toggle"),T=t.value}N.onclick=function(e){var e=e||window.event,t=e.target;"LABEL"===t.nodeName&&(T=t.children[0].value,changeGroupType(T))}}),L&&("OFF"!==e.options.videomode?L.checked=!0:L.checked=!1),w&&(w.value=e.options.initmode);var D=e.options.musiconback||"";document.getElementById("playmusiconback").checked=D?!0:!1,customize_upload("musiconback",D),changeGroupType(T)}else if("selector"==o){var R=e.owner,M=document.getElementById("owner");w&&(w.value=e.options.initmode),2==e.options.initmode?document.getElementById("conf-greetfile").style.display="block":document.getElementById("conf-greetfile").style.display="none",initcalls.checked=e.options.initcalls;var q=c.concat(e.members).sort();q.forEach(function(e){R&&e==R?M.innerHTML+='<option value="'+e+'" selected>'+e+"</option>":M.innerHTML+='<option value="'+e+'">'+e+"</option>"})}n.getElementById("dialuptt").value=e.options.dialtimeout||"",n.getElementById("autoredial").checked=e.options.autoredial,"channel"!==o&&(n.getElementById("confrecord").checked=e.options.recording);var H=n.getElementById("playgreet");H.checked=e.options.greeting,H.checked&&(H.checked=e.options.greetingfile?!0:!1);var U=n.getElementById("videoform");if(U)for(t=0;t<C.length;t++){var F=n.createElement("option");if(F.value=C[t],F.innerHTML=C[t],U.appendChild(F),C[t]==e.options.videomode&&(U.selectedIndex=t),C[t]==e.options.maxvideomode)break}var z=document.getElementById("confrecord"),G=document.getElementById("rectime-cont"),Y=document.getElementById("rectime");addEvent(z,"change",function(e){this.checked?G.classList.remove("hidden"):G.classList.add("hidden")}),z&&void 0!==e.options.recording&&(z.checked=e.options.recording,z.checked&&G.classList.remove("hidden")),Y&&void 0!==e.options.rectime&&(Y.value=e.options.rectime/60)}if(void 0!=e.profile){n.getElementById("forwarding")&&(n.getElementById("forwarding").checked=e.profile.forwarding),n.getElementById("callpickup")&&(n.getElementById("callpickup").checked=e.profile.callpickup),n.getElementById("dndover")&&(n.getElementById("dndover").checked=e.profile.dndover),n.getElementById("busyover")&&(n.getElementById("busyover").checked=e.profile.busyover),n.getElementById("monitor")&&(n.getElementById("monitor").checked=e.profile.monitor),n.getElementById("dnd")&&(n.getElementById("dnd").checked=e.profile.dnd),n.getElementById("clir")&&(n.getElementById("clir").checked=e.profile.clir),n.getElementById("pickupdeny")&&(n.getElementById("pickupdeny").checked=e.profile.pickupdeny),n.getElementById("busyoverdeny")&&(n.getElementById("busyoverdeny").checked=e.profile.busyoverdeny),n.getElementById("monitordeny")&&(n.getElementById("monitordeny").checked=e.profile.monitordeny),n.getElementById("callwaiting")&&(n.getElementById("callwaiting").checked=e.profile.callwaiting),n.getElementById("outcallbarring")&&(n.getElementById("outcallbarring").checked=e.profile.outcallbarring),n.getElementById("costroutebarring")&&(n.getElementById("costroutebarring").checked=e.profile.costroutebarring),n.getElementById("recording")&&(n.getElementById("recording").checked=e.profile.recording),n.getElementById("hiderecind")&&(n.getElementById("hiderecind").checked=e.profile.hiderecindication),n.getElementById("voicemail")&&(n.getElementById("voicemail").checked=e.profile.voicemail);var K=e.profile.bnumbertransforms;if(0!=K.length)for(t=0;t<K.length;t++)append_transform(null,"transforms",K[t]);else append_transform(null,"transforms")}if(TableSortable.sortables_init(),show_content(),set_page(),$(".select2").select2(),PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer.trim().length&&(PbxObject.LdapConnection=Ldap({domains:PbxObject.options.ldap.directoryDomains.split(" "),available:PbxObject.available,onaddusers:onAddLdapUsers}),$("#from-directory-btn").click(function(){PbxObject.LdapConnection.auth()})),"users"===o){var J=PbxObject.options.services.filter(function(e){return e.state});J.length?$("#services-cont").append(J.map(createServiceBtn)):(!PbxObject.options.ldap||PbxObject.options.ldap&&!PbxObject.options.ldap.directoryServer)&&$("#add-external-user").hide(),qparams=getQueryParams(),window.sessionStorage.getItem("lastURL")&&qparams.service_id&&qparams.service_type&&(getExternalUsers(qparams.service_id,parseInt(qparams.service_type,10)),window.sessionStorage.removeItem("lastURL"))}}function onAddLdapUsers(e){if(!PbxObject.name)return void set_bgroup(e,onAddLdapUsers);console.log("onAddUsers: ",e);var t=PbxObject.LdapConnection;document.getElementById("available-users");t.setUsers({groupid:PbxObject.oid,username:t.options.username,password:t.options.password,domain:t.options.domain,users:e},function(e){console.log("addLdapUsers result: ",e),t.close(),refreshUsersTable(function(e){t.options.available=e})})}function createServiceBtn(e){var t;return t=document.createElement("button"),addEvent(t,"click",function(t){getExternalUsers(e.id,e.type,e.props)}),t.className="btn btn-link btn-default padding-lg ellipsis",t.innerHTML="<span>"+e.name+"</span>",t}function getExternalUsers(e,t,n){1===t?(PbxObject.LdapConnection=Ldap({service_id:e,service_type:t,available:PbxObject.available,onaddusers:setExternalUsers}),PbxObject.LdapConnection.getExternalUsers()):json_rpc_async("getExternalUsers",{service_id:e},function(e){console.log("getExternalUsers result: ",e)})}function setExternalUsers(e){if(!PbxObject.name)return void set_bgroup(e,setExternalUsers);console.log("setExternalUsers: ",e);var t=PbxObject.LdapConnection;t.setExternalUsers({groupid:PbxObject.oid,service_id:t.options.service_id,users:e},function(e){console.log("addLdapUsers result: ",e),t.close(),refreshUsersTable(function(e){t.options.available=e})})}function set_bgroup(e,t){var n,o,a,r=document,s=PbxObject.oid,i=PbxObject.kind,l=r.getElementById("members"),c=r.getElementById("profile"),d=r.getElementById("playgreet"),u=r.getElementById("objname").value,m=document.getElementById("enabled"),p=[].slice.call(document.querySelectorAll('input[name="objectType"]'));
if(!u)return void alert(PbxObject.frases.MISSEDNAMEFIELD);if(n='"name":"'+u+'",',show_loading_panel(),PbxObject.name?o=set_object_success:(PbxObject.name=u,o=null),s&&(n+='"oid":"'+s+'",'),i&&(n+='"kind":"'+i+'",'),n+='"enabled":'+m.checked+",","users"!=i&&"equipment"!=i){n+='"members":[';for(var b=0;b<l.children.length;b++)n+='"'+l.children[b].innerHTML+'",';n+="],"}if("users"==i||"equipment"==i){n+='"members":[';for(var b=0;b<PbxObject.members.length;b++)n+='"'+PbxObject.members[b].number+'",';n+="],"}if("channel"==i){if(p.forEach(function(e){e.checked&&(a=e.value)}),"global"==a){d.checked=!1;var g=document.getElementById("out-number");n+='"external":"'+g.value+'",'}}else if("selector"==i){var f=document.getElementById("owner").options[document.getElementById("owner").selectedIndex].value;n+='"owner":"'+f+'",'}else if(("users"==i||"unit"==i||"equipment"==i)&&c){n+='"profile":{',null!=r.getElementById("forwarding")&&(n+='"forwarding":'+r.getElementById("forwarding").checked+","),null!=r.getElementById("callpickup")&&(n+='"callpickup":'+r.getElementById("callpickup").checked+","),null!=r.getElementById("dndover")&&(n+='"dndover":'+r.getElementById("dndover").checked+","),null!=r.getElementById("busyover")&&(n+='"busyover":'+r.getElementById("busyover").checked+","),null!=r.getElementById("monitor")&&(n+='"monitor":'+r.getElementById("monitor").checked+","),null!=r.getElementById("dnd")&&"users"!==i&&(n+='"dnd":'+r.getElementById("dnd").checked+","),null!=r.getElementById("recording")&&(n+='"recording":'+r.getElementById("recording").checked+","),null!=r.getElementById("hiderecind")&&(n+='"hiderecindication":'+r.getElementById("hiderecind").checked+","),null!=r.getElementById("callwaiting")&&"users"!==i&&(n+='"callwaiting":'+r.getElementById("callwaiting").checked+","),null!=r.getElementById("pickupdeny")&&(n+='"pickupdeny":'+r.getElementById("pickupdeny").checked+","),null!=r.getElementById("monitordeny")&&(n+='"monitordeny":'+r.getElementById("monitordeny").checked+","),null!=r.getElementById("busyoverdeny")&&(n+='"busyoverdeny":'+r.getElementById("busyoverdeny").checked+","),null!=r.getElementById("voicemail")&&(n+='"voicemail":'+r.getElementById("voicemail").checked+","),null!=r.getElementById("outcallbarring")&&(n+='"outcallbarring":'+r.getElementById("outcallbarring").checked+","),null!=r.getElementById("costroutebarring")&&(n+='"costroutebarring":'+r.getElementById("costroutebarring").checked+",");var h=r.getElementById("transforms").getElementsByTagName("tbody")[0];h&&(n+='"bnumbertransforms":[',n+=encode_transforms("transforms"),n+="]"),n+="},"}if(n+='"options":{',"equipment"==i){var v=JSON.stringify(PbxObject.protocolOpts);v=v.substr(1,v.length-2);var y=document.getElementById("devtype"),x=y.options[y.selectedIndex].value,E=document.getElementById("group-protocol");if(E&&(n+='"protocol":"'+E.options[E.selectedIndex].value+'",'),"ipphones"==x)n+='"kind":"ipphones",';else if("gateway"==x)n+='"kind":"gateway",',n+='"gateway":{',n+='"regname":"'+r.getElementById("regname").value+'",',n+='"regpass":"'+r.getElementById("regpass").value+'",',n+="},";else if("trunk"==x){var O=document.getElementById("tr-register").checked,j=document.getElementById("tr-proxy").checked;n+='"kind":"trunk",',n+='"trunk":{',n+='"domain":"'+document.getElementById("tr-domain").value+'",',n+='"register":'+O+",",O&&(n+='"user":"'+document.getElementById("tr-user").value+'",',n+='"auth":"'+document.getElementById("tr-auth").value+'",',n+='"pass":"'+document.getElementById("tr-pass").value+'",',n+='"regexpires":'+document.getElementById("tr-regexpires").value+","),n+='"proxy":'+j+",",j&&(n+='"paddr":"'+document.getElementById("tr-paddr").value+'",',n+='"pauth":"'+document.getElementById("tr-pauth").value+'",',n+='"ppass":"'+document.getElementById("tr-ppass").value+'",'),n+="},"}r.getElementById("phonelines")&&(n+='"phonelines":'+r.getElementById("phonelines").value+","),r.getElementById("starflash")&&(n+='"starflash":'+r.getElementById("starflash").checked+","),n+=v}else if("unit"==i){n+='"groupno":"'+r.getElementById("groupno1").value+'",',n+='"timeout":'+r.getElementById("timeout1").value+",",n+='"huntmode":'+r.getElementById("huntmode1").value+",",n+='"huntfwd":'+r.getElementById("huntfwd1").checked+",";var I=document.getElementById("unit-greeting"),B=document.getElementById("unit-waitmusic");I.value&&(I.files[0]&&(n+='"greeting":"'+I.files[0].name+'",'),upload("unit-greeting")),B.value&&(B.files[0]&&(n+='"waitmusic":"'+B.files[0].name+'",'),upload("unit-waitmusic"))}else if("pickup"==i)n+='"groupno":"'+r.getElementById("groupno2").value+'",';else if("conference"==i||"channel"==i||"selector"==i){var k=document.getElementById("initmode"),C=k.options[k.selectedIndex].value,d=r.getElementById("playgreet");if(file2=document.getElementById("greeting2"),n+='"autoredial":'+r.getElementById("autoredial").checked+",",n+='"recording":'+r.getElementById("confrecord").checked+",",n+='"greeting":'+d.checked+",",r.getElementById("rectime")&&r.getElementById("confrecord").checked&&(n+='"rectime":'+60*r.getElementById("rectime").value+","),d.checked&&file2.value&&(file2.files[0]&&(n+='"greetingfile":"'+file2.files[0].name+'",'),upload("greeting2")),"channel"!=i&&(n+='"dialtimeout":'+r.getElementById("dialuptt").value+",",n+='"videomode":"'+r.getElementById("videoform").value+'",'),"selector"==i){var w=document.getElementById("initcalls");n+='"initcalls":'+w.checked+",",2==C&&(file3=document.getElementById("onhold2"),file3.value&&(file3.files[0]&&(n+='"onholdfile":"'+file3.files[0].name+'",'),upload("onhold2")))}if("channel"==i){var P=document.getElementById("playmusiconback").checked;if(n+='"playmusiconback":'+P+",",P){var _=document.getElementById("musiconback");_.files[0]&&(n+='"musiconback":["'+_.files[0].name+'"],'),upload("musiconback")}var T=document.getElementById("video");n+=T.checked?'"videomode":"640x480",':'"videomode":"OFF",'}n+='"initmode":'+C+","}n+="}",json_rpc_async("setObject",n,function(n){if("function"==typeof o&&o(),"function"==typeof t&&t(e),n||(m.checked=!1),n&&getTempParams().ext){var a={number:getTempParams().ext,target:{oid:n,name:u}};getTempParams().oid&&(a.oid=getTempParams().oid),console.log("set route params: ",a),setObjRoute(a)}})}function setObjRoute(e){setRoute(e)}function renderObjRoute(e){ReactDOM.render(ObjectRoute({routes:e.routes,frases:e.frases,onChange:e.onChange}),document.getElementById("object-route-cont"))}function setCurrObjRoute(e){console.log("setCurrObjRoute: ",e),updateTempParams(e)}function addMembersRow(e){var t,n,o,a,r,s;return t=document.createElement("tr"),a=getInfoFromState(e.state,!0),r=a.rstatus,s=a.rclass,t.id=e.oid,n=t.insertCell(0),e.oid?(t.setAttribute("data-ext",e.number),o=document.createElement("a"),o.textContent=e.number,o.href="#",addEvent(o,"click",get_extension),n.appendChild(o)):n.textContent=e.number,n=t.insertCell(1),n.setAttribute("data-cell","name"),n.textContent=e.name||"",n=t.insertCell(2),n.setAttribute("data-cell","display"),n.textContent=e.display||"",n=t.insertCell(3),n.setAttribute("data-cell","reg"),n.textContent=e.followme||e.reg||"",n=t.insertCell(4),n.setAttribute("data-cell","status"),n.innerHTML='<span class="label label-'+a.className+'">'+r+"</span>",n=t.insertCell(5),button=document.createElement("button"),button.className="btn btn-link btn-danger btn-md",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",delete_extension),n.appendChild(button),t}function addUser(e,t){var n,o,a,r=r||window.event,s=document.getElementById("group-extensions").querySelector("tbody"),i=document.getElementById("available-users"),l=i.options,c=document.getElementById("user-name"),d=document.getElementById("user-login"),u=document.getElementById("user-email"),m=document.getElementById("user-alias"),p=document.getElementById("user-pass"),b=document.getElementById("storelimit");if(l.length){if(!PbxObject.name)return void set_bgroup(e,addUser);n=i.options[i.selectedIndex].value,o=c.value||PbxObject.frases.KINDS[e]+" "+n,login=d.value,email=u.value,a=m?m.value:o;var g='"kind":"'+e+'",';g+='"groupid":"'+PbxObject.oid+'",',login&&(g+='"login":"'+login+'",'),email&&(g+='"info": { "email": "'+email+'" },'),g+='"number":"'+n+'",',g+='"name":"'+o+'",',g+='"display":"'+a+'",',g+='"password":"'+p.value+'",',b=convertBytes(parseFloat(b.value),"GB","Byte"),b>=0&&(g+='"storelimit":'+b+",");var f={kind:e,groupid:PbxObject.oid,number:n,name:o,display:a,password:p.value};json_rpc_async("setObject",g,function(e){if(e){f.oid=e;var o=addMembersRow(f),a=s.rows;a.length?s.insertBefore(o,s.firstChild):s.appendChild(o),PbxObject.members.push(f),-1!==PbxObject.available.indexOf(n)&&PbxObject.available.splice(PbxObject.available.indexOf(n),1);for(var r=document.getElementById("select2-available-users-container"),l=([].slice.call(i.options),0);l<i.options.length;l++)i.options[l].value===n&&(i.removeChild(i.options[l]),r&&(i.options.length?r.textContent=i.options[0].value:r.textContent=""));if(!i.options.length){var c=document.getElementById("add-user");c.setAttribute("disabled","disabled")}$("#new-user-form").trigger("users.create"),t&&t()}})}}function refreshUsersTable(e){var t=document.getElementById("available-users");json_rpc_async("getObject",{oid:PbxObject.oid},function(n){PbxObject.available=n.available.sort(),makeElement(sortByKey(n.members,"number"),document.getElementById("group-extensions").querySelector("tbody"),addMembersRow,!0),makeElement(PbxObject.available.sort(),t,function(e){var t=document.createElement("option");return t.value=e,t.textContent=e,t},!0),$(t).trigger("change"),remove_loading_panel(),e&&e(PbxObject.available)})}function cleanForm(e){var t=document.getElementById(e);t.reset()}function checkHuntMode(e){var t;t=e?e.target:document.getElementById("huntmode1"),0==t.selectedIndex?document.getElementById("huntmodesetts").classList.add("hidden"):document.getElementById("huntmodesetts").classList.remove("hidden")}function load_billing(){function e(){return window.StripeCheckout?t():($.ajaxSetup({cache:!0}),void $.getScript("https://checkout.stripe.com/checkout.js",t))}function t(){b=StripeCheckout.configure({key:"pk_test_XIMDHl1xSezbHGKp3rraGp2y",image:"/badmin/images/Ringotel_emblem_new.png",locale:"auto",token:function(e){console.log("stripe token: ",e),p=e}}),window.addEventListener("popstate",function(){b.close()})}function n(){ReactDOM.render(BillingComponent({options:PbxObject.options,profile:f,sub:h,frases:PbxObject.frases,plans:v,invoices:y,discounts:x,addCard:a,editCard:r,renewSub:s,onPlanSelect:l,updateLicenses:c,extend:deepExtend,addCoupon:i}),g)}function o(e){b.open({email:f.email,name:"Ringotel",zipCode:!0,allowRememberMe:!1,panelLabel:"Add card",closed:e})}function a(e){o(function(t){if(console.log("addCard closed: ",t),!p)return e(null);var n={service:"stripe",token:p.id,card:p.card};billingRequest("addCard",n,function(t,n){console.log("saveCard response: ",t,p,n),t||n.error?(notify_about("error",t.message||n.error.message),e(null)):e(p),p=null})})}function r(e){o(function(t){if(console.log("editCard closed: ",t),!p)return e(null);var n={service:"stripe",token:p.id,card:p.card};billingRequest("updateCard",n,function(t,n){console.log("updateCard response: ",t,p,n),t||n.error?(notify_about("error",t.message||n.error.message),e(null)):e(p),p=null})})}function s(e){show_loading_panel(),billingRequest("renewSubscription",{subId:h._id},function(t,n){console.log("renewSubscription response: ",t,n),show_content(),(t||n.error)&&notify_about("error",t.message||n.error.message),e(t,n)})}function i(e){billingRequest("addCoupon",{coupon:e},function(t,o){return console.log("addCoupon response: ",t,e,o),t?notify_about("error",t.message):(x.push(o),void n())})}function l(e){console.log("changePlan: ",e),showModal("confirm_payment_modal",e,function(t,o){console.log("confirm_payment_modal submit:",t),show_loading_panel(),billingRequest("changePlan",{subId:h._id,planId:e.plan.planId},function(e,t){return show_content(),e?notify_about("error",e.message):(console.log("changePlan: ",e,t),$(o).modal("toggle"),h=t.result,void n())})})}function c(e){console.log("updateLicenses: ",e),showModal("confirm_payment_modal",e,function(t,o){console.log("confirm_payment_modal submit:",t),show_loading_panel(),billingRequest("updateSubscription",{subId:h._id,addOns:e.addOns,quantity:e.quantity},function(e,t){return show_content(),e?notify_about("error",e.message):(console.log("updateLicenses: ",e,t),$(o).modal("toggle"),h=t.result,void n())})})}function d(e,t){billingRequest("getPlans",{currency:e},function(n,o){return console.log("getPlans response: ",n,e,o),n?t(n):void(t&&t(null,o.result||[]))})}function u(e){billingRequest("getInvoices",null,function(t,n){return console.log("getInvoices response: ",t,n),t?e(t):void(e&&e(null,n.result||[]))})}function m(e){billingRequest("getDiscounts",null,function(t,n){return console.log("getDiscounts response: ",t,n),t?e(t):void(e&&e(null,n.result||[]))})}console.log("load_billing"),close_options();var p,b,g=document.getElementById("el-loaded-content"),f={},h={},v=[],y=[],x=[];e(),billingRequest("getSubscription",null,function(e,t){return console.log("getSubscription response: ",e,t.result),e?notify_about("error",e.message):(h=t.result,void billingRequest("getProfile",null,function(e,t){return console.log("getProfile: ",e,t),e?notify_about("error",e.message):(f=t.result,void d(f.currency,function(e,t){return e?notify_about("error",e.message):(v=t,n(),m(function(e,t){return e?notify_about("error",e.message):(x=t,void u(function(e,t){return e?notify_about("error",e.message):(y=t,console.log("invoices: ",y),void n())}))}),void show_content())}))}))})}function load_certificates(){PbxObject.options.mode&&0!==PbxObject.options.mode?$("#createCertBtn").click(createCert):$("#createCertBtn").remove(),$("#importCertBtn").click(importCert),getCertificates(),set_page()}function getCertificates(){json_rpc_async("getCertificates",null,function(e){fillCertTable(e)})}function fillCertTable(e){if(e){var t=document.querySelector("#certificates tbody");e.forEach(function(e){t.appendChild(createCertRow(e))}),close_options(),show_content()}}function createCertRow(e){var t,n,o,a=document.createElement("tr");return t=a.insertCell(0),n=document.createElement("a"),n.href="#",n.innerHTML=e,addEvent(n,"click",function(t){downloadCert(t,e)}),t.appendChild(n),t=a.insertCell(1),o=document.createElement("button"),o.className="btn btn-default btn-sm",o.innerHTML='<i class="fa fa-eye"></i>',addEvent(o,"click",function(){showCert(e)}),t.appendChild(o),t=a.insertCell(2),o=document.createElement("button"),o.className="btn btn-danger btn-sm",o.innerHTML='<i class="fa fa-remove"></i>',addEvent(o,"click",function(){removeCert(e)}),t.appendChild(o),a.setAttribute("data-cert",e),a}function downloadCert(e,t){var n=e.target;n.getAttribute("download")||(e.preventDefault(),json_rpc_async("getCertificate",{alias:t},function(e){n.setAttribute("download","certificate.pem"),n.href="data:text/plain;charset=utf-8,"+e,n.click()}))}function createCert(){openModal({tempName:"create_cert",modalId:"createCertModal"},function(){$("#createCert").click(function(){addNewCert()})})}function addNewCert(){var e=document.getElementById("newCertForm"),t=retrieveFormData(e);t&&0!==Object.keys(t).length&&(t.V=parseInt(t.V),json_rpc_async("createCertificate",t,function(e){e&&(fillCertTable([t.CN]),$("#createCertModal").modal("hide"))}))}function importCert(){openModal({tempName:"import_cert",modalId:"importCertModal",data:{certonly:0===PbxObject.options.mode}},function(){$("#importCert").click(function(){importNewCert()})})}function importNewCert(){var e=document.getElementById("importCertForm"),t=retrieveFormData(e);console.log("certInfo: ",t),t&&0!==Object.keys(t).length&&json_rpc_async("setCertificate",t,function(e){if("OK"===e){$("#importCertModal").modal("hide");var t=document.querySelector("#certificates tbody");clearTable(t),getCertificates()}})}function showCert(e){json_rpc_async("getCertificate",{alias:e},function(t){openModal({tempName:"show_cert",modalId:"showCertModal",data:{name:e,certificate:t}})})}function removeCert(e){json_rpc_async("removeCertificate",{alias:e},function(t){var n=document.querySelector('#certificates tbody tr[data-cert="'+e+'"]');n.parentNode.removeChild(n)})}function load_channel_records(){ChannelRecords(),show_content()}function ChannelRecords(){function e(e){var t={oid:window.location.hash.substr(window.location.hash.indexOf("?")+1),begin:e.begin,end:e.end},n={};json_rpc_async("getChannelRecords",t,function(e){n.records=e,json_rpc_async("getChannelEvents",t,function(e){n.events=e,$(document).trigger("channelRecords:data",[n])})})}function t(e){json_rpc_async("getChannelState",{oid:window.location.hash.substr(window.location.hash.indexOf("?")+1),time:e},function(t){console.log("getChannelState: ",e,t),$(document).trigger("channelRecords:state",[t])})}function n(e,t){console.log("onNewData: ",t),S.innerText=t.records.length,A.innerText=t.events.length,combined=w(t.records,t.events),console.log("combined: ",combined),combined.length&&(clearTable(R),lastEvents=[],s(t.events,R),y(combined))}function o(e,t){console.log("onNewEvent: ",t),-1===lastEvents.indexOf(t.channelEvent.timecode)&&(lastEvents.push(t.channelEvent.timecode),s([t.channelEvent],M),c(t.channelEvent))}function a(e,t){[].forEach.call(R.children,function(e){parseInt(e.getAttribute("data-event"),10)===t.channelEvent.timecode?e.classList.add("list-group-item-success"):e.classList.remove("list-group-item-success")})}function r(e,t){console.log("onChannelState: ",t),clearTable(M),clearTable(q),onlineElements={},lastEvents=[],s(t,M),t.forEach(c)}function s(e,t){console.log("addEventsTo: ",e);var n=document.createDocumentFragment();e.forEach(function(e){n.insertBefore(i(e),n.firstChild)}),t.insertBefore(n,t.firstChild)}function i(e,t){var n=document.createElement("li");return icon=document.createElement("i"),user=document.createElement("span"),evt=document.createElement("span"),time=document.createElement("span"),n.className="list-group-item",n.setAttribute("data-event",e.timecode),icon.className="fa fa-fw fa-"+k(e.event),user.innerText=e.user+" ",evt.innerText=PbxObject.frases.CHANNEL_EVENTS[e.event.toString()],time.innerText=moment(e.timecode).format("DD/MM/YY HH:mm:ss"),time.className="pull-right",n.appendChild(icon),n.appendChild(user),n.appendChild(evt),n.appendChild(time),n}function l(e,t){var n=document.createElement("li");return user=document.createElement("span"),n.className="list-group-item",n.setAttribute("data-event",e.timecode),user.innerText=e.user+" ",n.appendChild(user),n}function c(e){console.log(e);var t;onlineElements[e.user]||(t=l(e),q.appendChild(t),onlineElements[e.user]=t),t=$(onlineElements[e.user]),25===e.event?t.show():26===e.event?t.hide():27===e.event?(t.remove(),$(q).prepend(t),t.addClass("list-group-item-success")):28===e.event?t.removeClass("list-group-item-success"):29===e.event?t.addClass("list-group-item-danger"):30===e.event&&t.removeClass("list-group-item-danger")}function d(e,n){console.log("onPlaying: ",n,P.audio.currentTime),0!==n.trackIndex||P.audio.currentTime||t(Math.floor(n.track.timecode+n.currentTime)),F.innerText=n.track.file,z.innerText=n.trackIndex+1,G.innerHTML='<i class="fa fa-fw fa-pause"></i>'}function u(){console.log("onPause"),G.innerHTML='<i class="fa fa-fw fa-play"></i>'}function m(e,n){console.log("onSeeked: ",n),t(Math.floor(n.track.timecode+(n.currentTime||0)))}function p(e){var t=(P.duration*((e.offsetX||e.layerX)/Y.clientWidth)).toFixed(2);console.log("seek click: ",t),O(t)}function b(e,t){console.log("onInit: ",t);var n=t.playlist[t.playlist.length-1],o=n.timecode+1e3*n.duration;console.log("onInit: ",n,o),U.textContent=moment(o).format("DD/MM/YY HH:mm:ss")}function g(e,t){N.href=t.src,N.setAttribute("download",t.src)}function f(e){var t,n=e.target;"span"===n.nodeName&&(n=n.parentNode),t=n.getAttribute("data-event"),console.log(t),j(t)}function h(e){var t=e||window.event,n=t.target;"I"===n.nodeName&&(n=n.parentNode),"cpl-play"===n.id&&P.play(),"cpl-stop"===n.id&&P.stop(),"cpl-prev"===n.id&&P.prev(),"cpl-next"===n.id&&P.next()}function v(){$(document).on("player:init",b),$(document).on("player:seeked",m),$(document).on("player:timeupdate",x),$(document).on("player:timeupdate",E),$(document).on("player:playing",d),$(document).on("player:pause",u),$(document).on("player:next",m),$(document).on("player:prev",m),$(document).on("player:ended",I),$(document).on("player:trackchange",g),$(document).on("channelRecords:data",n),$(document).on("channelRecords:event",o),$(document).on("channelRecords:event",a),$(document).on("channelRecords:state",r),$(document).on("channelRecords:viewchange",B),addEvent(K,"click",h),addEvent(Y,"click",p),addEvent(J,"click",function(t){e({begin:moment(_.value).valueOf(),end:moment(T.value).valueOf()})}),addEvent(V,"change",function(e){$(document).trigger("channelRecords:viewchange",[{online:this.checked}])}),addEvent(R,"click",f),addEvent(M,"click",f)}function y(e){P.playlist=e,P.duration=(e[e.length-1].timecode+1e3*e[e.length-1].duration-e[0].timecode)/1e3,P.init().playTrack()}function x(e,t){var n=0===t.currentTime?0:Math.floor(100/t.duration*t.currentTime);Y.value=n}function E(e,t){var n=t.track.timecode,o=n+1e3*P.audio.currentTime;C(combined[t.trackIndex].events,o),H.textContent=moment(o).format("DD/MM/YY HH:mm:ss")}function O(e){var t=combined[0].timecode+1e3*e;combined.forEach(function(e,n,o){t>=e.timecode&&t<e.timecode+1e3*e.duration&&(console.log("playByCurrentTime: ",t,e),P.playTrack(n,(t-e.timecode)/1e3))})}function j(e){combined.forEach(function(t,n,o){e>=t.timecode&&e<o[n+1].timecode&&(console.log("playByTimecde: ",e,n,t),P.playTrack(n,(e-t.timecode)/1e3))})}function I(e,t){P.playTrack(P.trackIndex+1)}function B(e,t){t.online?(D.classList.add("hidden"),L.classList.remove("hidden")):(D.classList.remove("hidden"),L.classList.add("hidden"))}function k(e){var t="";switch(e){case 25:t="rss";break;case 26:t="sign-out";break;case 27:t="microphone";break;case 28:t="microphone-slash";break;case 29:t="close";break;case 30:t="check"}return t}function C(e,t){var n=Math.floor(t/1e3);e.forEach(function(e){n===Math.floor(e.timecode/1e3)&&$(document).trigger("channelRecords:event",[{channelEvent:e,timeSeconds:n}])})}function w(e,t){function n(e){var n=e.timecode+1e3*e.duration;e.events=[];for(var o=a;o<t.length;o++){if(!(t[o].timecode<=n)){a=o;break}e.events.push(t[o])}return e}for(var o=[],a=0,r=0;r<e.length;r++)o.push(n(e[r]));return o}PbxObject.ChannelPlayer=PbxObject.ChannelPlayer||new ChannelPlayer({audio:document.getElementById("channel-audiorec")});var P=PbxObject.ChannelPlayer,_=document.getElementById("date-from"),T=document.getElementById("date-to"),S=document.getElementById("cpl-recs"),A=document.getElementById("cpl-events"),N=document.getElementById("cpl-download"),L=document.getElementById("online-events-cont"),D=document.getElementById("offline-events-cont"),R=document.getElementById("range-events"),M=document.getElementById("channel-events"),q=document.getElementById("online-events"),H=(document.getElementById("channel-state"),document.getElementById("cpl-time")),U=document.getElementById("cpl-duration"),F=document.getElementById("cpl-currentFile"),z=document.getElementById("cpl-currentTrack"),G=document.getElementById("cpl-play"),Y=document.getElementById("cpl-seek"),K=document.getElementById("cpl-controls"),J=document.getElementById("cpl-submit-btn"),V=document.getElementById("events-view");combined=[],begin=moment().subtract(30,"minutes"),end=moment(),lastEvents=[],onlineElements={},$("#channel-player-cont").affix({offset:{top:200}}),rome(_,{initialValue:begin}),rome(T,{initialValue:end}),v(),e({begin:begin.valueOf(),end:end.valueOf()})}function ChannelPlayer(e){"use strict";if(!e.audio)throw"audio is undefined";return this.audio=e.audio,this.path=window.location.protocol+"//"+window.location.host+"/records/"||e.path,this.playlist=e.playlist||[],this.trackIndex=0,this.initEvents()}function load_channels(e){for(var t,n=document.getElementById("channels").getElementsByTagName("tbody")[0],o=document.createDocumentFragment(),a=[],r=0;r<e.length;r++)"channel"===e[r].kind&&(t=createChannelRow(e[r]),o.appendChild(t),a.push(e[r]));n.appendChild(o),PbxObject.channels=a,add_search_handler(),show_content(),addEvent(n,"click",tableClickHandler)}function tableClickHandler(e){var t,e=e||window.event,n=e.target;"BUTTON"!==n.nodeName&&(n=n.parentNode),t=n.className,-1!=t.indexOf("showPartiesBtn")?showParties(n):-1!=t.indexOf("deleteObjBtn")&&delete_extension(e)}function createChannelRow(e){var t,n,o=document.createElement("tr"),a=getInfoFromState(e.state,e.group),r=a.rstatus,s=a.rclass;return t=o.insertCell(0),e.oid?(n=document.createElement("a"),n.href="#"+e.kind+"?"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,t=o.insertCell(1),t.setAttribute("data-cell","name"),t.textContent=e.name||"",t=o.insertCell(2),t.setAttribute("data-cell","status"),t.textContent=r||"",t=o.insertCell(3),t.setAttribute("data-cell","parties"),e.parties&&(t.textContent=e.parties.length||""),t=o.insertCell(4),button=createNewButton({type:"popover",classname:"btn btn-primary btn-sm showPartiesBtn",placement:"left",dataTrigger:"focus",content:'<i class="fa fa-user"></i>'}),t.appendChild(button),e.parties||(button.disabled="disabled"),t=o.insertCell(5),t.innerHTML='<a type="button" class="btn btn-primary btn-sm" href="#channel_records?'+e.oid+'"><i class="fa fa-history"></i></a>',t=o.insertCell(6),e.oid&&(button=createNewButton({title:PbxObject.frases.DELETE,classname:"btn btn-danger btn-sm deleteObjBtn",content:'<i class="fa fa-trash"></i>'}),t.appendChild(button)),o.id=e.oid,o.setAttribute("data-ext",e.ext),o.className=s,o}function showParties(e){var t,n,o=getClosest(e,"tr"),a=PbxObject.channels,r="";a.forEach(function(e){e.oid===o.id&&(n=e.parties,n&&(t=n.length,n.sort(),n.forEach(function(e,n){r+=e,n!=t-1&&(r+=", ")})))}),e.setAttribute("data-content",r),$(e).popover("toggle")}function load_chatchannel(e){function t(){var e=PbxObject.frases.CHAT_CHANNEL.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){var e=PbxObject.name?{groupid:PbxObject.oid}:null;json_rpc_async("getAvailableUsers",e,function(e){console.log("getAvailableUsers: ",e),r(e)})}function r(e){console.log("showAvailableUsers: ",e),ReactDOM.render(AvailableUsersComponent({modalId:b,frases:PbxObject.frases,data:e,onSubmit:s}),g),$("#"+b).modal()}function s(e){u.members=u.members.concat(e),console.log("addMembers: ",e,u),l(u,function(e){d(u)}),$("#available-users-modal").modal("hide")}function i(e){console.log("deleteMember: ",e),u.members=u.members.filter(function(t){return t.oid!==e}),l(u,function(e){d(u)})}function l(e,t){PbxObject.name&&(m=set_object_success);var n=e.name||p;json_rpc_async("setObject",{kind:PbxObject.kind,oid:e.oid,name:n,enabled:e.enabled,members:e.members.length?e.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(e){PbxObject.name=u.name=n,m&&m(),t&&t(e)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function d(e){var t={frases:PbxObject.frases,params:e,getAvailableUsers:a,setObject:l,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:get_extension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(ChatchannelComponent(t),document.getElementById("el-loaded-content"))}console.log("load_chat_group: ",e);var u=e,m=null,p=t(),b="available-users-modal",g=document.getElementById("available-users-cont");g||(g=document.createElement("div"),g.id="available-users-cont",document.body.appendChild(g)),PbxObject.oid=e.oid,PbxObject.name=e.name,d(u),show_content(),set_page()}function load_chattrunk(e){function t(){getObjects("chatchannel",function(e){console.log("getObjects: ",e),l=e||[],r()})}function n(e){PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function o(e,t){if(!e.pageid)return console.error("pageid is not defined");show_loading_panel();var n={kind:PbxObject.kind,oid:e.oid,name:e.name,enabled:e.enabled||!0,type:e.type,pageid:e.pageid,pagename:e.pagename,sessiontimeout:60*parseFloat(e.sessiontimeout),replytimeout:60*parseFloat(e.replytimeout),routes:e.routes};PbxObject.name?s=set_object_success:n.properties=e.properties,json_rpc_async("setObject",n,function(n){PbxObject.name=e.name,s&&s(),t&&t(null,n),show_content()})}function a(e){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function r(){var t={type:i,services:c,frases:PbxObject.frases,params:e,routes:l,onStateChange:n,setObject:o,removeObject:a};console.log("render: ",t),ReactDOM.render(ChatTrunkComponent(t),document.getElementById("el-loaded-content")),show_content()}console.log("load_chat_trunk: ",PbxObject.kind,e);var s=null,i=e.type||"FacebookMessenger",l=[],c=[{id:"FacebookMessenger",name:"Messenger",icon:"/badmin/images/facebook_messenger.png",params:{appId:"1920629758202993"}}];e.sessiontimeout=(e.sessiontimeout||604800)/60,e.replytimeout=(e.replytimeout||86400)/60,PbxObject.oid=e.oid,PbxObject.name=e.name,t(),set_page()}function load_cli(e){PbxObject.oid=e.oid,PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})}));var o=e.bnumbertransforms;if(o.length)for(var a=0;a<o.length;a++)append_transform(null,"transforms1",o[a]);else append_transform(null,"transforms1");var r=e.numbers;if(r.length)for(a=0;a<r.length;a++)add_cli_row(r[a]);else add_cli_row();show_content(),set_page()}function set_cli(){var e,t=document.getElementById("objname").value;if(!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var n='"name":"'+t+'",';show_loading_panel(),PbxObject.name?e=set_object_success:(PbxObject.name=t,e=null),PbxObject.oid&&(n+='"oid":"'+PbxObject.oid+'",'),n+='"kind":"cligroup",',n+='"enabled":'+document.getElementById("enabled").checked+",",n+='"bnumbertransforms":[',n+=encode_transforms("transforms1"),n+="],",n+='"numbers":[';var o,a=document.getElementById("clinumbers").getElementsByTagName("tbody")[0];for(o=0;o<a.children.length;o++){var r=a.children[o],s="",i=r.getElementsByTagName("input")[0];i&&"number"==i.name&&(s+='"number":"'+i.value+'",');var l=r.getElementsByTagName("textarea")[0];l&&"description"==l.name&&(s+='"description":"'+l.value+'",'),""!=s&&(n+="{"+s+"},")}n+="]",json_rpc_async("setObject",n,e)}function add_cli_row(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,o,a,r=document.getElementById("clinumbers").getElementsByTagName("tbody")[0],s=r.rows.length,i=r.insertRow(s);n=i.insertCell(0),o=document.createElement("div"),o.className="form-group",a=document.createElement("input"),a.className="form-control",a.setAttribute("type","text"),a.setAttribute("name","number"),e&&e.number&&(a.value=e.number),o.appendChild(a),n.appendChild(o),n=i.insertCell(1),o=document.createElement("div"),o.className="form-group",a=document.createElement("textarea"),a.className="form-control y-resizable",a.setAttribute("rows","3"),a.setAttribute("name","description"),e&&e.description&&(a.value=e.description),o.appendChild(a),n.appendChild(o),n=i.insertCell(2),o=document.createElement("div"),o.className="form-group",a=document.createElement("a"),a.href="#",a.className="remove-clr",a.innerHTML='<i class="fa fa-close"></i>',addEvent(a,"click",remove_row),o.appendChild(a),n.appendChild(o)}function Dashboard(){var e,t,n,o,a,r,s,i,l,c,d,u,m=this,p=!1,b=document.querySelectorAll(".calls-incoming"),g=document.querySelectorAll(".calls-outgoing"),f=document.querySelectorAll(".calls-connected"),h=document.querySelectorAll(".calls-load"),v=document.getElementById("calls-trunks").querySelector("tbody"),y=document.getElementById("calls-table").querySelector("tbody"),x=(v.rows.length,
[]);this.init=function(){var e,t,n;d=new Picker,e=d.today(),t=36e5,n='"begin":'+e+', "interval":'+t,json_rpc_async("getCallStatisticsGraph",n,function(e){m.createGraph(e)}),this.update=setInterval(this.checkStates.bind(this),1e3),this.statUpdate=setInterval(this.updateStatistics.bind(this),18e5),addEvent(window,"hashchange",this.stopUpdate.bind(this)),set_page();new GetStarted(document.getElementById("ns-container")).init()},this.checkStates=function(){sendData("getCurrentState",null,6),sendData("getCurrentCalls",null,5)},this.updateStatistics=function(){var e,t,n;d=new Picker,e=d.today(),t=36e5,n='"begin":'+e+', "interval":'+t,json_rpc_async("getCallStatisticsGraph",n,function(e){m.createGraph(e)})},this.setCurrentState=function(e){p===!1&&(show_content(),p=!0),x=e.trunks;for(var t=0;t<b.length;t++)b[t].textContent!=e["in"]&&(b[t].textContent=e["in"]);for(var t=0;t<g.length;t++)g[t].textContent!=e.out&&(g[t].textContent=e.out);for(var t=0;t<f.length;t++)f[t].textContent!=e.conn&&(f[t].textContent=e.conn);for(var t=0;t<h.length;t++)h[t].textContent=parseFloat(e.load).toFixed(1)+"%";for(var t=0;t<x.length;t++){var n=x[t].enabled?"success":"danger";v.rows[t]?(v.rows[t].cells[0].className=n,v.rows[t].cells[1].firstChild.textContent!=x[t].name&&(v.rows[t].cells[1].firstChild.textContent=x[t].name),v.rows[t].cells[2].textContent!=x[t]["in"]&&(v.rows[t].cells[2].textContent=x[t]["in"]),v.rows[t].cells[3].textContent!=x[t].out&&(v.rows[t].cells[3].textContent=x[t].out),v.rows[t].cells[4].textContent=parseFloat(x[t].load).toFixed(1)+"%",v.rows[t].cells[5].textContent!=x[t].address&&(v.rows[t].cells[5].textContent=x[t].address)):(i=v.insertRow(t),l=i.insertCell(0),l.className=n,l=i.insertCell(1),"system"===x[t].type?l.innerText=x[t].name:(c=document.createElement("a"),c.href="#trunk/"+x[t].oid,c.textContent=x[t].name,l.appendChild(c)),l=i.insertCell(2),l.textContent=x[t]["in"],l=i.insertCell(3),l.textContent=x[t].out,l=i.insertCell(4),l.textContent=parseFloat(x[t].load).toFixed(1)+"%",l=i.insertCell(5),l.textContent=x[t].address)}},this.setCurrentCalls=function(e){if(e){y.rows.length>e.length&&this.clearTable(y,e.length);for(var t=0;t<e.length;t++)y.rows[t]?(y.rows[t].cells[0].textContent=e[t].caller,y.rows[t].cells[1].textContent=e[t].called,e[t].time&&(y.rows[t].cells[2].textContent=formatTimeString(e[t].time,"hh:mm:ss"))):(i=y.insertRow(t),l=i.insertCell(0),l.textContent=e[t].caller,l=i.insertCell(1),l.textContent=e[t].called,l=i.insertCell(2),l.textContent=formatTimeString(e[t].time,"hh:mm:ss"))}},this.clearTable=function(e,t){for(i=t-1;e.rows.length!=t;)e.deleteRow(i),i-=1},this.stopUpdate=function(){clearInterval(this.update),clearInterval(this.statUpdate),removeEvent(window,"hashchange",this.stopUpdate.bind(this))},this.createGraph=function(i){if(i.length){e=[],t=[],n=[],o=[],a=[];for(var l=0,c=i.length;c>l;l++)s=i[l],r=s.t,e.push([r,s.i]),t.push([r,s.o]),n.push([r,s.l]),o.push([r,s.m]),a.push([r,s.p]);var d={show:!0,barWidth:36e5,lineWidth:0,fill:.7};insAndLostData=[{label:PbxObject.frases.STATISTICS.CONNECTEDCALLS,stack:0,bars:d,data:e,color:"#3c763d"},{label:PbxObject.frases.STATISTICS.LOSTCALLS,stack:0,bars:d,data:o,color:"#AA4643"}],t=[{label:PbxObject.frases.SETTINGS.OUTCALLS,bars:d,data:t,color:"#4572A7"}],n=[{label:PbxObject.frases.SETTINGS.INTCALLS,bars:d,data:n,color:"#BADABA"}],a=[{label:PbxObject.frases.STATISTICS.LINES_PAYLOAD,data:a,lines:{show:!0,fill:!1},points:{show:!0},color:"#3c763d"}],u={xaxis:{mode:"time",timeformat:"%H:%M",timezone:"browser",tickSize:0,tickLength:0},yaxis:{min:0,tickFormatter:function(e){return e.toFixed(1)}},grid:{margin:0,hoverable:!0,borderWidth:0,color:"#ccc"},legend:!1,tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.1",yDateFormat:"%H:%M"}},$.plot($("#outCalls-graph"),t,u),$.plot($("#inAndLost-graph"),insAndLostData,u),$.plot($("#intCalls-graph"),n,u),$.plot($("#linesLoad-graph"),a,u),addEvent(window,"resize",m.resizeChart),addEvent(window,"hashchange",function(){removeEvent(window,"resize",m.resizeChart)})}else $("#outCalls-graph").html('<h4 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h4>"),$("#inAndLost-graph").html('<h4 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h4>"),$("#intCalls-graph").html('<h4 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h4>"),$("#linesLoad-graph").html('<h4 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h4>")},this.resizeChart=function(){$.plot($("#outCalls-graph"),t,u),$.plot($("#inAndLost-graph"),insAndLostData,u),$.plot($("#intCalls-graph"),n,u),$.plot($("#linesLoad-graph"),a,u)},this.init()}function load_dashboard(){PbxObject.Dashboard=new Dashboard}function EventEmitter(){function e(e,t){o.call(n,e)||(n[e]=[]);var a=n[e].push(t)-1;return{off:function(){delete n[e][a]}}}function t(e,t){o.call(n,e)&&n[e].forEach(function(e){e(void 0!==t?t:{})})}var n={},o=n.hasOwnProperty;return{on:e,emit:t}}function load_extensions(e){var t,n=document.getElementById("extensions").getElementsByTagName("tbody")[0],o=document.createDocumentFragment();PbxObject.extensions=e;for(var a=0;a<e.length;a++)t=createExtRow(e[a]),o.appendChild(t);n.appendChild(o),TableSortable.sortables_init(),add_search_handler(),set_page(),show_content()}function getExtensions(e){json_rpc_async("getExtensions",null,e)}function createExtRow(e){var t,n,o=document.createElement("tr"),a=getInfoFromState(e.state,e.group),r=a.rstatus;a.rclass;return t=o.insertCell(0),e.oid&&e.kind?(n=document.createElement("a"),"user"==e.kind||"phone"==e.kind?(n.href="#",addEvent(n,"click",get_extension)):n.href="#"+e.kind+"/"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,t=o.insertCell(1),t.setAttribute("data-cell","name"),t.textContent=e.name||"",t=o.insertCell(2),t.setAttribute("data-cell","group"),t.textContent=e.group||"",t=o.insertCell(3),t.textContent=e.reg||"",t.setAttribute("data-cell","reg"),t.className="nowrap",t.title=e.reg||"",t=o.insertCell(4),t.setAttribute("data-cell","kind"),t.textContent=PbxObject.frases.KINDS[e.kind]||"",t=o.insertCell(5),t.setAttribute("data-cell","status"),t.innerHTML='<span class="label label-'+a.className+'">'+(r||"")+"</span>",t=o.insertCell(6),e.oid&&(button=createNewButton({type:"tooltip",title:PbxObject.frases.DELETE,classname:"btn btn-link btn-danger btn-md",content:'<i class="fa fa-trash"></i>',handler:delete_extension}),t.appendChild(button)),o.id=e.oid,o.setAttribute("data-ext",e.ext),o.setAttribute("data-kind",e.kind),o}function updateExtensionRow(e,t){var n=document.getElementById(t.oid),o=t.state,a=getInfoFromState(o,t.group);if(n){var r,s=(n.cells,a.rstatus);a.rclass;t.name&&(r=n.querySelector('[data-cell="name"]'),r&&(r.innerHTML=t.name)),t.display&&(r=n.querySelector('[data-cell="display"]'),r&&(r.innerHTML=t.display)),t.hasOwnProperty("group")&&(r=n.querySelector('[data-cell="group"]'),r&&(r.innerHTML=t.group)),t.hasOwnProperty("reg")&&(r=n.querySelector('[data-cell="reg"]'),r&&(r.innerHTML=t.reg)),r=n.querySelector('[data-cell="status"]'),r&&(r.innerHTML='<span class="label label-'+a.className+'">'+s+"</span>")}updateObjects(PbxObject.extensions,t,"ext")}function get_extension(e){var e=e||window.event;"click"==e.type&&e.preventDefault();var t=getClosest(e.target,"tr").id;t&&(show_loading_panel(),PbxObject.templates.extension?json_rpc_async("getObject",'"oid":"'+t+'"',load_extension):$.get("/badmin/views/extension.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.extension=e,json_rpc_async("getObject",'"oid":"'+t+'"',load_extension)}))}function editExtension(e){var t,n,o,a=getClosest(e.target,"tr"),r=a.parentNode,s=document.createElement("tr"),i=a.cells,l=i[1].textContent,c=i[2].textContent,d=i[3].textContent,u=a.getAttribute("data-kind"),m=i[5].textContent;if(s.setAttribute("data-oid",a.id),t=s.insertCell(0),t.innerHTML=i[0].innerHTML,t=s.insertCell(1),t.innerHTML='<input class="form-control extname" value="'+l+'">',t=s.insertCell(2),"user"===u||"phone"===u){var p="user"===u?"users":"unit";n=document.createElement("select"),n.className="form-control extgroup",t.appendChild(n),fill_group_choice(p,c,n)}else t.textContent=c;t=s.insertCell(3),"phone"==u||-1!=d.indexOf(".")?t.textContent=d:t.innerHTML='<input class="form-control extreg" value="'+d+'">',t=s.insertCell(4),t.textContent=i[4].textContent,t=s.insertCell(5),t.textContent=m,t=s.insertCell(6),o=createNewButton({type:"tooltip",title:PbxObject.frases.CANCEL,classname:"btn btn-link btn-default btn-md",content:'<i class="fa fa-chevron-left"></i>',handler:function(){a.style.display="table-row",r.removeChild(s)}}),t.appendChild(o),t=s.insertCell(7),o=createNewButton({type:"tooltip",title:PbxObject.frases.SAVE,classname:"btn btn-link btn-success btn-md",content:'<i class="fa fa-check"></i>',handler:set_extension_update}),t.appendChild(o),r.insertBefore(s,a),a.style.display="none"}function set_extension_update(e){var t=getClosest(e.target,"tr"),n=t.getAttribute("data-oid"),o=document.getElementById(n),a=t.querySelector(".extname").value,r=t.querySelector(".extgroup"),s=r.options[r.selectedIndex].value,i=t.querySelector(".extreg"),l='"oid":"'+n+'",';a&&(l+='"name":"'+a+'",'),s&&(l+='"groupid":"'+s+'",'),i&&i.value&&(l+='"followme":"'+i.value+'",'),json_rpc_async("setObject",l,function(){t.parentNode.removeChild(t),o.style.display="table-row"})}function load_extension(e){PbxObject.extOid=e.oid,PbxObject.userid=e.userid,PbxObject.vars=PbxObject.vars||{},PbxObject.vars.infoShown=!1;var t,n=document,o=document.getElementById("ext-cont"),a=e.groupid,r="user"==e.kind?"users":"unit";"users"===r&&(e.storelimit=e.storelimit?convertBytes(e.storelimit,"Byte","GB").toFixed(2):0,e.storesize=e.storesize?convertBytes(e.storesize,"Byte","GB").toFixed(2):0,e.storefree=e.storefree?convertBytes(e.storelimit-e.storesize,"Byte","GB").toFixed(2):0),t=Mustache.render(PbxObject.templates.extension,{data:e,frases:PbxObject.frases}),o||(o=document.createElement("div"),o.id="ext-cont",$("#pagecontainer").prepend(o)),$(o).html(t);var s=document.getElementById("ext-storelimit-cont"),i=document.querySelector("#el-extension .user-state-ind"),l=document.getElementById("user-avatar"),c="/$AVATAR$?userid="+e.userid;if(l.onerror=function(){this.src="images/avatar.png"},l.src=c,i.classList.add(getInfoFromState(e.state).rclass),"users"!==r){var d=document.querySelector("#el-extension .user-storage-usage");d&&d.classList.add("hidden"),s&&s.classList.add("hidden")}else{var u=document.getElementById("pin-cont");u&&u.classList.add("hidden"),s.style.display="block"}switch_presentation(r,document.getElementById("ext-features")),a?fill_group_choice(r,a):document.getElementById("extgroup-cont").classList.add("hidden");var m=n.getElementById("ext-fwdnreg"),p=n.getElementById("ext-fwdnregnumber");m.checked=e.features.fwdnreg,p.value=e.features.fwdnregnumber;var b=document.getElementById("ext-tabs");e.features&&(void 0==e.features.fwdall&&(b.querySelector('li a[href="#ext-forwarding"]').parentNode.className="hidden"),void 0==e.features.recording&&n.getElementById("ext-recording").setAttribute("disabled",""),void 0==e.features.callwaiting&&n.getElementById("ext-callwaiting").setAttribute("disabled",""),void 0==e.features.pickupdeny&&n.getElementById("ext-pickupdeny").setAttribute("disabled",""),void 0==e.features.monitordeny&&n.getElementById("ext-monitordeny").setAttribute("disabled",""),void 0==e.features.busyoverdeny&&n.getElementById("ext-busyoverdeny").setAttribute("disabled",""),void 0==e.features.voicemail&&n.getElementById("ext-voicemail").setAttribute("disabled",""),void 0==e.features.lock&&n.getElementById("ext-plock").setAttribute("disabled","")),n.getElementById("el-set-extension").onclick=function(){set_extension(r)},n.getElementById("showUserInfo").onclick=function(t){t&&t.preventDefault(),getUserInfo(e.userid)},show_content(),$('#el-extension [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),$('#el-extension [data-toggle="tooltip"]').tooltip(),$("#el-extension").modal(),$("#el-extension").on("hidden.bs.modal",function(e){$('#el-extension [data-toggle="popover"]').popover("destroy"),PbxObject.vars.infoShown=!1})}function set_extension(e){var t=document,n=PbxObject.extOid,o='"oid":"'+n+'",',a=t.getElementById("extgroup"),r=t.getElementById("extstorelimit");if(a.options.length)var s=a.options[a.selectedIndex].value;o+=s?'"groupid":"'+s+'",':'"groupid":"'+PbxObject.oid+'",',o+='"name":"'+t.getElementById("extname").value+'",',o+='"display":"'+t.getElementById("extdisplay").value+'",',o+='"password":"'+t.getElementById("extpassword").value+'",',t.getElementById("extpin").value&&(o+='"pin":'+t.getElementById("extpin").value+","),r&&(r=convertBytes(r.value,"GB","Byte").toFixed(),r>=0&&(o+='"storelimit":'+r+",")),o+='"features":{',null!=t.getElementById("ext-fwdall")&&(o+='"fwdall":'+t.getElementById("ext-fwdall").checked+",",o+='"fwdallnumber":"'+t.getElementById("ext-fwdallnumber").value+'",'),null!=t.getElementById("ext-fwdnregnumber")&&(o+='"fwdnreg":'+t.getElementById("ext-fwdnreg").checked+",",o+='"fwdnregnumber":"'+t.getElementById("ext-fwdnregnumber").value+'",'),null!=t.getElementById("ext-fwdbusynumber")&&(o+='"fwdbusy":'+t.getElementById("ext-fwdbusy").checked+",",o+='"fwdbusynumber":"'+t.getElementById("ext-fwdbusynumber").value+'",'),null!=t.getElementById("ext-fwdnansnumber")&&(o+='"fwdnans":'+t.getElementById("ext-fwdnans").checked+",",o+='"fwdnansnumber":"'+t.getElementById("ext-fwdnansnumber").value+'",'),null!=t.getElementById("ext-fwdtimeout")&&t.getElementById("ext-fwdtimeout").value&&(o+='"fwdtimeout":'+t.getElementById("ext-fwdtimeout").value+","),0==t.getElementById("ext-plock").disabled&&(o+='"lock":'+t.getElementById("ext-plock").checked+","),0==t.getElementById("ext-recording").disabled&&(o+='"recording":'+t.getElementById("ext-recording").checked+","),0==t.getElementById("ext-callwaiting").disabled&&(o+='"callwaiting":'+t.getElementById("ext-callwaiting").checked+","),0==t.getElementById("ext-pickupdeny").disabled&&(o+='"pickupdeny":'+t.getElementById("ext-pickupdeny").checked+","),0==t.getElementById("ext-monitordeny").disabled&&(o+='"monitordeny":'+t.getElementById("ext-monitordeny").checked+","),0==t.getElementById("ext-busyoverdeny").disabled&&(o+='"busyoverdeny":'+t.getElementById("ext-busyoverdeny").checked+","),0==t.getElementById("ext-voicemail").disabled&&(o+='"voicemail":'+t.getElementById("ext-voicemail").checked+","),o+="}";var i=document.getElementById("userInfo"),l=retrieveFormData(i);l&&0!==Object.keys(l).length&&(l.userid=PbxObject.userid,json_rpc_async("setUserInfo",l,null)),json_rpc_async("setObject",o,function(){$("#el-extension").modal("hide")}),upload("upload-avatar","/$AVATAR$?userid="+PbxObject.userid)}function loadAvatar(e){var e=e||window.event;e&&e.preventDefault();var t=document.getElementById("upload-avatar");t.click(),t.onchange=function(){previewAvatar(this)}}function previewAvatar(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#user-avatar").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function getAvatar(e,t){var n=new XMLHttpRequest;n.overrideMimeType("text/plain; charset=x-user-defined"),n.open("GET","/$AVATAR$?userid="+e,!0),n.responseType="arraybuffer",n.onload=function(e){if(200==this.status){for(var o="",a=n.mozResponseArrayBuffer||n.response,r=new Uint8Array(a),s=0;s<r.byteLength;s++)o+=String.fromCharCode(r[s]);null!=t&&t(o)}},n.send(null)}function getUserInfo(e){if(PbxObject.vars.infoShown===!0)return void $("#userInfo").collapse("toggle");var t,n,o=document.getElementById("showUserInfo"),a=o.innerHTML;o.innerHTML='<i class="fa fa-lg fa-spinner fa-spin"></i>',getPartial("userinfo",function(r){json_rpc_async("getUserInfo",'"userid":"'+e+'"',function(e){PbxObject.vars.infoShown=!0,n={data:e,frases:PbxObject.frases},t=Mustache.render(r,n),$("#userInfo").html(t),o.innerHTML=a,$("#userInfo").collapse("toggle")})})}function GetStarted(e){function t(){var e=s(l,"routes",!0);return!appStorage.get("welcomed")&&!e.length&&!i.length}function n(){var e=document.createElement("div");$("body").prepend(e),ReactDOM.render(WelcomeModal({startTour:o,frases:PbxObject.frases}),e),$("#welcome-modal").modal(),appStorage.set("welcomed",!0)}function o(){d.start()}function a(){var e=!0;c=[{component:"AddExtensions",name:"addExtensions",icon:"fa fa-users",title:PbxObject.frases.GET_STARTED.STEPS.A.TITLE,desc:PbxObject.frases.GET_STARTED.STEPS.A.BODY,done:s(l,"users").length>0||s(l,"equipment").length>0},{component:"AddCallGroup",name:"addCallGroup",icon:"icon-headset_mic",title:PbxObject.frases.GET_STARTED.STEPS.B.TITLE,desc:PbxObject.frases.GET_STARTED.STEPS.B.BODY,done:s(l,"icd").length>0||s(l,"hunting").length>0},{name:"addAttendant",icon:"icon-room_service",title:PbxObject.frases.GET_STARTED.STEPS.C.TITLE,desc:PbxObject.frases.GET_STARTED.STEPS.C.BODY,done:s(l,"attendant").length>0,onClick:function(){window.location.hash="#attendant/attendant"}},{name:"addTrunk",icon:"fa fa-cloud",title:PbxObject.frases.GET_STARTED.STEPS.D.TITLE,desc:PbxObject.frases.GET_STARTED.STEPS.D.BODY,done:s(l,"trunk").length>0,onClick:function(){window.location.hash="#trunk/trunk"}}],c.forEach(function(t){t.done||(e=!1)}),ReactDOM.render(GsWidget({steps:c,frases:PbxObject.frases}),document.getElementById("get-started-cont")),e&&r()}function r(){var e=document.querySelector("#get-started-panel");e.classList.add("minimized"),e.classList.add("all-done")}function s(e,t,n){return e.filter(function(e){return n?e.kind!==t:e.kind===t})}var i=[],l=PbxObject.objects,c=[],d={};this.init=function(){"object"==typeof l?a():json_rpc_async("getExtensions",null,function(e){i=e,console.log("extensions:",i),getObjects(null,function(e){l=PbxObject.objects=e,console.log("objects:",l),a(),t()&&n()})})}}function load_hunting(e){function t(){var e=PbxObject.frases.HUNTING_GROUP.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){var e=PbxObject.name?{groupid:PbxObject.oid}:null;json_rpc_async("getAvailableUsers",e,function(e){console.log("getAvailableUsers: ",e),r(e)})}function r(e){console.log("showAvailableUsers: ",e),ReactDOM.render(AvailableUsersComponent({modalId:b,frases:PbxObject.frases,data:e,onSubmit:s}),g),$("#"+b).modal()}function s(e){u.members=u.members.concat(e),console.log("addMembers: ",e,u),l(u,function(e){d(u)}),$("#available-users-modal").modal("hide")}function i(e){console.log("deleteMember: ",e),u.members=u.members.filter(function(t){return t.oid!==e}),l(u,function(e){d(u)})}function l(t,n){PbxObject.name&&(m=set_object_success);var o=t.name||p;console.log("setObject: ",t),json_rpc_async("setObject",{kind:PbxObject.kind,oid:t.oid,name:o,enabled:t.enabled,options:t.options,members:t.members.length?t.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(a){if(PbxObject.name=u.name=o,t.files&&t.files.length&&(console.log("upload Files: ",t.files),t.files.forEach(function(e){uploadFile(e)})),t.route&&t.route.ext){console.log("set route props: ",t.route);var r={number:t.route.ext,target:{oid:PbxObject.oid,name:PbxObject.name}};e.routes.length&&(r.oid=e.routes[0].id),setObjRoute(r)}m&&m(),n&&n(a)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function d(e){var t={frases:PbxObject.frases,params:e,getAvailableUsers:a,setObject:l,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:get_extension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(HuntingGroupComponent(t),document.getElementById("el-loaded-content"))}console.log("load_hunting: ",e);var u=e,m=null,p=t(),b="available-users-modal",g=document.getElementById("available-users-cont");g||(g=document.createElement("div"),g.id="available-users-cont",document.body.appendChild(g)),PbxObject.oid=e.oid,PbxObject.name=e.name,d(u),show_content(),set_page()}function load_icd(e){function t(){var e=PbxObject.frases.ICD_GROUP.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){var e=PbxObject.name?{groupid:PbxObject.oid}:null;json_rpc_async("getAvailableUsers",e,function(e){console.log("getAvailableUsers: ",e),r(e)})}function r(e){console.log("showAvailableUsers: ",e),e=sortByKey(e,"ext"),ReactDOM.render(AvailableUsersComponent({modalId:b,frases:PbxObject.frases,data:e,onSubmit:s}),g),$("#"+b).modal()}function s(e){u.members=u.members.concat(e),console.log("addMembers: ",e,u),l(u,function(e){d(u)}),$("#available-users-modal").modal("hide")}function i(e){console.log("deleteMember: ",e),u.members=u.members.filter(function(t){return t.oid!==e}),l(u,function(e){d(u)})}function l(t,n){PbxObject.name&&(m=set_object_success);var o=t.name||p;console.log("setObject: ",t),json_rpc_async("setObject",{kind:PbxObject.kind,oid:t.oid,name:o,enabled:t.enabled,options:t.options,members:t.members.length?t.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(a){if(PbxObject.name=u.name=o,t.files&&t.files.length&&(console.log("upload Files: ",t.files),t.files.forEach(function(e){uploadFile(e)})),t.route&&t.route.ext){console.log("set route props: ",t.route);var r={number:t.route.ext,target:{oid:PbxObject.oid,name:PbxObject.name}};e.routes.length&&(r.oid=e.routes[0].id),setObjRoute(r)}m&&m(),n&&n(a)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function d(e){var t={frases:PbxObject.frases,params:e,getAvailableUsers:a,setObject:l,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:get_extension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(IcdGroupComponent(t),document.getElementById("el-loaded-content"))}console.log("load_icd: ",e);var u=e,m=null,p=t(),b="available-users-modal",g=document.getElementById("available-users-cont");g||(g=document.createElement("div"),g.id="available-users-cont",document.body.appendChild(g)),PbxObject.oid=e.oid,PbxObject.name=e.name,d(u),show_content(),set_page()}function Ldap(e){function t(e,t){json_rpc_async("getDirectoryUsers",e,function(e){console.log("getDirectoryUsers result: ",e),t&&t(e)})}function n(t,n){var o={url:"/services/"+e.service_id+"/Users"};console.log("getExternalUsers params: ",o),$.ajax(o).then(function(e){console.log("getExternalUsers: ",e),n?n(e.result):i(e.result)},function(t){var n=t.responseJSON.error;if(console.log("getExternalUsers error: ",n),n&&n.redirection){var o=window.location,a=o.origin+o.pathname+(o.search?o.search:"?")+"&service_id="+e.service_id+"&service_type="+e.service_type+o.hash;window.sessionStorage.setItem("lastURL",a),window.location=n.redirection}else{var o=window.location,a=o.origin+o.pathname+(o.search?o.search:"?")+"&service_id="+e.service_id+"&service_type="+e.service_type+o.hash;window.sessionStorage.setItem("lastURL",a),window.location=o.origin+"/services/"+e.service_id+"/Users"}})}function o(e,t){console.log("setDirectoryUsers: ",e),json_rpc_async("setDirectoryUsers",e,function(e){console.log("setDirectoryUsers result: ",e),t&&t(e)})}function a(e,t){console.log("setExternalUsers: ",e),json_rpc_async("setExternalUsers",e,function(e){console.log("setExternalUsers result: ",e),t&&t(e)})}function r(n){n?t(n,function(e){e&&i(e)}):showModal("ldap_auth",{service_id:e.service_id,domains:e.domains},s)}function s(o,a){console.log("ldapLogin: ",o,a);var r=a.querySelector('button[data-type="submit"]'),s=r.innerHTML;v=a,r=$(r),r.prop("disabled",!0),r.html('<i class="fa fa-fw fa-spinner fa-spin"></i>'),e.auth=o,e.external?n(o,function(e){console.log("getExternalUsers login result: ",e),r.prop("disabled",!1),r.html(s),e&&($(a).modal("hide"),i(e))}):t(o,function(e){console.log("ldapLogin result: ",e),r.prop("disabled",!1),r.html(s),e&&($(a).modal("hide"),i(e))})}function i(t){var n=t.map(function(e,t){return e.index=t,e});f=t,g=e.available.map(function(e,t){return{id:t+1,text:e}}),g.unshift({id:0,text:"----------"}),console.log("showModal: ",PbxObject.available,e.available,g),showModal("ldap_users",{users:n},l,c,p)}function l(t,n){function o(e){return e.hasOwnProperty("ext")}console.log("addLdapUsers: ",h),v=n,e.onaddusers(h.filter(o))}function c(e){$(e).on("click",function(e){e.preventDefault();var t=e.target;"add-ldap-user"!==t.name&&(t=t.parentNode),"add-ldap-user"===t.name&&d(t)}),v=e,TableSortable.sortables_init()}function d(e){var t,n,o=$(e),a=o.next();E=parseInt(e.getAttribute("data-index"),10),y=o.data("data-selected"),a.html('<select style="width: 100%;"></select>'),n=a.children(":first"),o.hide(),n.select2({data:sortByKey(g,"id")}),console.log("available: ",g),n.on("select2:open",u),n.on("select2:close",m),n.on("select2:close",function(){x&&0!==x.id?(o.text(x.text),t=x.id):x&&0===x.id?(o.html('<i class="fa fa-plus-circle fa-fw fa-lg"></i>'),t=x.id):(o.text(y.text),t=y.id),o.data("data-selected",t),o.show(),a.hide()}),a.show(),y&&n.val(y).trigger("change"),n.select2("open")}function u(e){y=g[parseInt(this.value,10)],x=null}function m(e){x=g[parseInt(this.value,10)],y.id!==x.id&&(0!==y.id&&(y.disabled=!1,h.splice(h.indexOf(E),1)),0!==x.id&&(x.disabled=!0,O=f[E],O.ext=x.text,delete O.index,h.push(O))),$(this).off("select2:open",u),$(this).off("select2:close",m),$(this).select2("destroy")}function p(e){console.log("LDAP modal closed"),g=[],f=[],h=[]}function b(){$(v).modal("hide")}var e=e||{},g=[],f=[],h=[],v=null;console.log("new LDAP: ",e);var y,x,E,O={};return{options:e,getUsers:t,getExternalUsers:n,setUsers:o,setExternalUsers:a,showUsers:i,auth:r,close:b}}function initGlobals(e){e.PbxObject={options:{},optionsOpened:!1,systime:"",initInterval:{},websocket:{},websocketTry:0,currentObj:{},protocolOpts:{},frases:{},smallScreen:!1,Dashboard:{},channels:[],members:[],available:[],extensions:[],objects:void 0,groups:{},templates:{},partials:{},name:"",language:"",query:"",kind:"",oid:""}}function init(){window.clearInterval(PbxObject.initInterval),"complete"===document.readyState||"interactive"===document.readyState?init_page():document.addEventListener?document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,!1),init_page()},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),init_page())})}function logout(){var e=new XMLHttpRequest;e.open("GET","/logout",!0),e.onload=function(e){console.log("logout: ",e),window.location="/"},e.send()}function createWebsocket(){var e="https:"===location.protocol?"wss:":"ws:";PbxObject.websocket=new WebSocket(e+"//"+window.location.host+"/","json.api.smile-soft.com"),PbxObject.websocket.onopen=function(e){console.log("WebSocket opened: ",e),PbxObject.websocketTry=1},PbxObject.websocket.onmessage=function(e){handleMessage(e.data)},PbxObject.websocket.onclose=onWebsocketClose}function onWebsocketClose(e){if(console.log("WebSocket closed",e),1006===e.code)return window.location="/";var t=generateInterval(PbxObject.websocketTry);setTimeout(function(){PbxObject.websocketTry++,createWebsocket()},t)}function generateInterval(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function billingRequest(e,t,n){var o=window.localStorage.getItem("ringo_tid");return o?void request("POST","https://my.ringotel.co/branch/api/"+e+"?access_token="+encodeURIComponent(o),t||null,null,function(e,t){return console.log("billing response: ",e,t),e||t.error?n(e||t.error):void(n&&n(null,t))}):n("MISSING_TOKEN")}function json_rpc(e,t){var n;n=null==t?'{"method":"'+e+'", "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}';var o=new XMLHttpRequest;if(o.open("POST","/",!1),o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),o.send(n),403===o.status)return window.location="/";var a=JSON.parse(o.responseText);return void 0!=a.error?void notify_about("error",a.error.message):a.result}function json_rpc_async(e,t,n,o){var a;a=null!==t?"object"==typeof t?'{"method":"'+e+'", "params":'+JSON.stringify(t)+', "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}':'{"method":"'+e+'", "id":1}';var r=new XMLHttpRequest;r.open("POST","/",!0);var s=setTimeout(function(){r.abort(),notify_about("info",PbxObject.frases.TIMEOUT),show_content()},6e4);r.onreadystatechange=function(){if(4==r.readyState)if(clearTimeout(s),200!=r.status){if(403===r.status)return window.location="/";console.error(e,r.statusText),notify_about("error",PbxObject.frases.ERROR),n&&n(null,r.statusText),show_content()}else if(null!=r.responseText){if(!r.responseText)return;var t=JSON.parse(r.responseText);void 0!=t.error?(n&&n(null,t.error),notify_about("error",t.error.message),show_content()):t.result&&null!==n&&n(t.result)}},r.setRequestHeader("Content-Type","application/json; charset=UTF-8"),r.send(a)}function request(e,t,n,o,a){var r,s,i;r=new XMLHttpRequest,r.open(e,t,!0),o&&o.headers&&o.headers.forEach(function(e){r.setRequestHeader(e.name,e.value)}),s=setTimeout(function(){r.abort()},6e4),r.onload=function(e){clearTimeout(s);var t=(e.target.getAllResponseHeaders(),e.target.status),n=e.target.responseText;if(n)try{n=JSON.parse(n)}catch(o){console.log("response in not JSON")}if(403===t)logout();else if(200===t)a&&a(null,n);else if(t>=500){if(a)return a("The service is under maintenance. Please, try again later.")}else a&&a(n.error,n)},n?(r.setRequestHeader("Content-Type","application/json"),i=JSON.stringify(n),r.send(i)):r.send()}function getTranslations(e){var t=new XMLHttpRequest,n="translations_"+e+".json";t.open("GET","/badmin/translations/"+n,!0),t.onload=function(e){if(403===e.target.status)logout();else if(200===e.target.status){var n=JSON.parse(t.responseText);loadTranslations(n)}else notify_about("error","ERROR_OCCURED")},t.setRequestHeader("Content-Type","application/json; charset=UTF-8"),t.send()}function loadTranslations(e){PbxObject.frases=e,init()}function sendData(e,t,n){var o={};o.method=e,t&&(o.params=t),n&&(o.id=n),o=JSON.stringify(o),PbxObject.websocket.send(o)}function setPageHeight(){$("#pagecontent").css("min-height",function(){return $(window).height()})}function changeOnResize(e){PbxObject.smallScreen!==e&&(e?($("#pagecontent").hasClass("squeezed-right")&&$("#pagecontent").removeClass("squeezed-right"),$("#pbxmenu").hasClass("squeezed-menu")&&$("#pbxmenu").removeClass("squeezed-menu")):$("#pagecontent").hasClass("squeezed-right")||$("#pagecontent").addClass("squeezed-right"),$("#sidebar-toggle").toggleClass("flipped"),PbxObject.smallScreen=e)}function handleMessage(e){var e=JSON.parse(e),t=e.method;if(e.method){var n=e.params;console.log("handleMessage",e.method,n),"stateChanged"==t||"objectUpdated"==t?$(document).trigger("onmessage.object.update",n):"conferenceUpdate"==t?updateConference(e):"objectCreated"==t?$(document).trigger("onmessage.object.add",n):"objectDeleted"==t&&$(document).trigger("onmessage.object.delete",n)}else callbackOnId(e.id,e.result)}function callbackOnId(e,t){5==e?PbxObject.Dashboard.setCurrentCalls(t):6==e?PbxObject.Dashboard.setCurrentState(t):7==e&&setCallStatistics(t)}function subscribeToEvents(){$(document).on("onmessage.object.update",updateExtensionRow),$(document).on("onmessage.object.update",updateMenu),$(document).on("onmessage.object.update",function(e,t){console.log("onmessage.object.update: ",PbxObject.oid,t),PbxObject.oid===t.oid&&objectStateUpdated(t),updateObjectCache(t)}),$(document).on("onmessage.object.add",newObjectAdded),$(document).on("onmessage.object.delete",onObjectDelete)}function init_page(){window.Events=EventEmitter();var e=$("#main-template").html(),t=Mustache.render(e,PbxObject.frases);$("#pagecontainer").html(t),switchMode(PbxObject.options.config),document.getElementsByTagName("title")[0].innerHTML="UCC "+PbxObject.frases.PBXADMIN,
setPageHeight(),subscribeToEvents(),PbxObject.language=PbxObject.options.lang,PbxObject.smallScreen=isSmallScreen(),$(window).resize(function(){setPageHeight(),changeOnResize(isSmallScreen())}),isSmallScreen()?$("#sidebar-toggle").toggleClass("flipped"):$("#pagecontent").addClass("squeezed-right"),$(window).width()>767&&$(window).width()<959&&($("#pbxmenu").addClass("squeezed-menu"),$("#pagecontent").removeClass("squeezed-right")),location.hash.substring(1)||(location.hash="dashboard"),load_pbx_options(PbxObject.options),get_object(),set_listeners(),$('[data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}}),$(".tab-switcher","#pbxoptions").click(function(e){switch_options_tab($(this).attr("data-tab"))})}function initTour(e){console.log("initTour: ",e,PbxObject.tours[e.kind]);var t=e.kind||"",n=e.tourOptions||{};n.frases=PbxObject.frases,PbxObject.tours[t]&&MyTour(t,PbxObject.tours[t](n)).start()}function set_listeners(){addEvent(window,"hashchange",get_object),$(".sidebar-toggle","#pagecontent").click(toggle_sidebar),$(".options-open","#pagecontent").click(open_options),$(".options-close","#pbxoptions").click(close_options),$("#pbxmenu li a").click(showGroups),$("#logout-btn").click(logout)}function showGroups(e){var t,n=this,o=this.href;o&&"#"===o.substring(o.length-1)&&e.preventDefault();var a=$(n).parent(),r=$(n).attr("data-kind");if(a.hasClass("active"))t=$(n).next("ul"),t&&(a.removeClass("active"),t.slideUp("normal"));else if(r){var s=document.createElement("ul");s.id="ul-"+r,"unit"!=r&&"icd"!=r&&"hunting"!=r&&"pickup"!=r&&"cli"!=r&&(likind=document.createElement("li"),likind.className="menu-name",likind.innerHTML=PbxObject.frases.KINDS[r],s.appendChild(likind)),show_loading_panel(a[0]),getObjects(r,function(e){console.log("showGroups: ",r,e);var o=document.createElement("li");o.className="add-group-object";var i=document.createElement("a");if("application"==r){var l=document.createElement("input");l.type="file",l.id="uploadapp",l.className="upload-custom",l.accept=".application",addEvent(l,"change",function(){upload("uploadapp")}),o.appendChild(l),i.href="#",addEvent(i,"click",function(e){document.getElementById("uploadapp").click(),e&&e.preventDefault})}else i.href="#"+r+"/"+r;i.innerHTML='<i class="fa fa-plus"></i><span>'+(isGroup(r)?PbxObject.frases.ADD_GROUP:PbxObject.frases.ADD)+"</span>",o.appendChild(i),s.appendChild(o);var c,d,u,o,i,m=e;for(sortByKey(m,"name"),c=0;c<m.length;c++)("trunk"!==r||"system"!==m[c].type)&&(d=m[c].oid,u=m[c].name,o=document.createElement("li"),o.setAttribute("data-oid",d),i=document.createElement("a"),i.href="#"+r+"/"+d,i.innerHTML=u,o.appendChild(i),s.appendChild(o));$(n).siblings().remove("ul"),a.append(s),show_content(!1),t=$(n).next("ul"),t&&t.slideDown("normal"),a.addClass("active")})}else t=$(n).next("ul"),t&&t.slideDown("normal"),a.addClass("active");a.siblings("li.active").removeClass("active").children("ul:visible").slideUp("normal")}function get_object(e){var t=location.hash.substring(1),n=-1!==t.indexOf("?")?t.substring(t.indexOf("?")+1):null,o=-1!=t.indexOf("/")?t.substring(0,t.indexOf("/")):t.substring(0),a=-1!=t.indexOf("/")?t.substring(t.indexOf("/")+1,n?t.indexOf("?"):t.length):null;PbxObject.language;if(t!==PbxObject.query){if(t){PbxObject.query=t,PbxObject.search=n,PbxObject.kind=o,PbxObject.oid=a,$("#dcontainer").addClass("faded"),show_loading_panel();var r=document.getElementById("el-extension");r&&r.parentNode.removeChild(r);var s=["equipment","unit","users","conference","selector","channel","pickup"];-1!=s.indexOf(o)&&(o="bgroup"),PbxObject.templates[o]?load_template(PbxObject.templates[o],o):request("GET","/badmin/views/"+o+".html",null,null,function(e,t){PbxObject.templates[o]=t,load_template(t,o)})}isSmallScreen()&&$("#pagecontent").hasClass("squeezed-right")&&($("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),$("#pbxmenu").scrollTop(0))}}function load_template(e,t){var n="load_"+t,o=window[n],a=Mustache.render(e,PbxObject.frases);$("#dcontainer").html(a),"extensions"===t||"channels"===t?getExtensions(o):PbxObject.oid?json_rpc_async("getObject",'"oid":"'+PbxObject.oid+'"',o):o(),$("#dcontainer").scrollTop(0),$(".squeezed-menu > ul").children("li.active").removeClass("active").children("ul:visible").slideUp("normal")}function getPartial(e,t){PbxObject.partials=PbxObject.partials||{};var n=PbxObject.partials[e];n?t(n):request("GET","/badmin/partials/"+e+".html",null,null,function(n,o){PbxObject.partials[e]=o,t(o)})}function getTemplate(e,t){PbxObject.templates=PbxObject.templates||{};var n=PbxObject.templates[e];n?t(n):request("GET","/badmin/views/"+e+".html",null,null,function(n,o){PbxObject.templates[e]=temp,t(temp)})}function getTempParams(){return PbxObject.currentObj}function updateTempParams(e){console.log("updateTempParams: ",e),PbxObject.currentObj=extend(PbxObject.currentObj||{},e)}function setTempParams(e){console.log("setTempParams: ",e),PbxObject.currentObj=e}function clearTempParams(){PbxObject.currentObj={}}function set_page(){var e=PbxObject.kind,t=["equipment","unit","users","conference","selector","channel","pickup"];-1!=t.indexOf(e)&&(e="bgroup");var n=document.getElementById("dcontainer"),o=n.querySelectorAll(".transrow"),a=n.querySelectorAll(".clirow"),r=document.getElementById("add-route"),s=document.getElementById("el-set-object"),i=document.getElementById("el-delete-object"),l="set_"+e,c=window[l];if(o.length)for(m=0;m<o.length;m++)addEvent(o[m],"click",append_transform);if(a.length)for(m=0;m<a.length;m++)addEvent(a[m],"click",add_cli_row);if(r&&addEvent(r,"click",add_new_route),s){var d=PbxObject.name?PbxObject.frases.SAVE:PbxObject.frases.CREATE;s.innerHTML='<i class="fa fa-check"></i> '+d,s.onclick=function(){c()}}i&&(PbxObject.name?i.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}:i.setAttribute("disabled","disabled"));for(var u=document.getElementsByClassName("el-sortable"),m=0;m<u.length;m++)new Sortable(u[m]);add_search_handler(),$(".selectable-cont").click(function(e){var t=e.target;if(t.getAttribute("data-value"))move_list_item(e);else{var n,o,a=getClosest(t,".selectable-cont");if(t.classList.contains("assign-all"))n=a.querySelector(".members"),o=a.querySelector(".available");else{if(!t.classList.contains("unassign-all"))return;n=a.querySelector(".available"),o=a.querySelector(".members")}move_list(n,o)}}),$("#dcontainer div.panel-header:not(.panel-static)").click(toggle_panel),$('#dcontainer [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),$('#dcontainer [data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}})}function setBreadcrumbs(){for(var e=document.getElementById("main-breadcrumb");e.firstChild;)e.removeChild(e.firstChild);if(PbxObject.kind){var t,n,o=document.getElementById("objname"),a=document.createDocumentFragment();t=document.createElement("li"),t.innerHTML='<a href="#'+PbxObject.kind+"/"+PbxObject.kind+'">'+PbxObject.frases.KINDS[PbxObject.kind]+"</a>",n=document.createElement("li"),n.className="active",o&&(n.innerHTML=o.value,addEvent(o,"input",function(){n.innerHTML=o.value})),a.appendChild(t),a.appendChild(n),e.appendChild(a)}}function getAvailablePool(e){json_rpc_async("getObject",{oid:"user"},function(t){console.log("getAvailablePool: ",t),e(t.available.sort())})}function toggle_sidebar(e){e&&e.preventDefault(),$(this).toggleClass("flipped"),$("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),isSmallScreen()||toggle_menu()}function toggle_menu(){$("#pbxmenu").toggleClass("squeezed-menu")}function open_options(e){e&&e.preventDefault(),$("#el-slidemenu").addClass("hide-menu"),$("#pagecontent").addClass("pushed-left"),$("#pbxoptions").addClass("pushed-left"),isOptionsOpened(!0)}function close_options(e){e&&e.preventDefault(),$("#pagecontent").removeClass("pushed-left"),$("#pbxoptions").removeClass("pushed-left"),$("#el-slidemenu").removeClass("hide-menu"),setTimeout(function(){$("#pbxoptions").removeClass("top-layer"),$("#el-options-content").remove()},500),isOptionsOpened(!1)}function isOptionsOpened(e){return void 0!==e&&(PbxObject.optionsOpened=e),PbxObject.optionsOpened?!0:!1}function showModal(e,t,n,o,a){var r=document.getElementById(e),s=document.getElementById("pagecontainer");r&&r.parentNode.removeChild(r),getPartial(e,function(i){t.frases=PbxObject.frases,r=Mustache.render(i,t),s.insertAdjacentHTML("afterbegin",r),$("#"+e).modal(),$("#"+e).on("shown.bs.modal",function(e){n&&setModal(this,n),o&&o(this)}),a&&$("#"+e).on("hide.bs.modal",function(e){a(this)})})}function setModal(e,t){var n=e.querySelector('[data-type="submit"]'),o=e.querySelector("form");n&&addEvent(n,"click",function(n){n.target.disabled=!0,t(o?retrieveFormData(o):null,e)})}function openModal(e,t){var n={},o=document.getElementById(e.modalId);getPartial(e.tempName,function(a){n.frases=PbxObject.frases,e.data&&(n.data=e.data);var r=Mustache.render(a,n),s=document.querySelector("#pagecontainer");o&&o.parentNode.removeChild(o),s.insertAdjacentHTML("afterbegin",r),$("#"+e.modalId).modal(),t&&t()})}function toggle_panel(e){e.preventDefault();var t=$(this).closest(".panel"),n=t.children(".panel-body");n.slideToggle(),t.toggleClass("minimized")}function toggle_presentation(){$("#el-slidemenu").addClass("hide-menu"),$("#pagecontent").addClass("pushed-left"),$("#pbxoptions").addClass("pushed-left")}function show_loading_panel(e){if(!document.getElementById("el-loading")){var t=document.createElement("div");t.id="el-loading",t.className="el-loading-panel ";var n=document.createElement("div");n.className="loader",n.innerHTML='<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>',t.appendChild(n);var o=e||document.getElementById("pagecontainer");o.appendChild(t)}}function remove_loading_panel(){var e=document.getElementById("el-loading");e&&e.parentNode.removeChild(e)}function show_content(e){setBreadcrumbs(),remove_loading_panel(),$("#dcontainer").hasClass("faded")&&$("#dcontainer").removeClass("faded"),e===!1}function switchMode(e){var t=[].slice.call(document.querySelectorAll(".branch-mode"));-1==e.indexOf("channels")&&t.forEach(function(e){-1!=e.className.indexOf("mode-channels")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no selectors")&&t.forEach(function(e){-1!=e.className.indexOf("mode-selector")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no users")&&t.forEach(function(e){-1!=e.className.indexOf("mode-users")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no trunks")&&t.forEach(function(e){-1!=e.className.indexOf("mode-trunks")&&e.parentNode.removeChild(e)}),-1!==e.indexOf("no groups")&&t.forEach(function(e){-1!=e.className.indexOf("mode-groups")&&e.parentNode.removeChild(e)})}function switch_presentation(e,t,n){var o=t||document.getElementById("dcontainer"),n=n?"."+n:".pl-kind",a=[].slice.call(o.querySelectorAll(n));a.forEach(function(t){t.classList.contains("pl-"+e)||t.classList.contains("pl-all")?(t.style.display="",t.classList.contains("pl-no-"+e)&&(t.style.display="none")):t.style.display="none"})}function switch_tab(e){for(var t=document.getElementById(e),n=t.parentNode.parentNode,o=n.children,a=0;a<o.length;a++)o[a].children[0].id!=e?o[a].style.display="none":o[a].style.display=""}function switch_options_tab(e){for(var t=document.getElementById(e),n=t.parentNode,o=n.children,a=1;a<o.length;a++)o[a].id!=e?o[a].style.display="none":o[a].style.display=""}function add_search_handler(){var e=[].slice.call(document.querySelectorAll(".el-search"));e.length&&e.forEach(function(e){e.getAttribute("data-element")&&(e.oninput=function(e){filter_element(e)})})}function makeElement(e,t,n,o){var a=document.createDocumentFragment();e.forEach(function(e){a.appendChild(n(e))}),o&&clearTable(t),t.appendChild(a)}function filter_element(e){var t,n,e=e||window.event,o=e.target||this,a=o.getAttribute("data-element"),r=document.getElementById(a);n=o.value.toLowerCase(),"TABLE"==r.nodeName?(defClass="table-row",r=r.querySelector("tbody")):defClass="block";for(var s=0;s<r.children.length;s++)child=r.children[s],t=child.textContent.toLowerCase(),child.style.display=-1===t.indexOf(n)?"none":defClass}function arrayToPattern(e,t){return e+"|"+t}function filterObject(e,t,n){var o=[],a=!1,r=t?Array.isArray(t)?t:[t]:[];return r.length?o=e.filter(function(e){return a=-1!==r.indexOf(e.kind),n?!a:a}):e}function getObjects(e,t,n){"object"==typeof PbxObject.objects?t(filterObject(PbxObject.objects,e,n)):json_rpc_async("getObjects",{kind:"all"},function(o){sortByKey(o,"name"),PbxObject.objects=o,t(filterObject(PbxObject.objects,e,n))})}function addObjects(e,t,n){return console.log("addObjects: ",e,t,n),e.push(t),sortByKey(e,n)}function updateObjects(e,t,n){return console.log("updateObjects: ",e,t,n),e=e.map(function(e,o,a){return e[n]===t[n]?extend(a[o],t):e})}function deleteObjects(e,t,n){return console.log("deleteObjects: ",e,t,n),e=e.filter(function(e,o,a){return e[n]!==t[n]}),console.log("deleteObjects arrays: ",e),e}function notify_about(e,t){var n,o,a,r=document.createElement("div"),s=document.createElement("i"),i=document.getElementsByTagName("body")[0];switch(e){case"success":o='<span class="fa fa-check"></span>',a="el-notifier-ok";break;case"error":o='<span class="fa fa-close"></span>',a="el-notifier-error";break;default:o='<span class="fa fa-warning"></span>',a="el-notifier-info"}s.className="fa fa-close el-close-notify",r.className="el-notifier "+a,r.innerHTML+=o+" "+t,r.appendChild(s),i.appendChild(r),n=setTimeout(function(){removeEvent(s,"click",function(){i.removeChild(r),clearTimeout(n)}),i.removeChild(r)},7e3),addEvent(s,"click",function(){i.removeChild(r),clearTimeout(n)})}function append_transforms(e,t){t.forEach(function(t){append_transform(null,e,t)})}function append_transform(e,t,n){var o,a,r,s,i,l;if(t)o=document.getElementById(t);else{if(!e||"click"!=e.type)return;var e=e||window.event,c=e.target||e.srcElement;e.preventDefault(),o=getClosest(c,"table")}a=o.querySelector("tbody"),s=a.rows.length,row=a.insertRow(s),r=row.insertCell(0),i=document.createElement("div"),i.className="form-group",l=document.createElement("input"),l.className="form-control",l.setAttribute("type","text"),l.setAttribute("name","number"),null!=n&&l.setAttribute("value",n.number),i.appendChild(l),r.appendChild(i),r=row.insertCell(1),r.setAttribute("align","center"),i=document.createElement("div"),i.className="form-group",l=document.createElement("input"),l.setAttribute("type","checkbox"),l.setAttribute("name","strip"),null!=n&&(l.checked=n.strip),i.appendChild(l),r.appendChild(i),r=row.insertCell(2),i=document.createElement("div"),i.className="form-group",l=document.createElement("input"),l.className="form-control",l.setAttribute("type","text"),l.setAttribute("name","prefix"),null!=n&&l.setAttribute("value",n.prefix),i.appendChild(l),r.appendChild(i),r=row.insertCell(3),i=document.createElement("div"),i.className="form-group",l=document.createElement("a"),l.href="#",l.className="remove-clr",l.innerHTML='<i class="fa fa-minus"></i>',addEvent(l,"click",remove_row),i.appendChild(l),r.appendChild(i)}function clear_transforms(e){var t,n,o;for(t=0;t<e.length;t++)for(o=document.getElementById(e[t]),n=o.rows.length-1;n>1;n--)o.deleteRow(n)}function transformsToArray(e){var t,n=document.getElementById(e).getElementsByTagName("tbody")[0],o=[].slice.call(n.children);return o=o.map(function(e){return t={},[].slice.call(e.querySelectorAll("input[name]")).map(function(e){t[e.name]="checkbox"===e.type?e.checked:e.value}),t}).filter(function(e){return""!==e.number})}function encode_transforms(e){for(var t=document.getElementById(e).getElementsByTagName("tbody")[0],n="",o=t.children.length;o--;){var a=t.children[o],r=a.getElementsByTagName("input"),s=r.length,i=a.querySelector('input[name="number"]');if(i.value){for(n+="{";s--;)"number"==r[s].name?n+='"number":"'+r[s].value+'",':"strip"==r[s].name?n+='"strip":'+r[s].checked+",":"prefix"==r[s].name&&(n+='"prefix":"'+r[s].value+'",');n+="},"}}return n}function remove_row(e){e.preventDefault();for(var t,n=e.currentTarget,o=n.parentNode;"TBODY"!=o.nodeName;)"TR"==o.nodeName&&(t=o),o=o.parentNode;o.removeChild(t)}function updateObjectCache(e){var t=PbxObject.objects||[],n=t.filter(function(t){return t.oid===e.oid})[0];n&&(n.enabled=e.enabled,n.name=e.name)}function objectStateUpdated(e){var t=document.getElementById("enabled");t&&(t.checked=e.enabled),console.log("objectStateUpdated: ",e),void 0!==e.up&&changeTrunkRegState(e.up)}function newObjectAdded(e,t){var n=t.oid,o=t.kind,a=t.name,r=(t.enabled,document.getElementById("objname")),s=document.getElementById("el-set-object"),i=document.getElementById("el-delete-object"),l=document.getElementById("ul-"+t.kind);if(remove_loading_panel(),notify_about("success",a+" "+PbxObject.frases.CREATED),console.log("newObjectAdded: ",r,a),r&&a&&(r.value=a),t.ext&&addObjects(PbxObject.extensions,t,"ext"),"phone"!==o&&"user"!==o){if(l){var c=document.createElement("li"),d=document.createElement("a");d.href="#"+o+"/"+n,d.innerHTML=a,c.setAttribute("data-oid",n),c.appendChild(d),l.appendChild(c)}i&&i.hasAttribute("disabled")&&(i.removeAttribute("disabled"),i.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid,t.ext)}),"application"!==o&&(PbxObject.query=o+"/"+n,window.location.href="#"+PbxObject.query),s&&(s.innerHTML='<i class="fa fa-check fa-fw"></i> '+PbxObject.frases.SAVE),"object"==typeof PbxObject.objects&&(PbxObject.objects.push(t),sortByKey(PbxObject.objects,"name"))}}function updateMenu(e,t){var n=document.getElementById("ul-"+t.kind),o=[];n&&(o=o.slice.call(n.querySelectorAll("li a")),o.forEach(function(e){-1!==e.href.indexOf(t.oid)&&(e.textContent=t.name)}))}function objectDeleted(e){var t,n=e.kind?document.getElementById("ul-"+e.kind):document.querySelector("#pbxmenu .nav-list"),o=n?[].slice.call(n.querySelectorAll("li ul li")):[];console.log("objectDeleted: ",e.kind,n,o),o.forEach(function(n){t=n.getAttribute("data-oid"),t&&t===e.oid&&n.parentNode.removeChild(n)}),"object"==typeof PbxObject.objects&&(PbxObject.objects=PbxObject.objects.filter(function(t){return t.oid!==e.oid}))}function set_object_success(){remove_loading_panel(),notify_about("success",PbxObject.frases.SAVED)}function set_options_success(){var e,t="",n=window.location.pathname.split("/");for(e=0;e<n.length;e++)("en"===n[e]||"uk"===n[e]||"ru"===n[e])&&(n[e]=PbxObject.language),t+="/",t+=n[e];var o=window.location.protocol+"//"+window.location.host+t.substring(1);window.location.href=o}function delete_object(e,t,n,o){var a=o?!0:confirm(PbxObject.frases.DODELETE+" "+e+"?");return a?void json_rpc_async("deleteObject",'"oid":"'+n+'"',function(){objectDeleted({name:e,kind:t,oid:n}),window.location.hash=t+"/"+t}):!1}function delete_extension(e){var t=getClosest(e.target,"tr"),n=t.id,o=(t.parentNode,t.getAttribute("data-ext")),a=t.querySelector("a"),r="extensions"===PbxObject.kind?t.cells[2].textContent:PbxObject.name,s=PbxObject.frases.DODELETE+" "+o+" "+PbxObject.frases.FROM.toLowerCase()+" "+(r?r:"")+"?",i=confirm(s);return PbxObject.members=PbxObject.members||[],PbxObject.available=PbxObject.available||[],i?void json_rpc_async("deleteObject",'"oid":"'+n+'"',function(){a&&(a.removeAttribute("href"),removeEvent(a,"click",get_extension)),PbxObject.members.forEach(function(e,t,o){e.oid===n&&o.splice(t,1)}),PbxObject.available.push(o),PbxObject.available.sort()}):!1}function onObjectDelete(e,t){t.ext&&/extensions|users|equipment/.test(PbxObject.kind)?(delete_extension_row(t),PbxObject.extensions=deleteObjects(PbxObject.extensions,t,"ext")):objectDeleted(t)}function delete_extension_row(e){var t=document.getElementById("extensions")||document.getElementById("group-extensions");t=t.querySelector("tbody");var n=document.getElementById(e.oid);t.removeChild(n);var o=document.getElementById("available-users");o&&(o.innerHTML+='<option value="'+e.ext+'">'+e.ext+"</option>")}function validateInput(e){var e=e||window.event;-1!==[46,9,8,27,13].indexOf(e.keyCode)||65==e.keyCode&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=40||188==e.keyCode&&e.shiftKey===!1||189==e.keyCode&&e.shiftKey===!1||(e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault()}function escapeValue(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function getFileName(e){if(null!==e){var t="";return Array.isArray(e)?e.forEach(function(e,n,o){t+=" "+e,n!==o.length-1&&(t+=",")}):t=" "+e,t}return""}function customize_upload(e,t){var n=document.getElementById(e);if(!n)return void console.error("custommize_upload: File element not found");var o=n.parentNode,a=document.createElement("button"),r=document.createElement("span");o.className+=" nowrap";var s=getFileName(t);r.innerHTML=s,r.title=s,r.className="upload-filename",a.type="button",a.className="btn btn-default btn-sm needsclick",a.innerHTML="Upload",a.onclick=function(){n.click()},o.insertBefore(a,n),o.insertBefore(r,n),n.onchange=function(){this.files.length?(s=getFileName(this.files[0].name),r.innerHTML=s,r.title=s):(r.innerHTML=" ",r.title="")}}function upload(e,t){var n;if(isElement(e))n=e;else{if("string"!=typeof e)return!1;n=document.getElementById(e)}var o=n.files;if(0==o.length)return!1;var a=o[0],r=t?t:"/"+a.name,s=new XMLHttpRequest,i=setTimeout(function(){s.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);s.onreadystatechange=function(){4==s.readyState&&(clearTimeout(i),200!=s.status?notify_about("error",PbxObject.frases.ERROR):"uploadapp"==e&&notify_about("success",a.name+" "+PbxObject.frases.UPLOADED))},s.open("PUT",r,!0),s.send(a),console.log("upload",a,r)}function uploadFile(e,t){if(!e)return!1;var n=t?t:"/"+e.name,o=new XMLHttpRequest,a=setTimeout(function(){o.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);o.onreadystatechange=function(){4==o.readyState&&(clearTimeout(a),200!=o.status&&notify_about("error",PbxObject.frases.ERROR))},o.open("PUT",n,!0),o.send(e)}function deleteFile(e){if(e){var t=new XMLHttpRequest,n=setTimeout(function(){t.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);t.onreadystatechange=function(){4==t.readyState&&(clearTimeout(n),200!=t.status&&notify_about("error",PbxObject.frases.ERROR))},t.open("DELETE",e,!0),t.send(),console.log("file deleted",e)}}function b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function get_object_link(e){var t=json_rpc("getObject",'"oid":"'+e+'"');location.hash=t.kind+"/"+e}function setObjectState(e,t,n){e&&void 0!==t&&json_rpc_async("setObjectState",{oid:e,enabled:t},function(e){n&&n(e)})}function setFormData(e,t){for(var n,o,a=0;a<e.elements.length;a++)n=e.elements[a],n.hasAttribute("name")&&(o=n.name,t.forEach(function(e){e.hasOwnProperty("key")&&e.key===o&&"file"!==n.type&&("checkbox"===n.type?n.checked=e.value:n.value=e.value)}))}function retrieveFormData(e){for(var t,n,o,a,r={},s=0;s<e.elements.length;s++)n=e.elements[s],t=n.getAttribute("data-type")||n.type,n.hasAttribute("name")&&(o=n.name,a="number"===t?parseFloat(n.value):"checkbox"===t?n.checked:"file"===t?n.files.length?n.files[0].name:null:n.value,void 0!==a&&null!==a&&(r[o]=a));return r}function isSmallScreen(){return $(window).width()<768}function convertBytes(e,t,n){var o={Byte:1,KB:1e3,MB:1e6,GB:1e9};return e*o[t]/o[n]}function debounce(e,t,n){var o;return function(){var a=this,r=arguments,s=function(){o=null,n||e.apply(a,r)},i=n&&!o;clearTimeout(o),o=setTimeout(s,t),i&&e.apply(a,r)}}function toTheTop(e){var t=$(document).scrollTop(),n=e?$("#"+e).offset().top:0;n>t||$("html body").animate({scrollTop:n},500)}function copyFromField(e,t){var n=getClosest(e,".input-group"),o=n.querySelector("input"),a=document.getElementById(t);o.value=a.value}function revealPassword(e){var t=getClosest(e,".input-group"),n=t.querySelector("input");"password"==n.type?(n.type="text",e.innerHTML='<i class="fa fa-eye-slash" data-toggle="tooltip" title="'+PbxObject.frases.HIDE_PWD+'"></i>'):(n.type="password",e.innerHTML='<i class="fa fa-eye" data-toggle="tooltip" title="'+PbxObject.frases.REVEAL_PWD+'"></i>')}function generatePassword(e){for(var t,n=getClosest(e,".input-group"),o=n.querySelector("input"),a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",r="",s=8,i=0;s>i;i++)t=Math.floor(62*Math.random()),r+=a.charAt(t);o.value=r}function getClosest(e,t){for(var n=t.charAt(0);e&&e!==document;e=e.parentNode)if("."===n){if(e.classList.contains(t.substr(1)))return e}else if("#"===n){if(e.id===t.substr(1))return e}else if("["===n){if(e.hasAttribute(t.substr(1,t.length-2)))return e}else if(e.nodeName===t.toUpperCase())return e;return!1}function checkAll(e,t){[].forEach.call(document.querySelectorAll(e),function(e){e.checked=t})}function isVisible(e,t){var n=document.getElementById(e),o=t?"remove":"add";n.classList[o]("hidden")}function switchDisabledState(e){var t,n,o,a,r;isElement(e)?t=e:(o=e||window.event,t=o.target),n=t.checked,a=t.getAttribute("data-name"),r=[].slice.call(document.querySelectorAll('input[name="'+a+'"]')),r.forEach(function(e){e.disabled=!n})}function isElement(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}function isGroup(e){var t=["equipment","unit","users","icd","hunting","cli","pickup"];return-1!=t.indexOf(e)?!0:void 0}function isMaxNumber(e){return 2147483647===e}function sortSelectOptions(e){var t=e.querySelectorAll("options");t.sort(function(e,t){return e.text.toUpperCase()>t.text.toUpperCase()?1:e.text.toUpperCase()<t.text.toUpperCase()?-1:0}),$(e).empty().append(t)}function sortByKey(e,t){return e.sort(function(e,n){return e[t]<n[t]?-1:e[t]>n[t]?1:0}),e}function objFromString(e,t){return e[t]}function formatTimeString(e,t){var n,o,a,r;return n=Math.floor(e/3600),e-=3600*n,o=Math.floor(e/60),r=(10>n?"0"+n:n)+":"+(10>o?"0"+o:o),"hh:mm:ss"==t&&(a=e-60*o,r+=":"+(10>a?"0"+a:a)),r}function formatDateString(e){var t="NaN"!==parseInt(e)?parseInt(e):e,n=new Date(t),o=n.getDate()<10?"0"+n.getDate():n.getDate(),a=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,r=n.getHours()<10?"0"+n.getHours():n.getHours(),s=n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes();return o+"/"+a+"/"+n.getFullYear()+" "+r+":"+s}function fillTable(e,t,n,o){e&&t&&n&&("object"==typeof t?t.forEach(function(t){e.appendChild(n(t))}):e.appendChild(n(t)),o&&o())}function clearTable(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function clearColumns(e){for(var t=e.querySelector("thead"),n=e.rows;t.rows[0].cells.length>1;)for(var o=0;o<n.length;o++)n[o].cells.length>1&&n[o].deleteCell(-1)}function elPosition(e){var t=getViewportH(),n=getOffset(e),o=n.top,a=t-o-e.offsetHeight;return a<=e.offsetHeight?"top":"bottom"}function getViewportH(){var e=document.documentElement,t=e.clientHeight,n=window.innerHeight;return n>t?n:t}function getOffset(e){return e.getBoundingClientRect()}function extend(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function deepExtend(e,t){for(var n in t)t[n]&&t[n].constructor&&t[n].constructor===Object?(e[n]=e[n]||{},arguments.callee(e[n],t[n])):e[n]=t[n];return e}function addEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)}function removeEvent(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}function createNewButton(e){var t=document.createElement("button");return("popover"===e.type||"tooltip"===e.type)&&(t.setAttribute("data-toggle",e.type),void 0!==e.html&&t.setAttribute("data-html",e.html),e.placement&&t.setAttribute("data-placement",e.placement),e.dataContent&&t.setAttribute("data-content",e.dataContent),e.dataTrigger&&t.setAttribute("data-trigger",e.dataTrigger)),t.className=e.classname||"",t.innerHTML=e.content||"",e.title&&(t.title=e.title),e.handler&&addEvent(t,e.evtType||"click",e.handler),t}function setAccordion(e){var t=e?e:"";$(t+" .acc-cont > .acc-pane").slideToggle(),$(t+" .acc-cont > .acc-header").click(function(){$(this).next(".acc-pane").slideToggle(),$(this).toggleClass("current"),$(this).siblings(".acc-header").removeClass("current")})}function createCodecRow(e){var t,n;return t=document.createElement("tr"),n=t.insertCell(0),n.className="draggable",n.innerHTML='<i class="fa fa-ellipsis-v"></i>',n=t.insertCell(1),n.className="codec-name",n.innerHTML=e.codec,n=t.insertCell(2),n.innerHTML='<input type="text" class="form-control codec-frames" value="'+(e.frame?e.frame:30)+'">',n=t.insertCell(3),n.innerHTML='<input type="checkbox" '+(e.enabled?"checked":"")+' class="codec-enabled">',t}function buildCodecsTable(e,t,n){var o=[],a=document.createDocumentFragment(),r=isElement(e)?e:document.getElementById(e);o=o.concat(n),t.forEach(function(e){e.enabled=!0,a.appendChild(createCodecRow(e)),-1!=o.indexOf(e.codec)&&o.splice(o.indexOf(e.codec),1)}),o.forEach(function(e){a.appendChild(createCodecRow({codec:e}))}),r.appendChild(a)}function getCodecsString(e){for(var t,n,o=[],a=isElement(e)?e:document.getElementById(e),r=0;n=a.rows[r];r++)n.getElementsByClassName("codec-enabled")[0].checked&&(t={codec:n.getElementsByClassName("codec-name")[0].textContent,frame:parseInt(n.getElementsByClassName("codec-frames")[0].value)},o.push(t));return o}function getFriendlyCodeName(e){return PbxObject.frases.CODES[e.toString()]}function fill_select_items(e,t){var n,o=document.getElementById(e);t.forEach(function(e){n=document.createElement("option"),n.value=e.oid,n.textContent=e.name,o.appendChild(n)})}function fill_list_items(e,t,n){("available"==e||"hunting"!=PbxObject.kind&&"icd"!=PbxObject.kind&&"unit"!=PbxObject.kind)&&t.sort();for(var o=document.getElementById(e),a=document.createDocumentFragment(),r=0;r<t.length;r++){var s=n?t[r][n]:t[r],i=document.createElement("li");i.setAttribute("data-value",s),i.innerHTML=s,a.appendChild(i)}o.appendChild(a)}function move_list_item(e){var t=e.target,n=getClosest(t,".selectable-cont"),o=t.parentNode;o.classList.contains("available")?(o.removeChild(t),n.querySelector(".members").appendChild(t)):(o.removeChild(t),n.querySelector(".available").appendChild(t))}function move_list(e,t){var e=isElement(e)?e:document.getElementById(e),t=isElement(t)?t:document.getElementById(t),n=[].slice.call(t.querySelectorAll("li"));n.forEach(function(t){e.appendChild(t)})}function changeGroupType(e){var t=[].slice.call(document.querySelectorAll(".object-type"));t.forEach(function(t){t.classList.contains(e)?t.classList.remove("hidden"):t.classList.add("hidden")})}function newInput(e){var t=document.createElement("div");if(t.className="form-group",e.label){var n='<label for="'+e.id+'">'+e.label+"</label>";t.innerHTML+=n}var o='<input type="'+(e.type||"text")+'" class="form-control" id="'+(e.id||"")+'" value="'+(e.value||"")+'">';return t.innerHTML+=o,t}function switchVisibility(e,t){t?$(e).show():$(e).hide()}function get_protocol_opts(e,t){var n="h323"==e?"h323":"sip",o=0!==Object.keys(PbxObject.protocolOpts).length?PbxObject.protocolOpts:t,a=[{mode:"sip info",sel:"sip info"===o.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===o.dtmfmode},{mode:"inband",sel:"inband"===o.dtmfmode}],r=[{mode:"h245alpha",sel:"h245alpha"===o.dtmfmode},{mode:"h245signal",sel:"h245signal"===o.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===o.dtmfmode},{mode:"inband",sel:"inband"===o.dtmfmode}],s={opts:o,frases:PbxObject.frases};s.opts.dtmfmodes="h323"==n?r:a;var i=Mustache.render(PbxObject.templates.protocol,s),l=document.getElementById("proto-cont");l||(l=document.createElement("div"),l.id="proto-cont",$("#pagecontainer").prepend(l)),$(l).html(i);var c=["Opus","G.711 Alaw","G.711 Ulaw","G.729","G.723"],d=document.getElementById("protocol-codecs").querySelector("tbody");buildCodecsTable(d,s.opts.codecs,c),new Sortable(d),switch_presentation(n,l),$("#el-protocol").modal(),$("#el-set-protocol").click(function(){save_proto_opts(n)})}function save_proto_opts(e){var t=PbxObject.protocolOpts,n=document.getElementById("protocol-codecs").querySelector("tbody");t.codecs=getCodecsString(n),
document.getElementById("t1")&&(t.t1=parseInt(document.getElementById("t1").value)),document.getElementById("t2")&&(t.t2=parseInt(document.getElementById("t2").value)),document.getElementById("t3")&&(t.t3=parseInt(document.getElementById("t3").value)),document.getElementById("t38fax")&&(t.t38fax=document.getElementById("t38fax").checked),document.getElementById("pvideo")&&(t.video=document.getElementById("pvideo").checked),document.getElementById("earlymedia")&&(t.earlymedia=document.getElementById("earlymedia").checked),document.getElementById("dtmfrelay")&&(t.dtmfrelay=document.getElementById("dtmfrelay").checked),t.dtmfmode=document.getElementById("dtmfmode").value,"h323"==e?(t.faststart=document.getElementById("faststart").checked,t.h245tunneling=document.getElementById("h245tunneling").checked,t.playringback=document.getElementById("playringback").checked):(t.nosymnat=document.getElementById("nosymnat").checked,t.buffering=document.getElementById("buffering").checked,t.noprogress=document.getElementById("noprogress").checked,t.noredirectinfo=document.getElementById("noredirectinfo").checked,t.passanumber=document.getElementById("passanumber").checked),$("#el-protocol").modal("hide")}function updateConference(e){var t=e.params,n=document.getElementById(t.oid);if(n){var o=n.querySelector('[data-cell="parties"]');if(o){var a=n.querySelector(".showPartiesBtn");t.total?(o.textContent=t.total,a.removeAttribute("disabled")):(o.textContent="",a.setAttribute("disabled","disabled"))}}var r=PbxObject.channels;r&&r.forEach(function(e){if(e.oid===t.oid){var n=e.parties;1==t.state?(n||(e.parties=n=[]),-1==n.indexOf(t.number)&&n.push(t.number)):0==t.state&&n.splice(n.indexOf(t.number),1)}})}function getInfoFromState(e,t){var n,o;return o=1==e?"success":8==e?"connected":2==e||5==e?"warning":0==e||-1==e&&t?"default":3==e?"danger":6==e||7==e?"info":"active",n=PbxObject.frases.STATES[e]||"",{rstatus:n,rclass:"bg-"+o,className:o}}function getQueryParams(e){return(e||document.location.search).replace(/(^\?)/,"").split("&").map(function(e){return e=e.split("="),this[e[0]]=e[1],this}.bind({}))[0]}function getSystemTime(e){json_rpc_async("getSystemTime",null,function(t){return e?t:void 0})}function fill_group_choice(e,t,n){var n=n||document.getElementById("extgroup");if(n){for(;n.firstChild;)n.removeChild(n.firstChild);getObjects(e,function(e){var o,a,r,s;if(!e.length)return r=document.createElement("option"),r.value="",r.innerHTML=t,r.disabled="disabled",void n.appendChild(r);for(s=0;s<e.length;s++)o=e[s].oid,a=e[s].name,r=document.createElement("option"),r.setAttribute("value",o),(o==t||a==t)&&(r.selected="true"),r.innerHTML=e[s].name,n.appendChild(r)})}}function change_protocol(){var e=this.value||document.getElementById("protocols").value;"h323"==e?(document.getElementById("sip").parentNode.style.display="none",document.getElementById("h323").parentNode.style.display=""):(document.getElementById("sip").parentNode.style.display="",document.getElementById("h323").parentNode.style.display="none")}function load_new_trunk(){function e(e){console.log("init: ",e);var n={frases:PbxObject.frases,trunks:t};ReactDOM.render(NewTrunkComponent(n),document.getElementById("el-loaded-content"))}var t=[{type:"sip",name:"SIP trunk",href:"#trunk/trunk",icon:"fa fa-fw fa-phone"},{type:"Messenger",name:"Messenger",href:"#chattrunk/chattrunk?type=Messenger",icon:"fa fa-fw fa-facebook"}];e(t),show_content(),set_page()}function poolArrayToString(e){var t="";return e.forEach(function(e,n,o){n>0&&(t+=","),t+=e.firstnumber,e.poolsize>1&&(t+="-"+(e.firstnumber+e.poolsize-1))}),t}function poolStringToObject(e){var t=[];return e.split(",").map(function(e){return e.split("-")}).forEach(function(e){t.push({firstnumber:parseInt(e[0]),poolsize:parseInt(e[1]?e[1]-e[0]+1:1)})}),t}function getDeviceSettings(){json_rpc_async("getDeviceSettings",null,loadDeviceSettings)}function loadDeviceSettings(e){console.log("loadDeviceSettings: ",e),PbxObject.deviceSettings=e;var t={data:e,frases:PbxObject.frases},n=document.getElementById("device-options"),o=Mustache.render(n.innerHTML,t);document.getElementById("device-options-cont").insertAdjacentHTML("afterbegin",o),n.parentNode.removeChild(n);var a,r=[];e.sip&&(document.getElementById("sip-log").value=e.sip.log||0,a=document.getElementById("sip-codecs").querySelector("tbody"),buildCodecsTable(a,e.sip.codecs,e.avcodecs),r.push(a)),e.sips&&(document.getElementById("sips-log").value=e.sips.log||0,a=document.getElementById("sips-codecs").querySelector("tbody"),buildCodecsTable(a,e.sips.codecs,e.avcodecs),r.push(a)),e.wss&&(document.getElementById("wss-log").value=e.wss.log||0,a=document.getElementById("wss-codecs").querySelector("tbody"),buildCodecsTable(a,e.wss.codecs,e.avcodecs),r.push(a)),e.http&&(document.getElementById("http-log").value=e.http.log||0),e.system&&(document.getElementById("rec-format").value=e.system.recformat||"PCM 8 Khz 16 bit"),e.system.smdr&&(document.getElementById("smdr-host").value=e.system.smdr.host),setAccordion("#device-options-cont"),r.forEach(function(e){new Sortable(e)})}function setTimezones(e,t){if(e){var n,o,a=moment.tz.names()||[],r=document.createDocumentFragment();o=document.createElement("option"),o.value="",o.innerText="Default timezone",r.appendChild(o),a.forEach(function(e){n=document.createElement("option"),n.value=e,n.innerText=e,r.appendChild(n)}),e.appendChild(r),e.value=t||""}}function load_pbx_options(e){var t;if(switch_options_tab("mainopt-tab"),setTimezones(document.getElementById("branch_timezone"),e.timezone),PbxObject.config=e.config||[],e.lang)for(var n=document.getElementById("interfacelang"),o=n.options.length-1;o>=0;)n.options[o].value===e.lang&&(n.options[o].selected=!0),o--;customize_upload("musonhold",e.options.holdmusicfile),document.getElementById("adminname").value=e.adminname||"";var a=document.getElementById("firstnumber");if(e.extensions?a.value=poolArrayToString(e.extensions):a.value="",e.options&&(document.getElementById("holdreminterv").value=e.options.holdremindtime||"",document.getElementById("holdrectime").value=e.options.holdrecalltime||"",document.getElementById("transrectime").value=e.options.transferrecalltime||"",document.getElementById("transrecdest").value=e.options.transferrecallnumber||"",document.getElementById("autoretrieve").checked=e.options.autoretrive,document.getElementById("parkrectime").value=e.options.parkrecalltime||"",document.getElementById("parkrecdest").value=e.options.parkrecallnumber||"",document.getElementById("discontime").value=e.options.parkdroptimeout||""),t=document.getElementById("el-set-options"),t.onclick=set_pbx_options,window.localStorage.ringo_tid)if(1!==e.mode&&e.prefix){var r=document.getElementById("deviceopt-tab"),s=document.getElementById("deviceopt-btn");r&&r.parentNode.removeChild(r),s&&s.parentNode.removeChild(s)}else getDeviceSettings();else{var i=document.getElementById("billing-tab");i&&i.parentNode.removeChild(i)}loadAdvancedOptions({ldap:e.ldap||{}}||{}),setAccordion("#featureopt-tab"),e.services?setServices(e.services):PbxObject.options.services=[],loadSecuritySettings({ipcheck:e.ipcheck||!1,iptable:e.iptable||[],adminipcheck:e.adminipcheck||!1,adminiptable:e.adminiptable||[]},setSecuritySettings)}function loadSecuritySettings(e,t){ReactDOM.render(SecuritySettings({params:e,frases:PbxObject.frases,onChange:t}),document.getElementById("security-settings-cont"))}function setSecuritySettings(e){function t(e){return e.net&&e.mask}PbxObject.options.ipcheck=e.ipcheck,PbxObject.options.iptable=e.iptable.filter(t),PbxObject.options.adminipcheck=e.adminipcheck,PbxObject.options.adminiptable=e.adminiptable.filter(t)}function loadAdvancedOptions(e){function t(e){var t=new RegExp("telephoneNumber|mobile|ipPhone");return!t.test(e)}console.log("Advanced options: ",e);var n={data:e,frases:PbxObject.frases},o=document.getElementById("ldap-settings"),a=Mustache.render(o.innerHTML,n);document.getElementById("services-options-cont").insertAdjacentHTML("afterbegin",a),o.parentNode.removeChild(o),$("#directoryAttributePhone").on("change",function(e){switchVisibility("#customDirectoryAttributePhone",t(this.value))}),$("#directoryAuth").on("change",function(e){switchVisibility("#gssapi-settings","GSSAPI"===this.value)}),switchVisibility("#gssapi-settings","GSSAPI"===e.ldap.directoryAuth),e.ldap.directoryServer&&($("#directoryAttributeUID").val(e.ldap.directoryAttributeUID),t(e.ldap.directoryAttributePhone)?($("#directoryAttributePhone").val("0"),$("#customDirectoryAttributePhone").show()):$("#directoryAttributePhone").val(e.ldap.directoryAttributePhone),$("#directoryAuth").val(e.ldap.directoryAuth))}function set_pbx_options(e){var e=e||window.event;e&&e.preventDefault(),1!==PbxObject.options.mode&&PbxObject.options.prefix||setDeviceSettings();var t,n="",o=!1,a=document.getElementById("adminname").value,r=document.getElementById("adminpass").value,s=document.getElementById("confirmpass").value,i=document.getElementById("interfacelang"),l=document.getElementById("firstnumber"),c=(document.getElementById("lastnumber"),document.getElementById("branch_timezone")),d=i.options[i.selectedIndex].value,u=getLdapOptions();if(!l||!l.value)return void alert(PbxObject.frases.OPTS__POOL_UNSPECIFIED);var m=poolStringToObject(l.value);if(n+='"extensions":'+JSON.stringify(m)+", ",r){if(r!==s)return alert(PbxObject.frases.OPTS__PWD_UNMATCH),!1;o=!0}else show_loading_panel();if(n+='"lang":"'+d+'", ',r&&(n+='"adminpass":"'+r+'", '),c.value&&(PbxObject.options.timezone=c.value,n+='"timezone":"'+c.value+'", '),n+='"ipcheck":'+(PbxObject.options.ipcheck||!1)+", ",PbxObject.options.iptable&&(n+='"iptable":'+JSON.stringify(PbxObject.options.iptable)+", "),n+='"adminipcheck":'+(PbxObject.options.adminipcheck||!1)+", ",PbxObject.options.adminiptable&&(n+='"adminiptable":'+JSON.stringify(PbxObject.options.adminiptable)+", "),u&&(n+='"ldap":'+JSON.stringify(u)+", "),PbxObject.options.services){var p=[].slice.call(document.querySelectorAll("#externalServices form")),b={},g=p.map(retrieveFormData).map(function(e){return b={},Object.keys(e).forEach(function(t){b.props=b.props||{},-1!==t.indexOf("prop_")?b.props[t.replace("prop_","")]=e[t]||"":b[t]=void 0!==e[t]?e[t]:""}),b});console.log("Saved services: ",g),n+='"services":'+JSON.stringify(g)+", "}n+='"options":{';var f=document.getElementById("musonhold");f.value&&(n+='"holdmusicfile":"'+f.files[0].name+'", ',upload("musonhold")),document.getElementById("holdreminterv").value&&(n+='"holdremindtime":'+document.getElementById("holdreminterv").value+", "),document.getElementById("holdrectime").value&&(n+='"holdrecalltime":'+document.getElementById("holdrectime").value+", "),document.getElementById("transrectime").value&&(n+='"transferrecalltime":'+document.getElementById("transrectime").value+", "),document.getElementById("transrecdest").value&&(n+='"transferrecallnumber":"'+document.getElementById("transrecdest").value+'", '),n+='"autoretrive":'+document.getElementById("autoretrieve").checked+", ",document.getElementById("parkrectime").value&&(n+='"parkrecalltime":'+document.getElementById("parkrectime").value+", "),document.getElementById("parkrecdest").value&&(n+='"parkrecallnumber":"'+document.getElementById("parkrecdest").value+'", '),document.getElementById("discontime").value&&(n+='"parkdroptimeout":'+document.getElementById("discontime").value),n+="}",d!==PbxObject.language?(PbxObject.language=d,window.localStorage.setItem("pbxLanguage",d),t=set_options_success):(t=set_object_success,PbxObject.options.ldap=u),json_rpc_async("setPbxOptions",n,function(){o&&window.localStorage.ringo_tid&&(1!==PbxObject.options.mode||PbxObject.options.prefix)?billingRequest("changePassword",{login:a,password:r},function(e,n){e||t()}):t()})}function setDeviceSettings(){var e,t="";t+='"sip":{',document.getElementById("sip-port").value&&(t+='"port":'+document.getElementById("sip-port").value+", "),document.getElementById("sip-log").value&&(t+='"log":'+document.getElementById("sip-log").value+", "),document.getElementById("sip-enabled").value&&(t+='"enabled":'+document.getElementById("sip-enabled").checked+", "),e=document.getElementById("sip-codecs").querySelector("tbody"),t+='"codecs":'+JSON.stringify(getCodecsString(e)),t+="},",t+='"sips":{',document.getElementById("sips-port").value&&(t+='"port":'+document.getElementById("sips-port").value+", "),document.getElementById("sips-log").value&&(t+='"log":'+document.getElementById("sips-log").value+", "),document.getElementById("sips-enabled").value&&(t+='"enabled":'+document.getElementById("sips-enabled").checked+", "),e=document.getElementById("sips-codecs").querySelector("tbody"),t+='"codecs":'+JSON.stringify(getCodecsString(e)),t+="},",t+='"wss":{',document.getElementById("wss-port").value&&(t+='"port":'+document.getElementById("wss-port").value+", "),document.getElementById("wss-log").value&&(t+='"log":'+document.getElementById("wss-log").value+", "),document.getElementById("wss-enabled").value&&(t+='"enabled":'+document.getElementById("wss-enabled").checked+", "),e=document.getElementById("wss-codecs").querySelector("tbody"),t+='"codecs":'+JSON.stringify(getCodecsString(e)),t+="},",t+='"http":{',document.getElementById("http-port").value&&(t+='"port":'+document.getElementById("http-port").value+", "),document.getElementById("http-log").value&&(t+='"log":'+document.getElementById("http-log").value+", "),document.getElementById("http-ssl").value&&(t+='"ssl":'+document.getElementById("http-ssl").checked+", "),t+="},",t+='"nat":{',document.getElementById("stun")&&(t+='"stun":"'+(document.getElementById("stun").value||"")+'", '),document.getElementById("router")&&(t+='"router":"'+(document.getElementById("router").value||"")+'", '),document.getElementById("rtpfirst")&&document.getElementById("rtpfirst").value&&(t+='"rtpfirst":'+document.getElementById("rtpfirst").value+", "),document.getElementById("rtplast")&&document.getElementById("rtplast").value&&(t+='"rtplast":'+document.getElementById("rtplast").value+", "),t+="},",t+='"registrar":{',document.getElementById("minexpires")&&document.getElementById("minexpires").value&&(t+='"minexpires":'+document.getElementById("minexpires").value+", "),document.getElementById("maxexpires")&&document.getElementById("maxexpires").value&&(t+='"maxexpires":'+document.getElementById("maxexpires").value+", "),t+="},",t+='"net":{',document.getElementById("tcptimeout")&&document.getElementById("tcptimeout").value&&(t+='"tcptimeout":'+document.getElementById("tcptimeout").value+", "),document.getElementById("rtptimeout")&&document.getElementById("rtptimeout").value&&(t+='"rtptimeout":'+document.getElementById("rtptimeout").value+", "),document.getElementById("iptos")&&document.getElementById("iptos").value&&(t+='"iptos":'+document.getElementById("iptos").value+", "),t+="},",t+='"system":{',document.getElementById("config-name")&&(t+='"config":"'+(document.getElementById("config-name").value||"")+'", '),document.getElementById("backup-path")&&(t+='"backup":"'+(document.getElementById("backup-path").value||"")+'", '),document.getElementById("rec-path")&&(t+='"store":"'+(document.getElementById("rec-path").value||"")+'", '),document.getElementById("rec-format")&&(t+='"recformat":"'+(document.getElementById("rec-format").value||"")+'", '),t+="},",t+='"smtp":{',document.getElementById("smtp-host").value&&(t+='"host":"'+(document.getElementById("smtp-host").value||"")+'", '),document.getElementById("smtp-port").value&&(t+='"port":"'+(document.getElementById("smtp-port").value||"")+'", '),document.getElementById("smtp-username").value&&(t+='"username":"'+(document.getElementById("smtp-username").value||"")+'", '),document.getElementById("smtp-password").value&&(t+='"password":"'+(document.getElementById("smtp-password").value||"")+'", '),document.getElementById("smtp-from")&&(t+='"from":"'+(document.getElementById("smtp-from").value||"")+'", '),t+="},",t+='"smdr":{',document.getElementById("smdr-port")&&document.getElementById("smdr-port").value&&(t+='"port":'+document.getElementById("smdr-port").value+", "),document.getElementById("smdr-host")&&document.getElementById("smdr-host").value&&(t+='"host":"'+document.getElementById("smdr-host").value+'", '),document.getElementById("smdr-enabled")&&document.getElementById("smdr-enabled").value&&(t+='"state":'+document.getElementById("smdr-enabled").checked+", "),t+="},",json_rpc_async("setDeviceSettings",t,null)}function getLdapOptions(){var e=document.querySelector("#ldap-tab form"),t=null;return e&&(t=retrieveFormData(e),"0"===!t.directoryAttributePhone&&(t.directoryAttributePhone=$("#customDirectoryAttributePhone").val()),"GSSAPI"!==t.directoryAuth&&(delete t.directoryKDC,delete t.directoryAdminServer)),console.log("setLdapOptions: ",t),t}function setServices(e){e.forEach(function(e){e.props&&Object.keys.length?e.props=Object.keys(e.props).map(function(t){return{name:t.replace("_"," "),key:t,value:e.props[t]}}):e.props=[]});var t={services:e,frases:PbxObject.frases},n=document.querySelector("#services-options-cont");console.log("Services: ",e),getPartial("services",function(e){rendered=Mustache.render(e,t),n.insertAdjacentHTML("beforeend",rendered),setAccordion("#services-options-cont")})}function Pagination(e){this.options=e,this.createPagination=function(e,t){if(this.pagin&&clearTable(this.options.table),this.currentRange=[],!(this.options.pagnum<=1)){var n,e=e||this.options.page,t=t||(this.options.pagnum>this.options.maxpagins?this.options.maxpagins:this.options.pagnum),o=document.querySelector(".pagination-container"),a=document.createElement("ul"),r=document.createElement("p");a.className="pagination custom-pagination",n=document.createElement("li"),n.innerHTML='<a href="#" class="first">&laquo;</a>',a.appendChild(n),n=document.createElement("li"),n.innerHTML='<a href="#" class="prev">-</a>',a.appendChild(n);for(var s=e;t>=s;s++)n=document.createElement("li"),n.innerHTML='<a href="#" data-page="'+s+'">'+s+"</a>",a.appendChild(n),s==t&&(this.lastPage=n),this.currentRange.push(s);for(n=document.createElement("li"),n.innerHTML='<a href="#" class="next">+</a>',a.appendChild(n),n=document.createElement("li"),n.innerHTML='<a href="#" class="last">&raquo;</a>',a.appendChild(n),this.pagin=a,this.paginInfo=r;o.hasChildNodes();)o.removeChild(o.firstChild);o.appendChild(a),o.appendChild(r),a.onclick=this._getSelectedPage.bind(this)}},this._getSelectedPage=function(e){e.preventDefault();var t=e.target,n=this._isPagin(t);n||("next"==t.className?n=this.currentPage+1:"prev"==t.className?n=this.currentPage-1:"first"==t.className?(n=1,this.options.pagnum>=this.options.maxpagins&&this.createPagination(1,this.options.maxpagins)):"last"==t.className&&(n=this.options.pagnum,n>=this.options.maxpagins&&this.createPagination(n-this.options.maxpagins+1,n))),n>this.options.pagnum||1>n||this.selectPage(n)},this.selectPage=function(e){var e=parseInt(e),t=parseInt(e)*parseInt(this.options.rows)-parseInt(this.options.rows),n=e*parseInt(this.options.rows);n=n<this.options.records.length?n:this.options.records.length,this.currentPage=e,clearTable(this.options.table);for(var o=t;n>o;o++)build_records_row(this.options.records[o],this.options.table);if(this.currentRange.length){this.currentRange.indexOf(e)==this.currentRange.length-1||this.currentRange.indexOf(e)==this.currentRange.length-2?this._appendPage():(0==this.currentRange.indexOf(e)||1==this.currentRange.indexOf(e))&&this._prependPage();var a=this.pagin.querySelector("li.active");a&&a.classList.remove("active"),this.pagin.querySelector('a[data-page="'+e+'"]').parentNode.classList.add("active")}this.paginInfo&&(this.paginInfo.innerHTML=PbxObject.frases.FROM2.toLowerCase()+" "+t+" "+PbxObject.frases.TO.toLowerCase()+" "+n+" "+PbxObject.frases.RECORDS.REC.toLowerCase())},this._appendPage=function(){var e=this.currentRange[this.currentRange.length-1]+1;if(!(e>this.options.pagnum)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,o=document.createElement("li");o.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(o,t.nextSibling),this.pagin.removeChild(n),this.currentRange.push(e),this.currentRange.shift()}},this._prependPage=function(){var e=this.currentRange[0]-1;if(!(1>e)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,o=document.createElement("li");o.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(o,n),this.pagin.removeChild(t),this.currentRange.unshift(e),this.currentRange.pop()}},this._destroyPagination=function(){for(;this.pagin&&this.pagin.hasChildNodes();)this.pagin.removeChild(this.pagin.firstChild)},this._isPagin=function(e){return e.getAttribute("data-page")}}function Picker(e,t){var n,o,a,r,s,i=document.getElementById(e),l=PbxObject.frases,c=!1,d=this;this.defaults={defaultOption:"today",interval:!1,actionButton:!0,buttonSize:"sm",buttonColor:"default"},this.defaults=extend({},this.defaults),extend(this.defaults,t),this.date={},this.interval=this.defaults.interval?36e5:null,this.intervalString="hour",this.fields={},this._pickerHandler=function(e){var t,o,a=e.target;"LABEL"===a.nodeName?(t=a.children[0].getAttribute("data-range"),t?(d._setCurrentRange(t),"custom"===t?(c=!0,n.classList.remove("ghosted")):(c=!1,n.classList.add("ghosted"))):(o=a.children[0].getAttribute("data-interval"),o&&("hour"===o?this.interval=36e5:"1/2_hour"===o?this.interval=18e5:"1/4_hour"===o?this.interval=9e5:"day"===o&&(this.interval=864e5),this.intervalString=o))):"BUTTON"===a.nodeName&&("submitButton"===a.name?(c&&d._rangeToString(),d.defaults.submitFunction&&d.defaults.submitFunction()):"selectButton"===a.name&&c&&d._rangeToString(),i.classList.toggle("open"))},this._init=function(){if(i){var e=this.template();i.innerHTML=e,dropdown=i.querySelector(".dropdown-menu"),a=[].slice.call(i.querySelectorAll('input[name="options"]')),o=i.querySelector(".dropdown-button"),btnText=o.querySelector(".btn-text"),n=i.querySelector(".custom-range"),o.onclick=function(){i.classList.toggle("open")},dropdown.onclick=function(e){d._pickerHandler(e)},this._setCurrentRange(this.defaults.defaultOption),r=document.getElementById("custom-range-from"),s=document.getElementById("custom-range-to"),rome(r,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.beforeEq(s)}),rome(s,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.afterEq(r)})}},this._setCurrentRange=function(e){if("today"===e){var t=this.today();this.date.start=t,this.date.end=t+864e5}else"yesterday"===e?(this.date.end=this.today(),this.date.start=this.date.end-864e5):"week"===e?(this.date.end=this.today()+864e5,this.date.start=this.date.end-6048e5):"30_days"===e?(this.date.end=this.today()+864e5,this.date.start=this.date.end-2592e6):"60_days"===e?(this.date.end=this.today()+864e5,this.date.start=this.date.end-5184e6):"custom"===e&&this._setCustomRange();this._setButtonText()},this._rangeToString=function(){var e=rome.find(r).getDateString("MM/DD/YYYY"),t=rome.find(s).getDateString("MM/DD/YYYY");this.date.start=new Date(e).getTime(),this.date.end=new Date(t).getTime(),this._setButtonText()},this.formatDate=function(e,t){var n=("0"+(e.getMonth()+1)).slice(-2),o=("0"+e.getDate()).slice(-2),a=e.getFullYear(),r="mm/dd/yyyy"==t?n+"/"+o+"/"+a:o+"/"+n+"/"+a;return r},this._setCustomRange=function(e){var t=this.today(),n=new Date(t),o=new Date(t+864e5);r.value=this.formatDate(n),s.value=this.formatDate(o)},this._setButtonText=function(){btnText.innerHTML=this.formatDate(new Date(this.date.start))+" - "+this.formatDate(new Date(this.date.end))},this._closeDropdowns=function(){i.classList.toggle("open"),removeEvent(document,"click",this._closeDropdowns)},this.today=function(){var e=new Date,t=new Date(this.formatDate(e,"mm/dd/yyyy")).valueOf();return t},this.template=function(){return'<button type="button" class="btn btn-'+this.defaults.buttonColor+" btn-"+this.defaults.buttonSize+' btn-block dropdown-button" aria-expanded="true"><span class="btn-text" style="margin-right:5px"></span><span class="caret"></span></button><div class="dropdown-menu"><div class="col-xs-12 btn-group btn-group-vertical" data-toggle="buttons"><label class="btn btn-default active"><input type="radio" name="options" data-range="today"autocomplete="on" checked>'+l.DATE_PICKER.TODAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="yesterday" autocomplete="off" checked>'+l.DATE_PICKER.YESTERDAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="week" autocomplete="off">'+l.DATE_PICKER.LAST_7_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="30_days" autocomplete="off">'+l.DATE_PICKER.LAST_30_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="60_days" autocomplete="off">'+l.DATE_PICKER.LAST_60_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="custom" autocomplete="off">'+l.DATE_PICKER.CUSTOM_RANGE+'</label></div><div class="col-xs-12 custom-range ghosted"><br><div class="input-group"><input type="text" class="form-control" id="custom-range-from"><span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" class="form-control" id="custom-range-to"></div></div>'+(this.defaults.interval?'<div class="col-xs-12 custom-interval"><hr><p>'+l.DATE_PICKER.INTERVAL+'</p><div class="btn-group btn-group-justified" data-toggle="buttons"><label class="btn btn-default"><input type="radio" name="options" data-interval="1/4_hour" autocomplete="off">15'+l.MIN+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="1/2_hour" autocomplete="off">30'+l.MIN+'</label><label class="btn btn-default active"><input type="radio" name="options" data-interval="hour" autocomplete="off" checked>'+l.HOUR+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="day" autocomplete="off">'+l.DAY+"</label></div></div>":"")+'<div class="col-xs-12"><hr>'+(this.defaults.actionButton?'<button type="button" name="submitButton" class="btn btn-primary btn-md btn-block">'+l.SEARCH+"</button>":'<button type="button" name="selectButton" class="btn btn-primary btn-md btn-block">'+l.SELECT+"</button>")+"</div></div>"},this._init()}function Player(){var e,t,n,o,a,r,s,i,l,c=1,d=!1,u="",m=function(){var c=y();e=document.createElement("div"),e.id="rec-player",e.className="pl-cont",e.innerHTML=c,document.querySelector("body").appendChild(e),t=document.getElementById("pl-seek"),n=document.getElementById("pl-time"),o=document.getElementById("pl-play"),a=document.getElementById("pl-duration"),r=document.getElementById("pl-download"),s=document.getElementById("audio-rec"),i=document.getElementById("pl-controls"),l=document.getElementById("pl-pb-control"),p()},p=function(){addEvent(e,"click",function(e){f(e)}),addEvent(s,"playing",function(){o.innerHTML='<i class="fa fa-fw fa-pause"></i>',x.lastEl&&(x.lastEl.innerHTML='<i class="fa fa-fw fa-pause"></i>')},!0),addEvent(s,"loadedmetadata",function(){a.textContent=formatTimeString(parseInt(s.duration),"hh:mm:ss")}),addEvent(s,"pause",function(){o.innerHTML='<i class="fa fa-fw fa-play"></i>',x.lastEl&&(x.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>')},!0),addEvent(s,"timeupdate",b,!0),addEvent(s,"ended",g(c+1),!0),addEvent(t,"click",function(e){e||(e=window.event),s.currentTime=(s.duration*((e.offsetX||e.layerX)/t.clientWidth)).toFixed(2)},!0)},b=function(){var e=0===s.currentTime?0:Math.floor(100/s.duration*s.currentTime);n.textContent=formatTimeString(parseInt(s.currentTime),"hh:mm:ss"),t.value=e,$(document).trigger("player:timeupdate",[{time:1e3*s.currentTime,trackIndex:c}])},g=function(e){!x.playlist.length||1>=e||e>=x.playlist.length||(c=e,$(document).trigger("player:track",[{track:c}]),s.src=x.filePath+x.playlist[c-1].file,u=x.playlist[c-1].file,r.href=s.src,r.setAttribute("download",s.src),s.play(),console.log("playTrack: ",c,x.playlist[c-1].file))},f=function(e){e||(e=window.event);var t=e.target;"I"==t.nodeName&&(t=t.parentNode),"pl-play"==t.id&&x.playAudio(),"pl-stop"==t.id&&x.stopAudio(),"pl-prev"==t.id&&x.prevAudio(),"pl-next"==t.id&&x.nextAudio(),"pl-close"==t.id&&v()},h=function(){e.classList.add("shown"),d=!0,x.playlist.length&&(i.style.width="475px",l.classList.remove("hidden"))},v=function(){e.classList.remove("shown"),x.stopAudio(),d=!1},y=function(){return'<audio id="audio-rec" type="audio/x-wav; codecs=\'1\'"></audio><div class="pl-controls" id="pl-controls"><a href="#" download="" class="pl-control bg-success pull-left" id="pl-download"><i class="fa fa-download"></i></a><button class="pl-control bg-primary pull-left" id="pl-play"><i class="fa fa-fw fa-play"></i></button><div id="pl-pb-control" class="hidden" style="display:inline;height: 100%;"><button class="pl-control bg-primary pull-left" id="pl-prev"><i class="fa fa-fw fa-backward"></i></button><button class="pl-control bg-primary pull-left" id="pl-next"><i class="fa fa-fw fa-forward"></i></button></div><div class="pl-time"><span id="pl-time"></span>/<span id="pl-duration"></span></div><progress id="pl-seek" max="100" value="0" class-"pl-seek-bar"></progress><button class="pl-control bg-danger pull-right" id="pl-close"><i class="fa fa-fw fa-close"></i></button><button class="pl-control bg-primary pull-right" id="pl-stop"><i class="fa fa-fw fa-stop"></i></button></div>'},x={playlist:[],filePath:"",audioFile:"",audioURL:"",audio:s,lastEl:null,playAudio:function(){d===!1&&h(),this.audioURL!==u&&(s.src=this.filePath+this.audioURL,u=this.audioURL,r.href=this.audioURL,r.setAttribute("download",this.audioFile)),console.log("playAudio: ",s.src,u),s.paused?s.play():s.pause()},prevAudio:function(){this.stopAudio(),g(c-1)},nextAudio:function(){this.stopAudio(),g(c+1)},stopAudio:function(){s.pause(),s.currentTime=0}};return m(),x}function load_rec_settings(){json_rpc_async("getVoiceRecordingList","",function(e){getRecObjects(e)}),$("#set-rec-settings").click(function(){setRecObjects()})}function getRecObjects(e){function t(){n+=1,n===o&&fillSelects(a)}var n=0,o=2,a={};a.result=e,json_rpc_async("getObjects",'"kind":"trunk"',function(n){e.trunks?a.trunks=n.filter(function(t){return-1==e.trunks.indexOf(t.name)}):a.trunks=n,t()}),json_rpc_async("getExtensions",null,function(n){var o=filterObject(n,["phone","user"]);console.log("getRecObjects: ",o),e.extensions?a.exts=o.filter(function(t){return-1===e.extensions.indexOf(t.ext)}):a.exts=o,t()})}function fillSelects(e){document.querySelector('#trunks-rec-mode input[value="'+e.result.trunksmode+'"]').checked=!0,document.querySelector('#ext-rec-mode input[value="'+e.result.extmode+'"]').checked=!0,e.result.trunks&&fill_list_items("rec-trunks",e.result.trunks),e.result.extensions&&fill_list_items("rec-ext",e.result.extensions),fill_list_items("av-trunks",e.trunks,"name"),fill_list_items("av-ext",e.exts,"ext"),close_options(),set_page(),show_content()}function setRecObjects(){var e="",t=document.querySelector("#trunks-rec-mode input:checked"),n=document.querySelector("#ext-rec-mode input:checked"),o=document.getElementById("rec-trunks"),a=document.getElementById("rec-ext");e+='"trunks":[';for(var r=0;r<o.children.length;r++)e+='"'+o.children[r].innerHTML+'",';e+="],",e+='"extensions":[';for(var r=0;r<a.children.length;r++)e+='"'+a.children[r].innerHTML+'",';e+="],",e+='"trunksmode":'+t.value+",",e+='"extmode":'+n.value+",",json_rpc_async("setVoiceRecordingList",e,function(){set_object_success()})}function load_records(){function e(e){e.preventDefault();var n="I"===e.target.nodeName?e.target.parentNode:e.target,o=n.getAttribute("data-method"),a=n.getAttribute("data-param");t[o]&&t[o](a,n)}PbxObject.Pagination=new Pagination,PbxObject.recPicker=new Picker("recs-date-picker",{
submitFunction:getRecParams,actionButton:!1,buttonSize:"md"});var t={playRecord:playRecord,getQos:getQos,toggleRecQoS:toggleRecQoS},n=[].slice.call(document.querySelectorAll(".init-mode"));n.forEach(function(e){"0"===e.value&&(e.checked=!0)}),json_rpc_async("getObjects",'"kind":"trunk"',function(e){e.unshift({oid:PbxObject.frases.ALL,name:PbxObject.frases.ALL}),fill_select_items("searchtrunk",e)}),$("#getcalls-btn").click(function(e){getRecParams(e)}),$("#sample-data").hide(),$("#search-calls .panel-body").slideToggle(),$("#extendedsearch").click(function(e){e.preventDefault();var t=$(this).closest(".panel"),n=t.find(".panel-body");n.is(":visible")?$(this).text(PbxObject.frases.MORE):$(this).text(PbxObject.frases.LESS),n.slideToggle()}),$("#records-table").click(e),TableSortable.sortables_init(),getRecords({begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end},showRecords),show_content()}function build_records_row(e,t){if(e){var n,o="",a=t.rows.length,r=t.insertRow(a),s=e.td;if(e.id&&(r.id=e.id),n=r.insertCell(0),n.textContent=formatDateString(e.ts),n=r.insertCell(1),n.className="nowrap",n.textContent=e.na,n=r.insertCell(2),o=e.nc&&e.nc!==e.nb?e.nb+" ("+e.nc+")":e.nb,n.textContent=o,n.title=o,n=r.insertCell(3),o=e.ta?e.tb?e.ta+" ("+e.tb+")":e.ta:e.tb,n.textContent=o,n=r.insertCell(4),n.textContent=formatTimeString(s,"hh:mm:ss"),n=r.insertCell(5),n.textContent=getFriendlyCodeName(e.cs),n=r.insertCell(6),n.textContent=parseFloat(e.tr).toFixed(2),n=r.insertCell(7),n.textContent=parseFloat(e.ch).toFixed(2),n=r.insertCell(8),e.fi){var i=document.createElement("a");i.href="#",i.setAttribute("data-method","playRecord"),i.setAttribute("data-param",e.fi),i.innerHTML='<i class="fa fa-play fa-fw"></i>',n.appendChild(i)}n=r.insertCell(9),n.innerHTML=e.fi?'<a href="'+window.location.protocol+"//"+window.location.host+"/records/"+e.fi+'" download="'+e.fi+'"><i class="fa fa-fw fa-download"></i></a>':"",n=r.insertCell(10),n.innerHTML='<a href="#" data-method="getQos" data-param="'+e.id+'"><i class="fa fa-fw fa-info"></i></a>'}}function getRecParams(e){show_loading_panel(e.target);var t,n,o,a=document.querySelectorAll(".init-order"),r=document.querySelectorAll(".init-mode"),s=document.getElementById("searchnum"),i=document.getElementById("searchtrunk");for(o=0;o<a.length;o++)a[o].checked&&(t=a[o].value);for(o=0;o<r.length;o++)r[o].checked&&(n=r[o].value);var l={begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end};s.value&&(l.number=s.value),i.value!==PbxObject.frases.ALL&&(l.trunk=i.options[i.selectedIndex].textContent),n&&(l.mode=parseInt(n,10)),t&&(l.order=parseInt(t,10)),getRecords(l,showRecords)}function getRecords(e,t){json_rpc_async("getCalls",e,t)}function showRecords(e){show_content();var t=document.getElementById("records-table").querySelector("tbody"),n=document.getElementById("searchrows");!n.value&&e.length>20&&(n.value=20);for(var o,a=n.value?parseInt(n.value):e.length,r=e.length>a?Math.ceil(e.length/a):1,s=0,i=0;i<e.length;i++)for(o in e[i])"ch"==o&&(s+=parseFloat(e[i][o]));s=s.toFixed(2),$("#sample-data").show(),$("#sample-length").text(e.length),$("#sample-cost").text(s),PbxObject.Pagination.options={table:t,page:1,maxpagins:5,rows:a,records:e,pagnum:r,buildTableFunction:build_records_row},PbxObject.Pagination.createPagination(),PbxObject.Pagination.selectPage(1)}function getQos(e,t){if(console.log("getQos: ",e,t),e){var n=t.innerHTML;t.getAttribute("data-method");t.innerHTML='<i class="fa fa-spinner fa-spin"></i>',t.setAttribute("data-method",""),getRecords({begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end,qos:!0,id:e},function(o){console.log("getQos result: ",o),t.innerHTML=n,t.setAttribute("data-method","toggleRecQoS"),showRecQoS(e,o)})}}function toggleRecQoS(e){console.log("toggleRecQoS: ",e),$("#"+e+"-qos").collapse("toggle")}function showRecQoS(e,t){var n=document.createElement("tr"),o=document.createElement("td"),a=document.createElement("div");a.id=e+"-qos",a.className="collapse",o.colSpan="11",o.style.padding="0",o.style.borderTop="none",o.appendChild(a),n.appendChild(o),$(n).insertAfter("#"+e),ReactDOM.render(RecQosTable({frases:PbxObject.frases,data:t[0],utils:{formatTimeString:formatTimeString}}),a),$(a).collapse()}function playRecord(e,t){PbxObject.Player=PbxObject.Player||new Player;var n=PbxObject.Player;null!==n.lastEl&&n.lastEl!=t&&(n.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>'),n.lastEl=t,n.audioFile=e,n.audioURL=window.location.protocol+"//"+window.location.host+"/records/"+e,n.playAudio()}function load_reports(){new Reports}function chartOptions(e){return{xaxis:{mode:"time",timeformat:e,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0,labelFormatter:function(e,t){return console.log(t),'<span class="chart-label">'+e+"</span>"}},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:e}}}function Reports(){var e,t,n=(document.querySelectorAll(".calls-incoming"),document.querySelectorAll(".calls-outgoing"),document.querySelectorAll(".calls-connected"),document.querySelectorAll(".calls-load"),this);this.init=function(){var t,o,a,r;e=new Picker("calls-date-picker",{submitFunction:n.getStatistics,interval:!0,buttonSize:"md"}),t=e.date.start,o=e.date.end,a=e.interval,r='"begin":'+t+', "end":'+o+', "interval":'+a,json_rpc_async("getCallStatisticsGraph",r,function(e){n.createGraph(e),show_content()})},this.getStatistics=function(){$("#reports-cont").addClass("faded");var t=e.date.start,o=e.date.end,a=e.interval,r='"begin":'+t+', "end":'+o+', "interval":'+a;json_rpc_async("getCallStatisticsGraph",r,function(e){n.createGraph(e),$("#reports-cont").removeClass("faded")})},this.createGraph=function(n){if(!n.length)return $("#outCalls-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),$("#inAndLost-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),$("#intCalls-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),void $("#linesLoad-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>");for(var o,a,r=[],s=[],i=[],l=[],c=[],d=("1/2_hour"==e.intervalString||"1/4_hour"==e.intervalString?[]:[1,e.intervalString],function(e){return"hour"==e?"%H:%M":"day"==e?"%d %b":"%H:%M"}(e.intervalString)),u=0,m=n.length;m>u;u++)a=n[u],o=a.t,r.push([o,a.i]),s.push([o,a.o]),i.push([o,a.l]),l.push([o,a.m]),c.push([o,a.p]);var p={show:!0,barWidth:e.interval,lineWidth:0,fill:.7};insAndLostData=[{label:PbxObject.frases.STATISTICS.CONNECTEDCALLS,stack:0,bars:p,data:r,color:"#3c763d"},{label:PbxObject.frases.STATISTICS.LOSTCALLS,stack:0,bars:p,data:l,color:"#AA4643"}],s=[{label:PbxObject.frases.SETTINGS.OUTCALLS,bars:p,data:s,color:"#4572A7"}],i=[{label:PbxObject.frases.SETTINGS.INTCALLS,bars:p,data:i,color:"#BADABA"}],c=[{label:PbxObject.frases.STATISTICS.LINES_PAYLOAD,data:c,lines:{show:!0,fill:!1},points:{show:!0},color:"#3c763d"}],t={xaxis:{mode:"time",timeformat:d,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:d}};var b=new chartOptions(d);b.legend.container=$("#outCalls-graph-lg");var g=new chartOptions(d);g.legend.container=$("#inAndLost-graph-lg");var f=new chartOptions(d);f.legend.container=$("#intCalls-graph-lg");var h=new chartOptions(d);h.legend.container=$("#linesLoad-graph-lg"),$.plot($("#outCalls-graph"),s,b),$.plot($("#inAndLost-graph"),insAndLostData,g),$.plot($("#intCalls-graph"),i,f),$.plot($("#linesLoad-graph"),c,h)},this.init()}function load_routes(e){PbxObject.oid=e.oid,PbxObject.routepriorities=["Max. prefix length","Least cost routing","Load balancing","Answer seizure ratio","Average call duration","Most idle gateway","Least utilised gateway","Max. priority (status)"],PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})}));var o,a=(document.getElementById("rtable"),document.getElementById("priorities")),r=e.priorities;for(o=0;o<r.length;o++){var s=document.createElement("li");s.setAttribute("data-routepriority",r[o]),s.innerHTML=PbxObject.routepriorities[r[o]],a.appendChild(s)}var i=e.anumbertransforms;if(i.length)for(o=0;o<i.length;o++)append_transform(null,"transforms1",i[o]);else append_transform(null,"transforms1");if(i=e.bnumbertransforms,i.length)for(o=0;o<i.length;o++)append_transform(null,"transforms2",i[o]);else append_transform(null,"transforms2");void 0!=e.routes?build_routes_table(e.routes):show_content(),TableSortable.sortables_init(),set_page()}function set_routes(){var e=document.getElementById("objname").value;if(!e)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var t='"name":"'+e+'",';show_loading_panel();var n;PbxObject.name?n=set_object_success:(PbxObject.name=e,n=null),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),t+='"kind":"routes",',t+='"enabled":'+document.getElementById("enabled").checked+",",t+='"priorities":[';var o,a=document.getElementById("priorities");for(o=0;o<a.children.length;o++)t+=a.children[o].getAttribute("data-routepriority")+",";t+="],",t+='"anumbertransforms":[',t+=encode_transforms("transforms1"),t+="],",t+='"bnumbertransforms":[',t+=encode_transforms("transforms2"),t+="],",t+='"routes":[';var r,s,i=document.getElementById("rtable");for(o=1;o<i.rows.length;o++)s=i.rows[o],s.cells[0].textContent&&(r="",r+='"number":"'+s.cells[0].textContent+'",',r+='"description":"'+s.cells[1].textContent+'",',r+='"target":{"oid":"'+s.cells[2].getAttribute("data-gid")+'"},',r+='"priority":'+parseInt(s.cells[3].getAttribute("data-priority"))+",",r+='"cost":'+parseFloat(s.cells[4].textContent)+",",""!=r&&(t+="{"+r+"},"));t+="]",json_rpc_async("setObject",t,n)}function build_routes_table(e){var t,n=document.getElementById("rtable").getElementsByTagName("tbody")[0];getObjects(["equipment","users","cli","timer","routes","pickup"],function(o){if(!e.length&&o.length)n.appendChild(build_route_row(null,o));else{sortByKey(e,"number"),t=document.createDocumentFragment();for(var a=0;a<e.length;a++)t.appendChild(add_route_row(e[a],o));n.appendChild(t)}show_content()},!0)}function editRow(e,t){getObjects(["equipment","users","cli","timer","routes","pickup"],function(n){var o=build_route_row(t,n);e.parentNode.insertBefore(o,e),e.style.display="none"},!0)}function add_new_route(e){var e=e||window.event;e&&e.preventDefault(),getObjects(["equipment","users","cli","timer","routes","pickup"],function(e){var t=document.getElementById("rtable").getElementsByTagName("tbody")[0];t.insertBefore(build_route_row(null,e),t.children[0])},!0)}function add_route_row(e,t){var n,o;n=document.createElement("tr"),o=n.insertCell(0),o.textContent=e.number,o=n.insertCell(1),o.textContent=e.description,o.className="nowrap",o.title=e.description||"",o=n.insertCell(2);var a={};for(i=0;i<t.length;i++)t[i].oid==e.target.oid&&(a=t[i],o.setAttribute("data-gid",e.target.oid),o.setAttribute("data-gname",a.name),o.innerHTML='<a href="#'+a.kind+"/"+a.oid+'">'+a.name+"</a>");return o=n.insertCell(3),o.setAttribute("data-priority",e.priority),o.textContent=0==e.priority?"OFF":10==e.priority?"EXV":e.priority,o=n.insertCell(4),o.textContent=parseFloat(e.cost).toFixed(2),o=n.insertCell(5),button=document.createElement("button"),button.className="btn btn-primary btn-sm",button.innerHTML='<i class="fa fa-edit"></i>',addEvent(button,"click",function(){editRow(n,e)}),o.appendChild(button),o=n.insertCell(6),button=document.createElement("button"),button.className="btn btn-danger btn-sm",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",function(t){var n=confirm(PbxObject.frases.DELETE+" "+PbxObject.frases.ROUTE.toLowerCase()+"?");return n?(deleteRoute(e.oid),void remove_row(t)):!1}),o.appendChild(button),n}function build_route_row(e,t){var n,o,a,r,s={},i=document.createElement("tr"),l=document.createElement("td"),c=document.createElement("div"),d=document.createElement("input"),u={};i.className="route-on-edit",c.className="form-group",d.className="form-control",d.setAttribute("type","text"),d.setAttribute("name","number"),d.setAttribute("size","12"),s.groupid=PbxObject.oid,null!=e&&(d.value=e.number,s.oid=e.oid),s.number=d.value.trim(),d.onchange=function(){s.number=d.value.trim()},c.appendChild(d),l.appendChild(c),i.appendChild(l),l=document.createElement("td");var c=document.createElement("div");c.className="form-group",descr=document.createElement("input"),descr.className="form-control",descr.setAttribute("type","text"),descr.setAttribute("name","description"),null!=e&&(descr.value=e.description),s.description=descr.value,descr.onchange=function(){s.description=descr.value},c.appendChild(descr),l.appendChild(c),i.appendChild(l),l=document.createElement("td");var c=document.createElement("div");c.className="form-group",target=document.createElement("select"),target.className="form-control",target.setAttribute("name","target");for(var m=0;m<t.length;m++)a=t[m].kind,u[a]?n=u[a]:(n=document.createElement("optgroup"),n.setAttribute("label",PbxObject.frases.KINDS[a]),u[a]=n,target.appendChild(n)),r=t[m].oid,o=document.createElement("option"),o.setAttribute("value",r),o.innerHTML=t[m].name,null!=e&&r==e.target.oid&&o.setAttribute("selected",""),n.appendChild(o);t.length&&(s.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent},target.onchange=function(){s.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent}}),c.appendChild(target),l.appendChild(c),i.appendChild(l),l=document.createElement("td");var c=document.createElement("div");c.className="form-group",priority=document.createElement("select"),priority.className="form-control",priority.setAttribute("name","priority");for(var m=0;10>=m;m++){var o=document.createElement("option");o.value=m,null!=e&&m==e.priority&&o.setAttribute("selected",""),0==m?o.innerHTML="OFF":10==m?o.innerHTML="EXV":o.innerHTML=m,priority.appendChild(o)}e||(priority.selectedIndex=1),c.appendChild(priority),s.priority=priority.options[priority.selectedIndex].value,priority.onchange=function(){s.priority=priority.options[priority.selectedIndex].value},l.appendChild(c),i.appendChild(l),l=document.createElement("td");var c=document.createElement("div");return c.className="form-group",cost=document.createElement("input"),cost.className="form-control",cost.setAttribute("type","text"),cost.setAttribute("name","cost"),cost.setAttribute("size","2"),null!=e&&e.cost?cost.setAttribute("value",parseFloat(e.cost).toFixed(2)):cost.value=parseFloat(0).toFixed(2),s.cost=parseFloat(cost.value).toFixed(2),cost.onchange=function(){s.cost=parseFloat(cost.value).toFixed(2)},c.appendChild(cost),l.appendChild(c),i.appendChild(l),l=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-default btn-sm",button.innerHTML='<i class="fa fa-chevron-left"></i>',addEvent(button,"click",function(){var e=i.nextSibling;e&&"TR"==e.nodeName&&"none"==e.style.display&&(e.style.display="table-row"),i.parentNode.removeChild(i)}),l.appendChild(button),i.appendChild(l),l=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-success btn-sm",button.innerHTML='<i class="fa fa-check"></i>',addEvent(button,"click",function(){var e=document.getElementById("objname").value;if(!e)return void alert(PbxObject.frases.MISSEDNAMEFIELD);if(!s.number)return void alert(PbxObject.frases.MISSED_ROUTE_NUMBER);isNaN(s.cost)&&(s.cost=0);var n=i.nextSibling,o=add_route_row(s,t);i.parentNode.insertBefore(o,i),n&&"TR"==n.nodeName&&"none"==n.style.display&&n.parentNode.removeChild(n),i.parentNode.removeChild(i),setRoute(s,set_object_success)}),l.appendChild(button),i.appendChild(l),i}function setRoute(e,t){var n=e,o=t||null;e.oid&&(n.oid=e.oid),e.priority&&(n.priority=parseFloat(e.priority)),e.cost&&(n.cost=parseFloat(e.cost)),console.log("setRoute: ",n),json_rpc_async("setRoute",n,o)}function deleteRoute(e){var t='"oid":"'+e+'"';json_rpc_async("deleteRoute",t,set_object_success)}function load_statistics(){new Statistics}function Statistics(){function e(e){e&&ReactDOM.render(TrunksQosTable({frases:PbxObject.frases,data:e,utils:{formatTimeString:formatTimeString}}),document.getElementById("trunks-qos-cont"))}function t(){return y?!1:(y=!0,$("#trunks-qos-cont").addClass("faded"),void n({begin:o.date.start,end:o.date.end},function(t){console.log("openTrunksQosStat data: ",t),e(t),$("#trunks-qos-cont").removeClass("faded")}))}function n(e,t){json_rpc_async("getTrunksStatistics",{begin:e.begin,end:e.end},t)}var o,a,r,s,i=document.getElementById("trunks-statistics-table"),l=document.getElementById("ext-statistics-table"),c=document.getElementById("ext-stats-btn"),d=document.getElementById("ext-stat-kind"),u=document.getElementById("lost-stats-btn"),m=document.getElementById("trunks-qos-btn"),p=document.getElementById("dcontainer"),b=[].slice.call(p.querySelectorAll(".data-model")),g="inbound",f=PbxObject.oid,h=!0,v=!0,y=!1;self=this,this._init=function(){o=new Picker("statistics-date-picker",{submitFunction:self.getStatisticsData,buttonSize:"md"}),a=o.date.start,r=o.date.end,s='"begin":'+a+', "end":'+r,json_rpc_async("getCallStatistics",s,self._setStatistics),c.onclick=function(){"shown"!==c.getAttribute("data-state")?(c.setAttribute("data-state","shown"),self._getExtStatisticsData()):c.setAttribute("data-state","hidden")},d.onclick=function(e){var e=e||window.event,t=e.target;"LABEL"===t.nodeName&&(g=t.children[0].getAttribute("data-kind"),h=!0,self._getExtStatisticsData())},u.onclick=function(){"shown"!==u.getAttribute("data-state")?(u.setAttribute("data-state","shown"),self._getLostStatisticsData()):u.setAttribute("data-state","hidden")},m.onclick=t,switch_presentation(f),set_page()},this.getStatisticsData=function(){var t={begin:o.date.start,end:o.date.end};$("#statistics-cont").addClass("faded"),json_rpc_async("getCallStatistics",t,function(e){self._setStatistics(e),$("#statistics-cont").removeClass("faded")}),n(t,e),h=!0,v=!0,"shown"==c.getAttribute("data-state")&&self._getExtStatisticsData(),"shown"==u.getAttribute("data-state")&&self._getLostStatisticsData()},this._getExtStatisticsData=function(){h&&(h=!1,$("#extStat-cont").addClass("faded"),a=o.date.start,r=o.date.end,s='"begin":'+a+', "end":'+r+', "kind":"'+g+'"',json_rpc_async("getCallStatisticsExt",s,function(e){self._setExtStatistics(e),$("#extStat-cont").removeClass("faded")}))},this._getLostStatisticsData=function(){v&&(v=!1,$("#lostCalls-cont").addClass("faded"),a=o.date.start,r=o.date.end,s='"begin":'+a+', "end":'+r,json_rpc_async("getLostCalls",s,function(e){self._setLostStats(e),$("#lostCalls-cont").removeClass("faded")}))},this._setStatistics=function(e){var t,n=e;n.inbounds.duration=formatTimeString(n.inbounds.duration,"hh:mm:ss"),n.outbounds.duration=formatTimeString(n.outbounds.duration,"hh:mm:ss"),n.internals.duration=formatTimeString(n.internals.duration,"hh:mm:ss"),void 0!==n.outbounds.cost&&(n.outbounds.cost=parseFloat(n.outbounds.cost).toFixed(2)),b.forEach(function(e){t=e.getAttribute("data-model"),"inbounds.lost"==t&&(0===n.inbounds.lost?e.classList.remove("negtv-col"):e.classList.add("negtv-col"));var o=t.split(".").reduce(objFromString,n);e.textContent=o}),self._build_trunks_statistics(n.trunks),show_content()},this._setExtStatistics=function(e){clearColumns(l);for(var t=0;t<e.length;t++)self._buildExtStatColumn(e[t])},this._setLostStats=function(e){for(var t=document.createDocumentFragment(),n=document.getElementById("lost-calls-table").querySelector("tbody"),o=0;o<e.length;o++)t.appendChild(self._buildLostCallsTable(e[o]));n.appendChild(t)},this._build_trunks_statistics=function(e){var t=i.querySelector("tbody");clearTable(t);for(var n=0;n<e.length;n++)row=t.insertRow(n),cell=row.insertCell(0),cell.textContent=void 0!==e[n].trunk?e[n].trunk:"",cell=row.insertCell(1),cell.textContent=void 0!==e[n]["in"]?e[n]["in"]:"",cell=row.insertCell(2),cell.textContent=void 0!==e[n].insec?formatTimeString(e[n].insec,"hh:mm:ss"):"",cell=row.insertCell(3),cell.textContent=void 0!==e[n].out?e[n].out:"",cell=row.insertCell(4),cell.textContent=void 0!==e[n].outsec?formatTimeString(e[n].outsec,"hh:mm:ss"):"",cell=row.insertCell(5),cell.textContent=void 0!==e[n].cost?parseFloat(e[n].cost).toFixed(2):""},this._buildExtStatColumn=function(e){for(var t,n,o,a=l.querySelector("thead"),r=l.querySelector("tbody"),s=0;s<a.rows.length;s++)t=document.createElement("th"),a.rows[s].appendChild(t),t.innerHTML=e.ext;for(var i=0;i<r.rows.length;i++){switch(n=r.rows[i].insertCell(-1),i){case 0:o="total";break;case 1:o="connected";break;case 2:o="duration";break;case 3:o="cost"}n.innerHTML=void 0!==e[o]?"duration"===o?formatTimeString(e[o],"hh:mm:ss"):"cost"===o?parseFloat(e[o]).toFixed(2):e[o]:""}},this._buildLostCallsTable=function(e){var t,n=document.createElement("tr");return t=n.insertCell(0),t.textContent=formatDateString(e.ts)||"",t=n.insertCell(1),t.textContent=e.na||"",t=n.insertCell(2),t.textContent=e.nb||"",t=n.insertCell(3),t.textContent=e.nc||"",t=n.insertCell(4),t.textContent=getFriendlyCodeName(e.cs)||"",n},this._init()}function AppStorage(e,t){if("localStorage"!==t&&"sessionStorage"!==t)return console.error('No such storage type. Choose either "localStorage" or "sessionStorage".');var n=window[t],o=n.getItem(e)?JSON.parse(n.getItem(e)):{};this.set=function(t,a,r){return o[t]=a,r||n.setItem(e,JSON.stringify(o)),this},this.get=function(e){return e?o[e]:o},this.remove=function(e){return e?delete o[e]:o={},this},this.setType=function(e){return window[e]&&(n=window[e]),this}}function load_storages(){function e(e){s&&s.parentNode.removeChild(s),s=document.createElement("div"),s.id="storage-settings-cont",document.body.appendChild(s),e.maxsize&&(e.maxsize=convertBytes(e.maxsize,"Byte","GB")),ReactDOM.render(StorageComponent({frases:PbxObject.frases,data:e,onSubmit:t}),s),$("#storage-settings").modal()}function t(e){console.log("saveStorage: ",e),e.path&&(e.id||delete e.id,void 0!==e.maxsize&&(e.maxsize=convertBytes(e.maxsize,"GB","Byte")),e.state=parseInt(e.state,10),json_rpc_async("setFileStore",e,function(e){e&&getStorages(function(e){a=e,getTotalStorage(function(e){PbxObject.options=e,o(),$("#storage-settings").modal("hide")})})}))}function n(){show_content(),void 0!==a&&void 0!=r&&(o(),TableSortable.sortables_init(),close_options(),set_page())}function o(){ReactDOM.render(UsageComponent({options:PbxObject.options,frases:PbxObject.frases,storageInfo:r,fileStorage:a,getTotalStorage:getTotalStorage,utils:{convertBytes:convertBytes,formatDateString:formatDateString,getFriendlyStorageState:getFriendlyStorageState},openStorageSettings:e}),document.getElementById("el-loaded-content"))}var a,r,s=document.getElementById("storage-settings-cont");1!==PbxObject.options.mode&&PbxObject.options.prefix?a=null:getStorages(function(e){a=e,n()}),getStorageInfo(function(e){r=e,n()})}function getStorages(e){json_rpc_async("getFileStore",null,function(t){e&&e(t)})}function getStorageInfo(e){json_rpc_async("getStoreInfo",null,function(t){sortByKey(t,"user"),e&&e(t)})}function getTotalStorage(e){json_rpc_async("getPbxOptions",null,function(t){e&&e(t)})}function setUserStoreLimit(e,t,n){json_rpc_async("setStoreLimit",{oid:e,limit:convertBytes(parseFloat(t),"GB","Byte")},function(e){console.log(e),n.value=convertBytes(e,"Byte","GB").toFixed(2)})}function getFriendlyStorageState(e){return PbxObject.frases.STORAGE.STATES[e]}function load_timer(e){PbxObject.oid=e.oid,PbxObject.name=e.name;var t,n=(new Date,[]),o=document.getElementById("enabled"),a=document.getElementById("objname");e.name&&(a.value=e.name),o&&(o.checked=e.enabled,addEvent(o,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(o.checked=!o.checked)})}));var r,s=document.getElementById("hh");for(r=0;24>r;r++){var i=document.createElement("option");if(10>r)var l="0"+r;else l=r;i.value=l,i.innerHTML=l,s.appendChild(i),l==e.hour&&(s.selectedIndex=r)}var c=document.getElementById("mm");for(r=0;55>=r;r+=5){var i=document.createElement("option");if(10>r)var l="0"+r;else l=r;i.value=l,i.innerHTML=l,c.appendChild(i),l==e.minute&&(c.selectedIndex=r/5)}for(r=0;r<e.weekdays.length;r++){var d=document.getElementById("t-d"+e.weekdays[r]);d.checked=!0,"LABEL"===d.parentNode.nodeName&&d.parentNode.classList.add("active")}fill_timer_targets("objects"),setTimezones(document.getElementById("timer_timezone"),e.timezone||PbxObject.options.timezone);var u=document.getElementById("targets").getElementsByTagName("tbody")[0];for(r=0;r<e.targets.length;r++)u.appendChild(timer_target_row(e.targets[r].oid,e.targets[r].name,e.targets[r].action));show_content(),set_page();var m=document.getElementById("add-timer-target");m.onclick=function(){add_timer_target()};var p=document.getElementById("timer-range");addEvent(p,"click",check_days);var b=document.createElement("div");b.className="timer-dates-wrapper no-weekdays no-years",document.body.appendChild(b),t=flatpickr("#timer-dates",{locale:PbxObject.language||"en",mode:"multiple",dateFormat:"d F",appendTo:b,minDate:new Date(2017,0,1),maxDate:new Date(2017,11,31),onChange:function(e,t){setTempParams({selectedDates:e})}}),e.yeardays&&(e.yeardays.forEach(function(e){n.push(moment().dayOfYear(e).format())}),t.setDate(n))}function set_timer(){var e,t=document.getElementById("objname").value,n=document.getElementById("timer_timezone");if(!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',show_loading_panel();var o;PbxObject.name?o=set_object_success:(PbxObject.name=t,o=null),null!=PbxObject.oid&&(e+='"oid":"'+PbxObject.oid+'",'),e+='"kind":"timer",';var a=document.getElementById("enabled");null!=a&&(e+='"enabled":'+a.checked+",");var r=document.getElementById("hh"),s=document.getElementById("mm");e+='"hour":"'+r.options[r.selectedIndex].value+'",',e+='"minute":"'+s.options[s.selectedIndex].value+'",',(n.value||PbxObject.options.timezone)&&(e+='"timezone":"'+(n.value||PbxObject.options.timezone)+'",'),e+='"weekdays":[';var i;for(i=0;7>i;i++)document.getElementById("t-d"+i).checked&&(e+=i+",");e+="],",PbxObject.currentObj&&PbxObject.currentObj.selectedDates&&(e+='"yeardays":[',PbxObject.currentObj.selectedDates.forEach(function(t){e+=moment(t).dayOfYear()+","}),e+="],");var l=document.getElementById("targets").getElementsByTagName("tbody")[0];for(e+='"targets":[',i=0;i<l.children.length;i++){var c=l.children[i];void 0!=c.id&&""!=c.id&&(e+='{"oid":"'+l.children[i].id+'","action":"'+c.children[0].getAttribute("data-action")+'"},')}e+="]",json_rpc_async("setObject",e,o)}function timer_target_row(e,t,n){var o=document.createElement("tr"),a=document.createElement("td"),r=document.createElement("a"),s="Enable"==n?PbxObject.frases.ENABLE:PbxObject.frases.DISABLE;a.textContent=s,a.setAttribute("data-action",n),o.appendChild(a),a=document.createElement("td"),o.id=e,r.href="#",r.onclick=function(t){get_object_link(e),t.preventDefault()},r.innerHTML=t,a.appendChild(r),o.appendChild(a),a=document.createElement("td");var i=document.createElement("button");return i.className="btn btn-danger btn-sm",i.innerHTML='<i class="fa fa-minus"></i>',i.onclick=function(){remove_listener(e)},a.appendChild(i),o.appendChild(a),o}function add_timer_target(){var e=document.getElementsByTagName("tbody")[0],t=document.getElementById("objects"),n=document.getElementById("actions"),o=t.options[t.selectedIndex];e.appendChild(timer_target_row(o.value,o.innerHTML,n.value))}function remove_listener(e){var t,n=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t=0;t<n.children.length;t++)n.children[t].id==e&&n.removeChild(n.children[t])}function fill_timer_targets(e){var t,n,o,a,r,s=document.getElementById(e),i={};"object"==typeof PbxObject.objects?r=PbxObject.objects:(r=json_rpc("getObjects",'"kind":"all"'),sortByKey(r,"name"),PbxObject.objects=r);for(var l=0;l<r.length;l++)o=r[l].kind,"equipment"!=o&&"cli"!=o&&"timer"!=o&&"users"!=o&&(i[o]?t=i[o]:(t=document.createElement("optgroup"),t.setAttribute("label",PbxObject.frases.KINDS[o]),i[o]=t,s.appendChild(t)),a=r[l].oid,n=document.createElement("option"),n.value=a,n.innerHTML=r[l].name,t.appendChild(n))}function check_days(e){var t,e=e||window.event,n=e.target,o=n.getAttribute("data-filter");e.preventDefault();for(var a=0;7>a;a++)t=document.getElementById("t-d"+a),"timer-workdays"===o&&(5===a||6===a)||"timer-holidays"===o&&5>a?(t.checked&&(t.checked=!1),"LABEL"===t.parentNode.nodeName&&t.parentNode.classList.remove("active")):(t.checked=!0,"LABEL"===t.parentNode.nodeName&&t.parentNode.classList.add("active"))}function MyTour(e,t){if(!e)return console.error("tour name is undefined");if(!t)return console.error("options is undefined");var n={},o={name:e,backdrop:!0,backdropContainer:"#pagecontent",storage:!1,template:["<div class='popover tour'>","<div class='arrow'></div>","<h3 class='popover-title'></h3>","<div class='popover-content'></div>","<div class='popover-navigation'>","<button class='btn btn-default' data-role='prev'><i class='fa fa-angle-left'></i></button>","<span data-role='separator'> </span>","<button class='btn btn-default' data-role='next'><i class='fa fa-angle-right'></i></button>","<button class='btn btn-link' data-role='end'>",PbxObject.frases.TOURS.END_TOUR,"</button>","</div>","</div>"].join(""),steps:[]};return t&&extend(o,t),n=new Tour(o),n.init(),n}function load_trunk(e){var t=(e.type,[].slice.call(document.querySelectorAll('[name="trunkType"]'))),n=document.getElementById("passanumber");PbxObject.oid=e.oid,PbxObject.name=e.name;var o=document.getElementById("enabled"),a=document.getElementById("objname");if(e.name&&(a.value=e.name),o&&(o.checked=e.enabled,addEvent(o,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(o.checked=!o.checked)})})),e.status){var r=document.getElementById("status");r&&(r.innerHTML=e.status)}if(void 0!==e.up&&changeTrunkRegState(e.up),e.protocol){var s,i="h323"==e.protocol?"h323":"sip",l=document.getElementById("protocols"),c=document.getElementById("get-proto-opts");e.name?(s=document.createElement("option"),s.value=e.protocol,s.textContent=e.protocol,l.appendChild(s)):(e.protocols.forEach(function(e){s=document.createElement("option"),s.value=e,s.textContent=e,"sip"===e&&s.setAttribute("selected","selected"),l.appendChild(s)}),"sip"!==l.value&&(l.value=e.protocol),addEvent(l,"change",function(){i="h323"==this.value?"h323":"sip",switch_presentation(i)})),addEvent(c,"click",function(){get_protocol_opts(l.value,e.parameters)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={},switch_presentation(i);
}t.forEach(function(t){if(t.value===e.type){var n=t.parentNode;t.checked,$(n).button("toggle")}else e.name&&t.parentNode.parentNode.removeChild(t.parentNode)}),e.domain&&(document.getElementById("domain").value=e.domain),document.getElementById("register").checked=e.register,document.getElementById("user").value=e.user||"",document.getElementById("pass").value=e.pass||"",document.getElementById("int-trunk-user").value=e.gateway?e.gateway.regname:e.user||"",document.getElementById("int-trunk-pass").value=e.gateway?e.gateway.regpass:e.pass||"",e.auth&&(document.getElementById("auth").value=e.auth),document.getElementById("regexpires").value=e.regexpires||60;var d=document.getElementById("proxy");addEvent(d,"change",function(){for(var e=document.getElementsByName("proxy"),t=0;t<e.length;t++)e[t].disabled=!this.checked}),d.checked=e.proxy;for(var u=document.getElementsByName("proxy"),m=0;m<u.length;m++)u[m].disabled=!e.proxy;if(e.paddr&&(document.getElementById("paddr").value=e.paddr),e.pauth&&(document.getElementById("pauth").value=e.pauth),e.ppass&&(document.getElementById("ppass").value=e.ppass),void 0!=e.maxinbounds&&(document.getElementById("maxinbounds").value=isMaxNumber(e.maxinbounds)?16:e.maxinbounds,document.getElementById("inmode").checked=e.maxinbounds>0),void 0!=e.maxoutbounds&&(document.getElementById("maxoutbounds").value=isMaxNumber(e.maxoutbounds)?16:e.maxoutbounds,document.getElementById("outmode").checked=e.maxoutbounds>0),void 0!=e.parameters){var p=e.parameters.codecs;if(void 0!=p)for(var b,m=0;m<p.length&&(b=document.getElementById("c"+m),b);m++)b.value=p[m].codec,document.getElementById("f"+m).value=p[m].frame;else for(m=0;4>m;m++)document.getElementById("c"+m).selectedIndex=0,document.getElementById("f"+m).value=0}n&&(n.checked=e.parameters.passanumber);var g=e.inboundanumbertransforms;if(g.length)for(m=0;m<g.length;m++)append_transform(null,"transforms1",g[m]);else append_transform(null,"transforms1");if(g=e.inboundbnumbertransforms,g.length)for(m=0;m<g.length;m++)append_transform(null,"transforms2",g[m]);else append_transform(null,"transforms2");if(g=e.outboundanumbertransforms,g.length)for(m=0;m<g.length;m++)append_transform(null,"transforms3",g[m]);else append_transform(null,"transforms3");if(g=e.outboundbnumbertransforms,g.length)for(m=0;m<g.length;m++)append_transform(null,"transforms4",g[m]);else append_transform(null,"transforms4");switch_presentation(e.type?e.type:"external",null,"pl-trunk-kind"),show_content(),set_page(),renderTrunkIncRoute({route:e.inboundbnumbertransforms.filter(getCurrIncRoutes)[0],frases:PbxObject.frases})}function changeTrunkRegState(e){var t=document.getElementById("enabled");e?t.classList.remove("unregistered"):t.classList.add("unregistered")}function getCurrIncRoutes(e){return"."===e.number&&e.strip&&e.prefix}function getRouteOptions(e){PbxObject.extensions.length?e(PbxObject.extensions):getExtensions(function(t){e(t)})}function renderTrunkIncRoute(e){var t=null;getRouteOptions(function(n){e.route&&(t=n.filter(function(t){return t.ext===e.route.prefix})[0]),console.log("renderTrunkIncRoute: ",t),ReactDOM.render(TrunkIncRoute({options:n,route:t,frases:e.frases,onChange:setTrunkIncRoute}),document.getElementById("trunk-inc-route"))}),clearTempParams()}function renderTrunkOutRoute(){ReactDOM.render(TrunkOutRoutes({frases:PbxObject.frases,onChange:setTrunkOutRoute}),document.getElementById("trunk-out-routes"))}function setTrunkIncRoute(e){console.log("setTrunkIncRoute: ",e),updateTempParams(e)}function setTrunkOutRoute(e){console.log("setTrunkOutRoute: ",e)}function set_trunk(){var e,t,n,o,a,r,s,i,l,c=document.getElementById("objname").value,d=document.getElementById("enabled"),u=document.getElementById("passanumber");if(!c)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;t='"name":"'+c+'",',show_loading_panel(),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),PbxObject.name?n=set_object_success:(PbxObject.name=c,n=null),o=[].slice.call(document.querySelectorAll('[name="trunkType"]')),o.forEach(function(e){e.checked?a=e.value:e.parentNode.parentNode.removeChild(e.parentNode)}),t+='"kind":"trunk",',t+='"enabled":'+d.checked+",";var m=document.getElementById("protocols").value,p=document.getElementById("register").checked,b=document.getElementById("proxy").checked;t+='"protocol":"'+m+'",',t+='"type":"'+a+'",',"external"===a?(t+='"domain":"'+document.getElementById("domain").value+'",',t+='"register":'+p+",",p&&(t+='"user":"'+document.getElementById("user").value+'",',t+='"auth":"'+document.getElementById("auth").value+'",',t+='"pass":"'+document.getElementById("pass").value+'",',t+='"regexpires":'+document.getElementById("regexpires").value+","),t+='"proxy":'+b+",",b&&(t+='"paddr":"'+document.getElementById("paddr").value+'",',t+='"pauth":"'+document.getElementById("pauth").value+'",',t+='"ppass":"'+document.getElementById("ppass").value+'",')):(t+='"user":"'+document.getElementById("int-trunk-user").value+'",',t+='"pass":"'+document.getElementById("int-trunk-pass").value+'",'),t+=document.getElementById("inmode").checked?'"maxinbounds":'+document.getElementById("maxinbounds").value+",":'"maxinbounds":0,',t+=document.getElementById("outmode").checked?'"maxoutbounds":'+document.getElementById("maxoutbounds").value+",":'"maxoutbounds":0,',t+='"parameters":{',u&&(t+='"passanumber":'+u.checked+","),e=JSON.stringify(PbxObject.protocolOpts),e=e.substr(1,e.length-2),t+=e,r=transformsToArray("transforms1"),s=transformsToArray("transforms2"),i=transformsToArray("transforms3"),l=transformsToArray("transforms4"),getTempParams().ext&&(incRoute=s.filter(getCurrIncRoutes)[0],incRoute?s.map(function(e){return e==incRoute?e.prefix=getTempParams().ext:e}):s.push({number:".",strip:!0,prefix:getTempParams().ext}),clearTable(document.querySelector("#transforms2 tbody")),append_transforms("transforms2",s)),t+="},",t+='"inboundanumbertransforms":',t+=JSON.stringify(r),t+=', "inboundbnumbertransforms":',t+=JSON.stringify(s),t+=', "outboundanumbertransforms":',t+=JSON.stringify(i),t+=', "outboundbnumbertransforms":',t+=JSON.stringify(l),console.log(t),json_rpc_async("setObject",t,function(e){e?n&&n():d.checked&&(d.checked=!1)})}AttObject.prototype.enterAttMenu=function(e,t){var e=e||window.event;e.preventDefault(),makeActiveCanvas(this.oid)},AttObject.prototype.editObject=function(e,t){var e=e||window.event;e.preventDefault(),showAttObjectSetts(this.params,this)},AttObject.prototype.removeElement=function(e,t,n){e&&e.preventDefault();var o=this.element.querySelector("#enter-att-menu"),a=this.element.querySelector("#edit-att-object"),r=this.element.querySelector("#remove-att-object");removeTreeBtn=this.element.querySelector("#remove-att-tree"),o&&removeEvent(o,"click",function(){this.enterAttMenu(e,t)}.bind(this)),a&&removeEvent(a,"click",function(){this.editObject(e,t)}.bind(this)),r&&removeEvent(r,"click",function(e){this.removeElement(e)}.bind(this)),removeTreeBtn&&removeEvent(removeTreeBtn,"click",function(e){this.removeElement(e)}.bind(this)),this.element.parentNode.removeChild(this.element),e?(removeObject(this.oid,n),removeFromSchema(this.oid),"0"==this.oid&&createInitButton()):removeObject(this.oid),changeAvailableButtons(t.button)},ChannelPlayer.prototype={initEvents:function(){return addEvent(this.audio,"playing",function(e){$(document).trigger("player:playing",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],currentTime:this.audio.currentTime,duration:this.audio.duration}])}.bind(this),!0),addEvent(this.audio,"loadedmetadata",function(e){$(document).trigger("player:loadedmetadata",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.audio.duration}])}.bind(this)),addEvent(this.audio,"pause",function(e){$(document).trigger("player:pause",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex]}])}.bind(this),!0),addEvent(this.audio,"seeked",function(e){$(document).trigger("player:seeked",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.duration||this.playlist[this.trackIndex].duration,currentTime:(this.playlist[this.trackIndex].timecode-this.playlist[0].timecode)/1e3+this.audio.currentTime}])}.bind(this),!0),addEvent(this.audio,"timeupdate",function(e){$(document).trigger("player:timeupdate",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.duration||this.playlist[this.trackIndex].duration,currentTime:(this.playlist[this.trackIndex].timecode-this.playlist[0].timecode)/1e3+this.audio.currentTime}])}.bind(this),!0),addEvent(this.audio,"ended",function(e){$(document).trigger("player:ended",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],currentTime:this.audio.currentTime}])}.bind(this),!0),this},init:function(){return $(document).trigger("player:init",[{audio:this.audio,path:this.path,playlist:this.playlist,trackIndex:this.trackIndex,duration:this.duration}]),this},playTrack:function(e,t){if(!this.playlist.length||e>this.playlist.length-1||0>e)return this;var n=this.playlist[e||this.trackIndex],o=this.path+n.file;void 0!==e&&(this.trackIndex=e),this.audio.src!==o&&(this.audio.src=o,$(document).trigger("player:trackchange",[{trackIndex:this.trackIndex,track:n,src:this.audio.src}])),void 0!==t&&(this.audio.currentTime=t),console.log("play: ",e,t),this.audio.play()},play:function(){return this.audio.paused?this.audio.play():this.audio.pause(),this},stop:function(){return this.audio.pause(),this.trackIndex=0,this.audio.currentTime=0,this},next:function(){var e=this.trackIndex+1;return this.audio.pause(),this.audio.currentTime=0,this.playTrack(e),$(document).trigger("player:next",[{trackIndex:this.trackIndex,track:this.playlist[e]}]),this},prev:function(){var e=this.trackIndex-1;return this.audio.pause(),this.audio.currentTime=0,this.playTrack(e),$(document).trigger("player:prev",[{trackIndex:this.trackIndex,track:this.playlist[e]}]),this}},window.onerror=function(e,t,n){console.error("Error message: "+e+"\nURL: "+t+"\nLine number: "+n)},function(){var e,t=window.sessionStorage.getItem("lastURL");if(t&&(window.sessionStorage.removeItem("lastURL"),window.location=t),initGlobals(window),createWebsocket(),window.onbeforeunload=function(){PbxObject.websocket.onclose=function(){},PbxObject.websocket.close()},window.localStorage.getItem("pbxOptions")){var n=window.localStorage.getItem("pbxOptions");n=JSON.parse(n),e=n.lang||"en",getTranslations(e),PbxObject.options=n,window.localStorage.removeItem("pbxOptions"),moment.locale(e)}else json_rpc_async("getPbxOptions",null,function(t){e=t.lang||"en",getTranslations(e),PbxObject.options=t,moment.locale(e)}),getSystemTime(function(e){PbxObject.systime=e})}();var appStorage=new AppStorage("app-storage","localStorage"),Utils={validateElement:function(e,t){var n=!!e.value;return n?t?t.classList.remove("has-error"):e.classList.remove("has-error"):(t?t.classList.add("has-error"):e.classList.add("has-error"),n=!1),n}};PbxObject.tours=PbxObject.tours||[],PbxObject.tours.attendant=function(){var e=PbxObject.frases;return{storage:window.localStorage,backdrop:!1,steps:[{placement:"bottom",element:"#objname",title:e.TOURS.ATTENDANT.A.TITLE,content:e.TOURS.ATTENDANT.A.BODY},{placement:"bottom",element:"#object-route-cont",title:e.TOURS.ATTENDANT.B.TITLE,content:e.TOURS.ATTENDANT.B.BODY},{placement:"left",element:"#enabled-cont",title:e.TOURS.ATTENDANT.C.TITLE,content:e.TOURS.ATTENDANT.C.BODY},{placement:"right",element:"#attGreetings",title:e.TOURS.ATTENDANT.D.TITLE,content:e.TOURS.ATTENDANT.D.BODY},{placement:"right",element:"#att-email-setts",title:e.TOURS.ATTENDANT.E.TITLE,content:e.TOURS.ATTENDANT.E.BODY},{placement:"right",element:"#attconnectors",title:e.TOURS.ATTENDANT.F.TITLE,content:e.TOURS.ATTENDANT.F.BODY},{reflex:!0,placement:"bottom",element:"#att-obj-types",title:e.TOURS.ATTENDANT.G.TITLE,content:e.TOURS.ATTENDANT.G.BODY,onShow:function(){$("#att-container .att-init-button").removeClass("open")},onHidden:function(){$("#att-container .att-init-button").addClass("open")}},{reflex:!0,backdrop:!0,placement:"bottom",element:"#att-obj-types + .dropdown-menu",title:e.TOURS.ATTENDANT.H.TITLE,content:e.TOURS.ATTENDANT.H.BODY,onHidden:function(){$("#att-container .att-init-button").removeClass("open")}}]}},PbxObject.tours=PbxObject.tours||[],PbxObject.tours.dashboard=function(){return{steps:[{backdropPadding:{top:10},placement:"top",element:"#dash-tour-cont",title:PbxObject.frases.TOURS.DASHBOARD.A.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.A.BODY},{backdropPadding:{top:10},element:"#dash-graph-cont",title:PbxObject.frases.TOURS.DASHBOARD.B.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.B.BODY,placement:"bottom"},{backdropPadding:{top:10},element:"#dash-monitor-cont",title:PbxObject.frases.TOURS.DASHBOARD.C.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.C.BODY,placement:"top"},{element:"#dash-trstate-cont",title:PbxObject.frases.TOURS.DASHBOARD.D.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.D.BODY,placement:"top"},{element:"#dash-callmonitor-cont",title:PbxObject.frases.TOURS.DASHBOARD.E.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.E.BODY,placement:"top"},{element:"#home-btn",content:PbxObject.frases.TOURS.DASHBOARD.F.BODY,placement:"bottom"},{element:"#pbxmenu",title:PbxObject.frases.TOURS.DASHBOARD.G.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.G.BODY,placement:"right"},{element:"#history-dropdown-cont .dropdown-menu",title:PbxObject.frases.TOURS.DASHBOARD.H.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.H.BODY,placement:"left",onShow:function(){$("#history-dropdown-cont").addClass("open")},onShown:function(){$("#history-dropdown-cont .tour-step-backdrop").css("position","absolute")},onHide:function(){$("#history-dropdown-cont").removeClass("open")}},{reflex:!0,element:"#open-opts-btn",content:PbxObject.frases.TOURS.DASHBOARD.I.BODY,placement:"left"},{element:"#pbxoptions",title:PbxObject.frases.TOURS.DASHBOARD.J.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.J.BODY,placement:"left",onShow:function(){isOptionsOpened()||open_options()},onHide:function(){isOptionsOpened()&&close_options()}},{element:"#get-started-cont",title:PbxObject.frases.TOURS.DASHBOARD.K.TITLE,content:PbxObject.frases.TOURS.DASHBOARD.K.BODY,placement:"bottom"}]}},PbxObject.tours=PbxObject.tours||[],PbxObject.tours.equipment=function(e){e.frases;return{storage:window.localStorage,backdrop:!1,steps:[{placement:"bottom",element:"#objname",title:"Group name",content:"Enter a group name"},{backdrop:!0,backdropPadding:{bottom:10},placement:"top",element:"#equipment-group-setts",title:"Group settings",content:"Select the signaling <b>protocol</b> for devices to connect with. <b>Device type</b> is basicaly the type of devices that would be connected to the server."},{reflex:!0,placement:"top",element:"#add-newuser-btn",title:"Creating new extensions",content:"Click this button to open the <b>Create extensions</b> form",onHidden:function(){$("#new-user-form").collapse("show")}},{backdrop:!0,backdropPadding:{bottom:10},reflex:"users.create",placement:"top",element:"#new-user-form",title:"Creating new extensions",content:"To create a new extension, fill in the form with the extension's data and then click <b>Create</b> button. After creating a first extension, the equipment group will be created also (<br/> Make sure to fill in the <b>Group name</b> field above). <br/> Click <b>Clear</b> button to clear the form."},{backdrop:!0,backdropPadding:{bottom:10},placement:"top",element:"#group-extensions",title:"Extensions list",content:"All extensions that were added to the group are listed here with the real-time updates of the extensions statuses"},{placement:"top",element:"#ext-features-panel",title:"Extension features",content:"Select which of the features of IP PBX would be available to the extensions of current group",onShow:function(){$("#ext-features-panel").removeClass("minimized")}},{placement:"bottom",element:"#el-set-object",title:"Saving changes",content:"Click <b>Save</b> button to save changes"}]}},PbxObject.tours=PbxObject.tours||[],PbxObject.tours.users=function(e){e.frases;return{storage:window.localStorage,backdrop:!1,steps:[{placement:"bottom",element:"#objname",title:"Group name",content:"Enter a group name"},{reflex:!0,placement:"top",element:"#add-newuser-btn",title:"Creating new users",content:"Click this button to open the <b>Create users</b> form",onHidden:function(){$("#new-user-form").collapse("show")}},{backdrop:!0,backdropPadding:{bottom:10},reflex:"users.create",placement:"top",element:"#new-user-form",title:"Creating new users",content:"To create a new user, fill in the form with the user's data and then click <b>Create</b> button. After creating a first user, the users group will be created also (<br/> Make sure to fill in the <b>Group name</b> field above). <br/> Click <b>Clear</b> button to clear the form."},{backdrop:!0,backdropPadding:{bottom:10},placement:"top",element:"#group-extensions",title:"Users list",content:"All users that were added to the group are listed here with the real-time updates of the users statuses"},{placement:"top",element:"#ext-features-panel",title:"Extension features",content:"Select which of the features of IP PBX would be available to the extensions of current group",onShow:function(){$("#ext-features-panel").removeClass("minimized")}},{placement:"bottom",element:"#el-set-object",title:"Saving changes",content:"Click <b>Save</b> button to save changes"}]}};