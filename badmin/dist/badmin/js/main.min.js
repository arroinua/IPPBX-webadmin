function load_application(e){PbxObject.oid=e.oid,PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");if(e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})})),e.debug&&(document.getElementById("debug").checked=e.debug),e.dbconnection){var o=e.dbconnection;"sun.jdbc.odbc.JdbcOdbcDriver"==o.driver?(document.getElementById("odbc").checked=!0,o.url&&(document.getElementById("odbcurl").value=o.url)):o.driver&&(document.getElementById("jdbc").checked=!0,document.getElementById("jdbcdriver").value=o.driver,o.url&&(document.getElementById("jdbcurl").value=o.url)),o.schema&&(document.getElementById("dbowner").value=o.schema),o.username&&(document.getElementById("dbuser").value=o.username),o.password&&(document.getElementById("dbpass").value=o.password)}var a=e.parameters;if(a.length)for(var r=0;r<a.length;r++)add_app_row(a[r]);else add_app_row();renderObjRoute({routes:e.routes||[],frases:PbxObject.frases,onChange:setCurrObjRoute}),show_content(),set_page()}function set_application(){show_loading_panel();var e=document.getElementById("appvariables").getElementsByTagName("tbody")[0],t=document.getElementById("objname").value,n='"name":"'+t+'",';n+='"enabled":'+document.getElementById("enabled").checked+",",PbxObject.oid&&(n+='"oid":"'+PbxObject.oid+'",'),n+='"parameters":[';var o,a;for(o=0;o<e.children.length;o++){var r=e.children[o],i=r.getElementsByTagName("input"),s="";for(a=0;a<i.length;a++)if("variable"==i[a].name)s+='"key":"'+i[a].value+'",';else{if("value"!=i[a].name)continue;s+='"value":"'+i[a].value+'",'}""!=s&&(n+="{"+s+"},")}n+="],",n+='"debug":'+document.getElementById("debug").checked+",",n+='"dbconnection":{';var c,l;document.getElementById("odbc").checked?(c="sun.jdbc.odbc.JdbcOdbcDriver",l=document.getElementById("odbcurl").value):(c=document.getElementById("jdbcdriver").value,l=document.getElementById("jdbcurl").value),n+='"driver":"'+c+'",',n+='"url":"'+l+'",',document.getElementById("dbowner")&&(n+='"schema":"'+document.getElementById("dbowner").value+'",'),document.getElementById("dbuser")&&(n+='"username":"'+document.getElementById("dbuser").value+'",'),document.getElementById("dbpass")&&(n+='"password":"'+document.getElementById("dbpass").value+'",'),n+="},",json_rpc_async("setObject",n,function(e){if(set_object_success(e),e&&getTempParams().ext){var n={number:getTempParams().ext,target:{oid:e,name:t}};getTempParams().oid&&(n.oid=getTempParams().oid),console.log("set route params: ",n),setObjRoute(n)}})}function add_app_row(e){var t=document.getElementById("appvariables").getElementsByTagName("tbody")[0],n=document.createElement("tr"),o=document.createElement("td"),a=document.createElement("div");a.className="form-group";var r=document.createElement("input");r.className="form-control",r.setAttribute("type","text"),r.setAttribute("name","variable"),r.setAttribute("disabled","disabled"),e&&e.key&&(r.value=e.key),a.appendChild(r),o.appendChild(a),n.appendChild(o),t.appendChild(n),o=document.createElement("td"),a=document.createElement("div"),a.className="form-group",r=document.createElement("input"),r.className="form-control",r.setAttribute("name","value"),e&&e.value&&(r.value=e.value),a.appendChild(r),o.appendChild(a),n.appendChild(o),t.appendChild(n),t.appendChild(n)}function load_attendant(e){PbxObject.oid=e?e.oid:"",PbxObject.name=e?e.name:"";var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name?n.value=e.name:getObjects(null,function(e){!filterObject(e,"attendant").length}),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})})),e.debug&&(document.getElementById("debug").checked=e.debug),show_content(),set_page(),setInitAttParams(),makeActiveCanvas(),getAttTemplate("attendant_object",function(t){setAttSettings(e.parameters,t)});var o=document.getElementById("addConnector");o.onclick=function(){addConnector()},json_rpc_async("getExtensions",null,function(e){var t=e.filter(function(e){return"trunk"!==e.kind&&"cli"!==e.kind&&"timer"!==e.kind&&"routes"!==e.kind&&"pickup"!==e.kind});PbxObject.attendant.routes=t})}function setInitAttParams(){PbxObject.attendant={currentPid:"",routes:[],connectors:[],objects:{},buttons:["1","2","3","4","5","6","7","8","9","0","#","*"],availableButtons:[],types:{menu:"menu",commutator:"commutator",mail:"mail"}}}function changeAvailableButtons(e,t){var n,o=t||document.querySelector(".att-canvas.active"),a=[];"object"==typeof e?a=[].concat(e):(a=JSON.parse(o.getAttribute("data-available-buttons")),btnIndex=a.indexOf(e),btnIndex!==-1?a.splice(btnIndex,1):a.splice(btnIndex,0,e)),PbxObject.attendant.availableButtons=PbxObject.attendant.buttons.map(function(e){return n={},n.button=e,a.indexOf(e)===-1?n.disabled=!0:n.disabled=!1,n}),o.setAttribute("data-available-buttons",JSON.stringify(a))}function createCanvas(e){var t=document.getElementById("att-container"),n=document.createElement("div");n.className="att-canvas active",void 0!==e&&n.setAttribute("data-parent",e),t.appendChild(n),createInitButton(n),changeAvailableButtons(PbxObject.attendant.buttons),addAttObjects(PbxObject.attendant.objects,e)}function makeActiveCanvas(e){void 0!==e&&(PbxObject.attendant.currentPid=e);var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),o=document.getElementById("toPrevCanvas"),a=!1;n.forEach(function(n){t=n.getAttribute("data-parent"),t===e||!e&&!t?(n.classList.add("active"),a=n):n.classList.remove("active")}),a?changeAvailableButtons(JSON.parse(a.getAttribute("data-available-buttons"))):createCanvas(e),setSchemaActiveEl(e||""),o&&(e&&"hidden"===o.className?o.className="":e||(o.className="hidden")),toTheTop("att-container")}function removeCanvases(e){var t,n=[].slice.call(document.querySelectorAll(".att-canvas")),o=new RegExp(e+"d*");n.forEach(function(e){t=e.getAttribute("data-parent"),o.test(t)&&e.parentNode.removeChild(e)})}function toPrevCanvas(e){e&&e.preventDefault();var t=document.querySelector(".att-canvas.active"),n=t.getAttribute("data-parent"),o=n.substr(0,n.length-1);makeActiveCanvas(o)}function createInitButton(e){var t=document.createElement("div"),n=e||document.querySelector(".att-canvas.active");t.className="dropdown att-init-button",t.innerHTML='<button class="btn btn-default dropdown-toggle dropdown-round" type="button" id="att-obj-types" data-toggle="dropdown" aria-expanded="true"><i class="fa fa-plus"></i></button><ul class="dropdown-menu" role="menu" aria-labelledby="att-obj-types"><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.menu+'"><i class="fa fa-music"></i> '+PbxObject.frases.ATTENDANT.MENU+'</a></li><li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.mail+'"><i class="fa fa-envelope"></i>  '+PbxObject.frases.ATTENDANT.MAIL+"</a></li>"+(PbxObject.attendant.currentPid?'<li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-type="'+PbxObject.attendant.types.commutator+'"><i class="fa fa-phone"></i>  '+PbxObject.frases.ATTENDANT.COMMUTATOR+"</a></li>":"")+"</ul>",addEvent(t,"click",function(e){e&&e.preventDefault();var t=e.currentTarget,n=e.target;"top"===elPosition(t)?t.className="dropup att-init-button":t.className="dropdown att-init-button","A"!==n.nodeName&&(n=n.parentNode);var o=n.getAttribute("data-type");o&&showAttObjectSetts({type:o})}),n.appendChild(t)}function setInitAttMoveBtns(e){var t=PbxObject.attendant.buttons,n=document.getElementById("moveBack"),o=document.getElementById("moveMmenu");fillBtnsSelectList(t,n,e.moveBack),fillBtnsSelectList(t,o,e.moveMmenu)}function fillBtnsSelectList(e,t,n){var o,a=document.createDocumentFragment();e.forEach(function(e){o=document.createElement("option"),o.value=e,o.innerHTML=e,e===n&&o.setAttribute("selected","selected"),a.appendChild(o)}),t.appendChild(a)}function strToJson(e){var t=new RegExp(/([\d\w]+)(=+)(?!\{)([\d\w@\-_.\s,?!*%$^&#+]*)(?=\,|\})/,"g"),n=new RegExp(/([\d\w#*]+)(=+)(?=\{)/,"g");return e.replace(t,function(e,t,n,o){return"null"!==o&&(o=JSON.stringify(o)),'"'+t+'":'+o}).replace(n,function(e,t,n){return'"'+t+'":'})}function setAttSettings(e,t){var n,o=document.getElementById("attvariables"),a="",r="",i="",s="",c={},l=null;e&&o&&setFormData(o,e),e.forEach(function(e){"jsonString"===e.key?(l=e.value,n=JSON.parse(l,function(e,t){return"null"===t?null:t}),PbxObject.attendant.objects=n):"connectors"===e.key?(l=e.value,addConnectors(JSON.parse(l))):"greetings"===e.key?a=e.value:"ringbackMusic"===e.key?r=e.value:"connectionFailed"===e.key?i=e.value:"leaveMessage"===e.key?s=e.value:"moveBack"===e.key?c.moveBack=e.value:"moveMmenu"===e.key&&(c.moveMmenu=e.value)}),e.length||(c.moveBack="#",c.moveMmenu="*"),customize_upload("attGreetings",a),customize_upload("ringbackMusic",r),customize_upload("connectionFailed",i),customize_upload("leaveMessage",s),setInitAttMoveBtns(c),addAttObjects(n,""),buildSchema(n)}function buildSchema(e){var t,n,o=document.getElementById("att-schema"),a=[];addToSchema("home",{name:'<i class="fa fa-home"></i>',type:PbxObject.attendant.types.menu},o);for(key in e)e.hasOwnProperty(key)&&a.push(e[key]);sortByKey(a,"oid"),a.forEach(function(e){t=e.oid.substr(0,e.oid.length-1),n="0"===e.oid?o.querySelector('ul[data-oid="home"]'):o.querySelector('ul[data-oid="'+t+'"]'),addToSchema(e.oid,e,n)}),addEvent(o,"click",setAttPosition)}function addToSchema(e,t,n){if(null!==e&&void 0!==e&&"null"!==e){var o,a,r=e.substr(0,e.length-1);a=n?n:"0"!==e?document.querySelector('#att-schema ul[data-oid="'+r+'"]'):document.querySelector('#att-schema ul[data-oid="home"]'),o=createSchemaBranch(e,t),a.appendChild(o)}}function createSchemaBranch(e,t){var n=document.createElement("li");return n.setAttribute("data-oid",e),t.type===PbxObject.attendant.types.menu?("home"===e&&(n.className="active"),n.innerHTML='<label class="fa fa-minus" for="t-'+e+'"></label><input type="checkbox" name="tree-node" id="t-'+e+'"/> <a href="#'+("home"===e?"":e)+'">'+t.name+(t.button?'<small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>":"")+'</a><ul data-oid="'+e+'"></ul>'):(n.innerHTML=t.name,t.button&&"null"!==t.button&&(n.innerHTML+=' <small class="nowrap text-muted"> '+generateAttObjPath(e)+"</small>")),n}function rebuildSchema(){var e=document.getElementById("att-schema");e.children[0]&&e.removeChild(e.children[0]),buildSchema(PbxObject.attendant.objects),setSchemaActiveEl(PbxObject.attendant.currentPid)}function removeFromSchema(e){var t=document.querySelector('#att-schema li[data-oid="'+e+'"]');t.parentNode.removeChild(t)}function setSchemaActiveEl(e){var t=document.getElementById("att-schema"),n=t.querySelector('li a[href="#'+e+'"]'),o=t.querySelector("li.active");n&&(o&&(o.className=""),n.parentNode.className="active")}function addAttObjects(e,t){if(e)for(key in e)e.hasOwnProperty(key)&&key.substr(0,key.length-1)===t&&addAttObject(e[key])}function addAttObject(e,t){var n,o=new AttObject(e),a=document.querySelector(".att-canvas.active"),r=PbxObject.attendant.currentPid+(e.button?e.button:0);if(e.button)changeAvailableButtons(e.button,a);else{var i=a.querySelector(".att-init-button");i&&isMainEl()&&i.parentNode.removeChild(i)}t?(a.insertBefore(o,t.element),t.removeElement(null,t.params),t.params.button!==e.button&&(n=PbxObject.attendant.currentPid+t.params.button,changeObjectsParent(n,r))):a.insertBefore(o,a.lastChild),e.connector&&(e.data=e.data.split(" - ")[0]),e.oid=r,PbxObject.attendant.objects[r]!==e&&(PbxObject.attendant.objects[r]=e,t?rebuildSchema():addToSchema(r,e)),setupInProgress()}function AttObject(e){var t=formAttParams(e),n=PbxObject.templates.attendant_object,o=Mustache.render(n,t),a=document.createElement("div"),r=PbxObject.attendant.currentPid+(e.button?e.button:0);console.log("new AttObject params: ",e,t),a.className="att-obj-wrapper",a.innerHTML=o;var i=a.querySelector("#enter-att-menu"),s=a.querySelector("#edit-att-object"),c=a.querySelector("#remove-att-object");return removeTreeBtn=a.querySelector("#remove-att-tree"),i&&addEvent(i,"click",function(t){this.enterAttMenu(t,e)}.bind(this)),s&&addEvent(s,"click",function(t){this.editObject(t,e)}.bind(this)),c&&addEvent(c,"click",function(t){this.removeElement(t,e)}.bind(this)),removeTreeBtn&&addEvent(removeTreeBtn,"click",function(t){this.removeElement(t,e,!0)}.bind(this)),this.oid=r,this.params=e,this.element=a,a}function removeObject(e,t){var n=PbxObject.attendant.objects,o=(document.getElementById("objname").value,t?new RegExp(e+"d*"):new RegExp("^"+e+"$"));for(var a in n)n.hasOwnProperty(a)&&o.test(a)&&delete n[a];removeCanvases(e),setupInProgress()}function changeObjectsParent(e,t){var n=PbxObject.attendant.objects,o=new RegExp(e+"d*"),a="";for(var r in n)n.hasOwnProperty(r)&&o.test(r)&&(a=r.replace(e,t),n[a]=n[r],n[a].oid=a,delete n[r])}function checkParams(e){var t="";return e.button||isMainEl()||(t+=PbxObject.frases.ATT__BTN_MISSED+"\n"),e.type===PbxObject.attendant.types.menu||e.connector||(t+=PbxObject.frases.ATT__CONN_MISSED+"\n"),e.type!==PbxObject.attendant.types.menu||e.file||e.data||(t+=PbxObject.frases.ATT__AUDIO_FILE_MISSED+"\n"),""===t||(alert(t),!1)}function showAttObjectSetts(e,t){var n=formAttParams(e);getAttTemplate("attendant_modal",function(o){var a=Mustache.render(o,n);r||(r=document.createElement("div"),r.id="att-setts-cont",$("#pagecontainer").prepend(r)),$(r).html(a);var r=document.getElementById("att-setts-cont"),i=document.getElementById("att-setts-data"),s=document.querySelector('#att-setts-form select[name="data"]'),c=document.querySelector('#att-setts-form select[name="button"]');s&&e.connector&&(s.value=e.connector),c&&e.button&&(c.value=e.button),e.type===PbxObject.attendant.types.menu?customize_upload("audioFile",e.data||""):e.type===PbxObject.attendant.types.mail&&customize_upload("audioFile",e.audio||""),$("#set-att-object").on("click",function(n){setAttObject(e,t)}),$('#att-setts-modal [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),i&&ReactDOM.render(Select3({name:"data",placeholder:PbxObject.frases.ATTENDANT.DATA_PLACEHOLDER,frases:PbxObject.frases,value:{value:n.data.data,label:n.data.data},options:n.connectors}),i),$("#att-setts-modal").on("shown.bs.modal",function(){document.querySelector('#att-setts-modal input[name="name"]').focus()}),$("#att-setts-modal").on("hide.bs.modal",function(){$('#att-setts-modal [data-toggle="popover"]').popover("destroy"),$("#set-att-object").off("click",function(n){setAttObject(e,t)})}),$("#att-setts-modal").modal()})}function setAttObject(e,t){var n=collectAttParams(e);console.log("setAttObject: ",n),checkParams(n)&&(t?addAttObject(n,t):addAttObject(n),$("#att-setts-modal").modal("hide"),setupInProgress())}function collectAttParams(e){var t,n=document.getElementById("att-setts-cont"),o=e.type,a=(o===PbxObject.attendant.types.menu?"input":"select",extend({},e));if(isMainEl()?a.button=null:a.button=n.querySelector('select[name="button"]').value,a.name=n.querySelector('input[name="name"]').value||generateAttObjName(o,a.button),a.type=o,o===PbxObject.attendant.types.menu){var r=n.querySelector('input[type="file"]'),i=n.querySelector('[name="digits"]');r&&(r.files.length?(a.file=r,a.data=r.files[0].name):e.file&&(a.file=e.file)),!a.data&&e.file&&(a.data=e.file.files[0].name),a.digits=i.checked?"14":"1"}else t=n.querySelector('[name="data"]').value,a.data=t,a.connector=t;if(o===PbxObject.attendant.types.mail){var s=n.querySelector('input[name="subject"]'),c=n.querySelector('textarea[name="body"]'),r=n.querySelector('input[type="file"]');r&&(r.files.length?(a.file=r,a.audio=r.files[0].name):e.file&&(a.file=e.file)),!a.audio&&e.file&&(a.audio=e.file.files[0].name),a.subject=s.value,a.body=c.value}return a}function formAttParams(e){var t={data:e,pid:PbxObject.attendant.currentPid,connectors:[],buttons:PbxObject.attendant.availableButtons,frases:PbxObject.frases,typeMenu:function(){return this.data.type==PbxObject.attendant.types.menu},typeCommutator:function(){return this.data.type==PbxObject.attendant.types.commutator},typeEmail:function(){return this.data.type==PbxObject.attendant.types.mail},allowMultipleDigits:function(){return"14"===this.data.digits},objType:function(){return this.frases.ATTENDANT[this.data.type.toUpperCase()]}};return t.data.name=t.data.name||generateAttObjName(t.data.type,t.pid),e.type===PbxObject.attendant.types.commutator?(t.connectors=PbxObject.attendant.connectors.filter(function(e){return e.ext.indexOf("@")===-1}),t.connectors=t.connectors.concat(PbxObject.attendant.routes)):e.type===PbxObject.attendant.types.mail&&(t.connectors=PbxObject.attendant.connectors.filter(function(e){return e.ext.indexOf("@")!==-1})),t.connectors=t.connectors.map(formatConnectors),t}function formatConnectors(e){return{value:e.ext,label:e.name?e.ext+" - "+e.name:e.ext}}function generateAttObjName(e,t,n){var o="";return o=PbxObject.attendant.currentPid||n?n||PbxObject.frases.ATTENDANT[e.toUpperCase()]:e===PbxObject.attendant.types.menu?PbxObject.frases.ATTENDANT.MAIN_MENU:PbxObject.frases.ATTENDANT.MAIL}function generateAttObjPath(e){return e.replace("0","").split("").reduce(function(e,t){return e+"."+t})}function setAttPosition(e){var e=e||window.event;if(e){var t=e.target;if("LABEL"===t.nodeName&&("fa fa-plus"===t.className?t.className="fa fa-minus":t.className="fa fa-plus"),"A"!==t.nodeName&&(t=t.parentNode),"A"===t.nodeName){e.preventDefault();var n=t.href.substr(t.href.indexOf("#")+1);t.hash;makeActiveCanvas(n)}}}function addConnectors(e){var t=document.getElementById("attconnectors").querySelector("tbody");e.forEach(function(e){t.appendChild(createConnectorRow(e)),PbxObject.attendant.connectors.push(e)})}function addConnector(e){var e=e||window.event;e&&"click"==e.type&&e.preventDefault();var t=document.getElementById("attconnectors"),n=t.querySelector("tbody"),o=t.querySelector('input[name="connName"]'),a=t.querySelector('input[name="connVal"]'),r=PbxObject.attendant.connectors,i={};return Utils.validateElement(o,o.parentNode),Utils.validateElement(a,a.parentNode),!(!a.value||!o.value)&&(i={name:o.value,ext:a.value},n.appendChild(createConnectorRow(i)),o.value="",a.value="",r.push(i),void setupInProgress())}function removeConnector(e){var t=PbxObject.attendant.connectors;t.forEach(function(n,o){n.name===e.name&&t.splice(o,1)}),setupInProgress()}function createConnectorRow(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,o,a=document.createElement("tr");return n=a.insertCell(0),e&&e.name&&(n.textContent=e.name),n=a.insertCell(1),e&&e.ext&&(n.textContent=e.ext),n=a.insertCell(2),o=document.createElement("a"),o.href="#",o.className="remove-clr",o.innerHTML='<i class="fa fa-close"></i>',addEvent(o,"click",function(t){remove_row(t),removeConnector(e)}),n.appendChild(o),a}function getAttTemplate(e,t){PbxObject.templates=PbxObject.templates||{};var n=PbxObject.templates[e];n?t(n):$.get("/badmin/views/"+e+".html",function(n){PbxObject.templates[e]=n,t(n)})}function filterByPattern(e,t){if(t){var n=new RegExp(t),o=e.filter(function(e){return n.test(e.ext)});return o}return e}function isMainEl(){return!PbxObject.attendant.currentPid}function set_attendant(){var e,t=document.getElementById("objname").value,n=(document.querySelector(".att-container"),PbxObject.attendant.objects),o=PbxObject.oid,a=retrieveFormData(document.getElementById("attvariables")),r=document.getElementById("attGreetings"),i=document.getElementById("ringbackMusic"),s=document.getElementById("connectionFailed"),c=document.getElementById("leaveMessage"),l=PbxObject.options.prefix,d="users"+(l?"/"+l:"")+"/attendant/"+o+"/";if(r.files[0]&&upload(r,"/attendant/"+o+"/"+r.files[0].name),i.files[0]&&upload(i,"/attendant/"+o+"/"+i.files[0].name),s.files[0]&&upload(s,"/attendant/"+o+"/"+s.files[0].name),c.files[0]&&upload(c,"/attendant/"+o+"/"+c.files[0].name),!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',PbxObject.oid&&(e+='"oid":"'+o+'",'),e+='"kind":"attendant",';var u=document.getElementById("enabled");null!=u&&(e+='"enabled":'+u.checked+","),e+='"debug":'+document.getElementById("debug").checked+",",e+='"parameters":[',e+="{",e+='"key":"algdir",',e+='"value":"'+d+'"',e+="},";var m;for(var p in n)n.hasOwnProperty(p)&&(m=n[p].file,m&&(m.files.length&&upload(m,"/attendant/"+o+"/"+m.files[0].name),delete n[p].file));e+="{",e+='"key":"jsonString",',e+='"value":'+JSON.stringify(n),e+="},",e+="{",e+='"key":"connectors",',e+='"value":'+JSON.stringify(PbxObject.attendant.connectors),e+="},";for(var p in a)a.hasOwnProperty(p)&&(e+="{",e+='"key":"'+p+'",',e+='"value":"'+a[p]+'"',e+="},");e+="],",json_rpc_async("setObject",e,function(e){set_object_success(e),setupInProgress(!1)})}function load_bgroup(e){console.log("load_bgroup: ",e),switch_presentation(e.kind);var t,n=document,o=e.kind,a=e.members,r=n.getElementById("dcontainer"),i=document.getElementById("enabled"),s=document.getElementById("new-user-form"),c=$(".object-name .switch"),l=e.available,d=PbxObject.options.maxusers,u=PbxObject.options.storelimit;if(l&&(l=l.sort(),PbxObject.available=l),PbxObject.oid=e.oid,PbxObject.name=e.name,e.name&&(n.getElementById("objname").value=e.name),i&&(i.checked=e.enabled,addEvent(i,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(i.checked=!i.checked)})})),"users"===o||"equipment"===o){var m=document.getElementById("group-extensions").querySelector("tbody"),p=document.getElementById("available-users"),b=document.getElementById("group-protocol"),f=document.getElementById("get-proto-opts"),g=(document.getElementById("new-user-form"),document.getElementById("clear-input"),document.getElementById("add-user")),h=document.getElementById("user-login"),v="users"===o?"user":"phone";if("equipment"==o){var y=e.options.protocols||e.options.protocol;if(addEvent(p,"change",function(e){h.value=createExtLogin(e.target.value)}),"object"==typeof y)y.forEach(function(e){b.innerHTML+='<option value="'+e+'">'+e+"</option>"});else{var x=b.parentNode,E=document.createElement("span");E.className="form-control-static",E.textContent=y,x.insertBefore(E,b),x.removeChild(b)}addEvent(f,"click",function(){get_protocol_opts(e.options.protocol||b.value,e.options)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={}}l&&l.length?(makeElement(l.sort(),p,function(e){var t=document.createElement("option");return t.value=e,t.textContent=e,t}),h.value=createExtLogin(p.value)):g.setAttribute("disabled","disabled"),addEvent(s,"submit",function(e){e.preventDefault(),addUser(v,function(){cleanForm("new-user-form"),"users"===o&&s.storelimit&&u&&d&&(s.storelimit.value=(convertBytes(u,"Byte","GB")/d).toFixed(2)),h.value=createExtLogin(p.value)})});makeElement(sortByKey(a,"number"),m,addMembersRow),PbxObject.members=a||[],PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer?$("#from-directory-btn").show():$("#from-directory-btn").hide()}else l&&fill_list_items("available",l),a&&fill_list_items("members",a,"number");if(e.options)if("equipment"==o){var O=document.getElementById("devtype"),j=document.getElementById("group-protocol"),_=e.options.kind||"ipphones",P=document.getElementById("tr-register"),C=document.getElementById("tr-proxy");O.value=_,e.options.protocol||(j.value="sip"),switch_options_tab("tab-"+_),O.onchange=function(){_=this.options[this.selectedIndex].value,switch_options_tab("tab-"+_),switchVisibility(c,"trunk"===_)},1!==PbxObject.options.mode||PbxObject.options.prefix?(O.removeChild(O.children[O.children.length-1]),c.hide(),console.log(c)):switchVisibility(c,"trunk"===_),void 0!==e.options.gateway&&(n.getElementById("regname").value=e.options.gateway.regname||"",n.getElementById("regpass").value=e.options.gateway.regpass||""),"trunk"==_&&(document.getElementById("tr-domain").value=e.options.trunk.domain||"",document.getElementById("tr-user").value=e.options.trunk.user||"",document.getElementById("tr-auth").value=e.options.trunk.auth||"",document.getElementById("tr-pass").value=e.options.trunk.pass||"",document.getElementById("tr-regexpires").value=e.options.trunk.regexpires||60,P.checked=e.options.trunk.register,isVisible("reg-setts",P.checked),C.checked=e.options.trunk.proxy,isVisible("proxy-setts",C.checked),document.getElementById("tr-paddr").value=e.options.trunk.paddr||"",document.getElementById("tr-pauth").value=e.options.trunk.pauth||"",document.getElementById("tr-ppass").value=e.options.trunk.ppass||""),n.getElementById("phonelines").value=e.options.phonelines||"1",void 0!=e.options.starflash&&(n.getElementById("starflash").checked=e.options.starflash),addEvent(P,"change",function(e){isVisible("reg-setts",this.checked)}),addEvent(C,"change",function(e){isVisible("proxy-setts",this.checked)})}else if("unit"==o){if(n.getElementById("groupno1").value=e.options.groupno||"",n.getElementById("timeout1").value=e.options.timeout||"",void 0!==e.options.huntmode){var I=n.getElementById("huntmode1");I.selectedIndex=e.options.huntmode,addEvent(I,"change",function(){checkHuntMode()}),checkHuntMode()}void 0!==e.options.huntfwd&&(n.getElementById("huntfwd1").checked=e.options.huntfwd);var k=e.options.greeting||"",w=e.options.waitmusic||"";customize_upload("unit-greeting",k),customize_upload("unit-waitmusic",w)}else if("pickup"==o)n.getElementById("groupno2").value=e.options.groupno||"";else if("conference"==o||"channel"==o||"selector"==o){var B=["OFF","320x240","352x288","640x360","640x480","704x576","1024x768","1280x720","1920x1080"],S=document.getElementById("initmode");S&&(S.onchange=function(){2==S.options[S.selectedIndex].value?document.getElementById("conf-greetfile").style.display="block":document.getElementById("conf-greetfile").style.display="none"}),PbxObject.videomax=e.options.maxvideomode;var T=e.options.onholdfile||"";customize_upload("onhold2",T);var A=e.options.greetingfile||"";if(customize_upload("greeting2",A),"channel"==o){var N,L=[].slice.call(r.querySelectorAll('input[name="objectType"]')),M=document.getElementById("out-number"),D=document.getElementById("channel-type-sel"),R=document.getElementById("video");L.forEach(function(t){if(e.external){if("global"==t.value){var n=t.parentNode;t.checked=!0,$(n).button("toggle"),N=t.value}M.value=e.external}else if("local"==t.value){var n=t.parentNode;t.checked=!0,$(n).button("toggle"),N=t.value}D.onclick=function(e){var e=e||window.event,t=e.target;"LABEL"===t.nodeName&&(N=t.children[0].value,changeGroupType(N))}}),R&&("OFF"!==e.options.videomode?R.checked=!0:R.checked=!1),S&&(S.value=e.options.initmode);var q=e.options.musiconback||"";document.getElementById("playmusiconback").checked=!!q,customize_upload("musiconback",q),changeGroupType(N)}else if("selector"==o){var H=e.owner,F=document.getElementById("owner");S&&(S.value=e.options.initmode),2==e.options.initmode?document.getElementById("conf-greetfile").style.display="block":document.getElementById("conf-greetfile").style.display="none",initcalls.checked=e.options.initcalls;var U=l.concat(e.members).sort();U.forEach(function(e){H&&e==H?F.innerHTML+='<option value="'+e+'" selected>'+e+"</option>":F.innerHTML+='<option value="'+e+'">'+e+"</option>"})}n.getElementById("dialuptt").value=e.options.dialtimeout||"",n.getElementById("autoredial").checked=e.options.autoredial,"channel"!==o&&(n.getElementById("confrecord").checked=e.options.recording);var z=n.getElementById("playgreet");z.checked=e.options.greeting,z.checked&&(z.checked=!!e.options.greetingfile);var G=n.getElementById("videoform");if(G)for(t=0;t<B.length;t++){var K=n.createElement("option");if(K.value=B[t],K.innerHTML=B[t],G.appendChild(K),B[t]==e.options.videomode&&(G.selectedIndex=t),B[t]==e.options.maxvideomode)break}var J=document.getElementById("confrecord"),Y=document.getElementById("rectime-cont"),V=document.getElementById("rectime");addEvent(J,"change",function(e){this.checked?Y.classList.remove("hidden"):Y.classList.add("hidden")}),J&&void 0!==e.options.recording&&(J.checked=e.options.recording,J.checked&&Y.classList.remove("hidden")),V&&void 0!==e.options.rectime&&(V.value=e.options.rectime/60)}if(void 0!=e.profile){n.getElementById("forwarding")&&(n.getElementById("forwarding").checked=e.profile.forwarding),n.getElementById("callpickup")&&(n.getElementById("callpickup").checked=e.profile.callpickup),n.getElementById("dndover")&&(n.getElementById("dndover").checked=e.profile.dndover),n.getElementById("busyover")&&(n.getElementById("busyover").checked=e.profile.busyover),n.getElementById("monitor")&&(n.getElementById("monitor").checked=e.profile.monitor),n.getElementById("dnd")&&(n.getElementById("dnd").checked=e.profile.dnd),n.getElementById("clir")&&(n.getElementById("clir").checked=e.profile.clir),n.getElementById("pickupdeny")&&(n.getElementById("pickupdeny").checked=e.profile.pickupdeny),n.getElementById("busyoverdeny")&&(n.getElementById("busyoverdeny").checked=e.profile.busyoverdeny),n.getElementById("monitordeny")&&(n.getElementById("monitordeny").checked=e.profile.monitordeny),n.getElementById("callwaiting")&&(n.getElementById("callwaiting").checked=e.profile.callwaiting),n.getElementById("outcallbarring")&&(n.getElementById("outcallbarring").checked=e.profile.outcallbarring),n.getElementById("costroutebarring")&&(n.getElementById("costroutebarring").checked=e.profile.costroutebarring),n.getElementById("recording")&&(n.getElementById("recording").checked=e.profile.recording),n.getElementById("hiderecind")&&(n.getElementById("hiderecind").checked=e.profile.hiderecindication),n.getElementById("voicemail")&&(n.getElementById("voicemail").checked=e.profile.voicemail);var W=e.profile.bnumbertransforms;if(0!=W.length)for(t=0;t<W.length;t++)append_transform(null,"transforms",W[t]);else append_transform(null,"transforms")}if(TableSortable.sortables_init(),show_content(),set_page(),PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer.trim().length&&(PbxObject.LdapConnection=Ldap({domains:PbxObject.options.ldap.directoryDomains.split(" "),available:PbxObject.available,onaddusers:onAddLdapUsers}),$("#from-directory-btn").click(function(){PbxObject.LdapConnection.auth()})),"users"===o){var Q=PbxObject.options.services.filter(function(e){return e.state});s.storelimit&&u&&d&&(s.storelimit.value=(convertBytes(u,"Byte","GB")/d).toFixed(2)),console.log("storelimit=",u,d,convertBytes(u,"Byte","GB")/d),Q.length?$("#services-cont").append(Q.map(createServiceBtn)):(!PbxObject.options.ldap||PbxObject.options.ldap&&!PbxObject.options.ldap.directoryServer)&&$("#add-external-user").hide();var X=window.sessionStorage.getItem("serviceParams");X&&(getExternalUsers(JSON.parse(X)),window.sessionStorage.removeItem("serviceParams"))}}function onAddLdapUsers(e){if(!PbxObject.name)return void set_bgroup(e,onAddLdapUsers);console.log("onAddUsers: ",e);var t=PbxObject.LdapConnection;document.getElementById("available-users");t.setUsers({groupid:PbxObject.oid,username:t.options.username,password:t.options.password,domain:t.options.domain,users:e},function(e){console.log("addLdapUsers result: ",e),t.close(),refreshUsersTable(function(e){t.options.available=e})})}function createServiceBtn(e){var t=document.createElement("button");return t.type="button",t.className="btn btn-default padding-lg pl-users",t.innerHTML="<span>"+PbxObject.frases.IMPORT_USERS_FROM+" </span><strong>"+e.name+"</strong>",addEvent(t,"click",function(t){getExternalUsers(e)}),t}function getExternalUsers(e){PbxObject.LdapConnection=Ldap({service_id:e.id,service_type:e.type,available:PbxObject.available,onaddusers:setExternalUsers}),1===e.type?PbxObject.LdapConnection.getExternalUsers():json_rpc_async("getExternalUsers",{service_id:e.id},function(e){console.log("getExternalUsers result: ",e),e&&PbxObject.LdapConnection.showUsers(e)})}function setExternalUsers(e){if(!PbxObject.name)return void set_bgroup(e,setExternalUsers);
console.log("setExternalUsers: ",e);var t=PbxObject.LdapConnection;t.setExternalUsers({groupid:PbxObject.oid,service_id:t.options.service_id,users:e},function(e){console.log("addLdapUsers result: ",e),t.close(),refreshUsersTable(function(e){t.options.available=e})})}function set_bgroup(e,t){var n,o,a,r=document,i=PbxObject.oid,s=PbxObject.kind,c=r.getElementById("members"),l=r.getElementById("profile"),d=r.getElementById("playgreet"),u=r.getElementById("objname").value,m=document.getElementById("enabled"),p=[].slice.call(document.querySelectorAll('input[name="objectType"]'));if(!u)return void alert(PbxObject.frases.MISSEDNAMEFIELD);if(n='"name":"'+u+'",',show_loading_panel(),PbxObject.name?o=set_object_success:(PbxObject.name=u,o=null),i&&(n+='"oid":"'+i+'",'),s&&(n+='"kind":"'+s+'",'),n+='"enabled":'+m.checked+",","users"!=s&&"equipment"!=s){n+='"members":[';for(var b=0;b<c.children.length;b++)n+='"'+c.children[b].innerHTML+'",';n+="],"}if("users"==s||"equipment"==s){n+='"members":[';for(var b=0;b<PbxObject.members.length;b++)n+='"'+PbxObject.members[b].number+'",';n+="],"}if("channel"==s){if(p.forEach(function(e){e.checked&&(a=e.value)}),"global"==a){d.checked=!1;var f=document.getElementById("out-number");n+='"external":"'+f.value+'",'}}else if("selector"==s){var g=document.getElementById("owner").options[document.getElementById("owner").selectedIndex].value;n+='"owner":"'+g+'",'}else if(("users"==s||"unit"==s||"equipment"==s)&&l){n+='"profile":{',null!=r.getElementById("forwarding")&&(n+='"forwarding":'+r.getElementById("forwarding").checked+","),null!=r.getElementById("callpickup")&&(n+='"callpickup":'+r.getElementById("callpickup").checked+","),null!=r.getElementById("dndover")&&(n+='"dndover":'+r.getElementById("dndover").checked+","),null!=r.getElementById("busyover")&&(n+='"busyover":'+r.getElementById("busyover").checked+","),null!=r.getElementById("monitor")&&(n+='"monitor":'+r.getElementById("monitor").checked+","),null!=r.getElementById("dnd")&&"users"!==s&&(n+='"dnd":'+r.getElementById("dnd").checked+","),null!=r.getElementById("recording")&&(n+='"recording":'+r.getElementById("recording").checked+","),null!=r.getElementById("hiderecind")&&(n+='"hiderecindication":'+r.getElementById("hiderecind").checked+","),null!=r.getElementById("callwaiting")&&"users"!==s&&(n+='"callwaiting":'+r.getElementById("callwaiting").checked+","),null!=r.getElementById("pickupdeny")&&(n+='"pickupdeny":'+r.getElementById("pickupdeny").checked+","),null!=r.getElementById("monitordeny")&&(n+='"monitordeny":'+r.getElementById("monitordeny").checked+","),null!=r.getElementById("busyoverdeny")&&(n+='"busyoverdeny":'+r.getElementById("busyoverdeny").checked+","),null!=r.getElementById("voicemail")&&(n+='"voicemail":'+r.getElementById("voicemail").checked+","),null!=r.getElementById("outcallbarring")&&(n+='"outcallbarring":'+r.getElementById("outcallbarring").checked+","),null!=r.getElementById("costroutebarring")&&(n+='"costroutebarring":'+r.getElementById("costroutebarring").checked+",");var h=r.getElementById("transforms").getElementsByTagName("tbody")[0];h&&(n+='"bnumbertransforms":[',n+=encode_transforms("transforms"),n+="]"),n+="},"}if(n+='"options":{',"equipment"==s){var v=JSON.stringify(PbxObject.protocolOpts);v=v.substr(1,v.length-2);var y=document.getElementById("devtype"),x=y.options[y.selectedIndex].value,E=document.getElementById("group-protocol");if(E&&(n+='"protocol":"'+E.options[E.selectedIndex].value+'",'),"ipphones"==x)n+='"kind":"ipphones",';else if("gateway"==x)n+='"kind":"gateway",',n+='"gateway":{',n+='"regname":"'+r.getElementById("regname").value+'",',n+='"regpass":"'+r.getElementById("regpass").value+'",',n+="},";else if("trunk"==x){var O=document.getElementById("tr-register").checked,j=document.getElementById("tr-proxy").checked;n+='"kind":"trunk",',n+='"trunk":{',n+='"domain":"'+document.getElementById("tr-domain").value+'",',n+='"register":'+O+",",O&&(n+='"user":"'+document.getElementById("tr-user").value+'",',n+='"auth":"'+document.getElementById("tr-auth").value+'",',n+='"pass":"'+document.getElementById("tr-pass").value+'",',n+='"regexpires":'+document.getElementById("tr-regexpires").value+","),n+='"proxy":'+j+",",j&&(n+='"paddr":"'+document.getElementById("tr-paddr").value+'",',n+='"pauth":"'+document.getElementById("tr-pauth").value+'",',n+='"ppass":"'+document.getElementById("tr-ppass").value+'",'),n+="},"}r.getElementById("phonelines")&&(n+='"phonelines":'+r.getElementById("phonelines").value+","),r.getElementById("starflash")&&(n+='"starflash":'+r.getElementById("starflash").checked+","),n+=v}else if("unit"==s){n+='"groupno":"'+r.getElementById("groupno1").value+'",',n+='"timeout":'+r.getElementById("timeout1").value+",",n+='"huntmode":'+r.getElementById("huntmode1").value+",",n+='"huntfwd":'+r.getElementById("huntfwd1").checked+",";var _=document.getElementById("unit-greeting"),P=document.getElementById("unit-waitmusic");_.value&&(_.files[0]&&(n+='"greeting":"'+_.files[0].name+'",'),upload("unit-greeting")),P.value&&(P.files[0]&&(n+='"waitmusic":"'+P.files[0].name+'",'),upload("unit-waitmusic"))}else if("pickup"==s)n+='"groupno":"'+r.getElementById("groupno2").value+'",';else if("conference"==s||"channel"==s||"selector"==s){var C=document.getElementById("initmode"),I=C.options[C.selectedIndex].value,d=r.getElementById("playgreet");if(file2=document.getElementById("greeting2"),n+='"autoredial":'+r.getElementById("autoredial").checked+",",n+='"recording":'+r.getElementById("confrecord").checked+",",n+='"greeting":'+d.checked+",",r.getElementById("rectime")&&r.getElementById("confrecord").checked&&(n+='"rectime":'+60*r.getElementById("rectime").value+","),d.checked&&file2.value&&(file2.files[0]&&(n+='"greetingfile":"'+file2.files[0].name+'",'),upload("greeting2")),"channel"!=s&&(n+='"dialtimeout":'+r.getElementById("dialuptt").value+",",n+='"videomode":"'+r.getElementById("videoform").value+'",'),"selector"==s){var k=document.getElementById("initcalls");n+='"initcalls":'+k.checked+",",2==I&&(file3=document.getElementById("onhold2"),file3.value&&(file3.files[0]&&(n+='"onholdfile":"'+file3.files[0].name+'",'),upload("onhold2")))}if("channel"==s){var w=document.getElementById("playmusiconback").checked;if(n+='"playmusiconback":'+w+",",w){var B=document.getElementById("musiconback");B.files[0]&&(n+='"musiconback":["'+B.files[0].name+'"],'),upload("musiconback")}var S=document.getElementById("video");n+=S.checked?'"videomode":"640x480",':'"videomode":"OFF",'}n+='"initmode":'+I+","}n+="}",json_rpc_async("setObject",n,function(n,a){"function"==typeof o&&o(),"function"==typeof t&&t(e)})}function renderObjRoute(e){ReactDOM.render(ObjectRoute({routes:e.routes,frases:e.frases,onChange:e.onChange}),document.getElementById("object-route-cont"))}function addMembersRow(e){var t,n,o,a,r,i;return t=document.createElement("tr"),a=getInfoFromState(e.state,!0),r=a.rstatus,i=a.rclass,t.id=e.oid,n=t.insertCell(0),e.oid?(t.setAttribute("data-ext",e.number),o=document.createElement("a"),o.textContent=e.number,o.href="#",addEvent(o,"click",get_extension),n.appendChild(o)):n.textContent=e.number,n=t.insertCell(1),n.setAttribute("data-cell","name"),n.textContent=e.name||"",n=t.insertCell(2),n.setAttribute("data-cell","display"),n.textContent=e.display||"",n=t.insertCell(3),n.setAttribute("data-cell","reg"),n.textContent=e.followme||e.reg||"",n=t.insertCell(4),n.setAttribute("data-cell","status"),n.innerHTML='<span class="label label-'+a.className+'">'+r+"</span>",n=t.insertCell(5),button=document.createElement("button"),button.className="btn btn-link btn-danger btn-md",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",delete_extension),n.appendChild(button),t}function addUser(e,t){var n,o,a,r=r||window.event,i=document.getElementById("group-extensions").querySelector("tbody"),s=document.getElementById("available-users"),c=s.options,l=document.getElementById("user-name"),d=document.getElementById("user-login"),u=document.getElementById("user-email"),m=document.getElementById("user-alias"),p=document.getElementById("user-pass"),b=document.getElementById("storelimit");if(c.length){if(!PbxObject.name)return void set_bgroup(e,function(){addUser(e,t)});n=s.options[s.selectedIndex].value,o=l.value||PbxObject.frases.KINDS[e]+" "+n,login=d.value,email=u.value,a=m?m.value:o;var f='"kind":"'+e+'",';f+='"groupid":"'+PbxObject.oid+'",',login&&(f+='"login":"'+login+'",'),email&&(f+='"info": { "email": "'+email+'" },'),f+='"number":"'+n+'",',f+='"name":"'+o+'",',f+='"display":"'+a+'",',f+='"password":"'+p.value+'",',b=convertBytes(parseFloat(b.value),"GB","Byte"),b>=0&&(f+='"storelimit":'+b+",");var g={kind:e,groupid:PbxObject.oid,number:n,name:o,display:a,password:p.value};json_rpc_async("setObject",f,function(e,o){if(e){g.oid=e;var a=addMembersRow(g),r=i.rows;r.length?i.insertBefore(a,i.firstChild):i.appendChild(a),PbxObject.members.push(g),PbxObject.available.indexOf(n)!==-1&&PbxObject.available.splice(PbxObject.available.indexOf(n),1);for(var c=document.getElementById("select2-available-users-container"),l=([].slice.call(s.options),0);l<s.options.length;l++)s.options[l].value===n&&(s.removeChild(s.options[l]),c&&(s.options.length?c.textContent=s.options[0].value:c.textContent=""));if(!s.options.length){var d=document.getElementById("add-user");d.setAttribute("disabled","disabled")}$("#new-user-form").trigger("users.create"),t&&t()}else notify_about("error",o&&o.message)})}}function refreshUsersTable(e){var t=document.getElementById("available-users");json_rpc_async("getObject",{oid:PbxObject.oid},function(n){PbxObject.available=n.available.sort(),makeElement(sortByKey(n.members,"number"),document.getElementById("group-extensions").querySelector("tbody"),addMembersRow,!0),makeElement(PbxObject.available.sort(),t,function(e){var t=document.createElement("option");return t.value=e,t.textContent=e,t},!0),$(t).trigger("change"),remove_loading_panel(),e&&e(PbxObject.available)})}function cleanForm(e){var t=document.getElementById(e);t.reset()}function checkHuntMode(e){var t;t=e?e.target:document.getElementById("huntmode1"),0==t.selectedIndex?document.getElementById("huntmodesetts").classList.add("hidden"):document.getElementById("huntmodesetts").classList.remove("hidden")}function createExtLogin(e){return PbxObject.options.prefix?PbxObject.options.prefix+e:e}function load_billing(){function e(){ReactDOM.render(BillingComponent({options:PbxObject.options,profile:r,sub:i,frases:PbxObject.frases,invoices:s,addCard:t,editCard:n,extend:deepExtend}),a)}function t(e){PbxObject.stripeHandler.open({email:r.email,name:"Ringotel",zipCode:!0,locale:"auto",allowRememberMe:!1,panelLabel:"Add card",amount:null,closed:function(t){if(console.log("addCard closed: ",t),!PbxObject.stripeToken)return e(null);var n={service:"stripe",token:PbxObject.stripeToken.id,card:PbxObject.stripeToken.card};BillingApi.addCard(n,function(t,n){console.log("saveCard response: ",t,PbxObject.stripeToken,n),t||n.error?(notify_about("error",t.message||n.error.message),e(null)):(e(PbxObject.stripeToken),set_object_success()),PbxObject.stripeToken=null})}})}function n(e){PbxObject.stripeHandler.open({email:r.email,name:"Ringotel",zipCode:!0,locale:"auto",allowRememberMe:!1,panelLabel:"Add card",closed:function(t){if(console.log("editCard closed: ",t),!PbxObject.stripeToken)return e(null);var n={service:"stripe",token:PbxObject.stripeToken.id,card:PbxObject.stripeToken.card};BillingApi.updateCard(n,function(t,n){console.log("updateCard response: ",t,PbxObject.stripeToken,n),t||n.error?(notify_about("error",t.message||n.error.message),e(null)):(e(PbxObject.stripeToken),set_object_success()),PbxObject.stripeToken=null})}})}function o(e){BillingApi.getInvoices(function(t,n){return console.log("getInvoices response: ",t,n),t?e(t):void(e&&e(null,n.result||[]))})}var a=document.getElementById("el-loaded-content"),r=PbxObject.profile,i={},s=[];BillingApi.getSubscription(function(t,n){return console.log("getSubscription response: ",t,n.result),t?notify_about("error",t.message):(i=n.result,e(),show_content(),void o(function(t,n){return t?notify_about("error",t.message):(s=n.filter(function(e){return e.paidAmount&&parseFloat(e.paidAmount)>0}),console.log("invoices: ",s),void e())}))})}function load_branch_options(){function e(){json_rpc_async("getPbxOptions",null,function(e){r=e,i=r.lang,c=1===e.mode||!e.prefix,c?json_rpc_async("getDeviceSettings",null,function(e){s=e,a(),close_options()}):(a(),close_options())})}function t(e,t){var n,o=[];e.options&&e.options.files&&(o=[].concat(e.options.files),delete e.options.files),console.log("saveOptions: ",r,e,o),o.length&&o.forEach(function(e){uploadFile(e)}),n=e.lang&&e.lang!==i?set_options_success_with_reload:set_object_success,json_rpc_async("setPbxOptions",e,function(o){r=deepExtend(r,e),PbxObject.options=r,console.log("setPbxOptions success: ",e,r),e.adminpass?window.localStorage.ringo_tid&&!c?BillingApi.changePassword({login:e.adminname,password:e.adminpass},function(e,o){e||(n(),t&&t())}):(n(),t&&t()):n(),window.localStorage.ringo_tid&&!c&&e.email&&BillingApi.changeAdminEmail({email:e.email},function(e,t){e&&notify_about("error",e)})})}function n(e,t){show_loading_panel(),json_rpc_async("createAPIKey",e,function(e){show_content(),t(e)})}function o(e){console.log("saveBranchOptions: ",e),json_rpc_async("setDeviceSettings",e,null)}function a(){var e={frases:PbxObject.frases,singleBranch:c,params:r,branchParams:s,saveOptions:t,generateApiKey:n,saveBranchOptions:o};console.log("render: ",e),ReactDOM.render(OptionsComponent(e),document.getElementById("el-loaded-content")),show_content()}var r={},i=null,s=null,c=!1;e()}function load_certificates(){PbxObject.options.mode&&0!==PbxObject.options.mode?$("#createCertBtn").click(createCert):$("#createCertBtn").remove(),$("#importCertBtn").click(importCert),getCertificates(),set_page()}function getCertificates(){json_rpc_async("getCertificates",null,function(e){fillCertTable(e)})}function fillCertTable(e){if(e){var t=document.querySelector("#certificates tbody");e.forEach(function(e){t.appendChild(createCertRow(e))}),close_options(),show_content()}}function createCertRow(e){var t,n,o,a=document.createElement("tr");return t=a.insertCell(0),n=document.createElement("a"),n.href="#",n.innerHTML=e,addEvent(n,"click",function(t){downloadCert(t,e)}),t.appendChild(n),t=a.insertCell(1),o=document.createElement("button"),o.className="btn btn-default btn-sm",o.innerHTML='<i class="fa fa-eye"></i>',addEvent(o,"click",function(){showCert(e)}),t.appendChild(o),t=a.insertCell(2),o=document.createElement("button"),o.className="btn btn-danger btn-sm",o.innerHTML='<i class="fa fa-remove"></i>',addEvent(o,"click",function(){removeCert(e)}),t.appendChild(o),a.setAttribute("data-cert",e),a}function downloadCert(e,t){var n=e.target;n.getAttribute("download")||(e.preventDefault(),json_rpc_async("getCertificate",{alias:t},function(e){n.setAttribute("download","certificate.pem"),n.href="data:text/plain;charset=utf-8,"+e,n.click()}))}function createCert(){openModal({tempName:"create_cert",modalId:"createCertModal"},function(){$("#createCert").click(function(){addNewCert()})})}function addNewCert(){var e=document.getElementById("newCertForm"),t=retrieveFormData(e);t&&0!==Object.keys(t).length&&(t.V=parseInt(t.V),json_rpc_async("createCertificate",t,function(e){e&&(notify_about("success",PbxObject.frases.SAVED),fillCertTable([t.CN]),$("#createCertModal").modal("hide"))}))}function importCert(){openModal({tempName:"import_cert",modalId:"importCertModal",data:{certonly:0===PbxObject.options.mode}},function(){$("#importCert").click(function(){importNewCert()})})}function importNewCert(){var e=document.getElementById("importCertForm"),t=retrieveFormData(e);console.log("certInfo: ",t),t&&0!==Object.keys(t).length&&json_rpc_async("setCertificate",t,function(e){if("OK"===e){notify_about("success",PbxObject.frases.SAVED),$("#importCertModal").modal("hide");var t=document.querySelector("#certificates tbody");clearTable(t),getCertificates()}})}function showCert(e){json_rpc_async("getCertificate",{alias:e},function(t){openModal({tempName:"show_cert",modalId:"showCertModal",data:{name:e,certificate:t}})})}function removeCert(e){json_rpc_async("removeCertificate",{alias:e},function(t){notify_about("success",PbxObject.frases.SAVED);var n=document.querySelector('#certificates tbody tr[data-cert="'+e+'"]');n.parentNode.removeChild(n)})}function load_channel_records(){ChannelRecords(),show_content()}function ChannelRecords(){function e(e){var t={oid:window.location.hash.substr(window.location.hash.indexOf("?")+1),begin:e.begin,end:e.end},n={};json_rpc_async("getChannelRecords",t,function(e){n.records=e,json_rpc_async("getChannelEvents",t,function(e){n.events=e,$(document).trigger("channelRecords:data",[n])})})}function t(e){json_rpc_async("getChannelState",{oid:window.location.hash.substr(window.location.hash.indexOf("?")+1),time:e},function(t){console.log("getChannelState: ",e,t),$(document).trigger("channelRecords:state",[t])})}function n(e,t){console.log("onNewData: ",t),T.innerText=t.records.length,A.innerText=t.events.length,combined=k(t.records,t.events),console.log("combined: ",combined),combined.length&&(clearTable(D),lastEvents=[],i(t.events,D),y(combined))}function o(e,t){console.log("onNewEvent: ",t),lastEvents.indexOf(t.channelEvent.timecode)===-1&&(lastEvents.push(t.channelEvent.timecode),i([t.channelEvent],R),l(t.channelEvent))}function a(e,t){[].forEach.call(D.children,function(e){parseInt(e.getAttribute("data-event"),10)===t.channelEvent.timecode?e.classList.add("list-group-item-success"):e.classList.remove("list-group-item-success")})}function r(e,t){console.log("onChannelState: ",t),clearTable(R),clearTable(q),onlineElements={},lastEvents=[],i(t,R),t.forEach(l)}function i(e,t){console.log("addEventsTo: ",e);var n=document.createDocumentFragment();e.forEach(function(e){n.insertBefore(s(e),n.firstChild)}),t.insertBefore(n,t.firstChild)}function s(e,t){var n=document.createElement("li");return icon=document.createElement("i"),user=document.createElement("span"),evt=document.createElement("span"),time=document.createElement("span"),n.className="list-group-item",n.setAttribute("data-event",e.timecode),icon.className="fa fa-fw fa-"+C(e.event),user.innerText=e.user+" ",evt.innerText=PbxObject.frases.CHANNEL_EVENTS[e.event.toString()],time.innerText=moment(e.timecode).format("DD/MM/YY HH:mm:ss"),time.className="pull-right",n.appendChild(icon),n.appendChild(user),n.appendChild(evt),n.appendChild(time),n}function c(e,t){var n=document.createElement("li");return user=document.createElement("span"),n.className="list-group-item",n.setAttribute("data-event",e.timecode),user.innerText=e.user+" ",n.appendChild(user),n}function l(e){console.log(e);var t;onlineElements[e.user]||(t=c(e),q.appendChild(t),onlineElements[e.user]=t),t=$(onlineElements[e.user]),25===e.event?t.show():26===e.event?t.hide():27===e.event?(t.remove(),$(q).prepend(t),t.addClass("list-group-item-success")):28===e.event?t.removeClass("list-group-item-success"):29===e.event?t.addClass("list-group-item-danger"):30===e.event&&t.removeClass("list-group-item-danger")}function d(e,n){console.log("onPlaying: ",n,w.audio.currentTime),0!==n.trackIndex||w.audio.currentTime||t(Math.floor(n.track.timecode+n.currentTime)),U.innerText=n.track.file,z.innerText=n.trackIndex+1,G.innerHTML='<i class="fa fa-fw fa-pause"></i>'}function u(){console.log("onPause"),G.innerHTML='<i class="fa fa-fw fa-play"></i>'}function m(e,n){console.log("onSeeked: ",n),t(Math.floor(n.track.timecode+(n.currentTime||0)))}function p(e){var t=(w.duration*((e.offsetX||e.layerX)/K.clientWidth)).toFixed(2);console.log("seek click: ",t),O(t)}function b(e,t){console.log("onInit: ",t);var n=t.playlist[t.playlist.length-1],o=n.timecode+1e3*n.duration;console.log("onInit: ",n,o),F.textContent=moment(o).format("DD/MM/YY HH:mm:ss")}function f(e,t){N.href=t.src,N.setAttribute("download",t.src)}function g(e){var t,n=e.target;"span"===n.nodeName&&(n=n.parentNode),t=n.getAttribute("data-event"),console.log(t),j(t)}function h(e){var t=e||window.event,n=t.target;"I"===n.nodeName&&(n=n.parentNode),"cpl-play"===n.id&&w.play(),"cpl-stop"===n.id&&w.stop(),"cpl-prev"===n.id&&w.prev(),"cpl-next"===n.id&&w.next()}function v(){$(document).on("player:init",b),$(document).on("player:seeked",m),$(document).on("player:timeupdate",x),$(document).on("player:timeupdate",E),$(document).on("player:playing",d),$(document).on("player:pause",u),$(document).on("player:next",m),$(document).on("player:prev",m),$(document).on("player:ended",_),$(document).on("player:trackchange",f),$(document).on("channelRecords:data",n),$(document).on("channelRecords:event",o),$(document).on("channelRecords:event",a),$(document).on("channelRecords:state",r),$(document).on("channelRecords:viewchange",P),addEvent(J,"click",h),addEvent(K,"click",p),addEvent(Y,"click",function(t){e({begin:moment(B.value).valueOf(),end:moment(S.value).valueOf()})}),addEvent(V,"change",function(e){$(document).trigger("channelRecords:viewchange",[{online:this.checked}])}),addEvent(D,"click",g),addEvent(R,"click",g)}function y(e){w.playlist=e,w.duration=(e[e.length-1].timecode+1e3*e[e.length-1].duration-e[0].timecode)/1e3,w.init().playTrack()}function x(e,t){var n=0===t.currentTime?0:Math.floor(100/t.duration*t.currentTime);K.value=n}function E(e,t){var n=t.track.timecode,o=n+1e3*w.audio.currentTime;I(combined[t.trackIndex].events,o),H.textContent=moment(o).format("DD/MM/YY HH:mm:ss")}function O(e){var t=combined[0].timecode+1e3*e;combined.forEach(function(e,n,o){t>=e.timecode&&t<e.timecode+1e3*e.duration&&(console.log("playByCurrentTime: ",t,e),w.playTrack(n,(t-e.timecode)/1e3))})}function j(e){combined.forEach(function(t,n,o){e>=t.timecode&&e<o[n+1].timecode&&(console.log("playByTimecde: ",e,n,t),w.playTrack(n,(e-t.timecode)/1e3))})}function _(e,t){w.playTrack(w.trackIndex+1)}function P(e,t){t.online?(M.classList.add("hidden"),L.classList.remove("hidden")):(M.classList.remove("hidden"),L.classList.add("hidden"))}function C(e){var t="";switch(e){case 25:t="rss";break;case 26:t="sign-out";break;case 27:t="microphone";break;case 28:t="microphone-slash";break;case 29:t="close";break;case 30:t="check"}return t}function I(e,t){var n=Math.floor(t/1e3);e.forEach(function(e){n===Math.floor(e.timecode/1e3)&&$(document).trigger("channelRecords:event",[{channelEvent:e,timeSeconds:n}])})}function k(e,t){function n(e){var n=e.timecode+1e3*e.duration;e.events=[];for(var o=a;o<t.length;o++){if(!(t[o].timecode<=n)){a=o;break}e.events.push(t[o])}return e}for(var o=[],a=0,r=0;r<e.length;r++)o.push(n(e[r]));return o}PbxObject.ChannelPlayer=PbxObject.ChannelPlayer||new ChannelPlayer({audio:document.getElementById("channel-audiorec")});var w=PbxObject.ChannelPlayer,B=document.getElementById("date-from"),S=document.getElementById("date-to"),T=document.getElementById("cpl-recs"),A=document.getElementById("cpl-events"),N=document.getElementById("cpl-download"),L=document.getElementById("online-events-cont"),M=document.getElementById("offline-events-cont"),D=document.getElementById("range-events"),R=document.getElementById("channel-events"),q=document.getElementById("online-events"),H=(document.getElementById("channel-state"),document.getElementById("cpl-time")),F=document.getElementById("cpl-duration"),U=document.getElementById("cpl-currentFile"),z=document.getElementById("cpl-currentTrack"),G=document.getElementById("cpl-play"),K=document.getElementById("cpl-seek"),J=document.getElementById("cpl-controls"),Y=document.getElementById("cpl-submit-btn"),V=document.getElementById("events-view");combined=[],begin=moment().subtract(30,"minutes"),end=moment(),lastEvents=[],onlineElements={},$("#channel-player-cont").affix({offset:{top:200}}),rome(B,{initialValue:begin}),rome(S,{initialValue:end}),v(),e({begin:begin.valueOf(),end:end.valueOf()})}function load_channel_statistics(){function e(e){console.log("load_chats_report params: ",e);var t={frases:PbxObject.frases};ReactDOM.render(AnalyticsComponent(t),document.getElementById("el-loaded-content"))}e(),set_page()}function ChannelPlayer(e){"use strict";if(!e.audio)throw"audio is undefined";return this.audio=e.audio,this.path=window.location.protocol+"//"+window.location.host+"/records/"||e.path,this.playlist=e.playlist||[],this.trackIndex=0,this.initEvents()}function load_channels(e){for(var t,n=document.getElementById("channels").getElementsByTagName("tbody")[0],o=document.createDocumentFragment(),a=[],r=0;r<e.length;r++)"channel"===e[r].kind&&(t=createChannelRow(e[r]),o.appendChild(t),a.push(e[r]));n.appendChild(o),PbxObject.channels=a,add_search_handler(),show_content(),addEvent(n,"click",tableClickHandler)}function tableClickHandler(e){var t,e=e||window.event,n=e.target;"BUTTON"!==n.nodeName&&(n=n.parentNode),t=n.className,t.indexOf("showPartiesBtn")!=-1?showParties(n):t.indexOf("deleteObjBtn")!=-1&&delete_extension(e)}function createChannelRow(e){var t,n,o=document.createElement("tr"),a=getInfoFromState(e.state,e.group),r=a.rstatus,i=a.rclass;return t=o.insertCell(0),e.oid?(n=document.createElement("a"),n.href="#"+e.kind+"?"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,t=o.insertCell(1),t.setAttribute("data-cell","name"),t.textContent=e.name||"",t=o.insertCell(2),t.setAttribute("data-cell","status"),t.textContent=r||"",t=o.insertCell(3),t.setAttribute("data-cell","parties"),e.parties&&(t.textContent=e.parties.length||""),t=o.insertCell(4),button=createNewButton({type:"popover",classname:"btn btn-primary btn-sm showPartiesBtn",placement:"left",dataTrigger:"focus",content:'<i class="fa fa-user"></i>'}),t.appendChild(button),e.parties||(button.disabled="disabled"),t=o.insertCell(5),t.innerHTML='<a type="button" class="btn btn-primary btn-sm" href="#channel_records?'+e.oid+'"><i class="fa fa-history"></i></a>',t=o.insertCell(6),e.oid&&(button=createNewButton({title:PbxObject.frases.DELETE,classname:"btn btn-danger btn-sm deleteObjBtn",content:'<i class="fa fa-trash"></i>'}),t.appendChild(button)),o.id=e.oid,o.setAttribute("data-ext",e.ext),o.className=i,o}function showParties(e){var t,n,o=getClosest(e,"tr"),a=PbxObject.channels,r="";a.forEach(function(e){e.oid===o.id&&(n=e.parties,n&&(t=n.length,n.sort(),n.forEach(function(e,n){r+=e,n!=t-1&&(r+=", ")})))}),e.setAttribute("data-content",r),$(e).popover("toggle")}function load_chatchannel(e){function t(){var e=PbxObject.frases.CHAT_CHANNEL.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){d=document.getElementById("available-users-cont"),d&&d.parentNode.removeChild(d),d=document.createElement("div"),d.id="available-users-cont",document.body.appendChild(d),getExtensions(function(e){ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,onSubmit:r,availableList:e.filter(function(e){return"user"===e.kind}),excludeList:u.members,groupid:PbxObject.name?PbxObject.oid:null}),d)})}function r(e){u.members=u.members.concat(e),PbxObject.name?s(u,function(e){l(u)}):l(u),$("#available-users-modal").modal("hide")}function i(e){var t=e.oid;u.members=u.members.filter(function(e){return e.oid!==t}),PbxObject.name?s(u,function(e){l(u)}):l(u)}function s(e,t){PbxObject.name&&(m=set_object_success);var n=e.name||p;json_rpc_async("setObject",{kind:PbxObject.kind,oid:e.oid,name:n,enabled:e.enabled,members:e.members.length?e.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(e){PbxObject.name=u.name=n,m&&m(),t&&t(e)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function l(e){var t={frases:PbxObject.frases,params:e,onAddMembers:a,setObject:s,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(ChatchannelComponent(t),document.getElementById("el-loaded-content"))}var d,u=e,m=null,p=t();e.name||(e.enabled=!0),PbxObject.oid=e.oid,PbxObject.name=e.name,l(u),show_content(),set_page()}function load_chattrunk(e){function t(e,t){PbxObject.name&&setObjectState(PbxObject.oid,e,function(e,n){t&&t(n,e)})}function n(e,t){show_loading_panel(),e.directref=!0,json_rpc_async("setObject",e,function(t,n){return n?notify_about("error",n.message):(PbxObject.name?set_object_success():(PbxObject.name=e.name,e.oid&&o(e,function(e){e.pageid&&c(e.type,e)})),c(e.type,e),void remove_loading_panel())})}function o(e,t){json_rpc_async("getObject",{oid:e.oid},t)}function a(e,t){var n=document.getElementById("modal-cont"),o={frases:PbxObject.frases,name:PbxObject.name,warning:"Telephony"===e?PbxObject.frases.CHAT_TRUNK.DID.DELETE_SIP_CHANNEL_MSG:PbxObject.frases.CHAT_TRUNK.DID.DELETE_OTHER_CHANNEL_MSG,onSubmit:t};n||(n=document.createElement("div"),n.id="modal-cont",document.body.appendChild(n)),ReactDOM.render(DeleteObjectModalComponent(o),n)}function r(e,t){PbxObject.stripeHandler.open({panelLabel:"Pay",allowRememberMe:!1,amount:100*e.chargeAmount,closed:function(n){if(PbxObject.stripeToken){var o={currency:e.currency,amount:e.chargeAmount,description:"Update balance",token:PbxObject.stripeToken.id};show_loading_panel(),BillingApi.updateBalance(o,function(n,o){remove_loading_panel(),n?notify_about("error",n.message):(t&&t(e),PbxObject.stripeToken=null)})}}})}function i(e,t){showModal("confirm_payment_modal",{frases:PbxObject.frases,payment:e},function(n,o){$(o).modal("toggle"),t(e)})}function s(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid,!0)}function c(e,o){var c={type:e,services:m,frases:PbxObject.frases,params:o,selected:l.channel,getObjects:getObjects,onStateChange:t,setObject:n,updateBalance:r,confirmRemoveObject:a,removeObject:s,confirmPayment:i};ReactDOM.render(ChatTrunkComponent(c),document.getElementById("el-loaded-content")),show_content()}var l=getQueryParams(),d=PbxObject.frases,u=e.type||"Telephony",m=[{id:"Telephony",name:d.CHAT_TRUNK.DID.SERVICE_NAME,icon:"/badmin/images/channels/did.png",component:DidTrunkComponent},{id:"FacebookMessenger",name:d.CHAT_TRUNK.FACEBOOK.SERVICE_NAME,icon:"/badmin/images/channels/facebook.png",params:{appId:"1920629758202993",redirectUri:"https://main.ringotel.net/chatbot/FacebookMessenger"},component:FacebookTrunkComponent},{id:"Email",name:d.CHAT_TRUNK.EMAIL.SERVICE_NAME,icon:"/badmin/images/channels/email.png",providers:{gmail:{protocol:"imap",hostname:"imap.gmail.com",port:993,usessl:!0},outlook:{protocol:"imap",hostname:"imap-mail.outlook.com",port:993,usessl:!0},office365:{protocol:"imap",hostname:"outlook.office365.com",port:993,usessl:!0},icloud:{protocol:"imap",hostname:"imap.mail.me.com",port:993,usessl:!0},aol:{protocol:"imap",hostname:"imap.aol.com",port:993,usessl:!0},yahoo:{protocol:"imap",hostname:"imap.mail.yahoo.com",port:993,usessl:!0}},component:EmailTrunkComponent},{id:"Viber",name:"Viber",icon:"/badmin/images/channels/viber.ico",component:ViberTrunkComponent},{id:"Telegram",name:"Telegram",icon:"/badmin/images/channels/telegram.png",component:TelegramTrunkComponent},{id:"WebChat",name:d.CHAT_TRUNK.WEBCHAT.SERVICE_NAME,icon:"/badmin/images/channels/webchat.png",component:WebchatTrunkComponent},{id:"Webcall",name:d.CHAT_TRUNK.WEBCALL.SERVICE_NAME,icon:"/badmin/images/channels/webchat.png",component:WebcallTrunkComponent}],p=getQueryParams().access_token||getQueryParams(window.location.hash.substr(window.location.hash.indexOf("?"))).access_token||null;return window.opener&&window.opener.onTokenReceived?window.opener.onTokenReceived(p):(p&&(m=m.map(function(e){return"FacebookMessenger"===e.id&&(e.params.userAccessToken=p),e})),PbxObject.oid=e.oid,PbxObject.name=e.name,e.sessiontimeout=e.sessiontimeout||604800,e.replytimeout=e.replytimeout||3600,set_page(),void c(u,e))}function load_cli(e){PbxObject.oid=e.oid,PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");
e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})}));var o=e.bnumbertransforms;if(o.length)for(var a=0;a<o.length;a++)append_transform(null,"transforms1",o[a]);else append_transform(null,"transforms1");var r=e.numbers;if(r.length)for(a=0;a<r.length;a++)add_cli_row(r[a]);else add_cli_row();show_content(),set_page()}function set_cli(){var e,t=document.getElementById("objname").value;if(!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var n='"name":"'+t+'",';show_loading_panel(),PbxObject.name?e=set_object_success:(PbxObject.name=t,e=null),PbxObject.oid&&(n+='"oid":"'+PbxObject.oid+'",'),n+='"kind":"cligroup",',n+='"enabled":'+document.getElementById("enabled").checked+",",n+='"bnumbertransforms":[',n+=encode_transforms("transforms1"),n+="],",n+='"numbers":[';var o,a=document.getElementById("clinumbers").getElementsByTagName("tbody")[0];for(o=0;o<a.children.length;o++){var r=a.children[o],i="",s=r.getElementsByTagName("input")[0];s&&"number"==s.name&&(i+='"number":"'+s.value+'",');var c=r.getElementsByTagName("textarea")[0];c&&"description"==c.name&&(i+='"description":"'+c.value+'",'),""!=i&&(n+="{"+i+"},")}n+="]",json_rpc_async("setObject",n,e)}function add_cli_row(e){var t=t||window.event;t&&"click"==t.type&&t.preventDefault();var n,o,a,r=document.getElementById("clinumbers").getElementsByTagName("tbody")[0],i=r.rows.length,s=r.insertRow(i);n=s.insertCell(0),o=document.createElement("div"),o.className="form-group",a=document.createElement("input"),a.className="form-control",a.setAttribute("type","text"),a.setAttribute("name","number"),e&&e.number&&(a.value=e.number),o.appendChild(a),n.appendChild(o),n=s.insertCell(1),o=document.createElement("div"),o.className="form-group",a=document.createElement("textarea"),a.className="form-control y-resizable",a.setAttribute("rows","3"),a.setAttribute("name","description"),e&&e.description&&(a.value=e.description),o.appendChild(a),n.appendChild(o),n=s.insertCell(2),o=document.createElement("div"),o.className="form-group",a=document.createElement("a"),a.href="#",a.className="remove-clr",a.innerHTML='<i class="fa fa-close"></i>',addEvent(a,"click",remove_row),o.appendChild(a),n.appendChild(o)}function load_customers(e){function t(e){return e.filter(function(e){return e.state})}function n(){json_rpc_async("getCustomers",null,function(e,t){console.log("getCustomers: ",t,e),p=sortByKey(e||[],"name"),u(p),show_content()})}function o(e){console.log("onDelete: ",e),ReactDOM.render(DeleteObjectModalComponent({frases:m,warning:m.CUSTOMERS.ON_DELETE_WARNING,onSubmit:function(){a(e)}}),g)}function a(e){json_rpc_async("deleteCustomerData",{customerid:e},function(t,n){console.log("deleteCustomerData result: ",n,t),p=p.filter(function(t){return t.id!==e}),notify_about("success",m.CUSTOMERS.ON_DELETED_MSG),u(p)})}function r(e,t){console.log("getPrivacyPrefs: ",e),json_rpc_async("getCustomerConsent",{customerid:e},function(e,n){return console.log("getCustomerConsent: ",e),n?notify_about("error",n):void t(e)})}function i(e){ReactDOM.render(CustomerInfoModalComponent({frases:m,params:e,onDelete:o,getPrivacyPrefs:r}),g)}function s(e){show_loading_panel();var t=e.service_id?"importContacts":"importCustomers";json_rpc_async(t,e,function(t,o){if(console.log("importCustomers error: ",o),o&&o.message){var a=JSON.parse(o.message);401===a.error.code?c({service_id:e.service_id,path:"/services/"+e.service_id+"/Contacts"},function(t,n){return t?void notify_about("error",t.message):s(e)}):notify_about("error",a.error.message)}else showModal("import_result_modal",{contacts:t,contactsCount:t.length},function(e,t){return $(t).modal("hide"),n()})})}function c(e,t){showModal("ldap_auth",{service_id:e.service_id},function(n,o){var a=o.querySelector('button[data-type="submit"]'),r=a.innerHTML;a=$(a),a.prop("disabled",!0),a.html('<i class="fa fa-fw fa-spinner fa-spin"></i>'),l(n,e.path,function(e,n){a.prop("disabled",!1),a.html(r),$(o).modal("hide"),t(null,n)})})}function l(e,t,n){var o={url:t};e&&(o.method="POST",o.data="username="+e.username+"&password="+e.password),console.log("authInService",o),$.ajax(o).then(function(e){if(console.log("authInService: ",e),e){if(e.result.location)return window.sessionStorage.setItem("serviceParams",JSON.stringify(serviceParams)),window.location=e.result.location;n(e.result)}else n()},function(e){var o=null;e.responseJSON.error&&e.responseJSON.error.message&&(o=JSON.parse(e.responseJSON.error.message).error),console.log("authInService error: ",o),o&&o.redirection?(window.sessionStorage.setItem("serviceParams",JSON.stringify(serviceParams)),window.location=o.redirection):o&&401===o.code?n(o):(window.sessionStorage.setItem("serviceParams",JSON.stringify(serviceParams)),window.location=loc.origin+t)})}function d(e){var t={},n=document.getElementById("modal-cont");n&&n.parentNode.removeChild(n),n=document.createElement("div"),n.id="modal-cont",document.body.appendChild(n),t={frases:PbxObject.frases,selectedService:e,onSubmit:s},ReactDOM.render(ImportDataModalComponent(t),n)}function u(e){var t={frases:PbxObject.frases,params:e,"import":d,importServices:f,openCustomerInfo:i};ReactDOM.render(CustomersComponent(t),document.getElementById("el-loaded-content"))}console.log("load_customers: ",PbxObject.kind,e);var m=PbxObject.frases,p=[],b=PbxObject.options.services,f=[{id:"csv",name:".csv"}].concat(t(b)),g=document.getElementById("modal-cont");g||(g=document.createElement("div"),g.id="modal-cont",document.body.appendChild(g)),set_page(),close_options(),n()}function load_dashboard(){function e(e){t(r)}function t(e){ReactDOM.render(DashboardComponent(e),document.getElementById("el-loaded-content")),show_content(),set_page()}function n(e,t,n){json_rpc_async(e,t,n)}function o(e){BillingApi.getSubscription(e)}function a(e){BillingApi.getCredits(e)}var r={frases:PbxObject.frases,options:PbxObject.options,profile:PbxObject.profile,fetchData:n,fetchSubscription:o,fetchCallingCredits:a};e()}function EventEmitter(){function e(e,t){o.call(n,e)||(n[e]=[]);var a=n[e].push(t)-1;return{off:function(){delete n[e][a]}}}function t(e,t){o.call(n,e)&&n[e].forEach(function(e){e(void 0!==t?t:{})})}var n={},o=n.hasOwnProperty;return{on:e,emit:t}}function load_extensions(e){function t(e){var t={frases:PbxObject.frases,data:e,getExtension:getExtension,deleteExtension:deleteExtension};ReactDOM.render(ExtensionsComponent(t),document.getElementById("el-loaded-content"))}var n=filterObject(e,["user","phone"]);t(n),set_page(),show_content()}function getExtensions(e,t){var n=null;json_rpc_async("getExtensions",null,function(o){"function"!=typeof e?(n=t)(filterObject(o,e)):(n=e)(o)})}function createExtRow(e){var t,n,o=document.createElement("tr"),a=getInfoFromState(e.state,e.group),r=a.rstatus;a.rclass;return t=o.insertCell(0),e.oid&&e.kind?(n=document.createElement("a"),"user"==e.kind||"phone"==e.kind?(n.href="#",addEvent(n,"click",get_extension)):n.href="#"+e.kind+"/"+e.oid,n.textContent=e.ext,t.appendChild(n)):t.textContent=e.ext,t=o.insertCell(1),t.setAttribute("data-cell","name"),t.textContent=e.name||"",t=o.insertCell(2),t.setAttribute("data-cell","group"),t.textContent=e.group||"",t=o.insertCell(3),t.textContent=e.reg||"",t.setAttribute("data-cell","reg"),t.className="nowrap",t.title=e.reg||"",t=o.insertCell(4),t.setAttribute("data-cell","kind"),t.textContent=PbxObject.frases.KINDS[e.kind]||"",t=o.insertCell(5),t.setAttribute("data-cell","status"),t.innerHTML='<span class="label label-'+a.className+'">'+(r||"")+"</span>",t=o.insertCell(6),e.oid&&(button=createNewButton({type:"tooltip",title:PbxObject.frases.DELETE,classname:"btn btn-link btn-danger btn-md",content:'<i class="fa fa-trash"></i>',handler:delete_extension}),t.appendChild(button)),o.id=e.oid,o.setAttribute("data-ext",e.ext),o.setAttribute("data-kind",e.kind),o}function updateExtensionRow(e,t){var n=document.getElementById(t.oid),o=t.state,a=getInfoFromState(o,t.group);if(n){var r,i=(n.cells,a.rstatus);a.rclass;t.name&&(r=n.querySelector('[data-cell="name"]'),r&&(r.innerHTML=t.name)),t.hasOwnProperty("group")&&(r=n.querySelector('[data-cell="group"]'),r&&(r.innerHTML=t.group)),t.hasOwnProperty("reg")&&(r=n.querySelector('[data-cell="reg"]'),r&&(r.innerHTML=t.reg)),r=n.querySelector('[data-cell="status"]'),r&&(r.innerHTML='<span class="label label-'+a.className+'">'+i+"</span>")}updateObjects(PbxObject.extensions,t,"ext")}function getExtension(e){show_loading_panel(),PbxObject.templates.extension?json_rpc_async("getObject",{oid:e},load_extension):$.get("/badmin/views/extension.html",function(t){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.extension=t,json_rpc_async("getObject",{oid:e},load_extension)})}function get_extension(e){var e=e||window.event;"click"==e.type&&e.preventDefault();var t=getClosest(e.target,"tr").id;t&&(show_loading_panel(),PbxObject.templates.extension?json_rpc_async("getObject",'"oid":"'+t+'"',load_extension):$.get("/badmin/views/extension.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.extension=e,json_rpc_async("getObject",'"oid":"'+t+'"',load_extension)}))}function editExtension(e){var t,n,o,a=getClosest(e.target,"tr"),r=a.parentNode,i=document.createElement("tr"),s=a.cells,c=s[1].textContent,l=s[2].textContent,d=s[3].textContent,u=a.getAttribute("data-kind"),m=s[5].textContent;if(i.setAttribute("data-oid",a.id),t=i.insertCell(0),t.innerHTML=s[0].innerHTML,t=i.insertCell(1),t.innerHTML='<input class="form-control extname" value="'+c+'">',t=i.insertCell(2),"user"===u||"phone"===u){var p="user"===u?"users":"unit";n=document.createElement("select"),n.className="form-control extgroup",t.appendChild(n),fill_group_choice(p,l,n)}else t.textContent=l;t=i.insertCell(3),"phone"==u||d.indexOf(".")!=-1?t.textContent=d:t.innerHTML='<input class="form-control extreg" value="'+d+'">',t=i.insertCell(4),t.textContent=s[4].textContent,t=i.insertCell(5),t.textContent=m,t=i.insertCell(6),o=createNewButton({type:"tooltip",title:PbxObject.frases.CANCEL,classname:"btn btn-link btn-default btn-md",content:'<i class="fa fa-chevron-left"></i>',handler:function(){a.style.display="table-row",r.removeChild(i)}}),t.appendChild(o),t=i.insertCell(7),o=createNewButton({type:"tooltip",title:PbxObject.frases.SAVE,classname:"btn btn-link btn-success btn-md",content:'<i class="fa fa-check"></i>',handler:set_extension_update}),t.appendChild(o),r.insertBefore(i,a),a.style.display="none"}function set_extension_update(e){var t=getClosest(e.target,"tr"),n=t.getAttribute("data-oid"),o=document.getElementById(n),a=t.querySelector(".extname").value,r=t.querySelector(".extgroup"),i=r.options[r.selectedIndex].value,s=t.querySelector(".extreg"),c='"oid":"'+n+'",';a&&(c+='"name":"'+a+'",'),i&&(c+='"groupid":"'+i+'",'),s&&s.value&&(c+='"followme":"'+s.value+'",'),json_rpc_async("setObject",c,function(){t.parentNode.removeChild(t),o.style.display="table-row"})}function load_extension(e){PbxObject.extOid=e.oid,PbxObject.userid=e.userid,PbxObject.vars=PbxObject.vars||{},PbxObject.vars.infoShown=!1;var t,n=document,o=document.getElementById("ext-cont"),a=e.groupid,r="user"==e.kind?"users":"unit";"users"===r&&(e.storelimit=e.storelimit?convertBytes(e.storelimit,"Byte","GB").toFixed(2):0,e.storesize=e.storesize?convertBytes(e.storesize,"Byte","GB").toFixed(2):0,e.storefree=e.storelimit-e.storesize),1!==getInstanceMode()&&(e.domain=window.location.hostname),t=Mustache.render(PbxObject.templates.extension,{data:e,frases:PbxObject.frases}),o||(o=document.createElement("div"),o.id="ext-cont",$("#pagecontainer").prepend(o)),$(o).html(t);var i=document.querySelector(".user-connected-services"),s=document.getElementById("ext-storelimit-cont"),c=document.querySelector("#el-extension .user-state-ind"),l=document.getElementById("user-avatar"),d="/$AVATAR$?userid="+e.userid;if(l.onerror=function(){this.src="images/avatar.png"},l.src=d,c.classList.add(getInfoFromState(e.state).rclass),"users"!==r){var u=document.querySelector("#el-extension .user-storage-usage");u&&u.classList.add("hidden"),s&&s.classList.add("hidden")}else{var m=document.getElementById("pin-cont");m&&m.classList.add("hidden"),s.style.display="block"}switch_presentation(r,document.getElementById("ext-features")),a?fill_group_choice(r,a):document.getElementById("extgroup-cont").classList.add("hidden");var p=n.getElementById("ext-fwdnreg"),b=n.getElementById("ext-fwdnregnumber");p.checked=e.features.fwdnreg,b.value=e.features.fwdnregnumber;var f=document.getElementById("ext-tabs");e.features&&(void 0==e.features.fwdall&&(f.querySelector('li a[href="#ext-forwarding"]').parentNode.className="hidden"),void 0==e.features.recording&&n.getElementById("ext-recording").setAttribute("disabled",""),void 0==e.features.callwaiting&&n.getElementById("ext-callwaiting").setAttribute("disabled",""),void 0==e.features.pickupdeny&&n.getElementById("ext-pickupdeny").setAttribute("disabled",""),void 0==e.features.monitordeny&&n.getElementById("ext-monitordeny").setAttribute("disabled",""),void 0==e.features.busyoverdeny&&n.getElementById("ext-busyoverdeny").setAttribute("disabled",""),void 0==e.features.voicemail&&n.getElementById("ext-voicemail").setAttribute("disabled",""),void 0==e.features.lock&&n.getElementById("ext-plock").setAttribute("disabled","")),n.getElementById("el-set-extension").onclick=function(){set_extension(r)},n.getElementById("showUserInfo").onclick=function(t){t&&t.preventDefault(),getUserInfo(e.userid)},e.services&&e.services.forEach(function(e){i.insertAdjacentHTML("beforeend",'<img src="/badmin/images/services/'+e+'.png" alt="'+e+'" title="'+PbxObject.frases.CONNECTED_TO+" "+e+'" />')}),show_content(),$('#el-extension [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),$('#el-extension [data-toggle="tooltip"]').tooltip(),$("#el-extension").modal(),$("#el-extension").on("hidden.bs.modal",function(e){$('#el-extension [data-toggle="popover"]').popover("destroy"),PbxObject.vars.infoShown=!1})}function set_extension(e){var t=document,n=PbxObject.extOid,o='"oid":"'+n+'",',a=t.getElementById("extgroup"),r=t.getElementById("extlogin").textContent,i=t.getElementById("extpassword").value,s=t.getElementById("extstorelimit");if(a.options.length)var c=a.options[a.selectedIndex].value;o+=c?'"groupid":"'+c+'",':'"groupid":"'+PbxObject.oid+'",',o+='"name":"'+t.getElementById("extname").value+'",',r&&(o+='"login":"'+r+'",'),i&&(o+='"password":"'+i+'",'),t.getElementById("extpin").value&&(o+='"pin":'+t.getElementById("extpin").value+","),s&&(s=convertBytes(s.value,"GB","Byte").toFixed(),s>=0&&(o+='"storelimit":'+s+",")),o+='"features":{',null!=t.getElementById("ext-fwdall")&&(o+='"fwdall":'+t.getElementById("ext-fwdall").checked+",",o+='"fwdallnumber":"'+t.getElementById("ext-fwdallnumber").value+'",'),null!=t.getElementById("ext-fwdnregnumber")&&(o+='"fwdnreg":'+t.getElementById("ext-fwdnreg").checked+",",o+='"fwdnregnumber":"'+t.getElementById("ext-fwdnregnumber").value+'",'),null!=t.getElementById("ext-fwdbusynumber")&&(o+='"fwdbusy":'+t.getElementById("ext-fwdbusy").checked+",",o+='"fwdbusynumber":"'+t.getElementById("ext-fwdbusynumber").value+'",'),null!=t.getElementById("ext-fwdnansnumber")&&(o+='"fwdnans":'+t.getElementById("ext-fwdnans").checked+",",o+='"fwdnansnumber":"'+t.getElementById("ext-fwdnansnumber").value+'",'),null!=t.getElementById("ext-fwdtimeout")&&t.getElementById("ext-fwdtimeout").value&&(o+='"fwdtimeout":'+t.getElementById("ext-fwdtimeout").value+","),0==t.getElementById("ext-plock").disabled&&(o+='"lock":'+t.getElementById("ext-plock").checked+","),0==t.getElementById("ext-recording").disabled&&(o+='"recording":'+t.getElementById("ext-recording").checked+","),0==t.getElementById("ext-callwaiting").disabled&&(o+='"callwaiting":'+t.getElementById("ext-callwaiting").checked+","),0==t.getElementById("ext-pickupdeny").disabled&&(o+='"pickupdeny":'+t.getElementById("ext-pickupdeny").checked+","),0==t.getElementById("ext-monitordeny").disabled&&(o+='"monitordeny":'+t.getElementById("ext-monitordeny").checked+","),0==t.getElementById("ext-busyoverdeny").disabled&&(o+='"busyoverdeny":'+t.getElementById("ext-busyoverdeny").checked+","),0==t.getElementById("ext-voicemail").disabled&&(o+='"voicemail":'+t.getElementById("ext-voicemail").checked+","),o+="}";var l=document.getElementById("userInfo"),d=retrieveFormData(l);d&&0!==Object.keys(d).length&&(d.userid=PbxObject.userid,json_rpc_async("setUserInfo",d,null)),json_rpc_async("setObject",o,function(){$("#el-extension").modal("hide")}),upload("upload-avatar","/$AVATAR$?userid="+PbxObject.userid)}function loadAvatar(e){var e=e||window.event;e&&e.preventDefault();var t=document.getElementById("upload-avatar");t.click(),t.onchange=function(){previewAvatar(this)}}function previewAvatar(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#user-avatar").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function getAvatar(e,t){var n=new XMLHttpRequest;n.overrideMimeType("text/plain; charset=x-user-defined"),n.open("GET","/$AVATAR$?userid="+e,!0),n.responseType="arraybuffer",n.onload=function(e){if(200==this.status){for(var o="",a=n.mozResponseArrayBuffer||n.response,r=new Uint8Array(a),i=0;i<r.byteLength;i++)o+=String.fromCharCode(r[i]);null!=t&&t(o)}},n.send(null)}function getUserInfo(e){if(PbxObject.vars.infoShown===!0)return void $("#userInfo").collapse("toggle");var t,n,o=document.getElementById("showUserInfo"),a=o.innerHTML;o.innerHTML='<i class="fa fa-lg fa-spinner fa-spin"></i>',getPartial("userinfo",function(r){json_rpc_async("getUserInfo",'"userid":"'+e+'"',function(e){PbxObject.vars.infoShown=!0,n={data:e,frases:PbxObject.frases},n.data.email=n.data.email||n.data.mail,t=Mustache.render(r,n),$("#userInfo").html(t),o.innerHTML=a,$("#userInfo").collapse("toggle")})})}function GetStarted(e){function t(){return!appStorage.get("welcomed")&&(!i.length||i.length<2)}function n(){var e=i.length<2?0:2;ReactDOM.render(GSModalComponent({frases:PbxObject.frases,initialStep:e,profile:PbxObject.profile,options:PbxObject.options,objects:PbxObject.objects,onClose:a,sendLinks:o}),c)}function o(e){}function a(e){PbxObject.tourStarted=!!e}function r(){var e=document.createElement("ul"),t=document.createElement("li"),o=document.querySelector("#pbxmenu"),a=document.querySelector("#pbxmenu .nav-list");e.className="nav-list",e.appendChild(t),o.insertBefore(e,a),ReactDOM.render(InitGSButtonComponent({frases:PbxObject.frases,onClick:n}),t)}var i=[],s=PbxObject.objects,c=document.getElementById("modals-cont");c||(c=document.createElement("div"),c.id="gs-modal-cont",document.body.appendChild(c)),this.init=function(){getExtensions(function(e){i=e,console.log("extensions:",i),console.log("objects:",s),t()&&(n(),appStorage.set("welcomed",!0)),r()})}}function load_guide(){getObjects("chattrunk",function(e){getExtensions(function(t){ReactDOM.render(GuideComponent({frases:PbxObject.frases,options:PbxObject.options,profile:PbxObject.profile,extensions:t,channels:e}),document.getElementById("dcontainer"))})}),show_content()}function load_hunting(e){function t(){var e=PbxObject.frases.HUNTING_GROUP.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){console.log("showAvailableUsers: "),d=document.getElementById("available-users-cont"),d&&d.parentNode.removeChild(d),d=document.createElement("div"),d.id="available-users-cont",document.body.appendChild(d),ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,onSubmit:r,excludeList:u.members,groupid:PbxObject.name?PbxObject.oid:null}),d)}function r(e){u.members=u.members.concat(e),console.log("addMembers: ",e,u),PbxObject.name?s(u,function(e){l(u)}):l(u),$("#available-users-modal").modal("hide")}function i(e){var t=e.oid;console.log("deleteMember: ",t),u.members=u.members.filter(function(e){return e.oid!==t}),PbxObject.name?s(u,function(e){l(u)}):l(u)}function s(t,n){PbxObject.name&&(m=set_object_success);var o=t.name||p;console.log("setObject: ",t),json_rpc_async("setObject",{kind:PbxObject.kind,oid:t.oid,name:o,enabled:t.enabled,options:t.options,members:t.members.length?t.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(a){if(PbxObject.name=u.name=o,t.files&&t.files.length&&(console.log("upload Files: ",t.files),t.files.forEach(function(e){uploadFile(e)})),t.route&&t.route.ext){console.log("set route props: ",t.route);var r={number:t.route.ext,target:{oid:PbxObject.oid,name:PbxObject.name}};e.routes.length&&(r.oid=e.routes[0].id),setObjRoute(r)}m&&m(),n&&n(a)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function l(e){var t={frases:PbxObject.frases,params:e,onAddMembers:a,setObject:s,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(HuntingGroupComponent(t),document.getElementById("el-loaded-content"))}console.log("load_hunting: ",e);var d,u=e,m=null,p=t();u.options.huntmode||(u.options.huntmode=1),PbxObject.oid=e.oid,PbxObject.name=e.name,l(u),show_content(),set_page()}function load_icd(e){function t(){var e=PbxObject.frases.ICD_GROUP.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){console.log("showAvailableUsers: ",u),d=document.getElementById("available-users-cont"),d&&d.parentNode.removeChild(d),d=document.createElement("div"),d.id="available-users-cont",document.body.appendChild(d),ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,onSubmit:r,excludeList:u.members,groupid:PbxObject.name?PbxObject.oid:null}),d)}function r(e){u.members=u.members.concat(e),console.log("addMembers: ",e,u),PbxObject.name?s(u,function(e){l(u)}):l(u),$("#available-users-modal").modal("hide")}function i(e){var t=e.oid;console.log("deleteMember: ",t),u.members=u.members.filter(function(e){return e.oid!==t}),PbxObject.name?s(u,function(e){l(u)}):l(u)}function s(e,t){PbxObject.name&&(m=set_object_success);var n=e.name||p;console.log("setObject: ",e),json_rpc_async("setObject",{kind:PbxObject.kind,oid:e.oid,name:n,enabled:e.enabled,options:e.options,members:e.members.length?e.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]},function(o){PbxObject.name=u.name=n,e.files&&e.files.length&&(console.log("upload Files: ",e.files),e.files.forEach(function(e){uploadFile(e)})),m&&m(),t&&t(o)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function l(e){var t={frases:PbxObject.frases,params:e,onAddMembers:a,setObject:s,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(IcdGroupComponent(t),document.getElementById("el-loaded-content"))}console.log("load_icd: ",e);var d,u=e,m=null,p=t();PbxObject.oid=e.oid,PbxObject.name=e.name,l(u),show_content(),set_page()}function Ldap(e){function t(e,t){console.log("getUsers: ",e),json_rpc_async("getDirectoryUsers",e,function(e){console.log("getDirectoryUsers result: ",e),t&&t(e)})}function n(t,n){var o="",a={url:"/services/"+e.service_id+"/Users"};t&&(a.method="POST",a.data="username="+t.username+"&password="+t.password),console.log("getExternalUsers params",a),$.ajax(a).then(function(e,t,o){return console.log("getExternalUsers response: ",e),e&&"string"==typeof e&&isLoginPage(e)?logout():(window.sessionStorage.removeItem("serviceParams"),e.result.location?(window.sessionStorage.setItem("serviceParams",JSON.stringify(p)),window.location=e.result.location):void(n?n(e.result):s(e.result)))},function(t){console.log("getExternalUsers error: ",t);var n=null;if(window.sessionStorage.removeItem("serviceParams"),t.responseJSON&&t.responseJSON.error&&t.responseJSON.error.message&&(n=JSON.parse(t.responseJSON.error.message).error),console.log("getExternalUsers error: ",n),n&&n.redirection)o=n.redirection;else if(t.statusCode()>=300&&t.statusCode()<400)o=t.getResponseHeader("Location");else{if(n&&401===n.code)return e.external=!0,r();o=m.origin+"/services/"+e.service_id+"/Users"}o&&(window.location=o,window.sessionStorage.setItem("serviceParams",JSON.stringify(p)))})}function o(e,t){console.log("setDirectoryUsers: ",e),json_rpc_async("setDirectoryUsers",e,function(e){console.log("setDirectoryUsers result: ",e),t&&t(e)})}function a(e,t){console.log("setExternalUsers: ",e),json_rpc_async("setExternalUsers",e,function(e,n){return console.log("setExternalUsers result: ",e),n?notify_about("error",n.message||PbxObject.frases.ERROR):void(t&&t(e))})}function r(n){n?t(n,function(e){e&&s(e)}):showModal("ldap_auth",{service_id:e.service_id,domains:e.domains},i)}function i(o,a){console.log("ldapLogin: ",o,a);var r=a.querySelector('button[data-type="submit"]'),i=r.innerHTML;u=a,r=$(r),r.prop("disabled",!0),r.html('<i class="fa fa-fw fa-spinner fa-spin"></i>'),e.auth=o,console.log("ldapAuth options: ",e,o),e.external?n(o,function(e){console.log("getExternalUsers login result: ",e),r.prop("disabled",!1),r.html(i),e&&($(a).modal("hide"),s(e))}):t(o,function(e){console.log("ldapLogin result: ",e),r.prop("disabled",!1),r.html(i),e&&($(a).modal("hide"),s(e))})}function s(t){var n=document.getElementById("modal-cont");n||(n=document.createElement("div"),n.id="modal-cont",document.body.appendChild(n)),ReactDOM.render(ImportUsersListModalComponent({frases:PbxObject.frases,service:p,externalUsers:t,available:e.available,members:e.members,onSubmit:c}),n)}function c(t){console.log("addLdapUsers: ",t),t.deAssociationList&&t.deAssociationList.length?Utils.each(t.deAssociationList,function(e,t){l(t,function(t,n){e()})},function(n){return n?notify_about("error",n.message):void e.onaddusers(t.selectedUsers)}):e.onaddusers(t.selectedUsers)}function l(e,t){json_rpc_async("deleteUserService",e,function(e,n){return console.log("deleteAssociation:",e),n?notify_about("error",n.message):void t()})}function d(){$(u).modal("hide")}var e=e||{},u=null,m=window.location,p={id:e.service_id,type:e.service_type};return console.log("new LDAP: ",e),{options:e,getUsers:t,getExternalUsers:n,setUsers:o,setExternalUsers:a,showUsers:s,auth:r,close:d}}function load_licenses(){function e(){ReactDOM.render(LicensesComponent({options:PbxObject.options,profile:f,sub:g,dids:h,frases:PbxObject.frases,discounts:v,renewSub:t,onPlanSelect:a,updateLicenses:i,addCredits:l,extend:deepExtend,addCoupon:o,countSubAmount:m,currencyNameToSymbol:p,utils:{convertBytes:convertBytes,getProration:u}}),b)}function t(e){show_loading_panel(),BillingApi.renewSubscription({subId:g._id},function(t,n){console.log("renewSubscription response: ",t,n),show_content(),t||n.error?notify_about("error",t.message||n.error.message):(e(t,n),set_object_success())})}function n(e,t){PbxObject.stripeHandler.open({email:f.email,name:"Ringotel",zipCode:!0,locale:"auto",panelLabel:"Pay",allowRememberMe:!1,currency:e.payment.currency,amount:100*e.payment.chargeAmount,closed:function(n){if(console.log("updateBalance closed: ",n,PbxObject.stripeToken),PbxObject.stripeToken){var o={currency:e.payment.currency,amount:e.payment.chargeAmount,description:"Update balance",token:PbxObject.stripeToken.id};BillingApi.updateBalance(o,function(n,o){console.log("updateBalance: ",n,o),n?notify_about("error",n.message):(y[t]&&y[t](e),PbxObject.stripeToken=null)})}}})}function o(t){BillingApi.addCoupon({coupon:t},function(n,o){return console.log("addCoupon response: ",n,t,o),n?notify_about("error",n.message):(v.push(o),set_object_success(),void e())})}function a(e){console.log("changePlan: ",e),s("confirm_payment_modal",e,r)}function r(t,o){show_loading_panel(),BillingApi.changePlan({subId:g._id,planId:t.plan.planId},function(o,a){return console.log("changePlan response: ",o,a),show_content(),o?void("NO_PAYMENT_SOURCE"===o.name?n(t,"changePlan"):notify_about("error",o.message)):(g=a.result,set_object_success(),void e())})}function i(){ReactDOM.render(UpdateLicenseModalComponent({options:PbxObject.options,sub:g,discounts:v,frases:PbxObject.frases,onSubmit:c,countSubAmount:m,currencyNameToSymbol:p,utils:{convertBytes:convertBytes,getProration:u}}),x)}function s(e,t,n){showModal(e,t,function(e,o){$(o).modal("toggle"),n(t)})}function c(t){s("confirm_payment_modal",t,function(t){show_loading_panel(),BillingApi.updateSubscription({subId:g._id,addOns:t.addOns,quantity:t.quantity},function(o,a){return console.log("updateLicenses response: ",o,a),show_content(),o?void("NO_PAYMENT_SOURCE"===o.name?n(t,"updateLicenses"):notify_about("error",o.message)):(g=a.result,set_object_success(),void e())})})}function l(t){s("confirm_add_credits_modal",{frases:PbxObject.frases,payment:t},function(t){show_loading_panel(),BillingApi.addCredits({amount:t.chargeAmount},function(o,a){return remove_loading_panel(),o?void("NO_PAYMENT_SOURCE"===o.name?n({payment:t},"addCredits"):notify_about("error",o.message)):(set_object_success(),void e())})})}function d(e){BillingApi.getDiscounts(function(t,n){return console.log("getDiscounts response: ",t,n),t?e(t):void(e&&e(null,n.result||[]))})}function u(e,t){return BillingApi.getProration(e,t)}function m(e){var t=e.quantity*e.plan.price,n="years"===e.plan.billingPeriodUnit?"annualPrice":"monthlyPrice";return e.addOns&&e.addOns.length&&e.addOns.forEach(function(e){e.quantity&&(t+=e.price*e.quantity)}),e.hasDids&&h.forEach(function(e){t+=e.included?0:parseFloat(e[n])}),t.toFixed(2)}function p(e){var t="";switch(e.toLowerCase()){case"eur":t="€";break;case"usd":t="$";break;default:t="€"}return t}var b=document.getElementById("el-loaded-content"),f=PbxObject.profile,g={},h=[],v=[],y={changePlan:r,updateLicenses:c,addCredits:l},x=document.getElementById("modal-cont");x||(x=document.createElement("div"),x.id="modal-cont",document.body.appendChild(x)),BillingApi.getSubscription(function(t,n){return console.log("getSubscription response: ",t,n.result),t?notify_about("error",t.message):(g=n.result,void BillingApi.getAssignedDids(function(t,n){return t?notify_about("error",t.message):(h=n.result,void d(function(t,n){return t?notify_about("error",t.message):(v=n,e(),void show_content())}))}))})}function initGlobals(e){e.PbxObject={options:{},optionsOpened:!1,systime:"",initInterval:{},websocket:{},websocketTry:0,currentObj:{},protocolOpts:{},frases:{},smallScreen:!1,Dashboard:{},channels:[],members:[],available:[],extensions:[],objects:void 0,groups:{},templates:{},partials:{},name:"",language:"",query:"",kind:"",oid:""}}function init(){var e=setupPage;initGlobals(window),window.clearInterval(PbxObject.initInterval),"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener?document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,!1),e()},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),e())})}function logout(){var e=new XMLHttpRequest;e.open("GET","/logout",!0),e.onload=function(e){console.log("logout: ",e),window.location="/"},e.send(),window.localStorage.removeItem("ringo_tid"),setLastQuery("")}function createWebsocket(){var e="https:"===location.protocol?"wss:":"ws:",t=new WebSocket(e+"//"+window.location.host+"/","json.api.smile-soft.com");t.onopen=function(e){console.log("WebSocket opened: ",e),PbxObject.websocketTry=1},t.onmessage=function(e){handleMessage(e.data)},t.onclose=onWebsocketClose,window.onbeforeunload=function(){t.onclose=function(){},t.close()},PbxObject.websocket=t}function onWebsocketClose(e){console.log("WebSocket closed",e);var t=generateInterval(PbxObject.websocketTry);
setTimeout(function(){PbxObject.websocketTry++,createWebsocket()},t)}function generateInterval(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function loadStripeJs(){return window.StripeCheckout?configureStripe():($.ajaxSetup({cache:!0}),void $.getScript("https://checkout.stripe.com/checkout.js",configureStripe))}function configureStripe(){var e=StripeCheckout.configure({key:"pk_live_6EK33o0HpjJ1JuLUWVWgH1vT",image:"/badmin/images/Ringotel_emblem_new.png",billingAddress:!0,email:PbxObject.profile.email,currency:PbxObject.profile.currency,name:"Ringotel",zipCode:!0,locale:"auto",token:function(e){console.log("stripe token: ",e),PbxObject.stripeToken=e}});window.addEventListener("popstate",function(){e.close()}),PbxObject.stripeHandler=e}function json_rpc(e,t){var n;n=null==t?'{"method":"'+e+'", "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}';var o=new XMLHttpRequest;if(o.open("POST","/",!1),o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),o.send(n),403===o.status)return window.location="/";var a=JSON.parse(o.responseText);return void 0!=a.error?void notify_about("error",a.error.message):a.result}function json_rpc_async(e,t,n,o){var a={},r={},i={},s=null;r=null!==t?"object"==typeof t?'{"method":"'+e+'", "params":'+JSON.stringify(t)+', "id":1}':'{"method":"'+e+'", "params":{'+t+'}, "id":1}':'{"method":"'+e+'", "id":1}',a=new XMLHttpRequest,a.open("POST","/",!0),s=setTimeout(function(){a.abort(),notify_about("info",PbxObject.frases.TIMEOUT),show_content()},3e5),a.onreadystatechange=function(){if(4==a.readyState)if(clearTimeout(s),200!=a.status){if(console.error(e,a.responseText),302===a.status)return window.location=a.getResponseHeader("Location");if(403===a.status)return logout();a.responseText&&(i=JSON.parse(a.responseText)),n?n(null,i.error):notify_about("error",i.error?i.error.message:PbxObject.frases.ERROR),show_content()}else if(null!=a.responseText){if(!a.responseText)return n();try{i=JSON.parse(a.responseText)}catch(t){if(console.log("response in not JSON"),isLoginPage(a.responseText))return logout()}i.error?(n&&n(null,i.error),notify_about("error",i.error?i.error.message:PbxObject.frases.ERROR),show_content()):i.result&&null!==n&&n(i.result)}},a.setRequestHeader("Content-Type","application/json; charset=UTF-8"),a.send(r)}function request(e,t,n,o,a){var r,i,s,c;r=new XMLHttpRequest,r.open(e,t,!0),o&&o.headers&&o.headers.forEach(function(e){r.setRequestHeader(e.name,e.value)}),s=setTimeout(function(){r.abort()},6e4),r.onreadystatechange=function(){if(4==r.readyState){if(clearTimeout(s),i=r.response)try{i=JSON.parse(i)}catch(e){if(console.log("response in not JSON"),isLoginPage(i))return logout()}if(200===r.status)a&&a(null,i);else{if(r.status>=300&&r.status<400)return window.location=r.getResponseHeader("Location");if(403===r.status)return logout();if(r.status>=500){if(a)return a("The service is under maintenance. Please, try again later.")}else a&&a(i?i.error:null)}}},n?(r.setRequestHeader("Content-Type","application/json"),c=JSON.stringify(n),r.send(c)):r.send()}function isLoginPage(e){return e.indexOf("auth-form")!==-1}function getTranslations(e,t){var n=new XMLHttpRequest,o="translations_"+e+".json";n.open("GET","/badmin/translations/"+o,!0),n.onload=function(e){if(403===e.target.status)logout();else if(200===e.target.status){var o=JSON.parse(n.responseText);PbxObject.frases=o,t(null,o)}else t("ERROR_OCCURED")},n.setRequestHeader("Content-Type","application/json; charset=UTF-8"),n.send()}function sendData(e,t,n){var o={};o.method=e,t&&(o.params=t),n&&(o.id=n),o=JSON.stringify(o),PbxObject.websocket.send(o)}function setPageHeight(){$("#pagecontent").css("min-height",function(){return $(window).height()})}function changeOnResize(e){PbxObject.smallScreen!==e&&(e?($("#pagecontent").hasClass("squeezed-right")&&$("#pagecontent").removeClass("squeezed-right"),$("#pbxmenu").hasClass("squeezed-menu")&&$("#pbxmenu").removeClass("squeezed-menu")):$("#pagecontent").hasClass("squeezed-right")||$("#pagecontent").addClass("squeezed-right"),$("#sidebar-toggle").toggleClass("flipped"),PbxObject.smallScreen=e)}function handleMessage(e){var e=JSON.parse(e),t=e.method;if(e.method){var n=e.params;console.log("handleMessage",e.method,n),"stateChanged"==t||"objectUpdated"==t?$(document).trigger("onmessage.object.update",n):"conferenceUpdate"==t?updateConference(e):"objectCreated"==t?$(document).trigger("onmessage.object.add",n):"objectDeleted"==t&&$(document).trigger("onmessage.object.delete",n)}else callbackOnId(e.id,e.result)}function callbackOnId(e,t){5==e?PbxObject.Dashboard.setCurrentCalls(t):6==e?PbxObject.Dashboard.setCurrentState(t):7==e&&setCallStatistics(t)}function subscribeToEvents(){$(document).on("onmessage.object.update",updateExtensionRow),$(document).on("onmessage.object.update",updateMenu),$(document).on("onmessage.object.update",function(e,t){console.log("onmessage.object.update: ",PbxObject.oid,t),PbxObject.oid===t.oid&&objectStateUpdated(t),updateObjectCache(t)}),$(document).on("onmessage.object.add",newObjectAdded),$(document).on("onmessage.object.delete",onObjectDelete)}function getPbxOptions(e){var t=window.sessionStorage.getItem("pbxOptions");t?e(JSON.parse(t)):json_rpc_async("getPbxOptions",null,function(t){PbxObject.options=t,e(t)})}function getInstanceMode(){return PbxObject.options.mode}function setupPage(){var e,t=(window.sessionStorage.getItem("lastURL"),location.hash.substring(1)),n={},o=t.indexOf("?")!==-1?t.substring(t.indexOf("?")+1):null;createWebsocket(),getSystemTime(),getPbxOptions(function(t){e=t.lang||"en",moment.locale(e),getTranslations(e,function(e,t){return e?notify_about("error",e):void(1!==getInstanceMode()?(dataLayer&&dataLayer.push({event:"is_cloud_branch"}),BillingApi.getProfile(function(e,t){e?console.error(e):(n=t.result,loadFSTracking(n),loadStripeJs()),console.log("getProfile: ",e,t),window.sessionStorage.query&&!window.opener&&(window.location.hash=window.sessionStorage.query+(o?o:"")),PbxObject.profile=n,init_page()})):init_page())})})}function loadFSTracking(e){window.FS&&FS.identify(e._id,{displayName:e._id,reviewsWritten_int:14})}function init_page(){window.Events=EventEmitter();var e=$("#main-template").html(),t=Mustache.render(e,PbxObject.frases);$("#pagecontainer").html(t),switchMode(PbxObject.options),document.getElementsByTagName("title")[0].innerHTML="UCC "+PbxObject.frases.PBXADMIN,setPageHeight(),subscribeToEvents(),PbxObject.language=PbxObject.options.lang,PbxObject.smallScreen=isSmallScreen(),$(window).resize(function(){setPageHeight(),changeOnResize(isSmallScreen())}),isSmallScreen()||$("#pagecontent").addClass("squeezed-right"),location.hash.substring(1)||(location.hash="realtime"),get_object(),set_listeners(),$('[data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}}),$(".tab-switcher","#pbxoptions").click(function(e){switch_options_tab($(this).attr("data-tab"))})}function initTour(e){console.log("initTour: ",e,PbxObject.tours[e.kind]);var t=e.kind||"",n=e.tourOptions||{};n.frases=PbxObject.frases,PbxObject.tours[t]&&MyTour(t,PbxObject.tours[t](n)).start()}function set_listeners(){addEvent(window,"hashchange",get_object),$(".sidebar-toggle","#pagecontent").click(toggle_sidebar),$(".options-open","#pagecontent").click(open_options),$(".options-close","#pbxoptions").click(close_options),$("#pbxmenu li a").click(onMenuClick),$("#logout-btn").click(logout)}function onMenuClick(e){var t=this,n=t.href;n&&"#"===n.substring(n.length-1)&&e.preventDefault(),showGroups(t)}function showGroups(e,t){var n,o=e,a=$(o).parent(),r=$(o).attr("data-kind");if(a.hasClass("active"))n=$(o).next("ul"),!t&&n&&(a.removeClass("active"),n.slideUp("normal"));else if(r){var i=document.createElement("ul");i.id="ul-"+r,show_loading_panel(a[0]),getObjects(r,function(e){console.log("showGroups: ",r,e);var t=document.createElement("li");t.className="add-group-object",t.setAttribute("data-oid",r);var s=document.createElement("a");if("application"==r){var c=document.createElement("input");c.type="file",c.id="uploadapp",c.className="upload-custom",c.accept=".application",addEvent(c,"change",function(){upload("uploadapp")}),t.appendChild(c),s.href="#",addEvent(s,"click",function(e){document.getElementById("uploadapp").click(),e&&e.preventDefault})}else s.href="#"+r+"/"+r;s.innerHTML='<i class="fa fa-plus"></i><span>'+(isGroup(r)?PbxObject.frases.ADD_GROUP:PbxObject.frases.ADD)+"</span>",t.appendChild(s),i.appendChild(t);var l,d,u,t,s,m=e;for(sortByKey(m,"name"),l=0;l<m.length;l++)"trunk"===r&&"system"===m[l].type||(d=m[l].oid,u=m[l].name,t=document.createElement("li"),t.setAttribute("data-oid",d),s=document.createElement("a"),s.href="#"+r+"/"+d,s.innerHTML=u,t.appendChild(s),i.appendChild(t));$(o).siblings().remove("ul"),a.append(i),show_content(!1),n=$(o).next("ul"),n&&n.slideDown("normal"),a.addClass("active")})}else n=$(o).next("ul"),n&&n.slideDown("normal"),a.addClass("active");a.siblings("li.active").removeClass("active").children("ul:visible").slideUp("normal")}function hideGroups(){$("#pbxmenu li.active").removeClass("active").children("ul:visible").slideUp("normal")}function get_object(e){var t=!0;if(PbxObject.setupInProgress&&(t=confirm("You have unsaved changes. Do you want cancel them?")),!t)return e.preventDefault();var n=location.hash.substring(1),o=n.indexOf("?")!==-1?n.substring(n.indexOf("?")+1):null,a=n.indexOf("/")!=-1?n.substring(0,n.indexOf("/")):n.substring(0),r=n.indexOf("/")!=-1?n.substring(n.indexOf("/")+1,o?n.indexOf("?"):n.length):null;PbxObject.language;if(n!==PbxObject.query){if(n){PbxObject.query=n,PbxObject.search=o,PbxObject.kind=a,PbxObject.oid=r,$("#dcontainer").addClass("faded"),show_loading_panel(),setLastQuery(n);var i=document.getElementById("el-extension");i&&i.parentNode.removeChild(i);var s=["equipment","unit","conference","channel","pickup"];s.indexOf(a)!=-1&&(a="bgroup"),PbxObject.templates[a]?load_template(PbxObject.templates[a],a):request("GET","/badmin/views/"+a+".html",null,null,function(e,t){PbxObject.templates[a]=t,load_template(t,a)}),renderSidebar({branchOptions:PbxObject.options,activeKind:PbxObject.kind,activeItem:PbxObject.oid}),window.ga&&(ga("set","page","/"+a),ga("send","pageview"))}isSmallScreen()&&$("#pagecontent").hasClass("squeezed-right")&&($("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),$("#pbxmenu").scrollTop(0))}}function load_template(e,t){var n="load_"+t,o=window[n],a=Mustache.render(e,PbxObject.frases);$("#dcontainer").html(a),"extensions"===t||"channels"===t?getExtensions(o):PbxObject.oid?json_rpc_async("getObject",'"oid":"'+PbxObject.oid+'"',o):o(),$("#dcontainer").scrollTop(0),$(".squeezed-menu > ul").children("li.active").removeClass("active").children("ul:visible").slideUp("normal")}function getPartial(e,t){PbxObject.partials=PbxObject.partials||{};var n=PbxObject.partials[e];n?t(n):request("GET","/badmin/partials/"+e+".html",null,null,function(n,o){PbxObject.partials[e]=o,t(o)})}function getTemplate(e,t){PbxObject.templates=PbxObject.templates||{};var n=PbxObject.templates[e];n?t(n):request("GET","/badmin/views/"+e+".html",null,null,function(n,o){PbxObject.templates[e]=temp,t(temp)})}function getTempParams(){return PbxObject.currentObj}function updateTempParams(e){console.log("updateTempParams: ",e),PbxObject.currentObj=extend(PbxObject.currentObj||{},e)}function setTempParams(e){console.log("setTempParams: ",e),PbxObject.currentObj=extend(PbxObject.currentObj,e)}function clearTempParams(){PbxObject.currentObj={}}function setLastQuery(e){window.sessionStorage.query=e}function setActiveMenuElement(e,t){var n=document.getElementById("pbxmenu"),o=n.querySelector('.nav-list li a[data-kind="'+e+'"]');console.log("setActiveMenuElement",e,t,o),t||hideGroups(),o&&(o.classList.contains("active")||n.classList.contains("squeezed-menu")||(showGroups(o,!0),setTimeout(function(){setActiveMenuItemElement(o,t)},500)),setActiveMenuItemElement(o,t))}function setActiveMenuItemElement(e,t){var n=[].slice.call(e.parentNode.querySelectorAll("ul li"));n.map(function(e){return e.hasAttribute("data-oid")&&e.getAttribute("data-oid")===t?e.classList.add("active"):e.classList.remove("active"),e}),console.log("setActiveMenuItemElement",e.parentNode,n,t)}function set_page(){var e=PbxObject.kind,t=["equipment","unit","users","conference","selector","channel","pickup"];t.indexOf(e)!=-1&&(e="bgroup");var n=document.getElementById("dcontainer"),o=n.querySelectorAll(".transrow"),a=n.querySelectorAll(".clirow"),r=document.getElementById("add-route"),i=document.getElementById("el-set-object"),s=document.getElementById("el-delete-object"),c="set_"+e,l=window[c];if(o.length)for(m=0;m<o.length;m++)addEvent(o[m],"click",append_transform);if(a.length)for(m=0;m<a.length;m++)addEvent(a[m],"click",add_cli_row);if(r&&addEvent(r,"click",add_new_route),i){var d=PbxObject.name?PbxObject.frases.SAVE:PbxObject.frases.CREATE;i.innerHTML='<i class="fa fa-check"></i> '+d,i.onclick=function(){l()}}s&&(PbxObject.name?s.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}:s.setAttribute("disabled","disabled"));for(var u=document.getElementsByClassName("el-sortable"),m=0;m<u.length;m++)new Sortable(u[m]);add_search_handler(),$(".selectable-cont").click(function(e){var t=e.target;if(t.getAttribute("data-value"))move_list_item(e);else{var n,o,a=getClosest(t,".selectable-cont");if(t.classList.contains("assign-all"))n=a.querySelector(".members"),o=a.querySelector(".available");else{if(!t.classList.contains("unassign-all"))return;n=a.querySelector(".available"),o=a.querySelector(".members")}move_list(n,o)}}),$("#dcontainer div.panel-header:not(.panel-static)").click(toggle_panel),$('#dcontainer [data-toggle="popover"]').popover({placement:"top",trigger:"focus"}),$('#dcontainer [data-toggle="tooltip"]').tooltip({delay:{show:1e3,hide:100}})}function setBreadcrumbs(){for(var e=document.getElementById("main-breadcrumb");e.firstChild;)e.removeChild(e.firstChild);if(PbxObject.kind){var t,n,o=document.getElementById("objname"),a=document.createDocumentFragment();t=document.createElement("li"),t.innerHTML='<a href="#'+PbxObject.kind+"/"+PbxObject.kind+'">'+PbxObject.frases.KINDS[PbxObject.kind]+"</a>",n=document.createElement("li"),n.className="active",o&&(n.innerHTML=o.value,addEvent(o,"input",function(){n.innerHTML=o.value})),a.appendChild(t),a.appendChild(n),e.appendChild(a)}}function getAvailablePool(e){json_rpc_async("getObject",{oid:"user"},function(t){console.log("getAvailablePool: ",t),e(t.available.sort())})}function toggle_sidebar(e){e&&e.preventDefault(),$(this).toggleClass("flipped"),$("#pagecontent").toggleClass("squeezed-right"),$("#pbxmenu").toggleClass("squeezed-right"),isSmallScreen()||toggle_menu()}function toggle_menu(){$("#pbxmenu").toggleClass("squeezed-menu")}function open_options(e){e&&e.preventDefault(),$("#el-slidemenu").addClass("hide-menu"),$("#pagecontent").addClass("pushed-left"),$("#pbxoptions").addClass("pushed-left"),isOptionsOpened(!0)}function close_options(e){e&&e.preventDefault(),$("#pagecontent").removeClass("pushed-left"),$("#pbxoptions").removeClass("pushed-left"),$("#el-slidemenu").removeClass("hide-menu"),setTimeout(function(){$("#pbxoptions").removeClass("top-layer"),$("#el-options-content").remove()},500),isOptionsOpened(!1)}function isOptionsOpened(e){return void 0!==e&&(PbxObject.optionsOpened=e),!!PbxObject.optionsOpened}function showModal(e,t,n,o,a){var r=document.getElementById(e),i=document.getElementById("pagecontainer");r&&r.parentNode.removeChild(r),getPartial(e,function(s){t.frases=PbxObject.frases,r=Mustache.render(s,t),i.insertAdjacentHTML("afterbegin",r),$("#"+e).modal(),$("#"+e).on("shown.bs.modal",function(e){n&&setModal(this,n),o&&o(this)}),a&&$("#"+e).on("hide.bs.modal",function(e){a(this)})})}function setModal(e,t){var n=e.querySelector('[data-type="submit"]'),o=e.querySelector("form");n&&addEvent(n,"click",function(n){n.target.disabled=!0,t(o?retrieveFormData(o):null,e)})}function openModal(e,t){var n={},o=document.getElementById(e.modalId);getPartial(e.tempName,function(a){n.frases=PbxObject.frases,e.data&&(n.data=e.data);var r=Mustache.render(a,n),i=document.querySelector("#pagecontainer");o&&o.parentNode.removeChild(o),i.insertAdjacentHTML("afterbegin",r),$("#"+e.modalId).modal(),t&&t()})}function toggle_panel(e){e.preventDefault();var t=$(this).closest(".panel"),n=t.children(".panel-body");n.slideToggle(),t.toggleClass("minimized")}function toggle_presentation(){$("#el-slidemenu").addClass("hide-menu"),$("#pagecontent").addClass("pushed-left"),$("#pbxoptions").addClass("pushed-left")}function show_loading_panel(e){if(!document.getElementById("el-loading")){"string"==typeof e&&(e=document.getElementById(e));var t=document.createElement("div");t.id="el-loading",t.className="el-loading-panel ";var n=document.createElement("div");n.className="loader",n.innerHTML='<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>',t.appendChild(n);var o=e||document.getElementById("pagecontainer");o.appendChild(t)}}function remove_loading_panel(){var e=document.getElementById("el-loading");e&&e.parentNode.removeChild(e)}function show_content(e){remove_loading_panel(),$("#dcontainer").removeClass("faded"),e===!1}function switchMode(e){var t=e.config,n=e.mode,o=[].slice.call(document.querySelectorAll(".branch-mode"));t.indexOf("channels")==-1&&o.forEach(function(e){e.className.indexOf("mode-channels")!=-1&&e.parentNode.removeChild(e)}),t.indexOf("no selectors")!==-1&&o.forEach(function(e){e.className.indexOf("mode-selector")!=-1&&e.parentNode.removeChild(e)}),t.indexOf("no users")!==-1&&o.forEach(function(e){e.className.indexOf("mode-users")!=-1&&e.parentNode.removeChild(e)}),t.indexOf("no trunks")!==-1&&o.forEach(function(e){e.className.indexOf("mode-trunks")!=-1&&e.parentNode.removeChild(e)}),t.indexOf("no groups")!==-1&&o.forEach(function(e){e.className.indexOf("mode-groups")!=-1&&e.parentNode.removeChild(e)}),1===n&&o.forEach(function(e){e.className.indexOf("mode-single")!=-1&&e.parentNode.removeChild(e)})}function switch_presentation(e,t,n){var o=t||document.getElementById("dcontainer"),n=n?"."+n:".pl-kind",a=[].slice.call(o.querySelectorAll(n));a.forEach(function(t){t.classList.contains("pl-"+e)||t.classList.contains("pl-all")?(t.style.display="",t.classList.contains("pl-no-"+e)&&(t.style.display="none")):t.style.display="none"})}function switch_tab(e){for(var t=document.getElementById(e),n=t.parentNode.parentNode,o=n.children,a=0;a<o.length;a++)o[a].children[0].id!=e?o[a].style.display="none":o[a].style.display=""}function switch_options_tab(e){for(var t=document.getElementById(e),n=t.parentNode,o=n.children,a=1;a<o.length;a++)o[a].id!=e?o[a].style.display="none":o[a].style.display=""}function add_search_handler(){var e=[].slice.call(document.querySelectorAll(".el-search"));e.length&&e.forEach(function(e){e.getAttribute("data-element")&&(e.oninput=function(e){filter_element(e)})})}function makeElement(e,t,n,o){var a=document.createDocumentFragment();e.forEach(function(e){a.appendChild(n(e))}),o&&clearTable(t),t.appendChild(a)}function filter_element(e){var t,n,e=e||window.event,o=e.target||this,a=o.getAttribute("data-element"),r=document.getElementById(a);n=o.value.toLowerCase(),"TABLE"==r.nodeName?(defClass="table-row",r=r.querySelector("tbody")):defClass="block";for(var i=0;i<r.children.length;i++)child=r.children[i],t=child.textContent.toLowerCase(),child.style.display=t.indexOf(n)===-1?"none":defClass}function arrayToPattern(e,t){return e+"|"+t}function filterObject(e,t,n){var o=[],a=!1,r=t?Array.isArray(t)?t:[t]:[];return r.length?o=e.filter(function(e){return a=r.indexOf(e.kind)!==-1,n?!a:a}):e}function getObjects(e,t,n){Array.isArray(PbxObject.objects)?t(e?filterObject(PbxObject.objects,e,n):PbxObject.objects):json_rpc_async("getObjects",{kind:"all"},function(o){sortByKey(o,"name"),PbxObject.objects=o,t(e?filterObject(PbxObject.objects,e,n):o)})}function addObjects(e,t,n){return console.log("addObjects: ",e,t,n),e.push(t),sortByKey(e,n)}function updateObjects(e,t,n){return console.log("updateObjects: ",e,t,n),e=e.map(function(e,o,a){return e[n]===t[n]?extend(a[o],t):e})}function deleteObjects(e,t,n){return console.log("deleteObjects: ",e,t,n),e=e.filter(function(e,o,a){return e[n]!==t[n]}),console.log("deleteObjects arrays: ",e),e}function notify_about(e,t){var n,o,a,r=document.createElement("div"),i=document.createElement("i"),s=document.getElementsByTagName("body")[0];switch(e){case"success":o='<span class="fa fa-check"></span>',a="el-notifier-ok";break;case"error":o='<span class="fa fa-close"></span>',a="el-notifier-error";break;default:o='<span class="fa fa-warning"></span>',a="el-notifier-info"}i.className="fa fa-close el-close-notify",r.className="el-notifier "+a,r.innerHTML+=o+" "+t,r.appendChild(i),s.appendChild(r),n=setTimeout(function(){removeEvent(i,"click",function(){s.removeChild(r),clearTimeout(n)}),s.removeChild(r)},7e3),addEvent(i,"click",function(){s.removeChild(r),clearTimeout(n)})}function append_transforms(e,t){t.forEach(function(t){append_transform(null,e,t)})}function append_transform(e,t,n){var o,a,r,i,s,c;if(t)o=document.getElementById(t);else{if(!e||"click"!=e.type)return;var e=e||window.event,l=e.target||e.srcElement;e.preventDefault(),o=getClosest(l,"table")}a=o.querySelector("tbody"),i=a.rows.length,row=a.insertRow(i),r=row.insertCell(0),s=document.createElement("div"),s.className="form-group",c=document.createElement("input"),c.className="form-control",c.setAttribute("type","text"),c.setAttribute("name","number"),null!=n&&c.setAttribute("value",n.number),s.appendChild(c),r.appendChild(s),r=row.insertCell(1),r.setAttribute("align","center"),s=document.createElement("div"),s.className="form-group",c=document.createElement("input"),c.setAttribute("type","checkbox"),c.setAttribute("name","strip"),null!=n&&(c.checked=n.strip),s.appendChild(c),r.appendChild(s),r=row.insertCell(2),s=document.createElement("div"),s.className="form-group",c=document.createElement("input"),c.className="form-control",c.setAttribute("type","text"),c.setAttribute("name","prefix"),null!=n&&c.setAttribute("value",n.prefix),s.appendChild(c),r.appendChild(s),r=row.insertCell(3),s=document.createElement("div"),s.className="form-group",c=document.createElement("a"),c.href="#",c.className="remove-clr",c.innerHTML='<i class="fa fa-minus"></i>',addEvent(c,"click",remove_row),s.appendChild(c),r.appendChild(s)}function clear_transforms(e){var t,n,o;for(t=0;t<e.length;t++)for(o=document.getElementById(e[t]),n=o.rows.length-1;n>1;n--)o.deleteRow(n)}function transformsToArray(e){var t,n=document.getElementById(e).getElementsByTagName("tbody")[0],o=[].slice.call(n.children);return o=o.map(function(e){return t={},[].slice.call(e.querySelectorAll("input[name]")).map(function(e){t[e.name]="checkbox"===e.type?e.checked:e.value}),t}).filter(function(e){return""!==e.number})}function encode_transforms(e){for(var t=document.getElementById(e).getElementsByTagName("tbody")[0],n="",o=t.children.length;o--;){var a=t.children[o],r=a.getElementsByTagName("input"),i=r.length,s=a.querySelector('input[name="number"]');if(s.value){for(n+="{";i--;)"number"==r[i].name?n+='"number":"'+r[i].value+'",':"strip"==r[i].name?n+='"strip":'+r[i].checked+",":"prefix"==r[i].name&&(n+='"prefix":"'+r[i].value+'",');n+="},"}}return n}function remove_row(e){e.preventDefault();for(var t,n=e.currentTarget,o=n.parentNode;"TBODY"!=o.nodeName;)"TR"==o.nodeName&&(t=o),o=o.parentNode;o.removeChild(t)}function updateObjectCache(e){var t=PbxObject.objects||[],n=t.filter(function(t){return t.oid===e.oid})[0];n&&(n.enabled=e.enabled,n.name=e.name)}function objectStateUpdated(e){var t=document.getElementById("enabled");t&&(t.checked=e.enabled),console.log("objectStateUpdated: ",e),void 0!==e.up&&changeTrunkRegState(e.up)}function newObjectAdded(e,t){var n=t.oid,o=t.kind,a=t.name,r=(t.enabled,document.getElementById("objname")),i=document.getElementById("el-set-object"),s=document.getElementById("el-delete-object");remove_loading_panel(),notify_about("success",a+" "+PbxObject.frases.CREATED),t.ext&&addObjects(PbxObject.extensions,t,"ext"),"phone"!==o&&"user"!==o&&(console.log("newObjectAdded: ",r,a),r&&a&&(r.value=a),s&&s.hasAttribute("disabled")&&(s.removeAttribute("disabled"),s.onclick=function(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid,t.ext)}),"application"!==o&&(PbxObject.query=o+"/"+n,window.location.href="#"+PbxObject.query),i&&(i.innerHTML='<i class="fa fa-check fa-fw"></i> '+PbxObject.frases.SAVE),Array.isArray(PbxObject.objects)&&(PbxObject.objects.push(t),sortByKey(PbxObject.objects,"name")),renderSidebar({branchOptions:PbxObject.options,activeKind:PbxObject.kind,activeItem:PbxObject.oid}))}function updateMenu(e,t){getObjects(null,function(e){PbxObject.objects=e.map(function(e){return e.ext||e.oid!==t.oid||(e.name=t.name,e.enabled=t.enabled,void 0!==t.up&&(e.up=t.up)),e}),renderSidebar({branchOptions:PbxObject.options,activeKind:PbxObject.kind,activeItem:PbxObject.oid})})}function objectDeleted(e){var t,n=e.kind?document.getElementById("ul-"+e.kind):document.querySelector("#pbxmenu .nav-list"),o=n?[].slice.call(n.querySelectorAll("li ul li")):[];console.log("objectDeleted: ",e.kind,n,o),o.forEach(function(n){t=n.getAttribute("data-oid"),t&&t===e.oid&&n.parentNode.removeChild(n)}),Array.isArray(PbxObject.objects)&&(PbxObject.objects=PbxObject.objects.filter(function(t){return t.oid!==e.oid}))}function set_object_success(e){remove_loading_panel(),notify_about("success",PbxObject.frases.SAVED)}function set_options_success_with_reload(){window.location.reload(!1)}function delete_object(e,t,n,o){var a=!!o||confirm(PbxObject.frases.DODELETE+" "+e+"?");return!!a&&void json_rpc_async("deleteObject",'"oid":"'+n+'"',function(){objectDeleted({name:e,kind:t,oid:n}),setupInProgress(!1),window.location.hash=t+"/"+t})}function deleteExtension(e){var t=e.oid,n=e.ext,o=e.group,a=PbxObject.frases.DODELETE+" "+e.name+" "+PbxObject.frases.FROM.toLowerCase()+" "+(o?o:"")+"?",r=confirm(a);PbxObject.members=PbxObject.members||[],PbxObject.available=PbxObject.available||[],r&&json_rpc_async("deleteObject",{oid:t},function(){PbxObject.members.forEach(function(e,n,o){e.oid===t&&o.splice(n,1)}),PbxObject.available.push(n),PbxObject.available.sort()})}function delete_extension(e){var t=getClosest(e.target,"tr"),n=t.id,o=(t.parentNode,t.getAttribute("data-ext")),a=t.querySelector("a"),r="extensions"===PbxObject.kind?t.cells[2].textContent:PbxObject.name,i=PbxObject.frases.DODELETE+" "+o+" "+PbxObject.frases.FROM.toLowerCase()+" "+(r?r:"")+"?",s=confirm(i);return PbxObject.members=PbxObject.members||[],PbxObject.available=PbxObject.available||[],!!s&&void json_rpc_async("deleteObject",'"oid":"'+n+'"',function(){a&&(a.removeAttribute("href"),removeEvent(a,"click",get_extension)),PbxObject.members.forEach(function(e,t,o){e.oid===n&&o.splice(t,1)}),PbxObject.available.push(o),PbxObject.available.sort()})}function onObjectDelete(e,t){t.ext&&/extensions|equipment/.test(PbxObject.kind)?(delete_extension_row(t),PbxObject.extensions=deleteObjects(PbxObject.extensions,t,"ext")):objectDeleted(t)}function delete_extension_row(e){var t=document.getElementById("extensions")||document.getElementById("group-extensions");t=t.querySelector("tbody");var n=document.getElementById(e.oid);t.removeChild(n);var o=document.getElementById("available-users");o&&(o.innerHTML+='<option value="'+e.ext+'">'+e.ext+"</option>")}function validateInput(e){var e=e||window.event;[46,9,8,27,13].indexOf(e.keyCode)!==-1||65==e.keyCode&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=40||188==e.keyCode&&e.shiftKey===!1||189==e.keyCode&&e.shiftKey===!1||(e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault()}function escapeValue(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function getFileName(e){if(null!==e){var t="";return Array.isArray(e)?e.forEach(function(e,n,o){t+=" "+e,n!==o.length-1&&(t+=",")}):t=" "+e,t.trim()}return""}function customize_upload(e,t){var n=document.getElementById(e);if(n){var o=n.parentNode,a=document.createElement("button"),r=document.createElement("span");o.className+=" nowrap";var i=getFileName(t);n.setAttribute("data-value",i),r.innerHTML=i,r.title=i,r.className="upload-filename",a.type="button",a.className="btn btn-default btn-sm needsclick",a.innerHTML=PbxObject.frases.UPLOAD,a.onclick=function(){n.click()},o.insertBefore(a,n),o.insertBefore(r,n),n.onchange=function(){console.log("upl onchange: ",this.files),this.files.length?(i=getFileName(this.files[0].name),r.innerHTML=i,r.title=i,n.setAttribute("data-value",i)):(r.innerHTML=" ",r.title="",n.removeAttribute("data-value"))}}}function parseAsCsv(e,t){function n(e,t,n){for(var o=[],a=!1,r=0,i=0;i<e.length;i++)'"'===e[i]&&(a=!a),i!==e.length-1&&(e[i]!==t||a&&'"'!==e[i-1]&&'"'!==e[i+1])||(o.push(e.substring(r,i)),r=i+1);return o.length<n&&(o.length=n),o}for(var o=e.split(/\r\n|\n/),a=new Array(o.length),r=o[0].split(t),i=0;i<o.length;)a[i]=n(o[i],t,r),i++;return a}function readFile(e,t,n){var o="function"==typeof t?t:n,a=new FileReader;a.readAsText(e,t.encoding||"UTF-8"),a.onload=function(e){o(null,e.target.result)},a.onerror=function(e){o(e)}}function upload(e,t){var n;if(isElement(e))n=e;else{if("string"!=typeof e)return!1;n=document.getElementById(e)}var o=n.files;if(0==o.length)return!1;var a=o[0],r=t?t:"/"+a.name,i=new XMLHttpRequest,s=setTimeout(function(){i.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);i.onreadystatechange=function(){4==i.readyState&&(clearTimeout(s),200!=i.status?notify_about("error",PbxObject.frases.ERROR):"uploadapp"==e&&notify_about("success",a.name+" "+PbxObject.frases.UPLOADED))},i.open("PUT",r,!0),i.send(a),console.log("upload",a,r)}function uploadFile(e,t){if(!e)return!1;var n=t?t:"/"+e.name,o=new XMLHttpRequest,a=setTimeout(function(){o.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);o.onreadystatechange=function(){4==o.readyState&&(clearTimeout(a),200!=o.status&&notify_about("error",PbxObject.frases.ERROR))},o.open("PUT",n,!0),o.send(e)}function deleteFile(e){if(e){var t=new XMLHttpRequest,n=setTimeout(function(){t.abort(),notify_about("info",PbxObject.frases.TIMEOUT)},3e4);t.onreadystatechange=function(){4==t.readyState&&(clearTimeout(n),200!=t.status&&notify_about("error",PbxObject.frases.ERROR))},t.open("DELETE",e,!0),t.send(),console.log("file deleted",e)}}function b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function get_object_link(e){var t=json_rpc("getObject",'"oid":"'+e+'"');location.hash=t.kind+"/"+e}function setObjectState(e,t,n){e&&void 0!==t&&json_rpc_async("setObjectState",{oid:e,enabled:t},function(e,t){t&&notify_about("error",t.message),n&&n(e,t)})}function setFormData(e,t){for(var n,o,a=0;a<e.elements.length;a++)n=e.elements[a],n.hasAttribute("name")&&(o=n.name,t.forEach(function(e){e.hasOwnProperty("key")&&e.key===o&&"file"!==n.type&&("checkbox"===n.type?n.checked=e.value:n.value=e.value)}))}function retrieveFormData(e){for(var t,n,o,a,r={},i=0;i<e.elements.length;i++)n=e.elements[i],t=n.getAttribute("data-type")||n.type,n.hasAttribute("name")&&(o=n.name,a="number"===t?parseFloat(n.value):"checkbox"===t?n.checked:"file"===t&&n.files.length?n.files[0].name:"file"===t&&n.getAttribute("data-value")?n.getAttribute("data-value"):n.value,void 0!==a&&null!==a&&(r[o]=a));return r}function isSmallScreen(){return $(window).width()<768}function convertBytes(e,t,n){var o={Byte:1,KB:1e3,MB:1e6,GB:1e9};return e*o[t]/o[n]}function debounce(e,t,n){var o;return function(){var a=this,r=arguments,i=function(){o=null,n||e.apply(a,r)},s=n&&!o;clearTimeout(o),o=setTimeout(i,t),s&&e.apply(a,r)}}function toTheTop(e){var t=$(document).scrollTop(),n=e?$("#"+e).offset().top:0;t<n||$("html body").animate({scrollTop:n},500)}function copyFromField(e,t){var n=getClosest(e,".input-group"),o=n.querySelector("input"),a=document.getElementById(t);
o.value=a.value}function revealPassword(e){var t=getClosest(e,".input-group"),n=t.querySelector("input");"password"==n.type?(n.type="text",e.innerHTML='<i class="fa fa-eye-slash" data-toggle="tooltip" title="'+PbxObject.frases.HIDE_PWD+'"></i>'):(n.type="password",e.innerHTML='<i class="fa fa-eye" data-toggle="tooltip" title="'+PbxObject.frases.REVEAL_PWD+'"></i>')}function generatePassword(e){for(var t,n,o,a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",r="",i=14,s=0;s<i;s++)o=Math.floor(62*Math.random()),r+=a.charAt(o);return e?(t=getClosest(e,".input-group"),n=t.querySelector("input"),n.value=r,void 0):r}function getClosest(e,t){for(var n=t.charAt(0);e&&e!==document;e=e.parentNode)if("."===n){if(e.classList.contains(t.substr(1)))return e}else if("#"===n){if(e.id===t.substr(1))return e}else if("["===n){if(e.hasAttribute(t.substr(1,t.length-2)))return e}else if(e.nodeName===t.toUpperCase())return e;return!1}function checkAll(e,t){[].forEach.call(document.querySelectorAll(e),function(e){e.checked=t})}function isVisible(e,t){var n=document.getElementById(e),o=t?"remove":"add";n.classList[o]("hidden")}function switchDisabledState(e){var t,n,o,a,r;isElement(e)?t=e:(o=e||window.event,t=o.target),n=t.checked,a=t.getAttribute("data-name"),r=[].slice.call(document.querySelectorAll('input[name="'+a+'"]')),r.forEach(function(e){e.disabled=!n})}function isElement(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}function isGroup(e){var t=["equipment","unit","users","icd","hunting","cli","pickup"];if(t.indexOf(e)!=-1)return!0}function isMaxNumber(e){return 2147483647===e}function sortSelectOptions(e){var t=e.querySelectorAll("options");t.sort(function(e,t){return e.text.toUpperCase()>t.text.toUpperCase()?1:e.text.toUpperCase()<t.text.toUpperCase()?-1:0}),$(e).empty().append(t)}function sortByKey(e,t){return e.sort(function(e,n){return e[t]<n[t]?-1:e[t]>n[t]?1:0}),e}function objFromString(e,t){return e[t]}function formatTimeString(e,t){var n,o,a,r=[];switch(n=Math.floor(e/3600),e-=3600*n,o=Math.floor(e/60),a=Math.floor(e-60*o),t){case"hh:mm":r=r.concat([n,o]);case"mm:ss":o=60*n+o,r=r.concat([o,a]);break;default:r=r.concat([n,o,a])}return r.map(function(e){return e<10&&(e="0"+e),e}).join(":")}function formatDateString(e){var t="NaN"!==parseInt(e)?parseInt(e):e,n=new Date(t),o=n.getDate()<10?"0"+n.getDate():n.getDate(),a=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,r=n.getHours()<10?"0"+n.getHours():n.getHours(),i=n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes();return o+"/"+a+"/"+n.getFullYear()+" "+r+":"+i}function fillTable(e,t,n,o){e&&t&&n&&("object"==typeof t?t.forEach(function(t){e.appendChild(n(t))}):e.appendChild(n(t)),o&&o())}function clearTable(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function clearColumns(e){for(var t=e.querySelector("thead"),n=e.rows;t.rows[0].cells.length>1;)for(var o=0;o<n.length;o++)n[o].cells.length>1&&n[o].deleteCell(-1)}function elPosition(e){var t=getViewportH(),n=getOffset(e),o=n.top,a=t-o-e.offsetHeight;return a<=e.offsetHeight?"top":"bottom"}function getViewportH(){var e=document.documentElement,t=e.clientHeight,n=window.innerHeight;return t<n?n:t}function getOffset(e){return e.getBoundingClientRect()}function extend(e,t){if(arguments.length<=1)return e;var n,o,a;for(n=1;n<arguments.length;n++){o=arguments[n];for(a in o)o.hasOwnProperty(a)&&(e[a]=o[a])}return e}function deepExtend(e,t){for(var n in t)t[n]&&t[n].constructor&&t[n].constructor===Object?(e[n]=e[n]||{},arguments.callee(e[n],t[n])):e[n]=t[n];return e}function addEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)}function removeEvent(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}function createNewButton(e){var t=document.createElement("button");return"popover"!==e.type&&"tooltip"!==e.type||(t.setAttribute("data-toggle",e.type),void 0!==e.html&&t.setAttribute("data-html",e.html),e.placement&&t.setAttribute("data-placement",e.placement),e.dataContent&&t.setAttribute("data-content",e.dataContent),e.dataTrigger&&t.setAttribute("data-trigger",e.dataTrigger)),t.className=e.classname||"",t.innerHTML=e.content||"",e.title&&(t.title=e.title),e.handler&&addEvent(t,e.evtType||"click",e.handler),t}function setAccordion(e){var t=e?e:"";$(t+" .acc-cont > .acc-pane").slideToggle(),$(t+" .acc-cont > .acc-header").click(function(){$(this).next(".acc-pane").slideToggle(),$(this).toggleClass("current"),$(this).siblings(".acc-header").removeClass("current")})}function createCodecRow(e){var t,n;return t=document.createElement("tr"),n=t.insertCell(0),n.className="draggable",n.innerHTML='<i class="fa fa-ellipsis-v"></i>',n=t.insertCell(1),n.className="codec-name",n.innerHTML=e.codec,n=t.insertCell(2),n.innerHTML='<input type="text" class="form-control codec-frames" value="'+(e.frame?e.frame:30)+'">',n=t.insertCell(3),n.innerHTML='<input type="checkbox" '+(e.enabled?"checked":"")+' class="codec-enabled">',t}function buildCodecsTable(e,t,n){var o=[],a=document.createDocumentFragment(),r=isElement(e)?e:document.getElementById(e);o=o.concat(n),t.forEach(function(e){e.enabled=!0,a.appendChild(createCodecRow(e)),o.indexOf(e.codec)!=-1&&o.splice(o.indexOf(e.codec),1)}),o.forEach(function(e){a.appendChild(createCodecRow({codec:e}))}),r.appendChild(a)}function getCodecsString(e){for(var t,n,o=[],a=isElement(e)?e:document.getElementById(e),r=0;n=a.rows[r];r++)n.getElementsByClassName("codec-enabled")[0].checked&&(t={codec:n.getElementsByClassName("codec-name")[0].textContent,frame:parseInt(n.getElementsByClassName("codec-frames")[0].value)},o.push(t));return o}function getFriendlyCodeName(e){return PbxObject.frases.CODES[e.toString()]||e}function fill_select_items(e,t){var n,o=document.getElementById(e);t.forEach(function(e){n=document.createElement("option"),n.value=e.oid,n.textContent=e.name,o.appendChild(n)})}function fill_list_items(e,t,n){("available"==e||"hunting"!=PbxObject.kind&&"icd"!=PbxObject.kind&&"unit"!=PbxObject.kind)&&t.sort();for(var o=document.getElementById(e),a=document.createDocumentFragment(),r=0;r<t.length;r++){var i=n&&t[r][n]?t[r][n]:t[r],s=document.createElement("li");s.setAttribute("data-value",i),s.innerHTML=i,a.appendChild(s)}o.appendChild(a)}function move_list_item(e){var t=e.target,n=getClosest(t,".selectable-cont"),o=t.parentNode;o.classList.contains("available")?(o.removeChild(t),n.querySelector(".members").appendChild(t)):(o.removeChild(t),n.querySelector(".available").appendChild(t))}function move_list(e,t){var e=isElement(e)?e:document.getElementById(e),t=isElement(t)?t:document.getElementById(t),n=[].slice.call(t.querySelectorAll("li"));n.forEach(function(t){e.appendChild(t)})}function changeGroupType(e){var t=[].slice.call(document.querySelectorAll(".object-type"));t.forEach(function(t){t.classList.contains(e)?t.classList.remove("hidden"):t.classList.add("hidden")})}function newInput(e){var t=document.createElement("div");if(t.className="form-group",e.label){var n='<label for="'+e.id+'">'+e.label+"</label>";t.innerHTML+=n}var o='<input type="'+(e.type||"text")+'" class="form-control" id="'+(e.id||"")+'" value="'+(e.value||"")+'">';return t.innerHTML+=o,t}function switchVisibility(e,t){t?$(e).show():$(e).hide()}function get_protocol_opts(e,t,n){var o="h323"==e?"h323":"sip",a=t,r=0!==Object.keys(PbxObject.protocolOpts).length?PbxObject.protocolOpts:a,i=[{mode:"sip info",sel:"sip info"===r.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===r.dtmfmode},{mode:"inband",sel:"inband"===r.dtmfmode}],s=[{mode:"h245alpha",sel:"h245alpha"===r.dtmfmode},{mode:"h245signal",sel:"h245signal"===r.dtmfmode},{mode:"rfc2833",sel:"rfc2833"===r.dtmfmode},{mode:"inband",sel:"inband"===r.dtmfmode}],c={opts:r,internal:"internal"===n,frases:PbxObject.frases};c.opts.dtmfmodes="h323"==o?s:i;var l=Mustache.render(PbxObject.templates.protocol,c),d=document.getElementById("proto-cont");d||(d=document.createElement("div"),d.id="proto-cont",$("#pagecontainer").prepend(d)),$(d).html(l);var u=["Opus","G.711 Alaw","G.711 Ulaw","G.729","G.723"],m=document.getElementById("protocol-codecs").querySelector("tbody");buildCodecsTable(m,c.opts.codecs,u),new Sortable(m),switch_presentation(o,d),$("#el-protocol").modal(),$("#el-set-protocol").click(function(){save_proto_opts(o)})}function save_proto_opts(e){var t=PbxObject.protocolOpts,n=document.getElementById("protocol-codecs").querySelector("tbody");t.codecs=getCodecsString(n),document.getElementById("t1")&&(t.t1=parseInt(document.getElementById("t1").value)),document.getElementById("t2")&&(t.t2=parseInt(document.getElementById("t2").value)),document.getElementById("t3")&&(t.t3=parseInt(document.getElementById("t3").value)),document.getElementById("t38fax")&&(t.t38fax=document.getElementById("t38fax").checked),document.getElementById("pvideo")&&(t.video=document.getElementById("pvideo").checked),document.getElementById("earlymedia")&&(t.earlymedia=document.getElementById("earlymedia").checked),document.getElementById("dtmfrelay")&&(t.dtmfrelay=document.getElementById("dtmfrelay").checked),t.dtmfmode=document.getElementById("dtmfmode").value,"h323"==e?(t.faststart=document.getElementById("faststart").checked,t.h245tunneling=document.getElementById("h245tunneling").checked,t.playringback=document.getElementById("playringback").checked):(t.nosymnat=document.getElementById("nosymnat").checked,t.buffering=document.getElementById("buffering").checked,t.noprogress=document.getElementById("noprogress").checked,t.noredirectinfo=document.getElementById("noredirectinfo").checked,t.passanumber=document.getElementById("passanumber").checked),$("#el-protocol").modal("hide")}function updateConference(e){var t=e.params,n=document.getElementById(t.oid);if(n){var o=n.querySelector('[data-cell="parties"]');if(o){var a=n.querySelector(".showPartiesBtn");t.total?(o.textContent=t.total,a.removeAttribute("disabled")):(o.textContent="",a.setAttribute("disabled","disabled"))}}var r=PbxObject.channels;r&&r.forEach(function(e){if(e.oid===t.oid){var n=e.parties;1==t.state?(n||(e.parties=n=[]),n.indexOf(t.number)==-1&&n.push(t.number)):0==t.state&&n.splice(n.indexOf(t.number),1)}})}function getInfoFromState(e,t){var n,o;return o=1==e?"info":8==e?"danger":2==e||5==e?"warning":0==e||e==-1&&t?"default":3==e?"danger":6==e||7==e?"danger":"active",n=PbxObject.frases.STATES[e]||"",{rstatus:n,rclass:"bg-"+o,className:o}}function getQueryParams(e){return(e||document.location.search).replace(/(^\?)/,"").split("&").map(function(e){return e=e.split("="),this[e[0]]=e[1],this}.bind({}))[0]}function getSystemTime(){json_rpc_async("getSystemTime",null,function(e){PbxObject.systime=e})}function fill_group_choice(e,t,n){var n=n||document.getElementById("extgroup");if(n){for(;n.firstChild;)n.removeChild(n.firstChild);getObjects(e,function(e){var o,a,r,i;if(!e.length)return r=document.createElement("option"),r.value="",r.innerHTML=t,r.disabled="disabled",void n.appendChild(r);for(i=0;i<e.length;i++)o=e[i].oid,a=e[i].name,r=document.createElement("option"),r.setAttribute("value",o),o!=t&&a!=t||(r.selected="true"),r.innerHTML=e[i].name,n.appendChild(r)})}}function change_protocol(){var e=this.value||document.getElementById("protocols").value;"h323"==e?(document.getElementById("sip").parentNode.style.display="none",document.getElementById("h323").parentNode.style.display=""):(document.getElementById("sip").parentNode.style.display="",document.getElementById("h323").parentNode.style.display="none")}function loadSupportWidget(e){return!0}function setupInProgress(e){return!1}function isBranchPackage(e){return PbxObject.options["package"]===e}function load_new_trunk(){function e(e){console.log("init: ",e);var n={frases:PbxObject.frases,trunks:t};ReactDOM.render(NewTrunkComponent(n),document.getElementById("el-loaded-content"))}var t=[{type:"sip",name:"SIP trunk",href:"#trunk/trunk",icon:"fa fa-fw fa-phone"},{type:"Messenger",name:"Messenger",href:"#chattrunk/chattrunk?type=Messenger",icon:"fa fa-fw fa-facebook"}];e(t),show_content(),set_page()}function load_numbers(e){function t(){billingRequest("getDidCountries",null,function(e,t){if(console.log("getSubscription response: ",e,t.result),e)return notify_about("error",e.message)})}console.log("load_numbers"),t()}function Pagination(e){this.options=e,this.createPagination=function(e,t){if(this.pagin&&clearTable(this.options.table),this.currentRange=[],!(this.options.pagnum<=1)){var n,e=e||this.options.page,t=t||(this.options.pagnum>this.options.maxpagins?this.options.maxpagins:this.options.pagnum),o=document.querySelector(".pagination-container"),a=document.createElement("ul"),r=document.createElement("p");a.className="pagination custom-pagination",n=document.createElement("li"),n.innerHTML='<a href="#" class="first">&laquo;</a>',a.appendChild(n),n=document.createElement("li"),n.innerHTML='<a href="#" class="prev">-</a>',a.appendChild(n);for(var i=e;i<=t;i++)n=document.createElement("li"),n.innerHTML='<a href="#" data-page="'+i+'">'+i+"</a>",a.appendChild(n),i==t&&(this.lastPage=n),this.currentRange.push(i);for(n=document.createElement("li"),n.innerHTML='<a href="#" class="next">+</a>',a.appendChild(n),n=document.createElement("li"),n.innerHTML='<a href="#" class="last">&raquo;</a>',a.appendChild(n),this.pagin=a,this.paginInfo=r;o.hasChildNodes();)o.removeChild(o.firstChild);o.appendChild(a),o.appendChild(r),a.onclick=this._getSelectedPage.bind(this)}},this._getSelectedPage=function(e){e.preventDefault();var t=e.target,n=this._isPagin(t);n||("next"==t.className?n=this.currentPage+1:"prev"==t.className?n=this.currentPage-1:"first"==t.className?(n=1,this.options.pagnum>=this.options.maxpagins&&this.createPagination(1,this.options.maxpagins)):"last"==t.className&&(n=this.options.pagnum,n>=this.options.maxpagins&&this.createPagination(n-this.options.maxpagins+1,n))),n>this.options.pagnum||n<1||this.selectPage(n)},this.selectPage=function(e){var e=parseInt(e),t=parseInt(e)*parseInt(this.options.rows)-parseInt(this.options.rows),n=e*parseInt(this.options.rows);n=n<this.options.records.length?n:this.options.records.length,this.currentPage=e,clearTable(this.options.table);for(var o=t;o<n;o++)build_records_row(this.options.records[o],this.options.table);if(this.currentRange.length){this.currentRange.indexOf(e)==this.currentRange.length-1||this.currentRange.indexOf(e)==this.currentRange.length-2?this._appendPage():0!=this.currentRange.indexOf(e)&&1!=this.currentRange.indexOf(e)||this._prependPage();var a=this.pagin.querySelector("li.active");a&&a.classList.remove("active"),this.pagin.querySelector('a[data-page="'+e+'"]').parentNode.classList.add("active")}this.paginInfo&&(this.paginInfo.innerHTML=PbxObject.frases.FROM2.toLowerCase()+" "+t+" "+PbxObject.frases.TO.toLowerCase()+" "+n+" "+PbxObject.frases.RECORDS.REC.toLowerCase())},this._appendPage=function(){var e=this.currentRange[this.currentRange.length-1]+1;if(!(e>this.options.pagnum)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,o=document.createElement("li");o.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(o,t.nextSibling),this.pagin.removeChild(n),this.currentRange.push(e),this.currentRange.shift()}},this._prependPage=function(){var e=this.currentRange[0]-1;if(!(e<1)){var t=this.pagin.querySelector('a[data-page="'+this.currentRange[this.currentRange.length-1]+'"]').parentNode,n=this.pagin.querySelector('a[data-page="'+this.currentRange[0]+'"]').parentNode,o=document.createElement("li");o.innerHTML='<a href="#" data-page="'+e+'">'+e+"</a>",this.pagin.insertBefore(o,n),this.pagin.removeChild(t),this.currentRange.unshift(e),this.currentRange.pop()}},this._destroyPagination=function(){for(;this.pagin&&this.pagin.hasChildNodes();)this.pagin.removeChild(this.pagin.firstChild)},this._isPagin=function(e){return e.getAttribute("data-page")}}function Picker(e,t){var n,o,a,r,i,s="string"==typeof e?document.getElementById(e):e,c=PbxObject.frases,l=!1,d=this;this.defaults={defaultOption:"today",interval:!1,actionButton:!0,buttonSize:"sm",buttonColor:"default"},this.defaults=extend({},this.defaults),extend(this.defaults,t),this.date={},this.interval=this.defaults.interval?36e5:null,this.intervalString="hour",this.fields={},this._pickerHandler=function(e){var t,o,a=e.target;"LABEL"===a.nodeName?(t=a.children[0].getAttribute("data-range"),t?(d._setCurrentRange(t),"custom"===t?(l=!0,n.classList.remove("ghosted")):(l=!1,n.classList.add("ghosted"))):(o=a.children[0].getAttribute("data-interval"),o&&("hour"===o?this.interval=36e5:"1/2_hour"===o?this.interval=18e5:"1/4_hour"===o?this.interval=9e5:"day"===o&&(this.interval=864e5),this.intervalString=o))):"BUTTON"===a.nodeName&&("submitButton"===a.name?(l&&d._rangeToString(),d.defaults.submitFunction&&d.defaults.submitFunction({date:this.date})):"selectButton"===a.name&&l&&d._rangeToString(),s.classList.toggle("open"))},this._init=function(){if(s){var e=this.template();s.innerHTML=e,dropdown=s.querySelector(".dropdown-menu"),a=[].slice.call(s.querySelectorAll('input[name="options"]')),o=s.querySelector(".dropdown-button"),btnText=o.querySelector(".btn-text"),n=s.querySelector(".custom-range"),o.onclick=function(){s.classList.toggle("open")},dropdown.onclick=function(e){d._pickerHandler(e)},this._setCurrentRange(this.defaults.defaultOption),r=document.getElementById("custom-range-from"),i=document.getElementById("custom-range-to"),rome(r,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.beforeEq(i)}),rome(i,{time:!1,inputFormat:"DD/MM/YYYY",dateValidator:rome.val.afterEq(r)})}},this._setCurrentRange=function(t){"today"===t?(this.date.start=today().toStartOf().valueOf(),this.date.end=today().toEndOf().valueOf()):"yesterday"===t?(this.date.end=today().toEndOf().minus(1).valueOf(),this.date.start=today().toStartOf().minus(1).valueOf()):"week"===t?(this.date.end=today().toEndOf().valueOf(),this.date.start=today().toStartOf().minus(7).valueOf()):"30_days"===t?(this.date.end=today().toEndOf().valueOf(),this.date.start=today().toStartOf().minus(30).valueOf()):"60_days"===t?(this.date.end=today().toEndOf().valueOf(),this.date.start=today().toStartOf().minus(60).valueOf()):"custom"===t&&this._setCustomRange(),e&&this._setButtonText()},this._rangeToString=function(){var e=rome.find(r).getDateString("MM/DD/YYYY"),t=rome.find(i).getDateString("MM/DD/YYYY");this.date.start=today(e).toStartOf().valueOf(),this.date.end=today(t).toEndOf().valueOf(),this._setButtonText()},this.formatDate=function(e,t){var n=("0"+(e.getMonth()+1)).slice(-2),o=("0"+e.getDate()).slice(-2),a=e.getFullYear(),r="mm/dd/yyyy"==t?n+"/"+o+"/"+a:o+"/"+n+"/"+a;return r},this._setCustomRange=function(e){var t=today().toStartOf().dateOf(),n=today().toEndOf().dateOf();r.value=this.formatDate(t),i.value=this.formatDate(n)},this._setButtonText=function(){btnText.innerHTML=this.formatDate(new Date(this.date.start))+" - "+this.formatDate(new Date(this.date.end))},this._closeDropdowns=function(){s.classList.toggle("open"),removeEvent(document,"click",this._closeDropdowns)},this.today=function(){return today().toStartOf().valueOf()},this.template=function(){return'<button type="button" class="btn btn-'+this.defaults.buttonColor+" btn-"+this.defaults.buttonSize+' btn-block dropdown-button" aria-expanded="true"><span class="btn-text" style="margin-right:5px"></span><span class="caret"></span></button><div class="dropdown-menu"><div class="col-xs-12 btn-group btn-group-vertical" data-toggle="buttons"><label class="btn btn-default active"><input type="radio" name="options" data-range="today"autocomplete="on" checked>'+c.DATE_PICKER.TODAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="yesterday" autocomplete="off" checked>'+c.DATE_PICKER.YESTERDAY+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="week" autocomplete="off">'+c.DATE_PICKER.LAST_7_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="30_days" autocomplete="off">'+c.DATE_PICKER.LAST_30_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="60_days" autocomplete="off">'+c.DATE_PICKER.LAST_60_DAYS+'</label><label class="btn btn-default"><input type="radio" name="options" data-range="custom" autocomplete="off">'+c.DATE_PICKER.CUSTOM_RANGE+'</label></div><div class="col-xs-12 custom-range ghosted"><br><div class="input-group"><input type="text" class="form-control" id="custom-range-from"><span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" class="form-control" id="custom-range-to"></div></div>'+(this.defaults.interval?'<div class="col-xs-12 custom-interval"><hr><p>'+c.DATE_PICKER.INTERVAL+'</p><div class="btn-group btn-group-justified" data-toggle="buttons"><label class="btn btn-default"><input type="radio" name="options" data-interval="1/4_hour" autocomplete="off">15'+c.MIN+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="1/2_hour" autocomplete="off">30'+c.MIN+'</label><label class="btn btn-default active"><input type="radio" name="options" data-interval="hour" autocomplete="off" checked>'+c.HOUR+'</label><label class="btn btn-default"><input type="radio" name="options" data-interval="day" autocomplete="off">'+c.DAY+"</label></div></div>":"")+'<div class="col-xs-12"><hr>'+(this.defaults.actionButton?'<button type="button" name="submitButton" class="btn btn-primary btn-md btn-block">'+c.SEARCH+"</button>":'<button type="button" name="selectButton" class="btn btn-primary btn-md btn-block">'+c.SELECT+"</button>")+"</div></div>"},this._init()}function Player(){var e,t,n,o,a,r,i,s,c,l=1,d=!1,u="",m=function(){var l=y();e=document.createElement("div"),e.id="rec-player",e.className="pl-cont",e.innerHTML=l,document.querySelector("body").appendChild(e),t=document.getElementById("pl-seek"),n=document.getElementById("pl-time"),o=document.getElementById("pl-play"),a=document.getElementById("pl-duration"),r=document.getElementById("pl-download"),i=document.getElementById("audio-rec"),s=document.getElementById("pl-controls"),c=document.getElementById("pl-pb-control"),p()},p=function(){addEvent(e,"click",function(e){g(e)}),addEvent(i,"playing",function(){o.innerHTML='<i class="fa fa-fw fa-pause"></i>',x.lastEl&&(x.lastEl.innerHTML='<i class="fa fa-fw fa-pause"></i>')},!0),addEvent(i,"loadedmetadata",function(){a.textContent=formatTimeString(parseInt(i.duration),"hh:mm:ss")}),addEvent(i,"pause",function(){o.innerHTML='<i class="fa fa-fw fa-play"></i>',x.lastEl&&(x.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>')},!0),addEvent(i,"timeupdate",b,!0),addEvent(i,"ended",f(l+1),!0),addEvent(t,"click",function(e){e||(e=window.event),i.currentTime=(i.duration*((e.offsetX||e.layerX)/t.clientWidth)).toFixed(2)},!0)},b=function(){var e=0===i.currentTime?0:Math.floor(100/i.duration*i.currentTime);n.textContent=formatTimeString(parseInt(i.currentTime),"hh:mm:ss"),t.value=e,$(document).trigger("player:timeupdate",[{time:1e3*i.currentTime,trackIndex:l}])},f=function(e){!x.playlist.length||e<=1||e>=x.playlist.length||(l=e,$(document).trigger("player:track",[{track:l}]),i.src=x.filePath+x.playlist[l-1].file,u=x.playlist[l-1].file,r.href=i.src,r.setAttribute("download",i.src),i.play(),console.log("playTrack: ",l,x.playlist[l-1].file))},g=function(e){e||(e=window.event);var t=e.target;"I"==t.nodeName&&(t=t.parentNode),"pl-play"==t.id&&x.playAudio(),"pl-stop"==t.id&&x.stopAudio(),"pl-prev"==t.id&&x.prevAudio(),"pl-next"==t.id&&x.nextAudio(),"pl-close"==t.id&&v()},h=function(){e.classList.add("shown"),d=!0,x.playlist.length&&(s.style.width="475px",c.classList.remove("hidden"))},v=function(){e.classList.remove("shown"),x.stopAudio(),d=!1},y=function(){return'<audio id="audio-rec" type="audio/x-wav; codecs=\'1\'"></audio><div class="pl-controls" id="pl-controls"><a href="#" download="" class="pl-control bg-success pull-left" id="pl-download"><i class="fa fa-download"></i></a><button class="pl-control bg-primary pull-left" id="pl-play"><i class="fa fa-fw fa-play"></i></button><div id="pl-pb-control" class="hidden" style="display:inline;height: 100%;"><button class="pl-control bg-primary pull-left" id="pl-prev"><i class="fa fa-fw fa-backward"></i></button><button class="pl-control bg-primary pull-left" id="pl-next"><i class="fa fa-fw fa-forward"></i></button></div><div class="pl-time"><span id="pl-time"></span>/<span id="pl-duration"></span></div><progress id="pl-seek" max="100" value="0" class-"pl-seek-bar"></progress><button class="pl-control bg-danger pull-right" id="pl-close"><i class="fa fa-fw fa-close"></i></button><button class="pl-control bg-primary pull-right" id="pl-stop"><i class="fa fa-fw fa-stop"></i></button></div>'},x={playlist:[],filePath:"",audioFile:"",audioURL:"",audio:i,lastEl:null,playAudio:function(){d===!1&&h(),this.audioURL!==u&&(i.src=this.filePath+this.audioURL,u=this.audioURL,r.href=this.audioURL,r.setAttribute("download",this.audioFile)),console.log("playAudio: ",i.src,u),i.paused?i.play():i.pause()},prevAudio:function(){this.stopAudio(),f(l-1)},nextAudio:function(){this.stopAudio(),f(l+1)},stopAudio:function(){i.pause(),i.currentTime=0}};return m(),x}function load_realtime(){function e(){getExtensions(function(e){s.extensions=e,i=setInterval(n,1e3),addEvent(window,"hashchange",r),t(),show_content(),set_page()})}function t(){ReactDOM.render(RealtimeDashboardComponent({frases:PbxObject.frases,data:s}),document.getElementById("el-loaded-content"))}function n(){json_rpc_async("getCurrentCalls",null,a),json_rpc_async("getCurrentState",null,o)}function o(e){s.state=e,s.trunks=e.trunks,t(s)}function a(e){e&&(s.calls=e,t(s))}function r(){clearInterval(i),removeEvent(window,"hashchange",r)}var i=null,s={extensions:[],state:{inc:0,out:0,conn:0,load:0},trunks:[],calls:[]};e()}function load_rec_settings(){json_rpc_async("getVoiceRecordingList","",function(e){getRecObjects(e)}),$("#set-rec-settings").click(function(){setRecObjects()})}function getRecObjects(e){function t(){n+=1,n===o&&fillSelects(a)}var n=0,o=2,a={};a.result=e,json_rpc_async("getObjects",'"kind":"trunk"',function(n){e.trunks?a.trunks=n.filter(function(t){return e.trunks.indexOf(t.name)==-1}):a.trunks=n,t()}),json_rpc_async("getExtensions",null,function(n){var o=filterObject(n,["phone","user"]);console.log("getRecObjects: ",o),e.extensions?a.exts=o.filter(function(t){return e.extensions.indexOf(t.ext)===-1}):a.exts=o,t()})}function fillSelects(e){document.querySelector('#trunks-rec-mode input[value="'+e.result.trunksmode+'"]').checked=!0,document.querySelector('#ext-rec-mode input[value="'+e.result.extmode+'"]').checked=!0,e.result.trunks&&fill_list_items("rec-trunks",e.result.trunks),e.result.extensions&&fill_list_items("rec-ext",e.result.extensions),fill_list_items("av-trunks",e.trunks,"name"),fill_list_items("av-ext",e.exts,"ext"),close_options(),set_page(),show_content()}function setRecObjects(){var e="",t=document.querySelector("#trunks-rec-mode input:checked"),n=document.querySelector("#ext-rec-mode input:checked"),o=document.getElementById("rec-trunks"),a=document.getElementById("rec-ext");e+='"trunks":[';for(var r=0;r<o.children.length;r++)e+='"'+o.children[r].innerHTML+'",';e+="],",e+='"extensions":[';for(var r=0;r<a.children.length;r++)e+='"'+a.children[r].innerHTML+'",';e+="],",e+='"trunksmode":'+t.value+",",e+='"extmode":'+n.value+",",json_rpc_async("setVoiceRecordingList",e,function(){set_object_success()})}function load_records(){function e(e){var n="I"===e.target.nodeName?e.target.parentNode:e.target,o=n.getAttribute("data-method"),a=n.getAttribute("data-param");t[o]&&t[o](a,n,e)}PbxObject.Pagination=new Pagination,PbxObject.recPicker=new Picker("recs-date-picker",{submitFunction:getRecParams,actionButton:!1,buttonSize:"md"});var t={playRecord:playRecord,getQos:getQos,toggleRecQoS:toggleRecQoS},n=[].slice.call(document.querySelectorAll(".init-mode"));n.forEach(function(e){"0"===e.value&&(e.checked=!0)}),json_rpc_async("getObjects",'"kind":"trunk"',function(e){e.unshift({oid:PbxObject.frases.ALL,name:PbxObject.frases.ALL}),fill_select_items("searchtrunk",e)}),$("#getcalls-btn").click(function(e){getRecParams(e)}),$("#sample-data").hide(),$("#search-calls .panel-body").slideToggle(),$("#extendedsearch").click(function(e){e.preventDefault();var t=$(this).closest(".panel"),n=t.find(".panel-body");n.is(":visible")?$(this).text(PbxObject.frases.MORE):$(this).text(PbxObject.frases.LESS),n.slideToggle()}),$("#records-table").click(e),TableSortable.sortables_init(),getRecords({begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end},showRecords),show_content()}function build_records_row(e,t){if(e){var n,o="",a=t.rows.length,r=t.insertRow(a),i=e.td;if(e.id&&(r.id=e.id),n=r.insertCell(0),n.textContent=formatDateString(e.ts),n=r.insertCell(1),n.className="nowrap",n.textContent=e.na,n=r.insertCell(2),o=e.nc&&e.nc!==e.nb?e.nb+" ("+e.nc+")":e.nb,n.textContent=o,n.title=o,n=r.insertCell(3),o=e.ta?e.tb?e.ta+" ("+e.tb+")":e.ta:e.tb,n.textContent=o,n=r.insertCell(4),n.textContent=formatTimeString(i,"hh:mm:ss"),n=r.insertCell(5),n.textContent=getFriendlyCodeName(e.cs),n=r.insertCell(6),n.textContent=parseFloat(e.tr).toFixed(2),n=r.insertCell(7),n.textContent=parseFloat(e.ch).toFixed(2),n=r.insertCell(8),e.fi){var s=document.createElement("a");s.href="#",s.setAttribute("data-method","playRecord"),s.setAttribute("data-param",e.fi),s.innerHTML='<i class="fa fa-play fa-fw"></i>',n.appendChild(s)}n=r.insertCell(9),n.innerHTML=e.fi?'<a href="'+window.location.protocol+"//"+window.location.host+"/records/"+e.fi+'" download="'+e.fi+'" target="_blank"><i class="fa fa-fw fa-download"></i></a>':"",n=r.insertCell(10),n.innerHTML='<a href="#" data-method="getQos" data-param="'+e.id+'"><i class="fa fa-fw fa-info"></i></a>'}}function getRecParams(e){show_loading_panel(e.target);var t,n,o,a=document.querySelectorAll(".init-order"),r=document.querySelectorAll(".init-mode"),i=document.getElementById("searchnum"),s=document.getElementById("searchtrunk");for(o=0;o<a.length;o++)a[o].checked&&(t=a[o].value);for(o=0;o<r.length;o++)r[o].checked&&(n=r[o].value);var c={begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end};i.value&&(c.number=i.value),s.value!==PbxObject.frases.ALL&&(c.trunk=s.options[s.selectedIndex].textContent),n&&(c.mode=parseInt(n,10)),t&&(c.order=parseInt(t,10)),getRecords(c,showRecords)}function getRecords(e,t){json_rpc_async("getCalls",e,t)}function showRecords(e){show_content();var t=document.getElementById("records-table").querySelector("tbody"),n=document.getElementById("searchrows");!n.value&&e.length>20&&(n.value=20);for(var o,a=n.value?parseInt(n.value):e.length,r=e.length>a?Math.ceil(e.length/a):1,i=0,s=0;s<e.length;s++)for(o in e[s])"ch"==o&&(i+=parseFloat(e[s][o]));i=i.toFixed(2),$("#sample-data").show(),$("#sample-length").text(e.length),$("#sample-cost").text(i),PbxObject.Pagination.options={table:t,page:1,maxpagins:5,rows:a,records:e,pagnum:r,buildTableFunction:build_records_row},PbxObject.Pagination.createPagination(),PbxObject.Pagination.selectPage(1)}function getQos(e,t,n){if(n.preventDefault(),console.log("getQos: ",e,t),e){var o=t.innerHTML;t.getAttribute("data-method");t.innerHTML='<i class="fa fa-spinner fa-spin"></i>',t.setAttribute("data-method",""),getRecords({begin:PbxObject.recPicker.date.start,end:PbxObject.recPicker.date.end,qos:!0,id:e},function(n){console.log("getQos result: ",n),t.innerHTML=o,t.setAttribute("data-method","toggleRecQoS"),showRecQoS(e,n)})}}function toggleRecQoS(e){console.log("toggleRecQoS: ",e),$("#"+e+"-qos").collapse("toggle")}function showRecQoS(e,t){var n=document.createElement("tr"),o=document.createElement("td"),a=document.createElement("div");a.id=e+"-qos",a.className="collapse",
o.colSpan="11",o.style.padding="0",o.style.borderTop="none",o.appendChild(a),n.appendChild(o),$(n).insertAfter("#"+e),ReactDOM.render(RecQosTable({frases:PbxObject.frases,data:t[0],utils:{formatTimeString:formatTimeString}}),a),$(a).collapse()}function playRecord(e,t,n){n.preventDefault(),PbxObject.Player=PbxObject.Player||new Player;var o=PbxObject.Player;null!==o.lastEl&&o.lastEl!=t&&(o.lastEl.innerHTML='<i class="fa fa-fw fa-play"></i>'),o.lastEl=t,o.audioFile=e,o.audioURL=window.location.protocol+"//"+window.location.host+"/records/"+e,o.playAudio()}function load_reg_history(e){function t(e){var t={frases:PbxObject.frases,params:e};ReactDOM.render(UsersRegHistoryComponent(t),document.getElementById("el-loaded-content"))}console.log("load_reg_history: ",e),t(),show_content()}function renderSidebar(e){function t(e){return isBranchPackage(e)}function n(){var n=[{name:"dashboard",iconClass:"fa fa-fw fa-pie-chart",objects:[{kind:"guide",iconClass:"fa fa-fw fa-arrow-circle-o-right",standout:!0},{kind:"realtime",iconClass:"fa fa-fw fa-tachometer"},{kind:"records",iconClass:"fa fa-fw fa-phone"},{kind:"statistics",iconClass:"fa fa-fw fa-table"},{kind:"channel_statistics",iconClass:"fa fa-fw fa-area-chart"},{kind:"reg_history",iconClass:"fa fa-fw fa-history"}]},{name:"users",iconClass:"icon-contact",objects:[{kind:"extensions"}],type:"group",fetchKinds:["users"]},{name:"equipment",iconClass:"fa fa-fw fa-fax",type:"group",fetchKinds:["equipment"]},{name:"servicegroup",iconClass:"icon-chats",type:"group",fetchKinds:["hunting",t("team")?"":"icd",t("team")?"":"chatchannel"]},{name:"chattrunk",iconClass:"icon-channels",shouldRender:!t("team"),fetchKinds:["chattrunk"]},{name:"trunk",iconClass:"icon-dialer_sip",fetchKinds:["trunk"]},{name:"attendant",iconClass:"fa fa-fw fa-sitemap",fetchKinds:["attendant"]},{name:"timer",iconClass:"fa fa-fw fa-clock-o",fetchKinds:["timer"]},{name:"routes",iconClass:"fa fa-fw fa-arrows",fetchKinds:["routes"]},{name:"settings",shouldRender:!1,objects:[{kind:"branch_options",iconClass:"fa fa-fw fa-sliders"},{kind:"rec_settings",iconClass:"fa fa-fw fa-microphone"},{kind:"services",iconClass:"fa fa-fw fa-plug"},{kind:"storages",iconClass:"fa fa-fw fa-hdd-o"},{kind:0!==e.branchOptions.mode||s.partnerid?"":"licenses",iconClass:"fa fa-fw fa-key"},{kind:0!==e.branchOptions.mode||s.partnerid?"":"billing",iconClass:"fa fa-fw fa-credit-card"},{kind:"certificates",iconClass:"fa fa-fw fa-lock"},{kind:"customers",iconClass:"fa fa-fw fa-users"}]}];return n}function o(e,t,n){var o=[];return e.fetchKinds&&e.fetchKinds.length?void window.getObjects(e.fetchKinds,function(e){return o=e?o.concat(e):o,n(o)}):n(o)}function a(e){return e.match("hunting|icd|chatchannel|selector")?"servicegroup":e.match("guide|realtime|statistics|channel_statistics|records|reg_history")?"dashboard":e.match("extensions")?"users":e.match("branch_options|rec_settings|services|storages|licenses|billing|certificates|customers")?"settings":e}function r(t){var n=extend({},e);n.activeKind=t,n.activeItem=e.activeItem||e.activeKind,i(n)}function i(e){var t=n(),i=a(e.activeKind),s=e.activeItem||e.activeKind,c=t.filter(function(e){return e.name===i})[0];o(c,e.branchOptions,function(e){componentParams={frases:PbxObject.frases,menuItems:t,activeKind:i,activeItem:s,selectedMenu:c,selectKind:r,objects:e},ReactDOM.render(SideBarComponent(componentParams),document.getElementById("pbxmenu"))})}var s=PbxObject.profile;PbxObject.options.config||[];i(e),console.log("renderSidebar",e.branchOptions.config)}function load_reports(){new Reports}function chartOptions(e){return{xaxis:{mode:"time",timeformat:e,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0,labelFormatter:function(e,t){return console.log(t),'<span class="chart-label">'+e+"</span>"}},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:e}}}function Reports(){var e,t,n=(document.querySelectorAll(".calls-incoming"),document.querySelectorAll(".calls-outgoing"),document.querySelectorAll(".calls-connected"),document.querySelectorAll(".calls-load"),this);this.init=function(){var t,o,a,r;e=new Picker("calls-date-picker",{submitFunction:n.getStatistics,interval:!0,buttonSize:"md"}),t=e.date.start,o=e.date.end,a=e.interval,r='"begin":'+t+', "end":'+o+', "interval":'+a,json_rpc_async("getCallStatisticsGraph",r,function(e){n.createGraph(e),show_content()})},this.getStatistics=function(){$("#reports-cont").addClass("faded");var t=e.date.start,o=e.date.end,a=e.interval,r='"begin":'+t+', "end":'+o+', "interval":'+a;json_rpc_async("getCallStatisticsGraph",r,function(e){n.createGraph(e),$("#reports-cont").removeClass("faded")})},this.createGraph=function(n){if(!n.length)return $("#outCalls-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),$("#inAndLost-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),$("#intCalls-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>"),void $("#linesLoad-graph").html('<h3 class="text-muted">'+PbxObject.frases.STATISTICS.NO_DATA+"</h3>");for(var o,a,r=[],i=[],s=[],c=[],l=[],d=("1/2_hour"==e.intervalString||"1/4_hour"==e.intervalString?[]:[1,e.intervalString],function(e){return"hour"==e?"%H:%M":"day"==e?"%d %b":"%H:%M"}(e.intervalString)),u=0,m=n.length;u<m;u++)a=n[u],o=a.t,r.push([o,a.i]),i.push([o,a.o]),s.push([o,a.l]),c.push([o,a.m]),l.push([o,a.p]);var p={show:!0,barWidth:e.interval,lineWidth:0,fill:.7};insAndLostData=[{label:PbxObject.frases.STATISTICS.CONNECTEDCALLS,stack:0,bars:p,data:r,color:"#3c763d"},{label:PbxObject.frases.STATISTICS.LOSTCALLS,stack:0,bars:p,data:c,color:"#AA4643"}],i=[{label:PbxObject.frases.SETTINGS.OUTCALLS,bars:p,data:i,color:"#4572A7"}],s=[{label:PbxObject.frases.SETTINGS.INTCALLS,bars:p,data:s,color:"#BADABA"}],l=[{label:PbxObject.frases.STATISTICS.LINES_PAYLOAD,data:l,lines:{show:!0,fill:!1},points:{show:!0},color:"#3c763d"}],t={xaxis:{mode:"time",timeformat:d,timezone:"browser",tickSize:0,monthNames:PbxObject.frases.MONTHS_SHORT,tickLength:0,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:15,color:"#555"},yaxes:{position:0,tickFormatter:function(e){return e.toFixed(1)},min:0,axisLabel:PbxObject.frases.KINDS.calls,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial, Helvetica, Tahoma, sans-serif",axisLabelPadding:5,color:"#555"},grid:{hoverable:!0,borderWidth:{top:0,right:0,bottom:1,left:1}},legend:{labelBoxBorderColor:"none",noColumns:5,position:"ne",margin:0},tooltip:!0,tooltipOpts:{content:"%x <br> %s: %y.2",yDateFormat:d}};var b=new chartOptions(d);b.legend.container=$("#outCalls-graph-lg");var f=new chartOptions(d);f.legend.container=$("#inAndLost-graph-lg");var g=new chartOptions(d);g.legend.container=$("#intCalls-graph-lg");var h=new chartOptions(d);h.legend.container=$("#linesLoad-graph-lg"),$.plot($("#outCalls-graph"),i,b),$.plot($("#inAndLost-graph"),insAndLostData,f),$.plot($("#intCalls-graph"),s,g),$.plot($("#linesLoad-graph"),l,h)},this.init()}function load_routes(e){PbxObject.oid=e.oid,PbxObject.routepriorities=["Max. prefix length","Least cost routing","Load balancing","Answer seizure ratio","Average call duration","Most idle gateway","Least utilised gateway","Max. priority (status)"],PbxObject.name=e.name;var t=document.getElementById("enabled"),n=document.getElementById("objname");e.name&&(n.value=e.name),t&&(t.checked=e.enabled,addEvent(t,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(t.checked=!t.checked)})}));var o,a=(document.getElementById("rtable"),document.getElementById("priorities")),r=e.priorities;for(o=0;o<r.length;o++){var i=document.createElement("li");i.setAttribute("data-routepriority",r[o]),i.innerHTML=PbxObject.routepriorities[r[o]],a.appendChild(i)}var s=e.anumbertransforms;if(s.length)for(o=0;o<s.length;o++)append_transform(null,"transforms1",s[o]);else append_transform(null,"transforms1");if(s=e.bnumbertransforms,s.length)for(o=0;o<s.length;o++)append_transform(null,"transforms2",s[o]);else append_transform(null,"transforms2");void 0!=e.routes?build_routes_table(e.routes):show_content(),TableSortable.sortables_init(),set_page()}function set_routes(){var e=document.getElementById("objname").value;if(!e)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;var t='"name":"'+e+'",';show_loading_panel();var n;PbxObject.name?n=set_object_success:(PbxObject.name=e,n=null),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),t+='"kind":"routes",',t+='"enabled":'+document.getElementById("enabled").checked+",",t+='"priorities":[';var o,a=document.getElementById("priorities");for(o=0;o<a.children.length;o++)t+=a.children[o].getAttribute("data-routepriority")+",";t+="],",t+='"anumbertransforms":[',t+=encode_transforms("transforms1"),t+="],",t+='"bnumbertransforms":[',t+=encode_transforms("transforms2"),t+="],",t+='"routes":[';var r,i,s=document.getElementById("rtable");for(o=1;o<s.rows.length;o++)i=s.rows[o],i.cells[0].textContent&&(r="",r+='"number":"'+i.cells[0].textContent+'",',r+='"description":"'+i.cells[1].textContent+'",',r+='"target":{"oid":"'+i.cells[2].getAttribute("data-gid")+'"},',r+='"priority":'+parseInt(i.cells[3].getAttribute("data-priority"))+",",r+='"cost":'+parseFloat(i.cells[4].textContent)+",",""!=r&&(t+="{"+r+"},"));t+="]",json_rpc_async("setObject",t,n)}function getRouteObjects(e){var t=[];getObjects(["equipment","users","cli","timer","routes","pickup","chattrunk","chatchannel"],function(n){t=t.concat(n),getExtensions(function(n){t=t.concat(n.filter(function(e){return e.kind.match(/user|phone/)})),console.log("getRouteObjects: ",t),e(t)})},!0)}function build_routes_table(e){var t,n,o=document.getElementById("rtable").getElementsByTagName("tbody")[0];getRouteObjects(function(a){if(!e.length&&a.length)o.appendChild(build_route_row(null,a));else{sortByKey(e,"number"),t=document.createDocumentFragment();for(var r=0;r<e.length;r++)n=e[r],isChannelRoute(n)||t.appendChild(add_route_row(e[r],a));o.appendChild(t)}show_content()})}function isChannelRoute(e){return e.number&&e.number.indexOf("@")!==-1}function editRow(e,t){getRouteObjects(function(n){var o=build_route_row(t,n);e.parentNode.insertBefore(o,e),e.style.display="none"})}function add_new_route(e){var e=e||window.event;e&&e.preventDefault(),getRouteObjects(function(e){var t=document.getElementById("rtable").getElementsByTagName("tbody")[0];t.insertBefore(build_route_row(null,e),t.children[0])})}function add_route_row(e,t){var n,o,a;n=document.createElement("tr"),o=n.insertCell(0),o.textContent=e.number,o=n.insertCell(1),o.textContent=e.description,o.className="nowrap",o.title=e.description||"",o=n.insertCell(2);var r={};for(i=0;i<t.length;i++)t[i].oid==e.target.oid&&(r=t[i],o.setAttribute("data-gid",e.target.oid),o.setAttribute("data-gname",r.name),a=document.createElement("a"),r.kind.match(/user|phone/)?(a.href="#",a.onclick=function(e){e.preventDefault(),getExtension(r.oid)}):a.href="#"+r.kind+"/"+r.oid,a.innerText=r.name,o.appendChild(a));return o=n.insertCell(3),o.setAttribute("data-priority",e.priority),o.textContent=0==e.priority?"OFF":10==e.priority?"EXV":e.priority,o=n.insertCell(4),o.textContent=parseFloat(e.cost).toFixed(2),o=n.insertCell(5),button=document.createElement("button"),button.className="btn btn-primary btn-sm",button.innerHTML='<i class="fa fa-edit"></i>',addEvent(button,"click",function(){editRow(n,e)}),o.appendChild(button),o=n.insertCell(6),button=document.createElement("button"),button.className="btn btn-danger btn-sm",button.innerHTML='<i class="fa fa-trash"></i>',addEvent(button,"click",function(t){var n=confirm(PbxObject.frases.DELETE+" "+PbxObject.frases.ROUTE.toLowerCase()+"?");return!!n&&(deleteRoute(e.oid),void remove_row(t))}),o.appendChild(button),n}function build_route_row(e,t){var n,o,a,r,i={},s=document.createElement("tr"),c=document.createElement("td"),l=document.createElement("div"),d=document.createElement("input"),u={};s.className="route-on-edit",l.className="form-group",d.className="form-control",d.setAttribute("type","text"),d.setAttribute("name","number"),d.setAttribute("size","12"),i.groupid=PbxObject.oid,null!=e&&(d.value=e.number,i.oid=e.oid),i.number=d.value.trim(),d.onchange=function(){i.number=d.value.trim()},l.appendChild(d),c.appendChild(l),s.appendChild(c),c=document.createElement("td");var l=document.createElement("div");l.className="form-group",descr=document.createElement("input"),descr.className="form-control",descr.setAttribute("type","text"),descr.setAttribute("name","description"),null!=e&&(descr.value=e.description),i.description=descr.value,descr.onchange=function(){i.description=descr.value},l.appendChild(descr),c.appendChild(l),s.appendChild(c),c=document.createElement("td");var l=document.createElement("div");l.className="form-group",target=document.createElement("select"),target.className="form-control",target.setAttribute("name","target");for(var m=0;m<t.length;m++)a=t[m].kind,u[a]?n=u[a]:(n=document.createElement("optgroup"),n.setAttribute("label",PbxObject.frases.KINDS[a]),u[a]=n,target.appendChild(n)),r=t[m].oid,o=document.createElement("option"),o.setAttribute("value",r),o.innerHTML=t[m].name,null!=e&&r==e.target.oid&&o.setAttribute("selected",""),n.appendChild(o);t.length&&(i.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent},target.onchange=function(){i.target={oid:target.options[target.selectedIndex].value,name:target.options[target.selectedIndex].textContent}}),l.appendChild(target),c.appendChild(l),s.appendChild(c),c=document.createElement("td");var l=document.createElement("div");l.className="form-group",priority=document.createElement("select"),priority.className="form-control",priority.setAttribute("name","priority");for(var m=0;m<=10;m++){var o=document.createElement("option");o.value=m,null!=e&&m==e.priority&&o.setAttribute("selected",""),0==m?o.innerHTML="OFF":10==m?o.innerHTML="EXV":o.innerHTML=m,priority.appendChild(o)}e||(priority.selectedIndex=1),l.appendChild(priority),i.priority=priority.options[priority.selectedIndex].value,priority.onchange=function(){i.priority=priority.options[priority.selectedIndex].value},c.appendChild(l),s.appendChild(c),c=document.createElement("td");var l=document.createElement("div");return l.className="form-group",cost=document.createElement("input"),cost.className="form-control",cost.setAttribute("type","text"),cost.setAttribute("name","cost"),cost.setAttribute("size","2"),null!=e&&e.cost?cost.setAttribute("value",parseFloat(e.cost).toFixed(2)):cost.value=parseFloat(0).toFixed(2),i.cost=parseFloat(cost.value).toFixed(2),cost.onchange=function(){i.cost=parseFloat(cost.value).toFixed(2)},l.appendChild(cost),c.appendChild(l),s.appendChild(c),c=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-default btn-sm",button.innerHTML='<i class="fa fa-chevron-left"></i>',addEvent(button,"click",function(){var e=s.nextSibling;e&&"TR"==e.nodeName&&"none"==e.style.display&&(e.style.display="table-row"),s.parentNode.removeChild(s)}),c.appendChild(button),s.appendChild(c),c=document.createElement("td"),button=document.createElement("button"),button.className="btn btn-success btn-sm",button.innerHTML='<i class="fa fa-check"></i>',addEvent(button,"click",function(){var e=document.getElementById("objname").value;if(!e)return void alert(PbxObject.frases.MISSEDNAMEFIELD);if(!i.number)return void alert(PbxObject.frases.MISSED_ROUTE_NUMBER);isNaN(i.cost)&&(i.cost=0);var n=s.nextSibling,o=add_route_row(i,t);s.parentNode.insertBefore(o,s),n&&"TR"==n.nodeName&&"none"==n.style.display&&n.parentNode.removeChild(n),s.parentNode.removeChild(s),setRoute(i,set_object_success)}),c.appendChild(button),s.appendChild(c),s}function setRoute(e,t){var n=e,o=t||null;e.oid&&(n.oid=e.oid),e.priority&&(n.priority=parseFloat(e.priority)),e.cost&&(n.cost=parseFloat(e.cost)),console.log("setRoute: ",n),json_rpc_async("setRoute",n,o)}function deleteRoute(e){var t='"oid":"'+e+'"';json_rpc_async("deleteRoute",t,set_object_success)}function load_selector(e){function t(){var e=PbxObject.frases.KINDS.selector+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){u.name=e}function o(e){u.enabled=e,PbxObject.name&&setObjectState(PbxObject.oid,e,function(t){console.log("onStateChange: ",e,t)})}function a(){d=document.getElementById("available-users-cont"),d&&d.parentNode.removeChild(d),d=document.createElement("div"),d.id="available-users-cont",document.body.appendChild(d),ReactDOM.render(AvailableUsersModalComponent({frases:PbxObject.frases,availableList:f,excludeList:u.members,onSubmit:r,groupid:PbxObject.name?PbxObject.oid:null}),d)}function r(e){u.members=u.members.concat(e),PbxObject.name?s(u,function(e){l(u)}):l(u),$("#available-users-modal").modal("hide")}function i(e){var t=e.oid;u.members=u.members.filter(function(e){return e.oid!==t}),PbxObject.name?s(u,function(e){l(u)}):l(u)}function s(t,n){PbxObject.name&&(m=set_object_success);var o=extend({},t),a=o.name||p;o.members=o.members.reduce(function(e,t){return e=e.concat([t.ext])},[]),json_rpc_async("setObject",{kind:PbxObject.kind,oid:o.oid,name:a,owner:o.owner,enabled:o.enabled,options:o.options,members:o.members},function(t){if(PbxObject.name=u.name=a,o.files&&o.files.length&&o.files.forEach(function(e){uploadFile(e)}),o.route&&o.route.ext){var r={number:o.route.ext,target:{oid:PbxObject.oid,name:PbxObject.name}};e.routes.length&&(r.oid=e.routes[0].id),setObjRoute(r)}m&&m(),n&&n(t)})}function c(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function l(e){var t={frases:PbxObject.frases,params:e,onAddMembers:a,setObject:s,onNameChange:n,onStateChange:o,getInfoFromState:getInfoFromState,getExtension:getExtension,deleteMember:i};e.name&&(t.removeObject=c),ReactDOM.render(SelectorComponent(t),document.getElementById("el-loaded-content"))}var d,u=e,m=null,p=t(),b=[].concat(u.members),f=[];PbxObject.oid=e.oid,PbxObject.name=e.name,getExtensions(function(e){f=e.filter(function(e){return"user"===e.kind||"phone"===e.kind}),u.members=f.filter(function(e){return b.indexOf(e.ext)!==-1}),l(u),show_content(),set_page()})}function load_services(){function e(){json_rpc_async("getPbxOptions",null,function(e){m=e.config,s=i(e.services,m),isBranchPackage("premium")&&(c={},c.props=e.ldap||{},c.name="Microsoft Active Directory",c.id="MicrosoftAD",c.types=1),getExtensions(["phone","user"],function(e){l=e,r()})})}function t(e){console.log("getExternalUsers:",e),d=Ldap({service_id:e.id,service_type:e.type,available:[],onaddusers:n,members:l}),d.getExternalUsers()}function n(e){console.log("setExternalUsers: ",e),e.length&&(show_loading_panel(),d.setExternalUsers({service_id:d.options.service_id,users:e},function(e){console.log("addLdapUsers result: ",e),d.close(),"OK"===e&&set_object_success()}))}function o(e){console.log("saveOptions: ",e);var t="/services/"+e.id+"/Subscription";t+="?state="+(e.state?1:0),t+=Object.keys(e.props).reduce(function(t,n){return t+="&"+n+"="+e.props[n]},""),console.log("saveOptions: ",e,t),request("GET",t,null,null,function(t,n){return t?notify_about("error",t):void(n.result&&(n.result.location?window.location=n.result.location:(set_object_success(),s=s.map(function(t){return t.id===e.id&&(t=e),t}),console.log("saveOptions saved: ",t,n,s),r())))})}function a(e){json_rpc_async("setPbxOptions",{ldap:e.props},function(){c=e,console.log("saveLdapOptions saved: ",e),r(),set_object_success()})}function r(){var e={frases:PbxObject.frases,saveOptions:o,saveLdapOptions:a,services:s,onImportUsers:t,ldap:c};ReactDOM.render(ServicesComponent(e),document.getElementById("el-loaded-content")),u&&u.id&&1===getQueryParams().success&&t(u),show_content()}function i(e,t){var n=isBranchPackage("team")?p.join(b):isBranchPackage("business")||isBranchPackage("trial")?b:[];return e.filter(function(e){return n.indexOf(e.id)===-1})}var s=[],c=null,l=[],d={},u=window.sessionStorage.serviceParams,m=[],p=["Azure","Zapier"],b=["DynamicsCRMOnline","MicrosoftAD"];e()}function load_statistics(){new Statistics}function Statistics(){function e(e){e&&ReactDOM.render(TrunksQosTable({frases:PbxObject.frases,data:e,utils:{formatTimeString:formatTimeString}}),document.getElementById("trunks-qos-cont"))}function t(){return!y&&(y=!0,$("#trunks-qos-cont").addClass("faded"),void n({begin:o.date.start,end:o.date.end},function(t){console.log("openTrunksQosStat data: ",t),e(t),$("#trunks-qos-cont").removeClass("faded")}))}function n(e,t){json_rpc_async("getTrunksStatistics",{begin:e.begin,end:e.end},t)}var o,a,r,i,s=document.getElementById("trunks-statistics-table"),c=document.getElementById("ext-statistics-table"),l=document.getElementById("ext-stats-btn"),d=document.getElementById("ext-stat-kind"),u=document.getElementById("lost-stats-btn"),m=document.getElementById("trunks-qos-btn"),p=document.getElementById("dcontainer"),b=[].slice.call(p.querySelectorAll(".data-model")),f="inbound",g=PbxObject.oid,h=!0,v=!0,y=!1;self=this,this._init=function(){o=new Picker("statistics-date-picker",{submitFunction:self.getStatisticsData,interval:!0,buttonSize:"md"}),a=o.date.start,r=o.date.end,interval=o.interval,json_rpc_async("getCallStatistics",{begin:a,end:r},self._setStatistics),json_rpc_async("getCallStatisticsGraph",{begin:a,end:r,interval:interval},self._setCharts),l.onclick=function(){"shown"!==l.getAttribute("data-state")?(l.setAttribute("data-state","shown"),self._getExtStatisticsData()):l.setAttribute("data-state","hidden")},d.onclick=function(e){var e=e||window.event,t=e.target;"LABEL"===t.nodeName&&(f=t.children[0].getAttribute("data-kind"),h=!0,self._getExtStatisticsData())},u.onclick=function(){"shown"!==u.getAttribute("data-state")?(u.setAttribute("data-state","shown"),self._getLostStatisticsData()):u.setAttribute("data-state","hidden")},m.onclick=t,switch_presentation(g),set_page()},this.getColumns=function(e,t,n,o){var a=[t],r=null,i=o?o.convert:null;return e.map(function(e){for(var o in e)o===t||n&&n.indexOf(o)===-1||(r=e[o],"minutes"===i&&(r=parseFloat((r/1e3/60).toFixed(2))),a.push(r))}.bind(this)),a},this.getStatisticsData=function(){var t={begin:o.date.start,end:o.date.end};$("#statistics-cont").addClass("faded"),json_rpc_async("getCallStatistics",t,function(e){self._setStatistics(e),$("#statistics-cont").removeClass("faded")}),json_rpc_async("getCallStatisticsGraph",{begin:o.date.start,end:o.date.end,interval:o.interval},self._setCharts),n(t,e),h=!0,v=!0,"shown"==l.getAttribute("data-state")&&self._getExtStatisticsData(),"shown"==u.getAttribute("data-state")&&self._getLostStatisticsData()},this._getExtStatisticsData=function(){h&&(h=!1,$("#extStat-cont").addClass("faded"),a=o.date.start,r=o.date.end,i='"begin":'+a+', "end":'+r+', "kind":"'+f+'"',json_rpc_async("getCallStatisticsExt",i,function(e){self._setExtStatistics(e),$("#extStat-cont").removeClass("faded")}))},this._getLostStatisticsData=function(){v&&(v=!1,$("#lostCalls-cont").addClass("faded"),a=o.date.start,r=o.date.end,i='"begin":'+a+', "end":'+r,json_rpc_async("getLostCalls",i,function(e){self._setLostStats(e),$("#lostCalls-cont").removeClass("faded")}))},this._setStatistics=function(e){var t,n=e;n.inbounds.duration=formatTimeString(n.inbounds.duration,"hh:mm:ss"),n.outbounds.duration=formatTimeString(n.outbounds.duration,"hh:mm:ss"),n.internals.duration=formatTimeString(n.internals.duration,"hh:mm:ss"),void 0!==n.outbounds.cost&&(n.outbounds.cost=parseFloat(n.outbounds.cost).toFixed(2)),b.forEach(function(e){t=e.getAttribute("data-model"),"inbounds.lost"==t&&(0===n.inbounds.lost?e.classList.remove("negtv-col"):e.classList.add("negtv-col"));var o=t.split(".").reduce(objFromString,n);e.textContent=o}),self._build_trunks_statistics(n.trunks),show_content()},this._setExtStatistics=function(e){clearColumns(c);for(var t=0;t<e.length;t++)self._buildExtStatColumn(e[t])},this._setLostStats=function(e){for(var t=document.createDocumentFragment(),n=document.getElementById("lost-calls-table").querySelector("tbody"),o=0;o<e.length;o++)t.appendChild(self._buildLostCallsTable(e[o]));n.appendChild(t)},this._setCharts=function(e){var t=moment(o.date.start).isSame(o.date.end,"day"),n=moment(o.date.end).diff(o.date.start,"day"),a=864e5===o.interval,r="%d-%m-%Y",i=!isSmallScreen()&&!(n>=7&&!a);console.log("_setCharts:",o,a,t,n),a||(r=t?"%H:%M":"%d-%m-%Y %H:%M"),console.log("statistics charts data: ",e);c3.generate({bindto:"#outbounds-chart",data:{x:"intervals",columns:[self.getColumns(e,"intervals",["t"]),self.getColumns(e,PbxObject.frases.SETTINGS.OUTCALLS,["o"])]},axis:{x:{show:i,type:"timeseries",tick:{culling:{max:7},format:r}},y:{min:0}}}),c3.generate({bindto:"#inbounds-chart",data:{x:"intervals",columns:[self.getColumns(e,"intervals",["t"]),self.getColumns(e,PbxObject.frases.SETTINGS.INCALLS,["i"]),self.getColumns(e,PbxObject.frases.STATISTICS.LOSTCALLS,["m"])],type:"bar",groups:[[PbxObject.frases.SETTINGS.INCALLS,PbxObject.frases.STATISTICS.LOSTCALLS]]},axis:{x:{show:i,type:"timeseries",tick:{culling:{max:7},format:r}},y:{min:0}}}),c3.generate({bindto:"#internals-chart",data:{x:"intervals",columns:[self.getColumns(e,"intervals",["t"]),self.getColumns(e,PbxObject.frases.SETTINGS.INTCALLS,["l"])]},axis:{x:{show:i,type:"timeseries",tick:{culling:{max:7},format:r}},y:{min:0}}})},this._build_trunks_statistics=function(e){var t=s.querySelector("tbody");clearTable(t);for(var n=0;n<e.length;n++)row=t.insertRow(n),cell=row.insertCell(0),cell.textContent=void 0!==e[n].trunk?e[n].trunk:"",cell=row.insertCell(1),cell.textContent=void 0!==e[n]["in"]?e[n]["in"]:"",cell=row.insertCell(2),cell.textContent=void 0!==e[n].insec?formatTimeString(e[n].insec,"hh:mm:ss"):"",cell=row.insertCell(3),cell.textContent=void 0!==e[n].out?e[n].out:"",cell=row.insertCell(4),cell.textContent=void 0!==e[n].outsec?formatTimeString(e[n].outsec,"hh:mm:ss"):"",cell=row.insertCell(5),cell.textContent=void 0!==e[n].cost?parseFloat(e[n].cost).toFixed(2):""},this._buildExtStatColumn=function(e){for(var t,n,o,a=c.querySelector("thead"),r=c.querySelector("tbody"),i=0;i<a.rows.length;i++)t=document.createElement("th"),a.rows[i].appendChild(t),t.innerHTML=e.ext;for(var s=0;s<r.rows.length;s++){switch(n=r.rows[s].insertCell(-1),s){case 0:o="total";break;case 1:o="connected";break;case 2:o="duration";break;case 3:o="cost"}n.innerHTML=void 0!==e[o]?"duration"===o?formatTimeString(e[o],"hh:mm:ss"):"cost"===o?parseFloat(e[o]).toFixed(2):e[o]:""}},this._buildLostCallsTable=function(e){var t,n=document.createElement("tr");return t=n.insertCell(0),t.textContent=formatDateString(e.ts)||"",t=n.insertCell(1),t.textContent=e.na||"",t=n.insertCell(2),t.textContent=e.nb||"",t=n.insertCell(3),t.textContent=e.nc||"",t=n.insertCell(4),t.textContent=getFriendlyCodeName(e.cs)||"",n},this._init()}function AppStorage(e,t){if("localStorage"!==t&&"sessionStorage"!==t)return console.error('No such storage type. Choose either "localStorage" or "sessionStorage".');var n=window[t],o=n.getItem(e)?JSON.parse(n.getItem(e)):{};this.set=function(t,a,r){return o[t]=a,r||n.setItem(e,JSON.stringify(o)),this},this.get=function(e){return e?o[e]:o},this.remove=function(e){return e?delete o[e]:o={},this},this.setType=function(e){return window[e]&&(n=window[e]),this}}function load_storages(){function e(e){var n=extend({},e);n.maxsize&&(n.maxsize=convertBytes(n.maxsize,"Byte","GB")),ReactDOM.render(StorageComponent({frases:PbxObject.frases,data:n,onSubmit:t}),s)}function t(e,t){console.log("saveStorage: ",e),e.path&&(e.id||delete e.id,void 0!==e.maxsize&&(e.maxsize=convertBytes(e.maxsize,"GB","Byte")),e.state=parseInt(e.state,10),json_rpc_async("setFileStore",e,function(e,n){return n?t(n):(notify_about("success",PbxObject.frases.SAVED),void getStorages(function(e){a=e,getTotalStorage(function(e){PbxObject.options=e,o(),t&&t()})}))}))}function n(){show_content(),void 0!==a&&void 0!=r&&(o(),TableSortable.sortables_init(),close_options(),set_page())}function o(){ReactDOM.render(UsageComponent({options:PbxObject.options,frases:PbxObject.frases,storageInfo:r,fileStorage:a,extensions:i,getTotalStorage:getTotalStorage,utils:{convertBytes:convertBytes,formatDateString:formatDateString,getFriendlyStorageState:getFriendlyStorageState},openStorageSettings:e}),document.getElementById("el-loaded-content"))}var a,r,i,s=document.getElementById("modal-cont");s||(s=document.createElement("div"),s.id="modal-cont",document.body.appendChild(s)),1!==PbxObject.options.mode&&PbxObject.options.prefix?a=null:getStorages(function(e){a=e,n()}),getStorageInfo(function(e){r=e,getExtensions(function(e){i=e,n()})})}function getStorages(e){json_rpc_async("getFileStore",null,function(t){e&&e(t)})}function getStorageInfo(e){json_rpc_async("getStoreInfo",null,function(t){sortByKey(t,"user"),e&&e(t)})}function getTotalStorage(e){json_rpc_async("getPbxOptions",null,function(t){e&&e(t)})}function setUserStoreLimit(e,t,n){json_rpc_async("setStoreLimit",{oid:e,limit:convertBytes(parseFloat(t),"GB","Byte")},function(e){console.log(e),n.value=convertBytes(e,"Byte","GB").toFixed(2)})}function getFriendlyStorageState(e){return PbxObject.frases.STORAGE.STATES[e]}function load_timer(e){function t(e){return moment().dayOfYear(e).format("YYYY-MM-DD")}PbxObject.oid=e.oid,PbxObject.name=e.name;var n,o=(new Date,document.getElementById("enabled")),a=document.getElementById("objname");e.name&&(a.value=e.name),o&&(o.checked=e.enabled,addEvent(o,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(o.checked=!o.checked)})}));var r,i=document.getElementById("hh");for(r=0;r<24;r++){var s=document.createElement("option");if(r<10)var c="0"+r;else c=r;s.value=c,s.innerHTML=c,i.appendChild(s),c==e.hour&&(i.selectedIndex=r)}var l=document.getElementById("mm");for(r=0;r<=55;r+=5){var s=document.createElement("option");if(r<10)var c="0"+r;else c=r;s.value=c,s.innerHTML=c,l.appendChild(s),c==e.minute&&(l.selectedIndex=r/5)}for(r=0;r<e.weekdays.length;r++){var d=document.getElementById("t-d"+e.weekdays[r]);d.checked=!0,"LABEL"===d.parentNode.nodeName&&d.parentNode.classList.add("active")}fill_timer_targets("objects"),setTimezones(document.getElementById("timer_timezone"),e.timezone||PbxObject.options.timezone);var u=document.getElementById("targets").getElementsByTagName("tbody")[0];for(r=0;r<e.targets.length;r++)u.appendChild(timer_target_row(e.targets[r].oid,e.targets[r].name,e.targets[r].action));show_content(),set_page();var m=document.getElementById("add-timer-target");m.onclick=function(){add_timer_target()};var p=document.getElementById("timer-range");addEvent(p,"click",check_days);var b=document.createElement("div");b.className="timer-dates-wrapper no-weekdays no-years",document.body.appendChild(b),console.log("load_timer: ",e.yeardays.map(t)),n=flatpickr("#timer-dates",{locale:PbxObject.language||"en",mode:"multiple",dateFormat:"d.m",appendTo:b,minDate:new Date((new Date).getFullYear(),0,1),maxDate:new Date((new Date).getFullYear(),11,31),defaultDate:e.yeardays?e.yeardays.map(t):[],onChange:function(e,t){setTempParams({selectedDates:e})}})}function setTimezones(e,t){var n=moment.tz.names()||[],o=document.createDocumentFragment(),a=null;n.map(function(e){return a=document.createElement("option"),a.value=e,a.textContent=e,e===t&&(a.selected=!0),o.appendChild(a),e}),e.appendChild(o)}function set_timer(){var e,t=document.getElementById("objname").value,n=document.getElementById("timer_timezone");
if(!t)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;e='"name":"'+t+'",',show_loading_panel();var o;PbxObject.name?o=set_object_success:(PbxObject.name=t,o=null),null!=PbxObject.oid&&(e+='"oid":"'+PbxObject.oid+'",'),e+='"kind":"timer",';var a=document.getElementById("enabled");null!=a&&(e+='"enabled":'+a.checked+",");var r=document.getElementById("hh"),i=document.getElementById("mm");e+='"hour":"'+r.options[r.selectedIndex].value+'",',e+='"minute":"'+i.options[i.selectedIndex].value+'",',(n.value||PbxObject.options.timezone)&&(e+='"timezone":"'+(n.value||PbxObject.options.timezone)+'",'),e+='"weekdays":[';var s;for(s=0;s<7;s++)document.getElementById("t-d"+s).checked&&(e+=s+",");e+="],",PbxObject.currentObj&&PbxObject.currentObj.selectedDates&&(e+='"yeardays":[',PbxObject.currentObj.selectedDates.forEach(function(t){e+=moment(t).dayOfYear()+","}),e+="],");var c=document.getElementById("targets").getElementsByTagName("tbody")[0];for(e+='"targets":[',s=0;s<c.children.length;s++){var l=c.children[s];void 0!=l.id&&""!=l.id&&(e+='{"oid":"'+c.children[s].id+'","action":"'+l.children[0].getAttribute("data-action")+'"},')}e+="]",json_rpc_async("setObject",e,o)}function timer_target_row(e,t,n){var o=document.createElement("tr"),a=document.createElement("td"),r=document.createElement("a"),i="Enable"==n?PbxObject.frases.ENABLE:PbxObject.frases.DISABLE;a.textContent=i,a.setAttribute("data-action",n),o.appendChild(a),a=document.createElement("td"),o.id=e,r.href="#",r.onclick=function(t){get_object_link(e),t.preventDefault()},r.innerHTML=t,a.appendChild(r),o.appendChild(a),a=document.createElement("td"),a.className="text-center";var s=document.createElement("button");return s.className="btn btn-danger btn-link btn-sm",s.innerHTML='<i class="fa fa-trash"></i>',s.onclick=function(){remove_listener(e)},a.appendChild(s),o.appendChild(a),o}function add_timer_target(){var e=document.getElementById("targets").getElementsByTagName("tbody")[0],t=document.getElementById("objects"),n=document.getElementById("actions"),o=t.options[t.selectedIndex];e.appendChild(timer_target_row(o.value,o.innerHTML,n.value))}function remove_listener(e){var t,n=document.getElementById("targets").getElementsByTagName("tbody")[0];for(t=0;t<n.children.length;t++)n.children[t].id==e&&n.removeChild(n.children[t])}function fill_timer_targets(e){var t,n,o,a,r,i=document.getElementById(e),s={};"object"==typeof PbxObject.objects?r=PbxObject.objects:(r=json_rpc("getObjects",'"kind":"all"'),sortByKey(r,"name"),PbxObject.objects=r);for(var c=0;c<r.length;c++)o=r[c].kind,"equipment"!=o&&"cli"!=o&&"timer"!=o&&"users"!=o&&(s[o]?t=s[o]:(t=document.createElement("optgroup"),t.setAttribute("label",PbxObject.frases.KINDS[o]),s[o]=t,i.appendChild(t)),a=r[c].oid,n=document.createElement("option"),n.value=a,n.innerHTML=r[c].name,t.appendChild(n))}function check_days(e){var t,e=e||window.event,n=e.target,o=n.getAttribute("data-filter");e.preventDefault();for(var a=0;a<7;a++)t=document.getElementById("t-d"+a),"timer-workdays"===o&&(5===a||6===a)||"timer-holidays"===o&&a<5?(t.checked&&(t.checked=!1),"LABEL"===t.parentNode.nodeName&&t.parentNode.classList.remove("active")):(t.checked=!0,"LABEL"===t.parentNode.nodeName&&t.parentNode.classList.add("active"))}function today(e){"use strict";function t(){return s.valueOf()}function n(){return s}function o(e){return s="month"===e?new Date(s.setDate(1)):"year"===e?new Date(s.setMonth(0,1)):new Date(s.setHours(0,0,0,1)),c}function a(e){return"month"===e?c.toStartOf("month").plus(1,"month").minus(1):s="year"===e?new Date(s.setMonth(11,31)):new Date(s.setHours(23,59,59)),c}function r(e,t){return t?t.match(/month|months/g)?s=new Date(s.setMonth(s.getMonth()+e)):t.match(/year|years/g)&&(s=new Date(s.setFullYear(s.getFullYear()+e))):s=new Date(s.setDate(s.getDate()+e)),c}function i(e,t){return t?t.match(/month|months/g)?s=new Date(s.setMonth(s.getMonth()-e)):t.match(/year|years/g)&&(s=new Date(s.setFullYear(s.getFullYear()-e))):s=new Date(s.setDate(s.getDate()-e)),c}var s=e?new Date(e):new Date,c={valueOf:t,dateOf:n,toStartOf:o,toEndOf:a,plus:r,minus:i};return c}function MyTour(e,t){if(!e)return console.error("tour name is undefined");if(!t)return console.error("options is undefined");var n={},o={name:e,backdrop:!0,backdropContainer:"#pagecontent",storage:!1,template:["<div class='popover tour'>","<div class='arrow'></div>","<h3 class='popover-title'></h3>","<div class='popover-content'></div>","<div class='popover-navigation'>","<button class='btn btn-default' data-role='prev'><i class='fa fa-angle-left'></i></button>","<span data-role='separator'> </span>","<button class='btn btn-default' data-role='next'><i class='fa fa-angle-right'></i></button>","<button class='btn btn-link' data-role='end'>",PbxObject.frases.TOURS.END_TOUR,"</button>","</div>","</div>"].join(""),steps:[]};return t&&extend(o,t),n=new Tour(o),n.init(),n}function load_trunk(e){var t=(e.type,[].slice.call(document.querySelectorAll('[name="trunkType"]')));PbxObject.oid=e.oid,PbxObject.name=e.name;var n=document.getElementById("enabled"),o=document.getElementById("objname");if(e.name&&(o.value=e.name),n&&(n.checked=e.enabled,addEvent(n,"change",function(){setObjectState(e.oid,this.checked,function(e){e||(n.checked=!n.checked)})})),e.status){var a=document.getElementById("status");a&&(a.innerHTML=e.status)}if(void 0!==e.up&&changeTrunkRegState(e.up),e.protocol){var r,i="h323"==e.protocol?"h323":"sip",s=document.getElementById("protocols"),c=document.getElementById("get-proto-opts");e.name?(r=document.createElement("option"),r.value=e.protocol,r.textContent=e.protocol,s.appendChild(r)):(e.protocols.forEach(function(e){r=document.createElement("option"),r.value=e,r.textContent=e,"sip"===e&&r.setAttribute("selected","selected"),s.appendChild(r)}),"sip"!==s.value&&(s.value=e.protocol),addEvent(s,"change",function(){i="h323"==this.value?"h323":"sip",switch_presentation(i)})),addEvent(c,"click",function(){getProtocolOptions(e.parameters)}),PbxObject.templates.protocol||$.get("/badmin/views/protocol.html",function(e){PbxObject.templates=PbxObject.templates||{},PbxObject.templates.protocol=e}),PbxObject.protocolOpts={},switch_presentation(i)}t.forEach(function(t){if(t.value===e.type){var n=t.parentNode;t.checked,$(n).button("toggle")}else e.name&&t.parentNode.parentNode.removeChild(t.parentNode)}),e.domain&&(document.getElementById("domain").value=e.domain),document.getElementById("register").checked=e.register,document.getElementById("user").value=e.user||"",document.getElementById("pass").value=e.pass||"",document.getElementById("int-trunk-user").value=e.gateway?e.gateway.regname:e.user||"",document.getElementById("int-trunk-pass").value=e.gateway?e.gateway.regpass:e.pass||"",e.auth&&(document.getElementById("auth").value=e.auth);var l=document.getElementById("proxy");addEvent(l,"change",function(){for(var e=document.getElementsByName("proxy"),t=0;t<e.length;t++)e[t].disabled=!this.checked}),l.checked=e.proxy;for(var d=document.getElementsByName("proxy"),u=0;u<d.length;u++)d[u].disabled=!e.proxy;if(e.paddr&&(document.getElementById("paddr").value=e.paddr),e.pauth&&(document.getElementById("pauth").value=e.pauth),e.ppass&&(document.getElementById("ppass").value=e.ppass),void 0!=e.maxinbounds&&(document.getElementById("maxinbounds").value=isMaxNumber(e.maxinbounds)?16:e.maxinbounds,document.getElementById("inmode").checked=e.maxinbounds>0),void 0!=e.maxoutbounds&&(document.getElementById("maxoutbounds").value=isMaxNumber(e.maxoutbounds)?16:e.maxoutbounds,document.getElementById("outmode").checked=e.maxoutbounds>0),void 0!=e.parameters){var m=e.parameters.codecs;if(void 0!=m)for(var p,u=0;u<m.length&&(p=document.getElementById("c"+u),p);u++)p.value=m[u].codec,document.getElementById("f"+u).value=m[u].frame;else for(u=0;u<4;u++)document.getElementById("c"+u).selectedIndex=0,document.getElementById("f"+u).value=0;document.getElementById("regexpires")&&(document.getElementById("regexpires").value=e.parameters.regexpires||60)}var b=e.inboundanumbertransforms;if(b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms1",b[u]);else append_transform(null,"transforms1");if(b=e.inboundbnumbertransforms,b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms2",b[u]);else append_transform(null,"transforms2");if(b=e.outboundanumbertransforms,b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms3",b[u]);else append_transform(null,"transforms3");if(b=e.outboundbnumbertransforms,b.length)for(u=0;u<b.length;u++)append_transform(null,"transforms4",b[u]);else append_transform(null,"transforms4");switch_presentation(e.type&&"undefined"!==e.type?e.type:"external",null,"pl-trunk-kind"),show_content(),set_page()}function getProtocolOptions(e){var t=document.getElementById("protocols"),n=[].slice.call(document.querySelectorAll('[name="trunkType"]')),o="";n.forEach(function(e){e.checked&&(o=e.value)}),console.log("getProtocolOptions: ",e,o),get_protocol_opts(t.value,e,o)}function changeTrunkRegState(e){var t=document.getElementById("enabled");e?t.classList.remove("unregistered"):t.classList.add("unregistered")}function set_trunk(){var e,t,n,o,a,r,i,s,c,l=document.getElementById("objname").value,d=document.getElementById("enabled");if(!l)return alert(PbxObject.frases.MISSEDNAMEFIELD),!1;t='"name":"'+l+'",',show_loading_panel(),PbxObject.oid&&(t+='"oid":"'+PbxObject.oid+'",'),PbxObject.name?n=set_object_success:(PbxObject.name=l,n=null),o=[].slice.call(document.querySelectorAll('[name="trunkType"]')),o.forEach(function(e){e.checked?a=e.value:e.parentNode.parentNode.removeChild(e.parentNode)}),t+='"kind":"trunk",',t+='"enabled":'+d.checked+",";var u=document.getElementById("protocols").value,m=document.getElementById("register").checked,p=document.getElementById("proxy").checked;t+='"protocol":"'+u+'",',t+='"type":"'+a+'",',"external"===a?(t+='"domain":"'+document.getElementById("domain").value+'",',t+='"register":'+m+",",m&&(t+='"user":"'+document.getElementById("user").value+'",',t+='"auth":"'+document.getElementById("auth").value+'",',t+='"pass":"'+document.getElementById("pass").value+'",'),t+='"proxy":'+p+",",p&&(t+='"paddr":"'+document.getElementById("paddr").value+'",',t+='"pauth":"'+document.getElementById("pauth").value+'",',t+='"ppass":"'+document.getElementById("ppass").value+'",')):(t+='"user":"'+document.getElementById("int-trunk-user").value+'",',t+='"pass":"'+document.getElementById("int-trunk-pass").value+'",'),t+=document.getElementById("inmode").checked?'"maxinbounds":'+document.getElementById("maxinbounds").value+",":'"maxinbounds":0,',t+=document.getElementById("outmode").checked?'"maxoutbounds":'+document.getElementById("maxoutbounds").value+",":'"maxoutbounds":0,',t+='"parameters":{',m&&(t+='"regexpires":'+document.getElementById("regexpires").value+","),e=JSON.stringify(PbxObject.protocolOpts),e=e.substr(1,e.length-2),t+=e,r=transformsToArray("transforms1"),i=transformsToArray("transforms2"),s=transformsToArray("transforms3"),c=transformsToArray("transforms4"),t+="},",t+='"inboundanumbertransforms":',t+=JSON.stringify(r),t+=', "inboundbnumbertransforms":',t+=JSON.stringify(i),t+=', "outboundanumbertransforms":',t+=JSON.stringify(s),t+=', "outboundbnumbertransforms":',t+=JSON.stringify(c),console.log(t),json_rpc_async("setObject",t,function(e){e?n&&n():d.checked&&(d.checked=!1)})}function load_users(e){function t(){var e=PbxObject.frases.USERS_GROUP.DEFAULT_NAME+" ";return e+=PbxObject.objects?filterObject(PbxObject.objects,PbxObject.kind).length+1:1}function n(e){b.name=e}function o(){console.log("openNewUserForm"),h=document.getElementById("modal-cont"),h&&h.parentNode.removeChild(h),h=document.createElement("div"),h.id="modal-cont",document.body.appendChild(h),a()}function a(){var e=PbxObject.options,t=e.storelimit/e.maxusers;b.storelimit=t,ReactDOM.render(NewUsersModalComponent({frases:PbxObject.frases,params:b,onSubmit:r,generatePassword:generatePassword,convertBytes:convertBytes,groupid:PbxObject.name?PbxObject.oid:null}),h)}function r(e,t){console.log("addUser: ",e);var n=extend({},e);return PbxObject.name?(n.kind="users"===b.kind?"user":"phone",n.groupid=b.oid,void json_rpc_async("setObject",n,function(e,o){return o?(t(o),notify_about("error",o.message)):(n.oid=e,n.reg="",n.state=0,b.available=b.available.filter(function(e){return e!==n.number}),b.members.push(n),p(b),void(t&&t(null,e)))})):u({name:b.name,profile:b.profile,members:[]},function(){r(n,t)})}function i(e){console.log("onImportUsers: ",e),"MicrosoftAD"===e.id?(PbxObject.LdapConnection=Ldap({domains:e.props.directoryDomains.split(" "),available:b.available,onaddusers:s,members:b.members}),PbxObject.LdapConnection.auth()):c(e)}function s(e){if(!PbxObject.name)return void set_bgroup(e,s);console.log("onAddUsers: ",e);var t=PbxObject.LdapConnection;t.setUsers({groupid:PbxObject.oid,username:t.options.username,password:t.options.password,domain:t.options.domain,users:e},function(e){console.log("addLdapUsers result: ",e),t.close()})}function c(e){console.log("getExternalUsers:",e),PbxObject.LdapConnection=Ldap({service_id:e.id,service_type:e.type,available:b.available,onaddusers:l,members:b.members}),PbxObject.LdapConnection.getExternalUsers()}function l(e){if(!PbxObject.name)return void set_bgroup(e,l);show_loading_panel(),console.log("setExternalUsers: ",e);var t=PbxObject.LdapConnection;t.setExternalUsers({groupid:PbxObject.oid,service_id:t.options.service_id,users:e},function(e){console.log("addLdapUsers result: ",e),t.close(),"OK"===e&&set_object_success()})}function d(e){var t=e.oid,n=PbxObject.frases.DODELETE+" "+e.name+"?",o=confirm(n);o&&json_rpc_async("deleteObject",{oid:t},function(){b.members=b.members.filter(function(e){return e.oid!==t}),b.available=b.available.concat([e.ext]).sort(),p(b)})}function u(e,t){PbxObject.name&&(f=set_object_success);var n=e.name||g,o={kind:PbxObject.kind,oid:b.oid,name:n,profile:e.profile,members:e.members.length?e.members.reduce(function(e,t){return e.push(t.number||t.ext),e},[]):[]};console.log("setObject: ",e),json_rpc_async("setObject",o,function(e){PbxObject.name=b.name=n,f&&f(),t&&t(e)})}function m(){delete_object(PbxObject.name,PbxObject.kind,PbxObject.oid)}function p(e){var t={frases:PbxObject.frases,params:e,setObject:u,onAddMembers:o,onNameChange:n,getExtension:getExtension,activeServices:v,onImportUsers:i,deleteMember:d};e.name&&(t.removeObject=m),ReactDOM.render(UsersGroupComponent(t),document.getElementById("el-loaded-content")),y&&y.id&&1===getQueryParams().success&&c(y)}console.log("load_users: ",e);var b=(PbxObject.frases,e),f=null,g=t(),h=document.getElementById("modal-cont"),v=PbxObject.options.services.filter(function(e){return e.state}),y=window.sessionStorage.serviceParams;PbxObject.options.ldap&&PbxObject.options.ldap.directoryServer.trim().length&&v.unshift({id:"MicrosoftAD",name:"Microsoft Active Directory",props:PbxObject.options.ldap,state:!0,types:1}),h||(h=document.createElement("div"),h.id="modal-cont",document.body.appendChild(h)),b.available.sort(),PbxObject.oid=e.oid,PbxObject.name=e.name,p(b),show_content(),set_page()}AttObject.prototype.enterAttMenu=function(e,t){var e=e||window.event;e.preventDefault(),makeActiveCanvas(this.oid)},AttObject.prototype.editObject=function(e,t){var e=e||window.event;e.preventDefault(),showAttObjectSetts(this.params,this)},AttObject.prototype.removeElement=function(e,t,n){e&&e.preventDefault();var o=this.element.querySelector("#enter-att-menu"),a=this.element.querySelector("#edit-att-object"),r=this.element.querySelector("#remove-att-object");removeTreeBtn=this.element.querySelector("#remove-att-tree"),o&&removeEvent(o,"click",function(){this.enterAttMenu(e,t)}.bind(this)),a&&removeEvent(a,"click",function(){this.editObject(e,t)}.bind(this)),r&&removeEvent(r,"click",function(e){this.removeElement(e)}.bind(this)),removeTreeBtn&&removeEvent(removeTreeBtn,"click",function(e){this.removeElement(e)}.bind(this)),this.element.parentNode.removeChild(this.element),e?(removeObject(this.oid,n),removeFromSchema(this.oid),"0"==this.oid&&createInitButton()):removeObject(this.oid),changeAvailableButtons(t.button),setupInProgress()};var BillingApi={url:"https://api-web.ringotel.net/branch/api/",cache:{},fetch:function(e,t,n,o,a){var r,i,s;r=new XMLHttpRequest,r.open(e,t,!0),o&&o.headers&&o.headers.forEach(function(e){r.setRequestHeader(e.name,e.value)}),i=setTimeout(function(){r.abort()},6e4),r.onload=function(e){clearTimeout(i);var t=(e.target.getAllResponseHeaders(),e.target.status),n=e.target.responseText;if(n)try{n=JSON.parse(n)}catch(o){console.log("response in not JSON")}if(403===t)logout();else if(200===t)a&&a(null,n);else if(t>=500){if(a)return a("The service is under maintenance. Please, try again later.")}else a&&a(n.error)},n?(r.setRequestHeader("Content-Type","application/json"),s=JSON.stringify(n),r.send(s)):r.send()},request:function(e,t,n){var o=window.localStorage.getItem("ringo_tid");return o?void this.fetch("POST",this.url+e+"?access_token="+encodeURIComponent(o),t||null,null,function(e,t){return e||t.error?n(e||t.error):void(n&&n(null,t))}):n("MISSING_TOKEN")},sendAppsLinks:function(e,t){this.request("sendAppsLinks",{email:e},t)},getProration:function(e,t){console.log("getProration: ",e,t);var n=Date.now(),o=Math.floor((e.nextBillingDate-e.prevBillingDate)/1e3),a=e.nextBillingDate>n?Math.floor((e.nextBillingDate-n)/1e3):0,r=(a/o).toFixed(2),i=parseFloat(t)*parseFloat(r);return i},getProfile:function(e){this.request("getProfile",null,e)},updateBalance:function(e,t){this.request("updateBalance",e,t)},changeAdminEmail:function(e,t){this.request("changeAdminEmail",e,t)},changePassword:function(e,t){this.request("changePassword",e,t)},addCard:function(e,t){this.request("addCard",e,t)},updateCard:function(e,t){this.request("updateCard",e,t)},getPlans:function(e,t){this.request("getPlans",e,t)},changePlan:function(e,t){this.request("changePlan",e,t)},getSubscription:function(e){this.request("getSubscription",null,e)},updateSubscription:function(e,t){this.request("updateSubscription",e,t)},renewSubscription:function(e){this.request("renewSubscription",null,e)},addCoupon:function(e,t){this.request("addCoupon",e,t)},getInvoices:function(e){this.request("getInvoices",null,e)},getDiscounts:function(e){this.request("getDiscounts",null,e)},getAssignedDids:function(e){this.request("getAssignedDids",null,e)},getUnassignedDids:function(e){this.request("getUnassignedDids",null,e)},orderDid:function(e,t){this.request("orderDid",e,t)},unassignDid:function(e,t){this.request("unassignDid",e,t)},getDidPrice:function(e,t){this.request("getDidPrice",e,t)},getDid:function(e,t){this.request("getDid",e,t)},getDidCountries:function(e){this.request("getDidCountries",null,e)},getDidLocations:function(e,t){this.request("getDidLocations",e,t)},hasDids:function(e){this.request("hasDids",null,e)},updateDidStatus:function(e,t){this.request("updateDidStatus",e,t)},updateDidRegistration:function(e,t){this.request("updateDidRegistration",e,t)},getCredits:function(e){this.request("getCredits",null,e)},addCredits:function(e,t){this.request("addCredits",e,t)}};ChannelPlayer.prototype={initEvents:function(){return addEvent(this.audio,"playing",function(e){$(document).trigger("player:playing",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],currentTime:this.audio.currentTime,duration:this.audio.duration}])}.bind(this),!0),addEvent(this.audio,"loadedmetadata",function(e){$(document).trigger("player:loadedmetadata",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.audio.duration}])}.bind(this)),addEvent(this.audio,"pause",function(e){$(document).trigger("player:pause",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex]}])}.bind(this),!0),addEvent(this.audio,"seeked",function(e){$(document).trigger("player:seeked",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.duration||this.playlist[this.trackIndex].duration,currentTime:(this.playlist[this.trackIndex].timecode-this.playlist[0].timecode)/1e3+this.audio.currentTime}])}.bind(this),!0),addEvent(this.audio,"timeupdate",function(e){$(document).trigger("player:timeupdate",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],duration:this.duration||this.playlist[this.trackIndex].duration,currentTime:(this.playlist[this.trackIndex].timecode-this.playlist[0].timecode)/1e3+this.audio.currentTime}])}.bind(this),!0),addEvent(this.audio,"ended",function(e){$(document).trigger("player:ended",[{trackIndex:this.trackIndex,track:this.playlist[this.trackIndex],currentTime:this.audio.currentTime}])}.bind(this),!0),this},init:function(){return $(document).trigger("player:init",[{audio:this.audio,path:this.path,playlist:this.playlist,trackIndex:this.trackIndex,duration:this.duration}]),this},playTrack:function(e,t){if(!this.playlist.length||e>this.playlist.length-1||e<0)return this;var n=this.playlist[e||this.trackIndex],o=this.path+n.file;void 0!==e&&(this.trackIndex=e),this.audio.src!==o&&(this.audio.src=o,$(document).trigger("player:trackchange",[{trackIndex:this.trackIndex,track:n,src:this.audio.src}])),void 0!==t&&(this.audio.currentTime=t),console.log("play: ",e,t),this.audio.play()},play:function(){return this.audio.paused?this.audio.play():this.audio.pause(),this},stop:function(){return this.audio.pause(),this.trackIndex=0,this.audio.currentTime=0,this},next:function(){var e=this.trackIndex+1;return this.audio.pause(),this.audio.currentTime=0,this.playTrack(e),$(document).trigger("player:next",[{trackIndex:this.trackIndex,track:this.playlist[e]}]),this},prev:function(){var e=this.trackIndex-1;return this.audio.pause(),this.audio.currentTime=0,this.playTrack(e),$(document).trigger("player:prev",[{trackIndex:this.trackIndex,track:this.playlist[e]}]),this}},window.onerror=function(e,t,n){console.error("Error message: "+e+"\nURL: "+t+"\nLine number: "+n)},init();var appStorage=new AppStorage("app-storage","localStorage"),Utils={validateElement:function(e,t){var n=!!e.value;return n?t?t.classList.remove("has-error"):e.classList.remove("has-error"):(t?t.classList.add("has-error"):e.classList.add("has-error"),n=!1),n},validateEmail:function(e){var t=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e)},each:function(e,t,n){function o(e,o,a){t(function(e){return e?n(e):void(o===a.length-1&&n())},e)}e.forEach(o)}};